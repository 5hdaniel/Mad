<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backlog Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        header h1 {
            font-size: 2em;
        }

        .header-info {
            text-align: right;
            opacity: 0.9;
        }

        .filter-indicator {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            display: none;
        }

        .filter-indicator.active {
            display: inline-block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .metric-card.warning {
            border-left: 4px solid #f59e0b;
        }

        .metric-card.danger {
            border-left: 4px solid #ef4444;
        }

        .metric-card.success {
            border-left: 4px solid #10b981;
        }

        .metric-card.info {
            border-left: 4px solid #3b82f6;
        }

        .metric-value {
            font-size: 2.2em;
            font-weight: bold;
            color: #667eea;
        }

        .metric-label {
            color: #666;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .metric-detail {
            font-size: 0.75em;
            color: #999;
            margin-top: 3px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-card h3 {
            margin-bottom: 15px;
            color: #444;
            font-size: 1em;
        }

        .chart-container {
            position: relative;
            height: 250px;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .filters-header h3 {
            color: #444;
            font-size: 1em;
        }

        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
            min-width: 150px;
        }

        .filter-group.search {
            flex: 2;
            min-width: 250px;
        }

        .filter-group label {
            font-size: 0.8em;
            color: #666;
            font-weight: 500;
        }

        .filter-group select, .filter-group input {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9em;
            transition: border-color 0.2s;
        }

        .filter-group select:focus, .filter-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd6;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .btn-refresh {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            margin-top: 8px;
        }

        .btn-refresh:hover {
            background: rgba(255,255,255,0.3);
        }

        .multi-select {
            position: relative;
        }

        .multi-select-btn {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9em;
            background: white;
            text-align: left;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .multi-select-btn:hover {
            border-color: #667eea;
        }

        .multi-select-btn::after {
            content: '‚ñº';
            font-size: 0.7em;
            color: #666;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }

        .multi-select-dropdown.open {
            display: block;
        }

        .multi-select-option {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .multi-select-option:hover {
            background: #f3f4f6;
        }

        .multi-select-option input {
            margin: 0;
        }

        .multi-select-option.selected {
            background: #e0e7ff;
        }

        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            max-width: 200px;
        }

        .selected-tag {
            background: #e0e7ff;
            color: #4338ca;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75em;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.2em;
            color: #333;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            padding: 20px;
        }

        .detail-row {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #666;
            width: 120px;
            flex-shrink: 0;
        }

        .detail-value {
            color: #333;
            flex: 1;
        }

        .detail-value code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.85em;
            color: #e11d48;
        }

        .detail-value strong {
            display: block;
            margin-top: 16px;
            margin-bottom: 8px;
            color: #1f2937;
            font-size: 1.05em;
        }

        .detail-value strong:first-child {
            margin-top: 0;
        }

        .description-content {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.7;
        }

        .clickable-row {
            cursor: pointer;
        }

        .clickable-row:hover {
            background: #f0f4ff;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .table-header h3 {
            color: #444;
        }

        .result-count {
            color: #666;
            font-size: 0.9em;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
            cursor: pointer;
            user-select: none;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th:hover {
            background: #e9ecef;
        }

        th.sorted-asc::after {
            content: ' ‚ñ≤';
            font-size: 0.7em;
        }

        th.sorted-desc::after {
            content: ' ‚ñº';
            font-size: 0.7em;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .priority-badge, .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-critical { background: #fee2e2; color: #dc2626; }
        .priority-high { background: #fef3c7; color: #d97706; }
        .priority-medium { background: #dbeafe; color: #2563eb; }
        .priority-low { background: #e5e7eb; color: #6b7280; }

        .status-pending { background: #e0e7ff; color: #4338ca; }
        .status-in-progress { background: #fef3c7; color: #d97706; }
        .status-testing { background: #d1fae5; color: #059669; }
        .status-completed { background: #d1fae5; color: #059669; }
        .status-blocked { background: #fee2e2; color: #dc2626; }
        .status-reopened { background: #fce7f3; color: #db2777; }
        .status-obsolete, .status-deferred { background: #e5e7eb; color: #6b7280; }

        .id-link {
            color: #667eea;
            font-weight: 600;
            text-decoration: none;
        }

        .id-link:hover {
            text-decoration: underline;
        }

        .estimate-cell {
            font-family: monospace;
            color: #666;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                text-align: center;
            }

            .header-info {
                text-align: center;
            }

            .filters-row {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
            }

            table {
                font-size: 0.85em;
            }

            th, td {
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>üìä Backlog Dashboard</h1>
                <span class="filter-indicator" id="filterIndicator">Filtered View</span>
            </div>
            <div class="header-info">
                <div id="generated-time"></div>
                <button class="btn btn-refresh" onclick="location.reload()">üîÑ Refresh</button>
            </div>
        </header>

        <div class="metrics-grid" id="metrics-grid"></div>

        <div class="charts-grid">
            <div class="chart-card">
                <h3>üìà Status Distribution</h3>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>üéØ Priority Distribution</h3>
                <div class="chart-container">
                    <canvas id="priorityChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>üìÅ Category Distribution (Top 8)</h3>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>‚ö° Effort Distribution</h3>
                <div class="chart-container">
                    <canvas id="effortChart"></canvas>
                </div>
            </div>
        </div>

        <div class="filters">
            <div class="filters-header">
                <h3>üîç Filter Items</h3>
                <button class="btn btn-secondary" onclick="resetFilters()">Reset All</button>
            </div>
            <div class="filters-row">
                <div class="filter-group search">
                    <label>Search</label>
                    <input type="text" id="searchInput" placeholder="Search by ID, title, or category...">
                </div>
                <div class="filter-group">
                    <label>Status</label>
                    <div class="multi-select" id="statusFilter"></div>
                </div>
                <div class="filter-group">
                    <label>Priority</label>
                    <div class="multi-select" id="priorityFilter"></div>
                </div>
                <div class="filter-group">
                    <label>Category</label>
                    <div class="multi-select" id="categoryFilter"></div>
                </div>
                <div class="filter-group">
                    <label>Sprint</label>
                    <div class="multi-select" id="sprintFilter"></div>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h3>üìã Backlog Items</h3>
                <span class="result-count" id="resultCount"></span>
            </div>
            <div class="table-wrapper">
                <table id="backlogTable">
                    <thead>
                        <tr>
                            <th data-sort="id">ID</th>
                            <th data-sort="title">Title</th>
                            <th data-sort="category">Category</th>
                            <th data-sort="priority">Priority</th>
                            <th data-sort="status">Status</th>
                            <th data-sort="sprint">Sprint</th>
                            <th data-sort="est_tokens">Estimate</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal-overlay" id="detailModal" onclick="if(event.target === this) closeModal()">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Backlog Item</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        // Backlog data will be injected here
        const backlogData = [
  {
    "id": "BACKLOG-001",
    "title": "Add ES Module Type to package.json",
    "category": "infra",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "[BACKLOG-001.md](BACKLOG-001.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-002",
    "title": "Code-Split Large JS Bundle",
    "category": "infra",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "[BACKLOG-002.md](BACKLOG-002.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-003",
    "title": "Improve First-Sync Time Estimation",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "[BACKLOG-003.md](BACKLOG-003.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-004",
    "title": "Add Sync History/Logs Screen",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "[BACKLOG-004.md](BACKLOG-004.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-005",
    "title": "Implement databaseService with LLM-Ready Patterns",
    "category": "service",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "[BACKLOG-005.md](BACKLOG-005.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-006",
    "title": "Dark Mode (Match System Settings)",
    "category": "ui",
    "priority": "Medium",
    "status": "Deferred",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "[BACKLOG-006.md](BACKLOG-006.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-007",
    "title": "Add iPhone Sync Integration Tests",
    "category": "test",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "[BACKLOG-007.md](BACKLOG-007.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-008",
    "title": "Redesign New Transaction Flow",
    "category": "ui",
    "priority": "High",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "2026-01-23",
    "file": "[BACKLOG-008.md](BACKLOG-008.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-009",
    "title": "Auth Popup Close Handler",
    "category": "ui",
    "priority": "High",
    "status": "Obsolete",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "[BACKLOG-009.md](BACKLOG-009.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-010",
    "title": "Default App Window to Full Screen",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "[BACKLOG-010.md](BACKLOG-010.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-011",
    "title": "Manually Add Missing Emails to Audit",
    "category": "ui",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "2026-01-23",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-012",
    "title": "Manually Add Missing Texts to Audit",
    "category": "ui",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "2026-01-23",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-013",
    "title": "Duplicate Transaction Detection",
    "category": "service",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-014",
    "title": "Update Joyride Demo for New Users",
    "category": "ui",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-011",
    "est_tokens": "~35K",
    "actual_tokens": "~18K",
    "variance": "-72%",
    "created_at": "2025-12-15",
    "completed_at": "2026-01-01",
    "file": "[BACKLOG-014.md](BACKLOG-014.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-015",
    "title": "Display Last Sync Time in UI",
    "category": "ui",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "2026-01-23",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-016",
    "title": "Refactor Contact Import",
    "category": "refactor",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-017",
    "title": "Naming Convention Documentation",
    "category": "docs",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-018",
    "title": "Smart Contact Sync",
    "category": "service",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-019",
    "title": "Returning User Experience",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-020",
    "title": "Device UUID Licensing",
    "category": "infra",
    "priority": "High",
    "status": "Obsolete",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-021",
    "title": "License Management System",
    "category": "infra",
    "priority": "High",
    "status": "Obsolete",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-022",
    "title": "Minimizable iPhone Sync Modal",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-023",
    "title": "Detailed Sync Progress",
    "category": "ui",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-024",
    "title": "Auto-Start Sync on Launch",
    "category": "service",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-025",
    "title": "Resume Failed Sync Prompt",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-026",
    "title": "Skip Driver Install Check",
    "category": "infra",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-027",
    "title": "Skip Mailbox Permission",
    "category": "service",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-028",
    "title": "Create App Logo & Branding",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-029",
    "title": "App Startup Performance",
    "category": "infra",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-030",
    "title": "Message Parser Async Yielding",
    "category": "service",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-031",
    "title": "Incremental Backup Size Estimation",
    "category": "service",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-032",
    "title": "Handle Backup Already in Progress",
    "category": "service",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-014",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "TASK-904, 910",
    "created_at": "2025-12-15",
    "completed_at": "2026-01-02",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-033",
    "title": "Check Supabase Terms Acceptance",
    "category": "service",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-034",
    "title": "Phone Type Card Layout",
    "category": "ui",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "2026-01-23",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-035",
    "title": "Remove Orphaned Table",
    "category": "schema",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-003",
    "est_tokens": "20-30K",
    "actual_tokens": "~40K",
    "variance": "+25%",
    "created_at": "2025-12-16",
    "completed_at": "2025-12-17",
    "file": "[BACKLOG-035.md](BACKLOG-035.md)",
    "description": "<strong>Problem Statement</strong>\n\nThe database contains orphaned tables that are no longer used by the application:\n\u2022 <code>extraction_metrics</code> - Created for ML feedback loop, never implemented\n\u2022 <code>user_feedback</code> - Replaced by <code>ClassificationFeedback</code> model\n\nThese tables:\n1. Add unnecessary database size\n2. Cause confusion during schema review\n3. Have foreign key relationships to active tables\n4. May cause migration conflicts in future\n\n---\n\n<strong>Technical Analysis</strong>\n\n<strong>Orphaned Tables</strong>\n\n#### <code>extraction_metrics</code>\n**Location:** Created in Migration 5 (<code>databaseService.ts:914</code>)\n<code>CREATE TABLE extraction_metrics (\n  id TEXT PRIMARY KEY,\n  user_id TEXT NOT NULL,\n  field_name TEXT NOT NULL,\n  total_extractions INTEGER DEFAULT 0,\n  confirmed_correct INTEGER DEFAULT 0,\n  user_corrected INTEGER DEFAULT 0,\n  completely_wrong INTEGER DEFAULT 0,\n  avg_confidence INTEGER,\n  high_confidence_count INTEGER DEFAULT 0,\n  medium_confidence_count INTEGER DEFAULT 0,\n  low_confidence_count INTEGER DEFAULT 0,\n  period_start DATETIME,\n  period_end DATETIME,\n  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n  FOREIGN KEY (user_id) REFERENCES users_local(id) ON DELETE CASCADE\n)\n</code>\n**Status:** Never used - planned for ML training metrics, not implemented\n**Indexes:** <code>idx_extraction_metrics_user_id</code>, <code>idx_extraction_metrics_field</code>\n**Trigger:** <code>update_extraction_metrics_timestamp</code>\n\n#### <code>user_feedback</code>\n**Location:** Created in Migration 5 (<code>databaseService.ts:894</code>)\n<code>CREATE TABLE user_feedback (\n  id TEXT PRIMARY KEY,\n  user_id TEXT NOT NULL,\n  transaction_id TEXT NOT NULL,\n  field_name TEXT NOT NULL,\n  original_value TEXT,\n  corrected_value TEXT,\n  original_confidence INTEGER,\n  feedback_type TEXT CHECK (feedback_type IN ('correction', 'confirmation', 'rejection')),\n  source_communication_id TEXT,\n  user_notes TEXT,\n  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n  FOREIGN KEY (user_id) REFERENCES users_local(id) ON DELETE CASCADE,\n  FOREIGN KEY (transaction_id) REFERENCES transactions(id) ON DELETE CASCADE,\n  FOREIGN KEY (source_communication_id) REFERENCES communications(id) ON DELETE SET NULL\n)\n</code>\n**Status:** Deprecated - <code>UserFeedback</code> type marked <code>@deprecated</code> in <code>models.ts</code>\n**Indexes:** Multiple indexes exist\n**Replacement:** <code>ClassificationFeedback</code> interface in models.ts (not yet implemented as table)\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Codebase search confirms no active usage of these tables\n\u2610 Database backup created before removal\n\u2610 Migration script drops tables safely\n\u2610 Associated indexes dropped\n\u2610 Associated triggers dropped\n\u2610 Migration documented in schema version log\n\u2610 All tests pass after removal\n\u2610 Application starts correctly after migration\n\n---\n\n<strong>Implementation Approach</strong>\n\n<strong>Phase 1: Usage Audit (CRITICAL)</strong>\n1. Search entire codebase for <code>extraction_metrics</code> references\n2. Search entire codebase for <code>user_feedback</code> table references\n3. Distinguish between:\n   - Table references (SQL queries)\n   - Type references (<code>UserFeedback</code> interface - can remain deprecated)\n4. Document any unexpected usage\n\n<strong>Phase 2: Backup Strategy</strong>\n1. Document current row counts (likely 0)\n2. Export any existing data (if any)\n3. Create database backup point\n\n<strong>Phase 3: Migration Script</strong>\n1. Create new migration file\n2. Drop indexes first\n3. Drop triggers\n4. Drop tables\n5. Update schema version\n\n<strong>Phase 4: Verification</strong>\n1. Run all tests\n2. Start application\n3. Verify database operations work\n4. Check no errors in logs\n\n---\n\n<strong>Estimated Effort</strong>\n\n| Phase | Turns | Tokens | Time |\n|-------|-------|--------|------|\n| Usage Audit | 2-3 | ~10K | 15m |\n| Backup/Prep | 1-2 | ~5K | 10m |\n| Migration Script | 2-3 | ~10K | 15m |\n| Verification | 1-2 | ~5K | 10m |\n| **Total** | **5-8** | **~30K** | **~45m** |\n\n---\n\n<strong>Migration SQL</strong>\n\n<code>-- Drop indexes\nDROP INDEX IF EXISTS idx_extraction_metrics_user_id;\nDROP INDEX IF EXISTS idx_extraction_metrics_field;\nDROP INDEX IF EXISTS idx_user_feedback_user_id;\nDROP INDEX IF EXISTS idx_user_feedback_transaction_id;\nDROP INDEX IF EXISTS idx_user_feedback_field_name;\nDROP INDEX IF EXISTS idx_user_feedback_type;\n\n-- Drop triggers\nDROP TRIGGER IF EXISTS update_extraction_metrics_timestamp;\n\n-- Drop tables\nDROP TABLE IF EXISTS extraction_metrics;\nDROP TABLE IF EXISTS user_feedback;\n</code>\n\n---\n\n<strong>Risks</strong>\n\n| Risk | Impact | Mitigation |\n|------|--------|------------|\n| Hidden code dependency | High | Thorough codebase search before removal |\n| Data loss | Low | Tables likely empty; backup anyway |\n| Migration failure | Medium | Test on dev database first |\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 **MUST complete after:** BACKLOG-038, BACKLOG-039\n\u2022 Reason: Schema fixes should be verified working before any table drops\n\n---\n\n<strong>Testing Requirements</strong>\n\n<strong>Pre-Removal Checks</strong>\n\u2022 Grep for all SQL references to tables\n\u2022 Run application, verify no errors\n\n<strong>Post-Removal Checks</strong>\n\u2022 All unit tests pass\n\u2022 All integration tests pass\n\u2022 Application starts without database errors\n\u2022 No warnings in logs about missing tables\n\n---\n\n<strong>STOP-AND-ASK Triggers</strong>\n\nIf during implementation you find:\n\u2022 Any active queries using these tables -> STOP and report to PM\n\u2022 Data exists in either table -> STOP, document data, ask PM about preservation\n\u2022 Foreign key conflicts -> STOP, document, ask PM\n\n---\n\n<strong>References</strong>\n\n\u2022 Table creation: <code>electron/services/databaseService.ts</code> (lines 894-962)\n\u2022 Deprecated type: <code>electron/types/models.ts</code> (UserFeedback interface)\n\u2022 New model: <code>ClassificationFeedback</code> interface in models.ts"
  },
  {
    "id": "BACKLOG-036",
    "title": "Fix Sync Phase UI Text",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-037",
    "title": "Don't Fail Sync on Disconnect",
    "category": "service",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-038",
    "title": "Schema Mismatch contacts.name",
    "category": "schema",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-003",
    "est_tokens": "40-60K",
    "actual_tokens": "~30K",
    "variance": "-36%",
    "created_at": "2025-12-16",
    "completed_at": "2025-12-17",
    "file": "[BACKLOG-038.md](BACKLOG-038.md)",
    "description": "<strong>Problem Statement</strong>\n\nThe <code>contacts</code> table schema has both <code>name</code> (deprecated) and <code>display_name</code> (canonical) columns. Code inconsistently uses both, causing:\n1. Data written to wrong column\n2. Queries returning null when data exists in other column\n3. UI showing empty names for valid contacts\n4. Backwards compatibility workarounds scattered throughout codebase\n\n---\n\n<strong>Technical Analysis</strong>\n\n<strong>Current State</strong>\n\n**Database Schema:**\n\u2022 <code>contacts.display_name</code> - Canonical column (should be primary)\n\u2022 <code>contacts.name</code> - Deprecated column (exists for backwards compatibility)\n\n**Type Definition** (<code>electron/types/models.ts</code>):\n<code>export interface Contact {\n  display_name?: string; // Optional for backwards compat - use name as fallback\n  /** @deprecated Use display_name instead */\n  name?: string;\n}\n</code>\n\n**Workaround Code** (<code>contactDbService.ts</code>):\n<code>// Line 41: Fallback in createContact\ndisplay_name: contactData.display_name || contactData.name || \"Unknown\",\n\n// Line 109, 135, 170: Aliasing in queries\nc.display_name as name,\n</code>\n\n<strong>Problem Scope</strong>\n\nFiles with <code>contacts.name</code> references:\n\u2022 <code>electron/services/db/contactDbService.ts</code> - Multiple workarounds\n\u2022 <code>electron/services/contactsService.ts</code> - May have direct references\n\u2022 <code>src/appCore/state/*.ts</code> - UI state may expect <code>name</code>\n\u2022 Various React components - May render <code>contact.name</code>\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 All database queries use <code>display_name</code> as the source of truth\n\u2610 <code>NewContact</code> type requires <code>display_name</code>, deprecates <code>name</code>\n\u2610 All write operations populate <code>display_name</code> only\n\u2610 All read operations return <code>display_name</code> (no aliasing needed)\n\u2610 Backwards compatibility layer clearly documented and isolated\n\u2610 Migration script copies any orphaned <code>name</code> values to <code>display_name</code>\n\u2610 UI components updated to use <code>display_name</code>\n\u2610 All existing tests pass\n\u2610 New tests verify correct column usage\n\n---\n\n<strong>Implementation Approach</strong>\n\n<strong>Phase 1: Data Migration</strong>\n1. Create migration that copies <code>name</code> -> <code>display_name</code> where <code>display_name</code> is null\n2. Verify no data loss\n\n<strong>Phase 2: Service Layer Update</strong>\n1. Update <code>createContact</code> to only write <code>display_name</code>\n2. Remove aliasing workarounds from queries\n3. Update <code>NewContact</code> type to make <code>display_name</code> required\n\n<strong>Phase 3: UI Update</strong>\n1. Search for <code>contact.name</code> usage in React components\n2. Update to <code>contact.display_name</code>\n3. Update any type assertions\n\n<strong>Phase 4: Cleanup</strong>\n1. Remove deprecated <code>name</code> field handling\n2. Document migration path for external consumers\n\n---\n\n<strong>Estimated Effort</strong>\n\n| Phase | Turns | Tokens | Time |\n|-------|-------|--------|------|\n| Data Migration | 3-5 | ~15K | 20m |\n| Service Layer | 4-6 | ~20K | 30m |\n| UI Update | 2-3 | ~10K | 15m |\n| Testing | 2-3 | ~10K | 15m |\n| **Total** | **10-15** | **~55K** | **~1.5h** |\n\n---\n\n<strong>Risks</strong>\n\n| Risk | Impact | Mitigation |\n|------|--------|------------|\n| Data loss during migration | High | Backup before, copy don't delete |\n| Breaking external imports | Medium | Keep <code>name</code> field readable temporarily |\n| UI regressions | Medium | Manual UI testing after changes |\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 None (can be done in parallel with BACKLOG-039)\n\n---\n\n<strong>Testing Requirements</strong>\n\n<strong>Unit Tests</strong>\n\u2022 <code>createContact</code> writes to <code>display_name</code>\n\u2022 <code>getContacts</code> returns <code>display_name</code> populated\n\u2022 Legacy <code>name</code> fallback works for old data\n\n<strong>Integration Tests</strong>\n\u2022 End-to-end contact creation shows correct name in UI\n\u2022 Imported contacts display properly\n\n---\n\n<strong>References</strong>\n\n\u2022 Type definition: <code>electron/types/models.ts</code> (Contact interface)\n\u2022 Service implementation: <code>electron/services/db/contactDbService.ts</code>\n\u2022 Related backlog: BACKLOG-016 (Refactor Contact Import)"
  },
  {
    "id": "BACKLOG-039",
    "title": "Schema Mismatch transactions.status",
    "category": "schema",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-003",
    "est_tokens": "40-60K",
    "actual_tokens": "~100K",
    "variance": "+100%",
    "created_at": "2025-12-16",
    "completed_at": "2025-12-17",
    "file": "[BACKLOG-039.md](BACKLOG-039.md)",
    "description": "<strong>Problem Statement</strong>\n\nThe <code>transactions.status</code> column accepts values that don't match the TypeScript enum. Legacy values like \"completed\" and \"pending\" are used in some code paths while the canonical values are \"active\", \"closed\", \"archived\".\n\nThis causes:\n1. Inconsistent data in the database\n2. Filter queries failing to match records\n3. UI status badges showing unexpected states\n4. Runtime type mismatches\n\n---\n\n<strong>Technical Analysis</strong>\n\n<strong>Current State</strong>\n\n**Type Definition** (<code>electron/types/models.ts</code>):\n<code>export type TransactionStatus = \"active\" | \"closed\" | \"archived\";\n\nexport interface Transaction {\n  status: TransactionStatus;\n  /** @deprecated Use status instead */\n  transaction_status?: string;\n}\n</code>\n\n**Workaround Code** (<code>transactionDbService.ts</code>):\n<code>// Lines 46-55: Mapping in createTransaction\nstatus: (() => {\n  const rawStatus = transactionData.transaction_status || transactionData.status || \"active\";\n  if (rawStatus === \"completed\") return \"closed\";\n  if (rawStatus === \"pending\") return \"active\";\n  if ([\"active\", \"closed\", \"archived\"].includes(rawStatus)) return rawStatus;\n  return \"active\";\n})(),\n</code>\n\n<strong>Problem Scope</strong>\n\n**Values in use:**\n\u2022 Canonical: <code>\"active\"</code>, <code>\"closed\"</code>, <code>\"archived\"</code>\n\u2022 Legacy: <code>\"completed\"</code>, <code>\"pending\"</code>, <code>\"open\"</code> (possibly others)\n\n**Affected code paths:**\n\u2022 <code>transactionDbService.ts</code> - createTransaction, updateTransaction\n\u2022 <code>transactionService.ts</code> - May have additional mappings\n\u2022 API handlers - May accept legacy values\n\u2022 UI components - May display unmapped values\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Database CHECK constraint enforces valid status values\n\u2610 All existing data normalized to canonical values\n\u2610 <code>createTransaction</code> validates status before insert\n\u2610 <code>updateTransaction</code> validates status before update\n\u2610 API layer rejects invalid status values with clear error\n\u2610 UI status selectors only offer valid options\n\u2610 Migration script normalizes all existing records\n\u2610 Legacy <code>transaction_status</code> field removed from write paths\n\u2610 All tests pass with strict status validation\n\n---\n\n<strong>Implementation Approach</strong>\n\n<strong>Phase 1: Data Migration</strong>\n1. Query for non-canonical status values\n2. Create mapping script for legacy -> canonical\n3. Execute update migration\n4. Verify all records have valid status\n\n<strong>Phase 2: Add Database Constraint</strong>\n1. Add CHECK constraint to transactions.status\n2. Only allow: 'active', 'closed', 'archived'\n\n<strong>Phase 3: Service Layer Hardening</strong>\n1. Remove runtime mapping from createTransaction\n2. Add validation function with clear error messages\n3. Update updateTransaction to validate\n4. Remove deprecated <code>transaction_status</code> from write paths\n\n<strong>Phase 4: API/UI Alignment</strong>\n1. Update API handlers to validate before service call\n2. Ensure UI dropdowns use canonical values\n3. Update any hardcoded strings\n\n---\n\n<strong>Estimated Effort</strong>\n\n| Phase | Turns | Tokens | Time |\n|-------|-------|--------|------|\n| Data Migration | 3-4 | ~15K | 20m |\n| Database Constraint | 2-3 | ~10K | 15m |\n| Service Layer | 3-5 | ~15K | 25m |\n| API/UI Updates | 2-3 | ~10K | 15m |\n| **Total** | **10-15** | **~50K** | **~1.5h** |\n\n---\n\n<strong>Status Value Mapping</strong>\n\n| Legacy Value | Canonical Value | Rationale |\n|--------------|-----------------|-----------|\n| \"completed\" | \"closed\" | Transaction finished |\n| \"pending\" | \"active\" | Transaction in progress |\n| \"open\" | \"active\" | Transaction in progress |\n| \"cancelled\" | \"archived\" | Transaction no longer active |\n| null/undefined | \"active\" | Default for new transactions |\n\n---\n\n<strong>Risks</strong>\n\n| Risk | Impact | Mitigation |\n|------|--------|------------|\n| Existing data with unknown values | High | Audit before migration, map all found values |\n| CHECK constraint blocks inserts | Medium | Ensure all write paths validated first |\n| UI shows wrong status | Low | Test UI after migration |\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 None (can be done in parallel with BACKLOG-038)\n\n---\n\n<strong>Testing Requirements</strong>\n\n<strong>Unit Tests</strong>\n\u2022 <code>createTransaction</code> rejects invalid status\n\u2022 <code>createTransaction</code> accepts all valid statuses\n\u2022 <code>updateTransaction</code> validates status\n\u2022 Status validation error messages are clear\n\n<strong>Integration Tests</strong>\n\u2022 Transaction list filters correctly by status\n\u2022 Status badge displays correct text\n\n<strong>Migration Tests</strong>\n\u2022 Run migration on test database with legacy values\n\u2022 Verify all records have valid status after\n\n---\n\n<strong>References</strong>\n\n\u2022 Type definition: <code>electron/types/models.ts</code> (TransactionStatus type)\n\u2022 Service implementation: <code>electron/services/db/transactionDbService.ts</code>\n\u2022 Related: Transaction UI components"
  },
  {
    "id": "BACKLOG-040",
    "title": "ContactsService macOS Paths",
    "category": "service",
    "priority": "Medium",
    "status": "Deferred",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-041",
    "title": "Create UX Engineer Agent",
    "category": "docs",
    "priority": "Medium",
    "status": "Obsolete",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-042",
    "title": "Lookback Period Not Persistent",
    "category": "service",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "2026-01-23",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-043",
    "title": "Settings Screen Not Scrollable",
    "category": "ui",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "2026-01-23",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-044",
    "title": "Multiple Contacts Per Role",
    "category": "ui",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "Backend + UI implemented",
    "created_at": "2025-12-15",
    "completed_at": "2025-12-20",
    "file": "",
    "description": ""
  },
  {
    "id": "BACKLOG-045",
    "title": "Block Contact Deletion",
    "category": "service",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "getTransactionsByContact + tests",
    "created_at": "2025-12-15",
    "completed_at": "2025-12-20",
    "file": "",
    "description": ""
  },
  {
    "id": "BACKLOG-046",
    "title": "DB Init Circuit Breaker",
    "category": "service",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-047",
    "title": "Contact Deletion Query Fix",
    "category": "service",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-048",
    "title": "Transaction Edit Preserve Tab",
    "category": "ui",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "2026-01-23",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-049",
    "title": "Communications Tab",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-050",
    "title": "Attachments Tab",
    "category": "ui",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-010",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "Addressed by TASK-706",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "",
    "description": ""
  },
  {
    "id": "BACKLOG-051",
    "title": "Delete Comms/Attachments",
    "category": "service",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-052",
    "title": "AI Transaction Timeline",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-053",
    "title": "Manually Add Communications",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-054",
    "title": "Render Email HTML",
    "category": "ui",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-010",
    "est_tokens": "~35K-55K",
    "actual_tokens": "-",
    "variance": "Addressed by TASK-701",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "",
    "description": ""
  },
  {
    "id": "BACKLOG-055",
    "title": "AI House Viewing Extraction",
    "category": "service",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-056",
    "title": "macOS Code Signing Fix",
    "category": "infra",
    "priority": "High",
    "status": "Obsolete",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-057",
    "title": "Login Auth Timeout Retry",
    "category": "service",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-058",
    "title": "Split databaseService.ts",
    "category": "refactor",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-002",
    "est_tokens": "200-300K",
    "actual_tokens": "~135K",
    "variance": "-54%",
    "created_at": "2025-12-15",
    "completed_at": "2025-12-16",
    "file": "[BACKLOG-058.md](BACKLOG-058.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-059",
    "title": "Fix Skipped Tests (27+)",
    "category": "test",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-002",
    "est_tokens": "48-72K",
    "actual_tokens": "~65K",
    "variance": "-7%",
    "created_at": "2025-12-15",
    "completed_at": "2025-12-16",
    "file": "[BACKLOG-059.md](BACKLOG-059.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-060",
    "title": "Fix N+1 Query Pattern",
    "category": "refactor",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-002",
    "est_tokens": "40-60K",
    "actual_tokens": "~55K",
    "variance": "+12%",
    "created_at": "2025-12-15",
    "completed_at": "2025-12-16",
    "file": "[BACKLOG-060.md](BACKLOG-060.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-061",
    "title": "Refactor Transactions.tsx",
    "category": "refactor",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-009",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "Addressed by TASK-605",
    "created_at": "2025-12-15",
    "completed_at": "2025-12-27",
    "file": "",
    "description": ""
  },
  {
    "id": "BACKLOG-062",
    "title": "Refactor Contacts.tsx",
    "category": "refactor",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-009",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "Addressed by TASK-606",
    "created_at": "2025-12-15",
    "completed_at": "2025-12-27",
    "file": "",
    "description": ""
  },
  {
    "id": "BACKLOG-063",
    "title": "Refactor useAppStateMachine.ts",
    "category": "refactor",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-009",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "Tests added by TASK-614",
    "created_at": "2025-12-15",
    "completed_at": "2025-12-27",
    "file": "",
    "description": ""
  },
  {
    "id": "BACKLOG-064",
    "title": "Add Batch DB Operations",
    "category": "service",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-065",
    "title": "Remove Console Statements",
    "category": "refactor",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-009",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "Addressed by TASK-616",
    "created_at": "2025-12-15",
    "completed_at": "2025-12-27",
    "file": "",
    "description": ""
  },
  {
    "id": "BACKLOG-066",
    "title": "LLM Transaction Detection",
    "category": "service",
    "priority": "High",
    "status": "Obsolete",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "Covered by AI MVP (BACKLOG-073-079)",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "",
    "description": ""
  },
  {
    "id": "BACKLOG-067",
    "title": "AI Timeline Builder",
    "category": "service",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-068",
    "title": "Contact Deduplication",
    "category": "service",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-069",
    "title": "Telemetry & Analytics",
    "category": "infra",
    "priority": "Low",
    "status": "Deferred",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-070",
    "title": "Enterprise User Management",
    "category": "infra",
    "priority": "Low",
    "status": "Deferred",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-071",
    "title": "Atomic Transaction Creation",
    "category": "service",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-15",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-072",
    "title": "Enforce Engineer Workflow Compliance",
    "category": "config",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-003",
    "est_tokens": "90-140K",
    "actual_tokens": "~52K",
    "variance": "-62%",
    "created_at": "2025-12-16",
    "completed_at": "2025-12-17",
    "file": "[BACKLOG-072.md](BACKLOG-072.md)",
    "description": "<strong>Problem Statement</strong>\n\nSPRINT-002 audit revealed **0% workflow compliance** across all 5 PRs:\n\u2022 No Plan agent invocations\n\u2022 No Engineer Metrics in PR descriptions\n\u2022 No SR Engineer reviews\n\u2022 All PRs self-merged\n\u2022 No PM handoffs between tasks\n\nThis undermines the entire estimation calibration system and quality gates.\n\n---\n\n<strong>Root Cause Analysis</strong>\n\n| Issue | Cause | Impact |\n|-------|-------|--------|\n| No Plan agent | Not enforced, easy to skip | No upfront design review |\n| No metrics | PR template doesn't require them | Can't calibrate estimates |\n| Self-merge | Branch protection allows it | No code review gate |\n| No SR review | Not enforced in tooling | Quality gate bypassed |\n| No PM handoff | Informal task assignment | No prioritization control |\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n<strong>1. Technical Enforcement</strong>\n\n\u2610 **PR Template** with required metrics section\n  - Template blocks submission without metrics table\n  - Includes Plan, Implementation, Debug breakdown\n\n\u2610 **Branch Protection Rules**\n  - Require at least 1 review before merge\n  - Prevent self-approval\n  - Require status checks to pass\n\n\u2610 **CI Check for Metrics**\n  - Add workflow step that validates PR description contains metrics table\n  - Fail CI if metrics missing\n\n<strong>2. Agent Enforcement</strong>\n\n\u2610 **Engineer Agent** must invoke Plan agent before implementation\n  - Add check in engineer.md that blocks coding without plan\n  - Plan agent outputs a plan file that must exist\n\n\u2610 **SR Engineer Agent** must verify:\n  - Engineer Metrics present in PR\n  - Plan was created (plan file exists)\n  - Tests pass before approving\n\n\u2610 **PM Agent** must:\n  - Assign tasks formally (create task file)\n  - Receive completion reports with metrics\n  - Update backlog with actuals\n\n<strong>3. Documentation</strong>\n\n\u2610 Update <code>engineer-workflow.md</code> with enforcement details\n\u2610 Add examples of compliant vs non-compliant PRs\n\u2610 Create \"Workflow Violation\" escalation process\n\n---\n\n<strong>Implementation Approach</strong>\n\n<strong>Phase 1: PR Template & Branch Protection</strong>\n1. Create <code>.github/PULL_REQUEST_TEMPLATE.md</code> with metrics section\n2. Update branch protection rules in GitHub settings\n3. Add CI step to validate PR description format\n\n<strong>Phase 2: Agent Guardrails</strong>\n1. Update <code>engineer.md</code> with Plan-First blocking logic\n2. Update <code>senior-engineer-pr-lead.md</code> with verification checklist\n3. Update PM skill to require formal task assignment\n\n<strong>Phase 3: Monitoring</strong>\n1. Add sprint retrospective template that audits compliance\n2. Create dashboard/report for workflow metrics\n3. Weekly compliance review by PM\n\n---\n\n<strong>Estimated Effort</strong>\n\n| Phase | Turns | Tokens | Time |\n|-------|-------|--------|------|\n| Phase 1: Templates & CI | 8-12 | 30-50K | 1h |\n| Phase 2: Agent Updates | 10-15 | 40-60K | 1.5h |\n| Phase 3: Monitoring | 5-8 | 20-30K | 45m |\n| **Total** | **23-35** | **90-140K** | **~3h** |\n\n---\n\n<strong>Success Metrics</strong>\n\n| Metric | Current | Target |\n|--------|---------|--------|\n| Plan Agent Usage | 0% | 100% |\n| Metrics in PRs | 0% | 100% |\n| SR Review Rate | 0% | 100% |\n| Self-Merge Rate | 100% | 0% |\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 GitHub repo admin access (branch protection)\n\u2022 Agent file update permissions\n\n---\n\n<strong>Notes</strong>\n\nThis is a **process debt** item, not technical debt. However, it's critical for:\n1. Estimation accuracy improvement\n2. Code quality gates\n3. Knowledge transfer between agents\n4. Sprint velocity tracking\n\nWithout enforcement, the workflow documentation is just aspirational.\n\n---\n\n<strong>References</strong>\n\n\u2022 <code>engineer-workflow.md</code> - Current workflow docs\n\u2022 <code>senior-engineer-pr-lead.md</code> - SR review process\n\u2022 <code>SPRINT-002-tech-debt-review.md</code> - Audit findings"
  },
  {
    "id": "BACKLOG-073",
    "title": "AI MVP Phase 0 - Schema Foundation",
    "category": "schema",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-004",
    "est_tokens": "~50K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-073.md](BACKLOG-073.md)",
    "created_at": "2025-12-16",
    "completed_at": "2025-12-17",
    "file": "",
    "description": "<strong>Description</strong>\n\nAdd database schema foundation for AI Transaction Auto-Detection MVP. This phase creates the necessary tables and fields for LLM integration, detection tracking, and user consent.\n\n**Note:** ~40% of originally planned schema work is already done. This backlog item covers only net-new implementations.\n\n---\n\n<strong>Tasks</strong>\n\n<strong>S01: Add Detection Fields to Transactions Table (Partial)</strong>\n**Estimated:** 5 turns\n\nAdd columns for AI detection tracking:\n<code>ALTER TABLE transactions ADD COLUMN detection_source TEXT DEFAULT 'manual'\n  CHECK (detection_source IN ('manual', 'auto', 'hybrid'));\nALTER TABLE transactions ADD COLUMN detection_status TEXT DEFAULT 'confirmed'\n  CHECK (detection_status IN ('pending', 'confirmed', 'rejected'));\nALTER TABLE transactions ADD COLUMN detection_confidence REAL;\nALTER TABLE transactions ADD COLUMN detection_method TEXT;\nALTER TABLE transactions ADD COLUMN suggested_contacts TEXT;  -- JSON\nALTER TABLE transactions ADD COLUMN reviewed_at DATETIME;\nALTER TABLE transactions ADD COLUMN rejection_reason TEXT;\n</code>\n\n**Acceptance Criteria:**\n\u2610 Migration adds all columns with proper defaults\n\u2610 Existing transactions unaffected (default: manual, confirmed)\n\u2610 TypeScript types updated in <code>electron/types/models.ts</code>\n\n<strong>S02: Create llm_settings Table</strong>\n**Estimated:** 5 turns\n\nNew table for API key management and usage tracking:\n<code>CREATE TABLE llm_settings (\n  id TEXT PRIMARY KEY,\n  user_id TEXT NOT NULL UNIQUE,\n  openai_api_key_encrypted TEXT,\n  anthropic_api_key_encrypted TEXT,\n  preferred_provider TEXT DEFAULT 'openai',\n  openai_model TEXT DEFAULT 'gpt-4o-mini',\n  anthropic_model TEXT DEFAULT 'claude-3-haiku-20240307',\n  tokens_used_this_month INTEGER DEFAULT 0,\n  budget_limit_tokens INTEGER,\n  budget_reset_date DATE,\n  platform_allowance_tokens INTEGER DEFAULT 0,\n  platform_allowance_used INTEGER DEFAULT 0,\n  use_platform_allowance INTEGER DEFAULT 0,\n  enable_auto_detect INTEGER DEFAULT 1,\n  enable_role_extraction INTEGER DEFAULT 1,\n  llm_data_consent INTEGER DEFAULT 0,\n  llm_data_consent_at DATETIME,\n  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n  FOREIGN KEY (user_id) REFERENCES users_local(id) ON DELETE CASCADE\n);\n</code>\n\n**Acceptance Criteria:**\n\u2610 Table created with all columns\n\u2610 Foreign key to users_local works\n\u2610 TypeScript LLMSettings interface added\n\n<strong>S05-Partial: Add llm_analysis Field to Messages</strong>\n**Estimated:** 3 turns\n\nAdd single column for storing full LLM analysis response:\n<code>ALTER TABLE messages ADD COLUMN llm_analysis TEXT;  -- JSON\n</code>\n\n**Note:** Other classification fields already exist (<code>classification_method</code>, <code>classification_confidence</code>).\n\n**Acceptance Criteria:**\n\u2610 Column added to messages table\n\u2610 Existing messages unaffected\n\n<strong>S07: Supabase Platform Allowance Schema</strong>\n**Estimated:** 3 turns\n\nAdd to Supabase users table (cloud migration):\n<code>ALTER TABLE users ADD COLUMN llm_monthly_allowance INTEGER DEFAULT 50000;\nALTER TABLE users ADD COLUMN llm_allowance_used INTEGER DEFAULT 0;\nALTER TABLE users ADD COLUMN llm_allowance_reset_date DATE;\n</code>\n\n**Acceptance Criteria:**\n\u2610 Supabase migration created\n\u2610 Fields accessible via Supabase client\n\n<strong>S08: Migration Testing</strong>\n**Estimated:** 6 turns\n\nTest Migration 008 on both fresh and existing databases.\n\n**Acceptance Criteria:**\n\u2610 Migration runs without errors on fresh database\n\u2610 Migration runs without errors on database with existing transactions\n\u2610 All new columns have proper defaults\n\u2610 Rollback tested (if applicable)\n\n---\n\n<strong>Already Implemented (Skipped)</strong>\n\n| Original Task | Status | Location |\n|---------------|--------|----------|\n| S03: classification_feedback table | EXISTS | <code>user_feedback</code> table covers this use case |\n| S04: attachments table | EXISTS | <code>has_attachments</code> field + metadata pattern |\n| S05: communications classification | EXISTS | <code>classification_method</code>, <code>classification_confidence</code> on messages |\n| S06: contacts engagement fields | EXISTS | <code>last_inbound_at</code>, <code>last_outbound_at</code>, <code>total_messages</code>, <code>tags</code> |\n\n---\n\n<strong>Quality Gate: Schema Ready</strong>\n\nBefore marking complete, verify:\n\u2610 Migration 008 runs on fresh DB\n\u2610 Migration 008 runs on existing DB with data\n\u2610 All new columns have proper defaults\n\u2610 TypeScript types match database schema exactly\n\u2610 No regression in existing functionality\n\n---\n\n<strong>Files to Modify</strong>\n\n| File | Changes |\n|------|---------|\n| <code>electron/services/databaseService.ts</code> | Add Migration 008 |\n| <code>electron/types/models.ts</code> | Add detection types, LLMSettings interface |\n| <code>electron/database/schema.sql</code> | Document new schema (reference) |\n\n<strong>Files to Create</strong>\n\n| File | Purpose |\n|------|---------|\n| <code>electron/services/db/llmSettingsDbService.ts</code> | CRUD for llm_settings table |\n\n---\n\n<strong>Security Considerations</strong>\n\n\u2022 API keys must be encrypted using <code>databaseEncryptionService</code>\n\u2022 <code>llm_data_consent</code> flag required before sending data to LLM providers\n\u2022 Consent timestamp (<code>llm_data_consent_at</code>) for compliance audit trail\n\n---\n\n<strong>Metrics Tracking</strong>\n\n| Phase | Turns | Tokens | Time |\n|-------|-------|--------|------|\n| Implementation | - | - | - |\n| PR Review | - | - | - |\n| Debugging/Fixes | - | - | - |\n| **Total** | - | - | - |\n\n*Fill in after completion*"
  },
  {
    "id": "BACKLOG-074",
    "title": "AI MVP Phase 1 - LLM Infrastructure",
    "category": "service",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-004",
    "est_tokens": "~70K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-074.md](BACKLOG-074.md)",
    "created_at": "2025-12-16",
    "completed_at": "2025-12-17",
    "file": "",
    "description": "<strong>Description</strong>\n\nBuild the core LLM service layer with provider abstraction, supporting both OpenAI and Anthropic. This phase establishes the foundation for all AI-powered features.\n\n---\n\n<strong>Tasks</strong>\n\n<strong>L01a: Create LLM Base Interface and Abstract Class</strong>\n**Estimated:** 3 turns\n**File:** <code>electron/services/llm/baseLLMService.ts</code>\n\nDefine core interfaces and abstract class:\n<code>interface LLMConfig {\n  provider: 'openai' | 'anthropic';\n  apiKey: string;\n  model: string;\n  maxTokens?: number;\n  temperature?: number;\n}\n\ninterface LLMResponse {\n  content: string;\n  tokensUsed: { prompt: number; completion: number };\n  model: string;\n  finishReason: string;\n}\n\nabstract class BaseLLMService {\n  abstract complete(prompt: string, config: LLMConfig): Promise<LLMResponse>;\n  abstract completeWithTools(prompt: string, tools: Tool[], config: LLMConfig): Promise<LLMResponse>;\n}\n</code>\n\n**Acceptance Criteria:**\n\u2610 Interfaces defined and exported\n\u2610 Abstract class with common methods\n\u2610 Error types defined\n\n<strong>L01b: Implement Retry and Rate Limiting</strong>\n**Estimated:** 3 turns\n**File:** <code>electron/services/llm/baseLLMService.ts</code>\n\nAdd to base class:\n\u2022 Exponential backoff retry (max 3 attempts)\n\u2022 Rate limiting (configurable requests/minute)\n\u2022 Circuit breaker pattern for repeated failures\n\n**Acceptance Criteria:**\n\u2610 Retry logic with exponential backoff\n\u2610 Rate limiter prevents excessive calls\n\u2610 Circuit breaker opens after repeated failures\n\n<strong>L01c: Implement Token Counting and Usage Tracking</strong>\n**Estimated:** 2 turns\n**File:** <code>electron/services/llm/baseLLMService.ts</code>\n\n\u2022 Token estimation before API call\n\u2022 Token tracking after API call\n\u2022 Usage persistence to database\n\u2022 Budget enforcement (block requests when exceeded)\n\n**Acceptance Criteria:**\n\u2610 Token estimation works for both providers\n\u2610 Usage saved to llm_settings table\n\u2610 Requests blocked when budget exceeded\n\n<strong>L02: Create OpenAI Service</strong>\n**Estimated:** 5 turns\n**File:** <code>electron/services/llm/openAIService.ts</code>\n\nImplements BaseLLMService for OpenAI API:\n\u2022 GPT-4o-mini (default, cost-effective)\n\u2022 GPT-4o (higher accuracy option)\n\u2022 JSON mode for structured outputs\n\u2022 Function calling support\n\n**Acceptance Criteria:**\n\u2610 Extends BaseLLMService\n\u2610 API calls work with valid key\n\u2610 JSON mode returns valid JSON\n\u2610 Error handling for API failures\n\n<strong>L03: Create Anthropic Service</strong>\n**Estimated:** 5 turns\n**File:** <code>electron/services/llm/anthropicService.ts</code>\n\nImplements BaseLLMService for Anthropic API:\n\u2022 Claude 3 Haiku (cost-effective)\n\u2022 Claude 3.5 Sonnet (higher accuracy)\n\u2022 Tool use support\n\n**Acceptance Criteria:**\n\u2610 Extends BaseLLMService\n\u2610 API calls work with valid key\n\u2610 Tool use returns structured data\n\u2610 Error handling for API failures\n\n<strong>L04: Create LLM Config Service</strong>\n**Estimated:** 3 turns\n**File:** <code>electron/services/llm/llmConfigService.ts</code>\n\nManages API keys and usage:\n<code>interface LLMConfigService {\n  getUserConfig(userId: string): Promise<LLMUserConfig>;\n  setApiKey(userId: string, provider: string, key: string): Promise<void>;\n  validateApiKey(provider: string, key: string): Promise<boolean>;\n  trackUsage(userId: string, tokens: number): Promise<void>;\n  checkBudget(userId: string): Promise<{ canProceed: boolean; remaining: number }>;\n  syncPlatformAllowance(userId: string): Promise<void>;\n}\n</code>\n\n**Acceptance Criteria:**\n\u2610 API keys encrypted via databaseEncryptionService\n\u2610 Usage tracking increments correctly\n\u2610 Budget check blocks when exceeded\n\u2610 Platform allowance syncs from Supabase\n\n<strong>L05: Create LLM Handlers</strong>\n**Estimated:** 2 turns\n**File:** <code>electron/llm-handlers.ts</code>\n\nIPC handlers for frontend communication:\n\u2022 <code>llm:get-config</code> - Get user's LLM settings\n\u2022 <code>llm:set-api-key</code> - Store API key securely\n\u2022 <code>llm:validate-key</code> - Test API key validity\n\u2022 <code>llm:get-usage</code> - Get usage stats\n\u2022 <code>llm:sync-allowance</code> - Sync platform allowance from Supabase\n\n**Acceptance Criteria:**\n\u2610 All handlers registered in main.ts\n\u2610 Preload bridge methods added\n\u2610 Error responses properly formatted\n\n<strong>L06: LLM Error Boundary Component</strong>\n**Estimated:** 3 turns\n**File:** <code>src/components/LLMErrorBoundary.tsx</code>\n\nUI component to handle LLM API failures gracefully:\n\u2022 Display user-friendly error messages\n\u2022 Retry button for transient failures\n\u2022 Link to settings if API key invalid\n\u2022 Fallback to pattern-matching notification\n\n**Acceptance Criteria:**\n\u2610 Catches LLM-specific errors\n\u2610 Shows actionable error messages\n\u2610 Retry functionality works\n\u2610 Links to settings page\n\n<strong>NEW: Content Sanitizer (Security - Option A)</strong>\n**Estimated:** 2 turns\n**File:** <code>electron/services/llm/contentSanitizer.ts</code>\n\nSanitize email content before sending to LLM:\n\u2022 Strip email signatures\n\u2022 Remove confidential footers/disclaimers\n\u2022 Redact SSN patterns, credit card numbers\n\u2022 Truncate excessive quoted threads\n\n**Acceptance Criteria:**\n\u2610 PII patterns redacted\n\u2610 Signatures stripped\n\u2610 Content length reasonable for token limits\n\n---\n\n<strong>Quality Gate: LLM Infrastructure Ready</strong>\n\nBefore marking complete, verify:\n\u2610 OpenAI key validation works (manual test)\n\u2610 Anthropic key validation works (manual test)\n\u2610 Usage tracking increments correctly\n\u2610 Budget enforcement blocks when exceeded\n\u2610 Content sanitization removes PII\n\u2610 Unit tests pass with mocked LLM responses\n\n---\n\n<strong>Files to Create</strong>\n\n| File | Purpose |\n|------|---------|\n| <code>electron/services/llm/baseLLMService.ts</code> | Abstract base class |\n| <code>electron/services/llm/openAIService.ts</code> | OpenAI implementation |\n| <code>electron/services/llm/anthropicService.ts</code> | Anthropic implementation |\n| <code>electron/services/llm/llmConfigService.ts</code> | API key + usage management |\n| <code>electron/services/llm/contentSanitizer.ts</code> | Security - content sanitization |\n| <code>electron/llm-handlers.ts</code> | IPC handlers |\n| <code>src/components/LLMErrorBoundary.tsx</code> | Error handling UI |\n\n<strong>Files to Modify</strong>\n\n| File | Changes |\n|------|---------|\n| <code>electron/main.ts</code> | Register llm-handlers |\n| <code>electron/preload.ts</code> | Add LLM bridge methods |\n| <code>package.json</code> | Add openai, @anthropic-ai/sdk dependencies |\n\n---\n\n<strong>Dependencies (npm)</strong>\n\n<code>{\n  \"openai\": \"^4.x\",\n  \"@anthropic-ai/sdk\": \"^0.x\"\n}\n</code>\n\n---\n\n<strong>Metrics Tracking</strong>\n\n| Phase | Turns | Tokens | Time |\n|-------|-------|--------|------|\n| Implementation | - | - | - |\n| PR Review | - | - | - |\n| Debugging/Fixes | - | - | - |\n| **Total** | - | - | - |\n\n*Fill in after completion*"
  },
  {
    "id": "BACKLOG-075",
    "title": "AI MVP Phase 2 - AI Analysis Tools",
    "category": "service",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-005",
    "est_tokens": "~70K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-075.md](BACKLOG-075.md)",
    "created_at": "2025-12-16",
    "completed_at": "",
    "file": "",
    "description": "<strong>Description</strong>\n\nCreate pure-function AI tools for transaction analysis. These tools analyze messages, extract contact roles, and cluster communications into transaction groups.\n\n---\n\n<strong>Tasks</strong>\n\n<strong>A01: Create Message Analyzer Tool</strong>\n**Estimated:** 4 turns\n**File:** <code>electron/services/llm/tools/analyzeMessageTool.ts</code>\n\nAnalyzes single message for real estate relevance.\n\n**Input:** Message content, sender, recipients, date\n\n**Output:**\n<code>interface MessageAnalysis {\n  isRealEstateRelated: boolean;\n  confidence: number;\n  transactionIndicators: {\n    type: 'purchase' | 'sale' | 'lease' | null;\n    stage: 'prospecting' | 'active' | 'pending' | 'closing' | 'closed' | null;\n  };\n  extractedEntities: {\n    addresses: Array<{ value: string; confidence: number }>;\n    amounts: Array<{ value: number; context: string }>;\n    dates: Array<{ value: string; type: 'closing' | 'inspection' | 'other' }>;\n    contacts: Array<{ name: string; email?: string; phone?: string; suggestedRole?: string }>;\n  };\n  reasoning: string;\n}\n</code>\n\n**Acceptance Criteria:**\n\u2610 Returns valid MessageAnalysis JSON\n\u2610 Identifies real estate keywords/phrases\n\u2610 Extracts addresses with confidence scores\n\u2610 Works with sanitized email content\n\n<strong>A02: Create Contact Role Extractor Tool</strong>\n**Estimated:** 3 turns\n**File:** <code>electron/services/llm/tools/extractContactRolesTool.ts</code>\n\nIdentifies contact roles from communication context.\n\n**Input:** Communication history, known contacts, property address\n\n**Output:**\n<code>interface ContactRoleExtraction {\n  assignments: Array<{\n    contactId?: string;\n    name: string;\n    email?: string;\n    role: string;  // 'buyer', 'seller', 'buyer_agent', 'seller_agent', 'escrow', 'inspector', etc.\n    confidence: number;\n    evidence: string[];  // Quotes from communications\n  }>;\n}\n</code>\n\n**Acceptance Criteria:**\n\u2610 Identifies common real estate roles\n\u2610 Provides evidence for each assignment\n\u2610 Handles ambiguous cases with lower confidence\n\u2610 Matches to existing contacts when possible\n\n<strong>A03: Create Transaction Clusterer Tool</strong>\n**Estimated:** 3 turns\n**File:** <code>electron/services/llm/tools/clusterTransactionsTool.ts</code>\n\nGroups communications into transaction clusters.\n\n**Input:** Array of analyzed messages\n\n**Output:**\n<code>interface TransactionCluster {\n  clusterId: string;\n  propertyAddress: string;\n  confidence: number;\n  transactionType: 'purchase' | 'sale' | 'lease' | null;\n  communicationIds: string[];\n  suggestedContacts: ContactRoleExtraction;\n  dateRange: { start: string; end: string };\n  summary: string;\n}\n</code>\n\n**Acceptance Criteria:**\n\u2610 Groups related messages by property address\n\u2610 Identifies transaction type from context\n\u2610 Provides date range for each cluster\n\u2610 Generates human-readable summary\n\n<strong>A04: Create Prompt Templates</strong>\n**Estimated:** 3 turns\n**File:** <code>electron/services/llm/prompts/</code>\n\nStructured prompts for each tool:\n\u2022 <code>messageAnalysis.ts</code> - System + user prompts for message analysis\n\u2022 <code>contactRoles.ts</code> - Prompts for role extraction\n\u2022 <code>transactionClustering.ts</code> - Prompts for clustering\n\n**Acceptance Criteria:**\n\u2610 Prompts use JSON mode for reliable parsing\n\u2610 System prompts define output schema\n\u2610 User prompts include sanitized content\n\u2610 Edge cases handled (empty body, foreign language)\n\n<strong>A05: Prompt Versioning System</strong>\n**Estimated:** 2 turns\n**File:** <code>electron/services/llm/promptVersionService.ts</code>\n\nTrack which prompt version produced each result:\n\n<code>interface PromptVersion {\n  id: string;\n  name: string;  // 'message-analysis-v1', 'contact-roles-v2'\n  version: string;\n  hash: string;  // SHA of prompt content\n  createdAt: Date;\n}\n\ninterface PromptVersionService {\n  getCurrentVersion(promptName: string): PromptVersion;\n  recordUsage(promptName: string, resultId: string): void;\n  getAccuracyByVersion(promptName: string): Map<string, number>;\n}\n</code>\n\n**Acceptance Criteria:**\n\u2610 Version ID stored with each LLM result\n\u2610 Can retrieve accuracy metrics by version\n\u2610 Enables A/B testing of prompt variations\n\n---\n\n<strong>Files to Create</strong>\n\n| File | Purpose |\n|------|---------|\n| <code>electron/services/llm/tools/analyzeMessageTool.ts</code> | Message analysis |\n| <code>electron/services/llm/tools/extractContactRolesTool.ts</code> | Role extraction |\n| <code>electron/services/llm/tools/clusterTransactionsTool.ts</code> | Transaction clustering |\n| <code>electron/services/llm/prompts/messageAnalysis.ts</code> | Message analysis prompts |\n| <code>electron/services/llm/prompts/contactRoles.ts</code> | Role extraction prompts |\n| <code>electron/services/llm/prompts/transactionClustering.ts</code> | Clustering prompts |\n| <code>electron/services/llm/promptVersionService.ts</code> | Prompt version tracking |\n\n---\n\n<strong>Quality Gate: AI Tools Ready</strong>\n\nBefore marking complete, verify:\n\u2610 Message analysis returns valid JSON\n\u2610 Role extraction identifies common roles (buyer, seller, agent, escrow, etc.)\n\u2610 Clustering groups messages by property address\n\u2610 Prompt snapshot tests pass\n\u2610 Tools work with both OpenAI and Anthropic providers\n\n---\n\n<strong>Testing Strategy</strong>\n\n<strong>Unit Tests</strong>\n\u2022 Mock LLM responses for deterministic testing\n\u2022 Test JSON parsing and validation\n\u2022 Test edge cases (empty input, malformed response)\n\n<strong>Prompt Regression Tests</strong>\n\u2022 Snapshot tests for prompt templates\n\u2022 Detect unintended prompt changes\n\u2022 Test multi-language content handling\n\n---\n\n<strong>Metrics Tracking</strong>\n\n| Phase | Turns | Tokens | Time |\n|-------|-------|--------|------|\n| Implementation | - | - | - |\n| PR Review | - | - | - |\n| Debugging/Fixes | - | - | - |\n| **Total** | - | - | - |\n\n*Fill in after completion*"
  },
  {
    "id": "BACKLOG-076",
    "title": "AI MVP Phase 3 - Hybrid Pipeline",
    "category": "service",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-005",
    "est_tokens": "~85K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-076.md](BACKLOG-076.md)",
    "created_at": "2025-12-16",
    "completed_at": "",
    "file": "",
    "description": "<strong>Description</strong>\n\nIntegrate AI analysis tools with existing pattern matching to create a hybrid extraction pipeline. This phase connects the AI tools to the transaction detection flow and merges results intelligently.\n\n---\n\n<strong>Tasks</strong>\n\n<strong>H01a: Create Hybrid Extractor Service Scaffold</strong>\n**Estimated:** 3 turns\n**File:** <code>electron/services/extraction/hybridExtractorService.ts</code>\n\nDefine interfaces and service structure:\n\n<code>interface HybridExtractorService {\n  analyzeMessages(\n    messages: ParsedEmail[],\n    options: {\n      usePatternMatching: boolean;\n      useLLM: boolean;\n      llmConfig: LLMConfig;\n    }\n  ): Promise<AnalyzedMessage[]>;\n\n  clusterIntoTransactions(\n    analyzedMessages: AnalyzedMessage[],\n    existingTransactions: Transaction[]\n  ): Promise<DetectedTransaction[]>;\n\n  extractContactRoles(\n    cluster: DetectedTransaction,\n    knownContacts: Contact[]\n  ): Promise<ContactRoleExtraction>;\n}\n</code>\n\n**Acceptance Criteria:**\n\u2610 Interfaces defined\n\u2610 Service class skeleton created\n\u2610 Dependency injection for LLM services\n\n<strong>H01b: Integrate Pattern Matching into Hybrid Service</strong>\n**Estimated:** 3 turns\n**File:** <code>electron/services/extraction/hybridExtractorService.ts</code>\n\nWire existing <code>TransactionExtractorService</code> into hybrid flow:\n\u2022 Call pattern matcher for initial analysis\n\u2022 Format results for combination with LLM results\n\u2022 Handle pattern-only mode (fallback)\n\n**Acceptance Criteria:**\n\u2610 Pattern matcher called first\n\u2610 Results formatted for merging\n\u2610 Works when LLM unavailable\n\n<strong>H01c: Integrate LLM Analysis into Hybrid Service</strong>\n**Estimated:** 4 turns\n**File:** <code>electron/services/extraction/hybridExtractorService.ts</code>\n\nWire LLM tools into hybrid flow:\n\u2022 Call A01-A03 tools for AI analysis\n\u2022 Handle LLM failures gracefully (fallback to pattern)\n\u2022 Use content sanitizer before sending to LLM\n\n**Acceptance Criteria:**\n\u2610 LLM tools called when enabled\n\u2610 Content sanitized before API calls\n\u2610 Graceful fallback on LLM failure\n\n<strong>H01d: Implement Result Merging Logic</strong>\n**Estimated:** 3 turns\n**File:** <code>electron/services/extraction/hybridExtractorService.ts</code>\n\nCombine pattern + LLM results:\n\u2022 Merge extracted entities from both sources\n\u2022 Resolve conflicts (prefer higher confidence)\n\u2022 Generate combined confidence score\n\n**Acceptance Criteria:**\n\u2610 Entities merged without duplicates\n\u2610 Conflicts resolved by confidence\n\u2610 Combined score calculated\n\n<strong>H02: Create Extraction Strategy Selector</strong>\n**Estimated:** 3 turns\n**File:** <code>electron/services/extraction/extractionStrategyService.ts</code>\n\nDecides which extraction method to use:\n\n<code>interface ExtractionStrategy {\n  method: 'pattern' | 'llm' | 'hybrid';\n  reason: string;\n}\n\ninterface ExtractionStrategyService {\n  selectStrategy(userId: string): Promise<ExtractionStrategy>;\n  // Considers: budget, API key availability, user preferences\n}\n</code>\n\n**Acceptance Criteria:**\n\u2610 Checks user's LLM budget\n\u2610 Checks API key availability\n\u2610 Fallback chain: LLM \u2192 Pattern \u2192 Manual\n\u2610 Returns reason for strategy selection\n\n<strong>H03: Create Confidence Aggregator</strong>\n**Estimated:** 2 turns\n**File:** <code>electron/services/extraction/confidenceAggregatorService.ts</code>\n\nCombines pattern + LLM confidence scores:\n\n<code>interface ConfidenceAggregator {\n  aggregate(\n    patternConfidence: number | null,\n    llmConfidence: number | null,\n    agreement: boolean  // Did both methods agree?\n  ): { score: number; level: 'high' | 'medium' | 'low' };\n}\n</code>\n\n**Acceptance Criteria:**\n\u2610 Higher score when methods agree\n\u2610 Weighted average when they disagree\n\u2610 Returns categorical level for UI\n\n<strong>H04: Update Transaction Service</strong>\n**Estimated:** 5 turns\n**File:** <code>electron/services/transactionService.ts</code>\n\nModify <code>scanAndExtractTransactions()</code> to use hybrid extraction:\n\n1. Fetch emails (existing)\n2. Run hybrid analysis (new)\n3. Cluster into detected transactions (new)\n4. Save with detection fields (pending user review)\n5. Return for UI display\n\n**Acceptance Criteria:**\n\u2610 Uses hybrid extractor when available\n\u2610 Sets <code>detection_source</code> and <code>detection_status</code>\n\u2610 Saves <code>suggested_contacts</code> JSON\n\u2610 Works with existing transaction list UI\n\n<strong>Unit Tests: LLM Service Tests (T01)</strong>\n**Estimated:** 3 turns\n**File:** <code>electron/services/llm/__tests__/</code>\n\nTest LLM services with mocked APIs:\n\u2022 Mock OpenAI/Anthropic responses\n\u2022 Test retry logic with simulated failures\n\u2022 Test rate limiting behavior\n\u2022 Test budget enforcement\n\n<strong>Unit Tests: Prompt Regression Tests (T02)</strong>\n**Estimated:** 3 turns\n**File:** <code>electron/services/llm/prompts/__tests__/</code>\n\nSnapshot tests for prompt templates:\n\u2022 Test prompt generation with sample inputs\n\u2022 Test edge cases (empty body, very long messages)\n\u2022 Detect unintended prompt changes\n\n<strong>Unit Tests: Confidence Aggregation Tests (T03)</strong>\n**Estimated:** 3 turns\n**File:** <code>electron/services/extraction/__tests__/</code>\n\nTest confidence score combination:\n\u2022 Test pattern + LLM score merging\n\u2022 Test edge cases (one method fails)\n\u2022 Test threshold behavior (high/medium/low)\n\n---\n\n<strong>Files to Create</strong>\n\n| File | Purpose |\n|------|---------|\n| <code>electron/services/extraction/hybridExtractorService.ts</code> | Main hybrid extraction logic |\n| <code>electron/services/extraction/extractionStrategyService.ts</code> | Strategy selection |\n| <code>electron/services/extraction/confidenceAggregatorService.ts</code> | Score merging |\n| <code>electron/services/llm/__tests__/llmService.test.ts</code> | LLM service tests |\n| <code>electron/services/llm/prompts/__tests__/prompts.test.ts</code> | Prompt tests |\n| <code>electron/services/extraction/__tests__/confidence.test.ts</code> | Aggregation tests |\n\n<strong>Files to Modify</strong>\n\n| File | Changes |\n|------|---------|\n| <code>electron/services/transactionService.ts</code> | Integrate hybrid extraction |\n\n---\n\n<strong>Quality Gate: Pipeline Ready</strong>\n\nBefore marking complete, verify:\n\u2610 Hybrid extraction produces pending transactions\n\u2610 Pattern matching works when LLM unavailable\n\u2610 Confidence scores display correctly\n\u2610 Fallback to pattern-only is seamless\n\u2610 All unit tests pass\n\n---\n\n<strong>Metrics Tracking</strong>\n\n| Phase | Turns | Tokens | Time |\n|-------|-------|--------|------|\n| Implementation | - | - | - |\n| PR Review | - | - | - |\n| Debugging/Fixes | - | - | - |\n| **Total** | - | - | - |\n\n*Fill in after completion*"
  },
  {
    "id": "BACKLOG-077",
    "title": "AI MVP Phase 4 - Feedback Loop",
    "category": "service",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-006",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-077.md](BACKLOG-077.md)",
    "created_at": "2025-12-16",
    "completed_at": "",
    "file": "",
    "description": "<strong>Description</strong>\n\nEnable users to correct AI mistakes and capture feedback for algorithm improvement. This phase creates the feedback capture system that records user corrections for future learning.\n\n---\n\n<strong>Tasks</strong>\n\n<strong>F01: Create Feedback Service</strong>\n**Estimated:** 3 turns\n**File:** <code>electron/services/feedbackService.ts</code>\n\nCaptures and stores user corrections:\n\n<code>interface FeedbackService {\n  recordTransactionFeedback(\n    detectedTransactionId: string,\n    action: 'confirm' | 'reject' | 'merge',\n    corrections?: {\n      propertyAddress?: string;\n      transactionType?: string;\n      addCommunications?: string[];\n      removeCommunications?: string[];\n    }\n  ): Promise<void>;\n\n  recordRoleFeedback(\n    transactionId: string,\n    contactId: string,\n    originalRole: string,\n    correctedRole: string\n  ): Promise<void>;\n\n  recordCommunicationFeedback(\n    communicationId: string,\n    wasRelevant: boolean,\n    correctTransactionId?: string\n  ): Promise<void>;\n\n  getFeedbackStats(userId: string): Promise<FeedbackStats>;\n}\n</code>\n\n**Note:** Uses existing <code>user_feedback</code> table with extended feedback types.\n\n**Acceptance Criteria:**\n\u2610 Feedback saved to user_feedback table\n\u2610 Original prediction stored for comparison\n\u2610 Model/prompt version tracked\n\u2610 Stats calculation works\n\n<strong>F02: Create Feedback Handlers</strong>\n**Estimated:** 2 turns\n**File:** <code>electron/feedback-handlers.ts</code>\n\nIPC handlers for recording feedback:\n\u2022 <code>feedback:record-transaction</code> - User confirms/rejects detected transaction\n\u2022 <code>feedback:record-role</code> - User corrects contact role\n\u2022 <code>feedback:record-relevance</code> - User marks communication relevant/irrelevant\n\u2022 <code>feedback:get-stats</code> - Get accuracy stats\n\n**Acceptance Criteria:**\n\u2610 Handlers registered in main.ts\n\u2610 Preload bridge methods added\n\u2610 Error responses formatted correctly\n\n<strong>F03: Update FeedbackLearningService</strong>\n**Estimated:** 3 turns\n**File:** <code>electron/services/feedbackLearningService.ts</code>\n\nExtend existing service to analyze LLM-specific feedback:\n\u2022 Track accuracy by model/provider\n\u2022 Track accuracy by prompt version\n\u2022 Detect systematic errors (e.g., always wrong about escrow officers)\n\u2022 Generate improvement suggestions\n\n<code>interface LLMFeedbackAnalysis {\n  accuracyByProvider: Map<string, number>;\n  accuracyByPromptVersion: Map<string, number>;\n  systematicErrors: Array<{\n    pattern: string;\n    frequency: number;\n    suggestion: string;\n  }>;\n}\n</code>\n\n**Acceptance Criteria:**\n\u2610 Accuracy tracked per provider\n\u2610 Accuracy tracked per prompt version\n\u2610 Systematic errors identified\n\u2610 Analysis available via API\n\n---\n\n<strong>Files to Create</strong>\n\n| File | Purpose |\n|------|---------|\n| <code>electron/services/feedbackService.ts</code> | Main feedback capture |\n| <code>electron/feedback-handlers.ts</code> | IPC handlers |\n\n<strong>Files to Modify</strong>\n\n| File | Changes |\n|------|---------|\n| <code>electron/services/feedbackLearningService.ts</code> | Add LLM-specific analysis |\n| <code>electron/main.ts</code> | Register feedback handlers |\n| <code>electron/preload.ts</code> | Add feedback bridge methods |\n\n---\n\n<strong>Integration with Existing Feedback System</strong>\n\nThe existing <code>user_feedback</code> table will be used with extended feedback types:\n\n**Current feedback_type values:**\n\u2022 <code>correction</code>\n\u2022 <code>confirmation</code>\n\u2022 <code>rejection</code>\n\n**Extended feedback_type values (add):**\n\u2022 <code>transaction_approved</code> - User approved AI-detected transaction\n\u2022 <code>transaction_rejected</code> - User rejected AI-detected transaction\n\u2022 <code>transaction_edited</code> - User edited before approving\n\u2022 <code>contact_role_corrected</code> - User changed suggested role\n\u2022 <code>communication_unlinked</code> - User removed comm from transaction\n\u2022 <code>communication_added</code> - User added comm to transaction\n\n---\n\n<strong>Quality Gate: Feedback Loop Ready</strong>\n\nBefore marking complete, verify:\n\u2610 Feedback recorded on approve/reject\n\u2610 Original prediction stored with feedback\n\u2610 Model/prompt version tracked\n\u2610 Stats calculation returns correct values\n\u2610 FeedbackLearningService identifies patterns\n\n---\n\n<strong>Metrics Tracking</strong>\n\n| Phase | Turns | Tokens | Time |\n|-------|-------|--------|------|\n| Implementation | - | - | - |\n| PR Review | - | - | - |\n| Debugging/Fixes | - | - | - |\n| **Total** | - | - | - |\n\n*Fill in after completion*"
  },
  {
    "id": "BACKLOG-078",
    "title": "AI MVP Phase 5 - UI Enhancements",
    "category": "ui",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-006",
    "est_tokens": "~40K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-078.md](BACKLOG-078.md)",
    "created_at": "2025-12-16",
    "completed_at": "",
    "file": "",
    "description": "<strong>Description</strong>\n\nEnhance existing UI components to support AI detection features. This phase adds LLM settings, detection status filters, approval workflows, and visual indicators for AI-detected transactions.\n\n---\n\n<strong>Tasks</strong>\n\n<strong>U01: LLM Settings Component</strong>\n**Estimated:** 3 turns\n**File:** <code>src/components/settings/LLMSettings.tsx</code>\n\nAdd to existing Settings page:\n\u2022 Two tabs: OpenAI | Anthropic\n\u2022 API key input with show/hide toggle\n\u2022 \"Validate Key\" button with status indicator (\u2713 valid, \u2717 invalid)\n\u2022 Model selection dropdown per provider\n\u2022 Usage display: \"X tokens used this month (limit: Y)\"\n\u2022 Platform allowance toggle: \"Use platform allowance instead\"\n\u2022 Feature toggles: Auto-detect, Role extraction\n\u2022 **Consent checkbox** (Option C): \"I understand my email content will be sent to [provider] for analysis\"\n\n**Acceptance Criteria:**\n\u2610 API key saved securely\n\u2610 Validation shows success/error states\n\u2610 Usage stats display correctly\n\u2610 Consent required before first use\n\n<strong>U02a: Add Detection Status Filter Tabs</strong>\n**Estimated:** 3 turns\n**File:** <code>src/components/TransactionList.tsx</code>\n\nAdd filter tabs to existing toolbar:\n\u2022 <code>All | Confirmed | Pending Review | Rejected</code>\n\u2022 Filter transactions by <code>detection_status</code> field\n\u2022 Update URL params for bookmarkable filters\n\u2022 Show count badge per tab\n\n**Acceptance Criteria:**\n\u2610 Tabs filter correctly\n\u2610 Counts update in real-time\n\u2610 URL reflects current filter\n\n<strong>U02b: Add Detection Badges to Transaction Cards</strong>\n**Estimated:** 3 turns\n**File:** <code>src/components/TransactionList.tsx</code>\n\nAdd visual indicators to transaction cards:\n\u2022 \"AI Detected\" badge (blue-purple gradient) for <code>detection_source='auto'</code>\n\u2022 \"Manual\" badge (gray) for <code>detection_source='manual'</code>\n\u2022 Confidence pill: \"85%\" with color scale\n  - Red: < 60%\n  - Yellow: 60-80%\n  - Green: > 80%\n\u2022 \"Pending Review\" warning badge for <code>detection_status='pending'</code>\n\n**Acceptance Criteria:**\n\u2610 Badges render correctly\n\u2610 Confidence colors match thresholds\n\u2610 Pending transactions visually distinct\n\n<strong>U02c: Add Approve/Reject Actions</strong>\n**Estimated:** 2 turns\n**File:** <code>src/components/TransactionList.tsx</code>\n\nAdd action buttons for pending transactions:\n\u2022 \u2713 Approve button \u2192 Update <code>detection_status='confirmed'</code>, record feedback\n\u2022 \u2717 Reject button \u2192 Show reason modal, update status, record feedback\n\u2022 Edit button \u2192 Open AuditTransactionModal in edit mode\n\u2022 Record all actions to feedback service\n\n**Acceptance Criteria:**\n\u2610 Approve updates status and records feedback\n\u2610 Reject shows reason modal\n\u2610 Edit opens modal in edit mode\n\u2610 Actions only show for pending transactions\n\n<strong>U03: Update AuditTransactionModal for Edit Mode</strong>\n**Estimated:** 2 turns\n**File:** <code>src/components/AuditTransactionModal.tsx</code>\n\nModify existing modal:\n1. Accept <code>editTransaction?: Transaction</code> prop\n2. If editing, pre-fill all fields from the transaction\n3. Allow skipping address verification if already verified\n4. Pre-populate suggested contacts from <code>transaction.suggested_contacts</code> JSON\n5. On save: update transaction instead of create, record feedback if changed\n\n**Acceptance Criteria:**\n\u2610 Edit mode pre-fills fields\n\u2610 Suggested contacts shown\n\u2610 Save updates existing transaction\n\u2610 Feedback recorded on changes\n\n<strong>U05: Suggested Contacts Display</strong>\n**Estimated:** 2 turns\n**File:** <code>src/components/TransactionDetails.tsx</code>\n\nIf <code>suggested_contacts</code> JSON exists and contacts not yet assigned:\n\u2022 Show \"AI Suggested Contacts\" section\n\u2022 Display each suggested contact with their suggested role\n\u2022 \"Accept All\" button to apply all suggestions\n\u2022 Individual accept/modify/reject per contact\n\u2022 Record feedback on accept/reject\n\n**Acceptance Criteria:**\n\u2610 Suggestions displayed clearly\n\u2610 Accept all applies suggestions\n\u2610 Individual actions work\n\u2610 Feedback recorded\n\n<strong>U06: Loading States for LLM Processing</strong>\n**Estimated:** 2 turns\n**File:** <code>src/components/LLMLoadingStates.tsx</code>\n\nSkeleton and loading UI for LLM operations:\n\u2022 Skeleton cards during transaction analysis\n\u2022 Progress indicator for batch processing\n\u2022 \"Analyzing with AI...\" messaging\n\u2022 Estimated time remaining display\n\n**Acceptance Criteria:**\n\u2610 Skeleton renders during analysis\n\u2610 Progress shown for batch operations\n\u2610 User knows LLM is working\n\n---\n\n<strong>Files to Create</strong>\n\n| File | Purpose |\n|------|---------|\n| <code>src/components/settings/LLMSettings.tsx</code> | LLM configuration UI |\n| <code>src/components/LLMLoadingStates.tsx</code> | Loading/skeleton components |\n\n<strong>Files to Modify</strong>\n\n| File | Changes |\n|------|---------|\n| <code>src/components/Settings.tsx</code> | Add LLM settings section |\n| <code>src/components/TransactionList.tsx</code> | Add filters, badges, actions |\n| <code>src/components/AuditTransactionModal.tsx</code> | Add edit mode |\n| <code>src/components/TransactionDetails.tsx</code> | Add suggested contacts |\n\n---\n\n<strong>Design Notes</strong>\n\n<strong>Badge Colors</strong>\n<code>/* AI Detected badge */\nbackground: linear-gradient(135deg, #3B82F6, #8B5CF6);\n\n/* Manual badge */\nbackground: #6B7280;\n\n/* Confidence pills */\n.confidence-low { background: #EF4444; }    /* < 60% */\n.confidence-medium { background: #F59E0B; } /* 60-80% */\n.confidence-high { background: #10B981; }   /* > 80% */\n\n/* Pending Review badge */\nbackground: #F59E0B;\n</code>\n\n<strong>Consent Modal Text (Option C)</strong>\n<code>Before using AI features, please acknowledge:\n\nYour email content will be sent to [OpenAI/Anthropic] for analysis.\nThis includes email subjects, bodies, and sender/recipient information.\n\nPersonal information is sanitized before sending, but some content\nmay still be transmitted to the AI provider.\n\n[ ] I understand and consent to this data processing\n\n[Cancel] [Accept & Continue]\n</code>\n\n---\n\n<strong>Quality Gate: UI Complete</strong>\n\nBefore marking complete, verify:\n\u2610 All UI components functional\n\u2610 Settings save and load correctly\n\u2610 Filters work as expected\n\u2610 Badges display correctly\n\u2610 Approve/reject workflow complete\n\u2610 Consent required before LLM use\n\n---\n\n<strong>Metrics Tracking</strong>\n\n| Phase | Turns | Tokens | Time |\n|-------|-------|--------|------|\n| Implementation | - | - | - |\n| PR Review | - | - | - |\n| Debugging/Fixes | - | - | - |\n| **Total** | - | - | - |\n\n*Fill in after completion*"
  },
  {
    "id": "BACKLOG-079",
    "title": "AI MVP Phase 6 - Integration Testing",
    "category": "test",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-006",
    "est_tokens": "~40K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-079.md](BACKLOG-079.md)",
    "created_at": "2025-12-16",
    "completed_at": "",
    "file": "",
    "description": "<strong>Description</strong>\n\nComprehensive integration and E2E testing for the AI Transaction Auto-Detection MVP. This phase ensures all components work together and handles failure scenarios gracefully.\n\n---\n\n<strong>Tasks</strong>\n\n<strong>I01: Integration Tests for LLM Pipeline</strong>\n**Estimated:** 5 turns\n**File:** <code>electron/services/__tests__/hybridExtractor.test.ts</code>\n\nTest the full hybrid extraction pipeline:\n\u2022 Pattern \u2192 LLM fallback behavior\n\u2022 Confidence aggregation with real scenarios\n\u2022 Budget enforcement blocking requests\n\u2022 Strategy selection logic\n\n**Test Scenarios:**\n<code>describe('HybridExtractor Integration', () => {\n  it('falls back to pattern when LLM unavailable');\n  it('uses LLM when budget available');\n  it('blocks LLM when budget exceeded');\n  it('merges pattern + LLM results correctly');\n  it('handles LLM timeout gracefully');\n  it('tracks usage after successful call');\n});\n</code>\n\n**Acceptance Criteria:**\n\u2610 All fallback scenarios tested\n\u2610 Budget enforcement verified\n\u2610 Usage tracking confirmed\n\u2610 Error handling covered\n\n<strong>I02: Integration Tests for Feedback Loop</strong>\n**Estimated:** 3 turns\n**File:** <code>electron/services/__tests__/feedbackService.test.ts</code>\n\nTest feedback recording and learning:\n\u2022 Feedback saves correctly with all fields\n\u2022 Stats calculation returns accurate values\n\u2022 Learning service identifies patterns\n\u2022 Feedback types properly categorized\n\n**Test Scenarios:**\n<code>describe('Feedback Integration', () => {\n  it('records transaction approval with corrections');\n  it('records transaction rejection with reason');\n  it('records role correction with evidence');\n  it('calculates accuracy by provider');\n  it('identifies systematic errors');\n});\n</code>\n\n**Acceptance Criteria:**\n\u2610 All feedback types tested\n\u2610 Stats calculation verified\n\u2610 Pattern detection works\n\n<strong>I03: E2E Test for Auto-Detection Flow</strong>\n**Estimated:** 3 turns\n**File:** <code>tests/e2e/autoDetection.test.ts</code>\n\nFull flow test from import to confirmation:\n\n1. Import emails (mock or test data)\n2. Run detection (hybrid extraction)\n3. Review detected transaction in UI\n4. Confirm with edits\n5. Verify feedback recorded\n6. Verify transaction status updated\n\n**Test Scenarios:**\n<code>describe('Auto-Detection E2E', () => {\n  it('detects transaction from email batch');\n  it('shows detected transaction in pending review');\n  it('allows user to confirm transaction');\n  it('allows user to edit before confirming');\n  it('allows user to reject with reason');\n  it('records feedback for all actions');\n});\n</code>\n\n**Acceptance Criteria:**\n\u2610 Full flow works end-to-end\n\u2610 UI reflects detection status\n\u2610 Feedback recorded correctly\n\u2610 Transaction status updates\n\n<strong>T04: E2E Failure Scenario Tests</strong>\n**Estimated:** 2 turns\n**File:** <code>tests/e2e/llmFailures.test.ts</code>\n\nTest error handling paths:\n\n**Scenarios:**\n<code>describe('LLM Failure Handling', () => {\n  it('handles API timeout gracefully');\n  it('shows error when API key invalid');\n  it('shows rate limit exceeded message');\n  it('falls back to pattern on malformed response');\n  it('retries on transient failure');\n  it('displays fallback notification to user');\n});\n</code>\n\n**Acceptance Criteria:**\n\u2610 Timeout shows user-friendly error\n\u2610 Invalid key links to settings\n\u2610 Rate limit shows remaining time\n\u2610 Malformed response triggers fallback\n\u2610 Retry logic works for transient errors\n\n---\n\n<strong>Test Data</strong>\n\n<strong>Mock Emails for Testing</strong>\nCreate test fixtures with real estate scenarios:\n\n<code>// tests/fixtures/realEstateEmails.ts\nexport const mockEmails = {\n  purchaseOffer: {\n    subject: 'RE: Offer on 123 Main St',\n    body: 'Please find attached the offer for $450,000...',\n    sender: 'buyer.agent@realty.com',\n    // ...\n  },\n  closingNotice: {\n    subject: 'Closing Scheduled - 456 Oak Ave',\n    body: 'Closing is scheduled for December 20th...',\n    sender: 'escrow@titleco.com',\n    // ...\n  },\n  // ... more scenarios\n};\n</code>\n\n<strong>Mock LLM Responses</strong>\n<code>// tests/mocks/llmResponses.ts\nexport const mockAnalysisResponse = {\n  isRealEstateRelated: true,\n  confidence: 0.92,\n  transactionIndicators: {\n    type: 'purchase',\n    stage: 'pending',\n  },\n  extractedEntities: {\n    addresses: [{ value: '123 Main St', confidence: 0.95 }],\n    // ...\n  },\n};\n</code>\n\n---\n\n<strong>Files to Create</strong>\n\n| File | Purpose |\n|------|---------|\n| <code>electron/services/__tests__/hybridExtractor.test.ts</code> | Pipeline integration tests |\n| <code>electron/services/__tests__/feedbackService.test.ts</code> | Feedback integration tests |\n| <code>tests/e2e/autoDetection.test.ts</code> | Full E2E flow test |\n| <code>tests/e2e/llmFailures.test.ts</code> | Failure scenario tests |\n| <code>tests/fixtures/realEstateEmails.ts</code> | Test email data |\n| <code>tests/mocks/llmResponses.ts</code> | Mock LLM responses |\n\n---\n\n<strong>Quality Gate: Feature Complete</strong>\n\nBefore marking AI MVP complete, verify:\n\n<strong>Functional Requirements</strong>\n\u2610 Detection works on real email data\n\u2610 Confirmation flow is intuitive\n\u2610 Feedback is recorded accurately\n\u2610 Fallback to pattern matching works\n\n<strong>Performance Requirements</strong>\n\u2610 < 5 seconds for 100 emails\n\u2610 UI remains responsive during analysis\n\u2610 No memory leaks in long sessions\n\n<strong>Security Requirements</strong>\n\u2610 API keys never logged or exposed\n\u2610 Content sanitization working\n\u2610 Consent required before first LLM call\n\n<strong>Reliability Requirements</strong>\n\u2610 Graceful degradation on LLM failure\n\u2610 No data loss on errors\n\u2610 Clear error messages for users\n\n---\n\n<strong>Success Metrics Verification</strong>\n\n| Metric | Target | Test Method |\n|--------|--------|-------------|\n| Detection Accuracy | >80% | Sample 50 emails, measure confirmed/(confirmed+rejected) |\n| User Confirmation Rate | >70% | Track via feedback stats |\n| Avg Corrections/Transaction | <3 | Calculate from feedback data |\n| Fallback Rate | <10% | Monitor pattern_only / total_detections |\n| Cost per Transaction | <$0.05 | Calculate tokens * rate / transactions |\n\n---\n\n<strong>Launch Checklist</strong>\n\nBefore declaring AI MVP ready for beta:\n\n<strong>Technical</strong>\n\u2610 All integration tests pass\n\u2610 All E2E tests pass\n\u2610 Performance benchmarks met\n\u2610 Security review completed\n\n<strong>Documentation</strong>\n\u2610 User guide for AI features\n\u2610 API key setup instructions\n\u2610 Troubleshooting guide\n\n<strong>Monitoring</strong>\n\u2610 Usage tracking dashboard\n\u2610 Error rate monitoring\n\u2610 Accuracy metrics visible\n\n---\n\n<strong>Metrics Tracking</strong>\n\n| Phase | Turns | Tokens | Time |\n|-------|-------|--------|------|\n| Implementation | - | - | - |\n| PR Review | - | - | - |\n| Debugging/Fixes | - | - | - |\n| **Total** | - | - | - |\n\n*Fill in after completion*"
  },
  {
    "id": "BACKLOG-081",
    "title": "Consolidate AI Consent into T&C",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "[BACKLOG-081.md](BACKLOG-081.md)",
    "created_at": "2025-12-20",
    "completed_at": "",
    "file": "",
    "description": "<strong>Status</strong>\n\u2022 **Priority:** Medium\n\u2022 **Status:** Pending\n\u2022 **Sprint:** Unassigned\n\u2022 **Created:** 2025-12-18\n\u2022 **Type:** Enhancement\n\n<strong>Summary</strong>\n\nMove the AI data processing consent from a separate modal into the main Terms and Conditions document. Users should agree to AI data processing as part of the standard T&C acceptance flow rather than seeing a separate consent popup.\n\n<strong>Current Behavior</strong>\n\nWhen users access LLM Settings for the first time, they see a separate \"AI Features - Data Processing Consent\" modal with:\n\u2022 Acknowledgment that email content will be sent to OpenAI/Anthropic\n\u2022 Details about email subjects, bodies, sender/recipient info being transmitted\n\u2022 Note about personal information sanitization\n\u2022 Ability to revoke consent in settings\n\n<strong>Desired Behavior</strong>\n\n1. **Update Terms and Conditions** to include an AI/LLM data processing section covering:\n   - What data is sent to AI providers (email content, subjects, bodies, contacts)\n   - Which providers may receive data (OpenAI, Anthropic)\n   - Data sanitization practices\n   - User's right to opt-out/revoke consent\n   - Data retention policies of AI providers\n\n2. **Remove separate consent modal** from LLMSettings.tsx (or make it supplementary)\n\n3. **Track consent via T&C version** - If user accepted T&C v2.0 which includes AI consent, they don't need separate AI consent\n\n4. **Settings should still show consent status** and allow users to view/revoke\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Terms and Conditions document updated with AI data processing section\n\u2610 T&C version bumped to reflect new content\n\u2610 Onboarding T&C acceptance covers AI consent\n\u2610 LLM Settings shows consent status based on T&C acceptance\n\u2610 Users can still revoke AI consent specifically in settings\n\u2610 Existing users who haven't accepted new T&C see updated version\n\n<strong>Technical Notes</strong>\n\n\u2022 Current consent logic: <code>src/components/settings/LLMSettings.tsx</code> (ConsentModal component)\n\u2022 T&C acceptance tracked in user settings/database\n\u2022 May need T&C versioning to track which version user accepted\n\u2022 Consider: Should AI consent be revocable separately from T&C?\n\n<strong>Dependencies</strong>\n\n\u2022 None blocking\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-078: AI MVP UI Enhancements (SPRINT-006)"
  },
  {
    "id": "BACKLOG-082",
    "title": "Consolidate Database Connection Systems",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-082.md](items/BACKLOG-082.md)",
    "description": "<strong>Status</strong>\n\u2022 **Priority:** Medium\n\u2022 **Status:** Pending\n\u2022 **Sprint:** Unassigned\n\u2022 **Created:** 2025-12-18\n\u2022 **Type:** Tech Debt / Refactor\n\n<strong>Summary</strong>\n\nConsolidate the two database connection systems into a single, unified approach. Currently there are:\n\n1. **<code>DatabaseService</code> class** (<code>electron/services/databaseService.ts</code>) - Legacy singleton class with 3600+ lines\n2. **<code>dbConnection.ts</code> module** (<code>electron/services/db/core/dbConnection.ts</code>) - Newer modular approach\n\nThese were temporarily bridged via <code>setSharedDb()</code> call, but this is a band-aid fix.\n\n<strong>Current State</strong>\n\n\u2022 <code>DatabaseService</code> is the main database manager (initialization, migrations, encryption)\n\u2022 <code>dbConnection.ts</code> provides helper functions (<code>dbGet</code>, <code>dbAll</code>, <code>dbRun</code>) used by newer services\n\u2022 The bridge happens in <code>databaseService.ts:173</code>: <code>setSharedDb(this.db)</code>\n\u2022 New LLM services use <code>dbConnection.ts</code> pattern\n\u2022 Legacy handlers use <code>databaseService</code> directly\n\n<strong>Desired State</strong>\n\nSingle database system with:\n\u2022 One source of truth for the database connection\n\u2022 Consistent API for all database operations\n\u2022 Clear separation between connection management and query execution\n\u2022 Smaller, focused modules instead of 3600+ line monolith\n\n<strong>Options</strong>\n\n<strong>Option A: Migrate to Module Pattern</strong>\n\u2022 Keep <code>dbConnection.ts</code> as the connection manager\n\u2022 Refactor <code>DatabaseService</code> to use it internally\n\u2022 Gradually migrate handlers to use modular db services\n\u2022 Split <code>databaseService.ts</code> into focused service modules\n\n<strong>Option B: Enhance DatabaseService</strong>\n\u2022 Remove <code>dbConnection.ts</code> module\n\u2022 Add helper methods to <code>DatabaseService</code>\n\u2022 Keep singleton pattern but refactor for better organization\n\n<strong>Option C: New Unified System</strong>\n\u2022 Design new database layer from scratch\n\u2022 Migrate both systems to new approach\n\u2022 Higher effort but cleanest result\n\n<strong>Recommendation</strong>\n\n**Option A** - Migrate to module pattern over time. This:\n\u2022 Aligns with modern patterns used in LLM services\n\u2022 Allows incremental migration\n\u2022 Reduces the 3600+ line monolith\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Single database connection source\n\u2610 Remove <code>setSharedDb()</code> bridge hack\n\u2610 All services use consistent database access pattern\n\u2610 <code>databaseService.ts</code> split into focused modules (<300 lines each)\n\u2610 No regression in functionality\n\u2610 All tests passing\n\n<strong>Technical Notes</strong>\n\n\u2022 Current bridge: <code>electron/services/databaseService.ts:173</code>\n\u2022 New pattern example: <code>electron/services/db/llmSettingsDbService.ts</code>\n\u2022 Legacy pattern: Direct <code>databaseService.methodName()</code> calls\n\n<strong>Dependencies</strong>\n\n\u2022 Should be done during a low-risk period\n\u2022 Requires comprehensive testing\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-058: Database architecture improvements (completed)\n\u2022 LLM services use the new modular pattern"
  },
  {
    "id": "BACKLOG-083",
    "title": "Fix schema_version Migration Warning",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-083.md](items/BACKLOG-083.md)",
    "description": "<strong>Status</strong>\n\u2022 **Priority:** Low\n\u2022 **Status:** Pending\n\u2022 **Sprint:** Unassigned\n\u2022 **Created:** 2025-12-18\n\u2022 **Type:** Bug / Tech Debt\n\n<strong>Summary</strong>\n\nDatabase initialization logs a migration error for missing <code>schema_version</code> table, but then reports success. This is confusing and should be cleaned up.\n\n<strong>Current Behavior</strong>\n\n<code>ERROR [DatabaseService] Migration failed\n{\n  \"error\": \"no such table: schema_version\",\n  ...\n}\nINFO  [DatabaseService] Database initialized successfully with encryption\n</code>\n\nThe error is logged but doesn't prevent initialization, suggesting it's a non-fatal check that should be handled gracefully.\n\n<strong>Expected Behavior</strong>\n\n\u2022 No error logged if <code>schema_version</code> table doesn't exist (expected for fresh databases)\n\u2022 Create <code>schema_version</code> table if it doesn't exist\n\u2022 Or remove the check if it's no longer needed\n\n<strong>Root Cause</strong>\n\nThe <code>_runAdditionalMigrations</code> method in <code>databaseService.ts</code> tries to query <code>schema_version</code> table without first checking if it exists.\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 No false-positive migration errors in logs\n\u2610 <code>schema_version</code> table created if missing\n\u2610 Existing databases with <code>schema_version</code> continue to work\n\u2610 Clean log output during initialization\n\n<strong>Technical Notes</strong>\n\n\u2022 Error occurs in: <code>DatabaseService._runAdditionalMigrations</code> (databaseService.ts:895)\n\u2022 Called from: <code>DatabaseService.runMigrations</code> (databaseService.ts:297)\n\u2022 Should check table existence before querying\n\n<strong>Dependencies</strong>\n\n\u2022 None\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-082: Consolidate Database Connection Systems"
  },
  {
    "id": "BACKLOG-084",
    "title": "Thread-Based Transaction Detection",
    "category": "service",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-007",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "[BACKLOG-084.md](BACKLOG-084.md)",
    "created_at": "2025-12-20",
    "completed_at": "",
    "file": "",
    "description": "<strong>Status</strong>\n\u2022 **Priority:** High\n\u2022 **Status:** Pending\n\u2022 **Sprint:** Unassigned\n\u2022 **Created:** 2025-12-19\n\u2022 **Type:** Enhancement / Cost Optimization\n\n<strong>Summary</strong>\n\nImplement thread-aware transaction detection to dramatically reduce LLM API costs. If the first email in a thread is a transaction, all subsequent emails in that thread are automatically linked to that transaction without LLM analysis. Combined with batching, this achieves 90%+ cost reduction.\n\n<strong>Current Behavior</strong>\n\n\u2022 Each email analyzed independently by LLM\n\u2022 No awareness of email threads/conversations\n\u2022 Thread relationships ignored during analysis\n\u2022 Spam/junk emails sent to LLM (wasted cost)\n\u2022 600 emails = 600 LLM calls = ~$6.00 (Haiku)\n\n<strong>Proposed Behavior</strong>\n\n1. **Skip spam/junk emails** - never send to LLM\n2. Group emails by <code>thread_id</code> (already stored in database)\n3. Analyze only the **first email** per thread\n4. Propagate transaction detection to all emails in that thread\n5. Batch the first-emails for additional savings\n\n<strong>Cost Analysis</strong>\n\n| Optimization Stage | Emails | LLM Calls | Cost (Haiku) |\n|-------------------|--------|-----------|--------------|\n| Current (per-email) | 600 | 600 | ~$6.00 |\n| After spam filter (~15%) | 510 | 510 | ~$5.10 |\n| Thread propagation | 127 threads | 127 | ~$1.27 |\n| Batching (30/batch) | 127 | 5 | ~$0.15 |\n| **Total savings** | | | **97.5%** |\n\n<strong>Technical Design</strong>\n\n<strong>Data Already Available</strong>\n\n**Thread IDs** (already captured):\n\u2022 **Gmail**: <code>threadId</code> field \u2192 stored as <code>thread_id</code>\n\u2022 **Outlook**: <code>conversationId</code> \u2192 mapped to <code>threadId</code> \u2192 stored as <code>thread_id</code>\n\u2022 **Database**: <code>messages.thread_id</code> column exists\n\n**Spam/Junk Detection:**\n\u2022 **Gmail**: <code>labels</code> array already captured (check for <code>SPAM</code> label)\n\u2022 **Outlook**: Need to add <code>inferenceClassification</code> or check <code>parentFolderId</code> for Junk folder\n\n<strong>Spam Detection Implementation</strong>\n\n**Gmail** (already available):\n<code>// Labels already captured in gmailFetchService.ts:368\nlabels: message.labelIds || []  // [\"INBOX\", \"SPAM\", \"TRASH\", etc.]\n\n// Check for spam:\nconst isSpam = labels.includes('SPAM') || labels.includes('TRASH');\n</code>\n\n**Outlook** (needs enhancement):\n<code>// Add to $select in outlookFetchService.ts:269\n\"$select=id,subject,...,inferenceClassification,parentFolderId\"\n\n// Check for junk:\nconst isJunk = inferenceClassification === 'other' || parentFolderName === 'Junk Email';\n</code>\n\n<strong>Algorithm</strong>\n\n<code>1. Query all unprocessed emails\n2. FILTER: Remove spam/junk emails (mark as non-transaction, skip LLM)\n   - Gmail: labels.includes('SPAM') || labels.includes('TRASH')\n   - Outlook: parentFolderId === junkFolderId\n3. Group remaining emails by thread_id\n4. Sort each thread by sent_at ASC (oldest first)\n5. For each thread:\n   a. Take first (oldest) email\n   b. Run LLM analysis on first email only\n   c. If transaction detected:\n      - Create transaction record\n      - Link ALL emails in thread to transaction\n      - Mark all as processed\n   d. If no transaction:\n      - Mark all emails in thread as non-transaction\n      - Skip remaining emails\n6. Batch step 5b across multiple threads for efficiency\n</code>\n\n<strong>Processing Flow</strong>\n\n<code>Thread A: \"123 Main St Closing\" (5 emails)\n\u251c\u2500\u2500 Email 1 (oldest) \u2192 LLM \u2192 TRANSACTION \u2713\n\u251c\u2500\u2500 Email 2 \u2192 Skip LLM, inherit transaction\n\u251c\u2500\u2500 Email 3 \u2192 Skip LLM, inherit transaction\n\u251c\u2500\u2500 Email 4 \u2192 Skip LLM, inherit transaction\n\u2514\u2500\u2500 Email 5 \u2192 Skip LLM, inherit transaction\n\nThread B: \"Newsletter\" (3 emails)\n\u251c\u2500\u2500 Email 1 (oldest) \u2192 LLM \u2192 NOT TRANSACTION\n\u251c\u2500\u2500 Email 2 \u2192 Skip LLM, marked non-transaction\n\u2514\u2500\u2500 Email 3 \u2192 Skip LLM, marked non-transaction\n</code>\n\n<strong>Batching Layer</strong>\n\nAfter thread grouping, batch the first-emails:\n<code>Batch 1: [Thread A email 1, Thread B email 1, Thread C email 1, ...]\n         \u2192 Single LLM call analyzing 30-40 emails\n         \u2192 Parse results, propagate to all thread members\n</code>\n\n<strong>Files to Modify</strong>\n\n\u2022 <code>electron/services/llm/hybridExtractionService.ts</code> - Add thread grouping logic\n\u2022 <code>electron/services/llm/tools/AnalyzeMessageTool.ts</code> - Add batch mode\n\u2022 New: <code>electron/services/llm/threadAnalysisService.ts</code> - Thread grouping utilities\n\n<strong>Database Queries</strong>\n\n<code>-- Get threads with their emails\nSELECT thread_id,\n       MIN(sent_at) as first_email_date,\n       COUNT(*) as email_count,\n       GROUP_CONCAT(id) as email_ids\nFROM messages\nWHERE processed = 0 AND thread_id IS NOT NULL\nGROUP BY thread_id\nORDER BY first_email_date;\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Spam/junk emails filtered before LLM analysis\n  - [ ] Gmail: Check for SPAM/TRASH labels\n  - [ ] Outlook: Add inferenceClassification to fetch, check parentFolderId\n\u2610 Emails grouped by <code>thread_id</code> before LLM analysis\n\u2610 Only first email per thread sent to LLM\n\u2610 Transaction detection propagated to all thread emails\n\u2610 Batching applied to first-emails (configurable batch size)\n\u2610 90%+ reduction in LLM calls demonstrated\n\u2610 No regression in transaction detection accuracy\n\u2610 Handles edge cases:\n  - [ ] Single-email threads (no grouping benefit, still works)\n  - [ ] Null/missing thread_id (fall back to individual analysis)\n  - [ ] Very large threads (100+ emails)\n  - [ ] Spam threads (entire thread skipped)\n\u2610 Progress reporting accurate for batched processing\n\n<strong>Edge Cases</strong>\n\n1. **Null thread_id**: Some emails may not have thread info. Fall back to individual analysis.\n2. **Large threads**: Thread with 100+ emails still only needs 1 LLM call.\n3. **Mid-thread transactions**: If transaction discussed mid-thread, first email detection may miss it. Consider analyzing first AND any email with transaction keywords as fallback.\n\n<strong>Dependencies</strong>\n\n\u2022 None (uses existing thread_id data)\n\n<strong>Related Items</strong>\n\n\u2022 Thread ID storage: <code>electron/services/gmailFetchService.ts:355</code>\n\u2022 Thread ID storage: <code>electron/services/outlookFetchService.ts:421</code>\n\u2022 Database column: <code>messages.thread_id</code>\n\u2022 LLM tools: <code>electron/services/llm/tools/</code>\n\n<strong>Notes</strong>\n\n\u2022 Primary savings come from thread propagation (75% reduction)\n\u2022 Secondary savings from batching (additional 67% of remaining)\n\u2022 Combined: 92%+ total cost reduction\n\u2022 Consider A/B testing accuracy before full rollout"
  },
  {
    "id": "BACKLOG-085",
    "title": "Test Thread-Based Detection Accuracy",
    "category": "test",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-007",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "[BACKLOG-085.md](BACKLOG-085.md)",
    "created_at": "2025-12-20",
    "completed_at": "",
    "file": "",
    "description": "<strong>Status</strong>\n\u2022 **Priority:** High\n\u2022 **Status:** Pending\n\u2022 **Sprint:** Unassigned\n\u2022 **Created:** 2025-12-19\n\u2022 **Type:** Testing / Validation\n\u2022 **Depends On:** BACKLOG-084\n\n<strong>Summary</strong>\n\nBefore rolling out thread-based transaction detection (BACKLOG-084), validate that the optimization doesn't reduce transaction detection accuracy. Test with real email data to confirm:\n1. Spam filtering correctly identifies non-transaction emails\n2. Thread propagation doesn't miss mid-thread transactions\n3. First-email-only analysis catches the same transactions as full analysis\n\n<strong>Test Strategy</strong>\n\n<strong>Phase 1: Baseline Measurement</strong>\n\nRun current per-email analysis on test dataset:\n1. Collect 100-200 real emails (with user consent)\n2. Run full LLM analysis on every email\n3. Record:\n   - Transactions detected\n   - Confidence scores\n   - LLM calls made\n   - Total cost\n\n<strong>Phase 2: Spam Filter Validation</strong>\n\n1. Identify spam/junk emails in test set\n2. Manual review: confirm none contain real estate transactions\n3. Calculate false positive rate (real transactions incorrectly marked as spam)\n4. **Target:** 0% false positives (never skip a real transaction)\n\n<strong>Phase 3: Thread Propagation Validation</strong>\n\n1. Group test emails by thread_id\n2. For each thread with detected transaction:\n   - Analyze first email only\n   - Compare result to full-thread analysis\n3. Calculate:\n   - Match rate (first-email catches transaction)\n   - Miss rate (transaction only in later emails)\n4. **Target:** 95%+ match rate\n\n<strong>Phase 4: Edge Case Testing</strong>\n\nTest specific scenarios:\n\u2610 Thread where transaction discussed mid-thread (not first email)\n\u2610 Thread where first email is newsletter, later email is transaction\n\u2610 Single-email threads\n\u2610 Threads with 50+ emails\n\u2610 Emails with null thread_id\n\n<strong>Phase 5: A/B Comparison</strong>\n\nRun both approaches in parallel:\n1. **Control:** Per-email analysis (current)\n2. **Test:** Thread-based + spam filter + batching\n\nCompare:\n\u2022 Transactions detected (should be equal or within 5%)\n\u2022 LLM calls made (should be 90%+ reduction)\n\u2022 Cost (should be 90%+ reduction)\n\u2022 Processing time (should be faster)\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Baseline metrics collected from current approach\n\u2610 Spam filter has 0% false positive rate\n\u2610 Thread propagation has 95%+ match rate\n\u2610 Edge cases documented with results\n\u2610 A/B comparison shows no significant accuracy loss\n\u2610 Cost reduction of 90%+ confirmed\n\u2610 Rollback plan documented if issues found\n\n<strong>Test Data Requirements</strong>\n\n**Minimum dataset:**\n\u2022 100+ emails\n\u2022 20+ threads with multiple emails\n\u2022 10+ confirmed transaction threads\n\u2022 5+ spam/newsletter emails\n\u2022 Mix of Gmail and Outlook sources\n\n**Ideal dataset:**\n\u2022 500+ emails\n\u2022 100+ threads\n\u2022 50+ transaction threads\n\u2022 50+ spam/junk emails\n\u2022 Real user data (with consent)\n\n<strong>Risk Mitigation</strong>\n\nIf thread-first approach misses transactions:\n\n1. **Fallback option:** Analyze first email + any email with transaction keywords\n2. **Hybrid approach:** Thread propagation for confirmed transactions, keyword scan for uncertain threads\n3. **Confidence threshold:** Only propagate if first-email confidence > 80%\n\n<strong>Metrics to Track</strong>\n\n| Metric | Baseline | Thread-Based | Target |\n|--------|----------|--------------|--------|\n| Transactions found | X | Y | Y >= X * 0.95 |\n| False negatives | X | Y | Y <= X + 2% |\n| LLM calls | 600 | ~30 | 95% reduction |\n| Cost | $6.00 | $0.15 | 97% reduction |\n| Processing time | X min | Y min | Y < X |\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-084 must be implemented first\n\u2022 Access to real email test data\n\u2022 User consent for testing with real emails\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-084: Thread-Based Transaction Detection with Batching\n\u2022 LLM tools: <code>electron/services/llm/tools/</code>\n\u2022 Hybrid extraction: <code>electron/services/llm/hybridExtractionService.ts</code>\n\n<strong>Notes</strong>\n\n\u2022 Testing should happen in staging/dev environment\n\u2022 Consider creating synthetic test dataset if real data not available\n\u2022 Document any edge cases discovered during testing for future reference"
  },
  {
    "id": "BACKLOG-086",
    "title": "Local ML Model with Hybrid Training",
    "category": "service",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "[BACKLOG-086.md](BACKLOG-086.md)",
    "created_at": "2025-12-20",
    "completed_at": "",
    "file": "",
    "description": "<strong>Status</strong>\n\u2022 **Priority:** Medium\n\u2022 **Status:** Pending\n\u2022 **Sprint:** Unassigned\n\u2022 **Created:** 2025-12-19\n\u2022 **Type:** Enhancement / AI / Cost Optimization\n\u2022 **Depends On:** BACKLOG-084, BACKLOG-085\n\n<strong>Summary</strong>\n\nImplement a hybrid ML system that combines a centralized base model (shipped with app updates) with local fine-tuning on user's emails. This progressively reduces LLM dependency from 100% to <5% over time while maintaining high accuracy.\n\n<strong>Architecture</strong>\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                  Software Update                        \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502  Base Model v1.0 (generic RE patterns)           \u2502  \u2502\n\u2502  \u2502  - Common keywords, email structures             \u2502  \u2502\n\u2502  \u2502  - Standard sender patterns                      \u2502  \u2502\n\u2502  \u2502  - 60-70% accuracy out of box                    \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                          \u2502\n                          \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    User's Device                        \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502  Base Model + Local Fine-tuning Layer            \u2502  \u2502\n\u2502  \u2502  - Learns user's contacts, brokerages            \u2502  \u2502\n\u2502  \u2502  - Adapts to regional patterns                   \u2502  \u2502\n\u2502  \u2502  - 90%+ accuracy after training                  \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n<strong>Feature Signals for Local Model</strong>\n\n<strong>High-Weight Signals</strong>\n\n| Signal | Logic | Example |\n|--------|-------|---------|\n| **Thread length** | 5+ emails = likely transaction | Long negotiation threads |\n| **Reply presence** | No replies = likely newsletter | One-way marketing emails |\n| **Signature keywords** | Role detection | \"Realtor\", \"Title Officer\", \"Escrow Agent\" |\n| **Attachment types** | Contract indicators | PDF, DOCX (purchase agreements) |\n\n<strong>Medium-Weight Signals</strong>\n\n| Signal | Logic | Example |\n|--------|-------|---------|\n| **Sender domain** | Known RE domains | @titleco.com, @remax.com |\n| **Reply velocity** | Quick back-and-forth | Active deal negotiation |\n| **CC recipients** | Multiple parties | Buyers, sellers, agents |\n| **Subject patterns** | Address mentions | \"RE: 123 Main St\" |\n\n<strong>Low-Weight Signals</strong>\n\n| Signal | Logic | Example |\n|--------|-------|---------|\n| **Email length** | Very short = less likely | One-line confirmations |\n| **Time of day** | Business hours | 9am-5pm more likely business |\n| **Day of week** | Weekdays | Business activity |\n\n<strong>Transaction Discovery Flow (Invisible Training)</strong>\n\n<strong>Philosophy</strong>\nMagic Audit finds transactions automatically - but the user decides what gets added. Every accept/dismiss action trains the model invisibly.\n\n<strong>Discovery Celebration Screen</strong>\n\nWhen new transactions are found, celebrate the magic:\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                                                     \u2502\n\u2502                      \u2728                             \u2502\n\u2502                                                     \u2502\n\u2502         We found 3 new transactions!                \u2502\n\u2502                                                     \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502  \ud83c\udfe0 123 Main Street, Austin TX                \u2502 \u2502\n\u2502  \u2502     Purchase \u00b7 $425,000 \u00b7 Closing Jan 15      \u2502 \u2502\n\u2502  \u2502     12 related emails                         \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502                                                     \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502  \ud83c\udfe0 456 Oak Avenue, Austin TX                 \u2502 \u2502\n\u2502  \u2502     Listing \u00b7 $550,000 \u00b7 Active               \u2502 \u2502\n\u2502  \u2502     8 related emails                          \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502                                                     \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502  \ud83c\udfe0 789 Pine Road, Austin TX                  \u2502 \u2502\n\u2502  \u2502     Purchase \u00b7 $380,000 \u00b7 Under Contract      \u2502 \u2502\n\u2502  \u2502     5 related emails                          \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502                                                     \u2502\n\u2502           [Review & Accept Transactions]            \u2502\n\u2502                                                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n<strong>Accept/Dismiss Flow (Training Source)</strong>\n\nEach transaction requires explicit action:\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                                                     \u2502\n\u2502  \ud83c\udfe0 123 Main Street, Austin TX                      \u2502\n\u2502                                                     \u2502\n\u2502  Type: Purchase                                     \u2502\n\u2502  Price: $425,000                                    \u2502\n\u2502  Status: Under Contract                             \u2502\n\u2502  Closing: January 15, 2025                          \u2502\n\u2502                                                     \u2502\n\u2502  Related Emails (12)                                \u2502\n\u2502  \u251c\u2500 Contract signed - Dec 10                        \u2502\n\u2502  \u251c\u2500 Inspection scheduled - Dec 12                   \u2502\n\u2502  \u251c\u2500 Title search complete - Dec 14                  \u2502\n\u2502  \u2514\u2500 [View all emails...]                            \u2502\n\u2502                                                     \u2502\n\u2502  Parties Detected:                                  \u2502\n\u2502  \u2022 John Smith (Buyer's Agent)                       \u2502\n\u2502  \u2022 Jane Doe (Seller's Agent)                        \u2502\n\u2502  \u2022 First American Title                             \u2502\n\u2502                                                     \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502         [Review Details]  (optional)        \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                     \u2502\n\u2502      [Dismiss]                    [Accept] \u2713        \u2502\n\u2502                                                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n<strong>Training Signals</strong>\n\n| User Action | Training Signal | What We Learn |\n|-------------|-----------------|---------------|\n| **Accept** | Strong positive | These email patterns = transaction |\n| **Dismiss** | Strong negative | These email patterns = NOT transaction |\n| **Review + Accept** | Strong positive + validated details | High-quality training data |\n| **Review + Edit + Accept** | Positive + corrections | Learn from mistakes |\n\n<strong>Optional Review Window</strong>\n\nFor thorough users who click \"Review Details\":\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Review: 123 Main Street                            \u2502\n\u2502                                                     \u2502\n\u2502  \u250c\u2500 Transaction Details \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502 Address: [123 Main Street, Austin TX    ]     \u2502 \u2502\n\u2502  \u2502 Type:    [Purchase           \u25bc]              \u2502 \u2502\n\u2502  \u2502 Price:   [$425,000                     ]     \u2502 \u2502\n\u2502  \u2502 Status:  [Under Contract     \u25bc]              \u2502 \u2502\n\u2502  \u2502 Closing: [2025-01-15                   ]     \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502                                                     \u2502\n\u2502  \u250c\u2500 Parties \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502 \u2022 John Smith        [Buyer's Agent  \u25bc] [x]   \u2502 \u2502\n\u2502  \u2502 \u2022 Jane Doe          [Seller's Agent \u25bc] [x]   \u2502 \u2502\n\u2502  \u2502 \u2022 First American    [Title Company  \u25bc] [x]   \u2502 \u2502\n\u2502  \u2502 [+ Add party]                                 \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502                                                     \u2502\n\u2502            [Cancel]              [Save & Accept]    \u2502\n\u2502                                                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n<strong>Passive Training (Ongoing)</strong>\n\nAfter initial acceptance, continue learning from:\n\n| Action | Signal |\n|--------|--------|\n| User edits transaction later | Correction data |\n| User deletes transaction | Was wrong, strong negative |\n| User links more emails | Pattern expansion |\n| User adds transaction manually | We missed this (false negative) |\n\n<strong>Signature Parsing</strong>\n\n<strong>Extraction Targets</strong>\n\n<code>interface ParsedSignature {\n  name: string;\n  title: string;           // \"Realtor\", \"Broker\", \"Escrow Officer\"\n  company: string;         // \"ABC Realty\", \"First American Title\"\n  phone: string;\n  email: string;\n  license: string;         // \"DRE# 12345678\"\n  isRealEstateRelated: boolean;\n}\n</code>\n\n<strong>Role Keywords</strong>\n\n<code>const RE_ROLES = [\n  // Agents\n  'realtor', 'real estate agent', 'broker', 'associate broker',\n  'listing agent', 'buyer agent', 'selling agent',\n\n  // Title & Escrow\n  'escrow officer', 'title officer', 'closing coordinator',\n  'settlement agent', 'escrow assistant',\n\n  // Lenders\n  'loan officer', 'mortgage broker', 'lender', 'underwriter',\n\n  // Legal\n  'real estate attorney', 'closing attorney',\n\n  // Other\n  'transaction coordinator', 'tc', 'home inspector'\n];\n</code>\n\n<strong>No-Reply Detection</strong>\n\nEmails without replies are likely not transactions:\n\n<code>interface ThreadAnalysis {\n  thread_id: string;\n  email_count: number;\n  has_user_reply: boolean;      // Did user ever reply?\n  has_any_reply: boolean;       // Any replies in thread?\n  reply_velocity: number;       // Avg hours between replies\n  last_activity: Date;\n}\n\n// Scoring adjustment\nif (!thread.has_any_reply && thread.email_count === 1) {\n  confidence *= 0.3;  // Likely newsletter/promotion\n}\n</code>\n\n<strong>Model Training Pipeline</strong>\n\n<strong>Data Collection (Already Happening)</strong>\n\n<code>// From existing tables:\n\u2022 llm_analysis_results     // LLM predictions\n\u2022 llm_extraction_feedback  // User corrections\n\u2022 communications           // Email metadata\n\u2022 messages                 // Thread info\n</code>\n\n<strong>Training Data Schema</strong>\n\n<code>interface TrainingExample {\n  // Features\n  subject: string;\n  body_preview: string;\n  sender_domain: string;\n  signature_role: string | null;\n  thread_length: number;\n  has_reply: boolean;\n  has_attachments: boolean;\n  attachment_types: string[];\n\n  // Labels\n  is_transaction: boolean;\n  transaction_type?: string;\n  confidence_source: 'llm' | 'user' | 'rule';\n}\n</code>\n\n<strong>Local Training</strong>\n\n<code>// Periodic retraining (e.g., weekly or after 50 new examples)\nasync function retrainLocalModel() {\n  const examples = await getTrainingExamples();\n\n  if (examples.length < 100) {\n    // Not enough data, rely on base model\n    return;\n  }\n\n  // Fine-tune on local data\n  const updatedWeights = await fineTune(baseModel, examples);\n  await saveLocalWeights(updatedWeights);\n\n  // Update confidence thresholds\n  await recalibrateThresholds();\n}\n</code>\n\n<strong>Confidence Cascade</strong>\n\n<code>Prediction Flow:\n\nInput Email\n     \u2502\n     \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Rule-based  \u2502 \u2500\u2500\u2500 High confidence \u2500\u2500\u2192 Return (no LLM)\n\u2502 Classifier  \u2502     (>95%)\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n     \u2502 Medium\n     \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Base Model  \u2502 \u2500\u2500\u2500 High confidence \u2500\u2500\u2192 Return (no LLM)\n\u2502             \u2502     (>90%)\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n     \u2502 Medium\n     \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Local Model \u2502 \u2500\u2500\u2500 High confidence \u2500\u2500\u2192 Return (no LLM)\n\u2502             \u2502     (>85%)\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n     \u2502 Low\n     \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 LLM (Haiku) \u2502 \u2500\u2500\u2192 Return + Train local model\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n<strong>Implementation Phases</strong>\n\n<strong>Phase 1: Enhanced Data Collection (Low effort)</strong>\n\u2610 Store all LLM results with features\n\u2610 Parse and store signatures\n\u2610 Track thread reply status\n\u2610 Calculate thread-level features\n\n<strong>Phase 2: Rule-Based Classifier (Low effort)</strong>\n\u2610 Implement keyword matching\n\u2610 Signature role detection\n\u2610 Thread length scoring\n\u2610 No-reply penalty\n\u2610 **Impact: -50% LLM calls**\n\n<strong>Phase 3: Tinder Training Game (Medium effort)</strong>\n\u2610 Build swipe UI component\n\u2610 Integrate into onboarding flow\n\u2610 Add periodic training prompts\n\u2610 Store user feedback efficiently\n\n<strong>Phase 4: Base Model v1 (Medium effort)</strong>\n\u2610 Choose ML framework (TensorFlow.js / ONNX)\n\u2610 Train on synthetic + pattern data\n\u2610 Package with app\n\u2610 **Impact: -70% LLM calls for new users**\n\n<strong>Phase 5: Local Fine-tuning (Medium effort)</strong>\n\u2610 Implement local training pipeline\n\u2610 Periodic retraining trigger\n\u2610 Confidence calibration\n\u2610 **Impact: -90% LLM calls after training**\n\n<strong>Phase 6: Feedback Loop for v2 (Low effort)</strong>\n\u2610 Opt-in anonymized pattern sharing\n\u2610 Aggregate feedback for base model\n\u2610 Push improved base model in updates\n\n<strong>Cost Reduction Timeline</strong>\n\n| Phase | New User | Trained User | LLM Cost |\n|-------|----------|--------------|----------|\n| Current | 100% LLM | 100% LLM | $6/600 emails |\n| Phase 2 (rules) | 50% LLM | 50% LLM | $3/600 emails |\n| Phase 4 (base) | 30% LLM | 30% LLM | $1.80/600 emails |\n| Phase 5 (local) | 30% LLM | 10% LLM | $0.60/600 emails |\n| + Thread optimization | 5% LLM | 2% LLM | $0.12/600 emails |\n\n<strong>Privacy Model</strong>\n\n<code>Never leaves device:           Optional (opt-in):\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500           \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\u2022 User's emails                - Pattern frequency stats\n\u2022 User's feedback              - Anonymized role detection rates\n\u2022 Local model weights          - Confidence calibration data\n\u2022 Training examples\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n<strong>Data Collection</strong>\n\u2610 Signatures parsed and stored\n\u2610 Thread reply status tracked\n\u2610 Thread length calculated\n\u2610 Training examples schema implemented\n\n<strong>Rule-Based Classifier</strong>\n\u2610 Keyword matching functional\n\u2610 Signature role detection working\n\u2610 50% reduction in LLM calls demonstrated\n\n<strong>Tinder Game</strong>\n\u2610 Swipe UI implemented\n\u2610 Undo/rewind working\n\u2610 Progress tracking functional\n\u2610 Integrated into onboarding\n\u2610 Feedback stored for training\n\n<strong>Local Model</strong>\n\u2610 Base model loads in Electron\n\u2610 Local fine-tuning works\n\u2610 Confidence cascade implemented\n\u2610 90% reduction demonstrated for trained users\n\n<strong>Technical Considerations</strong>\n\n<strong>ML Framework Options</strong>\n\n| Framework | Bundle Size | Performance | Ease |\n|-----------|-------------|-------------|------|\n| TensorFlow.js | ~2MB | Good | Medium |\n| ONNX Runtime | ~1MB | Excellent | Medium |\n| Transformers.js | ~5MB+ | Best NLP | Complex |\n| ml5.js | ~3MB | Moderate | Easy |\n\n**Recommendation:** Start with ONNX Runtime for production, TensorFlow.js for prototyping.\n\n<strong>Model Architecture</strong>\n\nFor transaction classification:\n\u2022 Input: TF-IDF or embeddings of email text + features\n\u2022 Architecture: Small feedforward network or gradient boosting\n\u2022 Output: is_transaction probability\n\nFor entity extraction:\n\u2022 Could use small NER model for addresses, names\n\u2022 Or rely on regex + LLM for complex cases\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-084: Thread-Based Transaction Detection\n\u2022 BACKLOG-085: Testing framework for accuracy validation\n\u2022 BACKLOG-077: Feedback Loop (data collection)\n\n<strong>Related Items</strong>\n\n\u2022 Existing tables: <code>llm_analysis_results</code>, <code>llm_extraction_feedback</code>\n\u2022 Pattern matching: <code>electron/services/llm/patternMatcher.ts</code>\n\u2022 LLM tools: <code>electron/services/llm/tools/</code>\n\n<strong>Notes</strong>\n\n\u2022 Start with rule-based + data collection (quick wins)\n\u2022 Tinder game makes training feel like onboarding, not work\n\u2022 Local training ensures privacy while maximizing personalization\n\u2022 Base model updates via app releases improve everyone over time"
  },
  {
    "id": "BACKLOG-087",
    "title": "Onboarding Value Proposition Screen",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "[BACKLOG-087.md](BACKLOG-087.md)",
    "created_at": "2025-12-20",
    "completed_at": "",
    "file": "",
    "description": "<strong>Status</strong>\n\u2022 **Priority:** Medium\n\u2022 **Status:** Pending\n\u2022 **Sprint:** Unassigned\n\u2022 **Created:** 2025-12-19\n\u2022 **Type:** UX / Onboarding\n\n<strong>Summary</strong>\n\nAdd a value proposition screen during onboarding that creates an \"aha moment\" before users connect their email. Use temptation bundling to pair the hard task (setup) with something desirable (never manually audit again).\n\n<strong>Psychology: Temptation Bundling</strong>\n\n> \"We're more likely to do the hard stuff when tightly coupled with something tempting.\"\n\n**Hard task (should):** Connect email, grant permissions, wait for sync\n**Tempting reward (want):** Never screenshot transactions again, automated audit trails\n\nBy showing the reward upfront, users are motivated to complete setup.\n\n<strong>Current Onboarding Flow</strong>\n\n<code>1. Welcome screen\n2. Terms & Conditions\n3. Connect email provider\n4. Sync progress\n5. Dashboard\n</code>\n\nMissing: No \"why this is worth it\" moment.\n\n<strong>Proposed Flow</strong>\n\n<code>1. Welcome screen\n2. Terms & Conditions\n3. \u2728 VALUE PROPOSITION SCREEN \u2728  \u2190 NEW\n4. Connect email provider\n5. Sync progress\n6. Dashboard\n</code>\n\n<strong>Value Proposition Screen Design</strong>\n\n<strong>Option A: Pain/Solution Contrast</strong>\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                                                     \u2502\n\u2502              Before Magic Audit                     \u2502\n\u2502                                                     \u2502\n\u2502    \ud83d\udcf8 Screenshot every transaction email            \u2502\n\u2502    \ud83d\udcc1 Export PDFs for each closing                  \u2502\n\u2502    \u23f0 Hours spent organizing files                  \u2502\n\u2502    \ud83d\ude30 Stress before audits                          \u2502\n\u2502                                                     \u2502\n\u2502              \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500                      \u2502\n\u2502                                                     \u2502\n\u2502              After Magic Audit                      \u2502\n\u2502                                                     \u2502\n\u2502    \u2728 Transactions found automatically              \u2502\n\u2502    \ud83d\udccb Audit trail ready in seconds                  \u2502\n\u2502    \u2615 More time for what matters                    \u2502\n\u2502    \ud83d\ude0c Audits? No problem.                          \u2502\n\u2502                                                     \u2502\n\u2502                                                     \u2502\n\u2502         [ See the magic in action \u2192 ]               \u2502\n\u2502                                                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n<strong>Option B: Time Savings Focus</strong>\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                                                     \u2502\n\u2502                     \u23f1\ufe0f                              \u2502\n\u2502                                                     \u2502\n\u2502       You spend 2+ hours per transaction            \u2502\n\u2502       organizing emails for audit                   \u2502\n\u2502                                                     \u2502\n\u2502                     \u2193                               \u2502\n\u2502                                                     \u2502\n\u2502       Magic Audit does it in seconds                \u2502\n\u2502                                                     \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502                                               \u2502 \u2502\n\u2502  \u2502   10 transactions/month \u00d7 2 hours = 20 hrs   \u2502 \u2502\n\u2502  \u2502                                               \u2502 \u2502\n\u2502  \u2502   That's 240 hours/year you'll get back      \u2502 \u2502\n\u2502  \u2502                                               \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502                                                     \u2502\n\u2502                                                     \u2502\n\u2502            [ Start saving time \u2192 ]                  \u2502\n\u2502                                                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n<strong>Option C: Visual Demo Preview</strong>\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                                                     \u2502\n\u2502          Here's what's about to happen              \u2502\n\u2502                                                     \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502                                               \u2502 \u2502\n\u2502  \u2502   [Animation/illustration showing:]           \u2502 \u2502\n\u2502  \u2502                                               \u2502 \u2502\n\u2502  \u2502   \ud83d\udce7 Emails scanning...                       \u2502 \u2502\n\u2502  \u2502        \u2193                                      \u2502 \u2502\n\u2502  \u2502   \ud83c\udfe0 Transaction detected!                    \u2502 \u2502\n\u2502  \u2502        \u2193                                      \u2502 \u2502\n\u2502  \u2502   \ud83d\udccb Audit trail ready                        \u2502 \u2502\n\u2502  \u2502                                               \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502                                                     \u2502\n\u2502   Your transactions. Found automatically.           \u2502\n\u2502   Your audit trail. Built instantly.               \u2502\n\u2502                                                     \u2502\n\u2502                                                     \u2502\n\u2502              [ Let's go \u2192 ]                         \u2502\n\u2502                                                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n<strong>Option D: Social Proof + Value</strong>\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                                                     \u2502\n\u2502       \"I used to spend my Sundays                   \u2502\n\u2502        organizing transaction files.                \u2502\n\u2502        Now I just click 'Export Audit'.\"            \u2502\n\u2502                                                     \u2502\n\u2502              \u2014 Sarah M., Realtor                    \u2502\n\u2502                                                     \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 \u2502\n\u2502                                                     \u2502\n\u2502         \u2713 Finds transactions automatically          \u2502\n\u2502         \u2713 Builds audit trails instantly             \u2502\n\u2502         \u2713 Export-ready for compliance               \u2502\n\u2502                                                     \u2502\n\u2502                                                     \u2502\n\u2502            [ See it in action \u2192 ]                   \u2502\n\u2502                                                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n<strong>Recommended Approach</strong>\n\n**Option A (Pain/Solution)** for initial release because:\n\u2022 Clear before/after contrast\n\u2022 Emotional connection (stress \u2192 relief)\n\u2022 No assets needed (text-based)\n\nLater iterate with:\n\u2022 Option C animation for polish\n\u2022 Option D testimonials once we have them\n\n<strong>CTA Button Options</strong>\n\n| Button Text | Feeling |\n|-------------|---------|\n| \"See the magic in action\" | Curiosity |\n| \"Start saving time\" | Practical value |\n| \"Let's go\" | Excitement, momentum |\n| \"Find my transactions\" | Direct, action-oriented |\n| \"Set me free\" | Emotional relief |\n\n<strong>Implementation Notes</strong>\n\n<strong>Location</strong>\nInsert after Terms & Conditions, before email provider selection.\n\n<strong>File</strong>\n<code>src/components/onboarding/OnboardingFlow.tsx</code>\n\n<strong>New Component</strong>\n<code>src/components/onboarding/ValueProposition.tsx</code>\n\n<strong>Skip Option</strong>\nConsider: Should users be able to skip?\nRecommendation: No skip button - it's one screen, creates anticipation.\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Value proposition screen added to onboarding flow\n\u2610 Before/after contrast clearly shown\n\u2610 Compelling CTA button\n\u2610 Screen appears after T&C, before email connection\n\u2610 Mobile-responsive design\n\u2610 No skip option (or subtle skip in corner)\n\u2610 Smooth transition to next step\n\n<strong>Metrics to Track</strong>\n\n\u2022 Time spent on screen (engagement)\n\u2022 Drop-off rate at this step vs. email connection step\n\u2022 Completion rate through full onboarding\n\u2022 User feedback/NPS correlation\n\n<strong>Dependencies</strong>\n\n\u2022 None (can be implemented independently)\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-086: Transaction Discovery Flow (celebration screen)\n\u2022 Onboarding flow: <code>src/components/onboarding/OnboardingFlow.tsx</code>\n\n<strong>Notes</strong>\n\n\u2022 Keep text concise - this is about emotion, not explanation\n\u2022 Consider A/B testing different CTAs once analytics is set up\n\u2022 Could add subtle animation to enhance \"magic\" feeling\n\u2022 Future: Personalize based on user's transaction volume"
  },
  {
    "id": "BACKLOG-088",
    "title": "Per-User Local ML Model",
    "category": "service",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "[BACKLOG-088.md](BACKLOG-088.md)",
    "created_at": "2025-12-20",
    "completed_at": "",
    "file": "",
    "description": "<strong>Priority: HIGH</strong>\n\n<strong>Summary</strong>\n\nImplement a per-user local ML model that learns from each user's email data. The model handles transaction detection, progressively taking over from the cloud LLM as it gains accuracy. Uses a tiered graduation system combining data count AND performance metrics to prevent overfitting and premature graduation.\n\n<strong>The Vision</strong>\n\n<code>User starts app\n    \u2502\n    \u25bc\nStage 1: Learning (0-99 examples)\n    \u2192 LLM only, collect training data passively\n    \u2502\n    \u25bc\nStage 2: Validating (100-299 examples)\n    \u2192 LLM primary, train local model, track metrics silently\n    \u2502\n    \u25bc\nStage 3: Assisting (300-499 examples, accuracy >90%)\n    \u2192 Show local prediction if agrees with LLM\n    \u2502\n    \u25bc\nStage 4: Primary (500-999 examples, accuracy >93%)\n    \u2192 Local primary, LLM fallback on low confidence\n    \u2502\n    \u25bc\nStage 5: Graduated (1000+ examples, accuracy >95%, F1 >92%)\n    \u2192 Local only, zero API cost\n</code>\n\n<strong>Existing Infrastructure (Already Built)</strong>\n\nThe database schema is **~80% ready**. These tables already exist:\n\n<strong>Training Data Collection (DONE)</strong>\n\u2022 **<code>classification_feedback</code>** - User corrections for message relevance, transaction links, document types\n\u2022 **<code>user_feedback</code>** - Field-level corrections with original/corrected values\n\u2022 **<code>extraction_metrics</code>** - Accuracy tracking per field per user\n\n<strong>Classification Tracking (DONE)</strong>\n\u2022 **<code>messages.is_transaction_related</code>** - Binary classification target\n\u2022 **<code>messages.classification_confidence</code>** - Confidence score\n\u2022 **<code>messages.classification_method</code>** - 'pattern', 'llm', 'user'\n\u2022 **<code>messages.is_false_positive</code>** - False positive tracking\n\n<strong>What Needs to Be Built</strong>\n\n<strong>1. Model Storage Table</strong>\n\n<code>CREATE TABLE user_models (\n  id TEXT PRIMARY KEY,\n  user_id TEXT NOT NULL,\n\n  -- Model info\n  model_type TEXT NOT NULL,  -- 'transaction_detection', 'transaction_type'\n  model_version INTEGER DEFAULT 1,\n\n  -- Serialized model (JSON for Logistic Regression weights)\n  model_data TEXT NOT NULL,\n  vocabulary TEXT,           -- TF-IDF vocabulary\n\n  -- Training info\n  training_examples INTEGER DEFAULT 0,\n  last_trained_at DATETIME,\n  training_duration_ms INTEGER,\n\n  -- Current tier\n  graduation_tier INTEGER DEFAULT 1,  -- 1-5\n\n  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n\n  FOREIGN KEY (user_id) REFERENCES users_local(id) ON DELETE CASCADE,\n  UNIQUE(user_id, model_type)\n);\n</code>\n\n<strong>2. Model Metrics Tracking Table</strong>\n\n<code>CREATE TABLE model_metrics (\n  id TEXT PRIMARY KEY,\n  user_id TEXT NOT NULL,\n  model_type TEXT NOT NULL,\n\n  -- Metrics (rolling window of last 100 predictions)\n  total_predictions INTEGER DEFAULT 0,\n  correct_predictions INTEGER DEFAULT 0,\n\n  -- Confusion matrix\n  true_positives INTEGER DEFAULT 0,\n  true_negatives INTEGER DEFAULT 0,\n  false_positives INTEGER DEFAULT 0,\n  false_negatives INTEGER DEFAULT 0,\n\n  -- Calculated metrics\n  accuracy REAL,\n  precision_score REAL,\n  recall REAL,\n  f1_score REAL,\n\n  -- Agreement tracking\n  local_llm_agreement_rate REAL,\n\n  -- Window tracking\n  window_start_at DATETIME,\n  last_updated_at DATETIME,\n\n  FOREIGN KEY (user_id) REFERENCES users_local(id) ON DELETE CASCADE,\n  UNIQUE(user_id, model_type)\n);\n</code>\n\n<strong>3. Supabase Model Backup</strong>\n\n<code>-- Supabase Storage bucket: 'user-models'\n-- Path: /models/{user_id}/model_v{version}.json\n-- Size: ~1-5MB per user\n\n-- Sync tracking in local DB\nALTER TABLE user_models ADD COLUMN\n  supabase_synced_at DATETIME,\n  supabase_version INTEGER;\n</code>\n\n<strong>Model Recommendation</strong>\n\n<strong>Task 1: Transaction Detection</strong>\n\n**Model: Logistic Regression + TF-IDF**\n\n| Factor | Why |\n|--------|-----|\n| Works with ~100 examples | Users don't have thousands of emails |\n| Fast training | <1 second to retrain |\n| Fast inference | <10ms |\n| Tiny size | ~100KB - 1MB |\n| Interpretable | Can see which words triggered classification |\n| Incrementally trainable | Add new examples without full retrain |\n\n**Library: <code>ml.js</code>** - scikit-learn-like API for Node.js\n\n<code>import { LogisticRegression } from 'ml-logistic-regression';\nimport { TfIdf } from 'natural';\n\n// Feature extraction\nconst tfidf = new TfIdf();\nemails.forEach(email => tfidf.addDocument(email.subject + ' ' + email.body));\n\n// Train\nconst classifier = new LogisticRegression({ numSteps: 1000 });\nclassifier.train(features, labels);\n\n// Predict\nconst prediction = classifier.predict(newEmailFeatures);\n// Returns: { class: 'transaction', confidence: 0.92 }\n\n// Serialize for storage (~100KB)\nconst modelJson = JSON.stringify(classifier.toJSON());\n</code>\n\n<strong>Task 2: Transaction Type</strong>\n\n**Model: Multi-class Logistic Regression**\n\u2022 Same approach, 4 classes: purchase, sale, lease, other\n\u2022 Only runs on emails classified as transactions\n\n<strong>Task 3: Extraction (Addresses, Contacts, Dates)</strong>\n\n**Keep pattern matching + LLM fallback**\n\u2022 Regex for addresses works well\n\u2022 Date parsing is deterministic\n\u2022 Contact/role extraction needs context \u2192 LLM is better here\n\u2022 Not worth the complexity for ML extraction\n\n<strong>Tiered Graduation System</strong>\n\n<strong>Why Hybrid (Count + Metrics)?</strong>\n\n\u2022 **Data count alone**: Could graduate by luck with small sample\n\u2022 **Metrics alone**: 95% on 20 examples is meaningless\n\u2022 **Both together**: Statistical significance + proven performance\n\n<strong>Graduation Tiers</strong>\n\n<code>interface GraduationTier {\n  tier: number;\n  name: string;\n  minExamples: number;\n  minAccuracy: number;\n  minPrecision: number;\n  minRecall: number;\n  minF1: number;\n  behavior: 'llm_only' | 'compare' | 'hybrid' | 'local_primary' | 'local_only';\n}\n\nconst GRADUATION_TIERS: GraduationTier[] = [\n  {\n    tier: 1,\n    name: 'Learning',\n    minExamples: 0,\n    minAccuracy: 0,\n    minPrecision: 0,\n    minRecall: 0,\n    minF1: 0,\n    behavior: 'llm_only'\n  },\n  {\n    tier: 2,\n    name: 'Validating',\n    minExamples: 100,\n    minAccuracy: 0,      // Just tracking, no requirements yet\n    minPrecision: 0,\n    minRecall: 0,\n    minF1: 0,\n    behavior: 'compare'  // Run both silently, collect metrics\n  },\n  {\n    tier: 3,\n    name: 'Assisting',\n    minExamples: 300,\n    minAccuracy: 0.90,\n    minPrecision: 0.85,\n    minRecall: 0.90,\n    minF1: 0.87,\n    behavior: 'hybrid'   // Show local if agrees with LLM\n  },\n  {\n    tier: 4,\n    name: 'Primary',\n    minExamples: 500,\n    minAccuracy: 0.93,\n    minPrecision: 0.88,\n    minRecall: 0.93,\n    minF1: 0.90,\n    behavior: 'local_primary'  // Local first, LLM on low confidence\n  },\n  {\n    tier: 5,\n    name: 'Graduated',\n    minExamples: 1000,\n    minAccuracy: 0.95,\n    minPrecision: 0.90,\n    minRecall: 0.95,\n    minF1: 0.92,\n    behavior: 'local_only'  // LLM only for edge cases\n  }\n];\n</code>\n\n<strong>Graduation Logic</strong>\n\n<code>function getCurrentTier(metrics: ModelMetrics): GraduationTier {\n  // Find highest tier where ALL requirements are met\n  for (let i = GRADUATION_TIERS.length - 1; i >= 0; i--) {\n    const tier = GRADUATION_TIERS[i];\n    if (\n      metrics.totalExamples >= tier.minExamples &&\n      metrics.accuracy >= tier.minAccuracy &&\n      metrics.precision >= tier.minPrecision &&\n      metrics.recall >= tier.minRecall &&\n      metrics.f1 >= tier.minF1\n    ) {\n      return tier;\n    }\n  }\n  return GRADUATION_TIERS[0]; // Default to Learning\n}\n\nfunction shouldUseLocalModel(\n  tier: GraduationTier,\n  localPrediction: Prediction,\n  confidenceThreshold: number = 0.80\n): 'local' | 'llm' | 'both' {\n  switch (tier.behavior) {\n    case 'llm_only':\n      return 'llm';\n\n    case 'compare':\n      return 'both';  // Run both, use LLM, track local accuracy\n\n    case 'hybrid':\n      return 'both';  // Run both, show local if they agree\n\n    case 'local_primary':\n      return localPrediction.confidence >= confidenceThreshold\n        ? 'local'\n        : 'llm';\n\n    case 'local_only':\n      return localPrediction.confidence >= confidenceThreshold * 0.9\n        ? 'local'\n        : 'llm';  // Still fallback on very low confidence\n  }\n}\n</code>\n\n<strong>Why Recall > Precision for Thresholds</strong>\n\nMissing a real transaction (false negative) is worse than showing a non-transaction (false positive):\n\u2022 User can dismiss a false positive easily\n\u2022 Missing a transaction could mean missing compliance deadlines\n\nSo: <code>minRecall: 0.95</code> vs <code>minPrecision: 0.90</code>\n\n<strong>Supabase Model Backup</strong>\n\n<strong>Storage Structure</strong>\n\n<code>Supabase Storage Bucket: 'user-models'\n\u251c\u2500\u2500 {user_id}/\n\u2502   \u251c\u2500\u2500 transaction_detection_v1.json  (~500KB)\n\u2502   \u251c\u2500\u2500 transaction_detection_v2.json\n\u2502   \u251c\u2500\u2500 transaction_type_v1.json       (~200KB)\n\u2502   \u2514\u2500\u2500 metadata.json                  (~1KB)\n</code>\n\n<strong>Sync Logic</strong>\n\n<code>async function syncModelToSupabase(userId: string, model: UserModel) {\n  const modelJson = JSON.stringify({\n    type: model.type,\n    version: model.version,\n    weights: model.toJSON(),\n    vocabulary: model.vocabulary,\n    metrics: model.metrics,\n    trainedAt: model.lastTrainedAt\n  });\n\n  await supabase.storage\n    .from('user-models')\n    .upload(\n      <code>${userId}/${model.type}_v${model.version}.json</code>,\n      modelJson\n    );\n}\n\nasync function restoreModelFromSupabase(userId: string, modelType: string) {\n  const { data } = await supabase.storage\n    .from('user-models')\n    .download(<code>${userId}/${modelType}_latest.json</code>);\n\n  return deserializeModel(data);\n}\n</code>\n\n<strong>Storage Costs</strong>\n\n| Users | Model Size | Total Storage | Supabase Tier |\n|-------|------------|---------------|---------------|\n| 100 | ~2MB each | ~200MB | Free (1GB) |\n| 500 | ~2MB each | ~1GB | Free (1GB) |\n| 1000+ | ~2MB each | ~2GB+ | Pro ($25/mo, 100GB) |\n\n<strong>Benefits</strong>\n\n| Metric | LLM Only | After Graduation |\n|--------|----------|------------------|\n| Cost per 600 emails | ~$0.10 | $0.00 |\n| Latency | 2-5 seconds | <10ms |\n| Works offline | No | Yes |\n| Privacy | Data sent to API | Fully local |\n| Accuracy | Good baseline | Personalized to user |\n\n<strong>Implementation Phases</strong>\n\n<strong>Phase 1: Infrastructure (~1 sprint)</strong>\n\u2610 Add <code>user_models</code> table\n\u2610 Add <code>model_metrics</code> table\n\u2610 Feature extraction service (TF-IDF)\n\u2610 Model training service (Logistic Regression)\n\u2610 Model persistence (save/load)\n\n<strong>Phase 2: Training Pipeline (~1 sprint)</strong>\n\u2610 Collect training data from existing <code>classification_feedback</code>\n\u2610 Background training worker\n\u2610 Metrics calculation (accuracy, precision, recall, F1)\n\u2610 Tier calculation and storage\n\n<strong>Phase 3: Inference Integration (~1 sprint)</strong>\n\u2610 Hook into extraction pipeline\n\u2610 Implement tier-based behavior switching\n\u2610 Confidence threshold handling\n\u2610 LLM fallback logic\n\n<strong>Phase 4: Supabase Backup (~0.5 sprint)</strong>\n\u2610 Create storage bucket\n\u2610 Sync on model update\n\u2610 Restore on new device login\n\n<strong>Phase 5: Dashboard & Monitoring (~0.5 sprint)</strong>\n\u2610 User-facing graduation progress\n\u2610 Accuracy trends visualization\n\u2610 Admin metrics dashboard\n\n<strong>Dependencies</strong>\n\n\u2611 SPRINT-007 cost optimization (completed) - provides fallback\n\u2611 Database schema for feedback collection (exists)\n\u2610 User feedback UI (for corrections) - partially exists\n\u2610 Background processing infrastructure\n\n<strong>Estimated Effort</strong>\n\n| Phase | Effort | Notes |\n|-------|--------|-------|\n| Phase 1 | 1 sprint | Schema already 80% done |\n| Phase 2 | 1 sprint | |\n| Phase 3 | 1 sprint | |\n| Phase 4 | 0.5 sprint | |\n| Phase 5 | 0.5 sprint | |\n| **Total** | **4 sprints** | Down from 5-6 due to existing schema |\n\n<strong>Success Metrics</strong>\n\n\u2022 80% of active users reach Tier 3 (Assisting) within 2 months\n\u2022 50% of active users reach Tier 5 (Graduated) within 6 months\n\u2022 Average API cost per user drops 90% after Tier 4\n\u2022 No accuracy regression when switching to local model\n\u2022 User corrections decrease over time (model is learning)\n\n<strong>Risks & Mitigations</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Model overfits to user's data | Tiered system requires high example count + metrics |\n| Accuracy drops over time | Track rolling window, auto-demote tier if metrics drop |\n| Model file corruption | Versioned backups on Supabase, can restore previous |\n| User has unusual email patterns | LLM fallback always available on low confidence |"
  },
  {
    "id": "BACKLOG-089",
    "title": "Password Manager Support in Authentication",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "[BACKLOG-089.md](BACKLOG-089.md)",
    "created_at": "2025-12-23",
    "completed_at": "",
    "file": "",
    "description": "<strong>Priority: Medium</strong>\n\n<strong>Summary</strong>\n\nEnable password manager integration (1Password, LastPass, Google Password Manager, etc.) for authentication flows in the Electron app.\n\n<strong>Problem</strong>\n\nCurrently, OAuth popups open in Electron's BrowserWindow which doesn't support browser extensions. Users who rely on password managers can't autofill their credentials.\n\n<strong>Technical Analysis</strong>\n\n<strong>Current State</strong>\n\u2022 OAuth (Google/Microsoft) uses BrowserWindow popups\n\u2022 Browser extensions (1Password, LastPass) don't work in Electron\n\u2022 OS-level password managers may partially work but unreliably\n\n<strong>Options</strong>\n\n| Option | Pros | Cons |\n|--------|------|------|\n| **A: Use system browser** | Full password manager support, familiar UX | Requires deep link/localhost callback handling |\n| **B: OS-level integration** | Works within app | Platform-specific, limited manager support |\n| **C: Manual paste workflow** | Simple to implement | Poor UX |\n\n<strong>Recommended: Option A (System Browser)</strong>\n\nUse <code>shell.openExternal</code> for OAuth flows:\n\n<code>// Instead of BrowserWindow popup\nimport { shell } from 'electron';\n\n// Open OAuth in system browser\nshell.openExternal(authUrl);\n\n// Handle callback via:\n// 1. Deep link (magicaudit://oauth/callback)\n// 2. Localhost redirect (http://localhost:PORT/callback)\n</code>\n\n**Implementation steps:**\n1. Register deep link protocol handler (<code>magicaudit://</code>)\n2. Or spin up temporary localhost server for callback\n3. Update OAuth redirect URIs in Google/Microsoft consoles\n4. Parse callback and complete auth flow\n\n<strong>Platform Considerations</strong>\n\n| Platform | Deep Link Support | Localhost Redirect |\n|----------|-------------------|-------------------|\n| Windows | Yes (registry) | Yes |\n| macOS | Yes (Info.plist) | Yes |\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 OAuth flows open in system default browser\n\u2610 Password managers can autofill credentials\n\u2610 Callback correctly returns to app and completes auth\n\u2610 Works on both Windows and macOS\n\u2610 Fallback to BrowserWindow if system browser fails\n\n<strong>Dependencies</strong>\n\n\u2022 OAuth redirect URI updates in Google Cloud Console\n\u2022 OAuth redirect URI updates in Microsoft Azure Portal\n\n<strong>Estimated Effort</strong>\n\n| Phase | Effort |\n|-------|--------|\n| Research & prototype | 0.5 sprint |\n| Implementation | 1 sprint |\n| Testing (both platforms) | 0.5 sprint |\n| **Total** | 2 sprints |\n\n<strong>References</strong>\n\n\u2022 [Electron shell.openExternal](https://www.electronjs.org/docs/latest/api/shell#shellopenexternalurl-options)\n\u2022 [Electron protocol handler](https://www.electronjs.org/docs/latest/api/app#appsetasdefaultprotocolclientprotocol-path-args)\n\u2022 [1Password browser integration](https://developer.1password.com/docs/web/)"
  },
  {
    "id": "BACKLOG-090",
    "title": "Incremental Sync - Only Process New Data",
    "category": "service",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-014",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "TASK-906, 907, 908, 911",
    "created_at": "2025-12-23",
    "completed_at": "2026-01-02",
    "file": "[BACKLOG-090.md](BACKLOG-090.md)",
    "description": "<strong>Priority: High</strong>\n\n<strong>Summary</strong>\n\nOptimize LLM processing costs by only analyzing data that arrived since the last sync, rather than re-processing all historical data.\n\n<strong>Problem</strong>\n\nCurrently, when syncing emails or iPhone data, we may re-process messages that have already been analyzed by the LLM, wasting API costs and time.\n\n<strong>Data Sources & Sync Timestamps</strong>\n\n<strong>Email (Gmail/Outlook)</strong>\n| Location | Field | Notes |\n|----------|-------|-------|\n| <code>oauth_tokens</code> table | <code>last_sync_at</code> | Per-provider sync timestamp |\n| <code>messages</code> table | <code>received_at</code> | Message received date |\n\n<strong>iPhone (iMessage/Contacts)</strong>\n| Location | Field | Notes |\n|----------|-------|-------|\n| Backup file | <code>lastModified</code> | File modification time |\n| <code>messages</code> table | <code>sent_at</code> / <code>received_at</code> | Message timestamps |\n| <code>useIPhoneSync</code> hook | <code>lastSyncTime</code> | In-memory, from backup status |\n\n<strong>Implementation</strong>\n\n<strong>1. Email Sync Optimization</strong>\n\n<code>// In email fetch service\nasync function fetchNewEmailsSince(userId: string, provider: 'google' | 'microsoft') {\n  // Get last sync timestamp from oauth_tokens\n  const token = await databaseService.getOAuthToken(userId, provider, 'mailbox');\n  const lastSync = token?.last_sync_at;\n\n  // Build query with date filter\n  const query = lastSync\n    ? { after: new Date(lastSync) }\n    : { maxResults: 600 }; // First sync: limit to recent\n\n  const emails = await fetchEmails(query);\n\n  // Update last_sync_at after successful fetch\n  await databaseService.updateOAuthTokenSyncTime(userId, provider, new Date());\n\n  return emails;\n}\n</code>\n\n<strong>2. iPhone Sync Optimization</strong>\n\n<code>// Already partially implemented via external_id deduplication\n// Enhancement: Skip parsing if backup hasn't changed\n\nasync function shouldProcessBackup(backupPath: string, lastSyncTime: Date | null) {\n  const backupModified = await getBackupModifiedTime(backupPath);\n  return !lastSyncTime || backupModified > lastSyncTime;\n}\n</code>\n\n<strong>3. LLM Processing Filter</strong>\n\n<code>// In extraction pipeline\nasync function getMessagesForLLMAnalysis(userId: string) {\n  return await db.query(<code>\n    SELECT * FROM messages\n    WHERE user_id = ?\n    AND is_transaction_related IS NULL  -- Not yet analyzed\n    AND classification_method IS NULL   -- No classification yet\n  </code>, [userId]);\n}\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Email sync only fetches messages newer than <code>last_sync_at</code>\n\u2610 <code>last_sync_at</code> is updated after each successful sync\n\u2610 iPhone sync skips unchanged backups\n\u2610 LLM pipeline only processes unanalyzed messages\n\u2610 First-time sync handles no-timestamp case gracefully\n\u2610 Logs show \"Fetched X new messages since Y\" for debugging\n\n<strong>Estimated Effort</strong>\n\n| Component | Effort |\n|-----------|--------|\n| Email sync optimization | 0.5 sprint |\n| iPhone sync enhancement | 0.25 sprint |\n| LLM filter integration | 0.25 sprint |\n| **Total** | 1 sprint |\n\n<strong>Dependencies</strong>\n\n\u2022 SPRINT-007 (Cost Optimization) - provides base infrastructure\n\u2022 Existing <code>external_id</code> deduplication for iPhone sync\n\n<strong>Cost Impact</strong>\n\nPrevents re-processing of already-analyzed emails, potentially reducing LLM costs by 50-90% for returning users with large mailboxes."
  },
  {
    "id": "BACKLOG-091",
    "title": "Prevent Duplicate Emails Across Providers",
    "category": "service",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-014/015",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "Phase 1 (TASK-905, 909), Phase 2 (TASK-917, 918, 919)",
    "created_at": "2025-12-23",
    "completed_at": "",
    "file": "[BACKLOG-091.md](BACKLOG-091.md)",
    "description": "<strong>Priority: High</strong>\n\n<strong>Summary</strong>\n\nDetect and prevent processing duplicate emails when users connect multiple email providers (Gmail + Outlook) that may contain the same messages (e.g., forwarded emails, CC'd messages, or migrated mailboxes).\n\n<strong>Problem</strong>\n\nUsers can connect both Gmail and Outlook accounts. If they:\n\u2022 Forward emails between accounts\n\u2022 Are CC'd on the same thread via both addresses\n\u2022 Migrated from one provider to another\n\u2022 Have auto-forwarding set up\n\n...the same email content may exist in both mailboxes, leading to:\n\u2022 Duplicate LLM processing costs\n\u2022 Duplicate transactions detected\n\u2022 Confusing UI with same email appearing twice\n\n<strong>Detection Strategies</strong>\n\n<strong>1. Message-ID Header (Preferred)</strong>\nEmail RFC 5322 requires a unique <code>Message-ID</code> header per email:\n<code>Message-ID: <unique-id@example.com>\n</code>\n\nThis ID is preserved when forwarding/syncing between providers.\n\n<code>interface Message {\n  // Add field\n  message_id_header?: string; // RFC 5322 Message-ID\n}\n\n// Dedup query\nSELECT * FROM messages\nWHERE message_id_header NOT IN (\n  SELECT message_id_header FROM messages\n  WHERE message_id_header IS NOT NULL\n  GROUP BY message_id_header\n  HAVING COUNT(*) > 1\n)\n</code>\n\n<strong>2. Content Hash Fallback</strong>\nFor emails without Message-ID or when headers aren't available:\n\n<code>function computeEmailHash(email: Email): string {\n  const content = [\n    email.subject,\n    email.from,\n    email.sentDate?.toISOString(),\n    email.bodyPlain?.slice(0, 500) // First 500 chars\n  ].join('|');\n\n  return crypto.createHash('sha256').update(content).digest('hex');\n}\n</code>\n\n<strong>3. Fuzzy Matching (Optional)</strong>\nFor edge cases with slight variations:\n\u2022 Ignore whitespace differences\n\u2022 Ignore signature blocks\n\u2022 Compare core content only\n\n<strong>Implementation</strong>\n\n<strong>Schema Changes</strong>\n\n<code>-- Add to messages table\nALTER TABLE messages ADD COLUMN message_id_header TEXT;\nALTER TABLE messages ADD COLUMN content_hash TEXT;\nALTER TABLE messages ADD COLUMN duplicate_of TEXT; -- Points to original message ID\n\nCREATE INDEX idx_messages_message_id_header ON messages(message_id_header);\nCREATE INDEX idx_messages_content_hash ON messages(content_hash);\n</code>\n\n<strong>Fetch & Store Flow</strong>\n\n<code>async function storeEmail(email: ParsedEmail, userId: string) {\n  const messageIdHeader = extractMessageIdHeader(email.raw);\n  const contentHash = computeEmailHash(email);\n\n  // Check for existing duplicate\n  const existing = await db.query(<code>\n    SELECT id FROM messages\n    WHERE user_id = ?\n    AND (message_id_header = ? OR content_hash = ?)\n  </code>, [userId, messageIdHeader, contentHash]);\n\n  if (existing) {\n    // Store as duplicate, link to original\n    return await db.insert('messages', {\n      ...email,\n      message_id_header: messageIdHeader,\n      content_hash: contentHash,\n      duplicate_of: existing.id,\n      is_transaction_related: null // Skip LLM analysis\n    });\n  }\n\n  // Store as original\n  return await db.insert('messages', {\n    ...email,\n    message_id_header: messageIdHeader,\n    content_hash: contentHash\n  });\n}\n</code>\n\n<strong>LLM Processing Filter</strong>\n\n<code>// Only process non-duplicate emails\nSELECT * FROM messages\nWHERE user_id = ?\nAND duplicate_of IS NULL\nAND is_transaction_related IS NULL\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Message-ID header extracted and stored for Gmail emails\n\u2610 Message-ID header extracted and stored for Outlook emails\n\u2610 Content hash computed as fallback\n\u2610 Duplicate emails linked via <code>duplicate_of</code> field\n\u2610 LLM pipeline skips duplicates\n\u2610 UI shows duplicate count/indicator (optional)\n\u2610 Existing emails backfilled with hashes (migration)\n\n<strong>Estimated Effort</strong>\n\n| Component | Effort |\n|-----------|--------|\n| Schema migration | 0.25 sprint |\n| Gmail header extraction | 0.25 sprint |\n| Outlook header extraction | 0.25 sprint |\n| Dedup logic + storage | 0.5 sprint |\n| LLM filter update | 0.25 sprint |\n| Testing | 0.5 sprint |\n| **Total** | 2 sprints |\n\n<strong>Edge Cases</strong>\n\n| Case | Handling |\n|------|----------|\n| No Message-ID header | Use content hash |\n| Email edited after forwarding | Content hash differs, treated as new |\n| Same email, different threads | Message-ID same, deduped |\n| Newsletter to both addresses | Deduped by Message-ID |\n\n<strong>References</strong>\n\n\u2022 [RFC 5322 - Message-ID](https://datatracker.ietf.org/doc/html/rfc5322#section-3.6.4)\n\u2022 Gmail API: <code>payload.headers</code> contains Message-ID\n\u2022 Graph API: <code>internetMessageHeaders</code> or <code>internetMessageId</code>"
  },
  {
    "id": "BACKLOG-092",
    "title": "Rename transactionDetailsModule",
    "category": "refactor",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-092.md](BACKLOG-092.md)",
    "created_at": "2025-12-27",
    "completed_at": "",
    "file": "",
    "description": "<strong>Priority: Low</strong>\n\n<strong>Category: refactor</strong>\n\n<strong>Summary</strong>\n\nRename the <code>transactionDetailsModule</code> directory to <code>transactionDetails</code> for naming consistency with other component modules in the codebase.\n\n<strong>Problem</strong>\n\nThe component directory <code>src/components/transactionDetailsModule/</code> uses an inconsistent naming pattern with the <code>Module</code> suffix. All other feature directories follow the pattern <code>src/components/<featureName>/</code> without suffixes:\n\n\u2022 <code>src/components/contact/</code>\n\u2022 <code>src/components/onboarding/</code>\n\u2022 <code>src/components/transaction/</code>\n\u2022 <code>src/components/settings/</code>\n\nThe <code>transactionDetailsModule</code> naming is inconsistent and confusing.\n\n<strong>Solution</strong>\n\nRename the directory and update all imports:\n\n<code># Before\nsrc/components/transactionDetailsModule/\n\n# After\nsrc/components/transactionDetails/\n</code>\n\n<strong>Implementation</strong>\n\n1. Rename directory: <code>transactionDetailsModule</code> -> <code>transactionDetails</code>\n2. Update all imports across the codebase\n3. Verify no broken imports\n4. Run type-check and lint\n\n<strong>Files Affected</strong>\n\n\u2022 <code>src/components/transactionDetailsModule/</code> (directory rename)\n\u2022 All files importing from this module (import path updates)\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Directory renamed to <code>transactionDetails</code>\n\u2610 All imports updated\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Turns | 2-3 | Simple rename + import updates |\n| Tokens | ~10K | |\n| Time | 15-20 min | |\n\n<strong>Dependencies</strong>\n\n\u2022 None (can be executed immediately)\n\n<strong>Risk</strong>\n\nLow - This is a simple rename operation with automated import updates."
  },
  {
    "id": "BACKLOG-093",
    "title": "Create common/ Module",
    "category": "refactor",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-093.md](BACKLOG-093.md)",
    "created_at": "2025-12-27",
    "completed_at": "",
    "file": "",
    "description": "<strong>Priority: Medium</strong>\n\n<strong>Category: refactor</strong>\n\n<strong>Summary</strong>\n\nCreate a <code>common/</code> module to house shared utility components that are used across multiple features. This includes error boundaries, toast notifications, and other cross-cutting UI components.\n\n<strong>Problem</strong>\n\nSeveral utility components currently sit at the root of <code>src/components/</code> without a clear organizational home:\n\n| File | Lines | Current Location | Description |\n|------|-------|------------------|-------------|\n| <code>ErrorBoundary.tsx</code> | 447 | Root | Global error handling component |\n| <code>Toast.tsx</code> | 117 | Root | Notification toast component |\n\nThese components are used across multiple features and don't belong to any specific feature module.\n\n<strong>Solution</strong>\n\nCreate a dedicated <code>common/</code> module:\n\n<code>src/components/\n+-- common/\n    +-- index.ts                 # Barrel export\n    +-- ErrorBoundary.tsx        # Moved from root\n    +-- Toast.tsx                # Moved from root\n    +-- __tests__/\n        +-- ErrorBoundary.test.tsx\n        +-- Toast.test.tsx\n</code>\n\n<strong>Implementation</strong>\n\n1. Create <code>src/components/common/</code> directory\n2. Move <code>ErrorBoundary.tsx</code> to <code>common/</code>\n3. Move <code>Toast.tsx</code> to <code>common/</code>\n4. Move associated test files to <code>common/__tests__/</code>\n5. Create barrel export (<code>index.ts</code>)\n6. Update all imports across the codebase\n\n<strong>Files to Move</strong>\n\n<strong>Components</strong>\n\u2022 <code>src/components/ErrorBoundary.tsx</code> -> <code>src/components/common/ErrorBoundary.tsx</code>\n\u2022 <code>src/components/Toast.tsx</code> -> <code>src/components/common/Toast.tsx</code>\n\n<strong>Tests (if exist)</strong>\n\u2022 <code>src/components/__tests__/ErrorBoundary.test.tsx</code> -> <code>src/components/common/__tests__/ErrorBoundary.test.tsx</code>\n\u2022 <code>src/components/__tests__/Toast.test.tsx</code> -> <code>src/components/common/__tests__/Toast.test.tsx</code>\n\n<strong>Barrel Export</strong>\n\n<code>// src/components/common/index.ts\nexport { ErrorBoundary } from './ErrorBoundary';\nexport { Toast } from './Toast';\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>common/</code> directory created\n\u2610 Both components moved\n\u2610 Test files relocated (if exist)\n\u2610 Barrel export created\n\u2610 All imports updated\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Turns | 3-4 | Move files + update imports |\n| Tokens | ~15K | |\n| Time | 20-30 min | |\n\n<strong>Dependencies</strong>\n\n\u2022 None (can be executed independently)\n\n<strong>Future Additions</strong>\n\nOther candidates for <code>common/</code> module:\n\u2022 Loading spinners\n\u2022 Modal base components\n\u2022 Form field wrappers\n\u2022 Confirmation dialogs"
  },
  {
    "id": "BACKLOG-094",
    "title": "Create llm/ Module",
    "category": "refactor",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-094.md](BACKLOG-094.md)",
    "created_at": "2025-12-27",
    "completed_at": "",
    "file": "",
    "description": "<strong>Priority: Medium</strong>\n\n<strong>Category: refactor</strong>\n\n<strong>Summary</strong>\n\nCreate a dedicated <code>llm/</code> module for LLM/AI-related UI components. This consolidates AI-specific error handling and display components in one location.\n\n<strong>Problem</strong>\n\nLLM-related components are scattered at the root of <code>src/components/</code>:\n\n| File | Lines | Current Location | Description |\n|------|-------|------------------|-------------|\n| <code>LLMErrorBoundary.tsx</code> | 125 | Root | Error boundary specific to LLM operations |\n| <code>LLMErrorDisplay.tsx</code> | 134 | Root | Error display component for LLM failures |\n\nThese components are closely related and should be grouped together.\n\n<strong>Solution</strong>\n\nCreate a dedicated <code>llm/</code> module:\n\n<code>src/components/\n+-- llm/\n    +-- index.ts                 # Barrel export\n    +-- LLMErrorBoundary.tsx     # Moved from root\n    +-- LLMErrorDisplay.tsx      # Moved from root\n    +-- __tests__/\n        +-- LLMErrorBoundary.test.tsx\n        +-- LLMErrorDisplay.test.tsx\n</code>\n\n<strong>Implementation</strong>\n\n1. Create <code>src/components/llm/</code> directory\n2. Move <code>LLMErrorBoundary.tsx</code> to <code>llm/</code>\n3. Move <code>LLMErrorDisplay.tsx</code> to <code>llm/</code>\n4. Move associated test files to <code>llm/__tests__/</code>\n5. Create barrel export (<code>index.ts</code>)\n6. Update all imports across the codebase\n\n<strong>Files to Move</strong>\n\n<strong>Components</strong>\n\u2022 <code>src/components/LLMErrorBoundary.tsx</code> -> <code>src/components/llm/LLMErrorBoundary.tsx</code>\n\u2022 <code>src/components/LLMErrorDisplay.tsx</code> -> <code>src/components/llm/LLMErrorDisplay.tsx</code>\n\n<strong>Tests (if exist)</strong>\n\u2022 <code>src/components/__tests__/LLMErrorBoundary.test.tsx</code> -> <code>src/components/llm/__tests__/LLMErrorBoundary.test.tsx</code>\n\u2022 <code>src/components/__tests__/LLMErrorDisplay.test.tsx</code> -> <code>src/components/llm/__tests__/LLMErrorDisplay.test.tsx</code>\n\n<strong>Barrel Export</strong>\n\n<code>// src/components/llm/index.ts\nexport { LLMErrorBoundary } from './LLMErrorBoundary';\nexport { LLMErrorDisplay } from './LLMErrorDisplay';\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>llm/</code> directory created\n\u2610 Both components moved\n\u2610 Test files relocated (if exist)\n\u2610 Barrel export created\n\u2610 All imports updated\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Turns | 2-3 | Small module, few imports |\n| Tokens | ~10K | |\n| Time | 15-20 min | |\n\n<strong>Dependencies</strong>\n\n\u2022 None (can be executed independently)\n\n<strong>Notes</strong>\n\n\u2022 TASK-618 identifies <code>LLMLoadingStates.tsx</code> as orphaned - this should be deleted, not moved\n\u2022 The <code>llm/</code> module is for active, used components only"
  },
  {
    "id": "BACKLOG-095",
    "title": "Create email/ Module",
    "category": "refactor",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-095.md](BACKLOG-095.md)",
    "created_at": "2025-12-27",
    "completed_at": "",
    "file": "",
    "description": "<strong>Priority: Medium</strong>\n\n<strong>Category: refactor</strong>\n\n<strong>Summary</strong>\n\nCreate a dedicated <code>email/</code> module for email export and processing UI components. This consolidates email-specific functionality in one location.\n\n<strong>Problem</strong>\n\nEmail export components are scattered at the root of <code>src/components/</code>:\n\n| File | Lines | Current Location | Description |\n|------|-------|------------------|-------------|\n| <code>OutlookExport.tsx</code> | 675 | Root | Main Outlook export functionality |\n| <code>ExportModal.tsx</code> | 427 | Root | Export dialog/modal |\n| <code>ExportComplete.tsx</code> | 164 | Root | Export completion screen |\n\nThese components form a cohesive email export feature and should be grouped together.\n\n<strong>Solution</strong>\n\nCreate a dedicated <code>email/</code> module:\n\n<code>src/components/\n+-- email/\n    +-- index.ts                 # Barrel export\n    +-- OutlookExport.tsx        # Moved from root (675 lines)\n    +-- ExportModal.tsx          # Moved from root (427 lines)\n    +-- ExportComplete.tsx       # Moved from root (164 lines)\n    +-- __tests__/\n        +-- OutlookExport.test.tsx\n        +-- ExportModal.test.tsx\n        +-- ExportComplete.test.tsx\n</code>\n\n<strong>Implementation</strong>\n\n1. Create <code>src/components/email/</code> directory\n2. Move <code>OutlookExport.tsx</code> to <code>email/</code>\n3. Move <code>ExportModal.tsx</code> to <code>email/</code>\n4. Move <code>ExportComplete.tsx</code> to <code>email/</code>\n5. Move associated test files to <code>email/__tests__/</code>\n6. Create barrel export (<code>index.ts</code>)\n7. Update all imports across the codebase\n\n<strong>Files to Move</strong>\n\n<strong>Components</strong>\n\u2022 <code>src/components/OutlookExport.tsx</code> -> <code>src/components/email/OutlookExport.tsx</code>\n\u2022 <code>src/components/ExportModal.tsx</code> -> <code>src/components/email/ExportModal.tsx</code>\n\u2022 <code>src/components/ExportComplete.tsx</code> -> <code>src/components/email/ExportComplete.tsx</code>\n\n<strong>Tests (if exist)</strong>\n\u2022 Move any associated test files to <code>email/__tests__/</code>\n\n<strong>Barrel Export</strong>\n\n<code>// src/components/email/index.ts\nexport { OutlookExport } from './OutlookExport';\nexport { ExportModal } from './ExportModal';\nexport { ExportComplete } from './ExportComplete';\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>email/</code> directory created\n\u2610 All 3 components moved\n\u2610 Test files relocated (if exist)\n\u2610 Barrel export created\n\u2610 All imports updated\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Turns | 4-5 | More files to move, more imports |\n| Tokens | ~20K | |\n| Time | 30-40 min | |\n\n<strong>Dependencies</strong>\n\n\u2022 None (can be executed independently)\n\n<strong>Future Considerations</strong>\n\n\u2022 <code>OutlookExport.tsx</code> at 675 lines may benefit from splitting in a future sprint\n\u2022 Gmail export components (if added) would also go here"
  },
  {
    "id": "BACKLOG-096",
    "title": "Create system/ Module",
    "category": "refactor",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-096.md](BACKLOG-096.md)",
    "created_at": "2025-12-27",
    "completed_at": "",
    "file": "",
    "description": "<strong>Priority: Medium</strong>\n\n<strong>Category: refactor</strong>\n\n<strong>Summary</strong>\n\nCreate a dedicated <code>system/</code> module for system-level and infrastructure UI components. This includes health monitoring, offline handling, update notifications, and system settings.\n\n<strong>Problem</strong>\n\nSystem/infrastructure components are scattered at the root of <code>src/components/</code>:\n\n| File | Lines | Current Location | Description |\n|------|-------|------------------|-------------|\n| <code>SystemHealthMonitor.tsx</code> | 326 | Root | System health dashboard |\n| <code>OfflineFallback.tsx</code> | 325 | Root | Offline state handling |\n| <code>UpdateNotification.tsx</code> | 89 | Root | App update notifications |\n| <code>SystemSettingsMockup.tsx</code> | 364 | Root | System settings UI |\n\nThese components are all related to system-level functionality and should be grouped together.\n\n<strong>Solution</strong>\n\nCreate a dedicated <code>system/</code> module:\n\n<code>src/components/\n+-- system/\n    +-- index.ts                    # Barrel export\n    +-- SystemHealthMonitor.tsx     # Moved from root (326 lines)\n    +-- OfflineFallback.tsx         # Moved from root (325 lines)\n    +-- UpdateNotification.tsx      # Moved from root (89 lines)\n    +-- SystemSettingsMockup.tsx    # Moved from root (364 lines)\n    +-- __tests__/\n        +-- SystemHealthMonitor.test.tsx\n        +-- OfflineFallback.test.tsx\n        +-- UpdateNotification.test.tsx\n        +-- SystemSettingsMockup.test.tsx\n</code>\n\n<strong>Implementation</strong>\n\n1. Create <code>src/components/system/</code> directory\n2. Move <code>SystemHealthMonitor.tsx</code> to <code>system/</code>\n3. Move <code>OfflineFallback.tsx</code> to <code>system/</code>\n4. Move <code>UpdateNotification.tsx</code> to <code>system/</code>\n5. Move <code>SystemSettingsMockup.tsx</code> to <code>system/</code>\n6. Move associated test files to <code>system/__tests__/</code>\n7. Create barrel export (<code>index.ts</code>)\n8. Update all imports across the codebase\n\n<strong>Files to Move</strong>\n\n<strong>Components</strong>\n\u2022 <code>src/components/SystemHealthMonitor.tsx</code> -> <code>src/components/system/SystemHealthMonitor.tsx</code>\n\u2022 <code>src/components/OfflineFallback.tsx</code> -> <code>src/components/system/OfflineFallback.tsx</code>\n\u2022 <code>src/components/UpdateNotification.tsx</code> -> <code>src/components/system/UpdateNotification.tsx</code>\n\u2022 <code>src/components/SystemSettingsMockup.tsx</code> -> <code>src/components/system/SystemSettingsMockup.tsx</code>\n\n<strong>Tests (if exist)</strong>\n\u2022 Move any associated test files to <code>system/__tests__/</code>\n\n<strong>Barrel Export</strong>\n\n<code>// src/components/system/index.ts\nexport { SystemHealthMonitor } from './SystemHealthMonitor';\nexport { OfflineFallback } from './OfflineFallback';\nexport { UpdateNotification } from './UpdateNotification';\nexport { SystemSettingsMockup } from './SystemSettingsMockup';\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>system/</code> directory created\n\u2610 All 4 components moved\n\u2610 Test files relocated (if exist)\n\u2610 Barrel export created\n\u2610 All imports updated\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Turns | 4-5 | 4 files to move |\n| Tokens | ~20K | |\n| Time | 30-40 min | |\n\n<strong>Dependencies</strong>\n\n\u2022 None (can be executed independently)\n\n<strong>Future Considerations</strong>\n\n\u2022 <code>SystemSettingsMockup.tsx</code> suggests this is a placeholder - may be replaced with real settings\n\u2022 May want to consider merging with or relating to <code>settings/</code> module"
  },
  {
    "id": "BACKLOG-097",
    "title": "Relocate Root-Level Test Files",
    "category": "refactor",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-097.md](BACKLOG-097.md)",
    "created_at": "2025-12-27",
    "completed_at": "",
    "file": "",
    "description": "<strong>Priority: Medium</strong>\n\n<strong>Category: refactor</strong>\n\n<strong>Summary</strong>\n\nMove 17 root-level test files in <code>src/components/__tests__/</code> to their respective feature module <code>__tests__/</code> folders for better co-location of tests with their source code.\n\n<strong>Problem</strong>\n\nThere are approximately 17 test files sitting at <code>src/components/__tests__/</code> that test components which now live in feature-specific modules. This violates the principle of co-locating tests with their source code.\n\nCurrent structure:\n<code>src/components/\n+-- __tests__/\n|   +-- ContactDetailsModal.test.tsx  # Should be in contact/__tests__/\n|   +-- TransactionList.test.tsx      # Should be in transaction/__tests__/\n|   +-- ...\n+-- contact/\n|   +-- ContactDetailsModal.tsx       # Source lives here\n+-- transaction/\n    +-- TransactionList.tsx           # Source lives here\n</code>\n\n<strong>Solution</strong>\n\nRelocate test files to their respective feature <code>__tests__/</code> folders:\n\n<code>src/components/\n+-- contact/\n|   +-- __tests__/\n|   |   +-- ContactDetailsModal.test.tsx  # Moved here\n|   +-- ContactDetailsModal.tsx\n+-- transaction/\n    +-- __tests__/\n    |   +-- TransactionList.test.tsx      # Moved here\n    +-- TransactionList.tsx\n</code>\n\n<strong>Implementation</strong>\n\n1. Inventory all test files in <code>src/components/__tests__/</code>\n2. For each test file:\n   a. Identify the source component it tests\n   b. Determine the feature module where the source lives\n   c. Create <code>__tests__/</code> folder in that module if needed\n   d. Move the test file\n   e. Update any relative imports in the test file\n3. Verify all tests still pass\n4. Delete empty <code>src/components/__tests__/</code> if all files moved\n\n<strong>Test Files to Relocate</strong>\n\nExpected relocations (verify actual files before executing):\n\n| Test File | Source Component | Target Location |\n|-----------|------------------|-----------------|\n| <code>ContactDetailsModal.test.tsx</code> | <code>contact/</code> | <code>contact/__tests__/</code> |\n| <code>ContactList.test.tsx</code> | <code>contact/</code> | <code>contact/__tests__/</code> |\n| <code>TransactionList.test.tsx</code> | <code>transaction/</code> | <code>transaction/__tests__/</code> |\n| <code>TransactionCard.test.tsx</code> | <code>transaction/</code> | <code>transaction/__tests__/</code> |\n| ... | ... | ... |\n\n**Note:** Exact file list should be verified by examining <code>src/components/__tests__/</code> before execution.\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 All 17 test files relocated to appropriate feature <code>__tests__/</code> folders\n\u2610 Relative imports in test files updated\n\u2610 Root <code>__tests__/</code> folder removed or contains only truly shared tests\n\u2610 <code>npm test</code> passes with all tests\n\u2610 Test coverage unchanged\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Turns | 6-8 | Many files to move, imports to update |\n| Tokens | ~30K | |\n| Time | 45-60 min | |\n\n<strong>Dependencies</strong>\n\n\u2022 Should be executed AFTER module creation tasks (BACKLOG-093 through BACKLOG-096)\n\u2022 Tests for components in new modules need those modules created first\n\n<strong>Execution Order</strong>\n\nRecommended to execute after:\n1. BACKLOG-093 (common/ module)\n2. BACKLOG-094 (llm/ module)\n3. BACKLOG-095 (email/ module)\n4. BACKLOG-096 (system/ module)\n\nThis ensures target <code>__tests__/</code> folders exist before moving tests."
  },
  {
    "id": "BACKLOG-098",
    "title": "Split AuditTransactionModal.tsx",
    "category": "refactor",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-098.md](BACKLOG-098.md)",
    "created_at": "2025-12-27",
    "completed_at": "",
    "file": "",
    "description": "<strong>Priority: High</strong>\n\n<strong>Category: refactor</strong>\n\n<strong>Summary</strong>\n\nSplit the large <code>AuditTransactionModal.tsx</code> (1,169 lines) into smaller, focused components and create a dedicated <code>audit/</code> module for audit-related functionality.\n\n<strong>Problem</strong>\n\n<code>AuditTransactionModal.tsx</code> at 1,169 lines is one of the largest components in the codebase. It likely contains:\n\u2022 Modal container logic\n\u2022 Audit form handling\n\u2022 Validation logic\n\u2022 Multiple sub-sections\n\u2022 State management\n\nThis violates the single responsibility principle and makes the component difficult to maintain, test, and reason about.\n\n<strong>Solution</strong>\n\n1. Analyze the component structure\n2. Extract logical sub-components\n3. Extract custom hooks for state management\n4. Create <code>audit/</code> module to house all extracted pieces\n\n<strong>Target Structure</strong>\n\n<code>src/components/\n+-- audit/\n    +-- index.ts                      # Barrel export\n    +-- AuditTransactionModal.tsx     # Main modal (target: <300 lines)\n    +-- components/\n    |   +-- AuditForm.tsx             # Form component\n    |   +-- AuditSummary.tsx          # Summary display\n    |   +-- AuditActions.tsx          # Action buttons\n    |   +-- AuditValidation.tsx       # Validation messages\n    +-- hooks/\n    |   +-- useAuditForm.ts           # Form state management\n    |   +-- useAuditValidation.ts     # Validation logic\n    +-- __tests__/\n        +-- AuditTransactionModal.test.tsx\n        +-- AuditForm.test.tsx\n        +-- useAuditForm.test.ts\n</code>\n\n<strong>Implementation Phases</strong>\n\n<strong>Phase 1: Analysis (~30 min)</strong>\n1. Read and understand the current component structure\n2. Identify logical boundaries for extraction\n3. Map state and prop flows\n4. Document extraction plan\n\n<strong>Phase 2: Hook Extraction (~45 min)</strong>\n1. Extract form state to <code>useAuditForm.ts</code>\n2. Extract validation logic to <code>useAuditValidation.ts</code>\n3. Update main component to use hooks\n\n<strong>Phase 3: Component Extraction (~60 min)</strong>\n1. Extract form section to <code>AuditForm.tsx</code>\n2. Extract summary section to <code>AuditSummary.tsx</code>\n3. Extract action buttons to <code>AuditActions.tsx</code>\n4. Update main component to compose extracted pieces\n\n<strong>Phase 4: Module Organization (~20 min)</strong>\n1. Create <code>audit/</code> directory structure\n2. Move all files to new locations\n3. Create barrel exports\n4. Update all imports\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>AuditTransactionModal.tsx</code> reduced to <300 lines\n\u2610 At least 3 sub-components extracted\n\u2610 At least 1 custom hook extracted\n\u2610 <code>audit/</code> module created with proper structure\n\u2610 All functionality preserved (no behavior changes)\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\u2610 Existing tests updated/pass\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Turns | 12-16 | Large refactor requiring careful analysis |\n| Tokens | ~60K | |\n| Time | 2-3 hours | |\n\n**Calibrated (0.5x refactor multiplier):**\n| Metric | Calibrated Estimate |\n|--------|---------------------|\n| Turns | 6-8 |\n| Tokens | ~30K |\n| Time | 1-1.5 hours |\n\n<strong>Dependencies</strong>\n\n\u2022 Should be executed after TASK-618 (orphaned files cleanup)\n\u2022 No blocking dependencies on other BACKLOG items\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Tight coupling in original component | Careful analysis before extraction |\n| Breaking existing functionality | Keep all tests passing throughout |\n| Prop drilling after extraction | Use context or composition patterns if needed |\n\n<strong>Notes</strong>\n\nThis is a larger refactoring task that may benefit from being broken into multiple TASKs during sprint planning:\n\u2022 TASK-A: Analysis and hook extraction\n\u2022 TASK-B: Component extraction\n\u2022 TASK-C: Module organization"
  },
  {
    "id": "BACKLOG-099",
    "title": "Split EmailOnboardingScreen.tsx",
    "category": "refactor",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~35K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-099.md](BACKLOG-099.md)",
    "created_at": "2025-12-27",
    "completed_at": "",
    "file": "",
    "description": "<strong>Priority: High</strong>\n\n<strong>Category: refactor</strong>\n\n<strong>Summary</strong>\n\nSplit the large <code>EmailOnboardingScreen.tsx</code> (1,203 lines) into smaller, focused components and hooks. This is one of the largest files in the codebase.\n\n<strong>Problem</strong>\n\n<code>EmailOnboardingScreen.tsx</code> at 1,203 lines is the largest component in the codebase. It likely contains:\n\u2022 Multiple onboarding steps/screens\n\u2022 Provider selection (Gmail/Outlook)\n\u2022 Authentication flows\n\u2022 Permission handling\n\u2022 Progress tracking\n\u2022 State management for the entire flow\n\nThis size makes the component:\n\u2022 Difficult to understand and maintain\n\u2022 Hard to test individual pieces\n\u2022 Prone to merge conflicts\n\u2022 Slow to navigate in IDE\n\n<strong>Solution</strong>\n\nAnalyze and extract logical pieces while keeping the component in the existing <code>onboarding/</code> module structure.\n\n<strong>Target Structure</strong>\n\n<code>src/components/\n+-- onboarding/\n    +-- index.ts                           # Barrel export\n    +-- EmailOnboardingScreen.tsx          # Main orchestrator (target: <300 lines)\n    +-- components/\n    |   +-- ProviderSelection.tsx          # Gmail/Outlook selection\n    |   +-- GmailAuthStep.tsx              # Gmail authentication\n    |   +-- OutlookAuthStep.tsx            # Outlook authentication\n    |   +-- PermissionsStep.tsx            # Permission requests\n    |   +-- OnboardingProgress.tsx         # Progress indicator\n    |   +-- OnboardingComplete.tsx         # Completion screen\n    +-- hooks/\n    |   +-- useOnboardingFlow.ts           # Flow state machine\n    |   +-- useProviderAuth.ts             # Auth handling\n    +-- __tests__/\n        +-- EmailOnboardingScreen.test.tsx\n        +-- ProviderSelection.test.tsx\n        +-- useOnboardingFlow.test.ts\n</code>\n\n<strong>Implementation Phases</strong>\n\n<strong>Phase 1: Analysis (~30 min)</strong>\n1. Read and understand the current component structure\n2. Identify the different \"steps\" in the onboarding flow\n3. Map state and prop flows\n4. Document extraction plan with specific line ranges\n\n<strong>Phase 2: Hook Extraction (~45 min)</strong>\n1. Extract flow state management to <code>useOnboardingFlow.ts</code>\n2. Extract auth logic to <code>useProviderAuth.ts</code>\n3. Update main component to use hooks\n\n<strong>Phase 3: Step Extraction (~90 min)</strong>\n1. Extract provider selection UI\n2. Extract Gmail auth step\n3. Extract Outlook auth step\n4. Extract permissions step\n5. Extract progress/completion UI\n\n<strong>Phase 4: Cleanup (~20 min)</strong>\n1. Update barrel exports\n2. Update all imports\n3. Verify tests pass\n4. Final review\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>EmailOnboardingScreen.tsx</code> reduced to <300 lines\n\u2610 At least 4 sub-components extracted\n\u2610 At least 1 custom hook extracted\n\u2610 All functionality preserved (no behavior changes)\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\u2610 Manual testing of onboarding flow passes\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Turns | 14-18 | Largest file in codebase |\n| Tokens | ~70K | |\n| Time | 2.5-3.5 hours | |\n\n**Calibrated (0.5x refactor multiplier):**\n| Metric | Calibrated Estimate |\n|--------|---------------------|\n| Turns | 7-9 |\n| Tokens | ~35K |\n| Time | 1.5-2 hours |\n\n<strong>Dependencies</strong>\n\n\u2022 None (onboarding/ module already exists)\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Complex flow state management | Careful hook extraction, keep state centralized |\n| Auth provider integration points | Test each step independently |\n| Breaking onboarding for new users | Manual testing required |\n\n<strong>Testing Considerations</strong>\n\nThe onboarding flow is critical for new users. Manual testing should include:\n1. Fresh install experience\n2. Gmail authentication flow\n3. Outlook authentication flow\n4. Permission granting\n5. Flow completion\n\n<strong>Notes</strong>\n\nThis is a larger refactoring task that may benefit from being broken into multiple TASKs during sprint planning:\n\u2022 TASK-A: Analysis and hook extraction\n\u2022 TASK-B: Provider selection extraction\n\u2022 TASK-C: Auth steps extraction\n\u2022 TASK-D: Progress/completion extraction"
  },
  {
    "id": "BACKLOG-100",
    "title": "Create auth/ Module",
    "category": "refactor",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-100.md](BACKLOG-100.md)",
    "created_at": "2025-12-27",
    "completed_at": "",
    "file": "",
    "description": "<strong>Priority: Medium</strong>\n\n<strong>Category: refactor</strong>\n\n<strong>Summary</strong>\n\nCreate a dedicated <code>auth/</code> module for authentication-related UI components. This consolidates login flows for Microsoft and general authentication in one location.\n\n<strong>Problem</strong>\n\nAuthentication components are scattered at the root of <code>src/components/</code>:\n\n| File | Lines | Current Location | Description |\n|------|-------|------------------|-------------|\n| <code>Login.tsx</code> | 563 | Root | Main login component |\n| <code>MicrosoftLogin.tsx</code> | 347 | Root | Microsoft-specific login flow |\n\nThese components are closely related and should be grouped together.\n\n<strong>Solution</strong>\n\nCreate a dedicated <code>auth/</code> module:\n\n<code>src/components/\n+-- auth/\n    +-- index.ts                 # Barrel export\n    +-- Login.tsx                # Moved from root (563 lines)\n    +-- MicrosoftLogin.tsx       # Moved from root (347 lines)\n    +-- __tests__/\n        +-- Login.test.tsx\n        +-- MicrosoftLogin.test.tsx\n</code>\n\n<strong>Implementation</strong>\n\n1. Create <code>src/components/auth/</code> directory\n2. Move <code>Login.tsx</code> to <code>auth/</code>\n3. Move <code>MicrosoftLogin.tsx</code> to <code>auth/</code>\n4. Move associated test files to <code>auth/__tests__/</code>\n5. Create barrel export (<code>index.ts</code>)\n6. Update all imports across the codebase\n\n<strong>Files to Move</strong>\n\n<strong>Components</strong>\n\u2022 <code>src/components/Login.tsx</code> -> <code>src/components/auth/Login.tsx</code>\n\u2022 <code>src/components/MicrosoftLogin.tsx</code> -> <code>src/components/auth/MicrosoftLogin.tsx</code>\n\n<strong>Tests (if exist)</strong>\n\u2022 Move any associated test files to <code>auth/__tests__/</code>\n\n<strong>Barrel Export</strong>\n\n<code>// src/components/auth/index.ts\nexport { Login } from './Login';\nexport { MicrosoftLogin } from './MicrosoftLogin';\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>auth/</code> directory created\n\u2610 Both components moved\n\u2610 Test files relocated (if exist)\n\u2610 Barrel export created\n\u2610 All imports updated\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Turns | 3-4 | Two files to move |\n| Tokens | ~15K | |\n| Time | 20-30 min | |\n\n<strong>Dependencies</strong>\n\n\u2022 None (can be executed independently)\n\n<strong>Future Considerations</strong>\n\n\u2022 <code>Login.tsx</code> at 563 lines may benefit from splitting in a future sprint\n\u2022 Additional auth providers (Gmail OAuth) may be added later\n\u2022 Password reset, logout components could also live here"
  },
  {
    "id": "BACKLOG-101",
    "title": "Split PermissionsScreen.tsx",
    "category": "refactor",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~22K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-101.md](BACKLOG-101.md)",
    "created_at": "2025-12-27",
    "completed_at": "",
    "file": "",
    "description": "<strong>Priority: Medium</strong>\n\n<strong>Category: refactor</strong>\n\n<strong>Summary</strong>\n\nSplit the large <code>PermissionsScreen.tsx</code> (873 lines) into smaller, focused components. This is one of the larger files in the codebase.\n\n<strong>Problem</strong>\n\n<code>PermissionsScreen.tsx</code> at 873 lines likely contains:\n\u2022 Multiple permission types\n\u2022 Platform-specific handling (Windows/macOS)\n\u2022 Permission request flows\n\u2022 Status display for each permission\n\u2022 Complex conditional rendering\n\nThis size makes the component difficult to maintain and test.\n\n<strong>Solution</strong>\n\nAnalyze and extract logical pieces, keeping the component in an appropriate module.\n\n<strong>Target Structure</strong>\n\n<code>src/components/\n+-- permissions/\n    +-- index.ts                         # Barrel export\n    +-- PermissionsScreen.tsx            # Main orchestrator (target: <300 lines)\n    +-- components/\n    |   +-- PermissionCard.tsx           # Individual permission display\n    |   +-- PermissionStatus.tsx         # Status indicator\n    |   +-- PermissionRequest.tsx        # Request flow\n    |   +-- PlatformPermissions.tsx      # Platform-specific handling\n    +-- hooks/\n    |   +-- usePermissions.ts            # Permission state management\n    +-- __tests__/\n        +-- PermissionsScreen.test.tsx\n        +-- PermissionCard.test.tsx\n</code>\n\n<strong>Implementation Phases</strong>\n\n<strong>Phase 1: Analysis (~20 min)</strong>\n1. Read and understand the current component structure\n2. Identify logical boundaries for extraction\n3. Map state and prop flows\n\n<strong>Phase 2: Hook Extraction (~30 min)</strong>\n1. Extract permission state management to <code>usePermissions.ts</code>\n2. Update main component to use hook\n\n<strong>Phase 3: Component Extraction (~60 min)</strong>\n1. Extract permission card UI\n2. Extract status indicators\n3. Extract request flow components\n4. Update main component to compose pieces\n\n<strong>Phase 4: Module Organization (~20 min)</strong>\n1. Create <code>permissions/</code> directory structure\n2. Move all files\n3. Create barrel exports\n4. Update imports\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>PermissionsScreen.tsx</code> reduced to <300 lines\n\u2610 At least 2 sub-components extracted\n\u2610 Custom hook extracted for permission state\n\u2610 <code>permissions/</code> module created\n\u2610 All functionality preserved\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Turns | 10-12 | Medium-large refactor |\n| Tokens | ~45K | |\n| Time | 1.5-2 hours | |\n\n**Calibrated (0.5x refactor multiplier):**\n| Metric | Calibrated Estimate |\n|--------|---------------------|\n| Turns | 5-6 |\n| Tokens | ~22K |\n| Time | 45-60 min |\n\n<strong>Dependencies</strong>\n\n\u2022 None\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Platform-specific code complexity | Keep platform logic together |\n| Permission API interactions | Test on both Windows and macOS |\n\n<strong>Notes</strong>\n\nPermissions are critical for app functionality. Manual testing should include:\n1. Fresh install permission requests\n2. Permission re-granting after denial\n3. Platform-specific behavior (Windows vs macOS)"
  },
  {
    "id": "BACKLOG-102",
    "title": "Security Hardening Evaluation",
    "category": "security",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-102.md](BACKLOG-102.md)",
    "created_at": "2025-12-27",
    "completed_at": "",
    "file": "",
    "description": "<strong>Priority: Medium</strong>\n\n<strong>Category: security</strong>\n\n<strong>Summary</strong>\n\nEvaluate and implement additional security hardening measures to further protect against SQL injection, XSS, and DoS attacks. Current protections are strong (8.5/10), but there are minor gaps to address.\n\n<strong>Current State</strong>\n\nThe codebase has solid defense-in-depth protections:\n\u2022 **SQL Injection**: Parameterized queries (100%), field whitelist (TASK-611), input validation\n\u2022 **XSS**: React auto-escaping, strict CSP, contextIsolation, ESLint rules\n\u2022 **Command Injection**: UDID validation, path validation, shell metacharacter blocking\n\n<strong>Identified Gaps</strong>\n\n<strong>1. No SQL Query Timeout</strong>\n**Risk**: Long-running queries could cause application hangs\n**Location**: <code>electron/services/db/core/dbConnection.ts</code>\n**Solution**: Add SQLite busy timeout pragma\n\n<code>database.pragma(\"busy_timeout = 5000\"); // 5-second timeout\n</code>\n\n<strong>2. No IPC Rate Limiting</strong>\n**Risk**: Potential DoS via rapid repeated IPC calls\n**Location**: IPC handlers in <code>electron/handlers/</code>\n**Solution**: Implement debouncing/throttling for expensive operations\n\n<code>// Example pattern\nconst throttledHandler = throttle(async (userId) => {\n  // expensive operation\n}, 1000);\n</code>\n\n<strong>3. Optional HTML Sanitization Library</strong>\n**Risk**: If user-generated HTML is ever rendered, XSS could occur\n**Current**: Not needed (React handles escaping), but good for defense-in-depth\n**Solution**: Add DOMPurify as optional dependency\n\n<code>npm install dompurify\nnpm install --save-dev @types/dompurify\n</code>\n\n<strong>4. Security Documentation</strong>\n**Risk**: Security assumptions not documented for future developers\n**Solution**: Add security section to architecture documentation\n\n<strong>Implementation Phases</strong>\n\n<strong>Phase 1: Query Timeout (~15 min)</strong>\n1. Add <code>busy_timeout</code> pragma to database initialization\n2. Test with concurrent operations\n3. Verify timeout behavior\n\n<strong>Phase 2: IPC Rate Limiting (~45 min)</strong>\n1. Identify expensive IPC handlers (file operations, database scans)\n2. Implement throttle/debounce utility\n3. Apply to identified handlers\n4. Add tests for rate limiting\n\n<strong>Phase 3: DOMPurify Integration (Optional) (~30 min)</strong>\n1. Install DOMPurify\n2. Create sanitization utility\n3. Document usage patterns\n4. Skip if no HTML rendering is planned\n\n<strong>Phase 4: Security Documentation (~20 min)</strong>\n1. Document current protections in <code>.claude/docs/shared/</code>\n2. Add security checklist for new features\n3. Document validation patterns\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>busy_timeout</code> pragma added to database initialization\n\u2610 At least 3 expensive IPC handlers have rate limiting\n\u2610 Security documentation created at <code>.claude/docs/shared/security-patterns.md</code>\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Turns | 6-8 | Multiple small changes |\n| Tokens | ~30K | |\n| Time | 1.5-2 hours | |\n\n<strong>Dependencies</strong>\n\n\u2022 TASK-611 (SQL field whitelist) should be completed first\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Rate limiting breaks legitimate use | Use generous thresholds, add bypass for batch operations |\n| Query timeout interrupts valid long operations | Set timeout high enough (5-10 seconds) |\n\n<strong>Notes</strong>\n\nThis is a proactive security improvement, not a response to a vulnerability. Current protections are strong; these additions provide defense-in-depth.\n\n**Files to modify:**\n\u2022 <code>electron/services/db/core/dbConnection.ts</code> - Query timeout\n\u2022 <code>electron/handlers/*.ts</code> - Rate limiting\n\u2022 <code>electron/utils/sanitization.ts</code> (new) - Optional DOMPurify wrapper\n\u2022 <code>.claude/docs/shared/security-patterns.md</code> (new) - Documentation"
  },
  {
    "id": "BACKLOG-103",
    "title": "Fix Contact Selection Issue",
    "category": "fix",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-010",
    "est_tokens": "~25K-40K",
    "actual_tokens": "-",
    "variance": "Addressed by TASK-700",
    "created_at": "2025-12-28",
    "completed_at": "",
    "file": "",
    "description": "<strong>Description</strong>\n\nThere is a bug when selecting contacts in the application. The specific issue needs investigation, but users are experiencing problems with the contact selection functionality.\n\n<strong>Investigation Required</strong>\n\nBefore implementation, the engineer must:\n1. Reproduce the bug by testing contact selection in various contexts\n2. Check <code>ContactSelectModal.tsx</code> for selection state issues\n3. Review contact selection in <code>AuditTransactionModal.tsx</code> and <code>EditTransactionModal.tsx</code>\n4. Identify if the issue is with single-select vs multi-select modes\n5. Document the exact reproduction steps\n\n<strong>Potential Areas</strong>\n\n\u2022 <code>src/components/ContactSelectModal.tsx</code> - Main contact selection modal\n\u2022 <code>src/components/AuditTransactionModal.tsx</code> - Transaction creation with contact assignment\n\u2022 <code>src/components/transaction/components/EditTransactionModal.tsx</code> - Transaction editing\n\u2022 Contact role assignment in transaction details\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Bug is documented with reproduction steps\n\u2610 Root cause identified\n\u2610 Fix implemented and tested\n\u2610 No regression in other contact-related functionality\n\n<strong>Estimated Effort</strong>\n\n\u2022 **Turns:** 4-8 (including investigation)\n\u2022 **Time:** ~45-90 min\n\u2022 **Adjustment:** N/A (ui category, 1.0x)\n\n---\n\n<strong>Notes</strong>\n\nThis is a bug fix item that requires investigation before implementation. The engineer should allocate time for bug reproduction and root cause analysis."
  },
  {
    "id": "BACKLOG-104",
    "title": "Dashboard UI to Emphasize Auto-Detection",
    "category": "ui",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-010",
    "est_tokens": "~35K-50K",
    "actual_tokens": "-",
    "variance": "Addressed by TASK-705",
    "created_at": "2025-12-28",
    "completed_at": "",
    "file": "",
    "description": "<strong>Description</strong>\n\nUpdate the Dashboard component to prominently showcase the AI auto-detection features built in SPRINT-006 and SPRINT-007. Currently the Dashboard focuses on manual actions (Start New Audit, Browse Transactions, Manage Contacts). It should highlight the AI-powered automatic transaction detection that runs in the background.\n\n<strong>Background</strong>\n\nSPRINT-006 and SPRINT-007 implemented:\n\u2022 AI-powered email analysis for transaction detection\n\u2022 Thread-based detection with 97% cost reduction\n\u2022 Automatic transaction suggestions with approve/reject workflow\n\u2022 LLM settings and feedback loop\n\nUsers should understand that the app is actively working to detect transactions for them.\n\n<strong>Proposed Changes</strong>\n\n1. **Add \"AI Detection Status\" section** to Dashboard\n   - Show count of pending auto-detected transactions awaiting review\n   - Display recent detection activity (e.g., \"5 new transactions detected today\")\n   - Link to pending review queue\n\n2. **Visual indicators**\n   - Badge on \"Browse Transactions\" showing pending review count\n   - Subtle animation or pulse indicating AI is active\n   - \"Last scan\" timestamp\n\n3. **Educational element**\n   - Brief explanation of how auto-detection works\n   - Value proposition messaging\n\n<strong>Files to Modify</strong>\n\n\u2022 <code>src/components/Dashboard.tsx</code> - Main dashboard layout\n\u2022 Potentially new components for status display\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Dashboard shows pending auto-detected transaction count\n\u2610 Users can navigate directly to pending review from Dashboard\n\u2610 AI activity status is clearly visible\n\u2610 Design is consistent with existing dashboard style\n\u2610 No performance impact from additional data fetching\n\n<strong>Estimated Effort</strong>\n\n\u2022 **Turns:** 6-10\n\u2022 **Tokens:** ~35K-50K\n\u2022 **Time:** ~1-2h\n\u2022 **Adjustment:** 1.0x (ui category)\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 Requires API to fetch pending auto-detected transaction count\n\u2022 May need IPC handler if not already available\n\n<strong>Notes</strong>\n\nThis is a UX enhancement to improve visibility of the AI features. Should not change core functionality, just surface existing capabilities more prominently."
  },
  {
    "id": "BACKLOG-105",
    "title": "Text Messages Tab in Transaction Details",
    "category": "ui",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-010",
    "est_tokens": "~80K-120K",
    "actual_tokens": "-",
    "variance": "Addressed by TASK-702/703/704",
    "created_at": "2025-12-28",
    "completed_at": "",
    "file": "",
    "description": "<strong>Description</strong>\n\nAdd a new \"Text Messages\" tab to the transaction details view. This tab will show text messages (SMS/iMessage) associated with the transaction, with the ability to:\n1. View text message threads linked to the transaction\n2. Remove non-relevant texts from the transaction\n3. Search for and attach text threads that weren't automatically attached\n\n<strong>Background</strong>\n\nThe current TransactionDetails component has two tabs:\n\u2022 Details: Shows transaction info and emails\n\u2022 Contacts: Shows assigned contacts and AI suggestions\n\nText messages are stored in the <code>messages</code> table with <code>channel IN ('sms', 'imessage')</code> but are not currently displayed in transaction details.\n\nRelated backlog items:\n\u2022 BACKLOG-011: Manually Add Missing Emails to Audit\n\u2022 BACKLOG-012: Manually Add Missing Texts to Audit\n\n<strong>Technical Scope</strong>\n\nThis feature involves multiple tasks:\n1. **Tab UI** - Add \"Messages\" tab to TransactionDetails\n2. **Message List Component** - Display text messages in conversation style\n3. **Unlink Functionality** - Remove messages from transaction\n4. **Attach Functionality** - Search and link new message threads\n\n<strong>Files to Create/Modify</strong>\n\n\u2022 <code>src/components/transactionDetailsModule/components/TransactionMessagesTab.tsx</code> (new)\n\u2022 <code>src/components/transactionDetailsModule/components/MessageThreadCard.tsx</code> (new)\n\u2022 <code>src/components/transactionDetailsModule/components/AttachMessagesModal.tsx</code> (new)\n\u2022 <code>src/components/TransactionDetails.tsx</code> (update tabs)\n\u2022 <code>src/components/transactionDetailsModule/types.ts</code> (extend types)\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Text Messages tab appears in transaction details\n\u2610 Text messages linked to transaction are displayed\n\u2610 Messages grouped by conversation thread\n\u2610 Can unlink irrelevant messages from transaction\n\u2610 Can search for and attach unlinked message threads\n\u2610 Empty state when no messages linked\n\u2610 Consistent styling with existing tabs\n\n<strong>Estimated Effort</strong>\n\n\u2022 **Turns:** 15-25 (multiple sub-tasks)\n\u2022 **Tokens:** ~80K-120K\n\u2022 **Time:** ~3-5h\n\u2022 **Adjustment:** 1.0x (ui category)\n\n---\n\n<strong>Sub-Tasks (Recommended Split)</strong>\n\n1. TASK-702: Add Messages tab infrastructure (Tab UI, empty state)\n2. TASK-703: Message thread display component\n3. TASK-704: Attach/unlink messages modal\n\n<strong>Notes</strong>\n\nConsider splitting this into 2-3 smaller tasks for parallel or sequential execution. The tab infrastructure can be done first, then the display component, then the attach/unlink functionality."
  },
  {
    "id": "BACKLOG-106",
    "title": "Add Behavioral Tests for useAppStateMachine",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-106.md](items/BACKLOG-106.md)",
    "description": "<strong>Priority: Medium</strong>\n\n<strong>Category: test</strong>\n\n<strong>Summary</strong>\n\nTASK-614 added 41 comprehensive tests for useAppStateMachine, but these are API contract tests (verify inputs/outputs). Behavioral tests for state transitions (e.g., \"when user completes onboarding, machine transitions to READY\") should be added.\n\n<strong>Origin</strong>\n\nSPRINT-009 Retrospective - TASK-614 completed API tests but behavioral coverage gap identified.\n\n<strong>Current State</strong>\n\nAfter TASK-614:\n\u2022 41 tests for useAppStateMachine\n\u2022 Tests verify API contracts (method calls, return values)\n\u2022 Tests do NOT verify state transition sequences\n\n<strong>Problem</strong>\n\nAPI contract tests verify:\n<code>// \"Calling initialize() returns expected shape\"\nexpect(result.current.initialize).toBeDefined();\n</code>\n\nBehavioral tests would verify:\n<code>// \"Complete onboarding flow transitions state correctly\"\nact(() => result.current.startOnboarding());\nexpect(result.current.state).toBe('ONBOARDING');\nact(() => result.current.completeOnboarding());\nexpect(result.current.state).toBe('READY');\n</code>\n\n<strong>Test Cases to Add</strong>\n\n<strong>State Transition Sequences</strong>\n\n1. **Fresh User Flow**\n   - INITIAL -> LOADING -> ONBOARDING -> READY\n\n2. **Returning User Flow**\n   - INITIAL -> LOADING -> READY (skip onboarding)\n\n3. **Error Recovery Flow**\n   - Any state -> ERROR -> (retry) -> Previous state\n\n4. **Logout Flow**\n   - READY -> LOGGED_OUT -> LOADING -> READY\n\n5. **Settings Navigation**\n   - READY <-> SETTINGS (bidirectional)\n\n<strong>Edge Cases</strong>\n\n6. **Invalid Transitions**\n   - Verify machine rejects invalid state transitions\n   - e.g., ONBOARDING -> SETTINGS should fail\n\n7. **Concurrent Actions**\n   - Multiple rapid state change requests\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 At least 5 new behavioral test cases added\n\u2610 Tests verify actual state values, not just method existence\n\u2610 Tests verify transition sequences (A -> B -> C)\n\u2610 Invalid transitions tested and rejected\n\u2610 All tests pass (<code>npm test</code>)\n\u2610 No flaky tests (run 3x)\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Turns | 6-8 | Test tasks have 0% variance historically |\n| Tokens | ~30K | |\n| Time | ~45-60 min | |\n\n<strong>Dependencies</strong>\n\n\u2022 TASK-614 (useAppStateMachine tests) - Complete\n\n<strong>Files to Modify</strong>\n\n\u2022 <code>src/hooks/__tests__/useAppStateMachine.test.ts</code>\n\n<strong>Technical Notes</strong>\n\n\u2022 Use React Testing Library's <code>renderHook</code> and <code>act</code>\n\u2022 May need to mock database and auth services for transition triggers\n\u2022 Consider XState testing utilities if machine is XState-based\n\n<strong>Notes</strong>\n\nThis improves test coverage quality, not just quantity. Behavioral tests catch regressions in state machine logic that API tests would miss."
  },
  {
    "id": "BACKLOG-107",
    "title": "Split useAppStateMachine.ts into Flow Hooks",
    "category": "refactor",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-013",
    "est_tokens": "~100K",
    "actual_tokens": "~36K",
    "variance": "-55%",
    "created_at": "2025-12-28",
    "completed_at": "2026-01-01",
    "file": "[BACKLOG-107.md](BACKLOG-107.md)",
    "description": "<strong>Priority: Critical</strong>\n\n<strong>Category: refactor</strong>\n\n<strong>Summary</strong>\n\nSplit the monolithic <code>useAppStateMachine.ts</code> (1,117 lines, 3.7x over target of 300) into dedicated flow-specific hooks following the existing TODO plan in the file.\n\n<strong>Problem</strong>\n\n<code>useAppStateMachine.ts</code> at 1,117 lines is 3.7x over the 300-line target and violates the architecture guardrails in <code>.claude/docs/shared/architecture-guardrails.md</code>. The file contains multiple distinct state flows that should be separated:\n\n\u2022 Authentication flow\n\u2022 Secure storage flow\n\u2022 Phone onboarding flow\n\u2022 Email onboarding flow\n\u2022 Permissions flow\n\n<strong>Solution</strong>\n\nExtract each flow into its own dedicated hook as outlined in the existing TODO comments within the file:\n\n<strong>Target Structure</strong>\n\n<code>src/hooks/\n+-- useAppStateMachine.ts      # Main orchestrator (target: <300 lines)\n+-- flows/\n    +-- index.ts               # Barrel export\n    +-- useAuthFlow.ts         # Authentication state\n    +-- useSecureStorageFlow.ts # Secure storage state\n    +-- usePhoneOnboardingFlow.ts # Phone onboarding state\n    +-- useEmailOnboardingFlow.ts # Email onboarding state\n    +-- usePermissionsFlow.ts  # Permissions state\n    +-- types.ts               # Shared flow types\n</code>\n\n<strong>Implementation Phases</strong>\n\n<strong>Phase 1: Analysis (~1 hour)</strong>\n1. Read the existing TODO plan in the file\n2. Map out state transitions for each flow\n3. Identify shared state/context dependencies\n4. Document extraction plan\n\n<strong>Phase 2: Extract useAuthFlow (~2 hours)</strong>\n1. Extract authentication-related state and transitions\n2. Create proper TypeScript interfaces\n3. Update main hook to use extracted flow\n4. Add tests\n\n<strong>Phase 3: Extract useSecureStorageFlow (~1.5 hours)</strong>\n1. Extract secure storage state and transitions\n2. Update main hook to use extracted flow\n3. Add tests\n\n<strong>Phase 4: Extract usePhoneOnboardingFlow (~2 hours)</strong>\n1. Extract phone onboarding state and transitions\n2. Handle complex device detection logic\n3. Update main hook to use extracted flow\n4. Add tests\n\n<strong>Phase 5: Extract useEmailOnboardingFlow (~2 hours)</strong>\n1. Extract email onboarding state and transitions\n2. Handle OAuth flow integration\n3. Update main hook to use extracted flow\n4. Add tests\n\n<strong>Phase 6: Extract usePermissionsFlow (~1.5 hours)</strong>\n1. Extract permissions state and transitions\n2. Update main hook to use extracted flow\n3. Add tests\n\n<strong>Phase 7: Final Cleanup (~1 hour)</strong>\n1. Create barrel exports\n2. Update all imports\n3. Verify all tests pass\n4. Document the new structure\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>useAppStateMachine.ts</code> reduced to <300 lines\n\u2610 At least 5 flow hooks extracted\n\u2610 All state transitions preserved (no behavior changes)\n\u2610 Test coverage maintained or improved\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\u2610 No regressions in onboarding or auth flows\n\n<strong>Estimated Effort</strong>\n\n| Metric | Raw Estimate | Notes |\n|--------|--------------|-------|\n| Turns | 60-80 | Large refactor, many files |\n| Tokens | ~200K | |\n| Time | 2-3 days | |\n\n**Calibrated (0.5x refactor multiplier):**\n| Metric | Calibrated Estimate |\n|--------|---------------------|\n| Turns | 30-40 |\n| Tokens | ~100K |\n| Time | 1-1.5 days |\n\n<strong>Dependencies</strong>\n\n\u2022 TASK-614 (useAppStateMachine tests) should be completed first\n\u2022 No blocking dependencies on other BACKLOG items\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Complex state interdependencies | Careful analysis of existing TODO plan |\n| Breaking onboarding flow | Extensive testing at each phase |\n| Hidden side effects | Integration tests for full flows |\n\n<strong>Notes</strong>\n\n**This item is SR Engineer sourced from architecture review.**\n\nThe file already contains a TODO plan for this extraction. The TODO comments should be followed as the primary guide, with adjustments as needed during implementation.\n\nThis is a multi-day effort that should be broken into multiple TASKs during sprint planning:\n\u2022 TASK-A: Analysis + useAuthFlow extraction\n\u2022 TASK-B: useSecureStorageFlow + usePhoneOnboardingFlow extraction\n\u2022 TASK-C: useEmailOnboardingFlow + usePermissionsFlow extraction\n\u2022 TASK-D: Final cleanup and testing"
  },
  {
    "id": "BACKLOG-108",
    "title": "Fix Flaky appleDriverService Test",
    "category": "test",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-011",
    "est_tokens": "~10K",
    "actual_tokens": "~19K",
    "variance": "-67%",
    "created_at": "2025-12-28",
    "completed_at": "2026-01-01",
    "file": "[BACKLOG-108.md](BACKLOG-108.md)",
    "description": "<strong>Priority: Critical</strong>\n\n<strong>Category: test</strong>\n\n<strong>Summary</strong>\n\nFix the flaky test in <code>appleDriverService</code> that times out at the 5000ms default timeout due to async installation checks taking longer than expected.\n\n<strong>Problem</strong>\n\nThe <code>appleDriverService</code> test suite has a flaky test that intermittently times out. The default Jest timeout of 5000ms is insufficient for the async driver installation verification checks, which can take longer on some systems or under load.\n\n**Symptoms:**\n\u2022 Test passes most of the time but occasionally times out\n\u2022 More frequent failures on slower CI runners or under load\n\u2022 Error message: <code>Async callback was not invoked within the 5000 ms timeout</code>\n\n<strong>Solution</strong>\n\nIncrease the timeout for the specific tests that perform async installation checks.\n\n<strong>Option 1: Test-Level Timeout (Recommended)</strong>\n\n<code>it('should verify driver installation', async () => {\n  // test implementation\n}, 15000); // 15-second timeout for this specific test\n</code>\n\n<strong>Option 2: Describe Block Timeout</strong>\n\n<code>describe('appleDriverService', () => {\n  jest.setTimeout(15000); // All tests in this describe block\n\n  // tests...\n});\n</code>\n\n<strong>Option 3: Mock Slow Operations</strong>\n\nIf the async check is testing external system calls, consider mocking them for faster, more reliable tests:\n\n<code>jest.mock('../path/to/driver-check', () => ({\n  checkDriverInstallation: jest.fn().mockResolvedValue(true)\n}));\n</code>\n\n<strong>Implementation Steps</strong>\n\n1. Locate the flaky test in <code>appleDriverService.test.ts</code>\n2. Identify which specific test(s) are timing out\n3. Apply appropriate timeout increase\n4. Verify fix by running the test multiple times\n5. Consider adding a note about why the extended timeout is needed\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Flaky test no longer times out\n\u2610 Test passes reliably (10+ consecutive runs)\n\u2610 No unnecessary timeouts added to other tests\n\u2610 Comment added explaining the extended timeout if applicable\n\u2610 <code>npm test</code> passes consistently\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Turns | 2-4 | Simple fix once located |\n| Tokens | ~10K | |\n| Time | 1-2 hours | Includes verification |\n\n<strong>Dependencies</strong>\n\n\u2022 None\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Hiding actual performance issues | Document expected timing |\n| Increasing overall test suite time | Only increase timeout where needed |\n\n<strong>Notes</strong>\n\n**This item is SR Engineer sourced from test reliability audit.**\n\nThis is a quick win that should be prioritized to improve CI reliability. The fix is straightforward but important for maintaining developer trust in the test suite.\n\n**Files to investigate:**\n\u2022 <code>electron/services/__tests__/appleDriverService.test.ts</code>\n\u2022 Or wherever <code>appleDriverService</code> tests are located"
  },
  {
    "id": "BACKLOG-109",
    "title": "Reduce AppRouter.tsx to <300 Lines",
    "category": "refactor",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-013",
    "est_tokens": "~20K",
    "actual_tokens": "~12K",
    "variance": "-83%",
    "created_at": "2025-12-28",
    "completed_at": "2026-01-01",
    "file": "[BACKLOG-109.md](BACKLOG-109.md)",
    "description": "<strong>Priority: High</strong>\n\n<strong>Category: refactor</strong>\n\n<strong>Summary</strong>\n\nReduce <code>AppRouter.tsx</code> from 359 lines to under 300 lines by extracting loading state JSX and removing the dead <code>USE_NEW_ONBOARDING</code> feature flag.\n\n<strong>Problem</strong>\n\n<code>AppRouter.tsx</code> at 359 lines exceeds the 300-line trigger threshold defined in <code>.claude/docs/shared/architecture-guardrails.md</code>. This makes the router harder to maintain and understand.\n\n**Specific issues:**\n1. Loading state JSX is inline and could be extracted\n2. <code>USE_NEW_ONBOARDING</code> feature flag is always <code>true</code> (dead code)\n3. Route definitions mixed with presentation logic\n\n<strong>Solution</strong>\n\n<strong>1. Remove USE_NEW_ONBOARDING Feature Flag</strong>\n\nThe <code>USE_NEW_ONBOARDING</code> flag is always <code>true</code>, meaning the \"old\" onboarding path is dead code:\n\n<code>// Before\nconst USE_NEW_ONBOARDING = true;\n\nif (USE_NEW_ONBOARDING) {\n  return <NewOnboarding />;\n} else {\n  return <OldOnboarding />; // Never reached - DELETE\n}\n\n// After\nreturn <NewOnboarding />;\n</code>\n\n<strong>2. Extract Loading State Component</strong>\n\n<code>// Before (inline in AppRouter)\nif (isLoading) {\n  return (\n    <div className=\"loading-container\">\n      <Spinner />\n      <p>Loading...</p>\n    </div>\n  );\n}\n\n// After\n// src/components/common/AppLoadingState.tsx\nexport const AppLoadingState: React.FC<{ message?: string }> = ({ message }) => (\n  <div className=\"loading-container\">\n    <Spinner />\n    <p>{message || 'Loading...'}</p>\n  </div>\n);\n\n// In AppRouter\nif (isLoading) {\n  return <AppLoadingState />;\n}\n</code>\n\n<strong>3. Consider Route Definition Extraction (Optional)</strong>\n\nIf still over 300 lines after the above, extract route definitions:\n\n<code>// src/routes/index.ts\nexport const routes = [\n  { path: '/', element: <Home /> },\n  { path: '/settings', element: <Settings /> },\n  // ...\n];\n</code>\n\n<strong>Implementation Steps</strong>\n\n1. Identify and remove <code>USE_NEW_ONBOARDING</code> flag and dead code paths\n2. Extract loading state JSX to a reusable component\n3. Update imports in AppRouter.tsx\n4. Verify all routes still work\n5. Run tests\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>AppRouter.tsx</code> reduced to <300 lines\n\u2610 <code>USE_NEW_ONBOARDING</code> flag removed\n\u2610 All dead code paths removed\n\u2610 Loading state extracted to reusable component\n\u2610 All routing behavior preserved\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\n<strong>Estimated Effort</strong>\n\n| Metric | Raw Estimate | Notes |\n|--------|--------------|-------|\n| Turns | 8-12 | Moderate refactor |\n| Tokens | ~40K | |\n| Time | 1-1.5 hours | |\n\n**Calibrated (0.5x refactor multiplier):**\n| Metric | Calibrated Estimate |\n|--------|---------------------|\n| Turns | 4-6 |\n| Tokens | ~20K |\n| Time | 30-45 minutes |\n\n<strong>Dependencies</strong>\n\n\u2022 None\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Breaking routing | Test all routes after changes |\n| Missing dead code references | Search for USE_NEW_ONBOARDING references |\n\n<strong>Notes</strong>\n\n**This item is SR Engineer sourced from architecture review.**\n\nThis is a straightforward cleanup task that should yield quick wins. The feature flag removal is the easiest part and should be done first to understand the scope.\n\n**Files to modify:**\n\u2022 <code>src/AppRouter.tsx</code> - Main changes\n\u2022 <code>src/components/common/AppLoadingState.tsx</code> (new) - Extracted component"
  },
  {
    "id": "BACKLOG-110",
    "title": "Reduce AppShell.tsx to <150 Lines",
    "category": "refactor",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-013",
    "est_tokens": "~15K",
    "actual_tokens": "~8K",
    "variance": "-43%",
    "created_at": "2025-12-28",
    "completed_at": "2026-01-01",
    "file": "[BACKLOG-110.md](BACKLOG-110.md)",
    "description": "<strong>Priority: High</strong>\n\n<strong>Category: refactor</strong>\n\n<strong>Summary</strong>\n\nReduce <code>AppShell.tsx</code> from 190 lines to under 150 lines by extracting the version popup and offline banner components.\n\n<strong>Problem</strong>\n\n<code>AppShell.tsx</code> at 190 lines exceeds the 150-line target defined in <code>.claude/docs/shared/architecture-guardrails.md</code>. The file contains inline JSX for UI elements that should be separate components.\n\n**Specific issues:**\n1. Version popup logic and JSX inline\n2. Offline banner logic and JSX inline\n3. Main layout wrapper mixed with feature components\n\n<strong>Solution</strong>\n\n<strong>1. Extract Version Popup Component</strong>\n\n<code>// src/components/shell/VersionPopup.tsx\ninterface VersionPopupProps {\n  version: string;\n  onClose: () => void;\n  isOpen: boolean;\n}\n\nexport const VersionPopup: React.FC<VersionPopupProps> = ({\n  version,\n  onClose,\n  isOpen\n}) => {\n  if (!isOpen) return null;\n\n  return (\n    <div className=\"version-popup\">\n      <div className=\"version-popup-content\">\n        <h3>Version {version}</h3>\n        {/* version details */}\n        <button onClick={onClose}>Close</button>\n      </div>\n    </div>\n  );\n};\n</code>\n\n<strong>2. Extract Offline Banner Component</strong>\n\n<code>// src/components/shell/OfflineBanner.tsx\ninterface OfflineBannerProps {\n  isOffline: boolean;\n}\n\nexport const OfflineBanner: React.FC<OfflineBannerProps> = ({ isOffline }) => {\n  if (!isOffline) return null;\n\n  return (\n    <div className=\"offline-banner\">\n      <span>You are currently offline</span>\n    </div>\n  );\n};\n</code>\n\n<strong>3. Update AppShell.tsx</strong>\n\n<code>// After extraction\nimport { VersionPopup } from './shell/VersionPopup';\nimport { OfflineBanner } from './shell/OfflineBanner';\n\nexport const AppShell: React.FC = ({ children }) => {\n  const { isOffline } = useNetworkStatus();\n  const { showVersion, version, closeVersionPopup } = useVersionPopup();\n\n  return (\n    <div className=\"app-shell\">\n      <OfflineBanner isOffline={isOffline} />\n      <Header />\n      <main>{children}</main>\n      <VersionPopup\n        isOpen={showVersion}\n        version={version}\n        onClose={closeVersionPopup}\n      />\n    </div>\n  );\n};\n</code>\n\n<strong>Implementation Steps</strong>\n\n1. Create <code>src/components/shell/</code> directory\n2. Extract <code>VersionPopup.tsx</code> with its props interface\n3. Extract <code>OfflineBanner.tsx</code> with its props interface\n4. Update <code>AppShell.tsx</code> to import and use extracted components\n5. Create barrel export for shell components\n6. Run tests\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>AppShell.tsx</code> reduced to <150 lines\n\u2610 <code>VersionPopup</code> component extracted with proper types\n\u2610 <code>OfflineBanner</code> component extracted with proper types\n\u2610 All functionality preserved\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\n<strong>Estimated Effort</strong>\n\n| Metric | Raw Estimate | Notes |\n|--------|--------------|-------|\n| Turns | 6-8 | Clean extraction |\n| Tokens | ~30K | |\n| Time | 45-60 minutes | |\n\n**Calibrated (0.5x refactor multiplier):**\n| Metric | Calibrated Estimate |\n|--------|---------------------|\n| Turns | 3-4 |\n| Tokens | ~15K |\n| Time | 20-30 minutes |\n\n<strong>Dependencies</strong>\n\n\u2022 None\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Breaking shell functionality | Test app shell behavior after changes |\n| Missing context dependencies | Ensure hooks are properly passed |\n\n<strong>Notes</strong>\n\n**This item is SR Engineer sourced from architecture review.**\n\nThis is a straightforward extraction task. The components are likely self-contained, making this a clean refactor.\n\n**Files to modify:**\n\u2022 <code>src/AppShell.tsx</code> - Main changes\n\u2022 <code>src/components/shell/VersionPopup.tsx</code> (new)\n\u2022 <code>src/components/shell/OfflineBanner.tsx</code> (new)\n\u2022 <code>src/components/shell/index.ts</code> (new) - Barrel export"
  },
  {
    "id": "BACKLOG-111",
    "title": "Migrate Components to Service Abstractions",
    "category": "refactor",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~150K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-111.md](BACKLOG-111.md)",
    "created_at": "2025-12-28",
    "completed_at": "",
    "file": "",
    "description": "<strong>Priority: High</strong>\n\n<strong>Category: refactor</strong>\n\n<strong>Summary</strong>\n\nMigrate 423 direct <code>window.api</code> calls across 43 component files to use the service layer abstractions in <code>src/services/</code>.\n\n<strong>Problem</strong>\n\nComponents are directly calling <code>window.api</code> and <code>window.electron</code> instead of using the service abstractions created in TASK-604. This violates the architecture principle of having clear service boundaries and makes the codebase harder to test and maintain.\n\n**Scope:**\n\u2022 423 direct <code>window.api</code> calls\n\u2022 43 component files affected\n\u2022 Key offenders:\n  - <code>Login.tsx</code>: 17 calls\n  - <code>EmailOnboardingScreen.tsx</code>: 15 calls\n  - <code>Settings.tsx</code>: 10 calls\n\n<strong>Solution</strong>\n\nMigrate components to use <code>src/services/</code> abstractions instead of direct IPC calls.\n\n<strong>Before (Direct Call)</strong>\n\n<code>// In component\nconst handleLogin = async () => {\n  const result = await window.api.auth.login(credentials);\n  if (result.success) {\n    // handle success\n  }\n};\n</code>\n\n<strong>After (Service Abstraction)</strong>\n\n<code>// In component\nimport { authService } from '@/services/authService';\n\nconst handleLogin = async () => {\n  const result = await authService.login(credentials);\n  if (result.success) {\n    // handle success\n  }\n};\n</code>\n\n<strong>Migration Strategy</strong>\n\n1. **Phase 1: High-Priority Files** (Login, EmailOnboarding, Settings)\n   - These have the most calls and highest impact\n\n2. **Phase 2: Medium-Priority Files**\n   - Files with 5-10 direct calls\n\n3. **Phase 3: Low-Priority Files**\n   - Files with <5 direct calls\n\n<strong>Service Layer Verification</strong>\n\nBefore migration, verify that <code>src/services/</code> has abstractions for all needed operations. If not, create them following the patterns established in TASK-604.\n\n<strong>Implementation Phases</strong>\n\n<strong>Phase 1: Audit & Planning (~2 hours)</strong>\n1. Run grep to catalog all <code>window.api</code> and <code>window.electron</code> calls\n2. Map each call to existing service abstraction\n3. Identify missing service methods\n4. Create migration plan by file\n\n<strong>Phase 2: Service Layer Completion (~4 hours)</strong>\n1. Add any missing service methods\n2. Ensure consistent error handling\n3. Add TypeScript types\n\n<strong>Phase 3: High-Priority Migration (~6 hours)</strong>\n1. Migrate <code>Login.tsx</code> (17 calls)\n2. Migrate <code>EmailOnboardingScreen.tsx</code> (15 calls)\n3. Migrate <code>Settings.tsx</code> (10 calls)\n4. Update tests\n\n<strong>Phase 4: Medium-Priority Migration (~6 hours)</strong>\n1. Migrate files with 5-10 calls\n2. Update tests\n\n<strong>Phase 5: Low-Priority Migration (~4 hours)</strong>\n1. Migrate remaining files\n2. Update tests\n3. Add ESLint rule to prevent new direct calls\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 All <code>window.api</code> calls migrated to service abstractions\n\u2610 All <code>window.electron</code> calls migrated to service abstractions\n\u2610 No direct IPC calls in components\n\u2610 ESLint rule added to prevent regression\n\u2610 All functionality preserved\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\n<strong>Estimated Effort</strong>\n\n| Metric | Raw Estimate | Notes |\n|--------|--------------|-------|\n| Turns | 80-100 | Large migration, many files |\n| Tokens | ~300K | |\n| Time | 2-3 days | |\n\n**Calibrated (0.5x refactor multiplier):**\n| Metric | Calibrated Estimate |\n|--------|---------------------|\n| Turns | 40-50 |\n| Tokens | ~150K |\n| Time | 1-1.5 days |\n\n<strong>Dependencies</strong>\n\n\u2022 TASK-604 (Service layer creation) - Already complete\n\u2022 Should be done after BACKLOG-107 (useAppStateMachine split) to avoid conflicts\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Breaking existing functionality | Test each migrated component |\n| Missing service abstractions | Complete service layer first |\n| Merge conflicts with parallel work | Schedule as dedicated sprint |\n\n<strong>Notes</strong>\n\n**This item is SR Engineer sourced from architecture review.**\n\nThis is a significant undertaking that will substantially improve code quality and testability. Consider breaking into multiple TASKs by component group:\n\n\u2022 TASK-A: Service layer completion + ESLint rule\n\u2022 TASK-B: Login.tsx migration\n\u2022 TASK-C: EmailOnboardingScreen.tsx migration\n\u2022 TASK-D: Settings.tsx migration\n\u2022 TASK-E: Remaining files migration\n\n**Files to modify:**\n\u2022 43 component files with direct IPC calls\n\u2022 <code>src/services/*.ts</code> - Potential additions\n\u2022 <code>.eslintrc.js</code> - New rule for <code>window.api</code> prevention"
  },
  {
    "id": "BACKLOG-112",
    "title": "Boost Test Coverage for src/hooks/",
    "category": "test",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~150K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-112.md](BACKLOG-112.md)",
    "created_at": "2025-12-28",
    "completed_at": "",
    "file": "",
    "description": "<strong>Priority: Medium</strong>\n\n<strong>Category: test</strong>\n\n<strong>Summary</strong>\n\nIncrease test coverage for <code>src/hooks/</code> from 13.83% to target of 80%.\n\n<strong>Problem</strong>\n\nThe hooks directory has critically low test coverage at 13.83%. Hooks contain critical business logic and state management that need comprehensive testing to prevent regressions.\n\n**Current State:**\n\u2022 Coverage: 13.83%\n\u2022 Target: 80%\n\u2022 Gap: 66.17 percentage points\n\n<strong>Solution</strong>\n\nSystematically add tests for all hooks in <code>src/hooks/</code>.\n\n<strong>Priority Order</strong>\n\n1. **High-Impact Hooks** (used by many components)\n   - <code>useAppStateMachine.ts</code> - Core app state (tests added in TASK-614, verify coverage)\n   - <code>useAuth.ts</code> - Authentication state\n   - <code>useDatabase.ts</code> - Database operations\n\n2. **Business Logic Hooks**\n   - Any hooks with complex logic or calculations\n   - Hooks with side effects\n\n3. **UI State Hooks**\n   - Form state hooks\n   - Modal state hooks\n   - Filter/sort hooks\n\n<strong>Testing Patterns</strong>\n\n<code>import { renderHook, act } from '@testing-library/react';\nimport { useExample } from './useExample';\n\ndescribe('useExample', () => {\n  it('should initialize with default state', () => {\n    const { result } = renderHook(() => useExample());\n    expect(result.current.value).toBe(defaultValue);\n  });\n\n  it('should update state on action', () => {\n    const { result } = renderHook(() => useExample());\n    act(() => {\n      result.current.updateValue('new value');\n    });\n    expect(result.current.value).toBe('new value');\n  });\n});\n</code>\n\n<strong>Implementation Steps</strong>\n\n1. List all hooks in <code>src/hooks/</code>\n2. Check existing coverage for each\n3. Create test files for untested hooks\n4. Add tests systematically\n5. Track coverage improvement\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>src/hooks/</code> coverage >= 80%\n\u2610 All exported hook functions have at least one test\n\u2610 Edge cases tested for complex hooks\n\u2610 Mock external dependencies appropriately\n\u2610 <code>npm test</code> passes\n\u2610 <code>npm run type-check</code> passes\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Turns | 40-60 | Many hooks to test |\n| Tokens | ~150K | |\n| Time | 1-2 days | |\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-107 (useAppStateMachine split) may affect this work\n\u2022 Consider doing after BACKLOG-107 to avoid testing code that will be refactored\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Hooks have complex dependencies | Use proper mocking |\n| BACKLOG-107 changes hook structure | Sequence appropriately |\n\n<strong>Notes</strong>\n\n**This item is SR Engineer sourced from coverage audit.**\n\nConsider combining this with BACKLOG-107 (useAppStateMachine split) - test coverage can be added as part of the extraction process.\n\n**Files to test:**\n\u2022 <code>src/hooks/*.ts</code>\n\u2022 <code>src/hooks/**/*.ts</code> (if nested structure)"
  },
  {
    "id": "BACKLOG-113",
    "title": "Boost Test Coverage for src/utils/",
    "category": "test",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~80K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-113.md](BACKLOG-113.md)",
    "created_at": "2025-12-28",
    "completed_at": "",
    "file": "",
    "description": "<strong>Priority: Medium</strong>\n\n<strong>Category: test</strong>\n\n<strong>Summary</strong>\n\nIncrease test coverage for <code>src/utils/</code> from 46.96% to target of 80%.\n\n<strong>Problem</strong>\n\nThe utils directory has moderate test coverage at 46.96%. Utility functions are often pure functions that should be easy to test and are frequently reused across the codebase.\n\n**Current State:**\n\u2022 Coverage: 46.96%\n\u2022 Target: 80%\n\u2022 Gap: 33.04 percentage points\n\n<strong>Solution</strong>\n\nAdd comprehensive tests for all utility functions in <code>src/utils/</code>.\n\n<strong>Testing Strategy</strong>\n\n1. **Identify uncovered utilities**\n   - Run coverage report with <code>--coverage</code> flag\n   - List all utilities with <80% coverage\n\n2. **Prioritize by usage**\n   - Test heavily-used utilities first\n   - Focus on utilities with complex logic\n\n3. **Test patterns for utilities**\n   - Input/output validation\n   - Edge cases (null, undefined, empty)\n   - Error conditions\n   - Boundary values\n\n<strong>Example Test Pattern</strong>\n\n<code>import { formatCurrency, parseCurrency } from './currencyUtils';\n\ndescribe('currencyUtils', () => {\n  describe('formatCurrency', () => {\n    it('should format positive amounts', () => {\n      expect(formatCurrency(1234.56)).toBe('$1,234.56');\n    });\n\n    it('should handle zero', () => {\n      expect(formatCurrency(0)).toBe('$0.00');\n    });\n\n    it('should handle negative amounts', () => {\n      expect(formatCurrency(-100)).toBe('-$100.00');\n    });\n\n    it('should handle undefined', () => {\n      expect(formatCurrency(undefined)).toBe('$0.00');\n    });\n  });\n});\n</code>\n\n<strong>Implementation Steps</strong>\n\n1. Run coverage report: <code>npm test -- --coverage</code>\n2. Identify utils below 80% coverage\n3. Create/update test files\n4. Add comprehensive tests\n5. Verify coverage improvement\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>src/utils/</code> coverage >= 80%\n\u2610 All exported functions have tests\n\u2610 Edge cases covered (null, undefined, empty, boundary)\n\u2610 Error handling tested\n\u2610 <code>npm test</code> passes\n\u2610 <code>npm run type-check</code> passes\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Turns | 20-30 | Utils are typically easy to test |\n| Tokens | ~80K | |\n| Time | 1 day | |\n\n<strong>Dependencies</strong>\n\n\u2022 None\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Complex utilities with external dependencies | Mock appropriately |\n| Time-dependent utilities | Use fake timers |\n\n<strong>Notes</strong>\n\n**This item is SR Engineer sourced from coverage audit.**\n\nUtility functions are often pure and straightforward to test. This should be a relatively quick win for coverage improvement.\n\n**Files to test:**\n\u2022 <code>src/utils/*.ts</code>\n\u2022 <code>src/utils/**/*.ts</code> (if nested structure)"
  },
  {
    "id": "BACKLOG-114",
    "title": "Boost Test Coverage for electron/utils/",
    "category": "test",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~80K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-114.md](BACKLOG-114.md)",
    "created_at": "2025-12-28",
    "completed_at": "",
    "file": "",
    "description": "<strong>Priority: Medium</strong>\n\n<strong>Category: test</strong>\n\n<strong>Summary</strong>\n\nIncrease test coverage for <code>electron/utils/</code> from 13.59% to target of 55%.\n\n<strong>Problem</strong>\n\nThe electron utils directory has very low test coverage at 13.59%. These utilities handle critical Electron-specific functionality that needs testing.\n\n**Current State:**\n\u2022 Coverage: 13.59%\n\u2022 Target: 55% (lower than renderer due to Electron complexity)\n\u2022 Gap: 41.41 percentage points\n\n<strong>Solution</strong>\n\nAdd targeted tests for electron utility functions.\n\n<strong>Special Considerations for Electron Utils</strong>\n\n1. **Mock Electron APIs**\n   - Use jest.mock for Electron modules\n   - Create test doubles for BrowserWindow, ipcMain, etc.\n\n2. **Platform-Specific Logic**\n   - Test cross-platform utilities on current platform\n   - Mock platform-specific behavior where needed\n\n3. **File System Operations**\n   - Use temp directories or mock fs\n   - Clean up after tests\n\n<strong>Example Test Pattern</strong>\n\n<code>jest.mock('electron', () => ({\n  app: {\n    getPath: jest.fn((name) => <code>/mock/${name}</code>),\n    isPackaged: false,\n  },\n  BrowserWindow: jest.fn(),\n}));\n\nimport { getAppDataPath } from './pathUtils';\n\ndescribe('pathUtils', () => {\n  describe('getAppDataPath', () => {\n    it('should return correct path in development', () => {\n      const path = getAppDataPath();\n      expect(path).toContain('/mock/userData');\n    });\n  });\n});\n</code>\n\n<strong>Implementation Steps</strong>\n\n1. Run coverage report for electron utils\n2. Identify critical utilities to test\n3. Set up Electron mocking infrastructure\n4. Add tests for each utility\n5. Verify coverage improvement\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>electron/utils/</code> coverage >= 55%\n\u2610 Critical utilities fully tested\n\u2610 Electron APIs properly mocked\n\u2610 Platform-specific logic tested\n\u2610 <code>npm test</code> passes\n\u2610 <code>npm run type-check</code> passes\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Turns | 20-30 | Electron mocking adds complexity |\n| Tokens | ~80K | |\n| Time | 1 day | |\n\n<strong>Dependencies</strong>\n\n\u2022 None\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Complex Electron mocking | Use established patterns from existing tests |\n| Platform-specific failures | Test on CI across platforms |\n\n<strong>Notes</strong>\n\n**This item is SR Engineer sourced from coverage audit.**\n\nThe target is 55% (lower than 80% for renderer) because Electron utilities often involve:\n\u2022 Native module interactions\n\u2022 File system operations\n\u2022 Platform-specific behavior\n\u2022 Process/IPC complexity\n\nFocus on utilities with pure logic first, then tackle those requiring complex mocking.\n\n**Files to test:**\n\u2022 <code>electron/utils/*.ts</code>"
  },
  {
    "id": "BACKLOG-115",
    "title": "Address Remaining any Types in Electron Handlers",
    "category": "refactor",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~150K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-115.md](BACKLOG-115.md)",
    "created_at": "2025-12-28",
    "completed_at": "",
    "file": "",
    "description": "<strong>Priority: Medium</strong>\n\n<strong>Category: refactor</strong>\n\n<strong>Summary</strong>\n\nReplace 60+ <code>any</code> types in electron handlers with proper TypeScript types. Currently generating 100+ ESLint warnings for <code>@typescript-eslint/no-explicit-any</code>.\n\n<strong>Problem</strong>\n\nThe electron handlers directory contains numerous explicit <code>any</code> types that:\n\u2022 Weaken type safety\n\u2022 Generate ESLint warnings\n\u2022 Make refactoring riskier\n\u2022 Reduce IDE support (autocomplete, error detection)\n\n**Current State:**\n\u2022 60+ <code>any</code> types found\n\u2022 100+ ESLint warnings for <code>@typescript-eslint/no-explicit-any</code>\n\u2022 Concentrated in IPC handler files\n\n<strong>Solution</strong>\n\nSystematically replace <code>any</code> types with proper TypeScript types.\n\n<strong>Type Replacement Strategy</strong>\n\n1. **IPC Request/Response Types**\n<code>// Before\nipcMain.handle('get-user', async (event, userId: any) => {\n  return await getUser(userId) as any;\n});\n\n// After\ninterface GetUserRequest {\n  userId: string;\n}\n\ninterface GetUserResponse {\n  id: string;\n  name: string;\n  email: string;\n}\n\nipcMain.handle('get-user', async (event, request: GetUserRequest): Promise<GetUserResponse> => {\n  return await getUser(request.userId);\n});\n</code>\n\n2. **Error Types**\n<code>// Before\ncatch (error: any) {\n  console.error(error.message);\n}\n\n// After\ncatch (error: unknown) {\n  if (error instanceof Error) {\n    console.error(error.message);\n  }\n}\n</code>\n\n3. **Dynamic Data**\n<code>// Before\nfunction processData(data: any): any {\n  // ...\n}\n\n// After\ninterface ProcessedData {\n  result: string;\n  metadata: Record<string, unknown>;\n}\n\nfunction processData(data: Record<string, unknown>): ProcessedData {\n  // ...\n}\n</code>\n\n<strong>Priority Order</strong>\n\n1. **IPC handlers** - Most impactful for type safety\n2. **Service method parameters** - API boundaries\n3. **Error handling** - Use <code>unknown</code> instead of <code>any</code>\n4. **Internal utilities** - Lower priority\n\n<strong>Implementation Steps</strong>\n\n1. Run ESLint to get full list of <code>any</code> warnings\n2. Group by handler file\n3. Create shared type definitions where applicable\n4. Replace <code>any</code> types file by file\n5. Verify no regressions\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>any</code> types in electron handlers reduced to <10\n\u2610 ESLint warnings for <code>@typescript-eslint/no-explicit-any</code> reduced by 90%\n\u2610 Shared type definitions created for common patterns\n\u2610 No functionality changes\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes (or warnings significantly reduced)\n\u2610 <code>npm test</code> passes\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Turns | 40-60 | Many files, but mechanical changes |\n| Tokens | ~150K | |\n| Time | 1-2 days | |\n\n<strong>Dependencies</strong>\n\n\u2022 None, but consider doing after BACKLOG-111 (service abstractions migration) to avoid conflicts\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Breaking type inference | Test thoroughly after each file |\n| Over-strict types causing issues | Use <code>unknown</code> or generics where truly dynamic |\n| Merge conflicts | Schedule as dedicated work |\n\n<strong>Notes</strong>\n\n**This item is SR Engineer sourced from type safety audit.**\n\nThis is a code quality improvement that will:\n\u2022 Catch bugs at compile time\n\u2022 Improve IDE support\n\u2022 Make refactoring safer\n\u2022 Reduce ESLint noise\n\nConsider creating a shared <code>electron/types/</code> directory for common IPC types.\n\n**Files to modify:**\n\u2022 <code>electron/handlers/*.ts</code>\n\u2022 <code>electron/types/*.ts</code> (new or existing)"
  },
  {
    "id": "BACKLOG-116",
    "title": "Bring Google Login to Feature Parity with Microsoft",
    "category": "service",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~60K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-116.md](BACKLOG-116.md)",
    "created_at": "2025-12-28",
    "completed_at": "",
    "file": "",
    "description": "<strong>Priority: Medium</strong>\n\n<strong>Category: service</strong>\n\n<strong>Summary</strong>\n\nThe <code>handleGoogleLogin</code> function in <code>googleAuthHandlers.ts</code> is missing several features that exist in <code>handleMicrosoftLogin</code>. This was identified during SR Engineer review of PR #242 after a hotfix restored basic Google login functionality that was accidentally simplified during the Sprint 009 refactor (commit 7930e9f).\n\n<strong>Problem</strong>\n\nDuring SPRINT-009's <code>auth-handlers.ts</code> split refactor, the Google login flow was accidentally simplified. While PR #242 restored basic functionality, the Google login handler is missing the following features that exist in the Microsoft handler:\n\n<strong>Missing Features in <code>handleGoogleLogin</code> vs <code>handleMicrosoftLogin</code></strong>\n\n| Feature | Microsoft | Google | Impact |\n|---------|-----------|--------|--------|\n| Timeout protection (120s) | Yes | No | Potential infinite hang |\n| Rate limiting check | Yes | No | Brute force vulnerability |\n| Database initialization check | Yes | No | Error on cold start |\n| Update existing user | Yes | No (only creates) | Profile updates lost |\n| OAuth token persistence | Yes | No | Session-only auth |\n| Last login update | Yes | No | Analytics gap |\n| Device registration | Yes | No | Multi-device tracking broken |\n| Event tracking | Yes | No | User login analytics lost |\n| Audit logging | Yes | No | Security audit gap |\n| Rate limit recording | Yes | No | Lockout doesn't work |\n| Bidirectional terms sync | Yes | No | Terms state inconsistent |\n| <code>setSyncUserId</code> call | Yes | No | Sync handler not initialized |\n\n**Note:** The <code>handleGoogleCompleteLogin</code> function (used for a different flow) does have many of these features. The primary issue is in <code>handleGoogleLogin</code> which is the popup-based flow.\n\n<strong>Solution</strong>\n\nRefactor <code>handleGoogleLogin</code> to match the structure of <code>handleMicrosoftLogin</code>:\n\n<strong>1. Add timeout protection</strong>\n\n<code>const timeoutMs = 120000;\nconst codeWithTimeout = Promise.race([\n  codePromise,\n  new Promise<never>((_, reject) =>\n    setTimeout(\n      () => reject(new Error(\"Authentication timed out\")),\n      timeoutMs\n    )\n  ),\n]);\nconst code = await codeWithTimeout;\n</code>\n\n<strong>2. Add rate limiting check</strong>\n\n<code>const email = \"pending@google.com\"; // or actual email if available\nconst rateLimitCheck = await rateLimitService.checkRateLimit(email);\nif (!rateLimitCheck.allowed) {\n  // Send rate limit error to renderer\n  return;\n}\n</code>\n\n<strong>3. Add database initialization check</strong>\n\n<code>if (!databaseService.isInitialized()) {\n  mainWindow.webContents.send(\"google:login-pending\", {\n    success: true,\n    pendingLogin: true,\n    userInfo,\n    tokens,\n    cloudUser,\n    subscription,\n  });\n  return;\n}\n</code>\n\n<strong>4. Add update existing user logic</strong>\n\nCurrently only creates new users. Need to add the update branch with cloud sync.\n\n<strong>5. Add missing service calls</strong>\n\n\u2022 <code>databaseService.saveOAuthToken()</code> - persist tokens\n\u2022 <code>databaseService.updateLastLogin()</code> - update last login timestamp\n\u2022 <code>supabaseService.registerDevice()</code> - register device\n\u2022 <code>supabaseService.trackEvent()</code> - track login event\n\u2022 <code>auditService.log()</code> - audit log\n\u2022 <code>rateLimitService.recordAttempt()</code> - record success for rate limiting\n\u2022 Bidirectional terms sync logic\n\u2022 <code>setSyncUserId()</code> - initialize sync handler\n\n<strong>Implementation Steps</strong>\n\n1. Compare <code>handleMicrosoftLogin</code> and <code>handleGoogleLogin</code> line-by-line\n2. Extract common auth processing logic into shared utilities (optional but recommended)\n3. Add timeout protection wrapper around <code>codePromise</code>\n4. Add rate limiting check before processing\n5. Add database initialization check with pending flow\n6. Add update existing user path (not just create)\n7. Add OAuth token persistence\n8. Add last login update\n9. Add device registration\n10. Add event tracking\n11. Add audit logging\n12. Add rate limit recording on success\n13. Add bidirectional terms sync\n14. Add <code>setSyncUserId</code> call\n15. Test both new user and returning user flows\n16. Test rate limiting behavior\n17. Test timeout behavior\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>handleGoogleLogin</code> includes 120s timeout protection\n\u2610 Rate limiting is checked before login processing\n\u2610 Database initialization is checked with pending flow support\n\u2610 Existing users are updated (not just created)\n\u2610 OAuth tokens are persisted to database\n\u2610 Last login timestamp is updated\n\u2610 Device registration occurs on login\n\u2610 Login events are tracked in Supabase\n\u2610 Login is audit logged\n\u2610 Rate limit success is recorded\n\u2610 Bidirectional terms sync works\n\u2610 <code>setSyncUserId</code> is called after successful login\n\u2610 All existing tests pass\n\u2610 New tests added for timeout and rate limiting\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\n<strong>Estimated Effort</strong>\n\n| Metric | Raw Estimate | Notes |\n|--------|--------------|-------|\n| Turns | 15-20 | Moderate complexity, mostly copying patterns |\n| Tokens | ~60K | |\n| Time | 2-3 hours | |\n\n<strong>Dependencies</strong>\n\n\u2022 None (standalone fix)\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Breaking Google login | Test thoroughly before merge |\n| Different OAuth flow semantics | Review Google vs Microsoft OAuth differences |\n| Missing edge cases | Compare handleGoogleCompleteLogin for reference |\n\n<strong>Notes</strong>\n\n**This item was sourced from SR Engineer review of PR #242.**\n\nThe good news is that <code>handleGoogleCompleteLogin</code> already implements many of these features, so the patterns exist in the same file. The work is largely about ensuring <code>handleGoogleLogin</code> (the popup flow) has parity with the Microsoft equivalent.\n\nConsider whether to extract common auth processing logic into shared utilities to prevent future drift between providers.\n\n**Related files:**\n\u2022 <code>electron/handlers/googleAuthHandlers.ts</code> - Google auth handlers (main changes)\n\u2022 <code>electron/handlers/microsoftAuthHandlers.ts</code> - Reference implementation\n\u2022 <code>electron/sync-handlers.ts</code> - For <code>setSyncUserId</code> import\n\n**Reference commits:**\n\u2022 7930e9f - Sprint 009 refactor that introduced the regression\n\u2022 PR #242 - Hotfix that restored basic functionality"
  },
  {
    "id": "BACKLOG-117",
    "title": "Fix Sprint 009 Auth Regressions (Preload Sandbox + Google Login)",
    "category": "fix",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "~20K",
    "actual_tokens": "~13K",
    "variance": "-70%",
    "created_at": "2025-12-28",
    "completed_at": "",
    "file": "[BACKLOG-117.md](BACKLOG-117.md)",
    "description": "<strong>Priority: Critical</strong>\n\n<strong>Category: service</strong>\n\n<strong>Summary</strong>\n\nSprint 009's <code>auth-handlers.ts</code> split refactor introduced two critical regressions that break authentication:\n\n1. **Preload Sandbox Issue**: Electron 35+ defaults <code>sandbox: true</code> in BrowserWindow webPreferences, which prevents the preload script from exposing <code>window.api</code> to the renderer. This breaks all IPC communication.\n\n2. **Google Login Flow Incomplete**: During the refactor (commit 7930e9f), the <code>setTimeout</code> block that awaits <code>codePromise</code> and completes the OAuth flow was accidentally omitted from <code>googleAuthHandlers.ts</code>. The authorization code is obtained but never processed.\n\n<strong>Problem</strong>\n\n<strong>Preload Script Broken</strong>\n\n<code>Electron 35+ changed sandbox default from false to true.\nPreload script cannot expose window.api when sandboxed.\nAll IPC calls fail silently.\n</code>\n\n<strong>Google Login Stalls</strong>\n\nThe refactored <code>handleGoogleLogin</code> function:\n1. Opens OAuth popup\n2. Obtains authorization code via <code>codePromise</code>\n3. **MISSING**: Code is never awaited or processed\n4. Login never completes\n\n**Root cause commit**: 7930e9f (Sprint 009 auth-handlers split)\n\n<strong>Solution</strong>\n\n<strong>1. Fix Preload Sandbox</strong>\n\nAdd <code>sandbox: false</code> to BrowserWindow webPreferences in <code>electron/main.ts</code>:\n\n<code>webPreferences: {\n  preload: path.join(__dirname, 'preload.js'),\n  contextIsolation: true,\n  nodeIntegration: false,\n  sandbox: false, // Required for preload script to expose window.api\n}\n</code>\n\n<strong>2. Restore Google Login Completion</strong>\n\nAdd the missing <code>setTimeout</code> block to <code>handleGoogleLogin</code> that:\n\u2022 Awaits <code>codePromise</code> for the OAuth authorization code\n\u2022 Exchanges code for tokens\n\u2022 Syncs user to Supabase\n\u2022 Creates/finds local user\n\u2022 Creates session\n\u2022 Sends <code>google:login-complete</code> event to renderer\n\n**Reference**: The original logic existed in <code>auth-handlers.ts</code> before the split.\n\n<strong>Implementation Status</strong>\n\n**PR #242** on branch <code>hotfix/preload-sandbox-and-login-flow</code> contains the fix.\n\nThe code changes are complete. SR Engineer has reviewed and provided enhancement suggestions (see BACKLOG-116 for feature parity improvements).\n\n<strong>Acceptance Criteria</strong>\n\n\u2611 <code>sandbox: false</code> added to BrowserWindow webPreferences\n\u2611 Google OAuth flow completes successfully\n\u2611 User is created/found in local database after login\n\u2611 Session is created\n\u2611 Renderer receives <code>google:login-complete</code> event\n\u2611 Microsoft login still works (not affected)\n\u2611 Preload script exposes <code>window.api</code> correctly\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\u2610 CI passes\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Turns | 4-6 | Code already exists in PR #242 |\n| Tokens | ~20K | Mostly validation and SR suggestions |\n| Time | 30-60 min | Implement SR feedback + test |\n\n**Adjustment**: Service category x 1.0 (no historical data)\n\n<strong>Dependencies</strong>\n\n\u2022 None (standalone critical fix)\n\n<strong>Related Items</strong>\n\n| ID | Title | Relationship |\n|----|-------|--------------|\n| BACKLOG-116 | Google Login Feature Parity | Enhancement work after this fix |\n| PR #242 | hotfix/preload-sandbox-and-login-flow | Contains the fix code |\n| Sprint 009 | Codebase Standards Remediation | Introduced the regression |\n\n<strong>SR Engineer Review Notes (from PR #242)</strong>\n\nSR Engineer reviewed PR #242 and provided these suggestions for robustness:\n\n1. **Add timeout protection (120s)**: Use <code>Promise.race</code> like Microsoft handler\n2. **Consider rate limiting**: Check rate limit before processing\n3. **Note**: The fix is simplified compared to Microsoft's full flow\n\nThese enhancements are tracked in BACKLOG-116 (feature parity), not required for this critical fix.\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Breaking existing login flows | Test both Google and Microsoft |\n| Preload change affecting security | sandbox: false is required for our architecture |\n\n<strong>Notes</strong>\n\n**Why this is separate from BACKLOG-116:**\n\u2022 This backlog item tracks the **critical regression fix** (restore functionality)\n\u2022 BACKLOG-116 tracks the **enhancement work** (add timeout, rate limiting, parity)\n\nThe fix in PR #242 restores basic functionality. Feature parity with Microsoft can be done as follow-up work without blocking the critical fix.\n\n**Files changed in PR #242:**\n\u2022 <code>electron/main.ts</code> - Added <code>sandbox: false</code>\n\u2022 <code>electron/handlers/googleAuthHandlers.ts</code> - Added missing login completion flow"
  },
  {
    "id": "BACKLOG-118",
    "title": "Fix OnboardingFlow React Hooks Order Bug",
    "category": "fix",
    "priority": "High",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "~10K",
    "actual_tokens": "~8K",
    "variance": "-50%",
    "created_at": "2025-12-28",
    "completed_at": "",
    "file": "[BACKLOG-118.md](BACKLOG-118.md)",
    "description": "<strong>Priority: High</strong>\n\n<strong>Category: ui</strong>\n\n<strong>Summary</strong>\n\nThe <code>OnboardingFlow.tsx</code> component has a React hooks order violation that causes a \"Rendered fewer hooks than expected\" error after connecting a mailbox during onboarding.\n\n<strong>Problem</strong>\n\n<strong>Root Cause</strong>\n\nIn <code>OnboardingFlow.tsx</code>, the <code>useCallback(handleStepAction)</code> hook is placed AFTER an early return guard:\n\n<code>// Line 178-181: Early return BEFORE the useCallback hook\nif (!currentStep) {\n  return null;\n}\n\n// ... more code ...\n\n// Line 190-196: This useCallback hook is AFTER the conditional return\nconst handleStepAction = useCallback(\n  (action: StepAction) => {\n    flowHandleAction(action);\n  },\n  [flowHandleAction]\n);\n</code>\n\n<strong>Why This Causes the Error</strong>\n\n1. On initial render (before mailbox connect): All hooks run, including <code>handleStepAction</code>\n2. After mailbox connects: <code>appState.emailConnected</code> becomes <code>true</code>\n3. Steps are filtered, and <code>currentStep</code> becomes <code>undefined</code>\n4. Early return triggers BEFORE <code>handleStepAction</code> useCallback\n5. React detects fewer hooks than previous render = ERROR\n\n<strong>When This Occurs</strong>\n\n\u2022 After connecting a Google or Microsoft mailbox during onboarding\n\u2022 When all remaining onboarding steps are filtered out (user already complete)\n\u2022 Any scenario where <code>currentStep</code> becomes undefined mid-session\n\n<strong>Solution</strong>\n\nMove the <code>handleStepAction</code> useCallback BEFORE the early return guard:\n\n<code>// Action handler - MUST be before any early return\nconst handleStepAction = useCallback(\n  (action: StepAction) => {\n    flowHandleAction(action);\n  },\n  [flowHandleAction]\n);\n\n// NOW the guard is safe - all hooks have been called\nif (!currentStep) {\n  return null;\n}\n</code>\n\n<strong>Implementation Status</strong>\n\n**Fixed in:** <code>src/components/onboarding/OnboardingFlow.tsx</code>\n\nThe fix moved <code>handleStepAction</code> useCallback from line 190-196 to line 178-186, placing it before the <code>if (!currentStep)</code> guard.\n\n<strong>Acceptance Criteria</strong>\n\n\u2611 <code>handleStepAction</code> useCallback moved before early return\n\u2611 <code>npm run type-check</code> passes\n\u2611 No lint errors introduced\n\u2610 Manual test: Connect mailbox during onboarding without crash\n\u2610 Manual test: Return as existing user with email connected\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Actual | Notes |\n|--------|----------|--------|-------|\n| Turns | 1-2 | 1 | Simple hook reorder |\n| Tokens | ~10K | ~8K | |\n| Time | 15m | 10m | |\n\n**Variance:** -50%\n\n<strong>Dependencies</strong>\n\n\u2022 None (standalone fix)\n\n<strong>Related Items</strong>\n\n| ID | Title | Relationship |\n|----|-------|--------------|\n| PR #242 | hotfix/preload-sandbox-and-login-flow | Discovered during testing |\n\n<strong>Technical Notes</strong>\n\n<strong>React Rules of Hooks</strong>\n\nReact requires hooks to be called in the same order on every render. This rule exists because React tracks hooks by their call order, not by name.\n\n**Rule:** Never place hooks after conditional returns.\n\n<strong>Pattern to Follow</strong>\n\n<code>// CORRECT: All hooks before any conditional return\nconst [state, setState] = useState();\nconst memoizedValue = useMemo(() => compute(), []);\nconst callback = useCallback(() => {}, []);\n\n// Now guards are safe\nif (!data) return null;\n\n// Render logic\nreturn <div>{data}</div>;\n</code>\n\n<strong>Notes</strong>\n\nThis bug was discovered during testing of BACKLOG-117 (Sprint 009 Auth Regressions). After fixing the Google login flow, the OnboardingFlow component started crashing when the mailbox connection completed.\n\n**Files changed:**\n\u2022 <code>src/components/onboarding/OnboardingFlow.tsx</code> - Moved useCallback before early return"
  },
  {
    "id": "BACKLOG-119",
    "title": "Audit OAuth Handler Parity (Google/Microsoft)",
    "category": "refactor",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~50K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-28",
    "completed_at": "",
    "file": "[BACKLOG-119.md](BACKLOG-119.md)",
    "description": "<strong>Priority: Low</strong>\n\n<strong>Category: refactor</strong>\n\n<strong>Summary</strong>\n\nConduct a comprehensive audit of Google and Microsoft OAuth handlers to ensure parity in safety checks, error handling patterns, and authentication flows. Establish shared utilities or a base handler pattern to prevent future divergence between providers.\n\n<strong>Background</strong>\n\nThis backlog item was created after discovering that the Google OAuth handler in <code>googleAuthHandlers.ts</code> was missing a critical database initialization check that the Microsoft handler in <code>microsoftAuthHandlers.ts</code> already had. This caused a \"Database is not initialized\" error on macOS when users tried to log in with Google.\n\nThe immediate fix was adding this check before database operations:\n\n<code>if (!databaseService.isInitialized()) {\n  // Send login-pending event instead of trying to use DB\n  mainWindow.webContents.send(\"google:login-pending\", {...});\n  return;\n}\n</code>\n\nWhile BACKLOG-116 addresses bringing <code>handleGoogleLogin</code> to feature parity with <code>handleMicrosoftLogin</code>, this item takes a broader approach: auditing ALL handler functions across both providers and establishing patterns to prevent future drift.\n\n<strong>Problem</strong>\n\nThe current auth handlers evolved independently, leading to inconsistencies:\n\n1. **No shared patterns** - Each handler implements safety checks differently\n2. **Easy to miss features** - When adding a feature to one provider, easy to forget the other\n3. **Multiple handler functions per provider** - Each provider has 3-4 handler functions, multiplying the parity problem\n4. **No enforcement mechanism** - Nothing prevents future divergence\n\n<strong>Scope</strong>\n\n<strong>Handlers to Audit</strong>\n\n**Google (<code>googleAuthHandlers.ts</code>):**\n\u2022 <code>handleGoogleLogin</code> (popup login flow)\n\u2022 <code>handleGoogleCompleteLogin</code> (code exchange flow)\n\u2022 <code>handleGoogleConnectMailbox</code> (post-DB mailbox connection)\n\u2022 <code>handleGoogleConnectMailboxPending</code> (pre-DB mailbox connection)\n\n**Microsoft (<code>microsoftAuthHandlers.ts</code>):**\n\u2022 <code>handleMicrosoftLogin</code> (popup login flow)\n\u2022 <code>handleMicrosoftConnectMailbox</code> (post-DB mailbox connection)\n\u2022 <code>handleMicrosoftConnectMailboxPending</code> (pre-DB mailbox connection)\n\n<strong>Areas to Check</strong>\n\n| Area | Description |\n|------|-------------|\n| **Database initialization** | Check <code>databaseService.isInitialized()</code> before DB operations |\n| **Rate limiting** | Check rate limits before processing, record attempts after |\n| **Timeout protection** | Wrap async operations with timeout (120s standard) |\n| **Session handling** | Consistent session creation and validation |\n| **Token management** | OAuth token persistence, refresh token handling |\n| **User create/update** | Update existing users, not just create new |\n| **Error handling** | Consistent error types, messages, and audit logging |\n| **Audit logging** | Log all auth events (success and failure) |\n| **Device registration** | Register device on login |\n| **Event tracking** | Track login events in Supabase |\n| **Bidirectional sync** | Terms/privacy acceptance synced both ways |\n| **Sync handler init** | Call <code>setSyncUserId()</code> after successful login |\n| **Mailbox flows** | Connection, cancellation, and error handling |\n\n<strong>Solution</strong>\n\n<strong>Phase 1: Comprehensive Audit (Document)</strong>\n\nCreate a parity matrix documenting which features exist in which handlers:\n\n| Feature | Google Login | Google Complete | Google Mailbox | Google Mailbox Pending | MS Login | MS Mailbox | MS Mailbox Pending |\n|---------|--------------|-----------------|----------------|------------------------|----------|------------|-------------------|\n| DB init check | ? | ? | ? | ? | ? | ? | ? |\n| Rate limiting | ? | ? | ? | ? | ? | ? | ? |\n| Timeout | ? | ? | ? | ? | ? | ? | ? |\n| ... | | | | | | | |\n\n<strong>Phase 2: Extract Shared Utilities</strong>\n\nCreate shared utilities to reduce duplication and enforce consistency:\n\n<code>// electron/handlers/auth-utils.ts\n\nexport function withTimeout<T>(promise: Promise<T>, ms: number = 120000): Promise<T> {\n  return Promise.race([\n    promise,\n    new Promise<never>((_, reject) =>\n      setTimeout(() => reject(new Error(\"Authentication timed out\")), ms)\n    ),\n  ]);\n}\n\nexport async function checkDatabaseReady(\n  mainWindow: BrowserWindow | null,\n  eventName: string,\n  pendingData: object\n): boolean {\n  if (!databaseService.isInitialized()) {\n    if (mainWindow && !mainWindow.isDestroyed()) {\n      mainWindow.webContents.send(eventName, {\n        success: true,\n        pendingLogin: true,\n        ...pendingData,\n      });\n    }\n    return false;\n  }\n  return true;\n}\n\nexport async function handleLoginSuccess(\n  localUser: User,\n  cloudUser: CloudUser,\n  provider: \"google\" | \"microsoft\",\n  sessionToken: string\n): Promise<void> {\n  // Rate limit recording\n  await rateLimitService.recordAttempt(localUser.email, true);\n\n  // Device registration\n  const deviceInfo = { ... };\n  await supabaseService.registerDevice(cloudUser.id, deviceInfo);\n\n  // Event tracking\n  await supabaseService.trackEvent(cloudUser.id, \"user_login\", { provider }, ...);\n\n  // Audit logging\n  await auditService.log({\n    userId: localUser.id,\n    sessionId: sessionToken,\n    action: \"LOGIN\",\n    resourceType: \"SESSION\",\n    resourceId: sessionToken,\n    metadata: { provider },\n    success: true,\n  });\n\n  // Sync handler init\n  setSyncUserId(localUser.id);\n}\n</code>\n\n<strong>Phase 3: Refactor Handlers to Use Shared Utilities</strong>\n\nRefactor both Google and Microsoft handlers to use the shared utilities, ensuring consistency.\n\n<strong>Phase 4: Add Tests for Parity</strong>\n\nCreate tests that verify both providers implement the same safety checks:\n\n<code>describe(\"OAuth Handler Parity\", () => {\n  it(\"both providers check database initialization\", async () => { ... });\n  it(\"both providers implement timeout protection\", async () => { ... });\n  it(\"both providers record rate limit attempts\", async () => { ... });\n  // etc.\n});\n</code>\n\n<strong>Implementation Steps</strong>\n\n1. Create parity audit matrix (document current state)\n2. Identify gaps in each handler (comparing to the \"complete\" set)\n3. Design shared utility interfaces\n4. Extract common patterns to <code>auth-utils.ts</code>\n5. Refactor Google handlers to use shared utilities\n6. Refactor Microsoft handlers to use shared utilities\n7. Add parity tests\n8. Update documentation\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Parity audit matrix created and committed\n\u2610 All gaps identified and documented\n\u2610 Shared utility module created (<code>electron/handlers/auth-utils.ts</code>)\n\u2610 Google handlers refactored to use shared utilities\n\u2610 Microsoft handlers refactored to use shared utilities\n\u2610 All handlers pass same safety checks (DB init, rate limit, timeout, etc.)\n\u2610 Parity tests added and passing\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\u2610 Manual testing of both login flows (Google and Microsoft)\n\u2610 Manual testing of both mailbox connection flows\n\n<strong>Estimated Effort</strong>\n\n| Metric | Raw Estimate | Adjusted (refactor x0.5) | Notes |\n|--------|--------------|--------------------------|-------|\n| Turns | 25-35 | 13-18 | Primarily refactoring existing patterns |\n| Tokens | ~100K | ~50K | |\n| Time | 4-6 hours | 2-3 hours | |\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-116 (Google Login Parity) - Should be completed first or merged with this work\n  - **Recommendation:** Complete BACKLOG-116 first, then this item builds on that work\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Breaking auth flows | Extensive manual testing of all flows |\n| OAuth provider differences | Document legitimate differences (not bugs) |\n| Refactoring complexity | Incremental changes, one handler at a time |\n| Missing edge cases | Review existing bug reports for auth-related issues |\n\n<strong>Relationship to Other Backlog Items</strong>\n\n| Item | Relationship |\n|------|--------------|\n| BACKLOG-116 | Prerequisite - addresses immediate parity gaps in <code>handleGoogleLogin</code> |\n| BACKLOG-100 | Related - Create auth/ Module (potential location for shared utilities) |\n\n<strong>Notes</strong>\n\n**Technical Debt Classification:** This is proactive technical debt prevention. While the immediate bug was fixed, the underlying pattern problem remains: two independent implementations that can drift apart.\n\n**Why Low Priority:** The immediate bug is fixed, and BACKLOG-116 addresses the most critical gaps. This item is about establishing patterns to prevent future issues, which is valuable but not urgent.\n\n**Consider combining with BACKLOG-100** (Create auth/ Module) if that work is scheduled, as both involve restructuring auth-related code.\n\n**Related files:**\n\u2022 <code>electron/handlers/googleAuthHandlers.ts</code>\n\u2022 <code>electron/handlers/microsoftAuthHandlers.ts</code>\n\u2022 <code>electron/handlers/auth-utils.ts</code> (to be created)\n\u2022 <code>electron/services/rateLimitService.ts</code>\n\u2022 <code>electron/services/auditService.ts</code>\n\u2022 <code>electron/services/databaseService.ts</code>\n\u2022 <code>electron/sync-handlers.ts</code>\n\n**Incident that prompted this item:**\n\u2022 Issue: \"Database is not initialized\" error on macOS during Google login\n\u2022 Root cause: Missing <code>databaseService.isInitialized()</code> check in <code>handleGoogleLogin</code>\n\u2022 Fix: Added check to send <code>google:login-pending</code> event when DB not ready"
  },
  {
    "id": "BACKLOG-120",
    "title": "CI Testing Infrastructure Gaps",
    "category": "infra",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~80K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2025-12-29",
    "completed_at": "",
    "file": "[BACKLOG-120.md](BACKLOG-120.md)",
    "description": "<strong>Summary</strong>\n\nTrack and address testing infrastructure gaps identified during TASK-704 CI debugging work. Several test categories are currently excluded from CI due to technical limitations, representing potential risk areas that need alternative coverage strategies.\n\n---\n\n<strong>Background Context</strong>\n\nDuring TASK-704 implementation, CI runs started hanging indefinitely (20-45+ minutes). Extensive debugging revealed multiple root causes related to how Jest handles certain test patterns in the CI environment.\n\n<strong>Root Cause Analysis</strong>\n\n1. **Mock Services with EventEmitter/setTimeout**\n   - Mock classes extend EventEmitter and create setTimeout timers\n   - These timers keep Node.js event loop alive after tests complete\n   - Jest's <code>--forceExit</code> flag conflicts with <code>--detectOpenHandles</code>\n\n2. **Native Module Incompatibility**\n   - Electron native modules (better-sqlite3-multiple-ciphers) are compiled for Electron runtime\n   - Jest runs under Node.js, causing version mismatches\n   - Tests that require native modules hang during module load\n\n3. **Fake Timer Conflicts**\n   - Integration tests use <code>jest.useFakeTimers()</code> at module level\n   - Mixed with real async operations (Promises, EventEmitter)\n   - Creates deadlock: fake timers wait for manual advancement, async code waits for real time\n\n---\n\n<strong>Current Workarounds Applied (TASK-704)</strong>\n\n<strong>1. jest.config.js Changes</strong>\n<code>testPathIgnorePatterns: [\n  '/tests/integration/',  // Fake timer conflicts\n  ...(process.env.CI ? [\n    '/electron/services/__tests__/',  // EventEmitter/setTimeout\n    '/electron/__tests__/',  // IPC handlers with native dependencies\n  ] : []),\n],\ntestTimeout: 30000,  // Global 30-second timeout\n</code>\n\n<strong>2. CI Workflow Changes (.github/workflows/ci.yml)</strong>\n<code>run: npm test -- --silent --maxWorkers=2 --workerIdleMemoryLimit=512MB --forceExit\n</code>\n\n<strong>3. Individual Test File Skips</strong>\n\u2022 <code>electron/services/__tests__/nativeModules.test.ts</code> - <code>describe.skip</code> in CI\n\u2022 <code>electron/services/__tests__/syncOrchestrator.test.ts</code> - <code>describe.skip</code> in CI\n\u2022 <code>src/components/__tests__/ContactSelectModal.test.tsx</code> - excluded via testPathIgnorePatterns in CI\n\n---\n\n<strong>Testing Gaps to Address</strong>\n\n<strong>1. SQLite/Native Modules - Risk: Medium-High</strong>\n\n**What's Not Tested in CI:**\n\u2022 <code>nativeModules.test.ts</code> - SQLite driver loading and version compatibility\n\n**Current Mitigation:**\n\u2022 CI runs <code>node scripts/rebuild-native.js</code> which rebuilds for Electron\n\u2022 Downstream tests (transaction, contact tests) would fail if SQLite broken\n\n**TODO:**\n\u2610 Add dedicated SQLite health check to CI build step\n\u2610 Consider adding SQLite smoke test that works with Node.js (not Electron-specific)\n\u2610 Document manual testing requirements for native module changes\n\n**Estimated Effort:** 2-3 turns\n\n---\n\n<strong>2. SyncOrchestrator (Windows iPhone Sync) - Risk: Low-Medium</strong>\n\n**What's Not Tested in CI:**\n\u2022 <code>syncOrchestrator.test.ts</code> - Full sync workflow orchestration\n\u2022 <code>backupService.test.ts</code> - iPhone backup creation\n\u2022 Device detection, backup decryption, message parsing pipeline\n\n**Current Mitigation:**\n\u2022 Windows-only feature with limited user base\n\u2022 Individual components have unit tests that do run\n\u2022 CI doesn't have iPhone devices anyway\n\n**TODO:**\n\u2610 Refactor mock implementations to use proper timer cleanup\n\u2610 Consider extracting timer-dependent logic into separate, testable units\n\u2610 Add smoke tests if Windows user adoption increases\n\u2610 Document manual testing requirements for iPhone sync changes\n\n**Estimated Effort:** 8-12 turns (mock refactoring is complex)\n\n---\n\n<strong>3. Integration Tests (/tests/integration/) - Risk: Medium</strong>\n\n**What's Not Tested in CI:**\n\u2022 E2E user journey tests\n\u2022 Cross-component integration flows\n\u2022 State machine transition tests\n\n**Current Mitigation:**\n\u2022 Unit tests cover same components individually\n\u2022 Component tests validate UI behavior\n\n**TODO:**\n\u2610 Create separate CI job with longer timeout (15-30 min)\n\u2610 OR run integration tests as nightly/weekly build\n\u2610 Refactor tests to avoid <code>jest.useFakeTimers()</code> at module level\n\u2610 Use <code>jest.useFakeTimers({ advanceTimers: true })</code> for auto-advancing\n\n**Estimated Effort:** 6-10 turns\n\n---\n\n<strong>4. Electron Handler Tests (/electron/__tests__/) - Risk: Low-Medium</strong>\n\n**What's Not Tested in CI:**\n\u2022 IPC handler unit tests\n\u2022 Auth handler flow tests\n\u2022 System handler tests\n\n**Current Mitigation:**\n\u2022 Most handlers are thin wrappers around services\n\u2022 Service tests provide coverage of core logic\n\n**TODO:**\n\u2610 Identify which handlers have unique logic (not just service delegation)\n\u2610 Extract testable logic from handlers into services where appropriate\n\u2610 Ensure mock infrastructure doesn't use EventEmitter patterns\n\n**Estimated Effort:** 4-6 turns\n\n---\n\n<strong>5. ContactSelectModal Test - Risk: Low</strong>\n\n**What's Not Tested in CI:**\n\u2022 <code>src/components/__tests__/ContactSelectModal.test.tsx</code> - Contact selection modal component tests\n\n**Issue Discovered:**\n\u2022 Test hangs during the **loading phase** (not execution) specifically in CI\n\u2022 All other frontend tests run fine; only this specific file triggers the hang\n\u2022 Root cause unknown - suspected module resolution or Jest worker initialization issue\n\u2022 Test works perfectly fine locally with identical configuration\n\n**Current Mitigation:**\n\u2022 Component is well-covered by related tests (Contacts.test.tsx, TransactionContacts tests)\n\u2022 The modal uses standard patterns also tested in AuditTransactionModal tests\n\u2022 Excluded only in CI; runs locally for developers\n\n**TODO:**\n\u2610 Investigate Jest worker initialization differences in CI vs local\n\u2610 Check if specific imports in this file cause issues (lazy loading, circular deps)\n\u2610 Try running with --runInBand in CI to isolate worker-related issues\n\u2610 Consider splitting into smaller test files to isolate problematic import\n\n**Estimated Effort:** 3-5 turns (primarily investigation)\n\n---\n\n<strong>Long-Term Solutions</strong>\n\n<strong>A. Mock Infrastructure Overhaul</strong>\nRefactor all EventEmitter-based mocks to:\n1. Use Jest's built-in mock functions instead of custom classes\n2. Clear all timers in <code>afterEach</code> hooks\n3. Remove <code>removeAllListeners()</code> patterns (not needed with proper mocks)\n\n<strong>B. Test Environment Strategy</strong>\n1. Use <code>testEnvironment: 'node'</code> for electron tests (currently using jsdom)\n2. Create separate Jest projects for frontend vs backend tests\n3. Consider using electron-mock for handler tests\n\n<strong>C. Native Module Testing</strong>\n1. Add prebuild check script that validates binaries before test run\n2. Skip native tests gracefully with clear messaging\n3. Add CI step that validates native rebuild succeeded\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 All testing gaps have documented alternative coverage strategies\n\u2610 Each excluded test category has manual testing procedures documented\n\u2610 Mock infrastructure refactored to not cause Jest hangs\n\u2610 Integration tests run in CI (either on every PR or nightly)\n\u2610 Native module tests have health check in CI build step\n\n---\n\n<strong>References</strong>\n\n\u2022 TASK-704 implementation (attach/unlink messages feature)\n\u2022 PR #255 (where CI issues were discovered)\n\u2022 jest.config.js (current exclusion patterns)\n\u2022 .github/workflows/ci.yml (current workarounds)\n\n---\n\n<strong>Risk Summary</strong>\n\n| Category | Risk Level | Coverage Gap | Mitigation Quality |\n|----------|------------|--------------|-------------------|\n| SQLite/Native | Medium-High | Native module loading | Good (rebuild step + downstream tests) |\n| SyncOrchestrator | Low-Medium | Windows iPhone sync | Acceptable (Windows-only, limited users) |\n| Integration | Medium | E2E flows | Moderate (unit tests cover components) |\n| Electron Handlers | Low-Medium | IPC handlers | Good (handlers are thin wrappers) |\n| ContactSelectModal | Low | Modal component test | Good (related tests cover same patterns) |\n\n**Overall Assessment:** Current workarounds are acceptable for shipping TASK-704. Long-term fixes should be scheduled in a future sprint focused on testing infrastructure."
  },
  {
    "id": "BACKLOG-121",
    "title": "Add Generator Approach Guidance for Large Fixtures",
    "category": "docs",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-015",
    "est_tokens": "~10K",
    "actual_tokens": "~800K-1.1M",
    "variance": "~100x",
    "created_at": "2026-01-01",
    "completed_at": "2026-01-02",
    "file": "[BACKLOG-121.md](BACKLOG-121.md)",
    "description": "<strong>Problem Statement</strong>\n\nDuring SPRINT-011, TASK-801 (iOS fixtures with 200+ messages) hit the 32K output token limit when the engineer attempted to directly output a large JSON file. This caused the task to stall and required a workaround.\n\n<strong>Proposed Solution</strong>\n\nUpdate PM documentation and task file templates to include explicit guidance for tasks that involve creating large data fixtures (>50 items):\n\n1. **Default to generator approach** - Create a TypeScript generator script that programmatically builds the data\n2. **Run the generator** - Execute with <code>npx ts-node</code> to create the JSON file\n3. **Delete the generator** - Remove temporary script after generation (or keep if useful for regeneration)\n\n<strong>Deliverables</strong>\n\n1. Update: <code>.claude/skills/agentic-pm/modules/task-file-authoring.md</code> - Add large fixture guidance\n2. Update: <code>.claude/docs/shared/plan-first-protocol.md</code> - Add fixture task considerations\n3. New: <code>.claude/docs/shared/large-fixture-generation.md</code> - Detailed guidance document\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Task authoring module includes warning for fixture tasks >50 items\n\u2610 Generator approach is documented with code examples\n\u2610 Token limit (32K) is explicitly mentioned as constraint\n\u2610 Examples from TASK-801 included as reference\n\n<strong>Implementation Notes</strong>\n\n<strong>Generator Script Pattern</strong>\n\n<code>// generateFixtures.ts (temporary)\nimport * as fs from 'fs';\n\nconst messages = [];\nfor (let i = 0; i < 200; i++) {\n  messages.push({\n    id: i + 1,\n    text: <code>Message ${i + 1}...</code>,\n    // ... build programmatically\n  });\n}\n\nfs.writeFileSync('messages.json', JSON.stringify({ messages }, null, 2));\nconsole.log(<code>Generated ${messages.length} messages</code>);\n</code>\n\n<strong>When to Use Generator Approach</strong>\n\n| Fixture Size | Approach |\n|--------------|----------|\n| <20 items | Direct Write tool |\n| 20-50 items | Consider generator |\n| >50 items | **Require generator** |\n\n<strong>Estimated Effort</strong>\n\n\u2022 **Turns:** 2-3\n\u2022 **Tokens:** ~10K\n\u2022 **Time:** 20-30m\n\n---\n\n<strong>References</strong>\n\n\u2022 TASK-801 implementation (SPRINT-011)\n\u2022 Error: \"Claude's response exceeded the 32000 output token maximum\""
  },
  {
    "id": "BACKLOG-122",
    "title": "Improve Engineer Agent Worktree Instructions",
    "category": "docs",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "~10K",
    "actual_tokens": "~8K",
    "variance": "-50%",
    "created_at": "2026-01-01",
    "completed_at": "",
    "file": "[BACKLOG-122.md](BACKLOG-122.md)",
    "description": "<strong>Problem Statement</strong>\n\nDuring SPRINT-011, engineer agents sometimes struggled with git worktree setup when instructed to use worktrees for parallel development:\n\u2022 Repeated failed commands trying to access worktree directories\n\u2022 Confusion about which directory to work in\n\u2022 Falling back to main directory instead of worktree\n\n<strong>Proposed Solution</strong>\n\nUpdate the engineer agent prompts and documentation with clearer worktree instructions:\n\n1. **Explicit worktree creation command** with expected output\n2. **Verification step** to confirm worktree exists before proceeding\n3. **Absolute path usage** throughout the task\n4. **Fallback guidance** if worktree creation fails\n\n<strong>Deliverables</strong>\n\n1. Update: <code>.claude/agents/engineer.md</code> - Add worktree section\n2. Update: <code>.claude/docs/shared/git-branching.md</code> - Add worktree best practices\n\n<strong>Acceptance Criteria</strong>\n\n\u2611 Engineer agent prompt includes worktree creation template\n\u2611 Verification command documented (<code>git worktree list</code>)\n\u2611 Common failure modes documented with solutions\n\u2611 Example workflow from branch creation to PR\n\n<strong>Implementation Notes</strong>\n\n<strong>Worktree Creation Template</strong>\n\n<code># 1. Create worktree\ngit worktree add ../Mad-task-XXX -b feature/TASK-XXX-description develop\n\n# 2. Verify creation\ngit worktree list\n# Expected: /path/to/Mad-task-XXX  abc1234 [feature/TASK-XXX-description]\n\n# 3. Change to worktree (if needed)\ncd ../Mad-task-XXX\n\n# 4. Verify you're in the right place\npwd && git branch --show-current\n</code>\n\n<strong>Common Failures</strong>\n\n| Issue | Cause | Solution |\n|-------|-------|----------|\n| \"already exists\" | Branch name conflict | Use unique branch name |\n| \"not a git repository\" | Wrong parent directory | Verify git repo location |\n| Directory not accessible | Permission or path issue | Use absolute paths |\n\n<strong>Estimated Effort</strong>\n\n\u2022 **Turns:** 2-3\n\u2022 **Tokens:** ~10K\n\u2022 **Time:** 20-30m\n\n---\n\n<strong>References</strong>\n\n\u2022 TASK-801, TASK-803 implementation issues (SPRINT-011)\n\u2022 Engineer agent getting stuck in loops trying to access worktree"
  },
  {
    "id": "BACKLOG-123",
    "title": "Update Test Category Estimation Multiplier",
    "category": "docs",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~5K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-01",
    "completed_at": "",
    "file": "[BACKLOG-123.md](BACKLOG-123.md)",
    "description": "<strong>Problem Statement</strong>\n\nSPRINT-011 data shows <code>test</code> category tasks are consistently overestimated:\n\u2022 Average variance: -28% (actual < estimated)\n\u2022 This follows the pattern seen in <code>refactor</code> category (-52%)\n\nCurrent estimation guidance does not include a multiplier for <code>test</code> category.\n\n<strong>Proposed Solution</strong>\n\nUpdate the estimation accuracy analysis and PM guidelines to include a 0.7x multiplier for test tasks.\n\n<strong>Deliverables</strong>\n\n1. Update: <code>.claude/plans/backlog/INDEX.md</code> - Update estimation multiplier table\n2. Update: <code>.claude/docs/shared/metrics-templates.md</code> - Add test category guidance\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 INDEX.md estimation table includes <code>test</code> category with 0.7x multiplier\n\u2610 Metrics templates document includes test category notes\n\u2610 SPRINT-011 data added to variance breakdown\n\n<strong>Implementation Notes</strong>\n\n<strong>Updated Estimation Table</strong>\n\n<code>| Category | Base Estimate | Adjustment | Notes |\n|----------|---------------|------------|-------|\n| schema | PM estimate | x 1.3 | High variance, add buffer |\n| refactor | PM estimate | x 0.5 | Consistently overestimate |\n| **test** | PM estimate | **x 0.7** | SPRINT-011 data: -28% avg |\n| config | PM estimate | x 0.5 | Significantly overestimate |\n| security | PM estimate | x 0.4 | SPRINT-009 showed simpler implementations |\n| service | PM estimate | x 1.0 | TBD - need data |\n| ui | PM estimate | x 1.0 | TBD - need data |\n</code>\n\n<strong>SPRINT-011 Test Task Data</strong>\n\n| Task | Est. Turns | Actual | Variance |\n|------|------------|--------|----------|\n| TASK-800 | 8-12 | ~4 | -60% |\n| TASK-801 | 10-14 | 10 | -14% |\n| TASK-802 | 12-18 | 8 | -47% |\n| TASK-804 | 2-4 | 6 | +50% |\n| **Average** | - | - | **-28%** |\n\nNote: TASK-804 was higher than estimated due to root cause analysis complexity, but still reasonable.\n\n<strong>Estimated Effort</strong>\n\n\u2022 **Turns:** 1-2\n\u2022 **Tokens:** ~5K\n\u2022 **Time:** 10-15m\n\n---\n\n<strong>References</strong>\n\n\u2022 SPRINT-011 Retrospective\n\u2022 INDEX.md Estimation Accuracy Analysis section"
  },
  {
    "id": "BACKLOG-124",
    "title": "Add Sprint Completion Checklist to PM Workflow",
    "category": "docs",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-012",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "TASK-805, PR #262",
    "created_at": "2026-01-01",
    "completed_at": "2026-01-01",
    "file": "[BACKLOG-124.md](BACKLOG-124.md)",
    "description": "<strong>Problem Statement</strong>\n\nSPRINT-010 was fully merged on 2025-12-29 but:\n\u2022 Sprint file still showed \"Planning\" status\n\u2022 Backlog items (054, 103, 104, 105) not marked complete\n\u2022 INDEX.md not updated with completion info\n\nThis led to incorrect status reports when asked \"where are we with SPRINT-010?\" on 2026-01-01.\n\n<strong>Proposed Solution</strong>\n\nAdd a mandatory \"Sprint Completion Checklist\" to the PM workflow that must be executed after the last PR merges.\n\n<strong>Deliverables</strong>\n\n1. Update: <code>.claude/skills/agentic-pm/modules/backlog-maintenance.md</code> - Add sprint completion checklist\n2. Update: <code>.claude/docs/shared/plan-first-protocol.md</code> - Reference sprint completion as PM responsibility\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Sprint completion checklist documented with specific steps\n\u2610 Checklist includes: update sprint file, mark backlog items, update INDEX.md\n\u2610 Verification step: <code>gh pr list</code> to confirm all tasks merged\n\u2610 Checklist is referenced in PM skill documentation\n\n<strong>Implementation Notes</strong>\n\n<strong>Sprint Completion Checklist</strong>\n\n<code><strong>Sprint Completion Checklist (After Last PR Merges)</strong>\n\n<strong>1. Verify All PRs Merged</strong>\n</code>bash\ngh pr list --state all | grep -E \"(TASK-XXX|TASK-YYY|...)\"\n# All should show \"MERGED\"\n<code>\n<strong>2. Update Sprint File</strong>\n\u2610 Change status to \"COMPLETED (YYYY-MM-DD)\"\n\u2610 Update all task rows to \"**Merged** (PR #XXX)\"\n\u2610 Update progress tracking section to \"X/X tasks merged (100%)\"\n\u2610 Add \"Merged PRs\" table with dates\n\n<strong>3. Update INDEX.md</strong>\n\u2610 Mark all addressed backlog items as \"Completed\"\n\u2610 Update Pending/Completed counts\n\u2610 Update sprint assignment line to \"Completed\"\n\u2610 Add changelog entry\n\n<strong>4. Commit Updates</strong>\n</code>bash\ngit add .claude/plans/\ngit commit -m \"docs: mark SPRINT-XXX as complete\"\ngit push\n<code></code>\n\n<strong>Estimated Effort</strong>\n\n\u2022 **Turns:** 2-3\n\u2022 **Tokens:** ~10K\n\u2022 **Time:** 15-20m\n\n---\n\n<strong>References</strong>\n\n\u2022 SPRINT-010 Retrospective (stale sprint file incident)\n\u2022 backlog-maintenance.md Sprint Status Verification section"
  },
  {
    "id": "BACKLOG-125",
    "title": "Enforce Metrics Collection for All Sprints",
    "category": "docs",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~8K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-01",
    "completed_at": "",
    "file": "[BACKLOG-125.md](BACKLOG-125.md)",
    "description": "<strong>Problem Statement</strong>\n\nSPRINT-010 was completed without detailed metrics tracking:\n\u2022 No turn counts per task\n\u2022 No token estimates\n\u2022 No time measurements\n\u2022 This reduces estimation accuracy data for future sprints\n\nHistorical metrics data is critical for improving PM estimates (see INDEX.md Estimation Accuracy Analysis).\n\n<strong>Proposed Solution</strong>\n\nAdd explicit metrics collection requirements to:\n1. Engineer workflow - must report metrics even for \"fast\" sprints\n2. SR Engineer review - verify metrics present before merge approval\n3. PM sprint templates - pre-populate metrics tables\n\n<strong>Deliverables</strong>\n\n1. Update: <code>.claude/agents/engineer.md</code> - Add \"no metrics = no merge\" reminder\n2. Update: <code>.claude/docs/PR-SOP.md</code> - Add metrics verification to checklist\n3. Update: <code>.claude/skills/agentic-pm/templates/</code> - Ensure metrics tables in all templates\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Engineer agent explicitly states metrics are required for ALL tasks\n\u2610 PR-SOP includes \"Engineer Metrics section present\" as blocking check\n\u2610 Sprint templates include pre-formatted metrics tables\n\u2610 Documentation clarifies: fast sprints still need metrics\n\n<strong>Implementation Notes</strong>\n\n<strong>Minimum Metrics Required</strong>\n\nEven for simple tasks, engineers must report:\n\n<code>| Phase | Turns | Tokens | Time |\n|-------|-------|--------|------|\n| Planning | X | ~XK | Xm |\n| Implementation | X | ~XK | Xm |\n| Total | X | ~XK | Xm |\n</code>\n\n<strong>Why This Matters</strong>\n\nWithout metrics from SPRINT-010 (7 UI tasks), we can't update the <code>ui</code> category estimation multiplier in INDEX.md. The category still shows \"TBD - need data\".\n\n<strong>Estimated Effort</strong>\n\n\u2022 **Turns:** 2-3\n\u2022 **Tokens:** ~8K\n\u2022 **Time:** 15-20m\n\n---\n\n<strong>References</strong>\n\n\u2022 SPRINT-010 Retrospective (missing metrics)\n\u2022 INDEX.md Estimation Accuracy Analysis (ui category has no data)\n\u2022 metrics-templates.md"
  },
  {
    "id": "BACKLOG-126",
    "title": "Enforce Debugging Metrics with Commit Verification",
    "category": "docs",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-012",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "TASK-806, PR #262",
    "created_at": "2026-01-01",
    "completed_at": "2026-01-01",
    "file": "[BACKLOG-126.md](BACKLOG-126.md)",
    "description": "<strong>Problem Statement</strong>\n\nTASK-704 took **22 hours** to merge due to CI debugging, but the engineer metrics reported:\n\u2022 Implementation: 4 turns, 30 min\n\u2022 **Debugging: 0**\n\nThe actual debugging effort (~20 turns, ~21 hours, 22 \"fix(ci):\" commits) was completely invisible.\n\n**Root Cause:** The Debugging row EXISTS in our metrics template, but:\n1. Engineers can fill in \"0\" without verification\n2. SR Engineer had no process to cross-check reported debugging against commit history\n3. No threshold defined for when debugging becomes a \"major incident\"\n4. Debugging was done in a separate branch/commit pattern that made it invisible\n\n**Key Insight:** We don't need new fields - we need ENFORCEMENT.\n\n---\n\n<strong>The TASK-704 Pattern (What to Detect)</strong>\n\nThe incident had clear signals that were missed:\n\n| Signal | What Happened | Should Have Triggered |\n|--------|---------------|----------------------|\n| Many fix commits | 22 \"fix(ci):\" commits | >3 fix commits = debugging occurred |\n| Long PR timeline | Created 08:16, merged 06:20 next day | >4h open = investigate |\n| Commit pattern | Sequential fix attempts | Iterative debugging visible in history |\n| Reported vs actual | Debugging: 0 vs 22h actual | Discrepancy = blocker |\n\n---\n\n<strong>Solution: Tiered Debugging Verification Protocol</strong>\n\n<strong>Core Principle: Capture Everything, Block Intelligently</strong>\n\n**Two separate goals:**\n1. **Estimation Accuracy** - Capture ALL debugging effort, even 5 minutes\n2. **Quality Gate** - Block only on clear discrepancies (evidence vs reported)\n\n---\n\n<strong>1. Engineer Responsibility: Track ALL Debugging</strong>\n\n**Any of these = debugging occurred, MUST be recorded:**\n\u2022 CI failure investigation (even if quick fix)\n\u2022 Any commit with \"fix\" in the message\n\u2022 Test failures requiring changes\n\u2022 Type errors after initial implementation\n\u2022 Lint fixes beyond auto-fix\n\u2022 Investigation/troubleshooting (even if no fix commit resulted)\n\u2022 Unexpected issues that required research\n\n**Even small debugging matters for estimation:**\n<code>| Debugging (Debug) | 1 | ~4K | 10 min |  \u2190 This is honest\n| Debugging (Debug) | 0 | 0 | 0 |         \u2190 This should be rare\n</code>\n\n**Rule:** If you made ANY commit after CI failed, Debugging > 0.\n\n---\n\n<strong>2. SR Engineer Verification: Tiered Response</strong>\n\n**Step 1: Collect evidence**\n<code># Count fix commits\nFIX_COUNT=$(git log --oneline origin/develop..HEAD | grep -iE \"fix\" | wc -l)\n\n# Count total commits\nTOTAL_COMMITS=$(git log --oneline origin/develop..HEAD | wc -l)\n\n# Check PR age\nPR_AGE=$(gh pr view --json createdAt --jq '.createdAt')\n</code>\n\n**Step 2: Cross-check with tiered response**\n\n| Fix Commits | Debugging Reported | Response |\n|-------------|-------------------|----------|\n| 0 | 0 | \u2705 **PASS** - Consistent, no debugging needed |\n| 0 | >0 | \u2705 **PASS** - Honest about non-commit debugging (e.g., investigation) |\n| 1-2 | 0 | \u26a0\ufe0f **ASK** - \"These fix commits required no debugging time?\" |\n| 1-2 | >0 | \u2705 **PASS** - Consistent, small debugging captured |\n| 3-5 | 0 | \u274c **BLOCK** - Clear discrepancy, require update |\n| 3-5 | >0 | \u2705 **PASS** - Verify proportional (3 commits \u2248 15+ min typical) |\n| 6+ | any | \ud83d\udccb **INCIDENT REPORT** - Major debugging, document for learning |\n\n**Step 3: Timeline as signal (not blocker)**\n\nPR open time \u2260 work time. Engineers wait for CI, wait for answers, get blocked on dependencies.\n\n| PR Open Time | Use As |\n|--------------|--------|\n| Any duration | **Signal to investigate**, not automatic block |\n\n**If PR open >4h AND Debugging: 0, ASK:**\n\u2022 \"Was there waiting time (CI, blocked, waiting for answer)?\"\n\u2022 \"Were there any unexpected issues that required debugging?\"\n\u2022 \"Did investigation/troubleshooting happen that didn't result in fix commits?\"\n\n**Only block if:** fix commits present + Debugging: 0 (clear discrepancy)\n\n---\n\n<strong>3. Why Track Even Small Debugging?</strong>\n\n**For PM estimation calibration:**\n\nIf TASK-700 estimates \"4-6 turns\" and actual is:\n\u2022 Implementation: 4 turns\n\u2022 Debugging: 0 turns\n\u2022 **Total: 4 turns** \u2192 PM thinks estimate was accurate\n\nBut if actual was:\n\u2022 Implementation: 4 turns\n\u2022 Debugging: 2 turns (CI lint fix, type error)\n\u2022 **Total: 6 turns** \u2192 PM learns debugging overhead is real\n\n**Without capturing small debugging, estimates appear more accurate than they are.**\n\n---\n\n<strong>4. Major Incident Threshold</strong>\n\nAn incident becomes a **Major Incident** requiring special documentation when ANY of:\n\n| Trigger | Threshold |\n|---------|-----------|\n| Debugging time | >2 hours |\n| Fix commits | >5 commits |\n| PR timeline | >8 hours from creation to merge |\n| CI failures | >5 failed CI runs |\n| External blocker | Any (dependency, API, infrastructure) |\n| Scope change | Task redefined mid-implementation |\n\n**Major Incidents require:**\n1. Incident Report section in PR (use template below)\n2. Root cause documented\n3. Prevention recommendations\n4. Backlog item created for systemic issues\n\n---\n\n<strong>Implementation: File Updates Required</strong>\n\n<strong>Update 1: <code>.claude/docs/PR-SOP.md</code></strong>\n\nAdd to **Phase 9: Pre-Merge Checklist**:\n\n<code><strong>9.4 Debugging Metrics Verification (MANDATORY)</strong>\n\nBefore merging, SR Engineer MUST verify debugging metrics are accurately captured.\n\n**Goal:** Capture ALL debugging for estimation accuracy, block only on clear discrepancies.\n\n**Step 1: Collect evidence**\n</code>bash\n# Count fix commits\nFIX_COUNT=$(git log --oneline origin/develop..HEAD | grep -iE \"fix\" | wc -l)\necho \"Fix commits: $FIX_COUNT\"\n\n# Check PR age\ngh pr view --json createdAt --jq '.createdAt'\n<code>\n**Step 2: Tiered response based on evidence vs reported**\n\n| Fix Commits | Debugging Reported | Response |\n|-------------|-------------------|----------|\n| 0 | 0 | \u2705 PASS |\n| 0 | >0 | \u2705 PASS (honest about investigation time) |\n| 1-2 | 0 | \u26a0\ufe0f ASK engineer: \"These fix commits took 0 debugging time?\" |\n| 1-2 | >0 | \u2705 PASS |\n| 3-5 | 0 | \u274c BLOCK - Require metrics update before merge |\n| 3-5 | >0 | \u2705 PASS (verify roughly proportional) |\n| 6+ | any | \ud83d\udccb INCIDENT REPORT required |\n\n**Step 3: Timeline as signal (not blocker)**\n\nPR open time \u2260 work time. Engineers wait for CI, answers, dependencies.\n\n| PR Open | Debugging: 0? | Response |\n|---------|---------------|----------|\n| Any | Yes | **Investigate if fix commits present** |\n\n**If PR >4h AND Debugging: 0, ASK:**\n\u2022 \"Was there waiting time (CI, blocked, waiting for answer)?\"\n\u2022 \"Were there any unexpected issues that required debugging?\"\n\u2022 \"Did investigation/troubleshooting happen that didn't result in fix commits?\"\n\n**Only block if:** fix commits present + Debugging: 0 (clear discrepancy)\n\n**Why this matters:** Without accurate debugging metrics, PM estimates appear more accurate than they are. Even 10 minutes of debugging affects estimation calibration.\n</code>\n\n<strong>Update 2: <code>.claude/agents/engineer.md</code></strong>\n\nAdd to **Step 6: Wait for CI and Debug**:\n\n<code><strong>ALL Debugging Must Be Tracked (Non-Negotiable)</strong>\n\n**Debugging = any work after initial implementation to fix issues.**\n\nTrack debugging if ANY of these occurred:\n\u2022 CI failed and you made changes\n\u2022 Type-check failed after implementation\n\u2022 Tests failed and required fixes\n\u2022 Lint errors beyond auto-fix\n\u2022 ANY commit with \"fix\" in the message\n\n**Even small debugging counts:**\n</code>markdown\n| Debugging (Debug) | 1 | ~4K | 10 min |  \u2190 Honest (CI lint fix)\n| Debugging (Debug) | 0 | 0 | 0 |         \u2190 Should be rare\n<code>\n**Rule:** If you committed after CI failed, Debugging > 0.\n\n**SR Engineer will verify:**\n</code>bash\ngit log --oneline origin/develop..HEAD | grep -iE \"fix\" | wc -l\n<code>\n**Consequences:**\n\u2022 1-2 fix commits + Debugging: 0 \u2192 SR will ask for clarification\n\u2022 3+ fix commits + Debugging: 0 \u2192 PR blocked until updated\n\u2022 6+ fix commits \u2192 Incident Report required\n\n<strong>Why This Matters for You</strong>\n\nTracking debugging helps PM improve estimates. If debugging is hidden:\n\u2022 PM thinks \"4 turn estimate\" was accurate when it took 6\n\u2022 Future similar tasks get underestimated\n\u2022 You get blamed for being \"slow\" when debugging was real work\n\n**Accurate metrics protect your time estimates.**\n\n<strong>Major Incident Triggers</strong>\n\nDocument as Major Incident when ANY occur:\n\u2022 Debugging takes >2 hours\n\u2022 You make >5 fix commits\n\u2022 CI fails >5 times on same issue\n\u2022 External blocker (dependency, API, infrastructure)\n\n[Major Incident Template - same as before]\n</code>\n\n<strong>Update 3: <code>.claude/docs/shared/metrics-templates.md</code></strong>\n\nAdd to **Validation Rules** section:\n\n<code><strong>Debugging Metrics: Capture Everything</strong>\n\n**Debugging is rarely 0.** Most tasks involve at least one CI fix, lint correction, or type error.\n\n**What counts as debugging:**\n\u2022 Any commit with \"fix\" in message\n\u2022 CI investigation time (even if quick)\n\u2022 Type errors after implementation\n\u2022 Test fixes\n\u2022 Lint fixes beyond auto-fix\n\n**Honest example:**\n</code>markdown\n| Phase | Turns | Tokens | Active Time |\n|-------|-------|--------|-------------|\n| Implementation (Impl) | 4 | ~16K | 25 min |\n| Debugging (Debug) | 1 | ~4K | 10 min |  \u2190 CI lint fix\n| **Engineer Total** | 5 | ~20K | 35 min |\n<code>\n<strong>SR Engineer Verification</strong>\n\nBefore merge, check for discrepancies:\n\n</code>bash\nFIX_COUNT=$(git log --oneline origin/develop..HEAD | grep -iE \"fix\" | wc -l)\nPR_AGE=$(gh pr view --json createdAt --jq '.createdAt')\n<code>\n**Tiered response:**\n\u2022 1-2 fix commits + Debugging: 0 \u2192 Ask\n\u2022 3+ fix commits + Debugging: 0 \u2192 Block\n\u2022 6+ fix commits \u2192 Incident Report required\n\u2022 Long PR + fix commits + Debugging: 0 \u2192 Investigate (PR time \u2260 work time)\n</code>\n\n---\n\n<strong>Why This Works</strong>\n\n| Gap in TASK-704 | How This Fixes It |\n|-----------------|-------------------|\n| Debugging reported as 0 | SR Engineer cross-checks with git log |\n| 22 fix commits not flagged | 6+ commits triggers incident report |\n| 22h timeline not questioned | Long PR + fix commits = investigate |\n| Small debugging hidden too | 1-2 fix commits prompts clarification |\n| No incident documentation | Major Incident threshold requires report |\n| Metrics not enforced | Tiered response: ask \u2192 block \u2192 incident |\n\n**Key Principles:**\n\n1. **Capture everything** - Even 1 fix commit should prompt \"is debugging really 0?\"\n2. **Block intelligently** - Only block on clear discrepancies (3+ commits, 0 reported)\n3. **Don't create friction** - Ask first for small discrepancies, block for clear ones\n4. **Use objective data** - Git history and PR age, not just self-reporting\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 PR-SOP Phase 9 includes tiered debugging verification (ask/block/incident)\n\u2610 engineer.md states ALL debugging must be tracked (even small)\n\u2610 engineer.md explains WHY tracking helps engineer (better estimates)\n\u2610 metrics-templates.md clarifies \"Debugging: 0 should be rare\"\n\u2610 Tiered response defined: 1-2 commits = ask, 3+ = block, 6+ = incident\n\u2610 Timeline used as signal to investigate (not automatic blocker)\n\u2610 Major Incident template provided\n\u2610 SR Engineer verification uses git commands (objective data)\n\n---\n\n<strong>Estimated Effort</strong>\n\n\u2022 **Turns:** 4-6\n\u2022 **Tokens:** ~20K\n\u2022 **Time:** 30-45m\n\n---\n\n<strong>References</strong>\n\n\u2022 TASK-704 CI incident (22 hours, 22 fix commits, reported as Debugging: 0)\n\u2022 BACKLOG-120 (CI Testing Infrastructure Gaps - created from incident)\n\u2022 SPRINT-010 Retrospective\n\u2022 <code>.claude/docs/shared/metrics-templates.md</code> (already has Debugging row)\n\u2022 <code>.claude/agents/engineer.md</code> (already mentions debugging tracking)\n\n---\n\n<strong>Example: What TASK-704 Should Have Looked Like</strong>\n\nIf this process had been in place:\n\n**Engineer Metrics (Correct):**\n<code>| Phase | Turns | Tokens | Active Time |\n|-------|-------|--------|-------------|\n| Planning (Plan) | 1 | ~4K | 5 min |\n| Implementation (Impl) | 4 | ~16K | 30 min |\n| Debugging (Debug) | 20 | ~80K | 21 hours |\n| **Engineer Total** | 25 | ~100K | 22 hours |\n\n<strong>Major Incident Report</strong>\n\n**Type:** CI Failure\n**Duration:** 21 hours\n**Fix Commits:** 22\n**CI Failures:** 15+\n\n<strong>Timeline</strong>\n\u2022 08:16: PR created, CI fails on test hang\n\u2022 09:00: Identified Jest not exiting\n\u2022 12:00: Tried --forceExit, fake timer cleanup\n\u2022 18:00: Excluded integration tests\n\u2022 06:00 next day: Narrowed to ContactSelectModal.test.tsx\n\u2022 06:11: Final fix, CI passes\n\n<strong>Root Cause</strong>\nMock classes using EventEmitter + setTimeout kept Node.js event loop alive.\nNative modules compiled for Electron incompatible with Jest/Node.js.\n\n<strong>Resolution</strong>\nSkip problematic tests in CI (documented in BACKLOG-120).\n\n<strong>Prevention</strong>\n1. Created BACKLOG-120 for CI infrastructure improvement\n2. Added test isolation verification to CI\n</code>\n\n**SR Engineer Verification Would Have Caught:**\n<code>$ git log --oneline origin/develop..HEAD | grep -E \"fix\" | wc -l\n22  # \u274c BLOCK: 22 fix commits but Debugging: 0\n\n$ gh pr view --json createdAt\n# Created 08:16, now 06:20 next day = 22 hours\n# \u274c BLOCK: PR open >8h but Debugging: 0\n</code>"
  },
  {
    "id": "BACKLOG-127",
    "title": "Add Sprint Capacity Limits to PM Workflow",
    "category": "docs",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-012",
    "est_tokens": "~6K",
    "actual_tokens": "-",
    "variance": "TASK-807, PR #262",
    "created_at": "2026-01-01",
    "completed_at": "2026-01-01",
    "file": "[BACKLOG-127.md](BACKLOG-127.md)",
    "description": "<strong>Problem Statement</strong>\n\nSPRINT-010 had 7 tasks planned but only 4 were completed. The remaining 3 (TASK-703, 704, 706) were deferred because:\n1. Sequential task chains blocked on each other\n2. Combined with parallel SPRINT-011 execution, capacity was exceeded\n3. No documented guidance on sprint capacity limits\n\n**Evidence from SPRINT-010 Retro:**\n> \"Original plan: 7 tasks, 45-69 turns estimated. Executed: 4 tasks in Batch 1. Deferred: 3 tasks (TASK-703, 704, 706) - all sequential dependencies.\"\n\n---\n\n<strong>Proposed Solution</strong>\n\nAdd explicit sprint capacity guidelines to prevent scope overflow.\n\n<strong>Deliverables</strong>\n\n1. Update: <code>.claude/skills/agentic-pm/modules/sprint-selection.md</code> - Add capacity guidelines section\n\n<strong>Implementation Notes</strong>\n\n<strong>Proposed Content</strong>\n\n<code><strong>Sprint Capacity Guidelines</strong>\n\n| Sprint Type | Max Tasks | Max Sequential Chain |\n|-------------|-----------|----------------------|\n| Solo sprint | 5-7 tasks | 2-3 sequential |\n| Parallel sprints | 4-5 per sprint | 1-2 sequential |\n\n<strong>Rules</strong>\n\n1. **Sequential chains beyond 2 tasks should be separate sprints**\n   - Each task in a chain blocks the next\n   - Risk of deferral compounds with chain length\n\n2. **When running parallel sprints, reduce capacity**\n   - Context switching overhead\n   - Merge conflict risk increases\n   - CI queue congestion\n\n3. **Stretch goals should be explicitly marked**\n   - Tasks 6-7 in a 7-task sprint = stretch\n   - Don't count stretch goals in commitment\n\n<strong>Example</strong>\n\n**Good sprint structure:**\n\u2022 4 parallel tasks (Batch 1)\n\u2022 2 sequential tasks (Batch 2, depends on 1 task from Batch 1)\n\u2022 1 stretch goal (explicitly marked)\n\n**Risky sprint structure:**\n\u2022 3 parallel tasks\n\u2022 4 sequential tasks (chain of 4)  \u2190 Too long, split into 2 sprints\n</code>\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 sprint-selection.md includes Sprint Capacity Guidelines section\n\u2610 Guidelines specify max tasks for solo vs parallel sprints\n\u2610 Guidelines specify max sequential chain length\n\u2610 Stretch goal marking guidance included\n\u2610 Example good/risky structure provided\n\n---\n\n<strong>Estimated Effort</strong>\n\n\u2022 **Turns:** 1-2\n\u2022 **Tokens:** ~6K\n\u2022 **Time:** 10-15m\n\n---\n\n<strong>References</strong>\n\n\u2022 SPRINT-010 Retrospective: Pattern 1 (Sprint Scope Overflow)\n\u2022 SPRINT-010-phase-retro-report.md: Proposal 1"
  },
  {
    "id": "BACKLOG-128",
    "title": "Add Type Verification Checklist for Fixture Tasks",
    "category": "docs",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-012",
    "est_tokens": "~6K",
    "actual_tokens": "-",
    "variance": "TASK-808, PR #262",
    "created_at": "2026-01-01",
    "completed_at": "2026-01-01",
    "file": "[BACKLOG-128.md](BACKLOG-128.md)",
    "description": "<strong>Problem Statement</strong>\n\nTASK-800 (Email Fixtures) used invalid TransactionStage values that caused CI failures:\n\u2022 Used: <code>initial_contact</code>, <code>negotiation</code>, <code>contract</code>\n\u2022 Actual type: <code>intro</code>, <code>showing</code>, <code>offer</code>, <code>inspections</code>, <code>escrow</code>, <code>closing</code>, <code>post_closing</code>\n\nThe engineer assumed reasonable-sounding values without verifying against the actual TypeScript type definition.\n\n**Evidence from SPRINT-011 Retro:**\n> \"Engineer assumed transaction stage values without verifying against actual TypeScript type definition. Reasonable-sounding values were invented rather than verified.\"\n\n---\n\n<strong>Proposed Solution</strong>\n\nAdd a Type Verification Checklist to the fixture task template so engineers verify enum values before committing.\n\n<strong>Deliverables</strong>\n\n1. Update: <code>.claude/skills/agentic-pm/modules/task-file-authoring.md</code> - Add fixture task section\n\n<strong>Implementation Notes</strong>\n\n<strong>Proposed Content</strong>\n\n<code><strong>Fixture Task Template Additions</strong>\n\n<strong>Type Verification Checklist (Required for Fixture Tasks)</strong>\n\nBefore committing fixture data, verify:\n\n\u2610 All enum values match actual TypeScript definitions\n\u2610 Import types from source files (do NOT hardcode values)\n\u2610 Run <code>npm run type-check</code> before committing fixture data\n\u2610 File paths to type definitions included in task acceptance criteria\n\n<strong>How to Verify Enum Values</strong>\n\n</code>bash\n# Find the type definition\ngrep -rn \"type TransactionStage\" --include=\"*.ts\" src/ electron/\n\n# Or check the exact file\ncat electron/services/types.ts | grep -A 10 \"TransactionStage\"\n<code>\n<strong>PM Responsibility</strong>\n\nWhen creating fixture tasks, PM MUST:\n1. Include exact enum values in task file (not \"use appropriate values\")\n2. Provide file path to type definition\n3. Add type-check to acceptance criteria\n\n<strong>Example</strong>\n\n**Bad task spec:**\n> \"Use appropriate transaction stages for the test emails\"\n\n**Good task spec:**\n> \"Use TransactionStage values from <code>electron/services/types.ts</code>:\n> - Valid values: <code>intro</code>, <code>showing</code>, <code>offer</code>, <code>inspections</code>, <code>escrow</code>, <code>closing</code>, <code>post_closing</code>\n> - Do NOT use: <code>initial_contact</code>, <code>negotiation</code>, <code>contract</code> (these don't exist)\"\n</code>\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 task-file-authoring.md includes Fixture Task Template section\n\u2610 Type Verification Checklist with 4 items included\n\u2610 How to verify enum values (grep command) included\n\u2610 PM responsibility section added\n\u2610 Good/bad example provided\n\n---\n\n<strong>Estimated Effort</strong>\n\n\u2022 **Turns:** 1-2\n\u2022 **Tokens:** ~6K\n\u2022 **Time:** 10-15m\n\n---\n\n<strong>References</strong>\n\n\u2022 SPRINT-011 Retrospective: Pattern 3 (Type Alignment Gaps)\n\u2022 SPRINT-011-phase-retro-report.md: Proposal 1\n\u2022 TASK-800: Required fix commit for TransactionStage type alignment"
  },
  {
    "id": "BACKLOG-129",
    "title": "Create CI Troubleshooting Documentation",
    "category": "docs",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-012",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "TASK-809, PR #262",
    "created_at": "2026-01-01",
    "completed_at": "2026-01-01",
    "file": "[BACKLOG-129.md](BACKLOG-129.md)",
    "description": "<strong>Problem Statement</strong>\n\nTASK-700 (PR #249) was delayed 30+ minutes due to stuck CI:\n\u2022 Pull request-triggered runs queued for 15+ minutes\n\u2022 Required 4 CI retriggerings\n\u2022 Ultimately required admin merge\n\nThere was no documented escalation path for stuck CI, causing engineers to waste time on ad-hoc solutions.\n\n**Evidence from SPRINT-011 Retro:**\n> \"TASK-700 PR #249 took 30+ extra minutes due to lack of clear escalation path.\"\n\n---\n\n<strong>Proposed Solution</strong>\n\nCreate CI troubleshooting documentation with clear escalation steps for common issues.\n\n<strong>Deliverables</strong>\n\n1. New file: <code>.claude/docs/shared/ci-troubleshooting.md</code>\n2. Update: <code>CLAUDE.md</code> - Add reference to CI troubleshooting doc\n\n<strong>Implementation Notes</strong>\n\n<strong>Proposed Content for ci-troubleshooting.md</strong>\n\n<code># CI Troubleshooting Guide\n\n<strong>Stuck Tests (Pending for 10+ Minutes)</strong>\n\n<strong>Step 1: Cancel and Retrigger</strong>\n</code>bash\n# Find the stuck run ID\ngh run list --branch <your-branch> --limit 5\n\n# Cancel the stuck run\ngh run cancel <run-id>\n\n# Push empty commit to retrigger\ngit commit --allow-empty -m \"chore: retrigger CI\" && git push\n<code>\n<strong>Step 2: If Still Stuck After 2 Retries</strong>\n</code>bash\n# Use admin merge (requires repo admin permissions)\ngh pr merge <PR-NUMBER> --merge --admin\n<code>\n**IMPORTANT:** Document admin merge in PR comments explaining why it was needed.\n\n<strong>Step 3: Report Recurring Issues</strong>\nIf CI gets stuck repeatedly on the same PR:\n1. Check for test flakiness\n2. Check for resource-intensive tests\n3. Consider splitting large PRs\n4. Report to team if systemic\n\n---\n\n<strong>Common CI Failures</strong>\n\n<strong>TypeScript Compilation Errors</strong>\n</code>bash\n# Run locally to see full error\nnpm run type-check\n<code>\n<strong>Lint Errors</strong>\n</code>bash\n# Auto-fix most issues\nnpm run lint -- --fix\n<code>\n<strong>Test Failures</strong>\n</code>bash\n# Run specific test file\nnpm test -- --testPathPattern=<filename>\n\n# Run with verbose output\nnpm test -- --verbose\n<code>\n<strong>Native Module Errors (NODE_MODULE_VERSION mismatch)</strong>\n</code>bash\nnpm rebuild better-sqlite3-multiple-ciphers\nnpx electron-rebuild\n<code>\n---\n\n<strong>CI Queue Congestion</strong>\n\nGitHub Actions free tier has limited concurrent runners.\n\n**Symptoms:**\n\u2022 Jobs queued for 10+ minutes\n\u2022 Push-triggered runs complete faster than PR-triggered runs\n\n**Mitigations:**\n\u2022 Cancel stuck runs before retriggering\n\u2022 Avoid pushing multiple commits in rapid succession\n\u2022 Consider off-peak hours for large PR batches\n\n---\n\n<strong>When to Use Admin Merge</strong>\n\nUse <code>gh pr merge --admin</code> when:\n\u2610 CI has been stuck 15+ minutes\n\u2610 You've tried 2+ retrigger attempts\n\u2610 The failure is CI infrastructure, not code\n\u2610 You've documented the reason in PR comments\n\n**DO NOT use admin merge when:**\n\u2022 Tests are actually failing\n\u2022 Type-check or lint errors exist\n\u2022 You haven't tried retrigger first\n</code>\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 ci-troubleshooting.md created with stuck test escalation steps\n\u2610 Common CI failures section with solutions\n\u2610 CI queue congestion explanation included\n\u2610 Admin merge guidelines (when to use, when not to use)\n\u2610 CLAUDE.md updated with reference to new doc\n\n---\n\n<strong>Estimated Effort</strong>\n\n\u2022 **Turns:** 2-3\n\u2022 **Tokens:** ~10K\n\u2022 **Time:** 15-20m\n\n---\n\n<strong>References</strong>\n\n\u2022 SPRINT-011 Retrospective: Pattern 1 (CI Queue Congestion)\n\u2022 SPRINT-011-phase-retro-report.md: Proposal 2\n\u2022 SPRINT-011-completion-report.md: CI Failures section\n\u2022 TASK-700 (PR #249): Admin merge required after 4 retrigger attempts"
  },
  {
    "id": "BACKLOG-130",
    "title": "Sub-Agent Permission Auto-Denial Incident",
    "category": "docs",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-012",
    "est_tokens": "~8K",
    "actual_tokens": "-",
    "variance": "TASK-810, PR #262",
    "created_at": "2026-01-01",
    "completed_at": "2026-01-01",
    "file": "[BACKLOG-130.md](BACKLOG-130.md)",
    "description": "<strong>Incident Summary</strong>\n\nDuring SPRINT-012 execution, 5 engineer sub-agents were spawned in parallel to implement documentation tasks. All 5 agents entered infinite retry loops due to tool permissions being auto-denied, burning approximately **9.6 million tokens** before the issue was identified.\n\n---\n\n<strong>Timeline</strong>\n\n| Time | Event |\n|------|-------|\n| T+0 | PM created SPRINT-012 with 5 documentation tasks |\n| T+5m | SR Engineer approved sprint plan |\n| T+7m | 5 engineer agents spawned in parallel with worktrees |\n| T+10m | First status check: all agents \"running\", reading files |\n| T+15m | Second status check: agents still running, high token counts |\n| T+25m | Investigation: agents stuck in retry loops |\n| T+30m | Root cause identified: permission auto-denial |\n\n---\n\n<strong>Root Cause Analysis</strong>\n\n<strong>What Happened</strong>\n\n1. Engineer agents were spawned using <code>Task</code> tool with <code>subagent_type=\"engineer\"</code>\n2. Agents read task files and target files successfully (Read tool works)\n3. Agents attempted to use Edit/Write tools to make changes\n4. **Tool permissions were auto-denied** with message: \"Permission to use [Tool] has been auto-denied (prompts unavailable)\"\n5. Agents retried the same operation repeatedly, burning tokens each time\n6. No error surfaced to the parent conversation - agents appeared to be \"running\"\n\n<strong>Why It Happened</strong>\n\n\u2022 Sub-agents run in background mode (<code>run_in_background: true</code>)\n\u2022 Write/Edit tools require user approval (interactive prompt)\n\u2022 Background agents cannot display interactive prompts to the user\n\u2022 The system auto-denies permissions instead of failing cleanly\n\u2022 Agents have no circuit breaker to stop after N failed attempts\n\n<strong>Evidence</strong>\n\nAgent output logs show repeated identical tool calls:\n<code>[Tool: Write] {\"file_path\":\"...\",\"content\":\"...\"}\n[Tool: Write] {\"file_path\":\"...\",\"content\":\"...\"}  # Same content\n[Tool: Write] {\"file_path\":\"...\",\"content\":\"...\"}  # Same content\n... (15+ times)\n</code>\n\n---\n\n<strong>Impact</strong>\n\n<strong>Token Waste</strong>\n\n| Agent | Task | Tokens Burned |\n|-------|------|---------------|\n| a331a5d | TASK-805 | ~68,000 |\n| a51d515 | TASK-806 | ~1,050,000 |\n| a08af27 | TASK-807 | ~3,500,000 |\n| a4b6a5a | TASK-808 | ~3,400,000 |\n| a2ba871 | TASK-809 | ~1,600,000 |\n| **Total** | | **~9,618,000** |\n\n<strong>Time Waste</strong>\n\n\u2022 ~30 minutes of wall-clock time spent on failed execution\n\u2022 Investigation and documentation: ~15 minutes\n\u2022 Total: ~45 minutes of debugging\n\n<strong>Tasks Blocked</strong>\n\nAll 5 SPRINT-012 tasks remain unimplemented:\n\u2022 TASK-805: Debugging Metrics Enforcement\n\u2022 TASK-806: Sprint Completion Checklist\n\u2022 TASK-807: Sprint Capacity Limits\n\u2022 TASK-808: Type Verification Checklist\n\u2022 TASK-809: CI Troubleshooting Docs\n\n---\n\n<strong>Immediate Resolution</strong>\n\n1. Cancel/ignore stuck sub-agents\n2. Clean up orphaned worktrees\n3. Implement tasks directly in parent conversation (has permissions)\n4. Document this incident for future prevention\n\n---\n\n<strong>Prevention Recommendations</strong>\n\n<strong>Short-term (Workaround)</strong>\n\n1. **Don't use background agents for write operations** - Only use <code>run_in_background: true</code> for read-only tasks (exploration, search, analysis)\n2. **Use foreground agents for implementation** - Run engineer agents without <code>run_in_background</code> so they can prompt for permissions\n3. **Add explicit guidance to engineer.md** - Warn about this limitation\n\n<strong>Medium-term (Process)</strong>\n\n1. **Pre-flight permission check** - Before spawning implementation agents, verify required tools are pre-approved\n2. **Agent circuit breaker** - Add retry limits to agent prompts (\"if tool fails 3 times, report error and stop\")\n3. **Token budgets per agent** - Set maximum token spend per sub-agent\n\n<strong>Recommended Fix (Configuration)</strong>\n\n**Pre-approve Write/Edit for engineer agents in project settings.**\n\nRationale: Since ALL engineer work goes through SR Engineer review before merge, the quality gate is at PR review, not at tool execution. Pre-approving these tools:\n\u2022 Eliminates permission prompts that can't be shown to background agents\n\u2022 Maintains safety through mandatory SR Engineer PR review\n\u2022 Enables parallel agent execution for multi-task sprints\n\nImplementation:\n<code># In .claude/settings.json or project config\n{\n  \"allowedTools\": [\"Write\", \"Edit\", \"Bash\"]\n}\n</code>\n\n<strong>Long-term (Infrastructure)</strong>\n\n1. **Sub-agent permission inheritance** - Allow parent conversation permissions to flow to sub-agents\n2. **Clean failure mode** - When permissions are denied, agent should error cleanly instead of retrying\n3. **Progress visibility** - Surface permission denials to parent conversation immediately\n\n---\n\n<strong>Backlog Items Created</strong>\n\n| ID | Title | Priority |\n|----|-------|----------|\n| BACKLOG-130 | This incident report | High |\n| (pending) | Add sub-agent permission guidance to engineer.md | Medium |\n| (pending) | Add retry limits to agent prompts | Medium |\n\n---\n\n<strong>Lessons Learned</strong>\n\n1. **Background agents can't write** - Permission prompts require foreground execution\n2. **Token waste accumulates silently** - No visibility into sub-agent spend until manual check\n3. **Parallel execution amplifies problems** - 5 agents failing = 5x token waste\n4. **Documentation tasks are ironic** - A sprint to improve process documentation was blocked by a process gap\n\n---\n\n<strong>Cross-References</strong>\n\n\u2022 Sprint: <code>SPRINT-012-process-docs-improvements.md</code>\n\u2022 Related: BACKLOG-126 (debugging metrics) - would have caught this if implemented\n\u2022 Agent docs: <code>.claude/agents/engineer.md</code>\n\n---\n\n<strong>Changelog</strong>\n\n\u2022 2026-01-01: Created incident report"
  },
  {
    "id": "BACKLOG-131",
    "title": "Fix PR Metrics Validation Shell Escaping Bug",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-131.md](items/BACKLOG-131.md)",
    "description": "<strong>Problem</strong>\n\nThe <code>pr-metrics-check.yml</code> workflow uses direct string interpolation for the PR body:\n\n<code>\u2022 name: Validate Engineer Metrics Section\n  run: |\n    PR_BODY='${{ github.event.pull_request.body }}'\n</code>\n\nThis breaks when the PR body contains:\n\u2022 Single quotes (escapes the shell string)\n\u2022 Parentheses (can be interpreted as subshell)\n\u2022 Other special shell characters\n\n<strong>Error Observed</strong>\n\n<code>Try 'write --help' for more information.\n##[error]Process completed with exit code 1.\n</code>\n\nAll 5 validation checks passed, but shell parsing failed at the end.\n\n---\n\n<strong>Root Cause</strong>\n\nGitHub Actions interpolates <code>${{ github.event.pull_request.body }}</code> directly into the shell script. Characters like <code>'</code>, <code>(</code>, <code>)</code>, <code>;</code> in the PR body can break shell parsing.\n\n---\n\n<strong>Fix</strong>\n\nUse environment variables instead of direct interpolation:\n\n<code>\u2022 name: Validate Engineer Metrics Section\n  if: steps.skip-check.outputs.skip != 'true'\n  env:\n    PR_BODY: ${{ github.event.pull_request.body }}\n  run: |\n    echo \"=== Validating PR Metrics ===\"\n    # Now $PR_BODY is a proper environment variable, not interpolated text\n    if [[ ! \"$PR_BODY\" =~ \"## Engineer Metrics\" ]]; then\n      ...\n</code>\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>pr-metrics-check.yml</code> uses env variables for PR body\n\u2610 Special characters in PR body don't break validation\n\u2610 All 5 validation checks still work correctly\n\u2610 Test with a PR body containing: <code>'</code>, <code>(</code>, <code>)</code>, <code>$</code>, backticks\n\n---\n\n<strong>Workaround</strong>\n\nUntil fixed, PRs can use:\n\u2022 <code>ci-fix</code> label to skip validation\n\u2022 <code>[skip-metrics]</code> in PR title\n\n---\n\n<strong>References</strong>\n\n\u2022 Affected file: <code>.github/workflows/pr-metrics-check.yml</code>\n\u2022 Related PR: #262 (required <code>ci-fix</code> label as workaround)\n\u2022 GitHub Actions docs: Using environment variables is safer than direct interpolation"
  },
  {
    "id": "BACKLOG-132",
    "title": "Mandatory Worktree for Parallel/Background Agents",
    "category": "docs",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-015",
    "est_tokens": "~5K",
    "actual_tokens": "~23K",
    "variance": "+360%",
    "created_at": "2026-01-02",
    "completed_at": "2026-01-02",
    "file": "[BACKLOG-132.md](BACKLOG-132.md)",
    "description": "<strong>Problem Statement</strong>\n\nTwo engineer agents (TASK-906 and TASK-908) were spawned to run in parallel but BOTH worked in the same directory (<code>/Users/daniel/Documents/Mad</code>). This caused:\n\n1. **File conflicts** - Both agents editing the same files\n2. **Edit tool failures** - Strings changed by one agent, causing match failures for the other\n3. **Retry loops** - Agents retrying failed edits hundreds of times\n4. **Massive token burn** - ~18M tokens consumed vs ~35K estimated (500x overrun)\n\n<strong>Root Cause</strong>\n\nThe <code>engineer.md</code> instructions say:\n> \"Worktree Workflow **(when PM specifies parallel execution)**\"\n\nThis made worktrees **opt-in** rather than **mandatory** for background agents. The PM didn't explicitly specify worktrees, so agents used the \"Standard Workflow\" (same directory).\n\n---\n\n<strong>Solution</strong>\n\n<strong>1. Make Worktree MANDATORY for Background Agents</strong>\n\n**Change engineer.md rule from:**\n> \"when PM specifies parallel execution\"\n\n**To:**\n> \"ALWAYS use worktrees when running as a background agent (run_in_background: true)\"\n\n<strong>2. Add Pre-Flight Directory Check</strong>\n\nBefore ANY file modifications, background agents MUST:\n\n<code># MANDATORY PRE-FLIGHT CHECK\n# If cwd is /path/to/Mad (main repo), STOP and create worktree first\nif [[ \"$(pwd)\" == *\"/Mad\" ]] && [[ ! \"$(pwd)\" == *\"/Mad-task-\"* ]]; then\n  echo \"ERROR: Cannot work in main repo directory. Create worktree first.\"\n  exit 1\nfi\n</code>\n\n<strong>3. PM Must Include Worktree Path in Agent Prompt</strong>\n\nWhen spawning engineer agents for parallel work, PM MUST specify:\n\n<code>**MANDATORY: Create worktree at /path/to/Mad-task-XXX BEFORE any implementation**\n</code>\n\n<strong>4. Agent Self-Check at Start</strong>\n\nEngineer agent must verify isolation BEFORE any work:\n\n<code><strong>Pre-Implementation Checklist</strong>\n\u2610 Working directory is NOT the main repo\n\u2610 Working directory is /path/to/Mad-task-XXX (isolated worktree)\n\u2610 <code>git worktree list</code> shows my worktree\n\u2610 No other agent is working in this directory\n</code>\n\n---\n\n<strong>Implementation Tasks</strong>\n\n1. **Update <code>.claude/agents/engineer.md</code>:**\n   - Change \"when PM specifies\" to \"ALWAYS when background agent\"\n   - Add mandatory pre-flight directory check\n   - Add blocking rule: \"If in main repo, STOP immediately\"\n\n2. **Update PM workflow documentation:**\n   - Add explicit worktree path to agent spawn prompts\n   - Add verification step after spawning agents\n\n3. **Add to CLAUDE.md (project instructions):**\n   - Add warning about parallel agent race conditions\n   - Reference this incident\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2611 Engineer agents running in background ALWAYS create worktrees\n\u2611 Engineer agents BLOCK if they detect they're in the main repo directory\n\u2611 PM spawn prompts include explicit worktree path\n\u2610 No future incidents of multiple agents in same directory (ongoing)\n\n---\n\n<strong>Incident Cost</strong>\n\n| Metric | Estimated | Actual | Overrun |\n|--------|-----------|--------|---------|\n| TASK-906 tokens | ~20K | ~4.9M | 245x |\n| TASK-908 tokens | ~15K | ~13.4M | 893x |\n| **Combined** | ~35K | ~18M | **514x** |\n\n**Estimated cost:** ~$50-100+ in token usage for work that should have cost <$0.50\n\n---\n\n<strong>References</strong>\n\n\u2022 SPRINT-014 Batch 2 incident\n\u2022 BACKLOG-130 (Sub-Agent Permission Auto-Denial) - similar class of agent workflow failure\n\u2022 <code>.claude/agents/engineer.md</code> lines 109-131 (current worktree instructions)"
  },
  {
    "id": "BACKLOG-133",
    "title": "Engineer Token Cap with Early Reporting",
    "category": "docs",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-015",
    "est_tokens": "~10K",
    "actual_tokens": "~800K-1.1M",
    "variance": "~100x",
    "created_at": "2026-01-02",
    "completed_at": "2026-01-02",
    "file": "TASK-914",
    "description": "<strong>Problem Statement</strong>\n\nEngineers can consume excessive tokens without early detection. In past incidents:\n\u2022 TASK-906/908 race condition: ~18M tokens (BACKLOG-132)\n\u2022 TASK-909 original run: ~2.7M tokens (CI wait loops)\n\nWe need automatic detection and reporting when engineers exceed expected token usage.\n\n<strong>Proposed Solution</strong>\n\nAdd token cap logic to <code>engineer.md</code> agent prompt:\n\n<strong>4x Token Cap Rule</strong>\n\n<code>If estimated tokens = X, then soft cap = 4X\n\nWhen engineer reaches 4x estimated tokens:\n1. STOP current work\n2. Report status to PM:\n   - Work completed so far\n   - Current token count vs estimate\n   - Remaining work\n   - Reason for overconsumption (if known)\n3. Wait for PM decision:\n   - Continue (with new cap)\n   - Abort and review\n</code>\n\n<strong>Implementation</strong>\n\n1. **Task file requirement**: All tasks must have <code>**Estimated:** X turns, ~YK tokens, Z min</code>\n2. **Engineer prompt update**: Add token tracking and cap logic\n3. **PM prompt update**: Handle token cap reports\n\n<strong>Example Task File Section</strong>\n\n<code>**Estimated:** 3-4 turns, ~15K tokens, 15-20 min\n**Token Cap:** 60K (4x upper estimate)\n</code>\n\n<strong>Example Engineer Report</strong>\n\n<code><strong>TOKEN CAP REACHED</strong>\n\n**Task:** TASK-XXX\n**Estimated:** 15K tokens\n**Current:** 60K tokens (4x cap hit)\n\n<strong>Progress</strong>\n\u2611 Step 1 complete\n\u2611 Step 2 complete\n\u2610 Step 3: stuck on X\n\n<strong>Reason for Overconsumption</strong>\nEncountered unexpected issue: [description]\n\n<strong>Options</strong>\n1. Continue with additional 30K token budget\n2. Abort and investigate root cause\n3. Hand off to different approach\n\n**Awaiting PM decision.**\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Engineer.md updated with token cap logic\n\u2610 Task template includes token cap field\n\u2610 PM receives and can act on token cap reports\n\u2610 Documentation updated with token cap workflow\n\n<strong>Do / Don't</strong>\n\n<strong>Do</strong>\n\u2022 Make cap configurable per task (4x is default)\n\u2022 Include clear reporting format\n\u2022 Allow PM override for complex tasks\n\n<strong>Don't</strong>\n\u2022 Hard-fail on cap (just report and wait)\n\u2022 Apply cap to SR Engineer reviews (different workflow)\n\u2022 Add excessive tracking overhead\n\n---\n\n<strong>Related</strong>\n\n\u2022 **BACKLOG-132**: Worktree race condition (root cause was different, but similar overconsumption)\n\u2022 **BACKLOG-130**: Permission auto-denial (contributed to workarounds)"
  },
  {
    "id": "BACKLOG-134",
    "title": "Engineer Token Optimization",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-134.md](items/BACKLOG-134.md)",
    "description": "<strong>Problem Statement</strong>\n\nEngineer agents consume excessive tokens due to:\n1. **CI polling loops** - Repeated <code>sleep X && gh pr checks</code> calls (10-20x)\n2. **Verbose command output** - npm test/lint without --silent flags\n3. **Edit tool retries** - Endless retries on \"string not found\" errors\n4. **Unclear responsibility split** - Engineers waiting for CI instead of handing off\n\n**Incidents:**\n\u2022 TASK-909: ~2.7M tokens (CI wait loops + no Read/Glob permissions)\n\u2022 TASK-907: ~656K tokens (CI watch loops)\n\n<strong>Solution</strong>\n\nUpdate <code>.claude/agents/engineer.md</code> with four token optimization rules:\n\n<strong>1. Engineers Don't Poll CI</strong>\n\nAfter creating PR:\n\u2022 Report PR number and link to PM/SR Engineer\n\u2022 DO NOT wait for CI\n\u2022 SR Engineer handles CI verification and merge\n\n<strong>2. Use --silent Flags</strong>\n\n<code># Instead of:\nnpm test -- --testPathPattern=\"foo\"\n\n# Use:\nnpm test -- --testPathPattern=\"foo\" --silent\n</code>\n\n<strong>3. Limit Tool Retries</strong>\n\nIf an Edit fails twice with \"string not found\":\n\u2022 STOP and report the issue\n\u2022 DO NOT keep retrying with variations\n\u2022 Ask for help or use a different approach\n\n<strong>4. Clear Responsibility Split</strong>\n\n| Agent | Does | Doesn't |\n|-------|------|---------|\n| Engineer | Implement, commit, push, create PR | Poll CI, wait for CI, merge |\n| SR Engineer | Review, verify CI, merge | Re-implement |\n\n<strong>Implementation</strong>\n\nUpdated <code>.claude/agents/engineer.md</code>:\n\u2022 Modified Step 6 to remove CI wait loop\n\u2022 Modified Step 7 to clarify immediate handoff after PR creation\n\u2022 Added \"Token Optimization Rules\" section\n\u2022 Added \"Tool Retry Limits\" section\n\n<strong>Acceptance Criteria</strong>\n\n\u2611 Engineer.md updated with no-CI-polling rule\n\u2611 Engineer.md updated with --silent flag guidance\n\u2611 Engineer.md updated with tool retry limits\n\u2611 Clear responsibility split documented\n\n<strong>Metrics</strong>\n\n| Phase | Turns | Tokens | Time |\n|-------|-------|--------|------|\n| Implementation | 1 | ~8K | 5 min |\n| **Total** | 1 | ~8K | 5 min |\n\n<strong>Related</strong>\n\n\u2022 **BACKLOG-130**: Permission auto-denial (contributed to TASK-909 token burn)\n\u2022 **BACKLOG-132**: Worktree race condition (~18M tokens)\n\u2022 **BACKLOG-133**: Token cap with early reporting (future prevention)"
  },
  {
    "id": "BACKLOG-135",
    "title": "Fix window.d.ts Type Definitions",
    "category": "refactor",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-015",
    "est_tokens": "~10K",
    "actual_tokens": "~10K",
    "variance": "0%",
    "created_at": "2026-01-02",
    "completed_at": "2026-01-02",
    "file": "TASK-916",
    "description": "<strong>Problem Statement</strong>\n\nThe <code>window.d.ts</code> type definitions are out of sync with the actual preload bridge exports. Specifically:\n\n1. <code>getUnifiedStatus()</code> is exposed via <code>electron/preload/deviceBridge.ts</code> but not properly typed in <code>window.d.ts</code>\n2. Engineers must use runtime type assertions to access these APIs\n3. TypeScript doesn't catch missing/incorrect API usage at compile time\n\n<strong>Impact</strong>\n\n\u2022 TASK-910 spent ~50 edit retries debugging type issues\n\u2022 Engineers waste time on type workarounds instead of features\n\u2022 Runtime errors possible if API changes without type updates\n\n<strong>Solution</strong>\n\n1. Audit <code>electron/preload/deviceBridge.ts</code> exports\n2. Update <code>src/window.d.ts</code> to match actual exports\n3. Add CI check to verify types match exports (optional)\n\n<strong>Files to Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>src/window.d.ts</code> | Add missing type definitions |\n| <code>electron/preload/deviceBridge.ts</code> | Verify exports match types |\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>getUnifiedStatus()</code> properly typed in <code>window.d.ts</code>\n\u2610 All sync API methods have matching type definitions\n\u2610 No type assertions needed to use sync APIs\n\u2610 <code>npm run type-check</code> passes\n\n<strong>Estimated Effort</strong>\n\n2-3 turns, ~10K tokens, 15-20 min\n\n---\n\n<strong>Related</strong>\n\n\u2022 **TASK-910**: Consumed ~6M tokens partly due to this issue\n\u2022 **BACKLOG-130**: Similar permission/type infrastructure issue"
  },
  {
    "id": "BACKLOG-136",
    "title": "PM Token Monitoring Workflow",
    "category": "docs",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-015",
    "est_tokens": "~5K",
    "actual_tokens": "~5K",
    "variance": "-50%",
    "created_at": "2026-01-02",
    "completed_at": "2026-01-02",
    "file": "Hotfix during SPRINT-015",
    "description": "<strong>Problem Statement</strong>\n\nEngineers self-report ~8K tokens but actual consumption is 100x+ higher (~800K-1.1M tokens).\n\n**Root Cause:** Engineers have NO visibility into actual token usage. The \"token cap\" feature (TASK-914) cannot work if engineers can't see their real consumption.\n\n**Impact:**\n\u2022 TASK-914 and TASK-915 each consumed ~1M tokens against ~10K estimates\n\u2022 PM estimates are meaningless without real consumption data\n\u2022 Token caps cannot be enforced without visibility\n\u2022 Budget forecasting impossible\n\n---\n\n<strong>Proposed Solution</strong>\n\nPM must monitor actual token consumption from the orchestrator level, not rely on engineer self-reporting.\n\n<strong>Implementation Options</strong>\n\n**Option A: Per-Agent File Output** (Simplest)\nWhen spawning engineer agents:\n<code># Track agent task_id\nAgent spawned: task_id = a82dc40\n\n# After completion, check actual tokens\nRead /tmp/claude/-Users-daniel-Documents-Mad/tasks/a82dc40.output\n# Parse \"X new tokens\" from progress messages\n</code>\n\n**Option B: Token Tracking in Agent Spawn**\nAdd token tracking to PM workflow:\n1. Record estimated tokens from task file\n2. Record agent task_id at spawn\n3. After agent completes, check TaskOutput for actual tokens\n4. Compare and flag overruns in task file\n\n<strong>Minimum Viable Hotfix</strong>\n\nAdd to PM workflow documentation (<code>.claude/skills/agentic-pm/modules/sprint-management.md</code>):\n\n<code><strong>Token Monitoring (MANDATORY)</strong>\n\nAfter EVERY engineer agent completes:\n\n1. Check TaskOutput for actual tokens consumed\n2. If actual > 4x estimate: FLAG as incident\n3. Update task file with actual tokens\n4. Add to sprint retro data\n\nExample check:\n\u2022 Task estimate: 10K tokens\n\u2022 Agent task_id: a82dc40\n\u2022 Actual: \"595084 new tokens\" (59x overrun!)\n\u2022 Action: Flag, investigate, update estimates\n</code>\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 PM documents token monitoring workflow\n\u2610 PM checks actual tokens after EVERY engineer agent completes\n\u2610 Overruns >4x are flagged immediately\n\u2610 Task files updated with actual (not self-reported) tokens\n\u2610 Sprint retros include actual token data\n\n---\n\n<strong>Effort Estimate</strong>\n\n**Category:** process (documentation)\n**Estimate:** 1-2 turns, ~5K tokens\n**Urgency:** IMMEDIATE - before spawning more engineer agents\n\n---\n\n<strong>Notes</strong>\n\nThis is a process/documentation hotfix, not a code change. The Claude Code tool already tracks tokens - we just need PM to check it.\n\nThe 100x discrepancy discovered in TASK-914/TASK-915 means ALL historical estimates are unreliable until we have real consumption data."
  },
  {
    "id": "BACKLOG-137",
    "title": "Automatic Token Tracking Tooling",
    "category": "infra",
    "priority": "High",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "~40K",
    "actual_tokens": "~34K",
    "variance": "-56%",
    "created_at": "2026-01-02",
    "completed_at": "2026-01-03",
    "file": "[BACKLOG-137.md](BACKLOG-137.md)",
    "description": "<strong>Problem Statement</strong>\n\nEngineers self-report ~8-12K tokens but actual consumption is ~800K-1.1M (~100x higher). Current process (BACKLOG-136) requires PM to manually check TaskOutput, but:\n\n1. TaskOutput files are ephemeral (cleared between sessions)\n2. PM doesn't consistently check after every agent\n3. No persistent record of actual vs estimated\n4. Estimates remain guesses without real data feedback loop\n\n**Impact:**\n\u2022 Token caps (4x estimate) are meaningless\n\u2022 Budget forecasting impossible\n\u2022 Category multipliers based on bad data\n\u2022 No accountability for token efficiency\n\n---\n\n<strong>Proposed Solution</strong>\n\nBuild automated tooling that captures and logs actual token usage per task.\n\n<strong>Architecture</strong>\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  PM spawns      \u2502\u2500\u2500\u2500\u2500\u25b6\u2502  Token Tracker   \u2502\u2500\u2500\u2500\u2500\u25b6\u2502  Metrics Log    \u2502\n\u2502  Engineer Agent \u2502     \u2502  (wrapper/hook)  \u2502     \u2502  (persistent)   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                               \u2502\n                               \u25bc\n                        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                        \u2502  Task File       \u2502\n                        \u2502  (auto-updated)  \u2502\n                        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n<strong>Implementation Options</strong>\n\n#### Option A: Claude Code Hook (Recommended)\n\nUse Claude Code's hook system to capture token usage after each agent completes.\n\n<code>// .claude/settings.json\n{\n  \"hooks\": {\n    \"post-agent\": {\n      \"command\": \"node .claude/scripts/log-agent-tokens.js\",\n      \"args\": [\"$AGENT_ID\", \"$TASK_ID\"]\n    }\n  }\n}\n</code>\n\n**Pros:** Native integration, runs automatically\n**Cons:** Need to verify hook system supports this\n\n#### Option B: Wrapper Script\n\nPM invokes engineers through a wrapper that captures metrics.\n\n<code># .claude/scripts/run-engineer.sh\nclaude-agent engineer \"$@\" | tee /tmp/agent-output.log\nnode .claude/scripts/extract-tokens.js /tmp/agent-output.log >> .claude/metrics/tokens.jsonl\n</code>\n\n**Pros:** Works today, no Claude Code changes needed\n**Cons:** Manual invocation required\n\n#### Option C: Post-Task MCP Tool\n\nCreate an MCP tool that PM calls after each engineer completes.\n\n<code>// mcp-token-logger\nserver.tool(\"log_task_tokens\", {\n  task_id: string,\n  agent_id: string,\n  estimated_tokens: number\n}, async (params) => {\n  const actual = await getAgentTokenUsage(params.agent_id);\n  await appendToMetricsLog(params.task_id, estimated, actual);\n  await updateTaskFile(params.task_id, actual);\n  return { variance: (actual / estimated * 100 - 100).toFixed(0) + \"%\" };\n});\n</code>\n\n**Pros:** Clean integration, reusable\n**Cons:** MCP setup overhead\n\n---\n\n<strong>Deliverables</strong>\n\n1. **Token capture mechanism** (hook, wrapper, or MCP tool)\n2. **Persistent metrics log** (<code>.claude/metrics/tokens.jsonl</code>)\n   <code>   {\"task\":\"TASK-919\",\"estimated\":20000,\"actual\":45000,\"variance\":\"+125%\",\"date\":\"2026-01-02\"}\n   </code>\n3. **Auto-update task files** with actual tokens in Implementation Summary\n4. **Dashboard/report script** to analyze trends\n5. **Alert on overruns** - flag when actual > 4x estimate\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2611 Token usage captured automatically after every engineer agent\n\u2611 Metrics persisted to file (survives session clear)\n\u2611 Task files template updated with auto-captured section\n\u2610 PM can run <code>npm run metrics:tokens</code> to see variance report (future)\n\u2610 4x overrun triggers visible warning (future)\n\n<strong>Implementation Notes</strong>\n\n**Implemented via Option A: Claude Code SubagentStop Hook**\n\nFiles created:\n\u2022 <code>.claude/hooks/track-agent-tokens.sh</code> - Hook script that parses agent transcripts\n\u2022 <code>.claude/metrics/tokens.jsonl</code> - Persistent metrics log\n\u2022 <code>.claude/scripts/show-token-metrics.sh</code> - Basic metrics viewer\n\nConfiguration:\n\u2022 <code>.claude/settings.json</code> - SubagentStop hook registration\n\nCaptures:\n\u2022 <code>input_tokens</code>, <code>output_tokens</code> (new tokens)\n\u2022 <code>cache_read_input_tokens</code>, <code>cache_creation_input_tokens</code> (cache tokens)\n\u2022 <code>total_tokens</code> = sum of all above\n\u2022 <code>api_calls</code> count\n\u2022 <code>agent_id</code> for correlation with Task tool output\n\nUsage:\n<code># View all metrics\ncat .claude/metrics/tokens.jsonl | jq '.'\n\n# Find specific agent's data\ngrep \"<agent_id>\" .claude/metrics/tokens.jsonl | jq '.'\n\n# View formatted summary\n./.claude/scripts/show-token-metrics.sh\n</code>\n\n---\n\n<strong>Estimated Effort</strong>\n\n**Category:** tooling\n**Estimate:** 6-10 turns, ~40K tokens\n**Complexity:** Medium (depends on hook system capabilities)\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 Investigate Claude Code hook system capabilities\n\u2022 May require Claude Code feature request if hooks don't support post-agent\n\n---\n\n<strong>Success Metrics</strong>\n\nAfter implementation:\n\u2022 100% of tasks have actual token data\n\u2022 Category multipliers updated quarterly with real data\n\u2022 Token variance per sprint tracked\n\u2022 Budget forecasting accuracy improves to \u00b150%\n\n---\n\n<strong>Notes</strong>\n\nThis is a foundational improvement. Without real token data, all estimation is guesswork. Priority should be high - every sprint without this loses data we can't recover."
  },
  {
    "id": "BACKLOG-138",
    "title": "Turns/Self-Reported Metrics Cleanup",
    "category": "docs",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "~75K",
    "actual_tokens": "-",
    "variance": "PR #282",
    "created_at": "2026-01-03",
    "completed_at": "2026-01-03",
    "file": "[BACKLOG-138.md](BACKLOG-138.md)",
    "description": "<strong>Status</strong>\n\u2022 **Priority:** Medium\n\u2022 **Category:** docs/cleanup\n\u2022 **Created:** 2026-01-03\n\u2022 **Completed:** 2026-01-03\n\u2022 **Sprint:** Unassigned\n\u2022 **PR:** #282 (merged)\n\n<strong>Summary</strong>\n\nRemove all references to deprecated \"turns\" and self-reported metrics (Turns/Time) across documentation, templates, and active files. Update everything to use the new auto-captured metrics format (Tokens/Duration/API Calls).\n\n<strong>Background</strong>\n\nBACKLOG-137 implemented automatic token tracking via SubagentStop hook. This changed the metrics format:\n\n| Old (Deprecated) | New (Auto-Captured) |\n|------------------|---------------------|\n| Turns (manual count) | API Calls (from hook) |\n| Tokens (estimate: Turns \u00d7 4K) | Total Tokens (from hook) |\n| Time (self-reported) | Duration (from hook, seconds) |\n\nCore files were updated (metrics-templates.md, ENGINEER-WORKFLOW.md, task-file.template.md, SKILL.md, task-file-authoring.md), but ~600+ references to \"turns\" still exist in the codebase.\n\n<strong>Files Requiring Updates</strong>\n\n<strong>Agent Documentation (High Priority)</strong>\n\u2610 <code>.claude/agents/engineer.md</code> - Remove turns tracking, add agent_id capture\n\u2610 <code>.claude/agents/senior-engineer-pr-lead.md</code> - Update review checklist\n\u2610 <code>.claude/agents/agentic-pm.md</code> - Update metrics requirements\n\n<strong>Shared Documentation</strong>\n\u2610 <code>.claude/docs/shared/metrics-tracking.md</code> - May be obsolete, consider removal\n\u2610 <code>.claude/docs/shared/token-cap-workflow.md</code> - Update to auto-captured format\n\u2610 <code>.claude/docs/shared/plan-first-protocol.md</code> - Update metrics sections\n\n<strong>PM Templates</strong>\n\u2610 <code>.claude/skills/agentic-pm/templates/engineer-assignment-message.template.md</code>\n\u2610 <code>.claude/skills/agentic-pm/templates/sprint-summary.template.md</code>\n\n<strong>Active Sprint/Task Files (Review and Update)</strong>\n\u2610 <code>.claude/plans/sprints/SPRINT-016-*.md</code> (if exists) - Update template sections\n\u2610 Active task files in <code>.claude/plans/tasks/</code> - Update Implementation Summary sections\n\n<strong>INDEX.md</strong>\n\u2610 The NON-NEGOTIABLE header still references Turns/Tokens/Time format\n\u2610 Column headers still include turns-based columns (preserve for historical data)\n\n<strong>Scope</strong>\n\n<strong>In Scope</strong>\n1. Update all documentation to reference auto-captured metrics\n2. Remove self-reporting instructions (count turns, track time)\n3. Add agent_id capture instructions where missing\n4. Update table formats to new columns\n5. Add deprecation notices to historical data sections\n\n<strong>Out of Scope</strong>\n1. Modifying historical data in INDEX.md (preserve for reference)\n2. Updating archived sprint files (preserve as-is)\n3. Changing completed task files (preserve as-is)\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>grep -r \"turns\" --include=\"*.md\" .claude/</code> returns only:\n  - Historical/archived files\n  - Explicitly deprecated sections\n  - INDEX.md historical columns\n\u2610 All active templates use auto-captured format\n\u2610 Agent docs reference agent_id capture\n\u2610 <code>npm run type-check</code> passes (no code changes expected)\n\n<strong>Implementation Notes</strong>\n\n<strong>Search Commands</strong>\n<code># Find all turns references\ngrep -rn \"turns\" --include=\"*.md\" .claude/ | grep -v \"archive\" | grep -v \"SPRINT-0[0-1]\"\n\n# Find self-reported time references\ngrep -rn \"self-report\" --include=\"*.md\" .claude/\n\n# Find old metric tables\ngrep -rn \"Impl Turns\" --include=\"*.md\" .claude/\n</code>\n\n<strong>Update Patterns</strong>\n\n**Old format (remove):**\n<code>| Phase | Turns | Tokens | Time |\n| Implementation | X | ~XK | Xm |\n</code>\n\n**New format (use):**\n<code>| Metric | Value |\n| Total Tokens | X |\n| Duration | X seconds |\n| API Calls | X |\n</code>\n\n<strong>Testing Approach</strong>\n\nAfter cleanup:\n1. Run an engineer agent on a test task\n2. Verify agent_id is captured in task file\n3. Verify metrics appear in <code>.claude/metrics/tokens.jsonl</code>\n4. Verify grep shows minimal turns references\n\n<strong>Estimation</strong>\n\n\u2022 **Category:** docs/cleanup\n\u2022 **Base estimate:** ~15K tokens\n\u2022 **Multiplier:** \u00d7 5.0 (docs category - iteration can spiral)\n\u2022 **Adjusted estimate:** ~75K tokens\n\u2022 **Token Cap:** 300K (4x upper estimate)\n\n<strong>Notes</strong>\n\nThis cleanup validates the auto-captured metrics workflow implemented in BACKLOG-137."
  },
  {
    "id": "BACKLOG-139",
    "title": "Comprehensive Database Initialization Gate",
    "category": "service",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-019",
    "est_tokens": "~40K",
    "actual_tokens": "~889K",
    "variance": "+2122%",
    "created_at": "2026-01-03",
    "completed_at": "2026-01-03",
    "file": "[BACKLOG-139.md](BACKLOG-139.md)",
    "description": "<strong>Problem Statement</strong>\n\nThe \"Database is not initialized. Call initialize() first.\" error keeps recurring despite 4+ previous fixes. This is a **recurring bug** that has been fixed piecemeal at least 4 times:\n\n| Date | Issue | Location | Fix |\n|------|-------|----------|-----|\n| Dec 12, 2025 | Email connection during onboarding | EmailOnboardingScreen.tsx | Fallback to pending API |\n| Dec 16, 2025 | Windows returning user race condition | auth-handlers.ts | Auto-init database |\n| Dec 28, 2025 | Google OAuth missing DB check | googleAuthHandlers.ts | Add isInitialized check |\n| Jan 2, 2026 | Navigation to dashboard before DB ready | useNavigationFlow.ts | Add to loading guard |\n| **Jan 3, 2026** | **Transaction detection on transaction page** | **???** | **THIS FIX** |\n\nEach fix addresses one spot, but the **root cause remains**: the app allows user interactions before the database is ready.\n\n---\n\n<strong>Root Cause Analysis</strong>\n\n<strong>Architectural Gap</strong>\n\n1. **Navigation flow guards routing** (<code>useNavigationFlow.ts</code>)\n   - Checks <code>isDatabaseInitialized</code> before allowing navigation to dashboard\n   - Only affects **routing decisions**, not component rendering\n\n2. **Modals bypass routing** (<code>AppModals.tsx</code>)\n   - Rendered independently based on modal flags\n   - Check <code>currentUser</code> and <code>authProvider</code> but **NOT** <code>isDatabaseInitialized</code>\n   - User can open Transactions modal while DB is still initializing\n\n3. **No single gate** for database readiness\n   - Multiple entry points to database-dependent features\n   - Each needs its own guard (fragile, error-prone)\n\n<strong>Race Condition Window</strong>\n\n<code>App Start\n    \u2502\n    \u251c\u2500\u2500 Auth loads quickly (persisted session)\n    \u2502   \u2514\u2500\u2500 currentUser exists \u2713\n    \u2502   \u2514\u2500\u2500 authProvider exists \u2713\n    \u2502\n    \u251c\u2500\u2500 Database initialization (async, slower)\n    \u2502   \u2514\u2500\u2500 isDatabaseInitialized = false \u2717\n    \u2502\n    \u2514\u2500\u2500 User clicks \"View Transactions\"\n        \u2514\u2500\u2500 Modal renders (guards pass: currentUser \u2713 authProvider \u2713)\n        \u2514\u2500\u2500 Transaction API called\n        \u2514\u2500\u2500 ERROR: \"Database is not initialized\"\n</code>\n\n---\n\n<strong>Proposed Solution: App-Level Database Gate</strong>\n\n**User's request:** \"The app won't even start without the database initialized.\"\n\n<strong>Approach</strong>\n\nInstead of adding guards to every component, add a **single app-level gate** that blocks all user interaction until the database is ready.\n\n<strong>Implementation Options</strong>\n\n| Option | Description | Pros | Cons |\n|--------|-------------|------|------|\n| **A: Loading Screen** | Show loading spinner until DB ready | Simple, blocks everything | User sees spinner on every start |\n| **B: Disable All Actions** | Render UI but disable buttons until DB ready | UI visible immediately | More complex, still risk of missed spots |\n| **C: Modal Guard** | Add <code>isDatabaseInitialized</code> to AppModals.tsx | Targeted fix | Still piecemeal |\n\n**Recommended: Option A** - Most comprehensive, matches user request.\n\n<strong>Specific Changes</strong>\n\n1. **AppShell.tsx or App.tsx**: Add gate before rendering main content\n   <code>   if (!isDatabaseInitialized && isAuthenticated) {\n     return <DatabaseInitializingScreen />;\n   }\n   </code>\n\n2. **AppModals.tsx**: Add <code>isDatabaseInitialized</code> guard for safety\n   <code>   {modalState.showTransactions && currentUser && authProvider && isDatabaseInitialized && (\n   </code>\n\n3. **TransactionList.tsx / Transactions.tsx**: Add defensive check\n   <code>   if (!isDatabaseInitialized) {\n     return <LoadingState message=\"Initializing database...\" />;\n   }\n   </code>\n\n---\n\n<strong>Files to Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>src/appCore/AppShell.tsx</code> or <code>src/App.tsx</code> | Add app-level DB gate |\n| <code>src/appCore/AppModals.tsx</code> | Add isDatabaseInitialized to modal guards |\n| <code>src/components/TransactionList.tsx</code> | Add defensive check |\n| <code>src/components/Transactions.tsx</code> | Add defensive check |\n| <code>src/components/Contacts.tsx</code> | Add defensive check |\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 App shows loading state until database is initialized\n\u2610 User cannot access transaction-dependent features until DB ready\n\u2610 Error \"Database is not initialized\" cannot occur in normal usage\n\u2610 Works on both macOS (keychain) and Windows (DPAPI)\n\u2610 Works for both new and returning users\n\n---\n\n<strong>Success Metrics</strong>\n\n\u2022 Zero occurrences of \"Database is not initialized\" error in production\n\u2022 No regression in startup time (database init is already async)\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-119: OAuth Handler Parity Audit (broader handler standardization)\n\u2022 Commit <code>0bd5a4c</code>: Navigation guard fix (Jan 2, 2026)\n\u2022 Commit <code>65ec74c</code>: Google OAuth DB check (Dec 28, 2025)\n\u2022 Commit <code>b8aa61a</code>: Windows returning user fix (Dec 16, 2025)"
  },
  {
    "id": "BACKLOG-140",
    "title": "Duplicate Transaction Re-Import Prevention",
    "category": "service",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-023",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "TASK-964, PR #317",
    "created_at": "2026-01-03",
    "completed_at": "2026-01-03",
    "file": "[BACKLOG-140.md](BACKLOG-140.md)",
    "description": "<strong>Problem</strong>\n\nWhen running transaction detection/import (e.g., \"Auto Detect\" or scanning for new transactions), the system is re-downloading and re-importing transactions that were already imported previously. This creates duplicate entries or wastes processing time checking transactions that already exist.\n\n<strong>Expected Behavior</strong>\n\nThe transaction import process should:\n1. Check if a transaction already exists before importing\n2. Skip transactions that have already been imported\n3. Only import genuinely new transactions\n\n<strong>Potential Root Causes</strong>\n\n1. **Missing deduplication check** - Import logic doesn't check for existing transactions\n2. **Identifier mismatch** - The uniqueness check uses different identifiers than what's stored\n3. **Timestamp-based logic error** - \"Last imported\" timestamp not being used/updated correctly\n4. **Batch import issue** - Bulk imports not checking against existing records\n\n<strong>Investigation Steps</strong>\n\n1. Review transaction import flow in:\n   - <code>electron/services/transactionService.ts</code>\n   - <code>electron/services/transactionDbService.ts</code>\n   - Any related import/sync services\n\n2. Check for existing deduplication logic:\n   - What fields are used for uniqueness? (ID, date, amount, etc.)\n   - Is there a \"last sync\" timestamp being tracked?\n\n3. Verify database schema:\n   - Are unique constraints in place?\n   - Is there an import timestamp column?\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Transaction import skips already-imported transactions\n\u2610 No duplicate transaction entries created\n\u2610 Import process is efficient (doesn't re-process old data)\n\u2610 Logging shows when transactions are skipped (for debugging)\n\n<strong>Notes</strong>\n\nReported during SPRINT-019 manual testing. User observed \"downloading duplicates old transactions that were already imported\" when using the transaction detection feature.\n\n---\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-013: Duplicate Transaction Detection (may be related - detection vs prevention)\n\u2022 BACKLOG-139: Database Init Gate (discovered during same testing session)"
  },
  {
    "id": "BACKLOG-141",
    "title": "Fix Onboarding Flicker for Returning Users (Quick Fix)",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-03",
    "completed_at": "",
    "file": "[BACKLOG-141.md](BACKLOG-141.md)",
    "description": "<strong>Problem</strong>\n\nWhen a returning user logs in, they briefly see the onboarding screens flicker for ~1 second before seeing the main dashboard.\n\n<strong>Root Cause</strong>\n\nIn <code>usePhoneTypeApi.ts</code>, <code>hasSelectedPhoneType</code> defaults to <code>false</code>. When user authenticates:\n1. <code>isAuthenticated</code> becomes <code>true</code>\n2. <code>hasSelectedPhoneType</code> is still <code>false</code> (default, before DB loads)\n3. Navigation sends user to <code>\"phone-type-selection\"</code>\n4. DB query completes, <code>hasSelectedPhoneType</code> becomes <code>true</code>\n5. Navigation redirects to dashboard\n6. Result: ~1 second flicker\n\nNote: <code>useEmailOnboardingApi.ts</code> already has this fix:\n<code>const [hasCompletedEmailOnboarding, setHasCompletedEmailOnboarding] =\n  useState<boolean>(true); // Default true to avoid flicker\n</code>\n\n<strong>Quick Fix</strong>\n\nApply the same pattern to <code>usePhoneTypeApi.ts</code>:\n\n<code>// Before:\nconst [hasSelectedPhoneType, setHasSelectedPhoneType] = useState<boolean>(false);\n\n// After:\nconst [hasSelectedPhoneType, setHasSelectedPhoneType] = useState<boolean>(true); // Default true to avoid flicker\n</code>\n\n<strong>Files to Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>src/appCore/state/flows/usePhoneTypeApi.ts</code> | Change default from <code>false</code> to <code>true</code> |\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Returning users see no onboarding flicker\n\u2610 New users still see onboarding correctly\n\u2610 Works on macOS and Windows\n\n<strong>Risk</strong>\n\n**Low-Medium:** If data fails to load for a new user, they might skip onboarding. However:\n\u2022 Same pattern already used for email onboarding\n\u2022 Loading errors are rare and would surface other issues anyway\n\n<strong>Notes</strong>\n\nThis is a quick fix. The comprehensive solution (BACKLOG-142) will implement a proper state machine that eliminates this class of bugs entirely.\n\n---\n\n<strong>Investigation Summary</strong>\n\nSR Engineer investigation found:\n\u2022 Race condition between auth completion and user data loading\n\u2022 <code>isStillLoading</code> guard in <code>useNavigationFlow.ts</code> is checked too late\n\u2022 Default values are inconsistent across hooks\n\u2022 Pattern already applied to email onboarding but not phone type"
  },
  {
    "id": "BACKLOG-142",
    "title": "State Coordination Layer Overhaul",
    "category": "architecture",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-020/021/022",
    "est_tokens": "~850K",
    "actual_tokens": "-",
    "variance": "Multi-phase",
    "created_at": "2026-01-03",
    "completed_at": "",
    "file": "[BACKLOG-142.md](BACKLOG-142.md)",
    "description": "<strong>Executive Summary</strong>\n\nReplace the fragmented hook-based state coordination with a unified state machine architecture. This addresses recurring race condition bugs in the auth/onboarding flow that have been fixed 4+ times but keep returning.\n\n<strong>Why Now</strong>\n\nThe current state coordination has fundamental architectural problems:\n\u2022 State distributed across 5+ independent hooks with no coordinator\n\u2022 Each hook loads data independently with inconsistent defaults\n\u2022 <code>useNavigationFlow</code> at 360 lines tries to coordinate everything via effects\n\u2022 Race conditions occur when hooks load at different speeds\n\u2022 Bugs like \"Database not initialized\" have been fixed 4+ times\n\n<strong>Business Impact</strong>\n\n| Issue | Impact |\n|-------|--------|\n| Onboarding flicker | Poor UX for returning users |\n| \"Database not initialized\" error | App crash requiring restart |\n| Navigation infinite loops | User must force-quit app |\n| React hooks order violations | Unpredictable behavior |\n\n---\n\n<strong>Root Cause Analysis</strong>\n\n<strong>Current Architecture Problems</strong>\n\n<code>Current State (Fragmented):\n\nuseAppStateMachine (orchestrator - 422 lines)\n    |\n    +-- useSecureStorage (70 lines) - defaults: isCheckingSecureStorage=true, isDatabaseInitialized=false\n    +-- usePhoneTypeApi (146 lines) - defaults: hasSelectedPhoneType=false, isLoadingPhoneType=true\n    +-- useEmailOnboardingApi (107 lines) - defaults: hasCompletedEmailOnboarding=true (to avoid flicker!)\n    +-- useAuthFlow (196 lines) - manages pendingOAuthData, pendingOnboardingData\n    +-- useNavigationFlow (360 lines) - tries to coordinate via complex effects\n    +-- useModalFlow, usePermissionsFlow, etc.\n\nProblems:\n1. Each hook has its own loading state and defaults (inconsistent)\n2. No single source of truth for \"app is ready\"\n3. useNavigationFlow effect has 15+ dependencies, runs on every change\n4. Guards rely on multiple conditions that race against each other\n5. Defaults chosen to \"avoid flicker\" mask real initialization issues\n</code>\n\n<strong>Specific Race Conditions</strong>\n\n| Race | Hooks Involved | Result |\n|------|----------------|--------|\n| Auth loads before DB | useSecureStorage, useAuthFlow | \"Database not initialized\" |\n| Phone type loads false then true | usePhoneTypeApi, useNavigationFlow | Onboarding flicker |\n| Email status loads async | useEmailOnboardingApi | Wrong screen shown |\n| Multiple effects trigger | All | Navigation loops |\n\n<strong>Previous Fixes (All Partial)</strong>\n\n| Sprint | Fix | Why It Wasn't Enough |\n|--------|-----|---------------------|\n| SPRINT-001 | Refactored UI | Explicitly kept state machine untouched |\n| SPRINT-013 | Split useAppStateMachine | Didn't redesign coordination |\n| SPRINT-019 | Database init gate | Added more guards, not unified |\n| BACKLOG-141 | Default flip | Masks problem, doesn't solve |\n\n---\n\n<strong>Proposed Solution: Unified App State Machine</strong>\n\n<strong>Target Architecture</strong>\n\n<code>Target State (Unified):\n\nAppStateProvider (single context)\n    |\n    +-- Finite State Machine\n        |\n        +-- States: loading | initializing | authenticating | onboarding | ready | error\n        +-- Transitions: defined, predictable, testable\n        +-- Single source of truth for \"what should render\"\n</code>\n\n<strong>Key Design Principles</strong>\n\n1. **Single Loading Phase**: No component renders until ALL initialization complete\n2. **Finite States**: App can only be in one state at a time\n3. **Explicit Transitions**: State changes only via defined actions\n4. **Predictable Order**: Database THEN auth THEN user data\n5. **Platform Awareness**: macOS vs Windows paths built into state machine\n\n<strong>State Machine States</strong>\n\n<code>type AppState =\n  | { status: 'loading'; phase: 'checking-storage' | 'initializing-db' | 'loading-auth' | 'loading-user-data' }\n  | { status: 'unauthenticated' }\n  | { status: 'onboarding'; step: 'terms' | 'phone-type' | 'email' | 'drivers' | 'permissions' }\n  | { status: 'ready'; user: User; platform: Platform }\n  | { status: 'error'; error: AppError };\n\ntype AppAction =\n  | { type: 'STORAGE_CHECKED'; hasKeyStore: boolean }\n  | { type: 'DB_INITIALIZED'; success: boolean }\n  | { type: 'AUTH_LOADED'; user: User | null }\n  | { type: 'USER_DATA_LOADED'; phoneType: PhoneType; emailStatus: EmailStatus }\n  | { type: 'ONBOARDING_STEP_COMPLETE'; step: OnboardingStep }\n  | { type: 'LOGOUT' }\n  | { type: 'ERROR'; error: AppError };\n</code>\n\n---\n\n<strong>Implementation Phases</strong>\n\n<strong>Phase 1: Foundation (SPRINT-020)</strong>\n\n**Goal**: Create the state machine foundation without breaking existing functionality.\n\n| Task | Description | Risk |\n|------|-------------|------|\n| Design state machine | Define states, transitions, types | Low |\n| Create AppStateContext | New context provider alongside existing | Low |\n| Implement core reducer | State transitions for loading -> ready | Medium |\n| Add loading orchestrator | Coordinate initialization sequence | Medium |\n| Integration tests | Verify state transitions | Low |\n\n**Branch Strategy**: <code>project/state-coordination</code> branching from develop\n\n<strong>Phase 2: Migration (SPRINT-021)</strong>\n\n**Goal**: Migrate existing hooks to use new state machine.\n\n| Task | Description | Risk |\n|------|-------------|------|\n| Migrate useSecureStorage | Use state machine for DB init | Medium |\n| Migrate usePhoneTypeApi | User data from state machine | Medium |\n| Migrate useEmailOnboardingApi | User data from state machine | Medium |\n| Update useNavigationFlow | Replace effects with state derivation | High |\n| Update components | Use new context | Medium |\n\n**Branch Strategy**: Continue on <code>project/state-coordination</code>\n\n<strong>Phase 3: Cleanup (SPRINT-022)</strong>\n\n**Goal**: Remove legacy code, finalize architecture.\n\n| Task | Description | Risk |\n|------|-------------|------|\n| Remove legacy hooks | Delete deprecated code | Low |\n| Remove workaround guards | Clean up \"belt-and-suspenders\" checks | Low |\n| Documentation | Update architecture docs | Low |\n| Performance optimization | Memoization, selective re-renders | Low |\n| End-to-end validation | Full platform testing | Medium |\n\n**Branch Strategy**: Merge <code>project/state-coordination</code> to develop\n\n---\n\n<strong>Risk Assessment</strong>\n\n<strong>High Risk Areas</strong>\n\n| Area | Risk | Mitigation |\n|------|------|------------|\n| Auth flow regression | **High** | Phase 1 runs parallel (no removal) |\n| Windows platform | **Medium** | Test on Windows at each phase |\n| Returning user flow | **High** | Integration tests for returning users |\n| New user onboarding | **Medium** | Integration tests for new users |\n\n<strong>Risk Mitigation Strategy</strong>\n\n1. **Parallel implementation**: Phase 1 adds new code, doesn't modify old\n2. **Feature flag**: Can disable new state machine via localStorage\n3. **Integration branch**: All work on <code>project/state-coordination</code>\n4. **Platform testing**: Required at each phase for macOS and Windows\n5. **Rollback plan**: Revert project branch if issues found\n\n---\n\n<strong>Testing Strategy</strong>\n\n<strong>Unit Tests</strong>\n\n\u2022 State machine reducer (all transitions)\n\u2022 AppStateContext provider\n\u2022 Loading orchestrator\n\u2022 Migration adapters\n\n<strong>Integration Tests</strong>\n\n| Scenario | States Covered |\n|----------|----------------|\n| New user signup (macOS) | loading -> onboarding -> ready |\n| New user signup (Windows) | loading -> onboarding -> ready |\n| Returning user login (macOS) | loading -> ready |\n| Returning user login (Windows) | loading -> ready |\n| OAuth error recovery | loading -> error -> unauthenticated |\n| Database init failure | loading -> error |\n| Terms decline | onboarding -> unauthenticated |\n\n<strong>Manual Testing Checklist</strong>\n\n\u2610 macOS new user full flow\n\u2610 macOS returning user (fast login)\n\u2610 Windows new user full flow\n\u2610 Windows returning user (fast login)\n\u2610 No onboarding flicker for returning users\n\u2610 No \"Database not initialized\" error\n\u2610 No navigation loops\n\u2610 Quick action during startup (stress test)\n\n---\n\n<strong>Acceptance Criteria (Overall)</strong>\n\n\u2610 Single source of truth for app state\n\u2610 No race conditions in auth/onboarding flow\n\u2610 \"Database not initialized\" error eliminated\n\u2610 Onboarding flicker eliminated for returning users\n\u2610 Navigation loops eliminated\n\u2610 Works on both macOS and Windows\n\u2610 Existing onboarding step registry preserved\n\u2610 Test coverage for state transitions\n\u2610 No regression in startup time\n\n---\n\n<strong>Estimated Effort</strong>\n\n| Phase | Est. Tokens | Complexity | Duration |\n|-------|-------------|------------|----------|\n| Phase 1 (Foundation) | ~300K | Medium | 1 sprint |\n| Phase 2 (Migration) | ~400K | High | 1 sprint |\n| Phase 3 (Cleanup) | ~150K | Low | 0.5 sprint |\n| **Total** | **~850K** | - | **2.5 sprints** |\n\n---\n\n<strong>Dependencies</strong>\n\n| Dependency | Type | Status |\n|------------|------|--------|\n| BACKLOG-139 (DB gate) | Completed | Done - provides foundation |\n| BACKLOG-141 (flicker fix) | Can skip | Will be superseded |\n| BACKLOG-107 (hook split) | Completed | Done - easier migration |\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-139: Comprehensive Database Initialization Guard (completed - provides gate)\n\u2022 BACKLOG-141: Fix Onboarding Flicker (superseded by this)\n\u2022 BACKLOG-107: Split useAppStateMachine (completed - enables this)\n\u2022 BACKLOG-111: Migrate Components to Service Abstractions (parallel effort)\n\n---\n\n<strong>Phase Completion Status</strong>\n\n<strong>Phase 1: Foundation (SPRINT-020) - COMPLETE</strong>\n\n\u2022 State machine types and reducer implemented\n\u2022 AppStateContext and LoadingOrchestrator created\n\u2022 49 tests (32 integration + 17 platform)\n\u2022 Feature flag defaults to false for safe rollout\n\u2022 PRs #287-294 merged\n\n<strong>Phase 2: Migration (SPRINT-021) - COMPLETE</strong>\n\n\u2022 All hooks migrated to state machine\n\u2022 useSecureStorage, usePhoneTypeApi, useEmailOnboardingApi, useNavigationFlow updated\n\u2022 State derivation from machine for all components\n\u2022 Feature flag enabled by default\n\u2022 PRs #296-309 merged\n\n<strong>Phase 3: Cleanup (SPRINT-022) - COMPLETE</strong>\n\n\u2022 State machine wired into main.tsx (TASK-957, PR #310)\n\u2022 Returning user flicker fixed (TASK-950)\n\u2022 Legacy code paths removed (TASK-952)\n\u2022 Architecture documentation created\n\u2022 BACKLOG-142 marked complete\n\n**Architecture Documentation:** <code>.claude/docs/shared/state-machine-architecture.md</code>\n\n---\n\n<strong>Changelog</strong>\n\n\u2022 2026-01-03: Created BACKLOG-142 for state coordination overhaul\n\u2022 2026-01-03: Phase 1 complete (SPRINT-020)\n\u2022 2026-01-03: Phase 2 complete (SPRINT-021)\n\u2022 2026-01-04: Phase 3 complete (SPRINT-022) - BACKLOG-142 COMPLETE"
  },
  {
    "id": "BACKLOG-143",
    "title": "Prevent Duplicate Contact Imports",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "SPRINT-055a",
    "est_tokens": "~40K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-04",
    "completed_at": "",
    "file": "[BACKLOG-143.md](BACKLOG-143.md)",
    "description": "*Created: 2026-01-03*\n*Status: Pending*"
  },
  {
    "id": "BACKLOG-144",
    "title": "Enforce SR Engineer Review Before PR Merge",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-144.md](items/BACKLOG-144.md)",
    "description": "<strong>Problem Statement</strong>\n\nDuring SPRINT-022, three PRs (#310, #311, #312) were merged to develop without proper SR Engineer review. The PR template includes an SR Engineer section, but nothing enforces that it must be completed before merge.\n\n<strong>Root Cause</strong>\n\n1. Engineer agents complete work and create PRs\n2. CI passes (tests, lint, type-check)\n3. No gate exists to verify SR Engineer review was performed\n4. PRs get merged based on CI passing + manual testing\n\n<strong>Impact</strong>\n\n\u2022 Architecture concerns may be missed\n\u2022 Security review skipped\n\u2022 Metrics not captured properly\n\u2022 Process violations go undetected\n\n---\n\n<strong>Proposed Solutions</strong>\n\n<strong>Option A: CI Validation Check (Recommended)</strong>\n\nAdd validation to existing PR Metrics workflow:\n\n<code># Check SR Engineer section is filled (not placeholder)\nif grep -q \"SR Engineer Agent ID: <paste\" <<< \"$PR_BODY\"; then\n  echo \"::error::SR Engineer review section not completed\"\n  exit 1\nfi\n</code>\n\n**Pros:** Automated, blocks merge, clear error\n**Cons:** Requires workflow modification\n\n<strong>Option B: Engineer Agent Handoff Requirement</strong>\n\nModify engineer agent to block until SR Engineer invoked.\n\n**Pros:** Natural workflow\n**Cons:** Relies on agent compliance\n\n<strong>Option C: Hybrid (Recommended)</strong>\n\n1. CI check validates SR Engineer section is filled\n2. Engineer agent instructions require SR Engineer handoff\n3. SR Engineer fills in section as part of review\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 PRs cannot be merged without SR Engineer section completed\n\u2610 Clear error message when validation fails\n\u2610 Documentation updated with new workflow\n\u2610 Tested on at least one PR\n\n---\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-126: Debugging Metrics Enforcement (similar pattern)\n\u2022 <code>.github/workflows/ci.yml</code>: Existing CI workflow\n\n---\n\n<strong>Changelog</strong>\n\n\u2022 2026-01-04: Created from SPRINT-022 retrospective"
  },
  {
    "id": "BACKLOG-145",
    "title": "Duplicate Contact Keys in ImportContactsModal",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "SPRINT-055a",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-145.md](items/BACKLOG-145.md)",
    "description": "<strong>Problem</strong>\n\nReact warning: \"Encountered two children with the same key\" when importing contacts. Multiple contacts with the same name cause key collisions.\n\n**Reported:** 2026-01-04 during SPRINT-021 manual testing\n**Severity:** Medium\n**Type:** Bug\n\n<strong>Error Message</strong>\n\n<code>Warning: Encountered two children with the same key, <code>contacts-app-Sharanya Jacobs Friend</code>.\nKeys should be unique so that components maintain their identity across updates.\n</code>\n\n<strong>Root Cause</strong>\n\nIn <code>electron/contact-handlers.ts:182</code>:\n\n<code>id: <code>contacts-app-${contactInfo.name}</code>, // Temporary ID for UI\n</code>\n\nContact IDs are generated using the contact's name, but names are not unique. Two contacts named \"Sharanya Jacobs Friend\" will have the same ID.\n\n<strong>Impact</strong>\n\n\u2022 React may duplicate or omit contacts during rendering\n\u2022 Selection behavior may be unpredictable\n\u2022 Console warnings clutter developer experience\n\n<strong>Fix</strong>\n\nUse a unique identifier instead of name:\n\n<code>// Option A: Use index + name + timestamp\nid: <code>contacts-app-${Date.now()}-${index}-${contactInfo.name}</code>,\n\n// Option B: Use crypto UUID\nid: <code>contacts-app-${crypto.randomUUID()}</code>,\n\n// Option C: Hash of all contact fields\nid: <code>contacts-app-${hash(JSON.stringify(contactInfo))}</code>,\n</code>\n\n<strong>Files to Change</strong>\n\n\u2022 <code>electron/contact-handlers.ts:182</code> - Change ID generation\n\n<strong>Priority</strong>\n\n**Medium** - Doesn't block release but causes user-visible issues\n\n<strong>Related</strong>\n\n\u2022 ImportContactsModal.tsx - Where the error manifests\n\u2022 BACKLOG-143 (if exists) - Original duplicate contacts import issue"
  },
  {
    "id": "BACKLOG-146",
    "title": "Prevent Stuck Jest Worker Processes from Agent Runs",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-146.md](items/BACKLOG-146.md)",
    "description": "<strong>Problem</strong>\n\nEngineer agents running <code>npm test</code> leave behind stuck Jest worker processes that consume 100% CPU each. In SPRINT-021, 5 Jest workers were found running at 100% CPU for over an hour, causing fan noise and system slowdown.\n\n**Incident:** 2026-01-04 during SPRINT-021 execution\n**Impact:** 5 processes \u00d7 100% CPU = system slowdown, loud fans\n\n<strong>Root Cause</strong>\n\nJest workers can hang indefinitely when:\n1. Tests use <code>setTimeout</code>/<code>setInterval</code> without cleanup\n2. EventEmitter listeners aren't removed\n3. Database connections aren't closed\n4. Agent terminates before Jest fully exits\n\nThe <code>--forceExit</code> flag helps but doesn't always work, especially when workers hang during test loading phase.\n\n<strong>Proposed Solutions</strong>\n\n<strong>Option A: Process Cleanup Hook (Recommended)</strong>\n\nAdd a Claude Code hook that kills orphaned Jest processes when agents complete:\n\n<code>// .claude/hooks.json\n{\n  \"SubagentStop\": [\n    {\n      \"command\": \"pkill -f 'jest-worker.*Mad' 2>/dev/null || true\",\n      \"description\": \"Kill orphaned Jest workers after agent completes\"\n    }\n  ]\n}\n</code>\n\n**Pros:** Automatic cleanup, no code changes\n**Cons:** May kill intentional test runs (edge case)\n\n<strong>Option B: Jest Config Improvements</strong>\n\nAdd timeout and worker limits to <code>jest.config.js</code>:\n\n<code>module.exports = {\n  workerIdleMemoryLimit: '512MB',\n  forceExit: true,\n  maxWorkers: 2,\n  testTimeout: 30000,\n};\n</code>\n\n**Pros:** Prevents hangs at source\n**Cons:** May mask real issues, doesn't help if worker hangs during load\n\n<strong>Option C: Engineer Agent SOP Update</strong>\n\nAdd to engineer agent instructions:\n1. Always run tests with <code>--forceExit --maxWorkers=2</code>\n2. Run <code>pkill -f jest-worker</code> before completing\n3. Verify no stuck processes before handoff\n\n**Pros:** Process-based solution\n**Cons:** Relies on agent compliance\n\n<strong>Recommendation</strong>\n\nImplement Options A + B together:\n1. Add SubagentStop hook for automatic cleanup\n2. Update Jest config with sensible defaults\n3. Document in engineer agent SOP as backup\n\n<strong>Priority</strong>\n\n**Medium** - Not blocking but causes user frustration\n\n<strong>Effort</strong>\n\n~2 hours to implement all options\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-120: CI Test Gaps (Jest hanging in CI)\n\u2022 SPRINT-021: State Machine Migration (where incident occurred)"
  },
  {
    "id": "BACKLOG-147",
    "title": "Secure Storage Setup Should Not Show for Returning Users",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-147.md](items/BACKLOG-147.md)",
    "description": "<strong>Summary</strong>\n\nThe \"Secure Storage Setup\" screen currently shows for returning users unless they've checked the \"Don't show again\" checkbox. This is unnecessary friction - returning users have already set up secure storage.\n\n<strong>Current Behavior</strong>\n\n1. Returning user restarts app\n2. Sees \"Secure Storage Setup - Protect your data with macOS Keychain\"\n3. Must click through or check \"Don't show again\"\n\n<strong>Desired Behavior</strong>\n\n1. Returning user restarts app\n2. If secure storage is already configured \u2192 Skip this screen entirely\n3. Only show if secure storage genuinely needs setup\n\n<strong>Implementation Notes</strong>\n\n\u2022 The \"Don't show again\" checkbox is a workaround for the real issue\n\u2022 Should check if secure storage is already initialized before showing\n\u2022 Similar pattern to TASK-955 (skip unnecessary onboarding steps)\n\n<strong>Priority</strong>\n\n**Medium** - UX improvement, not blocking\n\n<strong>Related</strong>\n\n\u2022 TASK-955: Skip Onboarding for Returning Users (addresses the broader issue)\n\u2022 BACKLOG-144: UI Flicker for Returning Users\n\n<strong>Status</strong>\n\n**Open** - May be resolved as part of TASK-955 or require separate work"
  },
  {
    "id": "BACKLOG-148",
    "title": "Split databaseService.ts into Domain Services",
    "category": "refactor",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-023",
    "est_tokens": "~60K",
    "actual_tokens": "-",
    "variance": "TASK-961, PR #315",
    "created_at": "2026-01-04",
    "completed_at": "2026-01-04",
    "file": "[BACKLOG-148.md](BACKLOG-148.md)",
    "description": "<strong>Priority: High</strong>\n\n<strong>Category: refactor</strong>\n\n<strong>Summary</strong>\n\nComplete the Phase 5 migration of <code>databaseService.ts</code> (3,877 lines) by wiring delegation to the existing <code>db/*</code> domain services created in BACKLOG-058 (PR #137, Dec 2025).\n\n<strong>Current State (2026-01-04)</strong>\n\n**Critical Discovery:** The db/* domain services ALREADY EXIST but are not being used.\n\n<strong>What Exists</strong>\n\n| Service | Lines | Created |\n|---------|-------|---------|\n| <code>db/core/dbConnection.ts</code> | ~100 | PR #137 |\n| <code>db/userDbService.ts</code> | 209 | PR #137 |\n| <code>db/transactionDbService.ts</code> | 364 | PR #137 |\n| <code>db/contactDbService.ts</code> | 520 | PR #137 |\n| <code>db/communicationDbService.ts</code> | 396 | PR #137 |\n| <code>db/sessionDbService.ts</code> | 90 | PR #137 |\n| <code>db/oauthTokenDbService.ts</code> | 201 | PR #137 |\n| <code>db/feedbackDbService.ts</code> | 118 | PR #137 |\n| <code>db/auditLogDbService.ts</code> | 188 | PR #137 |\n| <code>db/llmSettingsDbService.ts</code> | 213 | PR #137 |\n| <code>db/transactionContactDbService.ts</code> | 350 | PR #137 |\n| <code>db/index.ts</code> | - | PR #137 |\n\n<strong>The Problem</strong>\n\n<code>databaseService.ts</code> (3,877 lines) contains ALL logic duplicated. Phase 5 (wire up delegation) from BACKLOG-058 was never completed.\n\n**Evidence:**\n\u2022 Only 2 methods delegate: <code>getOAuthTokenSyncTime</code>, <code>updateOAuthTokenSyncTime</code>\n\u2022 37 files still import from <code>databaseService.ts</code>\n\u2022 The db/* services are barely used (1 reference in task docs)\n\n<strong>Solution</strong>\n\n<strong>Phase 5: Wire Delegation (TASK-961) - REQUIRED</strong>\n\nTransform <code>databaseService.ts</code> from a monolithic implementation to a thin facade that delegates to <code>db/*</code> services.\n\n**Before:**\n<code>async createUser(user: User): Promise<void> {\n  const db = this.getDb();\n  const stmt = db.prepare(<code>INSERT INTO users ...</code>);\n  // 20+ lines of implementation\n}\n</code>\n\n**After:**\n<code>async createUser(user: User): Promise<void> {\n  return userDbService.createUser(user);\n}\n</code>\n\n**Target:** Reduce <code>databaseService.ts</code> from 3,877 to <500 lines.\n\n<strong>Phase 6: Consumer Migration (TASK-962) - OPTIONAL</strong>\n\nMigrate all 37 consumer files from <code>databaseService.ts</code> imports to direct <code>db/*</code> service imports.\n\n**Recommendation:** DEFER. The facade pattern is a valid long-term architecture:\n\u2022 Single import point is easier for developers\n\u2022 No risk of import errors from multiple sources\n\u2022 Backward compatibility with existing code\n\n<strong>Implementation Phases (REVISED)</strong>\n\n<strong>Phase 1-4: COMPLETE (PR #137, Dec 2025)</strong>\n\u2611 Created db/* directory structure\n\u2611 Created domain service files\n\u2611 Implemented all domain operations\n\u2611 Created barrel exports\n\n<strong>Phase 5: Wire Delegation (TASK-961) - SPRINT-023</strong>\n\u2610 Document method mapping (databaseService.ts -> db/*)\n\u2610 Wire all methods to delegate to db/* services\n\u2610 Remove duplicate implementation code\n\u2610 Verify backward compatibility\n\n<strong>Phase 6: Consumer Migration (TASK-962) - OPTIONAL</strong>\n\u2610 Migrate 37 consumer files to direct db/* imports\n\u2610 Delete databaseService.ts facade\n\u2610 Update test imports\n\n<strong>Acceptance Criteria</strong>\n\n<strong>Phase 5 (Required)</strong>\n\u2610 <code>databaseService.ts</code> reduced to <500 lines\n\u2610 All methods delegate to db/* services\n\u2610 No duplicate implementation code\n\u2610 All 37 consumer files still work (backward compat)\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\n<strong>Phase 6 (Optional)</strong>\n\u2610 All consumers migrated to direct db/* imports\n\u2610 <code>databaseService.ts</code> deleted\n\u2610 No runtime import errors\n\n<strong>Estimated Effort (REVISED)</strong>\n\n| Phase | Metric | Estimate | Notes |\n|-------|--------|----------|-------|\n| Phase 5 | Tokens | ~15-20K | Wiring only, no new code |\n| Phase 6 | Tokens | ~20-25K | Import changes only |\n| **Total** | **Tokens** | **~35-45K** | Reduced from original ~120K |\n\n**Calibrated (0.5x refactor multiplier):**\n| Phase | Calibrated Estimate |\n|-------|---------------------|\n| Phase 5 | ~15-20K |\n| Phase 6 | ~20-25K |\n\n<strong>Dependencies</strong>\n\n\u2022 **None for Phase 5**\n\u2022 Phase 6 depends on Phase 5 completion\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Method signature mismatches | Type checking will catch |\n| Missing db/* equivalents | Add to db/* services if needed |\n| Circular dependencies | Already resolved in db/* |\n| Consumer import breakage (Phase 6) | Keep facade as alternative |\n\n<strong>Notes</strong>\n\n**History:**\n\u2022 BACKLOG-058 (Dec 2025): Created db/* services (Phases 1-4)\n\u2022 PR #137: Merged domain services\n\u2022 2026-01-04: Discovered Phase 5 never completed\n\n**This backlog item is the completion of BACKLOG-058's original vision.**\n\nThe original item assumed creating the db/* structure from scratch. The revised scope recognizes that structure exists and focuses on:\n1. Wiring delegation (Phase 5) - REQUIRED\n2. Consumer migration (Phase 6) - OPTIONAL\n\n<strong>Related Items</strong>\n\n\u2022 **BACKLOG-058**: Original database service split (Phases 1-4 complete)\n\u2022 **TASK-961**: Wire delegation (SPRINT-023)\n\u2022 **TASK-962**: Consumer migration (SPRINT-023 - OPTIONAL)\n\u2022 **TASK-964**: Depends on TASK-961 for clean database layer"
  },
  {
    "id": "BACKLOG-149",
    "title": "Delete Deprecated EmailOnboardingScreen.tsx",
    "category": "refactor",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-023",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "TASK-960, PR #314",
    "created_at": "2026-01-04",
    "completed_at": "2026-01-04",
    "file": "[BACKLOG-149.md](BACKLOG-149.md)",
    "description": "<strong>Priority: Medium</strong>\n\n<strong>Category: refactor</strong>\n\n<strong>Summary</strong>\n\nDelete the deprecated <code>EmailOnboardingScreen.tsx</code> (1,203 lines) after verifying migration to <code>onboarding/steps/EmailConnectStep.tsx</code> is complete.\n\n<strong>Problem</strong>\n\nThe file <code>src/components/EmailOnboardingScreen.tsx</code> is marked as DEPRECATED in its header:\n\n<code>/**\n * @deprecated Use <code>onboarding/steps/EmailConnectStep.tsx</code> instead.\n *\n * Migration guide:\n * 1. New step file has <code>meta</code> object with configuration\n * 2. Content component receives <code>onAction</code> callback\n * 3. Layout/navigation handled by OnboardingShell\n *\n * This file will be removed after migration is complete.\n */\n</code>\n\nThe file at 1,203 lines is still in the codebase despite being deprecated. Dead code:\n\u2022 Increases bundle size\n\u2022 Causes confusion for developers\n\u2022 May have stale dependencies\n\u2022 Adds maintenance burden\n\n<strong>Solution</strong>\n\n1. Verify migration is complete by checking all usages\n2. Confirm <code>EmailConnectStep.tsx</code> has full feature parity\n3. Delete the deprecated file\n4. Remove any orphaned imports/references\n\n<strong>Implementation Steps</strong>\n\n<strong>Step 1: Verify Migration (~30 min)</strong>\n1. Search for imports of <code>EmailOnboardingScreen</code>\n2. Check routing configuration\n3. Compare functionality with <code>EmailConnectStep.tsx</code>\n4. Document any missing features\n\n<strong>Step 2: Clean Deletion (~15 min)</strong>\n1. Delete <code>src/components/EmailOnboardingScreen.tsx</code>\n2. Remove from any barrel exports\n3. Update any stale imports (should fail to compile if missed)\n\n<strong>Step 3: Verification (~15 min)</strong>\n1. <code>npm run type-check</code> passes\n2. <code>npm run lint</code> passes\n3. <code>npm test</code> passes\n4. Manual test of email onboarding flow\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 All usages of <code>EmailOnboardingScreen</code> identified and migrated\n\u2610 <code>EmailOnboardingScreen.tsx</code> deleted\n\u2610 No orphaned imports remain\n\u2610 Email onboarding flow works correctly\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\u2610 Bundle size reduced\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Tokens | ~15K | Mostly verification, simple deletion |\n| Duration | ~1 hour | |\n\n<strong>Dependencies</strong>\n\n\u2022 Migration to <code>EmailConnectStep.tsx</code> must be complete\n\u2022 If migration is NOT complete, this becomes a larger task to complete migration first\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Migration incomplete | Thorough usage search before deletion |\n| Missing features in new component | Feature parity checklist |\n| Breaking onboarding for users | Manual testing of full flow |\n\n<strong>Notes</strong>\n\n**This item is SR Engineer sourced from architecture review (2026-01-04).**\n\nIf the migration is found to be incomplete, this task should be:\n1. Re-scoped to include completing the migration, OR\n2. Deferred until migration is complete, OR\n3. Split: TASK-A (complete migration) + TASK-B (delete old file)\n\nThe 1,203 lines in the deprecated file represent significant dead code. Deletion will improve codebase clarity and reduce bundle size."
  },
  {
    "id": "BACKLOG-150",
    "title": "Reduce useAppStateMachine.ts Return Object",
    "category": "refactor",
    "priority": "Low",
    "status": "Completed",
    "sprint": "SPRINT-028",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "TASK-1006, PR #367",
    "created_at": "2026-01-04",
    "completed_at": "2026-01-10",
    "file": "[BACKLOG-150.md](BACKLOG-150.md)",
    "description": "<strong>Priority: Low</strong>\n\n<strong>Category: refactor</strong>\n\n<strong>Summary</strong>\n\nReduce <code>useAppStateMachine.ts</code> (432 lines, 32 over 400-line trigger) by refactoring the ~180-line return object.\n\n<strong>Problem</strong>\n\n<code>src/appCore/state/useAppStateMachine.ts</code> at 432 lines is slightly over the 400-line trigger threshold from <code>.claude/docs/shared/architecture-guardrails.md</code>.\n\n**Note:** BACKLOG-107 / SPRINT-013 already addressed the major issues, reducing the file from 1,130 to 422 lines. The current issue is maintenance-level.\n\nThe primary remaining issue is the return statement which spans approximately 180 lines. This is because the hook returns many grouped properties.\n\n<strong>Solution</strong>\n\nConsider one of these approaches:\n\n<strong>Option A: Auto-Construct Return Object</strong>\nCreate a utility function that constructs the return object from the state machine context:\n\n<code>// Before\nreturn {\n  // Auth flow\n  isAuthenticated,\n  setIsAuthenticated,\n  // ... 50+ properties\n};\n\n// After\nreturn useMemo(() => ({\n  ...constructAuthFlowReturn(state),\n  ...constructStorageFlowReturn(state),\n  ...constructOnboardingFlowReturn(state),\n}), [state]);\n</code>\n\n<strong>Option B: Group Related Properties into Sub-Objects</strong>\n<code>// Before\nreturn {\n  isAuthenticated,\n  setIsAuthenticated,\n  isDatabaseReady,\n  // ... many flat properties\n};\n\n// After\nreturn {\n  auth: { isAuthenticated, setIsAuthenticated },\n  storage: { isDatabaseReady, ... },\n  onboarding: { ... },\n  // Grouped by concern\n};\n</code>\n\n**Recommendation:** Option A maintains backward compatibility while reducing line count.\n\n<strong>Implementation Steps</strong>\n\n<strong>Step 1: Analysis (~20 min)</strong>\n1. Catalog all return properties\n2. Group by flow/concern\n3. Identify dependencies\n\n<strong>Step 2: Create Helper Functions (~30 min)</strong>\n1. Create <code>constructAuthFlowReturn(state)</code>\n2. Create <code>constructStorageFlowReturn(state)</code>\n3. Create <code>constructOnboardingFlowReturn(state)</code>\n4. Each returns a typed partial object\n\n<strong>Step 3: Refactor Return (~15 min)</strong>\n1. Replace inline return with composed object\n2. Ensure memoization for performance\n3. Verify type safety\n\n<strong>Step 4: Verification (~15 min)</strong>\n1. <code>npm run type-check</code> passes\n2. <code>npm run lint</code> passes\n3. <code>npm test</code> passes\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>useAppStateMachine.ts</code> reduced to <400 lines\n\u2610 Return object construction moved to helper functions\n\u2610 All functionality preserved (no behavior changes)\n\u2610 No performance regressions\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Tokens | ~20K | Simple refactor, well-understood code |\n| Duration | ~1-2 hours | |\n\n**Calibrated (0.5x refactor multiplier):**\n| Metric | Calibrated Estimate |\n|--------|---------------------|\n| Tokens | ~10K |\n\n<strong>Dependencies</strong>\n\n\u2022 None\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Breaking hook consumers | Type checking will catch API changes |\n| Performance regression | Careful memoization |\n| Complexity increase | Keep helper functions simple |\n\n<strong>Notes</strong>\n\n**This item is SR Engineer sourced from architecture review (2026-01-04).**\n\nThis is a LOW priority maintenance task. The architecture is correct (BACKLOG-107 addressed the major issues). This is purely line-count reduction for maintainability.\n\nPriority should be given to HIGH/CRITICAL items before addressing this."
  },
  {
    "id": "BACKLOG-151",
    "title": "Reduce AppModals.tsx Below 150-Line Trigger",
    "category": "refactor",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~5K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-04",
    "completed_at": "",
    "file": "[BACKLOG-151.md](BACKLOG-151.md)",
    "description": "<strong>Priority: Low</strong>\n\n<strong>Category: refactor</strong>\n\n<strong>Summary</strong>\n\nReduce <code>AppModals.tsx</code> (169 lines, 19 over 150-line trigger) by extracting the iPhone Sync modal wrapper to a dedicated component.\n\n<strong>Problem</strong>\n\n<code>src/appCore/AppModals.tsx</code> at 169 lines is slightly over the 150-line trigger threshold for entry files as defined in <code>.claude/docs/shared/architecture-guardrails.md</code>:\n\n| File | Target | Trigger |\n|------|--------|---------|\n| <code>AppModals.tsx</code> | 150 | >150 |\n\nThe file handles multiple modal wrappers and could benefit from extracting the larger modal sections.\n\n<strong>Solution</strong>\n\nExtract the iPhone Sync modal wrapper to its own component:\n\n<strong>Target Structure</strong>\n\n<code>src/appCore/\n+-- AppModals.tsx           # Main modal orchestrator (target: <150 lines)\n+-- modals/\n    +-- index.ts            # Barrel export\n    +-- IPhoneSyncModal.tsx # iPhone sync modal wrapper\n    +-- (future extractions as needed)\n</code>\n\n<strong>Implementation Steps</strong>\n\n<strong>Step 1: Identify Extraction Target (~15 min)</strong>\n1. Review <code>AppModals.tsx</code> for largest sections\n2. iPhone Sync modal is likely the largest candidate\n3. Identify props and dependencies\n\n<strong>Step 2: Extract Component (~30 min)</strong>\n1. Create <code>modals/IPhoneSyncModal.tsx</code>\n2. Move modal logic and JSX\n3. Create proper TypeScript interface\n4. Add barrel export\n\n<strong>Step 3: Update AppModals (~10 min)</strong>\n1. Import extracted component\n2. Replace inline modal with component usage\n3. Pass required props\n\n<strong>Step 4: Verification (~15 min)</strong>\n1. <code>npm run type-check</code> passes\n2. <code>npm run lint</code> passes\n3. <code>npm test</code> passes\n4. Manual test of iPhone sync modal\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>AppModals.tsx</code> reduced to <150 lines\n\u2610 iPhone Sync modal extracted to dedicated component\n\u2610 All functionality preserved (no behavior changes)\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Tokens | ~10K | Simple extraction |\n| Duration | ~1 hour | |\n\n**Calibrated (0.5x refactor multiplier):**\n| Metric | Calibrated Estimate |\n|--------|---------------------|\n| Tokens | ~5K |\n\n<strong>Dependencies</strong>\n\n\u2022 None\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Breaking modal state | Keep state management in AppModals |\n| Props drilling | Pass minimal required props |\n\n<strong>Notes</strong>\n\n**This item is SR Engineer sourced from architecture review (2026-01-04).**\n\nThis is a LOW priority maintenance task. The file is only 19 lines over the trigger. Priority should be given to HIGH/CRITICAL items before addressing this.\n\nConsider batching with other small refactoring tasks in a \"cleanup sprint.\""
  },
  {
    "id": "BACKLOG-152",
    "title": "Split TransactionDetails.tsx into Tab Components",
    "category": "refactor",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-023",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-04",
    "completed_at": "",
    "file": "[BACKLOG-152.md](BACKLOG-152.md)",
    "description": "<strong>Priority: Medium</strong>\n\n<strong>Category: refactor</strong>\n\n<strong>Summary</strong>\n\nSplit <code>TransactionDetails.tsx</code> (832 lines) into tab-specific components and extract API logic to service abstractions.\n\n<strong>Problem</strong>\n\n<code>src/components/transaction/components/TransactionDetails.tsx</code> at 832 lines is a large modal component containing:\n\u2022 Multiple tabs (details, communications, attachments, etc.)\n\u2022 Direct <code>window.api</code> calls (architecture violation)\n\u2022 Mixed presentation and data fetching logic\n\u2022 Complex state management\n\nThis violates architecture guardrails from <code>.claude/docs/shared/architecture-guardrails.md</code>:\n\u2022 Direct <code>window.api</code> calls should use service abstractions\n\u2022 Large components should be split into focused sub-components\n\n<strong>Solution</strong>\n\n<strong>Phase 1: Extract Tab Components</strong>\n\n<code>src/components/transaction/\n+-- components/\n    +-- TransactionDetails.tsx      # Main modal (target: <400 lines)\n    +-- tabs/\n        +-- index.ts                # Barrel export\n        +-- TransactionInfoTab.tsx  # Basic transaction info\n        +-- CommunicationsTab.tsx   # Emails/texts display\n        +-- AttachmentsTab.tsx      # File attachments\n        +-- ContactsTab.tsx         # Associated contacts\n        +-- TimelineTab.tsx         # Transaction timeline (if exists)\n</code>\n\n<strong>Phase 2: Extract API Logic to Services</strong>\n\nReplace direct <code>window.api</code> calls with service abstractions:\n\n<code>// Before (architecture violation)\nconst data = await window.api.getTransactionDetails(id);\n\n// After (uses service abstraction)\nimport { transactionService } from '@/services';\nconst data = await transactionService.getDetails(id);\n</code>\n\n<strong>Implementation Steps</strong>\n\n<strong>Step 1: Analysis (~30 min)</strong>\n1. Identify all tabs in the modal\n2. Map <code>window.api</code> calls and their purposes\n3. Identify shared state between tabs\n4. Plan extraction boundaries\n\n<strong>Step 2: Tab Extraction (~2 hours)</strong>\n1. Extract each tab to its own component\n2. Pass required props from parent\n3. Keep tab switching logic in main component\n4. Create barrel exports\n\n<strong>Step 3: API Service Migration (~1 hour)</strong>\n1. Identify or create service abstractions\n2. Replace direct <code>window.api</code> calls\n3. Add proper error handling\n4. Add TypeScript types for API responses\n\n<strong>Step 4: Cleanup (~30 min)</strong>\n1. Update imports\n2. Verify all tests pass\n3. Manual testing of all tabs\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>TransactionDetails.tsx</code> reduced to <400 lines\n\u2610 All tabs extracted to dedicated components\n\u2610 No direct <code>window.api</code> calls in components\n\u2610 Service abstractions used for all API calls\n\u2610 All functionality preserved (no behavior changes)\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\u2610 Manual testing of transaction details modal\n\n<strong>Estimated Effort</strong>\n\n| Metric | Estimate | Notes |\n|--------|----------|-------|\n| Tokens | ~50K | Medium refactor with API migration |\n| Duration | 4-6 hours | |\n\n**Calibrated (0.5x refactor multiplier):**\n| Metric | Calibrated Estimate |\n|--------|---------------------|\n| Tokens | ~25K |\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-111 (Migrate Components to Service Abstractions) addresses the API migration pattern\n\u2022 Can be done independently, but benefits from service abstraction work being done first\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Breaking tab navigation | Keep tab state in parent component |\n| API call regressions | Integration tests for each tab |\n| State sharing issues | Use context or props carefully |\n\n<strong>Notes</strong>\n\n**This item is SR Engineer sourced from architecture review (2026-01-04).**\n\nThis task combines two concerns:\n1. Component size reduction (tab extraction)\n2. Architecture compliance (API call migration)\n\nConsider splitting into two tasks if preferred:\n\u2022 TASK-A: Tab extraction (pure refactor)\n\u2022 TASK-B: API migration (depends on BACKLOG-111 patterns)\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-111: Migrate Components to Service Abstractions (establishes patterns)\n\u2022 BACKLOG-098: Split AuditTransactionModal.tsx (similar refactor pattern)"
  },
  {
    "id": "BACKLOG-153",
    "title": "State Machine Email Connection Gap",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-153.md](items/BACKLOG-153.md)",
    "description": "<strong>Summary</strong>\n\nDuring SPRINT-023 (Architecture Debt Reduction), a gap was discovered in the state machine migration: the <code>setHasEmailConnected</code> setter was converted to a no-op, but no action was added to update the state machine when email connection completes during onboarding.\n\n<strong>Root Cause</strong>\n\nThe state machine migration (BACKLOG-142) made <code>setHasEmailConnected</code> a no-op because the state machine should be the source of truth. However:\n\n1. <code>selectHasEmailConnected</code> always returned <code>false</code> during onboarding status\n2. There was no <code>EMAIL_CONNECTED</code> action to update the state\n3. OAuth callbacks called <code>setHasEmailConnected(true)</code> but nothing happened\n\nThis caused the Email Connect page to stay stuck on \"Connecting...\" after successful OAuth.\n\n<strong>Fix Applied</strong>\n\nCommit <code>bcfae68</code> on 2026-01-04:\n\n1. Added <code>hasEmailConnected?: boolean</code> to <code>OnboardingState</code> interface\n2. Added <code>EMAIL_CONNECTED</code> action type to the state machine\n3. Updated reducer to handle <code>EMAIL_CONNECTED</code>\n4. Updated <code>selectHasEmailConnected</code> to read from onboarding state\n5. Updated <code>setHasEmailConnected</code> to dispatch the action\n6. Updated OAuth callbacks to pass email/provider\n\n<strong>Files Changed</strong>\n\n\u2022 <code>src/appCore/state/machine/types.ts</code>\n\u2022 <code>src/appCore/state/machine/reducer.ts</code>\n\u2022 <code>src/appCore/state/machine/selectors/userDataSelectors.ts</code>\n\u2022 <code>src/appCore/state/flows/useEmailOnboardingApi.ts</code>\n\u2022 <code>src/appCore/state/flows/useEmailHandlers.ts</code>\n\u2022 <code>src/components/onboarding/steps/EmailConnectStep.tsx</code>\n\n<strong>Lessons Learned</strong>\n\n1. **State machine migrations need integration testing** - Unit tests passed but the actual flow was broken\n2. **No-op setters need corresponding actions** - When converting setters to no-ops, ensure there's an action path\n3. **Test OAuth flows end-to-end** - The OAuth success case wasn't tested after the migration\n\n<strong>Process Violation</strong>\n\nThis fix was committed directly to <code>develop</code> branch instead of using a feature branch with PR review. See BACKLOG-154 for process enforcement.\n\n<strong>Status</strong>\n\n\u2611 Bug identified\n\u2611 Root cause analyzed\n\u2611 Fix implemented\n\u2611 Tests passing (567 tests)\n\u2611 Pushed to develop\n\u2610 Documented in retrospective\n\n<strong>Related</strong>\n\n\u2022 SPRINT-023: Architecture Debt Reduction\n\u2022 BACKLOG-142: State Machine Migration\n\u2022 BACKLOG-154: Branch Protection Enforcement"
  },
  {
    "id": "BACKLOG-154",
    "title": "Enforce Branch Protection for All Work",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-154.md](items/BACKLOG-154.md)",
    "description": "<strong>Summary</strong>\n\nClaude committed directly to <code>develop</code> branch instead of creating a feature/fix branch with PR review. This bypasses the quality gates and review process.\n\n<strong>Incident</strong>\n\nOn 2026-01-04, while fixing the email connection bug (BACKLOG-153), Claude:\n1. Made changes directly on <code>develop</code> branch\n2. Committed without creating a feature branch\n3. Pushed directly to <code>develop</code> (bypassing PR requirement)\n\n<strong>Why This Is a Problem</strong>\n\n1. **No PR review** - Changes weren't reviewed by SR Engineer agent\n2. **No CI validation** - Bypassed required status checks\n3. **No audit trail** - No PR description, no linked task\n4. **Risk of regression** - Direct commits can introduce bugs\n\n<strong>Required Enforcement</strong>\n\n<strong>1. Update CLAUDE.md (Mandatory)</strong>\n\nAdd explicit rule in the Git Branching Strategy section:\n\n<code><strong>CRITICAL: Never Commit Directly to develop or main</strong>\n\n**ALL work MUST go through a branch + PR workflow:**\n\n1. Create a branch: <code>git checkout -b fix/description</code> or <code>feature/description</code>\n2. Make changes and commit\n3. Push branch and create PR\n4. Wait for CI + review\n5. Merge via PR\n\n**There are NO exceptions.** Even \"quick fixes\" must use branches.\n\nIf you find yourself about to commit to develop/main, STOP and create a branch first.\n</code>\n\n<strong>2. Add Pre-Commit Check (Optional Enhancement)</strong>\n\nCould add a hook that prevents commits to protected branches:\n\n<code># .git/hooks/pre-commit\nbranch=$(git symbolic-ref HEAD 2>/dev/null | cut -d\"/\" -f 3)\nif [ \"$branch\" = \"develop\" ] || [ \"$branch\" = \"main\" ]; then\n  echo \"ERROR: Direct commits to $branch are not allowed.\"\n  echo \"Create a feature branch: git checkout -b fix/your-fix-name\"\n  exit 1\nfi\n</code>\n\n<strong>3. Claude Self-Check</strong>\n\nBefore any <code>git commit</code>, Claude should:\n1. Run <code>git branch --show-current</code>\n2. If on <code>develop</code> or <code>main</code>, create a branch first\n3. Never proceed with commit on protected branches\n\n<strong>Implementation Priority</strong>\n\n\u2022 **P1**: Update CLAUDE.md with explicit rule\n\u2022 **P2**: Add self-check to Claude's workflow\n\u2022 **P3**: Consider pre-commit hook (may interfere with legitimate merges)\n\n<strong>Status</strong>\n\n\u2611 Incident documented\n\u2610 CLAUDE.md updated\n\u2610 Process validated in next sprint\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-153: The bug fix that triggered this\n\u2022 CLAUDE.md: Development guide that needs updating"
  },
  {
    "id": "BACKLOG-155",
    "title": "Dashboard Unnecessary Vertical Scroll",
    "category": "ui",
    "priority": "Low",
    "status": "Completed",
    "sprint": "SPRINT-028",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "TASK-1004, PR #365",
    "created_at": "2026-01-04",
    "completed_at": "2026-01-10",
    "file": "[BACKLOG-155.md](BACKLOG-155.md)",
    "description": "<strong>Summary</strong>\n\nThe dashboard page allows vertical scrolling even when the content height is smaller than the viewport height. This creates a poor UX with unnecessary scroll bounce/movement.\n\n<strong>Expected Behavior</strong>\n\nWhen dashboard content fits within the viewport, there should be no vertical scrollbar and no ability to scroll up/down.\n\n<strong>Actual Behavior</strong>\n\nUsers can scroll up and down on the dashboard even when all content is visible without scrolling.\n\n<strong>Potential Causes</strong>\n\n1. **Container height issues** - Parent container may have <code>overflow-y: auto</code> or <code>scroll</code> when it should be <code>hidden</code> or <code>auto</code> with proper height constraints\n2. **Flex/grid layout gaps** - Flexbox or grid containers might be creating extra space\n3. **Body/html overflow** - Global styles may be forcing scroll behavior\n4. **Electron-specific** - Chromium in Electron may handle overflow differently\n5. **Content pushing beyond viewport** - Hidden elements or margins creating extra height\n\n<strong>Investigation Steps</strong>\n\n1. Check dashboard container CSS for overflow properties\n2. Inspect computed height of dashboard vs viewport\n3. Look for hidden elements adding to document height\n4. Check AppShell/layout wrapper overflow settings\n5. Test with DevTools to identify which element is causing scroll\n\n<strong>Files to Investigate</strong>\n\n\u2022 <code>src/components/Dashboard/</code> - Dashboard components\n\u2022 <code>src/components/AppShell.tsx</code> - Main layout wrapper\n\u2022 <code>src/App.tsx</code> - Root component styles\n\u2022 <code>src/index.css</code> or global styles - Body/html overflow rules\n\n<strong>Priority</strong>\n\nLow - Cosmetic issue, doesn't block functionality\n\n<strong>Status</strong>\n\n\u2610 Root cause identified\n\u2610 Fix implemented\n\u2610 Tested across screen sizes"
  },
  {
    "id": "BACKLOG-156",
    "title": "Auto-Refresh Data Sources on App Load",
    "category": "feature",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-028",
    "est_tokens": "~40K",
    "actual_tokens": "-",
    "variance": "TASK-1003, PR #369",
    "created_at": "2026-01-04",
    "completed_at": "2026-01-10",
    "file": "[BACKLOG-156.md](BACKLOG-156.md)",
    "description": "<strong>Summary</strong>\n\nAutomatically sync all available data sources when the user opens the application, eliminating the need to manually click \"Auto Detect\". This provides a seamless experience where users see their latest emails, texts, and contacts immediately.\n\n<strong>Priority</strong>\n\n**High** - Significant UX improvement, reduces friction for daily use\n\n<strong>Category</strong>\n\n**service/enhancement**\n\n<strong>Problem</strong>\n\nCurrently, users must manually trigger sync/detection after opening the app. This adds unnecessary friction, especially for users who check the app daily. The data sources that don't require device connection should refresh automatically.\n\n<strong>Solution</strong>\n\nOn app startup (after authentication and database initialization), automatically trigger sync for all available data sources based on platform:\n\n<strong>Platform Matrix</strong>\n\n| Data Source | Windows | macOS | Method |\n|-------------|---------|-------|--------|\n| Gmail | Yes | Yes | API - fetch new emails since last sync |\n| Outlook | Yes | Yes | API - fetch new emails since last sync |\n| Text Messages | No | Yes | Local iMessage database |\n| Contacts | No | Yes | Local Contacts database |\n| iPhone Backup | No | No | Requires manual trigger (device must be connected) |\n\n<strong>Behavior</strong>\n\n1. **Trigger point**: After successful authentication AND database initialization\n2. **Parallel execution**: Sync all available sources concurrently\n3. **Background operation**: Don't block UI - show subtle progress indicator\n4. **AI Detection**: After sync completes, run AI transaction detection on new items\n5. **Error handling**: Silent failures for individual sources (log but don't alert user)\n6. **Incremental**: Only fetch new data since last sync (use existing incremental sync from BACKLOG-090)\n\n<strong>UI Considerations</strong>\n\n\u2022 Show subtle sync indicator in dashboard/header during refresh\n\u2022 Don't show modal or blocking UI\n\u2022 Show toast notification when new transactions are detected\n\u2022 Allow user to disable in Settings (optional - discuss with user)\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Email sync triggers automatically on app load (Gmail + Outlook)\n\u2610 Text message sync triggers automatically on macOS\n\u2610 Contact sync triggers automatically on macOS\n\u2610 AI auto-detection runs after sync completes\n\u2610 User sees their latest data without clicking any buttons\n\u2610 Sync uses incremental approach (only new data)\n\u2610 UI remains responsive during background sync\n\u2610 Errors are logged but don't interrupt user\n\n<strong>Technical Notes</strong>\n\n\u2022 Leverage existing sync services (emailSyncService, contactsService, etc.)\n\u2022 Use existing incremental sync infrastructure from SPRINT-014 (BACKLOG-090)\n\u2022 Coordinate with state machine - trigger after <code>authenticated</code> + <code>databaseReady</code> states\n\u2022 Consider adding a brief delay (2-3 seconds) after UI renders to avoid startup slowdown\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-090 (Incremental Sync) - **Completed**\n\u2022 BACKLOG-142 (State Coordination) - **Completed**\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-024: Auto-Start Sync on Launch (similar scope - consider merging or marking duplicate)\n\n<strong>Estimate</strong>\n\n\u2022 **Est. Tokens**: ~40K\n\u2022 **Category Adjustment**: service \u00d7 0.50 = ~20K implementation\n\u2022 **SR Review Overhead**: +15-25K\n\u2022 **Total Estimate**: ~35-45K tokens\n\n<strong>Status</strong>\n\n**Pending** - Ready for sprint assignment"
  },
  {
    "id": "BACKLOG-157",
    "title": "Fix Failing Auth Handler Integration Test",
    "category": "test",
    "priority": "High",
    "status": "Obsolete",
    "sprint": "-",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-04",
    "completed_at": "",
    "file": "[BACKLOG-157.md](BACKLOG-157.md)",
    "description": "<strong>Summary</strong>\n\nThe auth-handlers integration test \"should restore session on get-current-user\" is failing, causing CI to report 748/749 tests passing.\n\n<strong>Problem</strong>\n\n<code>electron/__tests__/auth-handlers.integration.test.ts\n\nTest: \"should restore session on get-current-user\"\nExpected: result.success === true\nReceived: result.success === false\n</code>\n\n<strong>Root Cause (Investigation Needed)</strong>\n\nLikely related to recent state machine changes:\n\u2022 SPRINT-022/023 modified session handling\n\u2022 <code>handleGetCurrentUser</code> now checks <code>databaseService.isInitialized()</code>\n\u2022 Test may not be setting up database state correctly\n\n<strong>Files to Investigate</strong>\n\n\u2022 <code>electron/__tests__/auth-handlers.integration.test.ts</code> - The failing test\n\u2022 <code>electron/handlers/sessionHandlers.ts</code> - Handler implementation\n\u2022 <code>electron/services/databaseService.ts</code> - Database init check\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 All 749 tests pass\n\u2610 No changes that break session restoration in production\n\u2610 Test properly mocks database state if needed\n\n<strong>Priority</strong>\n\n**HIGH** - Blocking CI, must fix before adding more tests\n\n<strong>Estimate</strong>\n\n~15K tokens\n\n<strong>Category</strong>\n\ntest/fix"
  },
  {
    "id": "BACKLOG-158",
    "title": "Decompose AuditTransactionModal Component",
    "category": "refactor",
    "priority": "Medium",
    "status": "Obsolete",
    "sprint": "-",
    "est_tokens": "~60K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-04",
    "completed_at": "",
    "file": "[BACKLOG-158.md](BACKLOG-158.md)",
    "description": "<strong>Summary</strong>\n\n<code>AuditTransactionModal.tsx</code> is 1,187 lines - the largest component in the codebase. It should be decomposed into smaller, focused components.\n\n<strong>Problem</strong>\n\nThe component handles too many concerns:\n\u2022 Transaction form fields\n\u2022 Address input with autocomplete\n\u2022 Contact assignment UI\n\u2022 Validation logic\n\u2022 API interactions\n\u2022 Modal state management\n\nThis violates single responsibility principle and makes the code hard to maintain and test.\n\n<strong>Proposed Decomposition</strong>\n\n| New File | Responsibility | Est. Lines |\n|----------|---------------|------------|\n| <code>AuditTransactionForm.tsx</code> | Form fields and layout | ~200 |\n| <code>AddressInput.tsx</code> | Address autocomplete component | ~150 |\n| <code>ContactAssignment.tsx</code> | Contact selection UI | ~150 |\n| <code>useAuditTransaction.ts</code> | Business logic hook | ~200 |\n| <code>AuditTransactionModal.tsx</code> | Orchestrator only | <300 |\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Parent component reduced to <300 lines\n\u2610 4-5 new files extracted\n\u2610 All existing functionality preserved\n\u2610 All existing tests pass\n\u2610 New components are individually testable\n\n<strong>Priority</strong>\n\n**MEDIUM** - Important for maintainability but not blocking\n\n<strong>Estimate</strong>\n\n~60K tokens\n\n<strong>Category</strong>\n\nrefactor\n\n<strong>Dependencies</strong>\n\nShould have good test coverage before refactoring (BACKLOG-112, 113)"
  },
  {
    "id": "BACKLOG-159",
    "title": "Delete Deprecated PermissionsScreen.tsx",
    "category": "refactor",
    "priority": "Medium",
    "status": "Obsolete",
    "sprint": "-",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-04",
    "completed_at": "",
    "file": "[BACKLOG-159.md](BACKLOG-159.md)",
    "description": "<strong>Summary</strong>\n\n<code>PermissionsScreen.tsx</code> (873 lines) is marked as deprecated but still exists in the codebase. It should be deleted after verifying the replacement is complete.\n\n<strong>Problem</strong>\n\nThe file header says:\n<code>/**\n * @deprecated Use <code>onboarding/steps/PermissionsStep.tsx</code> instead.\n * This file will be removed after migration is complete.\n */\n</code>\n\nHowever, the file was never deleted, adding 873 lines of dead/duplicate code.\n\n<strong>Verification Steps</strong>\n\n1. Confirm <code>PermissionsStep.tsx</code> handles all use cases\n2. Search for any remaining imports of <code>PermissionsScreen</code>\n3. Check route definitions for references\n4. Verify onboarding flow works without it\n\n<strong>Files</strong>\n\n\u2022 <code>src/components/PermissionsScreen.tsx</code> - DELETE\n\u2022 Any files importing it - UPDATE\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 PermissionsScreen.tsx deleted\n\u2610 No broken imports\n\u2610 Onboarding permissions flow still works\n\u2610 No TypeScript errors\n\n<strong>Priority</strong>\n\n**MEDIUM** - Dead code removal, quick win\n\n<strong>Estimate</strong>\n\n~10K tokens\n\n<strong>Category</strong>\n\nrefactor/cleanup"
  },
  {
    "id": "BACKLOG-160",
    "title": "Consolidate last_exported_at/on Column Naming",
    "category": "refactor",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~5K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-161",
    "title": "Agent Anti-Loop Enforcement (Exploration + Verification)",
    "category": "infra",
    "priority": "Critical",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-161.md](items/BACKLOG-161.md)",
    "description": "<strong>Problem</strong>\n\nEngineer agents can get stuck in TWO types of loops:\n\n1. **Exploration Loop**: Reading files endlessly before writing code\n2. **Verification Loop**: Running type-check/tests repeatedly after code is written\n\nSPRINT-025 TASK-976 burned **14.2M tokens** (2849x over estimate) primarily in a verification loop - the agent kept running <code>npm run type-check</code> and reading files trying to \"fix\" a type error that was already resolved.\n\n<strong>Root Causes</strong>\n\n1. **No tool call limits** - Agent can make unlimited Read/Bash calls\n2. **No \"give up\" threshold** - Agent tries forever instead of asking for help\n3. **No loop detection** - Same command repeated 50+ times goes unnoticed\n4. **Background execution** - No human monitoring until too late\n5. **Perfectionism** - Agent won't commit until everything \"feels right\"\n6. **PM monitoring failure** - PM launched agent and didn't check until USER noticed the problem\n\n<strong>Proposed Solutions</strong>\n\n<strong>Solution 1: PostToolUse Hook with Loop Detection</strong>\n\n<code>#!/bin/bash\n# .claude/hooks/loop-detector.sh\n\nTOOL=\"$1\"\nAGENT_ID=\"${CLAUDE_AGENT_ID:-default}\"\nSTATE_FILE=\"/tmp/claude-agent-${AGENT_ID}.state\"\n\n# Initialize state file\ntouch \"$STATE_FILE\"\n\n# Track tool usage\nif [[ \"$TOOL\" =~ Read|Glob|Grep ]]; then\n  EXPLORE_COUNT=$(($(grep \"explore:\" \"$STATE_FILE\" | cut -d: -f2) + 1))\n  sed -i '' \"s/explore:.*/explore:$EXPLORE_COUNT/\" \"$STATE_FILE\" 2>/dev/null || echo \"explore:$EXPLORE_COUNT\" >> \"$STATE_FILE\"\n\n  if [ \"$EXPLORE_COUNT\" -gt 20 ]; then\n    echo \"\u26a0\ufe0f WARNING: $EXPLORE_COUNT exploration calls. Start writing code or ask for help!\" >&2\n  fi\n\nelif [[ \"$TOOL\" =~ Write|Edit ]]; then\n  # Reset exploration counter on write\n  sed -i '' \"s/explore:.*/explore:0/\" \"$STATE_FILE\" 2>/dev/null\n\nelif [[ \"$TOOL\" == \"Bash\" ]]; then\n  # Track repeated bash commands (verification loop)\n  LAST_CMD=$(grep \"lastcmd:\" \"$STATE_FILE\" | cut -d: -f2-)\n  CURRENT_CMD=\"$2\"  # Command argument\n\n  if [[ \"$CURRENT_CMD\" == \"$LAST_CMD\" ]]; then\n    REPEAT_COUNT=$(($(grep \"repeat:\" \"$STATE_FILE\" | cut -d: -f2) + 1))\n    sed -i '' \"s/repeat:.*/repeat:$REPEAT_COUNT/\" \"$STATE_FILE\" 2>/dev/null || echo \"repeat:$REPEAT_COUNT\" >> \"$STATE_FILE\"\n\n    if [ \"$REPEAT_COUNT\" -gt 5 ]; then\n      echo \"\ud83d\uded1 STOP: You've run the same command $REPEAT_COUNT times. Either:\" >&2\n      echo \"   1. The issue is fixed - commit and move on\" >&2\n      echo \"   2. You're stuck - ask for help\" >&2\n      echo \"   3. Try a DIFFERENT approach\" >&2\n    fi\n  else\n    sed -i '' \"s/repeat:.*/repeat:0/\" \"$STATE_FILE\" 2>/dev/null\n    sed -i '' \"s/lastcmd:.*/lastcmd:$CURRENT_CMD/\" \"$STATE_FILE\" 2>/dev/null || echo \"lastcmd:$CURRENT_CMD\" >> \"$STATE_FILE\"\n  fi\nfi\n</code>\n\n<strong>Solution 2: Engineer Agent Prompt Update</strong>\n\nAdd to <code>.claude/agents/engineer.md</code>:\n\n<code><strong>Anti-Loop Rules (MANDATORY)</strong>\n\n<strong>Exploration Limits</strong>\n\u2022 Read max 10 files before your first Write/Edit\n\u2022 If you need more context, write a minimal implementation first, then iterate\n\u2022 Don't try to understand the entire codebase - focus on what you're changing\n\n<strong>Verification Limits</strong>\n\u2022 Run type-check/lint/test MAX 3 times for the same issue\n\u2022 If it fails 3 times with the same error:\n  1. Commit what you have with a TODO comment\n  2. Document the issue in your PR\n  3. Ask for help or move on\n\n<strong>When Stuck</strong>\n\u2022 DO NOT repeat the same action hoping for different results\n\u2022 DO say \"I'm stuck on X, I've tried Y and Z\"\n\u2022 DO commit partial progress rather than burning tokens\n\n<strong>Background Agent Rule</strong>\n\u2022 Check in every 30 minutes of work\n\u2022 If making no progress for 15 minutes, STOP and report status\n</code>\n\n<strong>Solution 3: Token Budget Kill Switch</strong>\n\nAdd to PM workflow:\n\u2022 Set max token budget per task (e.g., 10x estimate)\n\u2022 Monitor background agents every 30 minutes\n\u2022 Kill agents exceeding budget with no output\n\n<strong>Solution 4: PM Background Agent Monitoring Protocol (MANDATORY)</strong>\n\n**The hook is a safety net. Monitoring is the primary defense.**\n\nWhen launching background agents, PM MUST:\n\n<code><strong>Background Agent Launch Checklist</strong>\n\nBEFORE launching:\n\u2610 Note the estimated token budget (e.g., 5K)\n\u2610 Set timer for 30-minute check-in\n\u2610 Record agent task_id\n\nAT 30-minute check-in:\n\u2610 Check agent status: <code>TaskOutput --task_id=<id> --block=false</code>\n\u2610 Verify progress: Has agent produced commits/PRs?\n\u2610 Check token consumption: Is it within 5x estimate?\n\u2610 If stuck: Kill agent, investigate, restart with guidance\n\nNEVER:\n\u2022 Launch and forget\n\u2022 Wait for user to notice problems\n\u2022 Assume \"no news is good news\"\n</code>\n\n**SPRINT-025 Failure Example:**\n\u2022 Agent launched at T+0\n\u2022 User noticed token burn at T+???\n\u2022 PM only investigated AFTER user raised concern\n\u2022 If user hadn't noticed, agent could have burned 100M+ tokens\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Hook detects exploration loop (>20 Read/Glob/Grep without Write)\n\u2610 Hook detects verification loop (>5 identical Bash commands)\n\u2610 Warning messages injected to agent context\n\u2610 Engineer agent prompt includes anti-loop rules\n\u2610 PM checklist includes \"check file overlap before parallel execution\"\n\u2610 Background agent monitoring documented\n\u2610 PM skill updated with mandatory monitoring protocol (Solution 4)\n\u2610 agentic-pm.md includes \"30-minute check-in\" requirement for background agents\n\n<strong>Incident Reference</strong>\n\n**SPRINT-025 TASK-976:**\n\u2022 14.2M tokens consumed\n\u2022 2849x over 5K estimate\n\u2022 Agent ran <code>npm run type-check</code> 20+ times\n\u2022 Agent read same files repeatedly\n\u2022 Code was DONE - agent couldn't recognize success\n\n**PM Monitoring Failure:**\n\u2022 PM launched agent in background and did NOT monitor\n\u2022 USER noticed the token consumption and asked about it\n\u2022 PM only verified work output AFTER user raised concerns\n\u2022 PM never proactively checked the worktree or agent progress\n\u2022 This is a discipline failure, not a tooling gap\n\n<strong>Estimate</strong>\n\n~5,000 tokens (hook implementation + prompt updates + documentation)"
  },
  {
    "id": "BACKLOG-162",
    "title": "Fix CI Validate PR Metrics Bash Escaping",
    "category": "infra",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-162.md](items/BACKLOG-162.md)",
    "description": "<strong>Problem</strong>\n\nThe \"Validate PR Metrics\" CI workflow fails when PR body contains certain text patterns that bash interprets as commands.\n\n**Error observed**:\n<code>built-in: command not found\nProcess completed with exit code 127\n</code>\n\n**Root Cause**: The CI script reads PR body content into a bash variable without proper escaping. When the PR body contains \"Electron's built-in printToPDF\", bash tries to execute \"built-in\" as a command.\n\n<strong>Reproduction</strong>\n\nAny PR with body text containing:\n\u2022 \"built-in\"\n\u2022 Other shell-interpreted patterns\n\n<strong>Proposed Fix</strong>\n\nIn <code>.github/workflows/ci.yml</code>, the PR body should be:\n1. Properly quoted when assigned to variable\n2. Or use <code>printf '%s'</code> instead of direct assignment\n3. Or use a different parsing approach (jq with proper escaping)\n\n<strong>Example Fix</strong>\n\n<code># Before (broken)\nPR_BODY='${{ github.event.pull_request.body }}'\n\n# After (fixed)\nPR_BODY=$(cat <<'EOFBODY'\n${{ github.event.pull_request.body }}\nEOFBODY\n)\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 CI passes when PR body contains \"built-in\"\n\u2610 CI passes when PR body contains shell special characters\n\u2610 No false positives on valid PRs\n\n<strong>Incident Reference</strong>\n\nSPRINT-025: PRs #334 and #335 required <code>--admin</code> flag to merge due to this false failure.\n\n<strong>Estimate</strong>\n\n~1,000 tokens (simple CI fix)"
  },
  {
    "id": "BACKLOG-163",
    "title": "Edit Active Transactions",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "SPRINT-026",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-163.md](items/BACKLOG-163.md)",
    "description": "<strong>Problem</strong>\n\nCurrently, the Edit button only appears for \"Pending Review\" transactions. Once a transaction is approved and becomes \"Active\", users cannot edit it.\n\nUsers need to edit active transactions to:\n\u2022 Update property details (address corrections)\n\u2022 Change transaction stage (offer \u2192 inspection \u2192 closing)\n\u2022 Modify dates\n\u2022 Update notes\n\n<strong>Current Behavior</strong>\n\n| Status | Edit Available? |\n|--------|-----------------|\n| Pending Review | \u2705 Yes |\n| Active | \u274c No |\n| Rejected | \u274c No |\n\n<strong>Proposed Change</strong>\n\nAdd Edit button to Active transactions in <code>TransactionHeader.tsx</code>.\n\n<strong>Files Affected</strong>\n\n\u2022 <code>src/components/transactionDetailsModule/components/TransactionHeader.tsx</code>\n\u2022 <code>src/components/transaction/components/EditTransactionModal.tsx</code> (verify compatibility)\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Edit button visible for Active transactions\n\u2610 EditTransactionModal opens and works for active transactions\n\u2610 Changes save correctly\n\u2610 No regression for Pending Review edit flow\n\n<strong>Estimate</strong>\n\n~4,000 tokens (simple UI addition)\n\n<strong>Task Reference</strong>\n\nTASK-981"
  },
  {
    "id": "BACKLOG-164",
    "title": "Rename \"Bulk Edit\" to \"Edit\" in Transaction List",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-164.md](items/BACKLOG-164.md)",
    "description": "<strong>Problem</strong>\n\nThe \"Bulk Edit\" button in the transaction list toolbar is confusing. It should just say \"Edit\" since it enables selection mode for editing multiple transactions.\n\n<strong>Current Behavior</strong>\n\nButton says \"Bulk Edit\" which implies:\n\u2022 A special bulk-only operation\n\u2022 Different from regular editing\n\n<strong>Proposed Change</strong>\n\nRename button from \"Bulk Edit\" to \"Edit\" (or \"Select\" to be clearer about what it does).\n\n<strong>Files Affected</strong>\n\n\u2022 <code>src/components/transaction/components/TransactionToolbar.tsx</code> (line ~306)\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Button text changed from \"Bulk Edit\" to \"Edit\"\n\u2610 No functional changes\n\n<strong>Estimate</strong>\n\n~500 tokens (simple text change)"
  },
  {
    "id": "BACKLOG-165",
    "title": "Duplicate Contacts in Import Contacts Page",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "SPRINT-055a",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-05",
    "completed_at": "",
    "file": "[BACKLOG-165.md](BACKLOG-165.md)",
    "description": "<strong>Problem</strong>\nEvery contact appears twice in the Import Contacts page, causing confusion and potential duplicate imports.\n\n<strong>Impact</strong>\n\u2022 **User Experience**: Confusing UI with duplicate entries\n\u2022 **Data Integrity**: Risk of importing the same contact multiple times\n\u2022 **Priority**: Medium\n\n<strong>Root Cause (To Investigate)</strong>\nLikely causes:\n1. <code>contacts:get-available</code> handler combines iPhone-synced contacts AND macOS Contacts app contacts without proper deduplication\n2. The deduplication logic in <code>contact-handlers.ts</code> (lines 119-180) may not be catching all duplicates\n3. Same contact may exist in both <code>unimportedDbContacts</code> (from iPhone sync) and <code>phoneToContactInfo</code> (from macOS Contacts app)\n\n<strong>Relevant Code</strong>\n\u2022 <code>electron/contact-handlers.ts</code> - <code>contacts:get-available</code> handler (lines 94-218)\n\u2022 Deduplication uses <code>seenContacts</code> Set with lowercase name as key\n\u2022 May need to also dedupe by email/phone\n\n<strong>Acceptance Criteria</strong>\n\u2610 Each contact appears only once in Import Contacts page\n\u2610 Deduplication considers name, email, AND phone\n\u2610 Contacts from iPhone sync take precedence (they have real DB IDs)\n\n<strong>Notes</strong>\n\u2022 Discovered: 2025-01-05\n\u2022 Reporter: User"
  },
  {
    "id": "BACKLOG-166",
    "title": "Platform Detection Returns \"unknown\" in Renderer",
    "category": "service",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-05",
    "completed_at": "",
    "file": "[BACKLOG-166.md](BACKLOG-166.md)",
    "description": "<strong>Problem</strong>\nThe platform detection in <code>src/utils/platform.ts</code> returns \"unknown\" instead of the actual platform (e.g., \"darwin\" for macOS), causing the warning:\n\n<code>[Platform] Unknown platform detected: \"unknown\". Defaulting to Windows.\n</code>\n\nThis affects feature availability checks (e.g., whether to show local Messages access or iPhone USB sync options).\n\n<strong>Impact</strong>\n\u2022 **User Experience**: Users on macOS may see Windows-specific UI/features\n\u2022 **Functionality**: Platform-specific features may not work correctly\n\u2022 **Priority**: Medium\n\n<strong>Root Cause Analysis</strong>\nThe code at <code>src/utils/platform.ts:19</code>:\n<code>const platform = window.api?.system?.platform || \"unknown\";\n</code>\n\n<code>window.api.system.platform</code> is exposed via preload (<code>electron/preload/systemBridge.ts:12</code>):\n<code>platform: process.platform,\n</code>\n\nPossible causes:\n1. **Timing issue**: PlatformContext renders before <code>window.api</code> is populated by contextBridge\n2. **Preload not loaded**: The preload script may not have run when the component first renders\n3. **contextBridge race condition**: The React app starts before Electron's contextBridge completes\n\n<strong>Potential Fixes</strong>\n\n<strong>Option 1: Add null check with retry (Quick Fix)</strong>\n<code>export function getPlatform(): Platform {\n  const platform = window.api?.system?.platform;\n\n  if (!platform) {\n    // Could be timing issue - check navigator as fallback\n    const userAgent = navigator.userAgent.toLowerCase();\n    if (userAgent.includes('mac')) return 'macos';\n    if (userAgent.includes('win')) return 'windows';\n    if (userAgent.includes('linux')) return 'linux';\n    return 'windows'; // Default\n  }\n  // ... rest of switch\n}\n</code>\n\n<strong>Option 2: Use navigator.platform (More Reliable)</strong>\n<code>export function getPlatform(): Platform {\n  // Check Electron API first, fallback to navigator\n  const electronPlatform = window.api?.system?.platform;\n  const platform = electronPlatform || navigator.platform?.toLowerCase() || 'unknown';\n\n  if (platform.includes('mac') || platform === 'darwin') return 'macos';\n  if (platform.includes('win')) return 'windows';\n  if (platform.includes('linux')) return 'linux';\n  return 'windows';\n}\n</code>\n\n<strong>Option 3: Defer PlatformContext initialization</strong>\nEnsure PlatformProvider only renders after window.api is confirmed available.\n\n<strong>Relevant Code</strong>\n\u2022 <code>src/utils/platform.ts</code> - Platform detection utility\n\u2022 <code>src/contexts/PlatformContext.tsx</code> - Platform context provider\n\u2022 <code>electron/preload/systemBridge.ts</code> - Exposes platform to renderer\n\n<strong>Acceptance Criteria</strong>\n\u2610 Platform correctly detected as \"macos\" on macOS\n\u2610 Platform correctly detected as \"windows\" on Windows\n\u2610 No console warnings about unknown platform\n\u2610 Feature availability works correctly per platform\n\n<strong>Notes</strong>\n\u2022 Discovered: 2026-01-05\n\u2022 The CSP warning is expected in dev mode (disappears when packaged)"
  },
  {
    "id": "BACKLOG-167",
    "title": "Restrict Status Options for Manual Transactions",
    "category": "feature",
    "priority": "Low",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "Already implemented in BulkActionBar.tsx",
    "created_at": "2026-01-05",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-167.md](BACKLOG-167.md)",
    "description": "<strong>Problem</strong>\nManual transactions (created by user, not AI-detected) can currently be set to \"pending\" or \"rejected\" status via bulk edit. These statuses don't make sense for manual transactions:\n\n\u2022 **pending**: Meant for AI-detected transactions awaiting user review\n\u2022 **rejected**: Meant for AI-detected transactions the user rejected as false positives\n\nManual transactions should only have \"active\" or \"closed\" status.\n\n<strong>Impact</strong>\n\u2022 **User Experience**: Confusing to have irrelevant status options\n\u2022 **Data Integrity**: Status semantics become unclear\n\u2022 **Priority**: Low\n\n<strong>Current Behavior</strong>\n1. User creates manual transaction \u2192 status = \"active\", detection_source = \"manual\"\n2. User selects transaction \u2192 bulk edit \u2192 can change to any of 4 statuses\n3. Setting to \"pending\" triggers pending review UI (amber styling, Edit button)\n4. Setting to \"rejected\" hides from Active tab\n\n<strong>Expected Behavior</strong>\n1. Manual transactions (<code>detection_source === \"manual\"</code>) should only allow:\n   - <code>active</code> \u2192 <code>closed</code> (transaction completed)\n   - <code>closed</code> \u2192 <code>active</code> (reopen if needed)\n2. AI-detected transactions (<code>detection_source === \"auto\"</code>) can use all 4 statuses\n\n<strong>Proposed Solution</strong>\n\n<strong>Option 1: Filter in BulkActionBar (UI-only)</strong>\n<code>// In BulkActionBar.tsx\nconst availableStatuses = selectedTransactions.some(t => t.detection_source === 'manual')\n  ? ['active', 'closed']  // Manual transactions\n  : ['pending', 'active', 'closed', 'rejected'];  // AI-detected\n</code>\n\n<strong>Option 2: Validate in Backend</strong>\n<code>// In transaction-handlers.ts bulk-update-status\nif (status === 'pending' || status === 'rejected') {\n  // Check if any selected transactions are manual\n  const manualTransactions = transactions.filter(t => t.detection_source === 'manual');\n  if (manualTransactions.length > 0) {\n    throw new ValidationError('Manual transactions cannot be set to pending/rejected');\n  }\n}\n</code>\n\n<strong>Option 3: Both (Recommended)</strong>\n\u2022 UI filters available options based on selection\n\u2022 Backend validates as safety net\n\n<strong>Relevant Code</strong>\n\u2022 <code>src/components/BulkActionBar.tsx</code> - Status dropdown\n\u2022 <code>electron/transaction-handlers.ts</code> - <code>transactions:bulk-update-status</code> handler\n\u2022 <code>src/components/transaction/hooks/useBulkActions.ts</code> - <code>handleBulkStatusChange</code>\n\n<strong>Acceptance Criteria</strong>\n\u2610 Manual transactions cannot be set to \"pending\" via bulk edit\n\u2610 Manual transactions cannot be set to \"rejected\" via bulk edit\n\u2610 AI-detected transactions can still use all 4 statuses\n\u2610 Clear error message if user somehow tries invalid status change\n\u2610 Mixed selection (manual + AI) shows only common valid statuses\n\n<strong>Notes</strong>\n\u2022 Discovered: 2026-01-05\n\u2022 Related to BACKLOG-164 (rename Bulk Edit to Edit)"
  },
  {
    "id": "BACKLOG-168",
    "title": "Transaction Bulk Edit Multi-Select Modal",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-05",
    "completed_at": "",
    "file": "[BACKLOG-168.md](BACKLOG-168.md)",
    "description": "*Created: 2026-01-05*\n*Status: Pending*"
  },
  {
    "id": "BACKLOG-169",
    "title": "Show in Folder Button for Exports",
    "category": "ui",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-028",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "TASK-1008, PR #366",
    "created_at": "2026-01-05",
    "completed_at": "2026-01-10",
    "file": "[BACKLOG-169.md](BACKLOG-169.md)",
    "description": "<strong>Description</strong>\n\nAfter exporting a transaction, add a button that opens the containing folder in Finder (macOS) or File Explorer (Windows) so users can quickly locate their exported file.\n\n<strong>User Story</strong>\n\nAs a user, after I export a transaction, I want to be able to click a button to open the folder where the export was saved, so I can easily find and share the exported file.\n\n<strong>Current Behavior</strong>\n\n\u2022 User exports transaction\n\u2022 Success message shows the file path\n\u2022 User must manually navigate to the folder\n\n<strong>Desired Behavior</strong>\n\n\u2022 User exports transaction\n\u2022 Success message shows file path AND a \"Show in Folder\" button\n\u2022 Clicking the button opens Finder/File Explorer with the file selected\n\n<strong>Technical Approach</strong>\n\n<strong>Backend (Electron)</strong>\n\nUse Electron's <code>shell.showItemInFolder(fullPath)</code> API:\n\n<code>// In system-handlers.ts or export-handlers.ts\nipcMain.handle(\"system:show-in-folder\", async (event, filePath: string) => {\n  const { shell } = require(\"electron\");\n  shell.showItemInFolder(filePath);\n  return { success: true };\n});\n</code>\n\n<strong>Frontend</strong>\n\nUpdate <code>ExportSuccessMessage</code> component or the export modal to include a \"Show in Folder\" button:\n\n<code><button onClick={() => window.api.system.showInFolder(exportPath)}>\n  Show in Folder\n</button>\n</code>\n\n<strong>Files to Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>electron/system-handlers.ts</code> | Add <code>system:show-in-folder</code> handler |\n| <code>electron/preload/systemBridge.ts</code> | Expose <code>showInFolder</code> method |\n| <code>src/components/ExportModal.tsx</code> | Add \"Show in Folder\" button after export |\n| <code>src/components/transactionDetailsModule/components/ExportSuccessMessage.tsx</code> | Add button (if exists) |\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 \"Show in Folder\" button appears after successful export\n\u2610 Button opens Finder on macOS with file selected\n\u2610 Button opens File Explorer on Windows with file selected\n\u2610 Works for all export formats (PDF, etc.)\n\n<strong>Estimate</strong>\n\n~5,000 tokens (simple Electron API usage)\n\n<strong>Notes</strong>\n\n\u2022 Electron's <code>shell.showItemInFolder()</code> is cross-platform and handles both macOS and Windows\n\u2022 The file must exist for this to work; should handle gracefully if file was moved/deleted"
  },
  {
    "id": "BACKLOG-170",
    "title": "Messages Not Loading in Attach Modal",
    "category": "fix",
    "priority": "Critical",
    "status": "Deferred",
    "sprint": "-",
    "est_tokens": "~5K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-05",
    "completed_at": "",
    "file": "[BACKLOG-170.md](BACKLOG-170.md)",
    "description": "<strong>Description</strong>\n\nWhen opening the \"Attach Messages\" modal from a transaction's Messages tab, no messages appear on macOS. The modal shows:\n\u2022 \"No unlinked messages available\"\n\u2022 \"All message threads are already linked to transactions\"\n\n<strong>Root Cause Analysis (TASK-985)</strong>\n\n<strong>Initial Investigation</strong>\n1. Fixed channel/communication_type field name mismatch in <code>getUnlinkedMessages()</code> (PR #342)\n2. Added debug logging to verify the fix\n\n<strong>Actual Root Cause</strong>\nThe database only contains **emails** - no text messages. This is because:\n\n1. **macOS Messages Access Gap**: The app can READ from <code>~/Library/Messages/chat.db</code> for export/display (via <code>conversationHandlers.ts</code>), but there is **no import mechanism** to store those messages in the app's internal <code>messages</code> table.\n\n2. **iPhone Sync Only**: Text messages only get imported into the database via iPhone backup sync (<code>syncOrchestrator.ts</code> + <code>iPhoneSyncStorageService.ts</code>), which is designed for **Windows/Linux** platforms.\n\n3. **Platform Mismatch**: The <code>platform.ts</code> config says macOS should have <code>localMessagesAccess: [\"macos\"]</code>, implying direct access. But the Attach Messages modal queries the internal database, not the macOS Messages database.\n\n<strong>Architecture</strong>\n<code>macOS chat.db \u2500\u2500(export only)\u2500\u2500> conversationHandlers.ts \u2500\u2500> Text Export\n                                (NO import to messages table)\n\niPhone backup \u2500\u2500(Windows/Linux)\u2500\u2500> syncOrchestrator.ts \u2500\u2500> messages table \u2500\u2500> Attach Modal\n</code>\n\n<strong>Resolution</strong>\n\nThis is not a bug but a **missing feature**. The fix requires implementing:\n\n**BACKLOG-172: macOS Messages Import**\n\u2022 Read from <code>~/Library/Messages/chat.db</code>\n\u2022 Import messages into the app's <code>messages</code> table\n\u2022 Use Full Disk Access permission (already checked)\n\n<strong>PR #342 (Partial Fix)</strong>\n\nThe channel name fix in PR #342 is still valid and necessary:\n\u2022 Fixed filter to check both <code>channel</code> and <code>communication_type</code> field names\n\u2022 Fixed filter to accept both <code>\"sms\"/\"imessage\"</code> and <code>\"text\"/\"imessage\"</code> values\n\u2022 This fix will be needed once messages ARE in the database (after BACKLOG-171)\n\n<strong>Files Modified</strong>\n\n| File | Change |\n|------|--------|\n| <code>electron/services/transactionService.ts</code> | Fixed channel filter logic |\n\n<strong>Acceptance Criteria</strong>\n\n\u2611 Channel name mismatch fixed (PR #342)\n\u2611 Root cause identified and documented\n\u2610 macOS Messages import implemented (BACKLOG-172)\n\u2610 Unlinked messages appear in attach modal on macOS\n\n<strong>Debug Output (for reference)</strong>\n\n<code>[DEBUG getUnlinkedMessages] allMessages count: 42\n[DEBUG getUnlinkedMessages] unique types: [ 'email' ]\n[DEBUG getUnlinkedMessages] filtered messages count: 0\n</code>\n\nThe database only has <code>email</code> type messages, no <code>text</code> or <code>imessage</code>."
  },
  {
    "id": "BACKLOG-171",
    "title": "Contacts Not Pre-Populated When Editing Transaction",
    "category": "fix",
    "priority": "High",
    "status": "Obsolete",
    "sprint": "-",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "Superseded by BACKLOG-210",
    "created_at": "2026-01-05",
    "completed_at": "",
    "file": "[BACKLOG-171.md](items/BACKLOG-171.md)",
    "description": "<strong>Description</strong>\n\nWhen clicking \"Edit\" to edit a transaction from the transaction detail window, the contact assignments are not pre-populated in the edit form.\n\n**What works:**\n\u2022 Address field correctly pre-fills with existing transaction address\n\u2022 Transaction type correctly pre-fills with existing type\n\n**What does NOT work:**\n\u2022 On the following screen (contact assignment step), linked/saved contacts do NOT pre-populate\n\u2022 User has to re-select all contacts even though they are already assigned to the transaction\n\n<strong>Root Cause Hypothesis</strong>\n\nThis appears to be a data loading issue where <code>contact_assignments</code> are not being passed through when entering edit mode, or the edit form is not receiving/using the existing contact assignments when initializing.\n\n<strong>Investigation Areas</strong>\n\n1. **EditTransactionModal.tsx**: Check if <code>contact_assignments</code> are being passed to the modal\n2. **Transaction detail query**: Verify the transaction query includes contact assignments\n3. **Form initialization**: Check if the multi-step form properly initializes contact state from existing data\n4. **State persistence**: Verify contact selections persist between form steps\n\n<strong>Files to Investigate</strong>\n\n| File | Purpose |\n|------|---------|\n| <code>src/components/transaction/components/EditTransactionModal.tsx</code> | Main edit modal |\n| <code>src/components/transactionDetailsModule/TransactionDetailsPage.tsx</code> | Provides transaction data to edit |\n| <code>src/hooks/useTransactionDetails.ts</code> | Transaction data fetching |\n| <code>src/components/ContactSelectModal.tsx</code> | Contact selection UI |\n\n<strong>Related Issues</strong>\n\n\u2022 BACKLOG-103 (Fixed): Contact selection issue in transaction creation - different bug, already completed in SPRINT-010 (TASK-700)\n\u2022 BACKLOG-158 (Pending): Decompose AuditTransactionModal - refactoring item, not the same bug\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 When editing a transaction, existing contact assignments pre-populate in the form\n\u2610 All roles (client, agent, lender, title, etc.) show their previously assigned contacts\n\u2610 User can modify contact assignments (add/remove)\n\u2610 Saving preserves both unchanged and modified contact assignments\n\u2610 No regression in new transaction creation flow\n\n<strong>Estimated Effort</strong>\n\n\u2022 **Est. Tokens:** ~25K\n\u2022 **Category:** ui (1.0x multiplier)\n\u2022 **Notes:** Investigation-first task; may require debugging data flow between transaction details and edit modal\n\n---\n\n<strong>Notes</strong>\n\nThis is a different bug from BACKLOG-103 which addressed contact selection during transaction creation. This bug specifically affects the edit workflow where existing data should pre-populate but contacts do not."
  },
  {
    "id": "BACKLOG-172",
    "title": "macOS Messages Import",
    "category": "feature",
    "priority": "High",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-05",
    "completed_at": "2026-01-23",
    "file": "[BACKLOG-172.md](items/BACKLOG-172.md)",
    "description": "<strong>Description</strong>\n\nImplement the ability to import text messages from macOS Messages app (<code>~/Library/Messages/chat.db</code>) into the app's internal <code>messages</code> table, enabling message-to-transaction linking on macOS.\n\n<strong>Background</strong>\n\nCurrently, text message import only works via iPhone backup sync (Windows/Linux). On macOS:\n\u2022 The app can read <code>chat.db</code> for export/display (conversationHandlers.ts)\n\u2022 But there's no mechanism to import those messages into the app database\n\u2022 This prevents the \"Attach Messages\" feature from working on macOS\n\nSee BACKLOG-170 for full root cause analysis.\n\n<strong>Technical Approach</strong>\n\n<strong>1. Create macOS Messages Import Service</strong>\n\n<code>// electron/services/macOSMessagesImportService.ts\n\nclass MacOSMessagesImportService {\n  /**\n   * Import messages from macOS Messages database\n   * Requires Full Disk Access permission\n   */\n  async importMessages(userId: string, options?: {\n    sinceDays?: number;  // Only import messages from last N days\n    limit?: number;      // Max messages to import\n  }): Promise<ImportResult>\n}\n</code>\n\n<strong>2. Query macOS Messages Database</strong>\n\nRead from <code>~/Library/Messages/chat.db</code>:\n\u2022 <code>message</code> table: Contains actual message content\n\u2022 <code>chat</code> table: Conversation metadata\n\u2022 <code>handle</code> table: Contact identifiers (phone numbers, emails)\n\u2022 <code>chat_handle_join</code>: Links chats to handles\n\n<strong>3. Transform and Store</strong>\n\nMap macOS Messages schema to app's <code>messages</code> table:\n\u2022 <code>ROWID</code> \u2192 generate UUID for <code>id</code>\n\u2022 <code>text</code> / <code>attributedBody</code> \u2192 <code>body_text</code> (use messageParser.ts)\n\u2022 <code>handle.id</code> \u2192 <code>participants</code>\n\u2022 <code>is_from_me</code> \u2192 <code>direction</code>\n\u2022 <code>service</code> \u2192 <code>channel</code> (iMessage \u2192 \"imessage\", SMS \u2192 \"sms\")\n\n<strong>4. Deduplication</strong>\n\n\u2022 Generate stable ID from: <code>message_guid + user_id</code>\n\u2022 Check existing before insert to avoid duplicates\n\u2022 Track last import timestamp for incremental imports\n\n<strong>Implementation Steps</strong>\n\n1. **Create macOSMessagesImportService.ts**\n   - Permission check (Full Disk Access)\n   - Read from chat.db\n   - Parse attributedBody blobs (reuse messageParser.ts)\n   - Insert into messages table\n\n2. **Add IPC Handler**\n   - <code>messages:import-macos</code> - Trigger import\n   - <code>messages:import-macos-status</code> - Get import status\n\n3. **UI Integration**\n   - Add \"Import Messages\" button in Settings or Dashboard\n   - Show import progress\n   - macOS only (use platform detection)\n\n4. **Auto-Import Option**\n   - Optional: Run import on app startup\n   - Optional: Periodic background sync\n\n<strong>Files to Create/Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>electron/services/macOSMessagesImportService.ts</code> | **NEW** - Core import logic |\n| <code>electron/handlers/messageImportHandlers.ts</code> | **NEW** - IPC handlers |\n| <code>src/components/settings/MessagesSettings.tsx</code> | Import button UI |\n| <code>electron/preload/messagesBridge.ts</code> | Expose import API |\n\n<strong>Dependencies</strong>\n\n\u2022 Full Disk Access permission (already implemented in permissionService.ts)\n\u2022 messageParser.ts (already has attributedBody parsing)\n\u2022 messages table schema (TASK-975 completed)\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 macOS users can import messages from Messages app\n\u2610 Imported messages appear in \"Attach Messages\" modal\n\u2610 Duplicate messages are not re-imported\n\u2610 Import progress is shown to user\n\u2610 Works with Full Disk Access permission\n\n<strong>Estimate</strong>\n\n~25,000 tokens\n\n<strong>Notes</strong>\n\n\u2022 Consider incremental import (only new messages since last import)\n\u2022 May need to handle encrypted messages (FileVault)\n\u2022 Watch for permission changes (user can revoke FDA)\n\u2022 Consider rate limiting / batching for large message histories"
  },
  {
    "id": "BACKLOG-173",
    "title": "Contact-First AttachMessagesModal Interface",
    "category": "ui",
    "priority": "High",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "~40K",
    "actual_tokens": "-",
    "variance": "TASK-989, PR #353",
    "created_at": "2026-01-05",
    "completed_at": "2026-01-09",
    "file": "[BACKLOG-173.md](BACKLOG-173.md)",
    "description": "<strong>Description</strong>\n\nRedesign the AttachMessagesModal to use a contact-first interface instead of loading all messages at once. This addresses a critical performance issue where loading 500k+ messages caused the UI to freeze.\n\n<strong>Problem Statement</strong>\n\nThe original AttachMessagesModal attempted to load ALL messages from the database on open:\n\u2022 With 579,000+ messages, this caused a complete UI freeze\n\u2022 The modal would show \"No unlinked messages available\" or hang indefinitely\n\u2022 Users could not attach text messages to transactions\n\n<strong>Solution Implemented</strong>\n\n**Two-View Interface:**\n1. **Contact List View**: Shows contacts with message counts (fast query with LIMIT)\n2. **Thread Selection View**: Shows message threads for the selected contact only\n\n**New Database Methods:**\n\u2022 <code>getMessageContacts()</code>: Returns unique contacts who have messages, with message counts\n\u2022 <code>getMessagesByContact()</code>: Returns messages for a specific contact\n\u2022 <code>getUnlinkedEmails()</code>: Returns emails not linked to any transaction\n\n**Additional Enhancements:**\n\u2022 Contact name resolution from macOS Contacts database\n\u2022 Thread cards show participants and date ranges\n\u2022 Updated terminology from \"messages\" to \"chats\"\n\u2022 Search contacts by phone number or name\n\n<strong>Technical Changes</strong>\n\n<strong>Database Layer (electron/services/databaseService.ts)</strong>\n<code>// New methods added\ngetMessageContacts(): Promise<ContactWithMessageCount[]>\ngetMessagesByContact(contactId: string): Promise<Message[]>\ngetUnlinkedEmails(): Promise<Message[]>\n</code>\n\n<strong>Service Layer (electron/services/transactionService.ts)</strong>\n\u2022 Added contact-based message queries\n\u2022 Optimized queries with proper LIMIT clauses\n\n<strong>IPC Handlers (electron/transaction-handlers.ts)</strong>\n\u2022 <code>transactions:getMessageContacts</code> - Get contacts with message counts\n\u2022 <code>transactions:getMessagesByContact</code> - Get messages for specific contact\n\u2022 <code>transactions:getUnlinkedEmails</code> - Get unlinked emails\n\n<strong>Preload Bridge (electron/preload/transactionBridge.ts)</strong>\n\u2022 Exposed new IPC methods to renderer\n\n<strong>UI Component (src/components/transactionDetailsModule/components/modals/AttachMessagesModal.tsx)</strong>\n\u2022 Complete rewrite with two-view interface\n\u2022 Contact search functionality\n\u2022 Thread selection UI\n\u2022 436 lines added, 242 lines removed\n\n<strong>Files Modified</strong>\n\n| File | Changes |\n|------|---------|\n| <code>electron/preload/transactionBridge.ts</code> | +25 lines - New IPC bridges |\n| <code>electron/services/databaseService.ts</code> | +69 lines - New query methods |\n| <code>electron/services/transactionService.ts</code> | +82 lines - Contact-based queries |\n| <code>electron/transaction-handlers.ts</code> | +108 lines - New IPC handlers |\n| <code>src/components/.../AttachMessagesModal.tsx</code> | +436/-242 - Complete rewrite |\n| <code>src/components/.../__tests__/AttachMessagesModal.test.tsx</code> | +196/-230 - Updated tests |\n\n<strong>Performance Impact</strong>\n\n| Scenario | Before | After |\n|----------|--------|-------|\n| Open modal (579k messages) | UI freeze (~30s+) | Instant (<100ms) |\n| Initial data load | All messages | Contacts only (~50-100 items) |\n| Message list | Full scan | Filtered by contact |\n\n<strong>Acceptance Criteria</strong>\n\n\u2611 Modal opens instantly regardless of message count\n\u2611 Contact list shows message counts\n\u2611 Search contacts by phone/name works\n\u2611 Selecting contact shows their threads\n\u2611 Thread cards show participants and date range\n\u2611 Can select and attach threads to transaction\n\u2611 21 tests pass for new contact-first flow\n\u2611 TypeScript type check passes\n\u2611 ESLint passes (only pre-existing warnings)\n\n<strong>PR Details</strong>\n\n\u2022 **PR**: #353\n\u2022 **Branch**: <code>feature/contact-first-attach-messages</code>\n\u2022 **Status**: Open (ready for merge)\n\u2022 **Additions**: 916 lines\n\u2022 **Deletions**: 472 lines\n\n<strong>Related Items</strong>\n\n\u2022 **BACKLOG-105**: Text Messages Tab in Transaction Details (parent feature, completed)\n\u2022 **BACKLOG-170**: Messages Not Loading in Attach Modal (bug that triggered this work)\n\u2022 **BACKLOG-172**: macOS Messages Import (future enhancement)\n\u2022 **TASK-704**: Original attach/unlink messages task\n\n<strong>Metrics</strong>\n\n| Metric | Value |\n|--------|-------|\n| Estimated Tokens | ~40,000 |\n| Actual Tokens | (from hook data) |\n| Files Changed | 6 |\n| Lines Added | 916 |\n| Lines Removed | 472 |\n| Tests | 21 passing |\n\n---\n\n<strong>Notes</strong>\n\nThis was an emergency performance fix triggered by BACKLOG-170 investigation. The original \"messages not loading\" bug led to discovering that loading 579k+ messages was never going to work - a fundamental architecture change was needed.\n\nThe contact-first approach is more intuitive for users anyway: they typically know WHO they want to attach messages from, not a specific message date/time."
  },
  {
    "id": "BACKLOG-174",
    "title": "Redesign \"Start New Audit\" Flow",
    "category": "ui",
    "priority": "High",
    "status": "Obsolete",
    "sprint": "-",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-05",
    "completed_at": "",
    "file": "[BACKLOG-174.md](BACKLOG-174.md)",
    "description": "<strong>Description</strong>\n\nWhen user clicks \"Start New Audit\", redirect to a screen that emphasizes the automated transaction extraction workflow rather than manual transaction creation.\n\n<strong>Current Behavior</strong>\n\nClicking \"Start New Audit\" opens manual transaction creation form directly.\n\n<strong>Desired Behavior</strong>\n\n1. Show list of **pending/AI-detected transactions** awaiting review\n2. Provide button to view **active transactions**\n3. Offer manual creation as a secondary option (\"Transaction not here? Add manually\")\n\n<strong>Rationale</strong>\n\nThe automated transaction extraction is a key differentiator of Magic Audit. The current flow leads users to manual creation first, which undermines the product's core value proposition and trains users to bypass the automated workflow.\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 \"Start New Audit\" button opens pending transactions view\n\u2610 Pending transactions list is prominently displayed\n\u2610 \"View Active Transactions\" button is available\n\u2610 \"Add Manually\" button is available as secondary option\n\u2610 Clear visual hierarchy emphasizing automated detection\n\n<strong>Technical Notes</strong>\n\n\u2022 May need to modify Dashboard component or create new routing\n\u2022 Consider reusing existing PendingTransactionsSection component\n\u2022 Ensure proper state management for navigation flow\n\n<strong>Estimated Tokens</strong>\n\n~30,000\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-104: Dashboard UI to Emphasize Auto-Detection (Completed)\n\u2022 BACKLOG-008: Redesign New Transaction Flow (file missing, may be related)\n\n---\n\n<strong>Notes</strong>\n\nThis is a UX improvement to align user behavior with the product's core value proposition of automated transaction detection."
  },
  {
    "id": "BACKLOG-175",
    "title": "Missing Recent Messages in AttachMessagesModal",
    "category": "fix",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-175.md](items/BACKLOG-175.md)",
    "description": "<strong>Description</strong>\n\nRecent messages are not appearing in the AttachMessagesModal. User reported that messages from today (Jan 5) are not showing, while the modal shows last message was from Dec 29, 2024.\n\n<strong>Problem Statement</strong>\n\nWhen opening the AttachMessagesModal and selecting a contact, recent messages are missing. The date range shown is outdated (e.g., Dec 29 instead of today).\n\n<strong>Potential Causes</strong>\n\n1. **Sync Issue**: Recent messages not imported from macOS Messages database\n   - The sync process may not be running or completing\n   - There could be an issue with the message import timestamp tracking\n\n2. **Query Issue**: Messages exist in database but aren't being returned\n   - The <code>getMessagesByContact</code> query might have filtering issues\n   - Date sorting or limiting could be excluding recent messages\n   - The <code>transaction_id IS NULL</code> filter might be incorrect if messages were auto-linked\n\n<strong>Investigation Steps</strong>\n\n1. Check if recent messages exist in the <code>messages</code> table:\n   <code>   SELECT * FROM messages\n   WHERE user_id = ?\n   ORDER BY sent_at DESC\n   LIMIT 10;\n   </code>\n\n2. Check when the last sync occurred:\n   <code>   SELECT * FROM sync_status\n   WHERE user_id = ?\n   ORDER BY updated_at DESC;\n   </code>\n\n3. Verify the <code>getMessagesByContact</code> query returns expected results\n\n4. Check if messages are being incorrectly linked to transactions during import\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Recent messages appear in AttachMessagesModal\n\u2610 Date range shows accurate first/last message dates\n\u2610 All unlinked messages for a contact are displayed\n\n<strong>Estimated Tokens</strong>\n\n~15,000\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-173: Contact-First AttachMessagesModal Interface (PR #353)\n\u2022 BACKLOG-170: Messages Not Loading in Attach Modal\n\n---\n\n<strong>Notes</strong>\n\nThis was discovered during testing of PR #353 (contact-first AttachMessagesModal). The modal now loads and displays contacts correctly, but the message data appears incomplete."
  },
  {
    "id": "BACKLOG-176",
    "title": "Show New Messages Count Instead of Total During Import",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-176.md](items/BACKLOG-176.md)",
    "description": "<strong>Description</strong>\n\nDuring macOS Messages import, the progress indicator shows total messages processed (e.g., \"Importing messages... 676,647 / 676,647\") which is misleading since most are skipped. Should show new messages found instead.\n\n<strong>Current Behavior</strong>\n\n<code>Importing messages... 676,647 / 676,647\n</code>\n\nLog shows: <code>Import complete: 0 imported, 676647 skipped</code>\n\n<strong>Desired Behavior</strong>\n\nShow meaningful progress that reflects actual new data:\n\u2022 \"Scanning messages... X new found\" (during import)\n\u2022 \"Import complete: X new messages added\" (when done)\n\u2022 Or: \"Scanning messages... (X skipped, Y new)\"\n\n<strong>Rationale</strong>\n\n\u2022 Current UI makes it seem like we're importing 676k messages every time\n\u2022 Users may think the app is slow or redundant\n\u2022 The actual work (finding NEW messages) is hidden\n\u2022 We already track skipped vs imported counts\n\n<strong>Technical Notes</strong>\n\nThe import service already calculates:\n<code>// From log: \"0 imported, 676647 skipped\"\n</code>\n\nJust need to surface this to the UI during progress updates.\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Progress shows new messages count, not total processed\n\u2610 Final status shows \"X new messages added\" or \"All caught up\"\n\u2610 Skipped count optionally shown (e.g., hover/tooltip)\n\n<strong>Estimated Tokens</strong>\n\n~10,000\n\n<strong>Related Items</strong>\n\n\u2022 MacOSMessagesImportService\n\u2022 Dashboard sync status display\n\n---"
  },
  {
    "id": "BACKLOG-177",
    "title": "Clean Up Dashboard Import Status Display",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-177.md](items/BACKLOG-177.md)",
    "description": "<strong>Description</strong>\n\nThe Dashboard shows redundant loading/placeholder elements under the import status. Should consolidate to a single status element and show proper completion states.\n\n<strong>Current Issues</strong>\n\n1. Multiple loading placeholders appear when they shouldn't\n2. This skeleton loader persists after import completes:\n<code><div class=\"ai-status-card-loading\">\n  <div class=\"w-10 h-10 bg-gray-200 rounded-full animate-pulse\"></div>\n  <div class=\"h-4 w-32 bg-gray-200 rounded animate-pulse mb-2\"></div>\n  <div class=\"h-3 w-48 bg-gray-200 rounded animate-pulse\"></div>\n</div>\n</code>\n\n<strong>Desired Behavior</strong>\n\n1. **Single import status element** - not multiple placeholders\n2. **When import is done**, show one of:\n   - \"You're all caught up\" (no new transactions)\n   - \"X new transactions found\" (with action to review)\n3. **Remove unnecessary loading skeleton** after import completes\n4. These completion states are already built - just need proper display logic\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Only one import status element shown at a time\n\u2610 Loading skeleton removed when import completes\n\u2610 Proper completion message displayed (\"All caught up\" or \"X new found\")\n\u2610 Clean transition from loading -> complete state\n\n<strong>Technical Notes</strong>\n\n\u2022 Check <code>data-testid=\"ai-status-card-loading\"</code> usage\n\u2022 Ensure state properly transitions from loading to complete\n\u2022 May need to review Dashboard component conditional rendering\n\n<strong>Estimated Tokens</strong>\n\n~15,000\n\n<strong>Related Items</strong>\n\n\u2022 Dashboard component\n\u2022 AI Detection Status section\n\u2022 BACKLOG-104: Dashboard UI to Emphasize Auto-Detection (Completed)\n\n---"
  },
  {
    "id": "BACKLOG-178",
    "title": "Auto-Linked Messages Display in Transaction Details",
    "category": "feature",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-027",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "TASK-990, PR #358",
    "created_at": "2026-01-09",
    "completed_at": "2026-01-10",
    "file": "-",
    "description": "<strong>Summary</strong>\n\nAdd support for fetching and importing WhatsApp messages into the communications/messages system.\n\n<strong>Priority</strong>\n\nMedium\n\n<strong>Category</strong>\n\nFeature - Communications\n\n<strong>Description</strong>\n\nCurrently the app supports:\n\u2022 macOS Messages (iMessage/SMS)\n\u2022 Email (Microsoft Graph, Gmail)\n\nWhatsApp is a popular messaging platform used by many real estate professionals. Adding support would expand communication coverage.\n\n<strong>Requirements (High-level)</strong>\n\n\u2022 Investigate WhatsApp data access options:\n  - WhatsApp Business API\n  - WhatsApp Web export\n  - Local WhatsApp database access (if possible)\n\u2022 Implement message import service\n\u2022 Map WhatsApp messages to existing message schema\n\u2022 Support thread/conversation grouping\n\u2022 Handle WhatsApp-specific features (media, voice notes, etc.)\n\n<strong>Technical Considerations</strong>\n\n\u2022 WhatsApp API access may require business account\n\u2022 End-to-end encryption limits direct data access\n\u2022 May need to rely on export/backup approach\n\u2022 Consider privacy and compliance requirements\n\n<strong>Estimated Effort</strong>\n\nLarge (needs research phase first)\n\n<strong>Dependencies</strong>\n\n\u2022 Existing messaging infrastructure (SPRINT-025, SPRINT-027)\n\u2022 Message viewer components\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Research completed on WhatsApp data access options\n\u2610 Chosen approach documented\n\u2610 WhatsApp messages can be imported\n\u2610 Messages display in Transaction Details\n\u2610 Contact matching works for WhatsApp contacts\n\n<strong>Created</strong>\n\n2026-01-09\n\n<strong>Status</strong>\n\nBacklog"
  },
  {
    "id": "BACKLOG-179",
    "title": "Manual Thread Attach/Unlink in Messages Tab",
    "category": "feature",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-027",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "TASK-991, PR #359",
    "created_at": "2026-01-09",
    "completed_at": "2026-01-10",
    "file": "-",
    "description": "<strong>Summary</strong>\n\nDisplay contact names instead of raw phone numbers throughout the messaging UI when a matching contact exists in the database.\n\n<strong>Priority</strong>\n\nHigh\n\n<strong>Category</strong>\n\nUI/UX - Messages\n\n<strong>Problem</strong>\n\nCurrently, message threads and the \"Also Include\" section show phone numbers (e.g., \"+15551234567\") instead of resolved contact names. This makes it harder for users to identify who they're communicating with at a glance.\n\n<strong>Affected Areas</strong>\n\n1. **MessageThreadCard header** - Shows phone number as fallback, should look up contact name\n2. **AttachMessagesModal contact list** - May show numbers instead of names\n3. **Thread grouping display** - Group chats should show participant names\n\n<strong>Requirements</strong>\n\n\u2610 Look up contact names by phone number when displaying threads\n\u2610 Use contact name as primary display, phone as subtitle\n\u2610 Handle cases where contact doesn't exist (show phone number)\n\u2610 Cache contact lookups to avoid repeated queries\n\n<strong>Technical Approach</strong>\n\n1. Add a <code>getContactByPhone(phone: string)</code> lookup method\n2. In <code>TransactionMessagesTab</code>, resolve contact names for each thread\n3. Pass resolved names to <code>MessageThreadCard</code>\n4. Handle multiple contacts for group chats\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Thread headers show contact names when available\n\u2610 Phone numbers show as subtitle under contact name\n\u2610 Unknown contacts still show phone number\n\u2610 No performance regression from lookups\n\n<strong>Created</strong>\n\n2026-01-09\n\n<strong>Status</strong>\n\nBacklog"
  },
  {
    "id": "BACKLOG-180",
    "title": "Message Bubble Direction Fix",
    "category": "ui",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-027",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "TASK-992, PR #356",
    "created_at": "2026-01-09",
    "completed_at": "2026-01-10",
    "file": "-",
    "description": "<strong>Summary</strong>\n\nDisplay the sender's name (or phone number) on each message bubble in group chats so users can see who sent which message.\n\n**Additional Requirement (2026-01-10):** For the thread header/title:\n\u2022 If the group chat has a name, use the group chat name\n\u2022 Otherwise, show all participants of the group chat (e.g., \"John, Jane, Bob\")\n\n<strong>Priority</strong>\n\nHigh\n\n<strong>Category</strong>\n\nUI/UX - Messages\n\n<strong>Problem</strong>\n\nIn group chats with multiple participants, all incoming messages appear the same - gray bubbles on the left with no indication of who sent each message. Users cannot tell which participant sent which text.\n\n<strong>Current Behavior</strong>\n\n<code>[Gray bubble] Hey, are we meeting tomorrow?     <- Who sent this?\n[Gray bubble] Yes, 2pm works for me             <- Who sent this?\n[Blue bubble] Great, see you then               <- User's message\n</code>\n\n<strong>Desired Behavior</strong>\n\n<code>John Smith\n[Gray bubble] Hey, are we meeting tomorrow?\n\nJane Doe\n[Gray bubble] Yes, 2pm works for me\n\n[Blue bubble] Great, see you then               <- User's message (no name needed)\n</code>\n\n<strong>Requirements</strong>\n\n\u2610 Show sender name above each inbound message bubble\n\u2610 Don't show name for consecutive messages from same sender\n\u2610 Use contact name if available, fall back to phone number\n\u2610 Outbound messages (from user) don't need sender label\n\u2610 Different colors/avatars for different senders (nice to have)\n\u2610 Thread header: Use group chat name if available\n\u2610 Thread header: If no group name, show comma-separated list of all participants\n\n<strong>Technical Approach</strong>\n\n1. Parse <code>participants.from</code> field from message data\n2. Look up contact name by phone/email\n3. Update <code>MessageBubble</code> component to accept and display sender\n4. Group consecutive messages from same sender to reduce visual clutter\n\n<strong>Data Available</strong>\n\nMessages have a <code>participants</code> JSON field:\n<code>{\n  \"from\": \"+15551234567\",\n  \"to\": [\"+15559876543\", \"+15551111111\"]\n}\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Inbound messages show sender name/number above bubble\n\u2610 Consecutive messages from same sender don't repeat name\n\u2610 Contact names used when available\n\u2610 Phone numbers shown when contact not found\n\u2610 Works for both 1:1 and group threads\n\n<strong>Created</strong>\n\n2026-01-09\n\n<strong>Status</strong>\n\nBacklog"
  },
  {
    "id": "BACKLOG-181",
    "title": "Streamline Terms and Conditions Onboarding Step",
    "category": "ui",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-028",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "TASK-1009, PR #368",
    "created_at": "2026-01-10",
    "completed_at": "2026-01-10",
    "file": "[BACKLOG-181.md](BACKLOG-181.md)",
    "description": "<strong>Recent Updates</strong>\n\n**2026-01-10:** Added step indicator (\"1 - Terms & Conditions\") to match other onboarding steps. The WelcomeTerms component now shows a step number badge consistent with OnboardingShell styling.\n\nRemaining items were already completed in prior work:\n\u2022 Single checkbox \u2713\n\u2022 Consistent card styling \u2713\n\u2022 Removed decline button \u2713\n\n---\n\n<strong>Problem Statement</strong>\n\nThe Terms and Conditions acceptance step during onboarding feels disconnected from the rest of the onboarding flow. It has a different visual style and requires two separate checkbox confirmations before proceeding.\n\nCurrent experience:\n\u2022 \"Welcome to Magic Audit!\" header with personalized greeting\n\u2022 Two separate checkboxes (Terms of Service, Privacy Policy)\n\u2022 \"Decline\" and \"Accept & Continue\" buttons\n\u2022 Different styling compared to other onboarding steps\n\n<strong>Proposed Solution</strong>\n\nStreamline the terms acceptance to match the visual style and flow of other onboarding steps:\n\n1. **Consistent styling** with other onboarding cards/steps\n2. **Single checkbox** or toggle for accepting both Terms and Privacy Policy\n3. **Inline links** to view full Terms/Privacy in a modal or new tab\n4. **Seamless transition** to next onboarding step\n5. **Remove \"Decline\" button** - user can close app if they don't accept\n\n<strong>Acceptance Criteria</strong>\n\n\u2611 Terms step matches visual style of other onboarding steps\n\u2611 Single acceptance action (not two separate checkboxes)\n\u2611 Terms and Privacy Policy remain accessible via links\n\u2611 Smooth transition to next step after acceptance\n\u2611 User greeting/personalization preserved\n\u2611 Step indicator shown (added 2026-01-10)\n\n<strong>Technical Notes</strong>\n\n\u2022 Check <code>src/components/onboarding/</code> for current implementation\n\u2022 May involve <code>TermsStep.tsx</code> or similar component\n\u2022 Should integrate with existing onboarding state machine\n\n<strong>References</strong>\n\n\u2022 Related to overall onboarding polish"
  },
  {
    "id": "BACKLOG-182",
    "title": "getCurrentUser() Returns False After Login",
    "category": "service",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-027",
    "est_tokens": "~8K",
    "actual_tokens": "-",
    "variance": "direct commit",
    "created_at": "2026-01-10",
    "completed_at": "2026-01-10",
    "file": "[BACKLOG-182.md](BACKLOG-182.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-183",
    "title": "Mixed UI During Import - Instructions With Progress",
    "category": "ui",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-027",
    "est_tokens": "~5K",
    "actual_tokens": "-",
    "variance": "direct commit",
    "created_at": "2026-01-10",
    "completed_at": "2026-01-10",
    "file": "[BACKLOG-183.md](BACKLOG-183.md)",
    "description": "<strong>Status: Completed (SPRINT-027)</strong>\n\n<strong>Summary</strong>\n\nDuring message/contact import, the PermissionsStep was showing both the permission instructions AND the import progress bars simultaneously, creating a confusing mixed UI state.\n\n<strong>Root Cause</strong>\n\nThe PermissionsStep component was rendering both views at the same time because there was no early return when the import view should be shown. The import progress section was being rendered alongside the instruction steps instead of replacing them.\n\n<strong>Solution</strong>\n\nCreated a dedicated import view that shows ONLY when importing or when import has results. Added an early return pattern so that when the import state is active, the component immediately returns the import-only view without rendering any of the instruction steps.\n\n<strong>Files Changed</strong>\n\n\u2022 <code>src/components/onboarding/steps/PermissionsStep.tsx</code> - Added early return for dedicated import view\n\n<strong>Impact</strong>\n\n\u2022 **Severity**: Medium - Confusing UX but not blocking\n\u2022 **User Impact**: Users saw overlapping instructions while import was running\n\u2022 **Discovery**: User testing during SPRINT-027\n\n<strong>Category</strong>\n\n<code>fix</code>\n\n<strong>Priority</strong>\n\nMedium\n\n<strong>Sprint</strong>\n\nSPRINT-027 (Messages & Contacts Polish)\n\n<strong>PR/Commit</strong>\n\nDirect commit to <code>fix/messages-display-issues</code> branch\n\n<strong>Estimated Tokens</strong>\n\n~5K\n\n<strong>Related Items</strong>\n\n\u2022 Part of permissions step improvements in SPRINT-027\n\u2022 Related to BACKLOG-184 (import stuck at 100%)"
  },
  {
    "id": "BACKLOG-184",
    "title": "Contacts Import Failing (1000 Limit)",
    "category": "service",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-027",
    "est_tokens": "~2K",
    "actual_tokens": "-",
    "variance": "direct commit",
    "created_at": "2026-01-10",
    "completed_at": "2026-01-10",
    "file": "[BACKLOG-184.md](BACKLOG-184.md)",
    "description": "<strong>Status: Completed (SPRINT-027)</strong>\n\n<strong>Summary</strong>\n\nContact import was failing with a validation error when users had more than 1000 contacts. The error was not user-friendly and prevented onboarding completion.\n\n<strong>Root Cause</strong>\n\nThe contact import handler had a hardcoded limit of 1000 contacts for validation. When a user had 1006 contacts (or any number over 1000), the import would fail with a validation error.\n\n<strong>Solution</strong>\n\nIncreased the contact import limit from 1000 to 5000 to accommodate users with larger contact lists while still maintaining a reasonable upper bound for performance.\n\n<strong>Files Changed</strong>\n\n\u2022 <code>electron/contact-handlers.ts</code> - Changed contact import limit from 1000 to 5000\n\n<strong>Impact</strong>\n\n\u2022 **Severity**: High - Blocked onboarding for users with >1000 contacts\n\u2022 **User Impact**: Users with many contacts could not complete onboarding\n\u2022 **Discovery**: User testing during SPRINT-027 (user had 1006 contacts)\n\n<strong>Category</strong>\n\n<code>fix</code>\n\n<strong>Priority</strong>\n\nHigh\n\n<strong>Sprint</strong>\n\nSPRINT-027 (Messages & Contacts Polish)\n\n<strong>PR/Commit</strong>\n\nDirect commit to <code>fix/messages-display-issues</code> branch\n\n<strong>Estimated Tokens</strong>\n\n~2K\n\n<strong>Related Items</strong>\n\n\u2022 Part of permissions step improvements in SPRINT-027"
  },
  {
    "id": "BACKLOG-185",
    "title": "Import Stuck at 100% on Progress Bar",
    "category": "ui",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-027",
    "est_tokens": "~3K",
    "actual_tokens": "-",
    "variance": "direct commit",
    "created_at": "2026-01-10",
    "completed_at": "2026-01-10",
    "file": "[BACKLOG-185.md](BACKLOG-185.md)",
    "description": "<strong>Status: Completed (SPRINT-027)</strong>\n\n<strong>Summary</strong>\n\nAfter both messages and contacts finished importing, the progress bar would stay stuck at 100% indefinitely, preventing users from continuing to the next step.\n\n<strong>Root Cause</strong>\n\nThe code was using <code>Promise.all</code> to wait for both messages AND contacts to complete before proceeding to the next step. Since contact import can take significantly longer (especially with 5000+ contacts), users were stuck waiting even after messages were done.\n\n<strong>Solution</strong>\n\nChanged the import logic to only wait for messages import to complete before allowing the user to proceed. Contacts continue importing in the background. The UI shows separate progress for each import type, and users can continue once messages are done.\n\n<strong>Files Changed</strong>\n\n\u2022 <code>src/components/onboarding/steps/PermissionsStep.tsx</code> - Changed <code>Promise.all</code> to only wait for messages import\n\n<strong>Impact</strong>\n\n\u2022 **Severity**: Medium - UX issue causing user confusion\n\u2022 **User Impact**: Users thought the app was frozen\n\u2022 **Discovery**: User testing during SPRINT-027\n\n<strong>Category</strong>\n\n<code>fix</code>\n\n<strong>Priority</strong>\n\nMedium\n\n<strong>Sprint</strong>\n\nSPRINT-027 (Messages & Contacts Polish)\n\n<strong>PR/Commit</strong>\n\nDirect commit to <code>fix/messages-display-issues</code> branch\n\n<strong>Estimated Tokens</strong>\n\n~3K\n\n<strong>Related Items</strong>\n\n\u2022 Part of permissions step improvements in SPRINT-027\n\u2022 Related to BACKLOG-183 (mixed UI during import)\n\u2022 Related to dual progress bars improvement (unplanned work in sprint)"
  },
  {
    "id": "BACKLOG-186",
    "title": "Continue Button Not Working After Import",
    "category": "ui",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-027",
    "est_tokens": "~5K",
    "actual_tokens": "-",
    "variance": "direct commit",
    "created_at": "2026-01-10",
    "completed_at": "2026-01-10",
    "file": "[BACKLOG-186.md](BACKLOG-186.md)",
    "description": "<strong>Status: Completed (SPRINT-027)</strong>\n\n<strong>Summary</strong>\n\nAfter message import completed successfully, clicking the \"Continue\" button did nothing. Users were stuck on the permissions step with no way to proceed to the dashboard.\n\n<strong>Root Cause</strong>\n\nThe <code>goToStep(\"dashboard\")</code> function is a no-op when the state machine is enabled. The permissions step was using the legacy navigation pattern which bypasses the state machine. Navigation must happen via the state machine dispatch function.\n\n<strong>Solution</strong>\n\nAdded <code>stateMachineDispatch</code> prop to <code>usePermissionsFlow</code> hook and dispatch the <code>ONBOARDING_STEP_COMPLETE</code> action with <code>step: \"permissions\"</code> to properly notify the state machine that the permissions step is complete. This triggers the correct state transition to the dashboard.\n\n<strong>Files Changed</strong>\n\n\u2022 <code>src/appCore/state/flows/usePermissionsFlow.ts</code> - Added <code>stateMachineDispatch</code> prop and dispatch logic\n\u2022 <code>src/appCore/state/useAppStateMachine.ts</code> - Connected dispatch to permissions flow\n\n<strong>Impact</strong>\n\n\u2022 **Severity**: Critical - Blocked onboarding completion entirely\n\u2022 **User Impact**: Users could not proceed past permissions step to dashboard\n\u2022 **Discovery**: User testing during SPRINT-027\n\n<strong>Category</strong>\n\n<code>fix</code>\n\n<strong>Priority</strong>\n\nCritical\n\n<strong>Sprint</strong>\n\nSPRINT-027 (Messages & Contacts Polish)\n\n<strong>PR/Commit</strong>\n\nDirect commit to <code>fix/messages-display-issues</code> branch\n\n<strong>Estimated Tokens</strong>\n\n~5K\n\n<strong>Related Items</strong>\n\n\u2022 Part of permissions step improvements in SPRINT-027\n\u2022 Related to BACKLOG-142 (State Coordination Overhaul) - this is a side effect of the state machine migration"
  },
  {
    "id": "BACKLOG-187",
    "title": "Display Attachments (Images/GIFs) in Text Messages",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~50K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-10",
    "completed_at": "",
    "file": "[BACKLOG-187.md](BACKLOG-187.md)",
    "description": "<strong>Description</strong>\n\nDisplay image and GIF attachments inline within text message conversations. Currently, messages with attachments only show \"[Attachment - Photo/Video/File]\" placeholder text.\n\n<strong>Current Behavior</strong>\n\n\u2022 Messages with attachments show placeholder text: \"[Attachment - Photo/Video/File]\"\n\u2022 <code>has_attachments</code> flag is stored but actual files are not imported\n\u2022 No visual preview of images/GIFs\n\n<strong>Desired Behavior</strong>\n\n1. Import attachment files from macOS Messages storage\n2. Store attachments in app's data directory\n3. Display images/GIFs inline in message bubbles\n4. Support common formats: JPG, PNG, GIF, HEIC\n5. Show thumbnail with option to view full size\n\n<strong>Technical Notes</strong>\n\n<strong>macOS Messages Attachment Storage</strong>\n\nAttachments are stored in <code>~/Library/Messages/Attachments/</code> with references in the <code>attachment</code> table.\n\n<strong>Implementation Steps</strong>\n\n1. Query <code>attachment</code> table during import\n2. Copy files to app storage (with deduplication)\n3. Store attachment metadata in messages table or new attachments table\n4. Update ConversationViewModal to render inline images\n5. Handle missing/deleted attachments gracefully\n\n<strong>Storage Considerations</strong>\n\n\u2022 Attachments can be large (photos, videos)\n\u2022 Consider thumbnail generation for preview\n\u2022 May need cleanup/pruning strategy\n\u2022 Respect user's storage preferences\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Import attachments from macOS Messages database\n\u2610 Store attachments in app's data directory\n\u2610 Display images inline in message bubbles\n\u2610 Display GIFs with animation\n\u2610 Show placeholder for unsupported formats\n\u2610 Handle missing attachments gracefully\n\u2610 Works for both 1:1 and group conversations\n\n<strong>Estimated Tokens</strong>\n\n~50,000 (significant feature addition)\n\n<strong>Related Items</strong>\n\n\u2022 TASK-1008: Show in Folder button (completed)\n\u2022 Message import service updates needed\n\n---\n\n<strong>Notes</strong>\n\nThis is an audit-critical feature - real estate agents often share property photos, contracts, and documents via text message. These attachments are important evidence in transaction audits."
  },
  {
    "id": "BACKLOG-188",
    "title": "Scan Lookback Period Setting Not Persisting",
    "category": "service",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-10",
    "completed_at": "",
    "file": "[BACKLOG-188.md](BACKLOG-188.md)",
    "description": "<strong>Description</strong>\n\nThe \"Scan Lookback Period\" setting in Settings doesn't persist when changed. User reported changing from 9 months to 3 months and the value didn't save.\n\n<strong>Current Behavior</strong>\n\n\u2022 User changes lookback period from 9 months to 3 months\n\u2022 Setting appears to change in UI\n\u2022 After some action (unclear if immediate or after restart), value resets to 9 months\n\n<strong>Expected Behavior</strong>\n\n\u2022 Lookback period should persist after changing\n\u2022 Value should survive app restart\n\u2022 Value should be stored in Supabase user_preferences\n\n<strong>Technical Notes</strong>\n\n<strong>Code Flow</strong>\n\n1. <code>Settings.tsx</code> calls <code>handleScanLookbackChange(months)</code>\n2. Handler calls <code>window.api.preferences.update(userId, { scan: { lookbackMonths: months } })</code>\n3. <code>preference-handlers.ts</code> deep-merges with existing preferences\n4. <code>supabaseService.syncPreferences()</code> upserts to Supabase\n\n<strong>Possible Causes</strong>\n\n1. **Silent failure** - Update might be failing but error is caught silently (<code>console.debug</code>)\n2. **Load issue** - Preferences might not be loading correctly on mount\n3. **Deep merge issue** - The <code>scan</code> object might not be merging correctly\n4. **Supabase sync** - Data might not be reaching Supabase\n\n<strong>Investigation Steps</strong>\n\n1. Check DevTools Console for errors when changing setting\n2. Check if value persists on same page (without navigation)\n3. Check if value persists after page navigation\n4. Check if value persists after app restart\n5. Check Supabase database directly for stored value\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Lookback period persists after changing\n\u2610 Value survives app restart\n\u2610 Value can be verified in Supabase\n\n<strong>Estimated Tokens</strong>\n\n~10,000 (bug investigation + fix)\n\n---\n\n<strong>Notes</strong>\n\nReported during SPRINT-029 session. Settings use Supabase for persistence."
  },
  {
    "id": "BACKLOG-189",
    "title": "Configurable Attachment Size Limit",
    "category": "feature",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-10",
    "completed_at": "",
    "file": "[BACKLOG-189.md](BACKLOG-189.md)",
    "description": "<strong>Description</strong>\n\nMake the maximum attachment size limit configurable in Settings instead of hardcoded at 50MB.\n\n<strong>Current Behavior</strong>\n\n\u2022 <code>MAX_ATTACHMENT_SIZE</code> is hardcoded to 50MB in <code>macOSMessagesImportService.ts:61</code>\n\u2022 Attachments over 50MB are skipped with a warning\n\u2022 User has no control over this limit\n\n<strong>Expected Behavior</strong>\n\n\u2022 Settings should include \"Max Attachment Size\" option\n\u2022 Options: 50MB, 100MB, 200MB, 500MB, Unlimited\n\u2022 Preference stored in Supabase user_preferences\n\u2022 Import service reads from preferences\n\n<strong>Technical Notes</strong>\n\n<strong>Files to Modify</strong>\n\n1. **Settings.tsx** - Add attachment size dropdown\n2. **preference-handlers.ts** - Handle <code>attachments.maxSizeMB</code> preference\n3. **macOSMessagesImportService.ts** - Read limit from preferences instead of constant\n\n<strong>Default Value</strong>\n\nKeep 50MB as default for new users.\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Settings shows max attachment size dropdown\n\u2610 Changing setting persists to Supabase\n\u2610 Import respects the configured limit\n\u2610 \"Unlimited\" option works (no size check)\n\n<strong>Estimated Tokens</strong>\n\n~8,000\n\n---\n\n<strong>Notes</strong>\n\nReported during SPRINT-029 session. User had 51MB attachments being skipped."
  },
  {
    "id": "BACKLOG-190",
    "title": "Transaction Date Range for Message Linking",
    "category": "service",
    "priority": "Critical",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-10",
    "completed_at": "",
    "file": "[BACKLOG-190.md](BACKLOG-190.md)",
    "description": "<strong>Description</strong>\n\nWhen adding contacts with many messages to a transaction, the app freezes because it tries to link ALL messages from that contact. Messages should be filtered to the transaction date range.\n\nAdditionally, Step 1 of the Audit Transaction Modal should be expanded to include transaction start/end dates.\n\n<strong>Current Behavior</strong>\n\n\u2022 Adding a contact triggers linking ALL their messages (can be thousands)\n\u2022 App freezes with contacts that have extensive message history\n\u2022 No way to specify transaction date range\n\u2022 Step 1 only has address and transaction type\n\n<strong>Expected Behavior</strong>\n\n1. **UI Changes (Step 1)**:\n   - Rename \"Step 1: Verify Property Address\" \u2192 \"Step 1: Transaction Details\"\n   - Add \"Transaction Start Date\" (required) - date picker\n   - Add \"Transaction End Date\" (optional) - date picker, defaults to null/ongoing\n\n2. **Backend Changes**:\n   - When linking messages to transaction, filter by date range\n   - Only link messages where <code>sent_at >= start_date</code>\n   - If end_date provided, also filter <code>sent_at <= end_date</code>\n   - Significantly reduces number of messages to process\n\n3. **Performance**:\n   - Should prevent freeze even for contacts with years of history\n   - Most transactions are < 1 year, so this naturally limits scope\n\n<strong>Technical Notes</strong>\n\n<strong>Files to Modify</strong>\n\n1. **AddressVerificationStep.tsx** - Add date pickers, rename component?\n2. **useAuditTransaction.ts** - Add start_date/end_date to addressData\n3. **AuditTransactionModal.tsx** - Update step title\n4. **messageMatchingService.ts** - Add date filtering to <code>autoLinkTextsToTransaction</code>\n5. **schema.sql** - Verify transactions table has start_date/end_date columns\n\n<strong>UI Design</strong>\n\n<code>Step 1: Transaction Details\n\nProperty Address *\n[________________________]\n\nTransaction Type *\n[Purchase] [Sale]\n\nTransaction Start Date *\n[__/__/____]  (date picker)\n\nTransaction End Date (optional)\n[__/__/____]  (date picker, or \"Ongoing\" checkbox)\n</code>\n\n<strong>SQL Filter</strong>\n\n<code>WHERE sent_at >= ?\n  AND (? IS NULL OR sent_at <= ?)\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Step 1 renamed to \"Transaction Details\"\n\u2610 Start date picker added (required)\n\u2610 End date picker added (optional)\n\u2610 Dates stored in transaction record\n\u2610 Message linking filters by transaction date range\n\u2610 No freeze when adding contacts with extensive history\n\u2610 Existing transactions without dates continue to work\n\n<strong>Estimated Tokens</strong>\n\n~15,000 (UI + backend changes)\n\n---\n\n<strong>Notes</strong>\n\nReported during SPRINT-029 session. Root cause is unbounded message linking.\nReal estate transactions typically span weeks to months, not years."
  },
  {
    "id": "BACKLOG-191",
    "title": "Add Test Coverage for Core Service Layer",
    "category": "test",
    "priority": "Critical",
    "status": "Obsolete",
    "sprint": "-",
    "est_tokens": "~115K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-11",
    "completed_at": "",
    "file": "[BACKLOG-191.md](BACKLOG-191.md)",
    "description": "<strong>Summary</strong>\n\nAdd test coverage for the core service layer files that currently have 0% coverage: <code>authService.ts</code>, <code>transactionService.ts</code>, <code>systemService.ts</code>, and <code>deviceService.ts</code> (781 lines total).\n\n<strong>Problem</strong>\n\nThe service layer contains critical business logic with no test coverage:\n\u2022 <code>src/services/authService.ts</code> - Authentication logic\n\u2022 <code>src/services/transactionService.ts</code> - Transaction management\n\u2022 <code>src/services/systemService.ts</code> - System operations\n\u2022 <code>src/services/deviceService.ts</code> - Device management\n\nThese services abstract <code>window.api</code> calls and contain business logic that should be tested to prevent regressions.\n\n<strong>Current State</strong>\n\n| File | Lines | Coverage |\n|------|-------|----------|\n| <code>authService.ts</code> | ~150 | 0% |\n| <code>transactionService.ts</code> | ~250 | 0% |\n| <code>systemService.ts</code> | ~180 | 0% |\n| <code>deviceService.ts</code> | ~200 | 0% |\n| **Total** | ~781 | 0% |\n\n<strong>Proposed Solution</strong>\n\nCreate unit tests for each service file with proper mocking of <code>window.api</code>:\n\n1. **authService.test.ts** - Test login, logout, session restore, token refresh\n2. **transactionService.test.ts** - Test CRUD operations, status changes, validation\n3. **systemService.test.ts** - Test platform detection, file operations, export\n4. **deviceService.test.ts** - Test device registration, sync status, backup\n\n<strong>Testing Approach</strong>\n\n<code>// Mock window.api for service tests\njest.mock('../../preload', () => ({\n  api: {\n    auth: {\n      login: jest.fn(),\n      logout: jest.fn(),\n      // ...\n    }\n  }\n}));\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 All 4 service files have test coverage >60%\n\u2610 Tests cover happy path and error cases\n\u2610 Tests use proper mocking (no real IPC calls)\n\u2610 All existing tests continue to pass\n\u2610 No flaky tests introduced\n\n<strong>Priority</strong>\n\n**CRITICAL** - Core business logic without coverage is high-risk\n\n<strong>Estimate</strong>\n\n| Phase | Est. Tokens |\n|-------|-------------|\n| authService tests | ~25K |\n| transactionService tests | ~35K |\n| systemService tests | ~25K |\n| deviceService tests | ~30K |\n| **Total** | ~115K |\n\n<strong>Category</strong>\n\ntest\n\n<strong>Impact</strong>\n\n\u2022 Prevents regression bugs in core business logic\n\u2022 Enables safer refactoring of service layer\n\u2022 Improves overall codebase confidence\n\n<strong>Dependencies</strong>\n\nNone - can be done independently\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-112: Boost Test Coverage for src/hooks/\n\u2022 BACKLOG-113: Boost Test Coverage for src/utils/"
  },
  {
    "id": "BACKLOG-192",
    "title": "Clean Up Console Statements (186 Remaining)",
    "category": "refactor",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-11",
    "completed_at": "",
    "file": "[BACKLOG-192.md](BACKLOG-192.md)",
    "description": "<strong>Summary</strong>\n\nRemove or replace 186 console statements throughout the codebase with structured logging or remove them entirely.\n\n<strong>Problem</strong>\n\nConsole statements in production code:\n\u2022 Clutter production logs\n\u2022 May expose sensitive information\n\u2022 Make debugging harder (noise vs signal)\n\u2022 Indicate incomplete development work\n\n<strong>Current State</strong>\n\n| File | Count | Priority |\n|------|-------|----------|\n| <code>src/components/onboarding/steps/PermissionsStep.tsx</code> | 21 | High |\n| <code>src/hooks/useAutoRefresh.ts</code> | 13 | High |\n| <code>src/components/Settings.tsx</code> | 12 | High |\n| Other files | 140 | Medium |\n| **Total** | 186 | - |\n\n<strong>Proposed Solution</strong>\n\n<strong>Phase 1: High-Priority Files (3 files, 46 statements)</strong>\nFocus on the files with the most console statements first.\n\n<strong>Phase 2: Remaining Files</strong>\nProcess remaining 140 statements across the codebase.\n\n<strong>Approach for Each Statement</strong>\n\n1. **Debug logging** (e.g., <code>console.log('data:', data)</code>) - Remove\n2. **Error logging** (e.g., <code>console.error(err)</code>) - Keep or convert to proper error handling\n3. **Development markers** (e.g., <code>console.log('TODO')</code>) - Address the TODO or remove\n4. **Conditional logging** - Consider keeping with production guard\n\n<strong>Example Conversions</strong>\n\n<code>// BEFORE\nconsole.log('User logged in:', user);\n\n// AFTER (remove if not needed in prod)\n// OR use structured logging if app has logging service:\nlogger.info('User logged in', { userId: user.id });\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Console statements reduced from 186 to <20\n\u2610 Remaining statements are intentional error logging\n\u2610 No functionality broken by removals\n\u2610 All tests pass\n\n<strong>Priority</strong>\n\n**MEDIUM** - Affects production debugging and code quality\n\n<strong>Estimate</strong>\n\n~30K tokens\n\n<strong>Category</strong>\n\nrefactor\n\n<strong>Impact</strong>\n\n\u2022 Cleaner production logs\n\u2022 Better debugging experience\n\u2022 Reduced risk of information exposure\n\n<strong>Notes</strong>\n\nBACKLOG-065 (Remove Console Statements) was marked complete in SPRINT-009, but this is a fresh audit showing 186 still remain. This may be due to new code added since then, or the original cleanup was partial."
  },
  {
    "id": "BACKLOG-193",
    "title": "Refactor databaseService.ts (1,223 Lines)",
    "category": "refactor",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~80K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-11",
    "completed_at": "",
    "file": "[BACKLOG-193.md](BACKLOG-193.md)",
    "description": "<strong>Summary</strong>\n\nSplit <code>electron/services/databaseService.ts</code> (1,223 lines) into focused modules: QueryService, MigrationService, and ConnectionService.\n\n<strong>Problem</strong>\n\n<code>databaseService.ts</code> is the largest service file in the codebase and handles too many concerns:\n\u2022 Database connection management\n\u2022 Migration execution\n\u2022 Query building and execution\n\u2022 Transaction management\n\u2022 Schema validation\n\nThis violates single responsibility principle and makes the code:\n\u2022 Hard to navigate and understand\n\u2022 Difficult to test in isolation\n\u2022 Risky to modify (changes may have unintended side effects)\n\n<strong>Current State</strong>\n\n<code>electron/services/databaseService.ts - 1,223 lines\n\u251c\u2500\u2500 Connection setup and encryption (~200 lines)\n\u251c\u2500\u2500 Migration system (~300 lines)\n\u251c\u2500\u2500 Query methods (~500 lines)\n\u251c\u2500\u2500 Transaction helpers (~150 lines)\n\u2514\u2500\u2500 Schema utilities (~75 lines)\n</code>\n\n<strong>Proposed Decomposition</strong>\n\n| New File | Responsibility | Est. Lines |\n|----------|---------------|------------|\n| <code>databaseConnectionService.ts</code> | Connection, encryption, initialization | ~200 |\n| <code>databaseMigrationService.ts</code> | Schema migrations, version tracking | ~300 |\n| <code>databaseQueryService.ts</code> | Generic query execution, transaction helpers | ~200 |\n| <code>databaseService.ts</code> | Orchestrator, public API | ~250 |\n| Domain query files (existing) | Entity-specific queries | As-is |\n\n<strong>Architecture After Refactor</strong>\n\n<code>databaseService.ts (orchestrator)\n\u251c\u2500\u2500 databaseConnectionService.ts (connection pool, encryption)\n\u251c\u2500\u2500 databaseMigrationService.ts (migrations, schema)\n\u251c\u2500\u2500 databaseQueryService.ts (query execution)\n\u2514\u2500\u2500 Domain services (contactQueries, transactionQueries, etc.)\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>databaseService.ts</code> reduced to <300 lines\n\u2610 3 new focused service files created\n\u2610 All existing functionality preserved\n\u2610 All existing tests pass\n\u2610 No changes to public API (consumers don't need updates)\n\u2610 Each new module has clear single responsibility\n\n<strong>Priority</strong>\n\n**HIGH** - Large file is a maintainability risk\n\n<strong>Estimate</strong>\n\n~80K tokens (refactor category x0.5 adjustment = ~40K effective)\n\n<strong>Category</strong>\n\nrefactor\n\n<strong>Impact</strong>\n\n\u2022 Improved code maintainability\n\u2022 Easier to test individual components\n\u2022 Clearer separation of concerns\n\u2022 Reduced risk when modifying database code\n\n<strong>Dependencies</strong>\n\n\u2022 Consider adding tests first (BACKLOG-191) to ensure refactor doesn't break anything\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-058: Split databaseService.ts (previous split, already completed)\n\u2022 BACKLOG-082: Database service architecture (related planning)\n\n<strong>Notes</strong>\n\nBACKLOG-058 was completed in SPRINT-002 and reduced the file significantly. However, the file has grown back to 1,223 lines and needs another round of extraction."
  },
  {
    "id": "BACKLOG-194",
    "title": "Add Test Coverage for Contexts",
    "category": "test",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~40K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-11",
    "completed_at": "",
    "file": "[BACKLOG-194.md](BACKLOG-194.md)",
    "description": "<strong>Summary</strong>\n\nAdd test coverage for <code>AuthContext.tsx</code> and <code>NetworkContext.tsx</code> which are critical infrastructure with no dedicated tests.\n\n<strong>Problem</strong>\n\nContext providers are foundational infrastructure that multiple components depend on:\n\u2022 <code>src/contexts/AuthContext.tsx</code> - Authentication state, login/logout\n\u2022 <code>src/contexts/NetworkContext.tsx</code> - Network connectivity detection\n\nWithout tests, changes to these contexts can silently break the entire application.\n\n<strong>Current State</strong>\n\n| File | Approx Lines | Coverage | Consumers |\n|------|--------------|----------|-----------|\n| <code>AuthContext.tsx</code> | ~150 | 0% | ~20 components |\n| <code>NetworkContext.tsx</code> | ~80 | 0% | ~10 components |\n\n<strong>Proposed Solution</strong>\n\nCreate comprehensive tests for each context:\n\n<strong>AuthContext Tests</strong>\n\u2022 Initial state (logged out)\n\u2022 Login flow (success and failure)\n\u2022 Logout flow\n\u2022 Session restoration\n\u2022 Token refresh\n\u2022 Error handling\n\n<strong>NetworkContext Tests</strong>\n\u2022 Initial state detection\n\u2022 Online/offline transitions\n\u2022 Event listener cleanup\n\u2022 Consumer hook behavior\n\n<strong>Testing Approach</strong>\n\n<code>// Example: Testing AuthContext\nimport { renderHook, act } from '@testing-library/react';\nimport { AuthProvider, useAuth } from './AuthContext';\n\ndescribe('AuthContext', () => {\n  it('should start in logged out state', () => {\n    const wrapper = ({ children }) => <AuthProvider>{children}</AuthProvider>;\n    const { result } = renderHook(() => useAuth(), { wrapper });\n\n    expect(result.current.isAuthenticated).toBe(false);\n    expect(result.current.user).toBeNull();\n  });\n\n  it('should update state on login', async () => {\n    // Mock window.api.auth.login\n    // Test state transition\n  });\n});\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 AuthContext has >80% test coverage\n\u2610 NetworkContext has >80% test coverage\n\u2610 Tests cover all public API methods\n\u2610 Tests cover error cases\n\u2610 All existing tests pass\n\u2610 No flaky tests\n\n<strong>Priority</strong>\n\n**MEDIUM** - Critical path coverage\n\n<strong>Estimate</strong>\n\n~40K tokens\n\n<strong>Category</strong>\n\ntest\n\n<strong>Impact</strong>\n\n\u2022 Safer context modifications\n\u2022 Prevents cascading failures\n\u2022 Documents expected behavior\n\n<strong>Dependencies</strong>\n\nNone\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-112: Boost Test Coverage for src/hooks/\n\u2022 BACKLOG-191: Add Test Coverage for Core Service Layer"
  },
  {
    "id": "BACKLOG-195",
    "title": "Add Test Coverage for Large Hooks",
    "category": "test",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~50K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-11",
    "completed_at": "",
    "file": "[BACKLOG-195.md](BACKLOG-195.md)",
    "description": "<strong>Summary</strong>\n\nAdd test coverage for the two largest hooks: <code>useAuditTransaction.ts</code> (499 lines) and <code>useAutoRefresh.ts</code> (562 lines).\n\n<strong>Problem</strong>\n\nThese hooks contain substantial business logic with no dedicated tests:\n\u2022 <code>src/hooks/useAuditTransaction.ts</code> (499 lines) - Transaction auditing workflow\n\u2022 <code>src/hooks/useAutoRefresh.ts</code> (562 lines) - Auto-refresh scheduling and execution\n\nBoth hooks are critical to core functionality and their size indicates complex logic that needs coverage.\n\n<strong>Current State</strong>\n\n| File | Lines | Coverage | Complexity |\n|------|-------|----------|------------|\n| <code>useAuditTransaction.ts</code> | 499 | ~0% | High - audit workflow |\n| <code>useAutoRefresh.ts</code> | 562 | ~0% | High - scheduling logic |\n\n<strong>Proposed Solution</strong>\n\n<strong>useAuditTransaction Tests</strong>\n\nTest the audit workflow:\n\u2022 Initial state\n\u2022 Step transitions (start -> verify -> assign -> complete)\n\u2022 Validation at each step\n\u2022 Error handling\n\u2022 Data persistence\n\n<strong>useAutoRefresh Tests</strong>\n\nTest the refresh mechanism:\n\u2022 Refresh scheduling\n\u2022 Refresh execution\n\u2022 Error recovery\n\u2022 Interval management\n\u2022 Component lifecycle (mount/unmount)\n\n<strong>Testing Approach</strong>\n\n<code>// Example: Testing useAuditTransaction\nimport { renderHook, act } from '@testing-library/react';\nimport { useAuditTransaction } from './useAuditTransaction';\n\ndescribe('useAuditTransaction', () => {\n  it('should start in initial step', () => {\n    const { result } = renderHook(() => useAuditTransaction());\n    expect(result.current.currentStep).toBe('initial');\n  });\n\n  it('should validate before step transition', async () => {\n    const { result } = renderHook(() => useAuditTransaction());\n\n    // Attempt to advance without required data\n    await act(async () => {\n      await result.current.nextStep();\n    });\n\n    expect(result.current.errors).toContain('Address required');\n  });\n});\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 useAuditTransaction has >60% test coverage\n\u2610 useAutoRefresh has >60% test coverage\n\u2610 Tests cover main workflows\n\u2610 Tests cover error cases\n\u2610 All existing tests pass\n\n<strong>Priority</strong>\n\n**MEDIUM** - Critical path coverage\n\n<strong>Estimate</strong>\n\n~50K tokens\n\n<strong>Category</strong>\n\ntest\n\n<strong>Impact</strong>\n\n\u2022 Safer hook modifications\n\u2022 Documents expected workflow behavior\n\u2022 Prevents regression in critical paths\n\n<strong>Dependencies</strong>\n\nNone\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-112: Boost Test Coverage for src/hooks/\n\u2022 BACKLOG-191: Add Test Coverage for Core Service Layer\n\u2022 BACKLOG-194: Add Test Coverage for Contexts"
  },
  {
    "id": "BACKLOG-196",
    "title": "Implement or Remove Settings.tsx TODOs",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-11",
    "completed_at": "",
    "file": "[BACKLOG-196.md](BACKLOG-196.md)",
    "description": "<strong>Summary</strong>\n\nAddress 10 placeholder features with TODO comments in <code>src/components/Settings.tsx</code> - either implement them or remove the UI placeholders.\n\n<strong>Problem</strong>\n\nThe Settings component has multiple placeholder features that:\n\u2022 Show UI that doesn't work (confusing for users)\n\u2022 Contain TODO comments indicating incomplete work\n\u2022 Create false expectations about app capabilities\n\n<strong>Current State</strong>\n\nFound 10 TODO/placeholder features in Settings.tsx:\n\n| Feature | Current State | Recommendation |\n|---------|--------------|----------------|\n| Export format selection | Placeholder | Implement (useful) |\n| Theme toggle | Placeholder | Implement or defer |\n| Notification settings | Placeholder | Remove (not MVP) |\n| Data retention settings | Placeholder | Implement (privacy) |\n| Sync frequency | Placeholder | Review necessity |\n| Language settings | Placeholder | Remove (English only) |\n| Privacy mode | Placeholder | Review necessity |\n| Backup schedule | Placeholder | Review necessity |\n| Account linking | Placeholder | Review necessity |\n| Debug mode toggle | Placeholder | Keep (dev tool) |\n\n<strong>Proposed Solution</strong>\n\n<strong>Phase 1: Audit & Categorize</strong>\n1. Document each placeholder feature\n2. Categorize: Implement | Remove | Defer\n\n<strong>Phase 2: Execute Decisions</strong>\n1. Remove features marked for removal\n2. Add \"Coming Soon\" badge to deferred features\n3. Implement quick-win features if time allows\n\n<strong>Example Implementation</strong>\n\n<code>// BEFORE\n<SettingsItem\n  title=\"Export Format\"\n  description=\"Choose export format\"\n  onClick={() => {}} // TODO: implement\n/>\n\n// AFTER (if removing)\n// Just delete the component\n\n// AFTER (if deferring)\n<SettingsItem\n  title=\"Export Format\"\n  description=\"Choose export format\"\n  disabled\n  badge=\"Coming Soon\"\n/>\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 All TODO comments in Settings.tsx addressed\n\u2610 No non-functional UI elements without \"Coming Soon\" badge\n\u2610 User expectations match actual functionality\n\u2610 Settings page is clean and professional\n\n<strong>Priority</strong>\n\n**LOW** - User experience clarity, not blocking\n\n<strong>Estimate</strong>\n\n~20K tokens\n\n<strong>Category</strong>\n\nui/enhancement\n\n<strong>Impact</strong>\n\n\u2022 Clearer user expectations\n\u2022 Professional appearance\n\u2022 Reduced confusion\n\n<strong>Dependencies</strong>\n\nNone\n\n<strong>Notes</strong>\n\nThis is primarily a UX cleanup task. Technical complexity is low, but decisions need to be made about each feature."
  },
  {
    "id": "BACKLOG-197",
    "title": "Enable Stricter TypeScript Rules",
    "category": "config",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-11",
    "completed_at": "",
    "file": "[BACKLOG-197.md](BACKLOG-197.md)",
    "description": "<strong>Summary</strong>\n\nEnable <code>noUnusedLocals</code> and <code>noUnusedParameters</code> in TypeScript config once <code>any</code> types are cleaned up.\n\n<strong>Problem</strong>\n\nThe codebase has unused variables and parameters that:\n\u2022 Create noise in the code\n\u2022 May indicate incomplete refactoring\n\u2022 Can hide bugs (variables set but never read)\n\nTypeScript's strict mode rules can catch these issues at compile time.\n\n<strong>Current State</strong>\n\nRules currently disabled in <code>tsconfig.json</code>:\n<code>{\n  \"compilerOptions\": {\n    \"noUnusedLocals\": false,\n    \"noUnusedParameters\": false\n  }\n}\n</code>\n\n<strong>Prerequisites</strong>\n\nBefore enabling these rules:\n1. **BACKLOG-115 must be complete** - Clean up <code>any</code> types first\n2. Codebase must compile cleanly with current rules\n\n<strong>Proposed Solution</strong>\n\n<strong>Phase 1: Dry Run</strong>\n1. Temporarily enable rules\n2. Document all violations\n3. Assess scope of cleanup\n\n<strong>Phase 2: Fix Violations</strong>\n1. Remove genuinely unused variables\n2. Prefix intentionally unused params with underscore: <code>_param</code>\n3. Use destructuring to ignore unused properties\n\n<strong>Phase 3: Enable Rules</strong>\n1. Update <code>tsconfig.json</code>\n2. Add to CI checks\n3. Document convention for unused params\n\n<strong>Example Fixes</strong>\n\n<code>// BEFORE - unused local\nfunction process(data: Data) {\n  const temp = data.value; // Never used\n  return data.processed;\n}\n\n// AFTER - removed\nfunction process(data: Data) {\n  return data.processed;\n}\n\n// BEFORE - unused parameter\nfunction handler(event: Event, context: Context) {\n  return event.type;\n}\n\n// AFTER - prefix unused\nfunction handler(event: Event, _context: Context) {\n  return event.type;\n}\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>noUnusedLocals: true</code> enabled\n\u2610 <code>noUnusedParameters: true</code> enabled\n\u2610 All violations fixed\n\u2610 CI passes with new rules\n\u2610 Convention documented for underscore prefix\n\n<strong>Priority</strong>\n\n**LOW** - Code hygiene improvement\n\n<strong>Estimate</strong>\n\n~25K tokens (depends on violation count)\n\n<strong>Category</strong>\n\nconfig/infra\n\n<strong>Impact</strong>\n\n\u2022 Cleaner codebase\n\u2022 Catches incomplete refactoring\n\u2022 Prevents unused variable bugs\n\n<strong>Dependencies</strong>\n\n\u2022 **BLOCKER**: BACKLOG-115 (Address any types) should be complete first\n  - Fixing <code>any</code> types often creates unused variables\n  - Doing both at once is more efficient\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-115: Address Remaining any Types in Electron Handlers"
  },
  {
    "id": "BACKLOG-198",
    "title": "Decompose Large Component Files",
    "category": "refactor",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~60K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-11",
    "completed_at": "",
    "file": "[BACKLOG-198.md](BACKLOG-198.md)",
    "description": "<strong>Summary</strong>\n\nReview and decompose large component files for better maintainability:\n\u2022 <code>AttachMessagesModal.tsx</code> (826 lines)\n\u2022 <code>LLMSettings.tsx</code> (820 lines)\n\n<strong>Problem</strong>\n\nComponents over 500 lines typically handle too many concerns:\n\u2022 Multiple UI states\n\u2022 Complex business logic\n\u2022 Nested sub-components\n\u2022 Multiple data flows\n\nThis makes them:\n\u2022 Hard to understand\n\u2022 Difficult to test\n\u2022 Risky to modify\n\u2022 Slow to render\n\n<strong>Current State</strong>\n\n| File | Lines | Location |\n|------|-------|----------|\n| <code>AttachMessagesModal.tsx</code> | 826 | <code>src/components/transactionDetailsModule/components/modals/</code> |\n| <code>LLMSettings.tsx</code> | 820 | <code>src/components/settings/</code> |\n\n<strong>Proposed Decomposition</strong>\n\n<strong>AttachMessagesModal.tsx (826 lines)</strong>\n\n| New File | Responsibility | Est. Lines |\n|----------|---------------|------------|\n| <code>AttachMessagesModal.tsx</code> | Orchestrator, modal shell | ~150 |\n| <code>ContactsList.tsx</code> | Contact selection view | ~200 |\n| <code>ThreadSelection.tsx</code> | Thread/message selection | ~200 |\n| <code>useAttachMessages.ts</code> | Business logic hook | ~150 |\n| <code>AttachMessages.types.ts</code> | Type definitions | ~50 |\n\n<strong>LLMSettings.tsx (820 lines)</strong>\n\n| New File | Responsibility | Est. Lines |\n|----------|---------------|------------|\n| <code>LLMSettings.tsx</code> | Orchestrator | ~150 |\n| <code>ProviderConfig.tsx</code> | Provider-specific settings | ~200 |\n| <code>ModelSelector.tsx</code> | Model selection UI | ~150 |\n| <code>CostDisplay.tsx</code> | Token/cost information | ~100 |\n| <code>useLLMSettings.ts</code> | Settings state management | ~150 |\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Both parent components reduced to <200 lines\n\u2610 New components are individually testable\n\u2610 All existing functionality preserved\n\u2610 All existing tests pass\n\u2610 No performance regressions\n\n<strong>Priority</strong>\n\n**LOW** - Maintainability improvement\n\n<strong>Estimate</strong>\n\n~60K tokens total\n\u2022 AttachMessagesModal: ~30K\n\u2022 LLMSettings: ~30K\n\n<strong>Category</strong>\n\nrefactor\n\n<strong>Impact</strong>\n\n\u2022 Improved maintainability\n\u2022 Easier testing\n\u2022 Better code reuse\n\u2022 Clearer component boundaries\n\n<strong>Dependencies</strong>\n\n\u2022 Consider adding tests first to ensure refactor safety\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-158: Decompose AuditTransactionModal Component\n\u2022 BACKLOG-098: Split AuditTransactionModal.tsx"
  },
  {
    "id": "BACKLOG-199",
    "title": "TypeScript Global Window Type Updates Not Recognized",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-199.md](items/BACKLOG-199.md)",
    "description": "<strong>Summary</strong>\n\nWhen updating <code>window.d.ts</code> to add new parameters to existing methods in the global Window interface augmentation, TypeScript does not pick up the changes. This requires using type assertions as a workaround.\n\n<strong>Problem</strong>\n\nUpdated <code>importMacOSMessages</code> in <code>src/window.d.ts</code> from:\n<code>importMacOSMessages: (userId: string) => Promise<MacOSImportResult>;\n</code>\n\nto:\n<code>importMacOSMessages: (userId: string, forceReimport?: boolean) => Promise<MacOSImportResult>;\n</code>\n\nHowever, TypeScript still reports:\n<code>error TS2554: Expected 1 arguments, but got 2.\n</code>\n\n<strong>Investigation Done</strong>\n\n\u2022 Verified file content is correct (md5 hash, od -c check)\n\u2022 Cleared all caches (node_modules/.cache, .tscache, tsbuildinfo)\n\u2022 Ran <code>tsc --noEmit --incremental false</code>\n\u2022 Tried triple-slash reference directive\n\u2022 Verified window.d.ts is in tsconfig include pattern\n\u2022 Checked for duplicate definitions - none found\n\u2022 Other 2-arg functions in same file work fine (e.g., <code>healthCheck</code>)\n\n<strong>Current Workaround</strong>\n\nType assertion in consuming code:\n<code>const importFn = window.api.messages.importMacOSMessages as (\n  userId: string,\n  forceReimport?: boolean\n) => Promise<...>;\n</code>\n\n<strong>Possible Causes</strong>\n\n1. TypeScript global declaration merging issue\n2. Declaration file module resolution order\n3. Incremental compilation cache at OS/daemon level\n4. Issue with how <code>declare global</code> interacts with lib DOM types\n\n<strong>Affected Files</strong>\n\n\u2022 <code>src/components/settings/MacOSMessagesImportSettings.tsx</code> - has workaround\n\n<strong>Priority</strong>\n\nLow - workaround exists and doesn't affect runtime\n\n<strong>Tags</strong>\n\ntypescript, types, window.d.ts, global-augmentation"
  },
  {
    "id": "BACKLOG-200",
    "title": "Contacts import fails with email validation error",
    "category": "fix",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-11",
    "completed_at": "",
    "file": "[BACKLOG-200.md](BACKLOG-200.md)",
    "description": "<strong>Category</strong>\nBug\n\n<strong>Priority</strong>\nMedium\n\n<strong>Description</strong>\nWhen importing contacts from macOS Contacts during onboarding, the import fails with a validation error on the email field. This results in \"No contacts imported yet\" being shown when users try to create transactions manually.\n\n<strong>Error Details</strong>\n<code>[Contacts] [Main] Import contacts failed:\n{\n  \"error\": {\n    \"name\": \"ValidationError\",\n    \"field\": \"email\"\n  }\n}\n</code>\n\n<strong>User Impact</strong>\n\u2022 Users cannot assign contacts to transactions\n\u2022 Manual transaction creation shows empty contacts list\n\u2022 Must manually create contacts instead of importing from address book\n\n<strong>Steps to Reproduce</strong>\n1. Fresh install / delete database\n2. Go through onboarding\n3. Grant Full Disk Access permissions\n4. Contacts import attempts but fails\n5. Try to create a transaction manually\n6. See \"No contacts imported yet\" message\n\n<strong>Technical Notes</strong>\n\u2022 1006 contacts were found for import but import failed\n\u2022 Error occurs in <code>contactsHandlers.ts</code> when calling <code>importContacts</code>\n\u2022 Likely a contact in the address book has a malformed email that fails validation\n\u2022 Need to investigate the validation logic and handle edge cases gracefully\n\n<strong>Files to Investigate</strong>\n\u2022 <code>electron/handlers/contactsHandlers.ts</code>\n\u2022 <code>electron/services/contactsService.ts</code>\n\u2022 Contact validation logic\n\n<strong>Acceptance Criteria</strong>\n\u2610 Contacts import succeeds even if some contacts have invalid data\n\u2610 Invalid contacts are skipped with a warning, not fail entire import\n\u2610 Import summary shows how many were skipped due to validation\n\u2610 Users see their imported contacts when creating transactions\n\n<strong>Related</strong>\n\u2022 Sprint-030 onboarding flow\n\u2022 macOS Contacts integration\n\n<strong>Created</strong>\n2026-01-11"
  },
  {
    "id": "BACKLOG-201",
    "title": "\"00\" prefix appearing before iMessage text",
    "category": "fix",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "~5K",
    "actual_tokens": "~180K",
    "variance": "+3500%",
    "created_at": "2026-01-11",
    "completed_at": "",
    "file": "[BACKLOG-201.md](BACKLOG-201.md)",
    "description": "<strong>Category</strong>\nBug\n\n<strong>Priority</strong>\nMedium (UX impact - confusing garbage text in messages)\n\n<strong>Status</strong>\nCompleted\n\n<strong>Description</strong>\n\"00\" text was appearing before every iMessage in conversation views. Instead of \"Hey it's daniel\", users saw \"00\\nHey it's daniel\".\n\n<strong>Root Cause Analysis</strong>\n\n<strong>Initial Assumptions (Wrong)</strong>\n1. **First hypothesis:** \"00\" was embedded in message data from iMessage parsing (typedstream format)\n   - Added debug logging to <code>messageParser.ts</code> during import - showed CLEAN data\n\n2. **Second hypothesis:** Client-side rendering issue\n   - Added sanitization in new <code>messageSanitizer.ts</code> - didn't fix it\n   - Added more aggressive debug logging in UI - still showed CLEAN data\n\n<strong>Breakthrough</strong>\nUser inspected element in browser DevTools, revealing \"00\" was a **TEXT NODE outside the message <code><p></code> tag**.\n\n<strong>Actual Root Cause</strong>\n<code>msg.has_attachments</code> is a **number** (0 or 1) from SQLite, not a boolean.\n\nIn JavaScript: <code>0 && anything</code> returns <code>0</code> (not <code>false</code>)\nReact renders the number <code>0</code> as text \"0\"\n\nTwo JSX conditionals used <code>{msg.has_attachments && ...}</code>, each rendering \"0\" = \"00\"\n\n<strong>Fix Applied</strong>\nChanged <code>{msg.has_attachments &&</code> to <code>{!!msg.has_attachments &&</code> (2 instances)\n\n**Files Changed:**\n\u2022 <code>src/components/transactionDetailsModule/components/modals/ConversationViewModal.tsx</code>\n  - Lines 366, 376: Added <code>!!</code> boolean coercion\n\n<strong>Cleanup Performed</strong>\nRemoved investigation artifacts that didn't solve the issue:\n\u2022 Reverted debug logging from <code>electron/utils/messageParser.ts</code>\n\u2022 Deleted <code>src/utils/messageSanitizer.ts</code> (created during investigation)\n\u2022 Removed sanitizer imports from <code>MessageThreadCard.tsx</code>\n\u2022 Reverted sanitizer usage in <code>ConversationViewModal.tsx</code>\n\n<strong>Key Learnings</strong>\n\n| Learning | Details |\n|----------|---------|\n| SQLite boolean storage | SQLite stores booleans as integers (0/1), not true/false |\n| React 0 rendering | React renders <code>0</code> as text, but not <code>false</code>, <code>null</code>, or <code>undefined</code> |\n| Boolean coercion pattern | Always use <code>!!field</code> or <code>Boolean(field)</code> when using numeric DB fields in JSX conditionals |\n| DevTools breakthrough | Browser \"Inspect Element\" was the breakthrough - showing \"00\" was a separate text node outside expected DOM structure |\n\n<strong>Effort Analysis</strong>\n\n| Phase | Time | Notes |\n|-------|------|-------|\n| Investigation | ~2-3 hours | Wrong initial assumptions led down rabbit holes (parser debugging, sanitizer creation) |\n| Actual fix | ~5 minutes | 2 lines of code change |\n| Cleanup | ~15 minutes | Remove dead-end code artifacts |\n| **Total** | **~3 hours** | **Ratio: 36:1 investigation to fix** |\n\n<strong>Preventive Measures</strong>\nConsider adding ESLint rule or documentation note:\n\u2022 Any SQLite integer field used in JSX conditionals should use boolean coercion\n\u2022 Especially: <code>has_attachments</code>, <code>is_read</code>, <code>is_from_me</code>, etc.\n\n<strong>Related</strong>\n\u2022 ConversationViewModal.tsx\n\u2022 SQLite boolean handling patterns\n\u2022 React conditional rendering quirks\n\n<strong>Review Status</strong>\n\u2611 SR Engineer: APPROVED\n\u2611 Ready for merge\n\n<strong>Created</strong>\n2026-01-11\n\n<strong>Completed</strong>\n2026-01-11"
  },
  {
    "id": "BACKLOG-202",
    "title": "Fix Test Regressions (contact-handlers/databaseService)",
    "category": "test",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-037",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-202.md](BACKLOG-202.md)",
    "created_at": "2026-01-11",
    "completed_at": "",
    "file": "",
    "description": "<strong>Summary</strong>\n\nFix test regressions in <code>electron/__tests__/contact-handlers.test.ts</code> and <code>electron/services/__tests__/databaseService.test.ts</code> that are causing CI failures.\n\n<strong>Problem</strong>\n\nTest regressions have been introduced, causing CI to fail. These tests cover critical functionality:\n\u2022 **contact-handlers.test.ts** - Tests for contact IPC handlers\n\u2022 **databaseService.test.ts** - Tests for core database operations\n\nThese regressions may have been introduced during recent sprints (SPRINT-027 through SPRINT-031) involving state machine changes, database initialization gates, or message import features.\n\n<strong>Files to Investigate</strong>\n\n\u2022 <code>electron/__tests__/contact-handlers.test.ts</code> - Contact handler tests\n\u2022 <code>electron/services/__tests__/databaseService.test.ts</code> - Database service tests\n\u2022 <code>electron/handlers/contactHandlers.ts</code> - Contact handler implementation\n\u2022 <code>electron/services/databaseService.ts</code> - Database service implementation\n\n<strong>Root Cause Analysis Needed</strong>\n\n1. Identify which tests are failing\n2. Determine when regression was introduced (git bisect if needed)\n3. Verify if test expectations or implementation changed\n4. Fix either the test or the underlying implementation bug\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 All contact-handler tests pass\n\u2610 All databaseService tests pass\n\u2610 No regressions in other tests\n\u2610 CI passes completely\n\u2610 Root cause documented in task file\n\n<strong>Priority</strong>\n\n**CRITICAL** - Test failures block CI and can mask other issues\n\n<strong>Estimate</strong>\n\n~20K tokens (investigation + fix)\n\n<strong>Category</strong>\n\ntest/fix\n\n<strong>Impact</strong>\n\n\u2022 Unblocks CI pipeline\n\u2022 Ensures database and contact operations work correctly\n\u2022 Prevents regressions from going unnoticed\n\n<strong>Dependencies</strong>\n\nNone - should be fixed immediately\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-157: Fix Failing Auth Handler Integration Test (similar pattern)\n\u2022 BACKLOG-191: Add Test Coverage for Core Service Layer"
  },
  {
    "id": "BACKLOG-203",
    "title": "Add Comprehensive Tests for macOSMessagesImportService",
    "category": "test",
    "priority": "High",
    "status": "Obsolete",
    "sprint": "-",
    "est_tokens": "~40K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-11",
    "completed_at": "",
    "file": "[BACKLOG-203.md](BACKLOG-203.md)",
    "description": "<strong>Summary</strong>\n\nAdd comprehensive test coverage for <code>electron/services/macOSMessagesImportService.ts</code>, a critical service for importing iMessage conversations on macOS.\n\n<strong>Problem</strong>\n\nThe <code>macOSMessagesImportService</code> handles macOS Messages (iMessage) database parsing and import. This is a complex service with multiple parsing operations, database queries, and attachment handling. Currently, test coverage may be limited to attachment tests only (<code>macOSMessagesImportService.attachments.test.ts</code>).\n\n<strong>Current State</strong>\n\n| File | Exists | Coverage Focus |\n|------|--------|----------------|\n| <code>macOSMessagesImportService.attachments.test.ts</code> | Yes | Attachment parsing only |\n| <code>macOSMessagesImportService.test.ts</code> | Unknown | Core import logic |\n\n<strong>Proposed Solution</strong>\n\nCreate comprehensive unit tests covering:\n\n1. **Message Parsing**\n   - Basic message extraction from chat.db\n   - Attributed body parsing (styled text)\n   - Group chat handling\n   - Date/timestamp conversion\n\n2. **Contact Matching**\n   - Phone number normalization\n   - Contact lookup by phone/email\n   - Unknown contact handling\n\n3. **Thread Management**\n   - Thread creation and grouping\n   - Participant resolution\n   - Thread-to-transaction linking\n\n4. **Attachment Handling**\n   - (Already covered in attachments test)\n   - Integration with message import\n\n5. **Error Handling**\n   - Database access errors\n   - Malformed message data\n   - Permission issues\n\n<strong>Files to Test</strong>\n\n\u2022 <code>electron/services/macOSMessagesImportService.ts</code> - Main service\n\n<strong>Files to Read (for context)</strong>\n\n\u2022 <code>electron/services/__tests__/macOSMessagesImportService.attachments.test.ts</code> - Existing tests\n\u2022 <code>.claude/docs/shared/imessage-attributedbody-parsing.md</code> - Parsing documentation\n\u2022 <code>electron/handlers/messageImportHandlers.ts</code> - Handler using this service\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Core message import logic has >60% test coverage\n\u2610 Message parsing tests cover happy path and edge cases\n\u2610 Contact matching tests cover various phone formats\n\u2610 Thread grouping tests verify correct behavior\n\u2610 Error handling tests ensure graceful failures\n\u2610 All existing tests continue to pass\n\u2610 No flaky tests introduced\n\n<strong>Priority</strong>\n\n**HIGH** - Messages feature is user-facing and parsing bugs impact data quality\n\n<strong>Estimate</strong>\n\n~40K tokens (comprehensive test suite)\n\n<strong>Category</strong>\n\ntest\n\n<strong>Impact</strong>\n\n\u2022 Prevents regression bugs in message import\n\u2022 Enables safer refactoring of parsing logic\n\u2022 Improves confidence in macOS-specific functionality\n\u2022 Documents expected behavior through tests\n\n<strong>Dependencies</strong>\n\nNone - can be done independently\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-172: macOS Messages Import (feature implementation)\n\u2022 BACKLOG-191: Add Test Coverage for Core Service Layer (pattern)"
  },
  {
    "id": "BACKLOG-204",
    "title": "Abstract window.api Calls into Service Layer",
    "category": "refactor",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~80K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-11",
    "completed_at": "",
    "file": "[BACKLOG-204.md](BACKLOG-204.md)",
    "description": "<strong>Summary</strong>\n\nMigrate direct <code>window.api</code> calls from React components to proper service layer abstractions in <code>src/services/</code>.\n\n<strong>Problem</strong>\n\nMultiple React components make direct calls to <code>window.api.*</code> instead of using the service layer. This violates architecture principles:\n\n1. **Coupling** - Components directly depend on Electron IPC structure\n2. **Testability** - Harder to mock IPC calls in component tests\n3. **Maintainability** - Changes to IPC interface require component updates\n4. **Consistency** - Mix of direct calls and service calls creates confusion\n\n<strong>Current State</strong>\n\nComponents with direct <code>window.api</code> calls (partial list):\n\u2022 <code>src/components/Settings.tsx</code>\n\u2022 <code>src/components/Transactions.tsx</code>\n\u2022 <code>src/components/TransactionDetails.tsx</code>\n\u2022 <code>src/components/transactionDetailsModule/components/*.tsx</code>\n\u2022 <code>src/components/onboarding/steps/PermissionsStep.tsx</code>\n\u2022 <code>src/components/audit/RoleAssignment.tsx</code>\n\u2022 <code>src/components/transaction/components/EditTransactionModal.tsx</code>\n\n<strong>Proposed Solution</strong>\n\n<strong>Phase 1: Audit and Categorize (~10K tokens)</strong>\n1. Enumerate all <code>window.api</code> calls in components\n2. Categorize by domain (auth, transactions, contacts, system, etc.)\n3. Map to existing or needed service abstractions\n\n<strong>Phase 2: Extend Service Layer (~30K tokens)</strong>\n1. Add missing methods to existing services\n2. Create new services if needed (e.g., <code>messageService.ts</code>)\n3. Ensure consistent error handling and typing\n\n<strong>Phase 3: Migrate Components (~40K tokens)</strong>\n1. Replace direct calls with service methods\n2. Update component tests to mock services\n3. Verify all functionality still works\n\n<strong>Files to Modify</strong>\n\n<strong>Services (extend or create)</strong>\n\u2022 <code>src/services/authService.ts</code>\n\u2022 <code>src/services/transactionService.ts</code>\n\u2022 <code>src/services/systemService.ts</code>\n\u2022 <code>src/services/deviceService.ts</code>\n\u2022 <code>src/services/contactService.ts</code> (may need creation)\n\u2022 <code>src/services/messageService.ts</code> (may need creation)\n\n<strong>Components (migrate)</strong>\n\u2022 Multiple components in <code>src/components/</code>\n\u2022 Multiple hooks in <code>src/components/*/hooks/</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 No direct <code>window.api</code> calls in component files\n\u2610 All IPC calls routed through service layer\n\u2610 Services have proper TypeScript types\n\u2610 Existing tests continue to pass\n\u2610 Component tests mock services (not window.api)\n\u2610 Documentation updated with service patterns\n\n<strong>Priority</strong>\n\n**MEDIUM** - Architecture improvement, not blocking features\n\n<strong>Estimate</strong>\n\n| Phase | Est. Tokens |\n|-------|-------------|\n| Phase 1: Audit | ~10K |\n| Phase 2: Services | ~30K |\n| Phase 3: Migration | ~40K |\n| **Total** | ~80K |\n\n<strong>Category</strong>\n\nrefactor\n\n<strong>Impact</strong>\n\n\u2022 Improves testability of React components\n\u2022 Reduces coupling to Electron IPC layer\n\u2022 Enables future changes to IPC without component updates\n\u2022 Establishes clear architecture boundaries\n\n<strong>Dependencies</strong>\n\n\u2022 Should be done after BACKLOG-191 (service layer tests) for better coverage\n\u2022 Complements BACKLOG-111 (Migrate Components to Service Abstractions)\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-111: Migrate Components to Service Abstractions (similar scope)\n\u2022 BACKLOG-191: Add Test Coverage for Core Service Layer\n\u2022 Architecture Guardrails: <code>.claude/docs/shared/architecture-guardrails.md</code>\n\n<strong>Technical Notes</strong>\n\n<strong>Current Service Pattern</strong>\n<code>// src/services/authService.ts\nexport const authService = {\n  login: async (email: string, password: string) => {\n    return window.api.auth.login(email, password);\n  },\n  // ...\n};\n</code>\n\n<strong>Usage Pattern in Components</strong>\n<code>// Before (direct call)\nconst user = await window.api.auth.getCurrentUser();\n\n// After (service abstraction)\nimport { authService } from '../services/authService';\nconst user = await authService.getCurrentUser();\n</code>"
  },
  {
    "id": "BACKLOG-205",
    "title": "Fix Flaky useAutoRefresh Timer Tests",
    "category": "test",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-11",
    "completed_at": "",
    "file": "[BACKLOG-205.md](BACKLOG-205.md)",
    "description": "<strong>Summary</strong>\n\nFix 4 flaky tests in <code>useAutoRefresh.test.ts</code> that have race conditions with Jest fake timers and async operations.\n\n<strong>Problem</strong>\n\nThese tests intermittently fail in CI due to timing issues between Jest's fake timers and async Promise resolution:\n\n1. <code>should only trigger once per dashboard entry</code> (line 217)\n2. <code>should wait for preferences before triggering</code> (line 652)\n3. <code>should default to enabled when preference not set</code> (line 688)\n4. <code>should default to enabled on preference load error</code> (line 708)\n\nThe tests are currently skipped with <code>it.skip()</code> to unblock CI.\n\n<strong>Root Cause Analysis</strong>\n\nThe tests use a combination of:\n\u2022 Jest fake timers (<code>jest.useFakeTimers()</code>)\n\u2022 Async operations (<code>mockPreferencesGet.mockResolvedValue()</code>)\n\u2022 Timer advancement (<code>jest.advanceTimersByTime()</code>)\n\nThe race condition occurs because:\n1. The hook loads preferences asynchronously\n2. The test advances timers before the async operation completes\n3. The expected callback never fires because the timer was set after advancement\n\n<strong>Proposed Solution</strong>\n\nOptions (in order of preference):\n\n<strong>Option 1: Use <code>waitFor</code> with proper flush</strong>\n<code>import { waitFor } from '@testing-library/react';\n\nit(\"should only trigger once per dashboard entry\", async () => {\n  renderHook(() => useAutoRefresh(defaultOptions));\n\n  // Wait for preferences to load AND timer to fire\n  await waitFor(() => {\n    expect(mockTransactionsScan).toHaveBeenCalledTimes(1);\n  }, { timeout: 5000 });\n});\n</code>\n\n<strong>Option 2: Use <code>runAllTimersAsync</code></strong>\n<code>await act(async () => {\n  await jest.runAllTimersAsync();\n});\n</code>\n\n<strong>Option 3: Manual microtask flushing</strong>\n<code>const flushPromises = () => new Promise(setImmediate);\n\nawait act(async () => {\n  await flushPromises();\n  jest.advanceTimersByTime(2500);\n  await flushPromises();\n});\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 All 4 tests are re-enabled (remove <code>it.skip</code>)\n\u2610 Tests pass consistently in CI (run 10x without failure)\n\u2610 Tests pass on both macOS and Windows CI runners\n\u2610 No timing-dependent assertions\n\n<strong>Priority</strong>\n\n**MEDIUM** - Tests are skipped but functionality is covered by other tests\n\n<strong>Estimate</strong>\n\n~15K tokens\n\n<strong>Category</strong>\n\ntest\n\n<strong>Impact</strong>\n\n\u2022 Restores full test coverage for useAutoRefresh\n\u2022 Removes technical debt (skipped tests)\n\u2022 Improves CI reliability\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-195: Add Test Coverage for Large Hooks\n\u2022 PR #386: Original test fix PR where these were skipped"
  },
  {
    "id": "BACKLOG-206",
    "title": "UI Freezing During iMessage Sync/Import",
    "category": "performance",
    "priority": "High",
    "status": "Pending",
    "sprint": "SPRINT-033",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-206.md](BACKLOG-206.md)",
    "created_at": "2026-01-11",
    "completed_at": "",
    "file": "",
    "description": "<strong>Description</strong>\n\nThe app freezes during iMessage sync/import operations when processing large message databases. Users with large message histories (600K+ messages) experience complete UI unresponsiveness during sync operations.\n\n<strong>Problem Context</strong>\n\nObserved with a user's database:\n\u2022 **677,255 messages**\n\u2022 **62,844 attachments**\n\u2022 **1,355 processing batches**\n\nThe heavy processing blocks the main thread, causing the UI to become completely unresponsive until sync completes.\n\n<strong>Current Behavior</strong>\n\n\u2022 Sync operations execute on the main thread\n\u2022 No progress feedback during import\n\u2022 UI is completely frozen during processing\n\u2022 User cannot interact with the app or even close it gracefully\n\u2022 No indication of how long the process will take\n\n<strong>Expected Behavior</strong>\n\n1. **UI remains responsive** during all sync/import operations\n2. **Progress indicator** shows current status (e.g., \"Processing batch 500 of 1,355\")\n3. **User can cancel** long-running operations if needed\n4. **App remains interactive** - user can navigate other parts of the UI\n\n<strong>Proposed Solutions</strong>\n\n<strong>Option 1: Worker Thread (Recommended)</strong>\n\nMove heavy processing to a Node.js Worker Thread:\n\n<code>// Main thread\nimport { Worker } from 'worker_threads';\n\nconst worker = new Worker('./messageImportWorker.js', {\n  workerData: { dbPath, options }\n});\n\nworker.on('message', (progress) => {\n  // Update UI with progress\n  mainWindow.webContents.send('import-progress', progress);\n});\n\nworker.on('exit', () => {\n  mainWindow.webContents.send('import-complete');\n});\n</code>\n\n**Pros:**\n\u2022 Complete isolation - no main thread blocking\n\u2022 Can use full CPU core for processing\n\u2022 Progress updates via message passing\n\n**Cons:**\n\u2022 Requires Worker Thread setup\n\u2022 Database connection handling in worker\n\n<strong>Option 2: Async Chunking with UI Yields</strong>\n\nProcess in chunks with <code>setImmediate</code> yields:\n\n<code>async function processMessagesInChunks(\n  messages: Message[],\n  batchSize: number,\n  onProgress: (current: number, total: number) => void\n) {\n  const total = Math.ceil(messages.length / batchSize);\n\n  for (let i = 0; i < messages.length; i += batchSize) {\n    const batch = messages.slice(i, i + batchSize);\n    await processBatch(batch);\n\n    // Yield to event loop - allows UI to update\n    await new Promise(resolve => setImmediate(resolve));\n\n    onProgress(Math.floor(i / batchSize) + 1, total);\n  }\n}\n</code>\n\n**Pros:**\n\u2022 Simpler implementation\n\u2022 No Worker Thread complexity\n\u2022 Uses existing architecture\n\n**Cons:**\n\u2022 Still runs on main thread (just yields periodically)\n\u2022 May still have micro-freezes during batch processing\n\n<strong>Option 3: Hybrid Approach</strong>\n\nUse Web Workers for CPU-intensive transformation, main thread for I/O:\n\n<code>// Renderer process\nconst worker = new Worker('transformWorker.js');\n\n// Send raw data to worker for transformation\nworker.postMessage({ type: 'transform', data: rawMessages });\n\n// Worker handles parsing/transformation\nworker.onmessage = async (e) => {\n  if (e.data.type === 'transformed') {\n    // Main thread handles database writes\n    await window.api.saveMessages(e.data.messages);\n  }\n};\n</code>\n\n<strong>Technical Implementation</strong>\n\n<strong>Files to Modify</strong>\n\n1. **src/main/services/macosMessagesService.ts** - Add chunked processing with yields\n2. **src/main/ipc/handlers/** - Add progress event emission\n3. **src/preload/index.ts** - Expose progress events\n4. **src/renderer/components/** - Add progress indicator component\n5. **New: src/main/workers/messageImportWorker.ts** - If using Worker Thread approach\n\n<strong>Progress Indicator Design</strong>\n\n<code>+------------------------------------------+\n|  Importing Messages                   X  |\n+------------------------------------------+\n|                                          |\n|  [=========>           ] 45%             |\n|                                          |\n|  Processing batch 612 of 1,355           |\n|  Messages: 305,500 / 677,255             |\n|                                          |\n|  Elapsed: 2:34  |  Remaining: ~3:15      |\n|                                          |\n|           [Cancel Import]                |\n+------------------------------------------+\n</code>\n\n<strong>IPC Events</strong>\n\n<code>// Progress event\ninterface ImportProgress {\n  type: 'messages' | 'attachments';\n  current: number;\n  total: number;\n  batchNumber: number;\n  totalBatches: number;\n  elapsedMs: number;\n}\n\n// Main -> Renderer\nipcMain.emit('import-progress', progress: ImportProgress);\nipcMain.emit('import-complete', result: ImportResult);\nipcMain.emit('import-error', error: Error);\n\n// Renderer -> Main (cancellation)\nipcRenderer.send('import-cancel');\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 UI remains responsive during import of 600K+ messages\n\u2610 Progress indicator shows batch progress (X of Y)\n\u2610 Progress indicator shows message count progress\n\u2610 Estimated time remaining is displayed\n\u2610 User can cancel import operation\n\u2610 Cancellation is graceful (no data corruption)\n\u2610 Progress persists across app restarts (resume capability - stretch goal)\n\u2610 No regression in import speed (< 10% slower)\n\n<strong>Estimated Tokens</strong>\n\n~25,000 (Worker Thread setup + Progress UI + IPC changes)\n\nIf using Option 2 (chunking only): ~15,000\n\n<strong>Testing</strong>\n\n\u2610 Test with small database (< 1000 messages) - fast completion\n\u2610 Test with medium database (10K-50K messages) - progress visible\n\u2610 Test with large database (500K+ messages) - remains responsive\n\u2610 Test cancellation mid-import\n\u2610 Test cancellation recovery (no corrupt state)\n\u2610 Test progress accuracy (actual vs displayed)\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-173: AttachMessagesModal UI freeze (different issue - query optimization)\n\u2022 BACKLOG-190: Transaction date range filtering (different issue - unbounded linking)\n\u2022 BACKLOG-156: Background sync (mentions UI responsiveness during sync)\n\n<strong>Notes</strong>\n\nThis is a distinct issue from BACKLOG-173 (modal query performance) and BACKLOG-190 (message linking scope). Those address specific query bottlenecks; this addresses the fundamental architecture of keeping the UI responsive during heavy I/O operations.\n\nThe recommended approach is Option 1 (Worker Thread) for complete isolation, but Option 2 (chunking with yields) is acceptable as a faster-to-implement solution with most of the benefits."
  },
  {
    "id": "BACKLOG-207",
    "title": "Auto-Link Communications When Contact Added",
    "category": "feature",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-045",
    "est_tokens": "~40K",
    "actual_tokens": "~20K",
    "variance": "-50%",
    "created_at": "2026-01-11",
    "completed_at": "2026-01-19",
    "file": "PR #475",
    "description": "<strong>Description</strong>\n\nWhen a user adds a contact to a transaction, the system should automatically search for existing communications (emails and iMessages/SMS) with that contact and link them to the transaction. This saves the user from manually attaching messages after adding a contact.\n\n<strong>Problem Context</strong>\n\nCurrently, when a user adds a contact to a transaction:\n1. The contact is associated with the transaction\n2. But existing emails and text messages with that contact are NOT automatically linked\n3. User must manually go to the Messages/Emails tab and attach relevant communications\n4. This is tedious, especially for transactions with multiple contacts\n\n<strong>User Value</strong>\n\n\u2022 **Time savings**: Eliminates manual message attachment for each contact\n\u2022 **Completeness**: Ensures relevant communications are not missed\n\u2022 **Better UX**: Transaction setup is more \"automatic\" and intelligent\n\n<strong>Current Behavior</strong>\n\n1. User opens transaction\n2. User adds contact (e.g., \"John Smith - Buyer's Agent\")\n3. Contact is saved to transaction\n4. Emails/messages with John Smith remain unlinked\n5. User must manually search and attach communications\n\n<strong>Expected Behavior</strong>\n\n1. User opens transaction\n2. User adds contact (e.g., \"John Smith - Buyer's Agent\")\n3. System automatically:\n   - Searches emails for contact's email address(es)\n   - Searches iMessages/SMS for contact's phone number(s)\n   - Links matching communications to the transaction (within date range if applicable)\n4. User sees notification: \"Found 12 emails and 8 text messages with John Smith. Linked to transaction.\"\n5. User can review linked communications in the Messages/Emails tabs\n\n<strong>Technical Implementation</strong>\n\n<strong>Trigger Point</strong>\n\nThe auto-link should trigger when:\n\u2022 A contact is added to a transaction via <code>addContactToTransaction</code> or similar\n\u2022 NOT when contact is updated (unless email/phone changed)\n\u2022 NOT during bulk import (performance consideration)\n\n<strong>Search Strategy</strong>\n\n<code>interface AutoLinkOptions {\n  contactId: string;\n  transactionId: string;\n  dateRange?: {\n    start: Date;  // Transaction listing date?\n    end: Date;    // Transaction closing date?\n  };\n}\n\nasync function autoLinkCommunicationsForContact(options: AutoLinkOptions) {\n  const contact = await getContact(options.contactId);\n\n  // Search emails by email address(es)\n  const emails = await searchEmailsByAddress(\n    contact.emails,\n    options.dateRange\n  );\n\n  // Search messages by phone number(s)\n  const messages = await searchMessagesByPhone(\n    contact.phoneNumbers,\n    options.dateRange\n  );\n\n  // Link to transaction\n  await linkEmailsToTransaction(emails, options.transactionId);\n  await linkMessagesToTransaction(messages, options.transactionId);\n\n  return {\n    emailsLinked: emails.length,\n    messagesLinked: messages.length\n  };\n}\n</code>\n\n<strong>Date Range Filtering</strong>\n\nCommunications should be filtered to relevant date range:\n\u2022 If transaction has listing/closing dates: use that range (with buffer)\n\u2022 If no dates: use last 6 months (configurable?)\n\u2022 This prevents linking ancient communications\n\n<strong>User Notification</strong>\n\nOptions for notifying the user:\n1. **Toast notification**: \"Linked 12 emails and 8 messages with John Smith\"\n2. **Inline in contact row**: Small badge showing linked count\n3. **Summary when saving**: \"Added 3 contacts. Linked 45 communications.\"\n\n<strong>Performance Considerations</strong>\n\n\u2022 Run search/linking asynchronously (don't block contact save)\n\u2022 Show progress indicator for large datasets\n\u2022 Consider batch processing if multiple contacts added at once\n\u2022 May need to leverage existing indexes on email addresses and phone numbers\n\n<strong>Files to Modify</strong>\n\n| File | Changes |\n|------|---------|\n| <code>electron/services/transactionService.ts</code> | Add auto-link trigger after contact add |\n| <code>electron/services/emailService.ts</code> or similar | Add search by address function |\n| <code>electron/services/macosMessagesService.ts</code> | Add search by phone number function |\n| <code>src/components/AuditTransactionModal.tsx</code> | Show linking progress/results |\n| <code>src/components/EditTransactionModal.tsx</code> | Same for edit flow |\n\n<strong>Edge Cases</strong>\n\n1. **Contact with no email/phone**: Skip auto-link (nothing to search)\n2. **Duplicate communications**: Check if already linked before adding\n3. **Large result sets**: May need pagination or limit (e.g., top 100 most recent)\n4. **Contact added to multiple transactions**: Each transaction gets its own links\n5. **Email provider not connected**: Only search available sources\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 When a contact is added to a transaction, relevant emails are auto-linked\n\u2610 When a contact is added to a transaction, relevant iMessages/SMS are auto-linked\n\u2610 Communications are filtered to transaction date range (if available)\n\u2610 User is notified of how many communications were linked\n\u2610 Duplicate links are prevented (idempotent operation)\n\u2610 Performance is acceptable (< 2 seconds for typical contact)\n\u2610 User can disable auto-linking in settings (optional/stretch goal)\n\n<strong>Estimated Tokens</strong>\n\n~35,000-50,000 (moderate complexity, touches multiple services)\n\n<strong>Testing</strong>\n\n\u2610 Unit tests for email search by address\n\u2610 Unit tests for message search by phone\n\u2610 Integration test: add contact -> verify communications linked\n\u2610 Test with contact having no email/phone\n\u2610 Test with contact having multiple emails/phones\n\u2610 Test duplicate prevention\n\u2610 Test date range filtering\n\u2610 Performance test with large message database\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-105: Text Messages Tab in Transaction Details (completed)\n\u2022 BACKLOG-173: AttachMessagesModal improvements\n\u2022 BACKLOG-190: Transaction date range filtering for messages\n\n<strong>Notes</strong>\n\nThis feature is a natural progression from the manual attach flow. It builds on existing infrastructure:\n\u2022 Email/message search already exists for manual attach\n\u2022 Transaction-communication linking already exists\n\u2022 Contact-transaction association already exists\n\nThe main new work is:\n1. Triggering the search automatically on contact add\n2. Filtering by date range\n3. User notification of results"
  },
  {
    "id": "BACKLOG-208",
    "title": "Separate Email/Text Counts on Transaction Cards",
    "category": "ui",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-033",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-208.md](BACKLOG-208.md)",
    "created_at": "2026-01-11",
    "completed_at": "",
    "file": "",
    "description": "<strong>Description</strong>\n\nTransaction cards currently display a combined count showing \"X emails\" but this count may include text messages or texts are being mislabeled as emails. The UI should separate and accurately display counts for each communication type.\n\n<strong>Problem Context</strong>\n\nOn the transaction page, transaction cards show something like \"12 emails\" but:\n1. This count may include text messages (SMS/iMessage) mixed with emails\n2. Or text messages are being incorrectly labeled as \"emails\"\n3. Users cannot distinguish how many emails vs text messages are linked to a transaction at a glance\n4. This creates confusion about what communications are actually associated\n\n<strong>Current Behavior</strong>\n\nTransaction cards display:\n<code>[Transaction Card]\n  Property Address\n  12 emails\n</code>\n\nBut \"12 emails\" may actually be 8 emails + 4 text messages, or the texts are mislabeled.\n\n<strong>Expected Behavior</strong>\n\nTransaction cards should display separate counts:\n\n**Option A (Text labels):**\n<code>[Transaction Card]\n  Property Address\n  8 emails, 4 texts\n</code>\n\n**Option B (Icons):**\n<code>[Transaction Card]\n  Property Address\n  [email-icon] 8  [message-icon] 4\n</code>\n\n**Option C (Combined with breakdown):**\n<code>[Transaction Card]\n  Property Address\n  12 messages (8 emails, 4 texts)\n</code>\n\n<strong>Technical Investigation Needed</strong>\n\n1. **Data source check**: Verify how counts are being calculated\n   - Is the query filtering by channel type (<code>email</code> vs <code>sms</code>/<code>imessage</code>)?\n   - Are the channels being set correctly during import?\n\n2. **Possible issues**:\n   - Query might not be filtering by channel\n   - iMessage/SMS might have incorrect channel value in database\n   - UI might be hardcoding \"emails\" label regardless of actual types\n\n<strong>Files Likely Involved</strong>\n\n| File | Changes |\n|------|---------|\n| <code>src/components/transaction/TransactionCard.tsx</code> | Update UI to show separate counts |\n| <code>electron/services/transactionService.ts</code> | Modify query to return counts by type |\n| Database query | Split COUNT by channel type |\n\n<strong>Proposed Implementation</strong>\n\n<strong>Database Query Change</strong>\n\n<code>-- Current (suspected)\nSELECT COUNT(*) as email_count\nFROM messages\nWHERE transaction_id = ?\n\n-- Proposed\nSELECT\n  SUM(CASE WHEN channel = 'email' THEN 1 ELSE 0 END) as email_count,\n  SUM(CASE WHEN channel IN ('sms', 'imessage') THEN 1 ELSE 0 END) as text_count\nFROM messages\nWHERE transaction_id = ?\n</code>\n\n<strong>UI Component Update</strong>\n\n<code>interface TransactionCounts {\n  emails: number;\n  texts: number;\n}\n\n// In TransactionCard\nfunction renderCommunicationCount({ emails, texts }: TransactionCounts) {\n  const parts = [];\n  if (emails > 0) parts.push(<code>${emails} ${emails === 1 ? 'email' : 'emails'}</code>);\n  if (texts > 0) parts.push(<code>${texts} ${texts === 1 ? 'text' : 'texts'}</code>);\n\n  if (parts.length === 0) return 'No communications';\n  return parts.join(', ');\n}\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Transaction cards display separate counts for emails and text messages\n\u2610 Counts accurately reflect the actual communication types in the database\n\u2610 Zero counts are handled gracefully (e.g., \"3 emails\" not \"3 emails, 0 texts\")\n\u2610 Singular/plural grammar is correct (\"1 email\" vs \"2 emails\")\n\u2610 UI design is clear and not cluttered\n\u2610 Query performance is not degraded\n\n<strong>Estimated Tokens</strong>\n\n~15,000-25,000 (straightforward UI + query change)\n\n<strong>Testing</strong>\n\n\u2610 Transaction with only emails shows only email count\n\u2610 Transaction with only texts shows only text count\n\u2610 Transaction with both shows both counts correctly\n\u2610 Transaction with no communications shows appropriate message\n\u2610 Verify counts match actual database records\n\u2610 Check performance with transactions having many linked messages\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-105: Text Messages Tab in Transaction Details (completed)\n\u2022 BACKLOG-207: Auto-Link Communications When Contact Added\n\n<strong>Notes</strong>\n\nThis is a data accuracy and UX improvement. Users need to know at a glance what types of communications are linked to each transaction, especially for audit purposes where the distinction between email and text evidence matters."
  },
  {
    "id": "BACKLOG-209",
    "title": "Fix iMessage Text Encoding Corruption (Data Loss)",
    "category": "fix",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-033",
    "est_tokens": "~60K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-209.md](BACKLOG-209.md)",
    "created_at": "2026-01-11",
    "completed_at": "",
    "file": "",
    "description": "<strong>Description</strong>\n\nMessages imported from the macOS Messages database are showing corruption characters (U+FFFD replacement characters) where actual text should be. The current \"fix\" removes these characters, which **LOSES the actual message content**. For a compliance/audit tool, losing message data is UNACCEPTABLE.\n\n<strong>Problem Context</strong>\n\nWhen importing iMessages from the macOS Messages database (<code>chat.db</code>), some messages display corrupted text:\n\n**Example of corruption:**\n<code>Expected: \"Hey, let's meet at 3pm tomorrow\"\nActual:   \"Hey, let's meet at 3pm tomorrow\"  (with  being replacement characters)\n</code>\n\nThe current workaround strips these characters, resulting in:\n<code>Result: \"Hey, lets meet at 3pm tomorrow\"  (apostrophe LOST)\n</code>\n\nThis is a **data integrity violation** - the audit tool is silently dropping message content.\n\n<strong>Root Cause Analysis</strong>\n\nThe corruption occurs in the <code>attributedBody</code> binary data parsing:\n\n1. **Location**: <code>electron/services/macOSMessagesImportService.ts</code> and/or <code>electron/utils/messageParser.ts</code>\n\n2. **Technical issue**: <code>buffer.toString(\"utf8\")</code> encounters bytes that aren't valid UTF-8\n\n3. **The <code>attributedBody</code> field**:\n   - Contains <code>NSAttributedString</code> serialized in Apple's typedstream format\n   - The typedstream format may contain:\n     - UTF-16 encoded strings (Little Endian or Big Endian)\n     - Latin-1 (ISO-8859-1) encoded strings\n     - Mixed encodings within the same blob\n   - The <code>imessage-parser</code> library may not handle all encoding variants\n\n4. **Why corruption appears**:\n   - Binary data is being interpreted as UTF-8 when it's actually UTF-16 or another encoding\n   - Non-ASCII characters (accented letters, apostrophes, emoji) are most affected\n   - The U+FFFD character is the Unicode \"replacement character\" for invalid sequences\n\n<strong>Technical Investigation Required</strong>\n\n<strong>Step 1: Identify Affected Messages</strong>\n<code>-- Find messages with potential encoding issues\nSELECT\n  m.ROWID,\n  m.text,\n  hex(m.attributedBody) as attributed_hex,\n  length(m.attributedBody) as body_length\nFROM message m\nWHERE m.attributedBody IS NOT NULL\n  AND m.text IS NULL\nLIMIT 100;\n</code>\n\n<strong>Step 2: Analyze Binary Format</strong>\n<code>// Debug function to inspect attributedBody encoding\nfunction analyzeAttributedBody(buffer: Buffer): void {\n  // Check for UTF-16 BOM markers\n  const bom = buffer.slice(0, 2);\n  if (bom[0] === 0xFF && bom[1] === 0xFE) console.log('UTF-16 LE BOM detected');\n  if (bom[0] === 0xFE && bom[1] === 0xFF) console.log('UTF-16 BE BOM detected');\n\n  // Check for typedstream magic bytes\n  const magic = buffer.slice(0, 4).toString('hex');\n  console.log('Magic bytes:', magic);\n\n  // Look for string markers in typedstream\n  // NSString typically has specific byte patterns\n}\n</code>\n\n<strong>Step 3: Test Multiple Decodings</strong>\n<code>function tryAllDecodings(buffer: Buffer): string[] {\n  const results: string[] = [];\n  const encodings = ['utf8', 'utf16le', 'utf16be', 'latin1', 'ascii'];\n\n  for (const encoding of encodings) {\n    try {\n      const decoded = buffer.toString(encoding as BufferEncoding);\n      // Check if result has replacement characters\n      if (!decoded.includes('\\uFFFD')) {\n        results.push(<code>${encoding}: ${decoded}</code>);\n      }\n    } catch (e) {\n      // Encoding not supported\n    }\n  }\n  return results;\n}\n</code>\n\n<strong>Files Involved</strong>\n\n| File | Purpose |\n|------|---------|\n| <code>electron/services/macOSMessagesImportService.ts</code> | Main import service |\n| <code>electron/utils/messageParser.ts</code> | Parses attributedBody blobs |\n| <code>imessage-parser</code> (npm package) | Third-party parsing library |\n\n<strong>Proposed Solution</strong>\n\n<strong>Option A: Enhanced Multi-Encoding Parser</strong>\n\n<code>function parseAttributedBody(buffer: Buffer): string {\n  // 1. Try UTF-8 first\n  let text = buffer.toString('utf8');\n  if (!containsReplacementChars(text)) return text;\n\n  // 2. Try UTF-16 LE (common on macOS)\n  text = buffer.toString('utf16le');\n  if (!containsReplacementChars(text)) return extractTextFromTypedstream(text);\n\n  // 3. Try UTF-16 BE\n  text = buffer.toString('utf16be');\n  if (!containsReplacementChars(text)) return extractTextFromTypedstream(text);\n\n  // 4. Try Latin-1 as fallback\n  text = buffer.toString('latin1');\n\n  // 5. If still corrupted, use iconv-lite for more encodings\n  return extractTextFromTypedstream(text);\n}\n\nfunction containsReplacementChars(text: string): boolean {\n  return text.includes('\\uFFFD');\n}\n</code>\n\n<strong>Option B: Proper Typedstream Parser</strong>\n\nThe typedstream format has a specific structure. A proper parser would:\n1. Read the typedstream header\n2. Identify object types (NSString, NSMutableString, etc.)\n3. Extract string data with correct encoding based on metadata\n4. Handle nested attributed strings\n\nReference: https://github.com/nickshanks/Typedstream\n\n<strong>Option C: Hybrid Approach (Recommended)</strong>\n\n1. Use existing <code>imessage-parser</code> as primary\n2. If result contains U+FFFD, fall back to multi-encoding attempts\n3. Log problematic messages for manual review\n4. Never silently drop content\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Messages with non-ASCII characters (apostrophes, accents, emoji) are correctly imported\n\u2610 NO message content is silently dropped or corrupted\n\u2610 Previously corrupted messages can be recovered via re-import\n\u2610 Unit tests cover multiple encoding scenarios\n\u2610 Integration test with real corrupted message samples\n\u2610 Logging identifies any messages that couldn't be fully decoded\n\u2610 Re-import with \"Force Reimport\" recovers previously corrupted messages\n\n<strong>Test Cases Required</strong>\n\n1. **UTF-8 with special characters**: \"Let's meet at caf for rsum review\"\n2. **Emoji content**: \"Great job! \"\n3. **Non-Latin scripts**: \"\" (Chinese), \"\" (Japanese), \"\" (Korean)\n4. **Mixed content**: \"Meeting at 3pm  - \"\n5. **Smart quotes**: \"\"Hello\" and 'World'\"\n6. **Currency symbols**: \"Price: 100, $50, 30\"\n\n<strong>Estimated Tokens</strong>\n\n~50,000-80,000 (complex investigation + multi-encoding implementation + extensive testing)\n\n<strong>Risk Assessment</strong>\n\n| Risk | Impact | Mitigation |\n|------|--------|------------|\n| Breaking existing imports | High | Extensive regression testing |\n| Performance degradation | Medium | Only fall back when needed |\n| Incomplete fix | High | Log unrecoverable messages |\n| Third-party library limitations | Medium | May need to fork/patch imessage-parser |\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-201: \"00\" prefix appearing before iMessage text (different issue - display layer)\n\u2022 BACKLOG-203: Add Comprehensive Tests for macOSMessagesImportService\n\u2022 BACKLOG-206: UI Freezing During iMessage Sync/Import\n\n<strong>Notes</strong>\n\n**This is a CRITICAL data integrity issue.** A compliance/audit tool that silently loses message content is worse than useless - it gives users false confidence that their data is complete when it is not.\n\nThe fix must guarantee that:\n1. All text content is preserved\n2. Users are notified if any content couldn't be decoded\n3. Re-import can recover previously corrupted messages\n\n**DO NOT** simply strip replacement characters as a \"fix\" - this loses data."
  },
  {
    "id": "BACKLOG-210",
    "title": "Contacts Not Pre-Populating in Edit Transaction",
    "category": "fix",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-033",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-210.md](BACKLOG-210.md)",
    "created_at": "2026-01-12",
    "completed_at": "",
    "file": "",
    "description": "<strong>Description</strong>\n\nWhen editing an existing transaction, the contact assignments are NOT pre-populating in the edit form. This is the same issue as BACKLOG-171/TASK-995, but the fix (PR #357) did not fully resolve the problem.\n\n**What works:**\n\u2022 Transaction details (address, type, dates) correctly pre-fill\n\u2022 The edit form renders correctly\n\n**What does NOT work:**\n\u2022 Contact assignments do NOT appear when editing a transaction\n\u2022 User must re-select all contacts even though they exist in the database\n\n<strong>Previous Fix Attempt</strong>\n\n**TASK-995 / PR #357** (merged 2026-01-09) changed role priority:\n<code>// Before\nconst role = assignment.specific_role || assignment.role;\n// After\nconst role = assignment.role || assignment.specific_role;\n</code>\n\nThis fix was intended to align with AUDIT_WORKFLOW_STEPS constants but did not resolve the issue.\n\n<strong>Investigation Areas</strong>\n\n1. **Database data** - Check if <code>role</code> field is populated in <code>transaction_contacts</code> table\n2. **Role value mismatch** - Compare saved role values vs AUDIT_WORKFLOW_STEPS keys\n3. **API response** - Verify <code>getTransactionDetails</code> returns <code>contact_assignments</code> with data\n4. **UI grouping logic** - Verify <code>loadContactAssignments()</code> correctly groups and sets state\n\n<strong>Files to Investigate</strong>\n\n| File | Purpose |\n|------|---------|\n| <code>src/components/transaction/components/EditTransactionModal.tsx</code> | Edit modal with <code>loadContactAssignments()</code> |\n| <code>electron/services/transactionService.ts:1082</code> | <code>getTransactionDetails()</code> |\n| <code>electron/services/db/transactionContactDbService.ts:158</code> | <code>getTransactionContactsWithRoles()</code> |\n| Database: <code>transaction_contacts</code> table | Check actual stored data |\n\n<strong>Debug Steps</strong>\n\n1. Add console.log in <code>loadContactAssignments()</code> to see API response\n2. Check database directly for a transaction's contact assignments\n3. Verify role values in database match AUDIT_WORKFLOW_STEPS keys\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 When editing a transaction, existing contacts appear in their assigned roles\n\u2610 All role types populate correctly (buyer, seller, agents, lender, title, etc.)\n\u2610 Modifying and saving contacts works correctly\n\u2610 No regression in new transaction creation\n\n<strong>Related</strong>\n\n\u2022 **BACKLOG-171**: Original issue report\n\u2022 **TASK-995**: First fix attempt (incomplete)\n\u2022 **PR #357**: Merged fix that didn't fully resolve the issue"
  },
  {
    "id": "BACKLOG-211",
    "title": "Email Onboarding State Mismatch",
    "category": "fix",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-049",
    "est_tokens": "~35K",
    "actual_tokens": "~184K",
    "variance": "[BACKLOG-211.md](BACKLOG-211.md)",
    "created_at": "2026-01-13",
    "completed_at": "",
    "file": "",
    "description": "<strong>Problem</strong>\n\nWhen a user has a valid mailbox token but the <code>email_onboarding_completed</code> database flag is <code>false</code>, the app shows confusing/incorrect UI:\n\n1. **Dashboard shows \"All Caught Up\"** - AIStatusCard displays this when <code>pendingCount === 0</code>, but doesn't account for whether mailbox is actually connected\n2. **Settings shows \"Connected\"** - Because <code>connectionStatusService</code> finds the valid mailbox token\n3. **Backend says onboarding incomplete** - Because <code>handleCheckEmailOnboarding</code> only checks for tokens IF the flag is already true\n\n<strong>Impact</strong>\n\n\u2022 **User Experience**: Users are confused by contradictory UI states - Settings says connected but Dashboard shows no activity\n\u2022 **Data Integrity**: No emails are being scanned despite having valid credentials\n\u2022 **Priority**: High (critical UX bug that leaves users confused about app state)\n\n<strong>Root Cause</strong>\n\nIn <code>electron/handlers/sessionHandlers.ts</code> line ~289:\n<code>if (onboardingCompleted) {  // <-- Only checks for token IF this flag is true\n  const googleToken = await databaseService.getOAuthToken(...);\n</code>\n\nThis creates a state where:\n1. User connected mailbox and token was saved\n2. But <code>email_onboarding_completed</code> flag was not set (race condition, error, or flow issue)\n3. App thinks onboarding is incomplete, so it doesn't scan for emails\n4. User sees \"All Caught Up\" with no indication they need to reconnect\n\n<strong>Expected Behavior</strong>\n\n1. If mailbox token exists, consider email onboarding complete (regardless of flag)\n2. Dashboard should show \"Connect your email\" prompt when no valid mailbox token\n3. \"All Caught Up\" should only show when mailbox IS connected AND no pending transactions\n\n<strong>Affected Files</strong>\n\n| File | Purpose |\n|------|---------|\n| <code>electron/handlers/sessionHandlers.ts</code> | <code>handleCheckEmailOnboarding</code> logic - needs to check token existence regardless of flag |\n| <code>src/components/dashboard/AIStatusCard.tsx</code> | Needs mailbox status awareness to show appropriate prompt |\n| <code>src/components/Dashboard.tsx</code> | May need to pass mailbox status to AIStatusCard |\n\n<strong>Investigation Areas</strong>\n\n1. **<code>handleCheckEmailOnboarding</code> logic** - Why does it only check token IF flag is true?\n2. **When is <code>email_onboarding_completed</code> set?** - Find all places that update this flag\n3. **Race condition analysis** - Is there a timing issue where token is saved but flag update fails?\n4. **AIStatusCard logic** - How can it determine mailbox connection status?\n\n<strong>Proposed Solution</strong>\n\n<strong>Option A: Backend-First (Recommended)</strong>\n1. Modify <code>handleCheckEmailOnboarding</code> to check for valid token regardless of flag\n2. If token exists and is valid, return <code>completed: true</code> and also update the flag for consistency\n3. AIStatusCard already shows pending count - if backend reports connected and pending=0, \"All Caught Up\" is correct\n\n<strong>Option B: Frontend-Aware</strong>\n1. Add mailbox connection status to Dashboard state\n2. Pass to AIStatusCard\n3. Show \"Connect your email\" if not connected, \"All Caught Up\" only if connected + pending=0\n\n<strong>Option C: Hybrid (Most Robust)</strong>\n1. Backend fix (Option A)\n2. Plus add explicit \"no mailbox connected\" state to AIStatusCard for defensive UX\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>handleCheckEmailOnboarding</code> returns <code>completed: true</code> if valid mailbox token exists (regardless of flag)\n\u2610 If no valid mailbox token exists, Dashboard shows appropriate prompt (not \"All Caught Up\")\n\u2610 \"All Caught Up\" only displays when mailbox is connected AND no pending items\n\u2610 Settings and Dashboard states are consistent\n\u2610 Add test coverage for edge cases:\n  - Token exists, flag false -> should return completed: true\n  - Token expired, flag true -> should handle gracefully\n  - No token, flag false -> should return completed: false\n\n<strong>Estimation</strong>\n\n\u2022 **Category**: service/ui (hybrid)\n\u2022 **Complexity**: Medium - involves backend logic change + potential UI update\n\u2022 **Estimated Tokens**: ~35K\n\u2022 **Files to modify**: 2-3\n\n<strong>Related</strong>\n\n\u2022 <code>electron/services/connectionStatusService.ts</code> - How connection status is determined\n\u2022 <code>src/components/settings/SettingsScreen.tsx</code> - Where \"Connected\" status is shown\n\u2022 BACKLOG-139 (Database Init Gate) - Similar state coordination issue pattern\n\n<strong>Notes</strong>\n\n\u2022 Discovered: 2026-01-12\n\u2022 Reporter: Testing feedback\n\u2022 Category: Bug Fix\n\u2022 Status: Pending"
  },
  {
    "id": "BACKLOG-212",
    "title": "Settings Popup Not Scrollable",
    "category": "fix",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-034",
    "est_tokens": "~40K",
    "actual_tokens": "~219K",
    "variance": "[BACKLOG-212.md](BACKLOG-212.md)",
    "created_at": "2026-01-13",
    "completed_at": "",
    "file": "",
    "description": "**Status**: OPEN - Requires deeper investigation\n**Priority**: CRITICAL - Blocks access to Force Re-import feature\n\n<strong>Problem</strong>\n\nThe Settings popup/modal is not scrollable, which prevents users from accessing features at the bottom of the settings panel (like \"Force Re-import\").\n\n<strong>Impact</strong>\n\n\u2022 **CRITICAL**: Users cannot access important features like force re-import\n\u2022 Blocks testing and recovery workflows\n\u2022 May affect other settings that are below the fold\n\u2022 **Priority**: CRITICAL - Blocks access to critical features\n\n<strong>Failed Fix Attempts</strong>\n\n<strong>Attempt 1: TASK-1034 / PR #410 - Remove overflow-hidden</strong>\n\n**Hypothesis**: The <code>overflow-hidden</code> on the parent wrapper (line 249) was clipping the scrollable content.\n\n**Change Made**: Removed <code>overflow-hidden</code> from the content wrapper div.\n\n**Result**: DID NOT FIX the issue. Scrolling still not working.\n\n<strong>Attempt 2: PR #411 - Nested div structure fix</strong>\n\n**Hypothesis**: The nested div structure was preventing proper height calculation for scroll.\n\n**Change Made**: Restructured the nested divs to simplify the scroll container.\n\n**Result**: DID NOT FIX the issue. Scrolling still not working.\n\n<strong>Root Cause: UNKNOWN</strong>\n\nSimple CSS fixes have not resolved the issue. The problem requires deeper investigation of:\n\u2022 Full component hierarchy (Settings.tsx and its parent modal wrapper)\n\u2022 Modal rendering context (portal? overlay?)\n\u2022 Electron-specific CSS rendering behavior\n\u2022 Interaction between flexbox, height constraints, and overflow\n\u2022 Possible JavaScript/React state affecting render\n\n<strong>Expected Behavior</strong>\n\nSettings popup should be scrollable when content exceeds viewport height. Users should be able to scroll to see and interact with all settings options regardless of their screen size.\n\n<strong>Current Implementation Analysis</strong>\n\nThe Settings component (<code>src/components/Settings.tsx</code>) has the following structure:\n\n<code>// Line 223-224: Outer modal container\n<div className=\"bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col overflow-hidden\">\n\n// Line 249: Content wrapper\n<div className=\"flex-1 min-h-0 overflow-hidden px-2\">\n\n// Line 250: Intended scrollable area\n<div className=\"h-full overflow-y-auto px-4 py-6\">\n</code>\n\nThe CSS properties appear correct (<code>overflow-y-auto</code>, <code>max-h-[90vh]</code>, <code>flex-col</code>), but scrolling is not working in practice. Possible causes:\n\n1. **<code>overflow-hidden</code> conflict** - The parent wrapper on line 249 has <code>overflow-hidden</code> which may be clipping the scrollable content\n2. **Height calculation issue** - The <code>h-full</code> may not be computing correctly in the flex context\n3. **Content not exceeding container** - Settings content may need explicit min-height or the container needs constraints\n4. **Browser/Electron rendering issue** - May need explicit height rather than flex-based sizing\n\n<strong>Affected Files</strong>\n\n| File | Purpose |\n|------|---------|\n| <code>src/components/Settings.tsx</code> | Main settings component - modal structure and scroll container |\n\n<strong>Proposed Solution - Next Steps</strong>\n\n**NOTE**: Options A and C below were attempted and did NOT work. Deeper investigation required.\n\n<strong>FAILED: Option A - Fix overflow cascade (Attempted in PR #410)</strong>\n\n~~Remove <code>overflow-hidden</code> from the wrapper~~ - **Did not fix the issue**\n\n<strong>FAILED: Option C - Simplify structure (Attempted in PR #411)</strong>\n\n~~Collapse the nested divs~~ - **Did not fix the issue**\n\n<strong>Option B: Explicit height calculation (Not yet attempted)</strong>\n\nUse calc() or explicit viewport-based heights:\n\n<code><div className=\"flex-1 min-h-0 overflow-y-auto px-4 py-6\" style={{ maxHeight: 'calc(90vh - 120px)' }}>\n</code>\n\n<strong>NEW: Option D - Deep investigation required</strong>\n\n1. **Investigate full render tree**: Use browser DevTools to trace the full CSS cascade from Settings.tsx up to the root\n2. **Check modal wrapper**: Settings may be rendered inside a portal or overlay that has its own constraints\n3. **Electron-specific debugging**: Test if issue reproduces in regular browser vs Electron\n4. **Height computation tracing**: Log computed heights at each level of the hierarchy\n5. **Check for conflicting styles**: Global CSS resets or Tailwind preflight may be interfering\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Settings modal is scrollable on all screen sizes\n\u2610 All settings sections are accessible (General, Email Connections, Export, AI Settings, Data & Privacy, About)\n\u2610 \"Force Re-import\" and any other bottom features are reachable\n\u2610 Header and Footer remain fixed/visible during scroll\n\u2610 Scroll behavior works in Electron app (not just browser dev)\n\u2610 No visual regression to modal appearance\n\u2610 Test on minimum supported screen height (e.g., 768px)\n\n<strong>Estimation</strong>\n\n\u2022 **Category**: ui / investigation\n\u2022 **Complexity**: Medium-High - Simple CSS fixes failed, requires investigation\n\u2022 **Estimated Tokens**: ~25K-40K (increased due to investigation needed)\n\u2022 **Files to modify**: Unknown until root cause identified\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-043 (existing stub for same issue - Medium priority, can be marked obsolete)\n\u2022 <code>src/components/Settings.tsx</code> - Primary file to modify\n\u2022 PR #410 - Failed fix attempt 1 (overflow-hidden removal)\n\u2022 PR #411 - Failed fix attempt 2 (nested div restructure)\n\u2022 TASK-1034 - Original task for this fix (incomplete)\n\n<strong>Notes</strong>\n\n\u2022 Discovered: 2026-01-12\n\u2022 Reporter: User feedback\n\u2022 Category: Bug Fix / Investigation\n\u2022 Priority: **CRITICAL** (blocks access to Force Re-import)\n\u2022 Status: **OPEN - Requires deeper investigation**\n\n<strong>Fix Attempt History</strong>\n\n| Date | PR | Approach | Result |\n|------|-----|----------|--------|\n| 2026-01-12 | #410 | Remove overflow-hidden from wrapper | FAILED |\n| 2026-01-12 | #411 | Restructure nested divs | FAILED |\n\n<strong>Next Sprint Action</strong>\n\nThis item should be prioritized in the next sprint with:\n1. **Investigation phase first** - Before writing any code, fully trace the CSS/DOM hierarchy\n2. **Time-boxed exploration** - Allocate tokens for investigation vs implementation\n3. **Possible pairing** - May benefit from human debugging in DevTools\n\n<strong>Technical Context</strong>\n\nThe Settings component uses a flexbox modal layout:\n\u2022 Fixed header (gradient with title + close button)\n\u2022 Flexible content area (should scroll)\n\u2022 Fixed footer (Done button)\n\nThe flexbox pattern is correct in principle (<code>flex-col</code> + <code>flex-1</code> + <code>min-h-0</code>), but the extra wrapper div with <code>overflow-hidden</code> may be preventing the scroll behavior from working properly."
  },
  {
    "id": "BACKLOG-213",
    "title": "Recurring Check Permissions Screen Bug",
    "category": "fix",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "[BACKLOG-213.md](BACKLOG-213.md)",
    "created_at": "2026-01-13",
    "completed_at": "",
    "file": "",
    "description": "<strong>Resolution</strong>\n\n**Task:** TASK-1033\n**PR:** #409\n**Fix:** Added <code>hasPermissions</code> field to <code>OnboardingState</code> and updated <code>selectHasPermissions()</code> to read from it.\n\n**Note:** This fix was implemented directly without following the proper workflow (no task file, no engineer agent, no metrics capture). See TASK-1033 for process violation documentation.\n\n---\n\n<strong>Problem Statement</strong>\n\nUsers are repeatedly getting stuck on the \"Check Permissions\" (Full Disk Access) screen on macOS, even when they have already granted permissions. This is the THIRD reported occurrence of this bug, indicating the previous fixes were incomplete or have regressed.\n\n---\n\n<strong>Root Cause Analysis</strong>\n\n<strong>The Bug Flow</strong>\n\n1. User launches app (returning user with FDA already granted)\n2. <code>LoadingOrchestrator</code> loads user data including permissions check\n3. <code>selectHasPermissions(state)</code> returns <code>false</code> during <code>onboarding</code> status\n4. <code>OnboardingFlow</code> sees <code>hasPermissions: false</code> in appState\n5. <code>PermissionsStep.shouldShow(context)</code> returns <code>true</code> (because <code>!context.permissionsGranted</code>)\n6. User sees permissions screen despite having already granted FDA\n\n<strong>Technical Root Cause: Selector Returns False During Onboarding</strong>\n\n**File:** <code>src/appCore/state/machine/selectors/userDataSelectors.ts</code> (lines 186-195)\n\n<code>export function selectHasPermissions(state: AppState): boolean {\n  if (state.status === \"ready\") {\n    return state.userData.hasPermissions;\n  }\n  if (state.status === \"onboarding\") {\n    // During onboarding, permissions check happens at the permissions step\n    return false;  // <-- BUG: Always returns false during onboarding!\n  }\n  return false;\n}\n</code>\n\n**The problem:** The selector ALWAYS returns <code>false</code> during onboarding status, regardless of whether the user actually has FDA granted. This is wrong for returning users who:\n\u2022 Already completed onboarding previously\n\u2022 Already have FDA granted\n\u2022 Are being routed through onboarding due to other incomplete steps (e.g., email not connected)\n\n<strong>Why Previous Fixes Didn't Work</strong>\n\nThe previous fixes addressed symptoms, not the root cause:\n\n| Fix | What It Did | Why It Didn't Work |\n|-----|-------------|-------------------|\n| TASK-950 | Derive appState from state machine | Still uses <code>selectHasPermissions</code> which returns false |\n| TASK-110 | Extract PermissionsStep with <code>shouldShow</code> | <code>shouldShow</code> relies on <code>permissionsGranted</code> which comes from the broken selector |\n| Various onboarding fixes | Skip steps for returning users | Only works if state machine says permissions are granted |\n\n<strong>The State Machine Gap</strong>\n\nThe <code>OnboardingState</code> type does NOT track permissions status:\n\n<code>interface OnboardingState {\n  status: \"onboarding\";\n  step: OnboardingStep;\n  user: User;\n  platform: PlatformInfo;\n  completedSteps: OnboardingStep[];\n  hasEmailConnected?: boolean;  // <-- Email status tracked\n  // hasPermissions?: boolean;   // <-- Permissions NOT tracked!\n}\n</code>\n\nOnly <code>ReadyState</code> has <code>userData.hasPermissions</code>. During onboarding, the actual permissions status is lost.\n\n---\n\n<strong>Evidence from Code</strong>\n\n<strong>LoadingOrchestrator does check permissions (lines 302-308):</strong>\n\n<code>// Check permissions (macOS only)\nplatform.isMacOS\n  ? window.api.system.checkPermissions().catch(() => ({\n      hasPermission: false,\n      fullDiskAccess: false,\n    }))\n  : Promise.resolve({ hasPermission: true, fullDiskAccess: true }),\n</code>\n\n<strong>But this data is only used in USER_DATA_LOADED dispatch:</strong>\n\nThe permissions status goes into <code>UserData</code>, which is only accessible in <code>ready</code> state, not <code>onboarding</code> state.\n\n---\n\n<strong>Regression Pattern</strong>\n\n| Date | Issue | \"Fix\" Applied | Regression Cause |\n|------|-------|---------------|------------------|\n| ~2025-12 | First occurrence | Various onboarding fixes | Incomplete state handling |\n| ~2026-01 | Second occurrence | TASK-950 state derivation | Selector design flaw |\n| 2026-01-12 | Third occurrence | (this report) | Same underlying issue |\n\n---\n\n<strong>Proposed Solution</strong>\n\n<strong>Option A: Track hasPermissions in OnboardingState (Recommended)</strong>\n\n1. Add <code>hasPermissions</code> field to <code>OnboardingState</code> type\n2. Populate it during <code>USER_DATA_LOADED</code> action when transitioning to onboarding\n3. Update <code>selectHasPermissions</code> to read from <code>OnboardingState.hasPermissions</code>\n\n**Pros:**\n\u2022 Clean, type-safe solution\n\u2022 Follows existing pattern (like <code>hasEmailConnected</code>)\n\u2022 Single source of truth\n\n**Cons:**\n\u2022 Requires state machine type changes\n\u2022 Requires reducer changes\n\n<strong>Option B: Skip Permissions Step If User Loaded With FDA</strong>\n\n1. Pass the actual permissions result through to onboarding context\n2. Bypass the selector for returning users\n3. Add <code>permissionsFromLoad?: boolean</code> to onboarding context\n\n**Pros:**\n\u2022 Simpler change\n\u2022 Doesn't modify state machine types\n\n**Cons:**\n\u2022 Another special case / workaround\n\u2022 Not as clean\n\n<strong>Option C: Check Permissions Directly in shouldShow</strong>\n\n1. Make <code>PermissionsStep.shouldShow</code> call <code>window.api.system.checkPermissions()</code> directly\n2. Cache the result to avoid repeated API calls\n\n**Pros:**\n\u2022 Always gets fresh permission status\n\u2022 No state machine changes\n\n**Cons:**\n\u2022 Async in a sync predicate (needs redesign)\n\u2022 Violates current architecture\n\u2022 Band-aid fix\n\n---\n\n<strong>Recommended Fix: Option A</strong>\n\n<code>// 1. Update OnboardingState in types.ts\nexport interface OnboardingState {\n  status: \"onboarding\";\n  step: OnboardingStep;\n  user: User;\n  platform: PlatformInfo;\n  completedSteps: OnboardingStep[];\n  hasEmailConnected?: boolean;\n  hasPermissions: boolean;  // ADD THIS\n}\n\n// 2. Update USER_DATA_LOADED in reducer.ts\n// When transitioning to onboarding, include hasPermissions\n\n// 3. Update selectHasPermissions in userDataSelectors.ts\nexport function selectHasPermissions(state: AppState): boolean {\n  if (state.status === \"ready\") {\n    return state.userData.hasPermissions;\n  }\n  if (state.status === \"onboarding\") {\n    return state.hasPermissions;  // READ FROM STATE, not hardcoded false\n  }\n  return false;\n}\n</code>\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Returning users with FDA granted do NOT see permissions screen\n\u2610 New users without FDA DO see permissions screen\n\u2610 Permissions status is correctly tracked through onboarding\n\u2610 All existing onboarding tests pass\n\u2610 Add regression test: returning user with FDA skips permissions step\n\u2610 No regressions in new user onboarding flow\n\n---\n\n<strong>Testing Requirements</strong>\n\n<strong>Manual Test Cases</strong>\n\n1. **Returning user with FDA**: Login -> should go to dashboard (not permissions)\n2. **Returning user without FDA**: Login -> should see permissions screen\n3. **New user**: Full onboarding flow including permissions\n4. **App restart**: After granting FDA, restart should not show permissions\n\n<strong>Automated Test Cases</strong>\n\n1. <code>selectHasPermissions</code> returns true when <code>OnboardingState.hasPermissions</code> is true\n2. <code>PermissionsStep.shouldShow</code> returns false when permissions already granted\n3. Integration test: Returning user with FDA goes to dashboard\n\n---\n\n<strong>Related Items</strong>\n\n| ID | Title | Relationship |\n|----|-------|-------------|\n| BACKLOG-142 | State Coordination Overhaul | Root initiative |\n| BACKLOG-144 | UI Flicker for Returning Users | Related symptom |\n| TASK-950 | Fix OnboardingFlow State Derivation | Previous incomplete fix |\n| TASK-110 | Extract PermissionsStep | Created shouldShow but relies on broken selector |\n\n---\n\n<strong>Sprint Recommendation</strong>\n\n**This should be the TOP priority for the next sprint.**\n\nGiven that this is the THIRD occurrence of this user-facing bug:\n1. Create a dedicated stability sprint (SPRINT-034?)\n2. Make this the first task\n3. Include regression tests to prevent future occurrences\n4. Consider adding monitoring/logging for permissions state transitions\n\n---\n\n<strong>Estimated Effort</strong>\n\n**Category:** fix\n**Estimated Tokens:** ~50K\n**Token Cap:** 200K\n\nBreakdown:\n\u2022 Type changes: ~5K\n\u2022 Reducer changes: ~15K\n\u2022 Selector changes: ~5K\n\u2022 Tests: ~20K\n\u2022 Integration testing: ~5K\n\n---\n\n<strong>Changelog</strong>\n\n\u2022 2026-01-12: Created (third occurrence of this bug)"
  },
  {
    "id": "BACKLOG-214",
    "title": "Auto-Link Communications Not Working (TASK-1031 Regression)",
    "category": "fix",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-034",
    "est_tokens": "~30K",
    "actual_tokens": "~463K",
    "variance": "[BACKLOG-214.md](BACKLOG-214.md)",
    "created_at": "2026-01-13",
    "completed_at": "",
    "file": "",
    "description": "<strong>Problem Statement</strong>\n\nUser reports that after adding contacts to a transaction, communications (emails and text messages) are NOT automatically linked. The user still has to manually attach chats to the transaction.\n\nThis is a potential regression or incomplete implementation of TASK-1031 which was supposed to implement this exact functionality.\n\n---\n\n<strong>Symptoms</strong>\n\n\u2022 Add contact to transaction\n\u2022 Expected: Related emails and iMessages should auto-link\n\u2022 Actual: No communications are linked\n\u2022 User must manually go to Messages tab and attach chats\n\n---\n\n<strong>Investigation Required</strong>\n\n<strong>1. Verify Implementation</strong>\n\nCheck if auto-link code is actually being called:\n\n<code>// transactionService.ts - assignContactToTransaction\n// Should call autoLinkCommunicationsForContact() after contact save\n</code>\n\n<strong>2. Check for Silent Failures</strong>\n\nThe auto-link may be running but silently failing. Check:\n\u2022 Are there matching communications to link?\n\u2022 Is the date range filter too restrictive?\n\u2022 Are there errors in the main process logs?\n\n<strong>3. Test Scenarios</strong>\n\n| Scenario | Expected | Actual |\n|----------|----------|--------|\n| Add contact with email | Emails linked | ? |\n| Add contact with phone | Messages linked | ? |\n| Add contact with both | Both linked | ? |\n| Contact with no communications | Nothing linked (not an error) | ? |\n\n<strong>4. Compare Against TASK-1031 PR</strong>\n\nReview PR #407 changes to ensure implementation matches requirements:\n\u2022 <code>feature/task-1031-auto-link-communications</code> branch\n\u2022 Files: transactionService.ts, transactionDbService.ts, etc.\n\n---\n\n<strong>Potential Root Causes</strong>\n\n| Cause | Likelihood | Investigation |\n|-------|------------|---------------|\n| Auto-link not wired up at call site | Medium | Check assignContactToTransaction() |\n| Query returns no results (date range) | Medium | Log query results |\n| Phone number format mismatch | High | +1, spaces, dashes normalization |\n| Email case sensitivity | Medium | Lowercase comparison |\n| Error swallowed in try/catch | Medium | Add error logging |\n| IPC handler not returning results | Low | Check renderer callback |\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 When contact is added to transaction, related emails auto-link\n\u2610 When contact is added to transaction, related iMessages auto-link\n\u2610 User notification shows count of linked communications\n\u2610 Works for contacts with multiple email addresses\n\u2610 Works for contacts with multiple phone numbers\n\u2610 Root cause documented\n\n---\n\n<strong>Related Items</strong>\n\n| ID | Title | Relationship |\n|----|-------|-------------|\n| BACKLOG-207 | Auto-link communications | Original feature request |\n| TASK-1031 | Implement auto-link | Merged implementation (may have regression) |\n| PR #407 | feat(auto-link) | Merged PR to review |\n\n---\n\n<strong>Estimated Effort</strong>\n\n**Category:** fix/regression\n**Estimated Tokens:** ~30K (investigation + fix)\n**Token Cap:** 120K\n\n---\n\n<strong>Changelog</strong>\n\n\u2022 2026-01-12: Created from user testing feedback"
  },
  {
    "id": "BACKLOG-215",
    "title": "Encoding Corruption in Group Chats (Binary Plist Fix)",
    "category": "fix",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-034",
    "est_tokens": "~50K",
    "actual_tokens": "~432K",
    "variance": "[BACKLOG-215.md](BACKLOG-215.md)",
    "created_at": "2026-01-13",
    "completed_at": "",
    "file": "",
    "description": "<strong>Problem Statement</strong>\n\n**CRITICAL:** All iMessage chats display corrupted/garbled characters that appear to be binary data displayed as text. This is NOT limited to group chats - the corruption affects ALL messages.\n\n<code>Example corrupted text:\n\u8601\u5fa0\u0f10\u534e\u654b\u6579\u4164\u6372\u6968\u6576\ud272\u0908\u0b0a\u7657\u7265\u6973\u6e6f\n</code>\n\n**Note:** TASK-1028 (PR #404) was intended to fix iMessage encoding issues but the corruption is still happening. Either:\n1. The fix was not effective\n2. There is a different/additional encoding issue not addressed by TASK-1028\n3. The fix only partially addressed the problem\n\nThis requires urgent re-investigation of the iMessage parsing logic.\n\n---\n\n<strong>Symptoms</strong>\n\n\u2022 **ALL** iMessage chats show corrupted characters (not just group chats)\n\u2022 Messages display CJK characters mixed with symbols\n\u2022 These are clearly NOT intentional text (random unicode codepoints)\n\u2022 The pattern <code>\u8601\u5fa0\u0f10\u534e\u654b\u6579</code> suggests UTF-16 bytes being read as UTF-8 or binary/serialized data\n\u2022 Affects both 1:1 conversations AND group chats\n\n---\n\n<strong>ROOT CAUSE IDENTIFIED</strong>\n\n**Reference:** https://fatbobman.com/en/posts/deep-dive-into-imessage/\n\n<strong>The Actual Problem</strong>\n\niMessage stores messages in **two fields**:\n\n| Field | Format | Purpose |\n|-------|--------|---------|\n| <code>message.text</code> | Plain text (simple string) | Simple messages without formatting |\n| <code>message.attributedBody</code> | **Binary plist format** (NSAttributedString) | Rich text with formatting, links, mentions |\n\n**The corrupted characters (<code>\u8601\u5fa0\u0f10\u534e\u654b\u6579</code>) are raw binary plist data being displayed directly instead of being properly parsed.**\n\n<strong>Why TASK-1028 Was Wrong</strong>\n\nTASK-1028's multi-encoding fallback addressed the **WRONG problem**:\n\n| What TASK-1028 Did | What Was Actually Needed |\n|--------------------|--------------------------|\n| Tried UTF-8/UTF-16/Latin1 text decoding | Binary plist parsing |\n| Assumed text encoding mismatch | Issue is binary format interpretation |\n| Added encoding fallback chain | Needed format detection + parsing |\n\n**The issue is NOT text encoding (UTF-8 vs UTF-16).** The <code>attributedBody</code> field contains serialized <code>NSAttributedString</code> data in Apple's binary plist format. Treating binary plist as text (regardless of encoding) produces garbled characters.\n\n<strong>Solutions from Article</strong>\n\n**Option 1: Regex extraction (fast but may miss some)**\n<code>// Extract readable characters from binary data\n// Fast but may miss embedded strings\nfunction extractTextFromBinaryPlist(buffer: Buffer): string {\n  const text = buffer.toString('utf-8');\n  // Match sequences of readable characters\n  return text.match(/[\\x20-\\x7E\\u4E00-\\u9FFF]+/g)?.join('') || '';\n}\n</code>\n\n**Option 2: plutil conversion (accurate but slower)**\n<code># Convert binary plist to XML, then extract <string> tags\nplutil -convert xml1 -o - attributedBody.plist | grep '<string>' | sed 's/<[^>]*>//g'\n</code>\n\n**Option 3: Fallback to message.text (recommended first step)**\n<code>// If attributedBody parsing fails, use plain text field\nfunction getMessageText(row: MessageRow): string {\n  if (row.text) {\n    return row.text;  // Simple messages have plain text\n  }\n  if (row.attributedBody) {\n    return parseBinaryPlist(row.attributedBody);  // Rich messages need parsing\n  }\n  return '';\n}\n</code>\n\n<strong>Files to Investigate</strong>\n\n\u2022 **iMessage import service** - Where <code>attributedBody</code> is being read\n\u2022 **Message text extraction** - Check if binary plist parsing exists\n\u2022 **Fallback logic** - Verify if <code>message.text</code> is used when <code>attributedBody</code> fails\n\n---\n\n<strong>Technical Analysis (Original)</strong>\n\n<strong>Likely Cause (SUPERSEDED - see ROOT CAUSE above)</strong>\n\nThe corrupted output pattern suggests one of:\n\n1. ~~**NSArchiver data** - macOS uses NSArchiver for serializing complex objects~~\n2. ~~**typedstream format** - Different variant than what TASK-1028 handles~~\n3. **attributedBody format parsing failure** - Parser not correctly handling format **CONFIRMED**\n4. **Binary blob displayed directly** - Parser returning raw bytes instead of text **CONFIRMED**\n5. ~~**TASK-1028 fix not applied correctly** - Merged but not functioning as expected~~\n\n<strong>Investigation Steps</strong>\n\n1. **Verify TASK-1028 fix is active:**\n   - Check that the encoding fix code is actually being executed\n   - Add logging to confirm which code path is taken\n\n2. **Analyze message format:**\n<code>-- Examine messages with corrupted display\nSELECT m.ROWID, m.text, hex(m.attributedBody) as hex_body,\n       length(m.attributedBody) as body_length\nFROM message m\nWHERE m.attributedBody IS NOT NULL\nLIMIT 10\n</code>\n\n3. **Check byte patterns:**\n<code>// If first bytes are 'bplist' or 'typedstream', needs different parsing\nfunction detectFormat(buffer: Buffer): string {\n  const header = buffer.slice(0, 10).toString('ascii');\n  if (header.startsWith('bplist')) return 'binary-plist';\n  if (header.startsWith('streamtyped')) return 'typedstream';\n  return 'unknown';\n}\n</code>\n\n---\n\n<strong>Relationship to TASK-1028</strong>\n\nTASK-1028 was supposed to fix encoding issues, but corruption persists:\n\n| Aspect | TASK-1028 Expected | Actual Result |\n|--------|-------------------|---------------|\n| Scope | Fix encoding issues | Corruption still present |\n| Character type | U+FFFD replacement | Random CJK/symbols showing |\n| Message type | All messages | All messages STILL affected |\n| Status | Merged (PR #404) | Fix may be ineffective |\n\n**Action Required:** Re-investigate the iMessage parsing logic to determine why TASK-1028 did not resolve the issue.\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 ALL iMessage chats display correctly without garbled characters\n\u2610 Binary data blobs are properly detected and parsed (not displayed raw)\n\u2610 Root cause of TASK-1028 ineffectiveness identified\n\u2610 Corrupted messages can be recovered via Force Reimport\n\u2610 Logging identifies unparseable message formats\n\u2610 Full test suite passes\n\u2610 Manual verification that corruption is resolved in both 1:1 and group chats\n\n---\n\n<strong>Related Items</strong>\n\n| ID | Title | Relationship |\n|----|-------|-------------|\n| BACKLOG-209 | iMessage encoding fix | Original encoding issue |\n| TASK-1028 | Fix U+FFFD encoding | Fix may be ineffective |\n| PR #404 | Encoding fix | Merged but not working |\n\n---\n\n<strong>Estimated Effort</strong>\n\n**Category:** fix/data-integrity\n**Estimated Tokens:** ~75K (investigation of why TASK-1028 failed + new fix)\n**Token Cap:** 300K\n\n---\n\n<strong>Changelog</strong>\n\n\u2022 2026-01-12: Created from user testing feedback\n\u2022 2026-01-12: **ELEVATED TO CRITICAL** - Corruption affects ALL chats, not just group chats. TASK-1028 fix may not have been effective.\n\u2022 2026-01-12: **ROOT CAUSE IDENTIFIED** - Issue is binary plist format in <code>attributedBody</code> field being displayed as raw text. TASK-1028's encoding fallback was addressing wrong problem. Reference: https://fatbobman.com/en/posts/deep-dive-into-imessage/"
  },
  {
    "id": "BACKLOG-216",
    "title": "Edit Contacts Still Not Pre-Populating (TASK-1030 Regression)",
    "category": "fix",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-034",
    "est_tokens": "~25K",
    "actual_tokens": "~386K",
    "variance": "[BACKLOG-216.md](BACKLOG-216.md)",
    "created_at": "2026-01-13",
    "completed_at": "",
    "file": "",
    "description": "<strong>Problem Statement</strong>\n\nWhen clicking \"Edit\" on an existing transaction, the contact assignments do NOT pre-populate in the edit form. Users must re-select all contacts even though they are saved in the database.\n\nThis is a potential regression or incomplete fix from TASK-1030 which was supposed to fix this exact issue.\n\n---\n\n<strong>Symptoms</strong>\n\n1. Create a new transaction with contacts assigned\n2. Save the transaction\n3. Click \"Edit\" on the transaction\n4. Expected: Contact assignments should appear in the form\n5. Actual: Contact fields are empty\n\n---\n\n<strong>History</strong>\n\nThis is the **SECOND** report of this issue:\n\n| Occurrence | Task | PR | Status |\n|------------|------|-----|--------|\n| First | TASK-995 | #357 | Incomplete fix |\n| Second | TASK-1030 | #406 | Merged, but still reported |\n| Third | This report | TBD | Investigation needed |\n\n---\n\n<strong>Investigation Required</strong>\n\n<strong>1. Verify TASK-1030 Fix Is Active</strong>\n\n<code>// Check EditTransactionModal.tsx\n// loadContactAssignments() should be called in useEffect\n// Verify the function exists and runs on mount\n</code>\n\n<strong>2. Check API Response</strong>\n\nAdd logging to verify data is being returned:\n\n<code>const details = await window.api.getTransactionDetails(transactionId);\nconsole.log('contact_assignments:', details.contact_assignments);\n// Should log array of assignments, not empty/undefined\n</code>\n\n<strong>3. Verify Database State</strong>\n\n<code>SELECT tc.*, c.name\nFROM transaction_contacts tc\nJOIN contacts c ON tc.contact_id = c.id\nWHERE tc.transaction_id = '<test_transaction_id>'\n</code>\n\n<strong>4. Check Role Mapping</strong>\n\n<code>// AUDIT_WORKFLOW_STEPS keys must match database role values\nconst expectedRoles = Object.keys(AUDIT_WORKFLOW_STEPS);\nconst actualRole = assignment.role;\nconsole.log('Role match:', expectedRoles.includes(actualRole));\n</code>\n\n---\n\n<strong>Potential Root Causes</strong>\n\n| Cause | Likelihood | Notes |\n|-------|------------|-------|\n| Fix not deployed | Low | PR #406 merged, but check branch |\n| Race condition | Medium | Data loading before component mount |\n| Role key mismatch | Medium | DB values don't match expected keys |\n| API not returning assignments | Medium | Check getTransactionDetails query |\n| UI state not updating | Medium | Check setState after data load |\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 When editing transaction, existing contacts appear in their assigned roles\n\u2610 All role types populate correctly (buyer, seller, agents, etc.)\n\u2610 Modifying and saving contacts works correctly\n\u2610 Root cause documented\n\u2610 No regression in new transaction creation\n\u2610 Full test suite passes\n\n---\n\n<strong>Related Items</strong>\n\n| ID | Title | Relationship |\n|----|-------|-------------|\n| BACKLOG-210 | Contacts not pre-populating | Original issue |\n| TASK-1030 | Fix pre-population | Merged fix (may have regression) |\n| TASK-995 | First fix attempt | Previous incomplete fix |\n| PR #406 | fix(transaction) | Merged PR to review |\n\n---\n\n<strong>Estimated Effort</strong>\n\n**Category:** fix/regression\n**Estimated Tokens:** ~25K (investigation + fix)\n**Token Cap:** 100K\n\n---\n\n<strong>Changelog</strong>\n\n\u2022 2026-01-12: Created from user testing feedback (third occurrence)"
  },
  {
    "id": "BACKLOG-217",
    "title": "UX Improvement - Edit Contacts Button Flow",
    "category": "ui",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-034",
    "est_tokens": "~40K",
    "actual_tokens": "~156K",
    "variance": "[BACKLOG-217.md](BACKLOG-217.md)",
    "created_at": "2026-01-13",
    "completed_at": "",
    "file": "",
    "description": "<strong>Problem Statement</strong>\n\nUser wants the \"Edit\" button for contacts on a transaction to work like the \"Attach Message\" button - showing the same contact assignment screen used in \"Edit Transaction Step 2\".\n\nCurrently, the edit flow may be confusing or require too many clicks. User expects a more direct, modal-based approach similar to attaching messages.\n\n---\n\n<strong>Current Behavior</strong>\n\nWhen user wants to edit contacts on a transaction:\n1. Click \"Edit\" on transaction\n2. Navigate through edit wizard steps\n3. Find contacts section\n4. Make changes\n5. Save\n\n---\n\n<strong>Requested Behavior</strong>\n\nWhen user clicks \"Edit\" on the contacts section:\n1. Open a modal directly showing the contact assignment interface\n2. Same UI as \"Edit Transaction Step 2\" (familiar interface)\n3. Make changes and save\n4. Modal closes, transaction updates\n\nThis mirrors the \"Attach Message\" button which opens a focused modal for message attachment.\n\n---\n\n<strong>Design Requirements</strong>\n\n<strong>Modal Should Include</strong>\n\n\u2022 Contact role categories (Buyer, Seller, Agents, etc.)\n\u2022 Contact search/selection\n\u2022 Add new contact option\n\u2022 Remove contact option\n\u2022 Save/Cancel buttons\n\n<strong>UX Principles</strong>\n\n| Principle | Implementation |\n|-----------|----------------|\n| Consistency | Match \"Attach Message\" button behavior |\n| Efficiency | Direct access to contacts without full edit wizard |\n| Familiarity | Reuse existing Step 2 contact assignment UI |\n\n---\n\n<strong>Technical Approach</strong>\n\n<strong>Option A: Extract Contact Assignment as Standalone Modal</strong>\n\n<code>// ContactAssignmentModal.tsx\n// - Extract from EditTransactionModal Step 2\n// - Accept transactionId as prop\n// - Handle save/cancel independently\n</code>\n\n<strong>Option B: Add \"Quick Edit\" Button for Contacts Section</strong>\n\n<code>// TransactionDetailView.tsx\n// Add button that opens EditTransactionModal starting at Step 2\n<Button onClick={() => openEditModal({ startStep: 2 })}>\n  Edit Contacts\n</Button>\n</code>\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 \"Edit Contacts\" button on transaction opens contact assignment modal\n\u2610 Modal uses same UI as Edit Transaction Step 2\n\u2610 Changes save directly to transaction\n\u2610 No need to go through full edit wizard\n\u2610 Consistent with \"Attach Message\" button UX\n\u2610 Cancel discards changes without affecting transaction\n\n---\n\n<strong>Related Items</strong>\n\n| ID | Title | Relationship |\n|----|-------|-------------|\n| BACKLOG-216 | Contacts not pre-populating | Related bug |\n| - | Edit Transaction Modal | Component to refactor |\n| - | Attach Message feature | UX reference |\n\n---\n\n<strong>Estimated Effort</strong>\n\n**Category:** enhancement/ux\n**Estimated Tokens:** ~40K (UI extraction + new button)\n**Token Cap:** 160K\n\n---\n\n<strong>Notes</strong>\n\n\u2022 Need UX confirmation on exact button placement\n\u2022 May be able to reuse existing contact assignment component\n\u2022 Consider mobile/responsive layout\n\n---\n\n<strong>Changelog</strong>\n\n\u2022 2026-01-12: Created from user testing feedback"
  },
  {
    "id": "BACKLOG-218",
    "title": "Group Chat Display in Transaction Details (Placeholder)",
    "category": "ui",
    "priority": "High",
    "status": "Blocked",
    "sprint": "-",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "Pending user requirements",
    "created_at": "2026-01-13",
    "completed_at": "",
    "file": "[BACKLOG-218.md](BACKLOG-218.md)",
    "description": "<strong>Problem Statement</strong>\n\nUser wants group chats displayed differently in transaction details view.\n\n**Note:** This is a placeholder item - specific requirements need to be gathered.\n\n---\n\n<strong>Follow-Up Required</strong>\n\nNeed to clarify with user:\n\n1. **Current display issues?**\n   - Are group chats showing incorrectly?\n   - Is the layout confusing?\n   - Are participants not visible?\n\n2. **Desired display format?**\n   - Show all participants?\n   - Group name prominently displayed?\n   - Different visual treatment from 1:1 chats?\n   - Expandable/collapsible format?\n\n3. **Specific pain points?**\n   - Hard to identify which group chat is which?\n   - Too much/too little information shown?\n   - Need filtering or sorting options?\n\n---\n\n<strong>Possible Requirements (TBD)</strong>\n\n| Aspect | Current | Desired (TBD) |\n|--------|---------|---------------|\n| Group name | ? | Prominent display? |\n| Participants | ? | Show all members? |\n| Message preview | ? | Different format? |\n| Visual style | ? | Distinct from 1:1? |\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n**TBD - Pending user clarification**\n\n\u2610 [To be defined after user feedback]\n\u2610 Full test suite passes\n\n---\n\n<strong>Related Items</strong>\n\n| ID | Title | Relationship |\n|----|-------|-------------|\n| BACKLOG-215 | Group chat encoding corruption | Related group chat issue |\n| - | Transaction detail view | Component to modify |\n\n---\n\n<strong>Estimated Effort</strong>\n\n**Category:** enhancement/ux\n**Estimated Tokens:** ~30K (TBD based on requirements)\n**Token Cap:** 120K\n\n---\n\n<strong>Changelog</strong>\n\n\u2022 2026-01-12: Created as placeholder from user testing feedback - needs requirements clarification"
  },
  {
    "id": "BACKLOG-219",
    "title": "Audit Debug/Logging Calls Across Repository",
    "category": "refactor",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-13",
    "completed_at": "",
    "file": "[BACKLOG-219.md](BACKLOG-219.md)",
    "description": "<strong>Type</strong>\nTech Debt / Code Quality\n\n<strong>Priority</strong>\nLow\n\n<strong>Description</strong>\nReview and audit all debug logging and <code>console.log</code> statements across the codebase. During development, debug logging has been added in various places (especially during TASK-1012 attachment work and TASK-1028 iMessage parsing). These should be reviewed to:\n\n1. Remove temporary debug logs that are no longer needed\n2. Convert useful debug logs to proper <code>logService</code> calls with appropriate log levels\n3. Ensure no sensitive data is being logged (message content, file paths, user data)\n4. Standardize logging format and prefixes\n\n<strong>Scope</strong>\n\u2022 <code>electron/</code> - Backend services and handlers\n\u2022 <code>src/components/</code> - Frontend components (especially modal components)\n\u2022 Focus areas:\n  - <code>electron/services/macOSMessagesImportService.ts</code> - Has debug logging for attachments\n  - <code>electron/utils/messageParser.ts</code> - May have parsing debug logs\n  - <code>src/components/transactionDetailsModule/components/modals/ConversationViewModal.tsx</code> - Has attachment fetch logging\n\n<strong>Acceptance Criteria</strong>\n\u2610 All <code>console.log</code> statements reviewed and either removed or converted to <code>logService</code>\n\u2610 Debug logging uses appropriate log levels (debug, info, warn, error)\n\u2610 No sensitive user data logged at info level or above\n\u2610 Logging prefixes are consistent (e.g., <code>[ServiceName]</code> format)\n\u2610 Production builds don't include verbose debug output\n\n<strong>Notes</strong>\n\u2022 Created during SPRINT-034 stability work\n\u2022 Debug logging was added to diagnose attachment display issues\n\u2022 SR Engineer should review before next release\n\n<strong>Created</strong>\n2025-01-12"
  },
  {
    "id": "BACKLOG-220",
    "title": "Unlink Communications UI Not Refreshing",
    "category": "fix",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-049",
    "est_tokens": "~25K",
    "actual_tokens": "~35K",
    "variance": "+40%",
    "created_at": "2026-01-13",
    "completed_at": "",
    "file": "PR #462",
    "description": "<strong>Type</strong>\nBug / UI / Architecture\n\n<strong>Priority</strong>\nHigh\n\n<strong>Description</strong>\nWhen attempting to remove/unlink a communication (email or iMessage) from a transaction, the UI does not update. The backend operation appears to succeed (visible in console logs), but the communication remains visible in the UI until page refresh.\n\n**Root Cause (Updated):** The <code>communications</code> table architecture needs to link by <code>thread_id</code> rather than <code>message_id</code>. Current implementation creates confusion between individual messages and conversation threads.\n\n<strong>Symptoms</strong>\n\u2022 Click to unlink/remove a message from transaction\n\u2022 Nothing visually changes (or only partial update)\n\u2022 Backend logs show successful operation\n\u2022 Manual page refresh shows the communication is removed\n\n<strong>Investigation Findings (2026-01-17)</strong>\n\nPR #450 (TASK-1109) attempted to fix this by awaiting the async callback before closing the modal. However, user testing revealed the fix was insufficient because:\n\n1. **Architecture issue:** <code>communications</code> table stores individual <code>message_id</code> references, but UI operates on conversation threads\n2. **Unlink granularity mismatch:** User expects to unlink \"the conversation\" but backend unlinks individual messages\n3. **State complexity:** Multiple messages per thread means multiple unlink operations\n\n<strong>Required Solution</strong>\n\nThe <code>communications</code> table needs to transition from:\n\u2022 <code>communications.message_id -> messages.id</code> (per-message linking)\n\nTo:\n\u2022 <code>communications.thread_id -> messages.thread_id</code> (per-thread linking)\n\nThis change affects:\n\u2022 <code>autoLinkService.ts</code> - how links are created\n\u2022 <code>communicationDbService.ts</code> - how links are queried/deleted\n\u2022 Export services - how communications are counted/exported\n\u2022 <code>transactionDbService.ts</code> - how communications are joined\n\n<strong>Stashed Work</strong>\n\nThread-based schema refactor was started but deferred due to scope:\n\u2022 **Stash:** <code>stash@{0}: TASK-1109-thread-based-schema-refactor-deferred</code>\n\u2022 **Files changed:** 7 files, 502 insertions, 619 deletions\n\u2022 **Key changes:** schema.sql, communicationDbService.ts, transactionService.ts\n\n<strong>Acceptance Criteria</strong>\n\u2610 Unlinking communication immediately removes entire thread from UI\n\u2610 No page refresh required\n\u2610 Works for both emails and iMessages\n\u2610 Backend operations complete atomically (all messages in thread)\n\n<strong>Dependencies</strong>\n\u2022 BACKLOG-296: Database Schema Alignment (must complete schema work first)\n\u2022 Schema audit on <code>research/database-schema-audit</code> branch\n\n<strong>Related</strong>\n\u2022 TASK-1037 (Auto-Link) - Found during verification testing\n\u2022 SPRINT-034, SPRINT-041\n\u2022 PR #450 (insufficient fix)\n\u2022 BACKLOG-296 (Database Schema Alignment)\n\n<strong>Created</strong>\n2025-01-12\n\n<strong>Reopened</strong>\n2026-01-17"
  },
  {
    "id": "BACKLOG-221",
    "title": "iMessage Attachments Not Displaying (Stale message_id)",
    "category": "fix",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-044",
    "est_tokens": "~40K",
    "actual_tokens": "~25K",
    "variance": "-37%",
    "created_at": "2026-01-13",
    "completed_at": "2026-01-18",
    "file": "PR #471",
    "description": "<strong>Type</strong>\nBug / Data Integrity\n\n<strong>Priority</strong>\nHigh\n\n<strong>Description</strong>\niMessage picture attachments are not displaying in conversation views. GIF attachments work, but regular images show \"[Attachment]\" placeholder. Root cause: attachment records in database have stale <code>message_id</code> values that don't match current message records.\n\n<strong>Symptoms</strong>\n\u2022 Pictures show \"[Attachment]\" placeholder\n\u2022 GIFs display correctly (some records have matching IDs)\n\u2022 Debug logs show \"0 attachments\" returned for queries\n\u2022 Attachment files exist on disk (29K+ files in storage directory)\n\n<strong>Root Cause</strong>\nAttachment records were created during a previous import with old message_id values. When messages were re-imported, they received new UUIDs, but existing attachment records still reference the old message_ids.\n\n<strong>Workarounds Available</strong>\n1. **Repair function** - <code>await window.api.messages.repairAttachments()</code> in dev console\n2. **Re-import** - Full iMessage re-import creates fresh attachment associations\n\n<strong>Permanent Fix Needed</strong>\nConsider one of:\n1. Store <code>external_id</code> (iMessage GUID) in attachments table for reliable lookup\n2. Always re-create attachment records on import (not just when content is new)\n3. Run repair function automatically after import\n\n<strong>Acceptance Criteria</strong>\n\u2610 Picture attachments display in conversation view\n\u2610 No manual repair step required after import\n\u2610 Existing attachment files are properly linked\n\n<strong>Related</strong>\n\u2022 TASK-1012 (Attachment display feature)\n\u2022 SPRINT-034\n\n<strong>Created</strong>\n2025-01-12"
  },
  {
    "id": "BACKLOG-222",
    "title": "Contact Changes Not Saving When Editing Transaction",
    "category": "fix",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-049",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-13",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-222.md](BACKLOG-222.md)",
    "description": "<strong>Type</strong>\nBug / Data Persistence\n\n<strong>Priority</strong>\nHigh\n\n<strong>Description</strong>\nWhen editing a transaction and adding/modifying contacts, the changes do not persist after saving. The contacts pre-populate correctly (TASK-1038 fix works), but any modifications made during editing are lost.\n\n<strong>Symptoms</strong>\n1. Open existing transaction with 1 contact\n2. Click Edit Contacts\n3. Add another contact\n4. Save\n5. Changes are lost - still shows only 1 contact\n\n<strong>Likely Cause</strong>\n\u2022 Save handler may not be collecting updated contact state\n\u2022 State not being passed correctly to save function\n\u2022 Database update may be silently failing\n\n<strong>Acceptance Criteria</strong>\n\u2610 Adding contacts during edit persists after save\n\u2610 Removing contacts during edit persists after save\n\u2610 Modifying contact roles persists after save\n\n<strong>Related</strong>\n\u2022 TASK-1038 (Contacts Pre-Pop) - Found during verification\n\u2022 SPRINT-034\n\n<strong>Created</strong>\n2025-01-12"
  },
  {
    "id": "BACKLOG-223",
    "title": "Add Text Message Status Indicator (Like Email Status)",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-13",
    "completed_at": "",
    "file": "[BACKLOG-223.md](BACKLOG-223.md)",
    "description": "<strong>Type</strong>\nEnhancement / UX\n\n<strong>Priority</strong>\nMedium\n\n<strong>Description</strong>\nAdd a status indicator for text messages (iMessage import) similar to the email connection status. Users should be able to see at a glance whether iMessages have been imported and the last import date.\n\n<strong>Current State</strong>\n\u2022 Email status shows connection state and accuracy (TASK-1039)\n\u2022 No equivalent indicator for iMessages/text messages\n\n<strong>Proposed Solution</strong>\nAdd to Dashboard or Settings:\n\u2022 iMessage import status (imported/not imported)\n\u2022 Last import date/time\n\u2022 Number of messages imported\n\u2022 Quick link to re-import\n\n<strong>Acceptance Criteria</strong>\n\u2610 Dashboard shows iMessage import status\n\u2610 Last import date visible\n\u2610 Message count visible\n\u2610 Status updates after import\n\n<strong>Related</strong>\n\u2022 TASK-1039 (Email State) - User requested similar feature\n\u2022 SPRINT-034\n\n<strong>Created</strong>\n2025-01-12"
  },
  {
    "id": "BACKLOG-224",
    "title": "Apply Edit Contacts Pattern to Transaction Details",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-13",
    "completed_at": "",
    "file": "[BACKLOG-224.md](BACKLOG-224.md)",
    "description": "<strong>Problem Statement</strong>\n\nThe \"Complete your account setup\" banner for email connection has two issues:\n\n1. **\"Continue Setup\" button doesn't work** - Clicking the button has no effect\n2. **Banner doesn't auto-dismiss** - After connecting email, the banner should automatically disappear instead of requiring manual dismiss\n\n<strong>Current Behavior</strong>\n\n\u2022 Amber banner appears on dashboard: \"Complete your account setup - Connect your email to export communications with your audits\"\n\u2022 Clicking \"Continue Setup\" button does nothing\n\u2022 User can manually dismiss with X button, but this shouldn't be required after setup is complete\n\n<strong>Expected Behavior</strong>\n\n1. \"Continue Setup\" button should open the email connection flow (Gmail/Outlook OAuth)\n2. Once email is successfully connected, the banner should automatically disappear\n3. Banner should not reappear after being dismissed or after email is connected\n\n<strong>Location</strong>\n\n\u2022 Dashboard/home page\n\u2022 Component likely in: <code>src/components/</code> (search for \"Complete your account setup\" or \"amber\" banner)\n\n<strong>Priority</strong>\n\nMedium - Affects onboarding UX\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 \"Continue Setup\" button opens email connection modal/flow\n\u2610 Banner auto-dismisses when email account is successfully connected\n\u2610 Banner state persists correctly (doesn't reappear after dismiss/connect)\n\u2610 Works for both Gmail and Outlook connection flows\n\n<strong>Notes</strong>\n\n\u2022 Discovered during SPRINT-034 verification\n\u2022 User can work around by dismissing with X button"
  },
  {
    "id": "BACKLOG-225",
    "title": "Video Attachment Support for iMessage Import",
    "category": "feature",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~40K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-13",
    "completed_at": "",
    "file": "[BACKLOG-225.md](BACKLOG-225.md)",
    "description": "<strong>Problem Statement</strong>\n\nVideo attachments (<code>.mov</code>, <code>.mp4</code>) from iMessages are not imported, even though the message shows <code>[Attachment]</code> placeholder. Currently only images are supported.\n\n<strong>Current Behavior</strong>\n\n\u2022 Only image extensions supported: <code>.jpg</code>, <code>.jpeg</code>, <code>.png</code>, <code>.gif</code>, <code>.heic</code>\n\u2022 Videos are skipped during import\n\u2022 Message still shows <code>[Attachment]</code> placeholder (confusing UX)\n\u2022 User sees placeholder but no content\n\n<strong>Expected Behavior</strong>\n\n1. Import video attachments (<code>.mov</code>, <code>.mp4</code>, <code>.m4v</code>)\n2. Display video with player controls in conversation view\n3. OR: Don't show <code>[Attachment]</code> placeholder for unsupported types\n\n<strong>Technical Details</strong>\n\n\u2022 File: <code>electron/services/macOSMessagesImportService.ts</code>\n\u2022 Line 77: <code>SUPPORTED_IMAGE_EXTENSIONS = [\".jpg\", \".jpeg\", \".png\", \".gif\", \".heic\"]</code>\n\u2022 Would need to add video extensions and create video player component\n\n<strong>Considerations</strong>\n\n\u2022 Video files are larger - storage impact\n\u2022 Need video player component in UI\n\u2022 May need to handle different codecs\n\u2022 Could thumbnail videos instead of storing full file\n\n<strong>Priority</strong>\n\nLow - Enhancement\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Video files (<code>.mov</code>, <code>.mp4</code>, <code>.m4v</code>) are imported\n\u2610 Video player displays in conversation view\n\u2610 Playback controls work (play/pause, scrub)\n\u2610 OR: <code>[Attachment]</code> placeholder hidden for unsupported types\n\n<strong>Related</strong>\n\n\u2022 TASK-1012: Original attachment import implementation (images only)\n\u2022 BACKLOG-225: URL preview formatting (nice to have)\n\n<strong>Notes</strong>\n\n\u2022 Discovered during SPRINT-034 verification\n\u2022 Example: IMG_2753.MOV (1.1MB) not imported despite being small enough"
  },
  {
    "id": "BACKLOG-226",
    "title": "URL Preview Formatting in Messages",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~35K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-13",
    "completed_at": "",
    "file": "[BACKLOG-226.md](BACKLOG-226.md)",
    "description": "<strong>Problem Statement</strong>\n\nURLs shared in iMessages show as plain text links instead of rich previews like iMessage displays them (with title, description, thumbnail).\n\n<strong>Current Behavior</strong>\n\n\u2022 URLs appear as plain text in message bubbles\n\u2022 No preview card with site title/description/image\n\u2022 Less visual context for shared links\n\n<strong>Expected Behavior</strong>\n\n\u2022 Detect URLs in message text\n\u2022 Fetch Open Graph / meta data for preview\n\u2022 Display preview card similar to iMessage:\n  - Site favicon\n  - Page title\n  - Description snippet\n  - Thumbnail image (if available)\n\n<strong>Technical Considerations</strong>\n\n\u2022 Would need to fetch URL metadata (og:title, og:description, og:image)\n\u2022 Could cache previews to avoid re-fetching\n\u2022 Privacy: fetching URLs reveals user activity\n\u2022 Option: Only show previews for URLs that were previewed in original iMessage\n\n<strong>Priority</strong>\n\nLow - Nice to have enhancement\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 URLs detected in message text\n\u2610 Preview card displayed below/inline with message\n\u2610 Shows title, description, and thumbnail\n\u2610 Graceful fallback for sites without meta tags\n\n<strong>Notes</strong>\n\n\u2022 Discovered during SPRINT-034 verification\n\u2022 User mentioned \"would be nice if it was formatted with the preview like it is on iMessages but it's not critical at all\""
  },
  {
    "id": "BACKLOG-227",
    "title": "Show iMessage Attachments in Attachments Tab",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-14",
    "completed_at": "",
    "file": "[BACKLOG-227.md](BACKLOG-227.md)",
    "description": "<strong>Problem Statement</strong>\n\nThe Attachments tab in transaction details only shows email attachments. iMessage attachments (photos, GIFs, files) are only visible inline when viewing individual conversations. Users want a centralized view of all media.\n\n<strong>Current Behavior</strong>\n\n\u2022 Attachments tab shows only email attachments\n\u2022 iMessage attachments only visible in conversation view modal\n\u2022 No way to see all text message media at a glance\n\n<strong>Expected Behavior</strong>\n\nSeparate tabs or sections for:\n1. **Email Attachments** - Current functionality (from emails)\n2. **Text Attachments** - New (from iMessages/SMS)\n\nEach should be in its own tab, NOT combined.\n\n<strong>Implementation Options</strong>\n\n<strong>Option A: Sub-tabs within Attachments</strong>\n<code>Attachments Tab\n\u251c\u2500\u2500 Email (current)\n\u2514\u2500\u2500 Text Messages (new)\n</code>\n\n<strong>Option B: Separate Top-level Tabs</strong>\n<code>Transaction Details\n\u251c\u2500\u2500 Overview\n\u251c\u2500\u2500 Messages\n\u251c\u2500\u2500 Email Attachments\n\u251c\u2500\u2500 Text Attachments  (new)\n\u2514\u2500\u2500 Contacts\n</code>\n\n<strong>Option C: Filter Toggle</strong>\n<code>Attachments Tab\n[Email] [Text] [All]  <- toggle buttons\n</code>\n\n<strong>Technical Details</strong>\n\n\u2022 iMessage attachments stored in <code>attachments</code> table with <code>message_id</code> FK\n\u2022 Need to query attachments for messages linked to transaction\n\u2022 Display should include: thumbnail, filename, date, sender\n\n<strong>Priority</strong>\n\nMedium - Enhancement\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 iMessage attachments visible in dedicated section/tab\n\u2610 Separated from email attachments (not combined)\n\u2610 Shows thumbnail preview for images\n\u2610 Shows sender/date context\n\u2610 Can click to view full size\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-225: Video attachment support (would also appear here)\n\u2022 BACKLOG-226: URL preview formatting\n\n<strong>Created</strong>\n\n2025-01-13"
  },
  {
    "id": "BACKLOG-228",
    "title": "UI Freeze When Viewing Messages to Attach",
    "category": "performance",
    "priority": "High",
    "status": "Pending",
    "sprint": "SPRINT-049",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "Related to BACKLOG-173 regression",
    "created_at": "2026-01-14",
    "completed_at": "",
    "file": "[BACKLOG-228.md](BACKLOG-228.md)",
    "description": "<strong>Problem Statement</strong>\n\nThe app freezes when opening the Attach Messages modal to view/select messages for linking to a transaction. This occurs despite BACKLOG-173 fix (contact-first interface).\n\n<strong>Current Behavior</strong>\n\n\u2022 Open transaction \u2192 Messages tab \u2192 Click \"Attach Messages\"\n\u2022 UI freezes / becomes unresponsive\n\u2022 May need to force-quit app\n\n<strong>Previous Fix (BACKLOG-173)</strong>\n\nPR #353 implemented a contact-first interface to avoid loading all messages at once. However, the freeze is still occurring, indicating either:\n1. Regression in the fix\n2. Different code path being triggered\n3. Incomplete fix for certain scenarios\n\n<strong>Expected Behavior</strong>\n\n\u2022 Attach Messages modal opens quickly\n\u2022 Shows contacts first (as designed in BACKLOG-173)\n\u2022 Only loads messages for selected contact\n\u2022 UI remains responsive throughout\n\n<strong>Investigation Needed</strong>\n\n1. Verify contact-first interface is still active\n2. Check if freeze happens before or after contact selection\n3. Profile to find the blocking operation\n4. Check if pagination/batching is working correctly\n\n<strong>Priority</strong>\n\nHigh - Blocks core workflow\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Attach Messages modal opens without freeze\n\u2610 UI remains responsive during message loading\n\u2610 Works with large message databases (500K+ messages)\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-173: Contact-First AttachMessagesModal Interface (completed PR #353)\n\u2022 BACKLOG-206: UI Freezing During iMessage Sync/Import\n\u2022 TASK-1029: Fix UI Freezing During iMessage Import\n\n<strong>Created</strong>\n\n2025-01-13"
  },
  {
    "id": "BACKLOG-229",
    "title": "Binary Plist Text Still Showing as Garbage (CRITICAL)",
    "category": "fix",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-036",
    "est_tokens": "~40K",
    "actual_tokens": "~30K",
    "variance": "-25%",
    "created_at": "2026-01-14",
    "completed_at": "2026-01-14",
    "file": "PR #431 (TASK-1071)",
    "description": "<strong>Priority: CRITICAL</strong>\n\n<strong>Problem Statement</strong>\n\nDespite TASK-1035 fix, binary plist data is still appearing as garbage text in some messages. The <code>looksLikeBinaryGarbage</code> detection is not catching all cases.\n\n<strong>Example Garbage Output</strong>\n\n<code>\u0b04\u7473\u6572\u6d61\u7974\u6570\u8164\u03e8\u0184\u8440\u8484\u4e19\u4d53\u7475\u6261\u656c\u7441\u7274\u6269\u7475\u6465\u7453\u6972\u676e\u8400\u1284\u534e\u7441\u7274\u6269\u7475\u6465\u7453\u6972\u676e\u8400\u0884\u534e\u624f\u656a\u7463\u8500\u8492\u8484\u4e0f\u4d53\u7475\u6261\u656c\u7453\u6972\u676e\u8401\u0884\u534e\u7453\u6972\u676e\u9501\u0184\u032b\ubfef\u86bc\u0284\u4969\u0101\u8492\u8484\u4e0c\u4453\u6369\u6974\u6e6f\u7261y\u8495\u6901\u9203\u9884\u2698\u5f5f\u496b\u424d\u7361\u5765\u6972\u6974\u676e\u6944\u6572\u7463\u6f69\u416e\u7474\u6972\u7562\u6574\u614e\u656d\u9286\u8484\u0884\u534e\u754e\u626d\u7265\u8400\u0784\u534e\u6156\u756ce\u8495\u2a01\u8484\u7101\uff9f\u9286\u9884\u1d98\u5f5f\u496b\u4d4d\u7365\u6173\u6567\u6150\u7472\u7441\u7274\u6269\u7475\u4e65\u6d61\u8665\u8492\u9e9d\u9f9f\u8600\u8492\u9898\u5f22\u6b5f\u4d49\u6946\u656c\u7254\u6e61\u6673\u7265\u5547\u4449\u7441\u7274\u6269\u7475\u4e65\u6d61\u8665\u8492\u9898\u6129\u5f74\u5f30\u3435\u4638\u3642\u4534\u412d\u3733\u2d46\u3434\u4544\u392d\u3936\u2d37\u3735\u3834\u3737\u3838\u3742\u3941\u8686\n</code>\n\nThis is binary plist data (<code>streamtyped</code> format) being misinterpreted as UTF-16 text.\n\n<strong>Root Cause Analysis</strong>\n\nThe current <code>looksLikeBinaryGarbage</code> function checks for:\n1. Literal \"bplist\" or \"streamtyped\" strings\n2. >30% unusual characters (code > 255)\n\nHowever, when binary data is read as UTF-16 and displayed as UTF-8:\n\u2022 \"streamtyped\" becomes <code>\u7473\u6572\u6d61\u7974\u6570</code> (garbled)\n\u2022 The literal string check fails\n\u2022 The 30% check may also fail depending on the specific bytes\n\n<strong>Symptoms</strong>\n\n1. Messages with attachments (screenshots) show the image correctly\n2. But the accompanying text shows as Chinese/Japanese-like garbage characters\n3. Contains patterns like <code>_kIMBaseWritingDirectionAttributeName</code> encoded as garbage\n\n<strong>Files Affected</strong>\n\n\u2022 <code>electron/utils/messageParser.ts</code> - <code>looksLikeBinaryGarbage</code> function\n\u2022 <code>electron/services/macOSMessagesImportService.ts</code> - import uses <code>getMessageText</code>\n\n<strong>Proposed Fix</strong>\n\nImprove binary garbage detection:\n1. Check for UTF-16 interpreted binary patterns\n2. Detect <code>__kIM</code> metadata even when garbled\n3. Check for specific byte sequences that indicate binary plist\n4. Lower the threshold for unusual character detection\n\n<strong>Related</strong>\n\n\u2022 TASK-1035: Original binary plist fix (incomplete)\n\u2022 BACKLOG-215: iMessage Encoding Corruption\n\u2022 SPRINT-034: Stability fixes\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 No garbage text appearing in message conversations\n\u2610 Binary plist data properly parsed and displayed as readable text\n\u2610 Works for both fresh imports and existing data\n\n<strong>Created</strong>\n\n2025-01-13"
  },
  {
    "id": "BACKLOG-230",
    "title": "NULL thread_id Investigation and Fix",
    "category": "fix",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "Analysis complete; macOS orphans, not parser issue",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-230-null-thread-id-investigation.md](BACKLOG-230-null-thread-id-investigation.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-230-null-thread-id-investigation",
    "title": "NULL thread_id Investigation and Fix",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-230-null-thread-id-investigation.md](items/BACKLOG-230-null-thread-id-investigation.md)",
    "description": "<strong>Problem Statement</strong>\n\n7.2% of messages (48,502 out of 674,652) have NULL thread_id, causing them to not be properly grouped into chat threads.\n\n<strong>Root Cause Analysis (Completed)</strong>\n\n**Key Finding:** These messages are **orphaned at the macOS level** - Apple's chat.db has no chat association for them.\n\n| Category | Count | Percentage |\n|----------|-------|------------|\n| Outbound to \"unknown\" | 24,816 | 51% |\n| Known senders (deleted chats) | 23,686 | 49% |\n| **Total** | 48,502 | 100% |\n\n<strong>Why This Happens</strong>\n\nmacOS stores messages with:\n\u2022 <code>handle_id = 0</code> (no recipient link)\n\u2022 No entry in <code>chat_message_join</code> table\n\u2022 Even Apple doesn't know the recipient\n\nThis occurs when:\n\u2022 Chat was deleted but message metadata remained\n\u2022 iCloud sync issues between devices\n\u2022 Messages sent during connectivity problems\n\n---\n\n<strong>Detailed Investigation Results</strong>\n\n<strong>Analysis Query Results</strong>\n\n<code>await window.api.system.diagnosticNullThreadIdAnalysis(userId);\n</code>\n\n**By Channel:**\n\u2022 iMessage: 41,717 (86%)\n\u2022 SMS: 6,785 (14%)\n\n**By Time (recent is minimal):**\n\u2022 Jan 2026: 6 messages\n\u2022 Dec 2025: 8 messages\n\u2022 Jul 2025: 352 messages (bulk historical)\n\n**Top Senders with NULL thread_id:**\n| Sender | Count | Sample |\n|--------|-------|--------|\n| unknown | 24,816 | \"Where are you?\" |\n| +14153071897 | 9,777 | (attachment) |\n| +15109819028 | 789 | Normal conversation |\n| +14153072985 | 375 | Normal conversation |\n\n<strong>macOS chat.db Analysis</strong>\n\nVerified 24,825 orphaned outbound messages directly in macOS:\n\n<code>SELECT COUNT(*) FROM message m\nLEFT JOIN chat_message_join cmj ON m.ROWID = cmj.message_id\nWHERE cmj.chat_id IS NULL AND m.is_from_me = 1;\n-- Result: 24,825\n</code>\n\n**Recovery attempts:**\n\u2022 Only 2 messages have <code>reply_to_guid</code> (could trace to chat)\n\u2022 Only 6 messages have <code>thread_originator_guid</code>\n\u2022 Timestamp proximity matching: inconclusive\n\n---\n\n<strong>Test Cases from Production</strong>\n\n<strong>Case 1: Orphaned Message with Reply Chain (Recoverable)</strong>\n\n**Message:**\n<code>{\n  \"external_id\": \"4728C738-7127-44A3-8DB6-50AE8DDE280D\",\n  \"body_text\": \"Also\",\n  \"participants\": \"{\\\"from\\\":\\\"me\\\",\\\"to\\\":[\\\"unknown\\\"]}\",\n  \"sent_at\": \"2026-01-12T03:22:21.162Z\"\n}\n</code>\n\n**macOS data:**\n<code>-- Message has reply_to_guid\nreply_to_guid: CE694AAC-0E4B-433D-9817-DE14FF416AB1\ndestination_caller_id: +14158064240  -- User's number (sender)\nhandle_id: 0  -- No recipient handle\n\n-- Parent message has chat association\nchat_identifier: chat88807631268728891\ndisplay_name: \"JP sales team\"\nparticipants: +14082104874, +14088076253\n</code>\n\n**Conclusion:** Can recover recipient by following reply chain (only 2 of 24K have this)\n\n<strong>Case 2: Truly Orphaned (Not Recoverable)</strong>\n\n**Message:**\n<code>{\n  \"external_id\": \"6EB502E6-38E9-4884-8440-B44E3F0C173E\",\n  \"body_text\": \"Can one of you try to help me with the kitchen faucet...\",\n  \"participants\": \"{\\\"from\\\":\\\"me\\\",\\\"to\\\":[\\\"unknown\\\"]}\",\n  \"sent_at\": \"2025-12-22T22:18:34.707Z\"\n}\n</code>\n\n**macOS data:**\n\u2022 <code>handle_id = 0</code>\n\u2022 No <code>chat_message_join</code> entry\n\u2022 No <code>reply_to_guid</code>\n\u2022 No <code>thread_originator_guid</code>\n\u2022 Likely sent to \"Hall Family\" group chat (based on content)\n\n**Conclusion:** Cannot programmatically recover recipient\n\n<strong>Case 3: Known Sender, Deleted Chat</strong>\n\n<code>{\n  \"sender\": \"+14153706109\",\n  \"count\": 259,\n  \"sampleText\": \"Ladies. What r your plans for tomorrow evening...\"\n}\n</code>\n\n**Conclusion:** Chat was deleted, but messages remain. Can group by sender.\n\n<strong>Case 4: SMS Short Codes</strong>\n\n<code>{\n  \"body_text\": \"Your United verification code is 510438...\",\n  \"participants\": \"{\\\"from\\\":\\\"26266\\\",\\\"to\\\":[\\\"me\\\"]}\"\n}\n</code>\n\n**Conclusion:** Short codes don't create proper chats. Expected behavior.\n\n---\n\n<strong>Available Data for Orphaned Messages</strong>\n\nWhat we **have**:\n\u2022 Message text (in attributedBody blob)\n\u2022 Timestamp\n\u2022 User's account (e.g., danielxhaim@gmail.com)\n\u2022 <code>is_sent = 1</code> (confirmed sent)\n\u2022 <code>destination_caller_id</code> (user's phone number, not recipient)\n\nWhat we **don't have**:\n\u2022 Recipient phone/email\n\u2022 Chat association\n\u2022 Thread context\n\n---\n\n<strong>Potential Solutions</strong>\n\n<strong>Option A: Accept \"Unknown\" as Accurate \u2713</strong>\nThese are truly orphaned at macOS level. \"Unknown\" is correct.\n\n**Pros:** Honest, no false data\n**Cons:** 7.2% of messages incomplete\n\n<strong>Option B: Synthetic thread_id by Sender</strong>\nFor known senders, group messages together:\n<code>const threadId = senderId\n  ? <code>orphan-${senderId}</code>\n  : null;\n</code>\n\n**Pros:** Groups related messages\n**Cons:** May group unrelated conversations\n\n<strong>Option C: \"Orphaned Messages\" UI Section</strong>\nSeparate view showing messages with no chat association.\n\n**Pros:** Audit trail preserved\n**Cons:** UI complexity\n\n<strong>Option D: Manual Mapping Table</strong>\nUser provides corrections: \"Message X was sent to Contact Y\"\n\n**Pros:** Accurate when mapped\n**Cons:** Manual effort\n\n---\n\n<strong>Group Chats in User's Database (Reference)</strong>\n\nFor manual mapping if needed:\n\n| ROWID | display_name | participants |\n|-------|--------------|--------------|\n| 452 | Hall Family | (family members) |\n| 809 | JP sales team | +14082104874, +14088076253 |\n| 2042 | Incline Gays\u2122 | (11 participants) |\n| 1948 | New Orleans Cruise | (9 participants) |\n| 2302 | Dorian Clan | (9 participants) |\n| 2301 | The Middle Agers | (8 participants) |\n| 1834 | Incline OGs \u2764\ufe0f\u200d\ud83e\ude79 | (6 participants) |\n\n---\n\n<strong>Diagnostic Tools Available</strong>\n\n<code>// Full health report\nawait window.api.system.diagnosticMessageHealth(userId);\n\n// NULL thread_id samples\nawait window.api.system.diagnosticNullThreadId(userId);\n\n// Detailed NULL analysis (by sender, channel, month)\nawait window.api.system.diagnosticNullThreadIdAnalysis(userId);\n\n// Unknown recipient messages with macOS IDs\nawait window.api.system.diagnosticUnknownRecipientMessages(userId);\n\n// Threads for a specific contact\nawait window.api.system.diagnosticThreadsForContact(userId, \"4155551234\");\n</code>\n\n---\n\n<strong>Recommendation</strong>\n\n**Accept as-is for now.** The good news:\n\u2022 Only ~40 recent orphaned messages (last 6 months)\n\u2022 Bulk (24K) are historical\n\u2022 Current import is working correctly for new messages\n\nFuture enhancement: Add \"Orphaned Messages\" section in UI for compliance review.\n\n---\n\n<strong>Related</strong>\n\n\u2022 SPRINT-036: Deterministic Message Parsing (completed)\n\u2022 FIX-PLAN-message-parsing-and-grouping.md (original analysis)"
  },
  {
    "id": "BACKLOG-231",
    "title": "Fix Failing iosMessagesParser Tests (20 tests)",
    "category": "test",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "Mock database setup issues",
    "created_at": "2026-01-15",
    "completed_at": "",
    "file": "[BACKLOG-231.md](BACKLOG-231.md)",
    "description": "<strong>Problem</strong>\n\nThe <code>iosMessagesParser.test.ts</code> test file has 20 failing tests out of 46 total. These tests fail because they test against a mock SQLite database that doesn't properly represent the iOS Messages database structure.\n\n<strong>Impact</strong>\n\n\u2022 **Test Suite**: 20 failures reduce confidence in test coverage metrics\n\u2022 **CI**: Tests pass overall but these specific tests are failing silently (not blocking CI)\n\u2022 **Data Integrity**: Parser functionality is not properly validated by tests\n\u2022 **Priority**: Medium (tests were added in SPRINT-036/037 but underlying mock data issues remain)\n\n<strong>Root Cause Analysis</strong>\n\nBased on test output, the issues are:\n\n1. **Mock database structure mismatch**: Tests expect 3 conversations but mock returns 0\n2. **Non-existent path handling**: Parser doesn't throw when opening non-existent database path\n3. **Group chat detection**: <code>find()</code> returns <code>undefined</code> when searching for group chats\n4. **Message retrieval**: Messages array is empty when it should contain 3 messages\n5. **Message attribute parsing**: <code>fromMe</code>, <code>sender</code>, <code>recipient</code> fields not properly populated\n\nThe mock database setup in the test file likely needs to:\n\u2022 Use the correct table schema (<code>chat</code>, <code>message</code>, <code>chat_message_join</code>, <code>handle</code>)\n\u2022 Insert proper test data with all required columns\n\u2022 Match the actual iOS Messages database structure\n\n<strong>Affected Files</strong>\n\n| File | Purpose |\n|------|---------|\n| <code>electron/services/__tests__/iosMessagesParser.test.ts</code> | Test file with 20 failures |\n| <code>electron/services/iosMessagesParser.ts</code> | Parser implementation |\n\n<strong>Failing Test Categories</strong>\n\n| Category | Tests Failing | Description |\n|----------|---------------|-------------|\n| Database open/close | 1 | Non-existent path should throw |\n| getConversations | 3 | Empty results, missing group/individual chat detection |\n| getMessages | 3+ | Empty results, chronological order, fromMe detection |\n| Message content parsing | 10+ | Text extraction, attachments, date handling |\n\n<strong>Proposed Solution</strong>\n\n<strong>Option A: Fix Mock Database Setup (Recommended)</strong>\n1. Review actual iOS Messages database schema\n2. Update test file to create proper mock tables\n3. Insert representative test data\n4. Ensure parser methods are tested against realistic data\n\n<strong>Option B: Integration Test Approach</strong>\n1. Create a test fixtures directory with sanitized real iOS Messages database\n2. Update tests to use fixture database\n3. Mark as integration tests (separate from unit tests)\n\n<strong>Option C: Mock Service Layer</strong>\n1. Create a mock for the SQLite database layer\n2. Mock return values for each query\n3. Test parser logic independently of actual database\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 All 46 tests in iosMessagesParser.test.ts pass\n\u2610 Tests validate actual parser behavior (not just mock responses)\n\u2610 Test coverage for edge cases:\n  - Non-existent database path\n  - Empty database\n  - Group chats vs individual chats\n  - Messages with attachments\n  - Date parsing and sorting\n\u2610 No regressions in existing passing tests\n\n<strong>Estimation</strong>\n\n\u2022 **Category**: test\n\u2022 **Complexity**: Medium - requires understanding iOS Messages schema\n\u2022 **Estimated Tokens**: ~30K\n\u2022 **Files to modify**: 1-2\n\n<strong>Related</strong>\n\n\u2022 SPRINT-036 (Deterministic Message Parsing) - Added parser refactors\n\u2022 SPRINT-037 (Test Coverage) - Addressed databaseService tests, not iosMessagesParser\n\u2022 BACKLOG-203 (macOS Messages tests) - Related but for macOS, not iOS parser\n\n<strong>Notes</strong>\n\n\u2022 Discovered: 2026-01-15 during SPRINT-037 completion review\n\u2022 26 tests pass, 20 fail (56% pass rate)\n\u2022 These tests were likely added without proper mock data setup\n\u2022 Consider adding to SPRINT-038 or next test-focused sprint"
  },
  {
    "id": "BACKLOG-232",
    "title": "Fix Disabled webSecurity in OAuth Popup Windows",
    "category": "security",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "~40K",
    "actual_tokens": "-",
    "variance": "googleAuthHandlers.ts, microsoftAuthHandlers.ts",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "PR #433",
    "description": ""
  },
  {
    "id": "BACKLOG-233",
    "title": "Add Global Unhandled Rejection Handlers",
    "category": "service",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "main.ts, main.tsx missing process.on handlers",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "PR #435",
    "description": ""
  },
  {
    "id": "BACKLOG-234",
    "title": "Fix Race Condition in Sync Orchestrator",
    "category": "service",
    "priority": "Critical",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~50K",
    "actual_tokens": "-",
    "variance": "Concurrent sync state conflicts",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-235",
    "title": "Patch jsdiff DoS Vulnerability",
    "category": "security",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "npm audit vulnerability",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "PR #434",
    "description": ""
  },
  {
    "id": "BACKLOG-236",
    "title": "Fix Incomplete PII Masking in LLM Pipeline",
    "category": "security",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "~45K",
    "actual_tokens": "-",
    "variance": "Content sent to LLM may expose PII",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "PR #436",
    "description": ""
  },
  {
    "id": "BACKLOG-237",
    "title": "Reduce Transactions.tsx State Complexity (17 useState)",
    "category": "refactor",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "TASK-1159",
    "est_tokens": "~60K",
    "actual_tokens": "~25K",
    "variance": "58% under estimate",
    "created_at": "2026-01-17",
    "completed_at": "2026-01-22",
    "file": "feature/BACKLOG-237-reduce-transactions-state",
    "description": ""
  },
  {
    "id": "BACKLOG-238",
    "title": "Break Down Oversized Flow Hooks",
    "category": "refactor",
    "priority": "Critical",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~100K",
    "actual_tokens": "-",
    "variance": "useEmailHandlers 382 lines, useAuthFlow 233 lines",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-239",
    "title": "Reduce Direct Database Access Pattern",
    "category": "refactor",
    "priority": "Critical",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~120K",
    "actual_tokens": "-",
    "variance": "45 instances of const db = pattern",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-240",
    "title": "Implement Database Migration Rollback Strategy",
    "category": "infra",
    "priority": "Critical",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~60K",
    "actual_tokens": "-",
    "variance": "No rollback procedures exist",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-241",
    "title": "Add Startup Health Checks",
    "category": "infra",
    "priority": "Critical",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~35K",
    "actual_tokens": "-",
    "variance": "No pre-flight validation on app start",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-242",
    "title": "Add AbortController Support for Long Operations",
    "category": "service",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~50K",
    "actual_tokens": "-",
    "variance": "No cancellation support for sync/fetch",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-243",
    "title": "Fix Fire-and-Forget IPC Event Handlers",
    "category": "service",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~60K",
    "actual_tokens": "-",
    "variance": "IPC handlers lack error handling",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-244",
    "title": "Guarantee Session Cleanup Before State Transitions",
    "category": "service",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~40K",
    "actual_tokens": "-",
    "variance": "Session state leaks possible",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-245",
    "title": "Validate Database Connection State",
    "category": "service",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "No connection validation before queries",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-246",
    "title": "Add Component-Level Error Boundaries",
    "category": "ui",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~45K",
    "actual_tokens": "-",
    "variance": "Missing granular error boundaries",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-247",
    "title": "Re-enable Sandbox for Preload Script",
    "category": "security",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-043",
    "est_tokens": "~40K",
    "actual_tokens": "~35K",
    "variance": "-12%",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "PR #463",
    "description": ""
  },
  {
    "id": "BACKLOG-248",
    "title": "Fix Environment Variable Exposure in googleAuthService",
    "category": "security",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-043",
    "est_tokens": "~25K",
    "actual_tokens": "~15K",
    "variance": "-40%",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "PR #464",
    "description": ""
  },
  {
    "id": "BACKLOG-249",
    "title": "Tighten CSP in Development Mode",
    "category": "security",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-043",
    "est_tokens": "~20K",
    "actual_tokens": "~10K",
    "variance": "-50%",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "PR #465",
    "description": ""
  },
  {
    "id": "BACKLOG-250",
    "title": "Reduce Heavy Service Dependency Chains",
    "category": "refactor",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~80K",
    "actual_tokens": "-",
    "variance": "transactionService imports 13+ services",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-251",
    "title": "Standardize IPC Handler Error Handling",
    "category": "refactor",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~70K",
    "actual_tokens": "-",
    "variance": "165 handlers with inconsistent patterns",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-252",
    "title": "Decouple LLM Service from Consumers",
    "category": "refactor",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~55K",
    "actual_tokens": "-",
    "variance": "Tight coupling to LLM implementation",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-253",
    "title": "Remove Module-Level State Anti-Patterns",
    "category": "refactor",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~40K",
    "actual_tokens": "-",
    "variance": "Global state in hooks causes Strict Mode issues",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-254",
    "title": "Fix Type Safety Issues with any and unsafe unknown",
    "category": "refactor",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~50K",
    "actual_tokens": "-",
    "variance": "AppleDriverSetup.tsx:43 and others",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-255",
    "title": "Modularize Large Components (700-827 lines)",
    "category": "refactor",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~90K",
    "actual_tokens": "-",
    "variance": "Multiple oversized component files",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-256",
    "title": "Address TODO/FIXME Comments (15+)",
    "category": "refactor",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~60K",
    "actual_tokens": "-",
    "variance": "Incomplete features flagged",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-257",
    "title": "Fix Module-Level Mutable State in useAutoRefresh",
    "category": "refactor",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "Memory leak and state sharing risk",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-258",
    "title": "Fix N+1 Query in Transaction Details",
    "category": "performance",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~45K",
    "actual_tokens": "-",
    "variance": "Nested subqueries pattern",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-259",
    "title": "Fix Memory Leak in useAutoRefresh Event Listeners",
    "category": "performance",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "Uncleaned event listeners",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-260",
    "title": "Implement Virtual Scrolling for Large Lists",
    "category": "performance",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~60K",
    "actual_tokens": "-",
    "variance": "Transaction/message lists need virtualization",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-261",
    "title": "Unify Logging Architecture",
    "category": "refactor",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~70K",
    "actual_tokens": "-",
    "variance": "280 structured vs 87 console.log",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-262",
    "title": "Add Pre-Deployment Validation",
    "category": "infra",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~40K",
    "actual_tokens": "-",
    "variance": "No validation before deploy",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-263",
    "title": "Add Auto-Updater Metrics and Failure Tracking",
    "category": "infra",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~35K",
    "actual_tokens": "-",
    "variance": "Silent update failures possible",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-264",
    "title": "Document LLM Service API",
    "category": "docs",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~40K",
    "actual_tokens": "-",
    "variance": "Complex retry/batch logic undocumented",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-265",
    "title": "Document Complex Algorithms",
    "category": "docs",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~50K",
    "actual_tokens": "-",
    "variance": "messageMatchingService, autoLinkService",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-266",
    "title": "Consolidate Duplicate Utility Functions",
    "category": "refactor",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~35K",
    "actual_tokens": "-",
    "variance": "formatCurrency, formatDate duplicates",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-267",
    "title": "Standardize Error Handling Patterns",
    "category": "refactor",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~50K",
    "actual_tokens": "-",
    "variance": "Inconsistent error handling across codebase",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-268",
    "title": "Convert Relative Imports to Path Aliases",
    "category": "refactor",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~80K",
    "actual_tokens": "-",
    "variance": "332+ relative import paths",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-269",
    "title": "Add Memoization to Transaction Components",
    "category": "performance",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~40K",
    "actual_tokens": "-",
    "variance": "Missing useMemo/useCallback",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-270",
    "title": "Optimize Conversation Filtering Array Operations",
    "category": "performance",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "Inefficient array operations",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-271",
    "title": "Add Indexes for Database LIKE Queries",
    "category": "performance",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "Unindexed columns in search queries",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-272",
    "title": "Fix Synchronous JSON Serialization in Hot Paths",
    "category": "performance",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~35K",
    "actual_tokens": "-",
    "variance": "Blocking serialization",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-273",
    "title": "Improve Test Coverage (24% baseline)",
    "category": "test",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~100K",
    "actual_tokens": "-",
    "variance": "21 skipped tests, many uncovered paths",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-274",
    "title": "Ensure Cleanup on App Termination",
    "category": "service",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~40K",
    "actual_tokens": "-",
    "variance": "Insufficient cleanup handlers",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-275",
    "title": "Add Structured Logging to Renderer Process",
    "category": "refactor",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~45K",
    "actual_tokens": "-",
    "variance": "LogService not used in renderer",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-276",
    "title": "Implement Error Recovery & Rollback Strategy",
    "category": "service",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~60K",
    "actual_tokens": "-",
    "variance": "No graceful error recovery",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-277",
    "title": "Secure CI Logs from Secret Exposure",
    "category": "security",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "Potential credential leaks in CI",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-278",
    "title": "Improve JSDoc Coverage",
    "category": "docs",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~80K",
    "actual_tokens": "-",
    "variance": "~2400 comments for 246 files (~10/file)",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-279",
    "title": "Document IPC Handlers Consistently",
    "category": "docs",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~50K",
    "actual_tokens": "-",
    "variance": "Handler documentation inconsistent",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-280",
    "title": "Document Migration & Version History",
    "category": "docs",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~35K",
    "actual_tokens": "-",
    "variance": "No migration documentation",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-281",
    "title": "Create Documentation Standards",
    "category": "docs",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "No consistent doc patterns",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-282",
    "title": "Document Error Handling Patterns",
    "category": "docs",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "Error patterns undocumented",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-283",
    "title": "Document Configuration/Environment Setup",
    "category": "docs",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "Setup documentation gaps",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-284",
    "title": "Implement Dependency Injection for Services",
    "category": "refactor",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~120K",
    "actual_tokens": "-",
    "variance": "Manual service instantiation",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-285",
    "title": "Add Data Abstraction Layer for Components",
    "category": "refactor",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~100K",
    "actual_tokens": "-",
    "variance": "Direct data access in components",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "-",
    "description": ""
  },
  {
    "id": "BACKLOG-286",
    "title": "Unify Chat Card and Group Chat Card Components",
    "category": "ui",
    "priority": "Low",
    "status": "Completed",
    "sprint": "SPRINT-040",
    "est_tokens": "~40K",
    "actual_tokens": "~70K",
    "variance": "PRs #442,445-448",
    "created_at": "2026-01-15",
    "completed_at": "2026-01-17",
    "file": "-",
    "description": "<strong>Category</strong>\nUI/UX, Code Quality\n\n<strong>Priority</strong>\nLow\n\n<strong>Status</strong>\nPending\n\n<strong>Description</strong>\n\nThe individual chat card and group chat card in the Text Messages section have inconsistent designs and are likely separate components. They should be unified into a single <code>ThreadCard</code> component with variants for individual vs group chats.\n\n<strong>Current State</strong>\n\n**Individual Chat Card:**\n\u2022 Avatar: Letter initial with gradient background (green/teal)\n\u2022 Title: Contact name\n\u2022 Subtitle: Phone number\n\u2022 Preview: Last message text\n\u2022 Badge: Green \"X messages\" pill\n\n**Group Chat Card:**\n\u2022 Avatar: Purple group icon (no initial)\n\u2022 Title: \"Group Chat\" label + purple \"X people\" badge\n\u2022 Subtitle: Participant names (\"Also includes: ...\")\n\u2022 Info: Date range + message count as text (no badge)\n\u2022 No preview text\n\n<strong>Visual Inconsistencies</strong>\n\n1. **Avatar styles differ** - Individual uses colored gradient with initial; group uses icon\n2. **Badge placement differs** - Individual has badge on right; group has inline badge after title\n3. **Message count display differs** - Individual uses badge; group uses plain text\n4. **Information hierarchy differs** - Individual shows preview; group shows date range\n5. **Color schemes differ** - Individual uses green; group uses purple\n\n<strong>Proposed Solution</strong>\n\nCreate a unified <code>ThreadCard</code> component with:\n\n<code>interface ThreadCardProps {\n  variant: 'individual' | 'group';\n  contactName: string;\n  avatarInitial?: string;\n  avatarColor?: string;\n  phoneNumber?: string;\n  participants?: string[];\n  participantCount?: number;\n  messageCount: number;\n  previewText?: string;\n  dateRange?: { start: Date; end: Date };\n  threadId: string;\n  onView: () => void;\n  onUnlink: () => void;\n}\n</code>\n\n<strong>Design Decisions Needed</strong>\n\n1. Should group chats also show an initial (first participant)?\n2. Should individual chats also show date range?\n3. Unified badge style - should both use badges for message count?\n4. Color coding - keep different colors for visual distinction or unify?\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Single <code>ThreadCard</code> component handles both variants\n\u2610 Consistent spacing and alignment between variants\n\u2610 Consistent badge styling for message counts\n\u2610 Consistent avatar sizing and positioning\n\u2610 Both variants have same hover/interaction states\n\u2610 Existing functionality preserved (view, unlink)\n\u2610 Tests cover both variants\n\n<strong>Files Likely Affected</strong>\n\n\u2022 <code>src/components/transactionDetailsModule/components/MessageThreadCard.tsx</code> (or similar)\n\u2022 May need to create new unified component\n\u2022 Update parent component that renders the cards\n\n<strong>Implementation Notes</strong>\n\n\u2022 Consider using compound component pattern or variant props\n\u2022 Tailwind's <code>cva</code> (class-variance-authority) could help manage variant styles\n\u2022 Ensure accessibility: proper ARIA labels for both variants\n\n<strong>Related</strong>\n\n\u2022 Text Messages section in Transaction Details\n\u2022 <code>MessageThreadCard</code> component (current)\n\n<strong>Screenshots/Reference</strong>\n\nUser provided HTML showing current inconsistent designs.\n\n<strong>Created</strong>\n2026-01-15"
  },
  {
    "id": "BACKLOG-287",
    "title": "Dashboard Visible After Logout",
    "category": "security",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "Auth state not cleared on logout",
    "created_at": "2026-01-15",
    "completed_at": "2026-01-16",
    "file": "PR #437",
    "description": "<strong>Category</strong>\nSecurity, Authentication\n\n<strong>Priority</strong>\n**CRITICAL**\n\n<strong>Status</strong>\nCompleted (PR #437 merged 2026-01-16)\n\n<strong>Description</strong>\n\nAfter logging out, the user can still see the dashboard. This is a security vulnerability - authenticated content should not be visible after logout.\n\n<strong>Steps to Reproduce</strong>\n\n1. Log in to the application\n2. Navigate to dashboard\n3. Log out\n4. Dashboard is still visible (should redirect to login or show unauthenticated state)\n\n<strong>Expected Behavior</strong>\n\nAfter logout:\n\u2022 User should be redirected to login screen\n\u2022 All authenticated routes should be inaccessible\n\u2022 Session data should be cleared\n\u2022 Cached data should not be displayed\n\n<strong>Actual Behavior</strong>\n\nDashboard remains visible after logout, BUT:\n\u2022 \"Browse Transactions\" button doesn't work\n\u2022 \"Manage Contacts\" button doesn't work\n\u2022 \"Start New Audit\" button doesn't work\n\nThis suggests the **session IS cleared** (API calls fail), but the **UI state is stale** (React state not reset, or route guard not triggering).\n\n<strong>Potential Root Causes</strong>\n\n1. **State machine not transitioning** - App state machine may not be updating to <code>unauthenticated</code> state\n2. **Route protection failing** - Protected routes may not be checking auth state correctly\n3. **Session not cleared** - Token/session may still be in memory or storage\n4. **React state caching** - Component state may persist across auth transitions\n5. **OAuth session not revoked** - External provider session may still be active\n\n<strong>Investigation Steps</strong>\n\n1. Check <code>useAppStateMachine.ts</code> - verify logout transitions state correctly\n2. Check route guards in <code>AppRouter.tsx</code> - verify auth checks\n3. Check logout handler in <code>authBridge.ts</code> / <code>auth-handlers.ts</code>\n4. Check if <code>system:initialize-secure-storage</code> clears sessions properly\n5. Check for cached React Query data that persists\n\n<strong>Files Likely Involved</strong>\n\n\u2022 <code>src/hooks/useAppStateMachine.ts</code> - State machine transitions\n\u2022 <code>src/components/AppRouter.tsx</code> - Route protection\n\u2022 <code>electron/auth-handlers.ts</code> - Logout handler\n\u2022 <code>electron/preload/authBridge.ts</code> - Auth bridge\n\u2022 <code>src/services/authService.ts</code> - Client-side auth\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Logout clears all session data\n\u2610 User is redirected to login after logout\n\u2610 Dashboard is not accessible without authentication\n\u2610 Refreshing page after logout shows login screen\n\u2610 No cached data visible after logout\n\n<strong>Security Impact</strong>\n\n**HIGH** - Unauthorized access to user data if device is shared or stolen after logout.\n\n<strong>Related</strong>\n\n\u2022 Authentication flow\n\u2022 Session management\n\u2022 Route protection\n\n<strong>Created</strong>\n2026-01-15\n\n<strong>Reported By</strong>\nUser (manual testing)"
  },
  {
    "id": "BACKLOG-288",
    "title": "Simplify Dashboard Button Labels",
    "category": "ui",
    "priority": "Low",
    "status": "Completed",
    "sprint": "SPRINT-040",
    "est_tokens": "~10K",
    "actual_tokens": "~20K",
    "variance": "PRs #441,443",
    "created_at": "2026-01-15",
    "completed_at": "2026-01-17",
    "file": "-",
    "description": "<strong>Category</strong>\nUI/UX\n\n<strong>Priority</strong>\nLow\n\n<strong>Status</strong>\nPending\n\n<strong>Description</strong>\n\nThe dashboard buttons have verbose labels that could be simplified for a cleaner UI:\n\n<strong>Label Changes</strong>\n\n| Current Label | New Label |\n|---------------|-----------|\n| Start New Audit | New Audit |\n| Browse Transactions | All Audits |\n| Manage Contacts | Contacts |\n\n<strong>Layout Changes</strong>\n\n1. **Remove redundant action text**: Remove the <code><span>View All</span></code> and <code><span>Start Audit</span></code> text from button footers\n2. **Keep arrow icon**: Retain the chevron arrow SVG icon (<code><svg>...<path d=\"M9 5l7 7-7 7\"></path></svg></code>)\n3. **Move arrow next to heading**: Place the arrow icon directly next to the h2 heading (e.g., \"New Audit \u2192\") instead of in the footer\n\n<strong>Visual Result</strong>\n\nBefore:\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Start New Audit     \u2502\n\u2502 description text    \u2502\n\u2502 [Start Audit \u2192]     \u2502  \u2190 remove this footer text, keep arrow\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\nAfter:\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 New Audit \u2192         \u2502  \u2190 arrow next to heading\n\u2502 description text    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n<strong>Rationale</strong>\n\n\u2022 Shorter labels reduce visual clutter\n\u2022 \"Start\" is redundant - clicking a button implies starting\n\u2022 \"Browse\" and \"Manage\" are unnecessary verbs\n\u2022 \"Transactions\" should be \"Audits\" for consistency with domain terminology\n\u2022 Footer action text is redundant when the whole card is clickable\n\u2022 Arrow icon provides clear affordance that the card is clickable\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 \"Start New Audit\" heading displays \"New Audit\"\n\u2610 \"Browse Transactions\" heading displays \"All Audits\"\n\u2610 \"Manage Contacts\" heading displays \"Contacts\"\n\u2610 \"View All\" and \"Start Audit\" span text removed from footers\n\u2610 Arrow SVG icon moved next to the h2 heading\n\u2610 Button functionality remains unchanged\n\u2610 Accessibility labels updated if different from display text\n\n<strong>Files Likely Involved</strong>\n\n\u2022 <code>src/components/Dashboard.tsx</code> or similar dashboard component\n\u2022 Any i18n/localization files if applicable\n\n<strong>Implementation Notes</strong>\n\n\u2022 Simple text change, no logic changes needed\n\u2022 Consider updating any tooltips or aria-labels as well\n\n<strong>Related</strong>\n\n\u2022 Dashboard UI\n\u2022 User experience improvements\n\n<strong>Created</strong>\n2026-01-15\n\n<strong>Reported By</strong>\nUser (feedback)"
  },
  {
    "id": "BACKLOG-289",
    "title": "Unified Notification System",
    "category": "ui",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-040",
    "est_tokens": "~50K",
    "actual_tokens": "~40K",
    "variance": "PR #439",
    "created_at": "2026-01-16",
    "completed_at": "2026-01-17",
    "file": "-",
    "description": "<strong>Category</strong>\nUI/UX, Architecture\n\n<strong>Priority</strong>\nMedium\n\n<strong>Status</strong>\nPending\n\n<strong>Description</strong>\n\nCreate a unified notification system with consistent toast/alert/notification components used across all screens. Currently, notifications may be implemented inconsistently across different parts of the app.\n\n<strong>Goals</strong>\n\n1. **Single notification API** - One way to trigger notifications from anywhere in the app\n2. **Consistent styling** - All notifications look the same (success, error, warning, info)\n3. **Consistent behavior** - Same animation, positioning, auto-dismiss timing\n4. **Accessible** - Proper ARIA roles, keyboard handling, screen reader support\n\n<strong>Proposed API</strong>\n\n<code>// Simple usage\nnotify.success(\"Transaction saved successfully\");\nnotify.error(\"Failed to connect to email provider\");\nnotify.warning(\"Sync may take longer than usual\");\nnotify.info(\"New messages detected\");\n\n// With options\nnotify.success(\"Transaction saved\", {\n  duration: 5000,        // Auto-dismiss after 5s (default: 3s)\n  action: {\n    label: \"View\",\n    onClick: () => navigate(\"/transactions/123\")\n  }\n});\n\n// Persistent (no auto-dismiss)\nnotify.error(\"Connection lost\", { persistent: true });\n</code>\n\n<strong>Component Requirements</strong>\n\n<strong>Toast Component</strong>\n\u2022 Appears in consistent position (top-right or bottom-right)\n\u2022 Stacks multiple notifications\n\u2022 Auto-dismisses after configurable duration\n\u2022 Manual dismiss via X button\n\u2022 Optional action button\n\u2022 Variants: success (green), error (red), warning (yellow), info (blue)\n\n<strong>Context/Provider</strong>\n\u2022 <code>NotificationProvider</code> wraps app\n\u2022 <code>useNotification()</code> hook for triggering\n\u2022 Queue management for multiple notifications\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Single <code>NotificationProvider</code> component at app root\n\u2610 <code>useNotification()</code> hook available throughout app\n\u2610 Consistent toast styling for all notification types\n\u2610 Auto-dismiss with configurable duration\n\u2610 Manual dismiss option\n\u2610 Action button support\n\u2610 Stacking/queue for multiple notifications\n\u2610 Accessible (ARIA, keyboard)\n\u2610 All existing notification patterns migrated to new system\n\n<strong>Files Likely Involved</strong>\n\n\u2022 New: <code>src/components/ui/Notification/</code> or <code>src/components/ui/Toast/</code>\n\u2022 New: <code>src/contexts/NotificationContext.tsx</code>\n\u2022 New: <code>src/hooks/useNotification.ts</code>\n\u2022 Update: <code>src/App.tsx</code> - Add provider\n\u2022 Update: Various components currently showing notifications\n\n<strong>Implementation Notes</strong>\n\n\u2022 Consider using a library like <code>react-hot-toast</code> or <code>sonner</code> as base\n\u2022 Or build custom with Tailwind + Headless UI\n\u2022 Should integrate with existing design system\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-290 (Reusable Sync Progress Component) - may use notifications for sync status\n\u2022 General UX consistency improvements\n\n<strong>Created</strong>\n2026-01-16\n\n<strong>Reported By</strong>\nUser (design sprint planning)"
  },
  {
    "id": "BACKLOG-290",
    "title": "Reusable Sync Progress Component",
    "category": "ui",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-040",
    "est_tokens": "~40K",
    "actual_tokens": "~45K",
    "variance": "PR #440",
    "created_at": "2026-01-16",
    "completed_at": "2026-01-17",
    "file": "-",
    "description": "<strong>Category</strong>\nUI/UX, Architecture\n\n<strong>Priority</strong>\nMedium\n\n<strong>Status</strong>\nPending\n\n<strong>Description</strong>\n\nExtract sync progress UI into a shared, reusable component that's used consistently throughout the app. Currently, sync progress may be implemented differently in various screens (iPhone sync, email sync, data import, etc.).\n\n<strong>Goals</strong>\n\n1. **Single source of truth** - One <code>SyncProgress</code> component used everywhere\n2. **Consistent UX** - Users see the same progress UI regardless of what's syncing\n3. **Flexible** - Works for iPhone sync, email sync, data processing, exports\n4. **Informative** - Shows what's happening, estimated time, and detailed steps\n\n<strong>Proposed Component API</strong>\n\n<code><SyncProgress\n  title=\"Syncing iPhone...\"\n  subtitle=\"Keep your device connected\"\n\n  // Progress\n  progress={78}                    // 0-100 percentage\n  progressText=\"6.2 GB / 8.0 GB\"  // Custom progress text\n\n  // Steps (optional expandable details)\n  steps={[\n    { label: \"Connecting to iPhone\", status: \"complete\", duration: \"0.2s\" },\n    { label: \"Reading storage info\", status: \"complete\", duration: \"1.1s\" },\n    { label: \"Waiting for passcode\", status: \"complete\", duration: \"45s\" },\n    { label: \"Transferring files\", status: \"active\", duration: \"8m 14s\" },\n    { label: \"Reading messages\", status: \"pending\" },\n    { label: \"Saving to database\", status: \"pending\" },\n  ]}\n\n  // Meta info (optional)\n  lastSyncDate={new Date(\"2024-12-11T14:36:00\")}\n  lastSyncSize=\"46.9 GB\"\n\n  // Error state\n  error={syncError}\n  onCopyDiagnostics={() => copyToClipboard(diagnosticReport)}\n\n  // Actions\n  onCancel={() => cancelSync()}\n  onRetry={() => retrySync()}\n/>\n</code>\n\n<strong>Component Variants</strong>\n\n<strong>Compact (for inline/card use)</strong>\n<code>[\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2591\u2591] 78% Syncing messages...\n</code>\n\n<strong>Standard (modal/panel use)</strong>\n<code>\ud83d\udd04 Syncing iPhone...\n[\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2591\u2591\u2591\u2591] 78%\n6.2 GB / 8.0 GB \u2022 Keep connected\n</code>\n\n<strong>Detailed (expandable steps)</strong>\n<code>\ud83d\udd04 Syncing iPhone...\n[\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2591\u2591\u2591\u2591] 78%\n\n\u25bc Show Details\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 \u2713 Connecting to iPhone       0.2s  \u2502\n\u2502 \u2713 Waiting for passcode       45s   \u2502\n\u2502 \u25cf Transferring files...      8m 14s\u2502\n\u2502 \u25cb Reading messages                 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n<strong>Use Cases</strong>\n\n| Screen | Current | With Component |\n|--------|---------|----------------|\n| iPhone Sync Modal | Custom progress UI | <code><SyncProgress variant=\"detailed\" /></code> |\n| Email Sync Status | Badge/text | <code><SyncProgress variant=\"compact\" /></code> |\n| Data Import | Loading spinner | <code><SyncProgress variant=\"standard\" /></code> |\n| Export Progress | Modal with bar | <code><SyncProgress variant=\"standard\" /></code> |\n| Background Sync | None/notification | <code><SyncProgress variant=\"compact\" /></code> |\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Single <code>SyncProgress</code> component with variants (compact, standard, detailed)\n\u2610 Supports progress percentage and custom text\n\u2610 Supports step-by-step checklist (expandable)\n\u2610 Shows last sync info when available\n\u2610 Error state with diagnostic copy button\n\u2610 Cancel and retry action support\n\u2610 Used consistently across all sync/progress screens\n\u2610 Accessible (ARIA progressbar, status updates)\n\n<strong>Files Likely Involved</strong>\n\n\u2022 New: <code>src/components/ui/SyncProgress/SyncProgress.tsx</code>\n\u2022 New: <code>src/components/ui/SyncProgress/SyncProgressSteps.tsx</code>\n\u2022 New: <code>src/components/ui/SyncProgress/types.ts</code>\n\u2022 Update: <code>src/components/iphone/SyncProgress.tsx</code> - Replace or wrap\n\u2022 Update: Any other components showing sync/progress UI\n\n<strong>Implementation Notes</strong>\n\n\u2022 Should handle indeterminate progress (spinner) when percentage unknown\n\u2022 Consider animation for step transitions\n\u2022 Step timing should be human-readable (\"45s\", \"3m 22s\", \"~2 hours\")\n\u2022 Error diagnostic report should include: steps completed, error message, timestamps, device info\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-023 (Detailed Sync Progress) - Original spec for iPhone sync\n\u2022 BACKLOG-289 (Unified Notification System) - May show sync status as notifications\n\u2022 BACKLOG-008 (New Transaction Flow) - May show \"last sync\" info\n\n<strong>Created</strong>\n2026-01-16\n\n<strong>Reported By</strong>\nUser (design sprint planning)"
  },
  {
    "id": "BACKLOG-291",
    "title": "Enhanced Error Diagnostics Report",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-291.md](items/BACKLOG-291.md)",
    "description": "<strong>Category</strong>\nUX, Support, Debugging\n\n<strong>Priority</strong>\nMedium\n\n<strong>Status</strong>\nPending\n\n<strong>Description</strong>\n\nThe current error report shown by ErrorBoundary is minimal. It only includes:\n\u2022 Timestamp\n\u2022 Error message\n\u2022 Stack trace\n\u2022 Component stack\n\nUsers and support need more diagnostic information to debug issues effectively. The error report should include:\n\n1. **Console logs** - Recent console.log/error/warn entries\n2. **Main process logs** - Electron main process log entries (from VS Code terminal)\n3. **System diagnostics** - App version, platform, OS version, memory usage\n4. **Recent user actions** - What screens/actions led to the error\n5. **Network status** - Online/offline, connection issues\n6. **Auth state** - Is user logged in, which providers connected\n\n<strong>Current Error Report</strong>\n\n<code>=== MAGIC AUDIT ERROR REPORT ===\n\nTIMESTAMP: 2026-01-16T23:44:45.278Z\n\nERROR:\nCannot read properties of undefined (reading 'system')\n\nSTACK TRACE:\nTypeError: Cannot read properties of undefined (reading 'system')\n    at LoadingOrchestrator.tsx:43:16\n    ...\n\nCOMPONENT STACK:\n    at LoadingOrchestrator (...)\n    at AppStateProvider (...)\n    ...\n</code>\n\n<strong>Proposed Enhanced Report</strong>\n\n<code>=== MAGIC AUDIT ERROR REPORT ===\n\nTIMESTAMP: 2026-01-16T23:44:45.278Z\nAPP VERSION: 1.1.0\nPLATFORM: darwin (macOS 14.2.1)\nNODE: v20.11.0\nELECTRON: v35.7.5\n\nERROR:\nCannot read properties of undefined (reading 'system')\n\nSTACK TRACE:\nTypeError: Cannot read properties of undefined (reading 'system')\n    at LoadingOrchestrator.tsx:43:16\n    ...\n\nCOMPONENT STACK:\n    at LoadingOrchestrator (...)\n    at AppStateProvider (...)\n    ...\n\nRECENT CONSOLE LOGS (last 50 entries):\n[13:14:53.966] [DeviceHandlers] Registering device detection handlers\n[13:14:53.969] [BackupHandlers] Registering backup handlers\n[13:14:54.504] [DatabaseService] Initializing database\n...\n\nRECENT USER ACTIONS:\n1. App launched\n2. Google login initiated\n3. Google login completed\n4. Transaction scan started\n5. Error occurred in LoadingOrchestrator\n\nSYSTEM STATE:\n\u2022 Auth: Logged in (userId: 22db6971...)\n\u2022 Email providers: Google (connected)\n\u2022 Database: Initialized\n\u2022 Network: Online\n\u2022 Last sync: 2026-01-16T21:15:06Z\n\n=== END REPORT ===\n</code>\n\n<strong>Implementation Requirements</strong>\n\n<strong>1. Console Log Capture</strong>\n\nCreate a ring buffer to capture recent console logs:\n\n<code>// src/utils/consoleCapture.ts\nconst logBuffer: LogEntry[] = [];\nconst MAX_LOGS = 100;\n\nconst originalConsole = {\n  log: console.log,\n  error: console.error,\n  warn: console.warn,\n};\n\nexport function initConsoleCapture() {\n  ['log', 'error', 'warn'].forEach(method => {\n    console[method] = (...args) => {\n      logBuffer.push({\n        timestamp: new Date().toISOString(),\n        level: method,\n        message: args.map(a => String(a)).join(' '),\n      });\n      if (logBuffer.length > MAX_LOGS) logBuffer.shift();\n      originalConsole[method](...args);\n    };\n  });\n}\n\nexport function getRecentLogs(): LogEntry[] {\n  return [...logBuffer];\n}\n</code>\n\n<strong>2. Main Process Log Forwarding</strong>\n\nForward main process logs to renderer via IPC for inclusion in reports:\n\n<code>// In main process\nipcMain.handle('system:get-main-process-logs', () => {\n  return mainProcessLogBuffer;  // Similar ring buffer in main\n});\n</code>\n\n<strong>3. System Diagnostics Enhancement</strong>\n\nExpand <code>system:get-diagnostics</code> to include more info:\n\n<code>{\n  appVersion: '1.1.0',\n  platform: 'darwin',\n  osVersion: '14.2.1',\n  nodeVersion: 'v20.11.0',\n  electronVersion: 'v35.7.5',\n  memoryUsage: process.memoryUsage(),\n  uptime: process.uptime(),\n  dbInitialized: true,\n  authState: { loggedIn: true, userId: '...', providers: ['google'] },\n  networkOnline: true,\n  lastSyncTime: '2026-01-16T21:15:06Z',\n}\n</code>\n\n<strong>4. User Action Tracking</strong>\n\nTrack recent navigation/actions for debugging:\n\n<code>// src/utils/actionTracker.ts\nconst actionBuffer: string[] = [];\nconst MAX_ACTIONS = 20;\n\nexport function trackAction(action: string) {\n  actionBuffer.push(<code>${new Date().toISOString()} - ${action}</code>);\n  if (actionBuffer.length > MAX_ACTIONS) actionBuffer.shift();\n}\n\nexport function getRecentActions(): string[] {\n  return [...actionBuffer];\n}\n</code>\n\n<strong>5. ErrorBoundary Enhancement</strong>\n\nUpdate ErrorBoundary to collect and display all diagnostic info:\n\n<code>// In ErrorBoundary.tsx getDiagnosticsReport()\nconst report = <code>\n=== MAGIC AUDIT ERROR REPORT ===\n\n${await getSystemDiagnostics()}\n\nERROR:\n${error.message}\n\nSTACK TRACE:\n${error.stack}\n\nCOMPONENT STACK:\n${componentStack}\n\nRECENT CONSOLE LOGS:\n${getRecentLogs().map(l => </code>[${l.timestamp}] ${l.level}: ${l.message}<code>).join('\\n')}\n\nRECENT USER ACTIONS:\n${getRecentActions().join('\\n')}\n\n=== END REPORT ===\n</code>;\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Console logs captured in ring buffer (last 100 entries)\n\u2610 Main process logs accessible from renderer\n\u2610 System diagnostics include app version, platform, OS version\n\u2610 User actions tracked (navigation, key events)\n\u2610 Error report includes all diagnostic sections\n\u2610 \"Copy Report\" button copies full enhanced report\n\u2610 Report is formatted for easy reading and parsing\n\u2610 No PII in reports (mask user IDs, emails)\n\n<strong>Files Likely Involved</strong>\n\n\u2022 <code>src/components/ErrorBoundary.tsx</code> - Main error UI\n\u2022 New: <code>src/utils/consoleCapture.ts</code> - Console log capture\n\u2022 New: <code>src/utils/actionTracker.ts</code> - User action tracking\n\u2022 <code>electron/system-handlers.ts</code> - Enhanced diagnostics IPC\n\u2022 <code>electron/services/systemService.ts</code> - Diagnostics service\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-023 (Detailed Sync Progress) - Error diagnostics for sync\n\u2022 BACKLOG-289 (Unified Notification System) - Error notifications\n\n<strong>Created</strong>\n2026-01-16\n\n<strong>Reported By</strong>\nUser (error debugging session)"
  },
  {
    "id": "BACKLOG-292",
    "title": "Resolve Preload Script __DEV__ Undefined Error",
    "category": "infra",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "~10K",
    "actual_tokens": "~5K",
    "variance": "-50%",
    "created_at": "2026-01-16",
    "completed_at": "2026-01-18",
    "file": "PR #438",
    "description": "<strong>Category</strong>\nBuild, Infrastructure\n\n<strong>Priority</strong>\nCritical\n\n<strong>Status</strong>\nIn Progress\n\n<strong>Description</strong>\n\nThe app crashes on startup with <code>ReferenceError: __DEV__ is not defined</code> in the preload script. This prevents the app from loading entirely.\n\n<strong>Error Details</strong>\n\n<code>Unable to load preload script: /Users/daniel/Documents/Mad/dist-electron/preload.js\n\nReferenceError: __DEV__ is not defined\n    at Object.<anonymous> (systemBridge.js:10:24)\n</code>\n\nThis causes a cascade failure:\n1. Preload script fails to load\n2. <code>window.api</code> is undefined\n3. <code>LoadingOrchestrator.tsx:68</code> tries to access <code>window.api.system</code> \u2192 crash\n\n<strong>Root Cause</strong>\n\n**Build process conflict between tsc and esbuild:**\n\n1. <code>npm run dev</code> executes:\n   - <code>build:electron</code> (tsc) - compiles ALL electron files including preload\n   - <code>build:preload:dev</code> (esbuild) - bundles preload with <code>--define:__DEV__=true</code>\n   - <code>concurrently</code> runs <code>watch:electron</code> (tsc --watch)\n\n2. <code>watch:electron</code> (tsc) continuously overwrites <code>dist-electron/preload.js</code> with non-bundled TypeScript output\n\n3. The tsc output doesn't have <code>__DEV__</code> defined (esbuild defines it at bundle time)\n\n4. Result: preload.js alternates between working (esbuild) and broken (tsc) versions\n\n<strong>Evidence</strong>\n\n**Broken preload.js (tsc output - 2.4kb):**\n<code>\"use strict\";\nconst index_1 = require(\"./preload/index\");  // Uses relative imports\n</code>\n\n**Working preload.js (esbuild output - 61.6kb):**\n<code>\"use strict\";\n// electron/preload.ts\nvar import_electron12 = require(\"electron\");\n// All modules bundled inline, __DEV__ replaced with true\n</code>\n\n<strong>Solution</strong>\n\n1. **Exclude preload from tsc** - Add to <code>tsconfig.electron.json</code>:\n   <code>   \"exclude\": [\n     \"electron/preload.ts\",\n     \"electron/preload/**/*\"\n   ]\n   </code>\n\n2. **Add watch:preload to dev script** - Update <code>package.json</code>:\n   <code>   \"dev\": \"... concurrently ... \\\"npm run watch:preload\\\"\"\n   </code>\n\nThis ensures:\n\u2022 tsc handles main process files only\n\u2022 esbuild handles preload bundling exclusively\n\u2022 Both can watch for changes without conflict\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>npm run dev</code> starts without __DEV__ errors\n\u2610 Preload script properly bundled (60kb+, not 2kb)\n\u2610 <code>window.api</code> available in renderer\n\u2610 App loads to login/dashboard screen\n\u2610 Changes to preload files trigger esbuild rebuild\n\n<strong>Files to Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>tsconfig.electron.json</code> | Exclude preload files from compilation |\n| <code>package.json</code> | Add <code>watch:preload</code> to dev/start scripts |\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-291 (Enhanced Error Diagnostics) - Would help debug issues like this\n\n<strong>Created</strong>\n2026-01-16\n\n<strong>Reported By</strong>\nUser (startup crash)"
  },
  {
    "id": "BACKLOG-293",
    "title": "Duplicate macOS Messages Sync on Dashboard Load",
    "category": "fix",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-041",
    "est_tokens": "~20K",
    "actual_tokens": "~15K",
    "variance": "-25%",
    "created_at": "2026-01-16",
    "completed_at": "2026-01-17",
    "file": "PR (TASK-1113)",
    "description": "<strong>Summary</strong>\n\nReturning users see the macOS Messages sync running twice when opening the dashboard. The sync appears to trigger redundantly, processing 678K+ messages twice in a row.\n\n---\n\n<strong>Observed Behavior</strong>\n\nUser reported seeing sync logs appear twice on initial dashboard load:\n\n<code>[1] 2026-01-17T01:31:18.141Z INFO  [MacOSMessagesImportService] Fetched 678041 messages and 62952 attachments in macOS Messages\n[1] 2026-01-17T01:31:18.141Z INFO  [MacOSMessagesImportService] Loading existing message IDs for deduplication...\n[1] 2026-01-17T01:31:23.144Z INFO  [MacOSMessagesImportService] Found 675014 existing messages\n[1] 2026-01-17T01:31:23.144Z INFO  [MacOSMessagesImportService] Processing 678041 messages in 1357 batches\n[1] 2026-01-17T01:31:23.631Z INFO  [MacOSMessagesImportService] Processing 62952 attachments, 28871 already stored\n</code>\n\nThis indicates the full sync process is being triggered multiple times for returning users.\n\n---\n\n<strong>Expected Behavior</strong>\n\n\u2022 Sync should only trigger once on dashboard load\n\u2022 If sync was recently completed, should use cached/last sync state\n\u2022 Deduplication should prevent redundant processing, but the sync shouldn't even start twice\n\n---\n\n<strong>Potential Causes</strong>\n\n1. **React StrictMode double-mount** (dev only) - Effects run twice in development\n2. **Multiple sync triggers** - Sync may be called from:\n   - Login completion handler\n   - Dashboard mount effect\n   - BackgroundServices component\n3. **Race condition** - Multiple components checking \"should sync\" before any sync starts\n4. **Missing sync-in-progress guard** - No mutex/lock preventing concurrent syncs\n\n---\n\n<strong>Investigation Areas</strong>\n\n1. Check <code>BackgroundServices</code> component for sync trigger logic\n2. Check <code>useAppStateMachine</code> for state transitions that trigger sync\n3. Check if <code>MacOSMessagesImportService</code> has a \"sync in progress\" guard\n4. Review useEffect dependencies in dashboard-related components\n\n---\n\n<strong>Files to Investigate</strong>\n\n\u2022 <code>src/appCore/BackgroundServices.tsx</code>\n\u2022 <code>src/hooks/useAppStateMachine.ts</code>\n\u2022 <code>electron/services/MacOSMessagesImportService.ts</code>\n\u2022 <code>src/screens/Dashboard.tsx</code>\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Sync triggers exactly once on dashboard load for returning users\n\u2610 Sync-in-progress state prevents duplicate sync triggers\n\u2610 No regression in initial sync for new users\n\u2610 Performance: 678K messages shouldn't be fetched/processed twice"
  },
  {
    "id": "BACKLOG-294",
    "title": "Extract Reusable DashboardActionCard Component",
    "category": "refactor",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "DRY refactor for dashboard buttons",
    "created_at": "2026-01-16",
    "completed_at": "",
    "file": "[BACKLOG-294.md](BACKLOG-294.md)",
    "description": "<strong>Summary</strong>\n\nExtract a reusable <code>DashboardActionCard</code> component from the repeated button patterns in Dashboard.tsx. All three action buttons (New Audit, All Audits, Contacts) now share the same layout pattern and should be consolidated.\n\n---\n\n<strong>Current State</strong>\n\nDashboard.tsx has three buttons with near-identical structure:\n\u2022 Icon on the left (gradient background, rounded)\n\u2022 Title text in the middle\n\u2022 Optional badge (for pending count)\n\u2022 Arrow icon on the right with hover animation\n\nEach button is ~30 lines of JSX with repeated patterns.\n\n---\n\n<strong>Proposed Component</strong>\n\n<code>interface DashboardActionCardProps {\n  title: string;\n  icon: React.ReactNode;\n  iconGradient: string; // e.g., \"from-blue-500 to-purple-600\"\n  arrowColor: string;   // e.g., \"text-blue-600\"\n  hoverBorder: string;  // e.g., \"hover:border-blue-500\"\n  onClick: () => void;\n  badge?: {\n    count: number;\n    label: string;\n  };\n  highlight?: boolean;  // For the ring effect when pending\n  dataTour?: string;\n}\n\nfunction DashboardActionCard({ ... }: DashboardActionCardProps) {\n  // Unified button rendering\n}\n</code>\n\n---\n\n<strong>Benefits</strong>\n\n\u2022 **DRY**: Remove ~60 lines of duplicated JSX\n\u2022 **Consistency**: Single source of truth for button styling\n\u2022 **Maintainability**: Style changes apply to all buttons at once\n\u2022 **Testability**: One component to test instead of three inline buttons\n\n---\n\n<strong>Files to Modify</strong>\n\n\u2022 <code>src/components/Dashboard.tsx</code> - Replace inline buttons with component\n\u2022 Create <code>src/components/dashboard/DashboardActionCard.tsx</code>\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 DashboardActionCard component created\n\u2610 All three dashboard buttons use the component\n\u2610 Visual appearance unchanged\n\u2610 Hover effects and animations preserved\n\u2610 Pending badge functionality preserved\n\u2610 data-tour attributes preserved\n\u2610 Tests added for the new component"
  },
  {
    "id": "BACKLOG-295",
    "title": "Transaction Header Responsive Layout",
    "category": "ui",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-040",
    "est_tokens": "~18K",
    "actual_tokens": "~18K",
    "variance": "PR #449",
    "created_at": "2026-01-17",
    "completed_at": "2026-01-17",
    "file": "-",
    "description": "<strong>Problem Statement</strong>\n\nOn narrow viewports, the Transaction Details panel header becomes cramped with overlapping UI elements. The current layout places the title/address and action buttons on the same row, which causes usability issues when horizontal space is limited.\n\n---\n\n<strong>Current Behavior</strong>\n\nThe header uses a single-row <code>flex items-center justify-between</code> layout:\n\n<code>[Transaction Details] [Address] [Edit] [Reject] [Export] [X]\n</code>\n\nAll elements are inline, leading to:\n\u2022 Cramped buttons on narrow screens\n\u2022 Potential text truncation or overlap\n\u2022 Poor touch target spacing on smaller devices\n\n---\n\n<strong>Desired Behavior</strong>\n\nOn narrow viewports, the header should stack vertically into two rows:\n\n**Top Row:**\n<code>[Transaction Details Title] [Address] [X (close)]\n</code>\n\n**Bottom Row:**\n<code>[Edit] [Reject] [Export]\n</code>\n\nThis provides:\n\u2022 Better button spacing and touch targets\n\u2022 Preserved title/address visibility\n\u2022 Close button remains accessible in top-right\n\n---\n\n<strong>Technical Analysis</strong>\n\n<strong>Affected Component</strong>\n\n**File:** <code>src/components/transactionDetailsModule/components/TransactionHeader.tsx</code>\n\n<strong>Current Structure (lines 58-124)</strong>\n\n<code><div className={<code>flex-shrink-0 px-6 py-4 flex items-center justify-between rounded-t-xl ${getHeaderStyle()}</code>}>\n  {/* Left side: Title + Address */}\n  <div>\n    <div className=\"flex items-center gap-2\">\n      <h3 className=\"text-xl font-bold text-white\">{getHeaderTitle()}</h3>\n      {/* Status badges */}\n    </div>\n    <p className={<code>text-sm ${getHeaderTextStyle()}</code>}>{transaction.property_address}</p>\n  </div>\n\n  {/* Right side: Action buttons + Close */}\n  <div className=\"flex items-center gap-2\">\n    {/* Conditional action buttons (Edit/Reject/Export/etc) */}\n    <button onClick={onClose}>X</button>\n  </div>\n</div>\n</code>\n\n<strong>Proposed Solution</strong>\n\nUse Tailwind responsive utilities to switch layouts:\n\n1. Wrap the entire header in a responsive container:\n   - Default (mobile): <code>flex-col</code> with stacked rows\n   - Wide screens (<code>md:</code> or <code>lg:</code>): <code>flex-row items-center justify-between</code>\n\n2. Restructure action buttons section:\n   - Move close button to the title row (right side)\n   - Action buttons in their own row on narrow viewports\n\n3. Consider breakpoints:\n   - <code>sm:</code> (640px) or <code>md:</code> (768px) as the transition point\n\n<strong>Alternative Approaches</strong>\n\n1. **CSS-only with flex-wrap**: Use <code>flex-wrap</code> and let items naturally wrap\n2. **Drawer/dropdown for actions**: Collapse actions into a menu on narrow viewports\n3. **Fixed breakpoint stacking**: Explicit layout change at specific width (recommended)\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Header layout stacks vertically on narrow viewports (< 768px recommended)\n\u2610 Top row contains: title, status badge, address, and close button\n\u2610 Bottom row contains: action buttons (Edit, Reject, Export, etc.)\n\u2610 Layout returns to single-row on wider viewports\n\u2610 Close button remains in top-right corner at all viewport sizes\n\u2610 No visual regressions on desktop/wide screens\n\u2610 Buttons maintain adequate touch target size (min 44x44px recommended)\n\u2610 Works for all header states: active, pending review, rejected\n\n---\n\n<strong>Estimated Effort</strong>\n\n| Phase | Turns | Tokens | Time |\n|-------|-------|--------|------|\n| Layout refactor | 2-3 | ~8K | 15m |\n| Responsive utilities | 1-2 | ~4K | 10m |\n| State variations testing | 1-2 | ~4K | 10m |\n| Visual QA | 1 | ~2K | 5m |\n| **Total** | **5-8** | **~18K** | **~40m** |\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 None (isolated UI component change)\n\n---\n\n<strong>Testing Requirements</strong>\n\n<strong>Manual Testing</strong>\n\u2022 Resize browser to verify breakpoint behavior\n\u2022 Test all header states (active, pending review, rejected)\n\u2022 Verify button functionality preserved after layout change\n\u2022 Check on actual narrow devices if available\n\n<strong>Visual Testing</strong>\n\u2022 Screenshot comparison at various viewport widths\n\u2022 Verify no overlap or truncation at edge cases\n\n---\n\n<strong>References</strong>\n\n\u2022 Component: <code>src/components/transactionDetailsModule/components/TransactionHeader.tsx</code>\n\u2022 Tailwind responsive docs: https://tailwindcss.com/docs/responsive-design\n\u2022 Related: Transaction details panel styling\n\n---\n\n<strong>Notes</strong>\n\nConsider coordinating with other responsive improvements if planned (e.g., sidebar collapse, mobile navigation) to ensure consistent breakpoint usage across the application."
  },
  {
    "id": "BACKLOG-296",
    "title": "Database Schema Alignment - Service Updates",
    "category": "refactor",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-042",
    "est_tokens": "~40K",
    "actual_tokens": "~35K",
    "variance": "-12%",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "PR #462",
    "description": "<strong>Problem Statement</strong>\n\nThe SR Engineer completed a comprehensive database schema audit identifying **14 architectural findings**. The recent thread-based schema refactor (SPRINT-036) addressed the communications/messages relationship, but exposed that several services still query the old schema patterns.\n\n<strong>Immediate Issue</strong>\n\nServices are querying columns that no longer exist or have been deprecated:\n\u2022 <code>communications.communication_type</code> - Channel is now in <code>messages.channel</code>\n\u2022 <code>communications.sender</code> - Participants now in <code>messages.participants</code>\n\u2022 <code>communications.recipients</code> - Participants now in <code>messages.participants</code>\n\n<strong>New Architecture Summary</strong>\n\n| Old Pattern | New Pattern |\n|-------------|-------------|\n| <code>communications.communication_type</code> | <code>messages.channel</code> (via JOIN) |\n| <code>communications.sender</code> | <code>messages.participants</code> (JSON) |\n| <code>communications.recipients</code> | <code>messages.participants</code> (JSON) |\n| <code>communications</code> stores email content | <code>communications</code> is junction table linking <code>thread_id</code> to <code>transaction_id</code> |\n| Content in communications table | Content in <code>messages</code> table |\n\n---\n\n<strong>Affected Services (Confirmed)</strong>\n\n<strong>1. autoLinkService.ts (CRITICAL)</strong>\n\n**Lines 191-231** query communications table assuming it stores email content:\n\n<code>// Current (broken):\n.map(() => \"(LOWER(c.sender) LIKE ? OR LOWER(c.recipients) LIKE ?)\")\n...\nAND c.communication_type = 'email'\n</code>\n\n**Impact:** Auto-linking cannot find emails to link to transactions.\n\n<strong>2. enhancedExportService.ts (HIGH)</strong>\n\n**Lines 153, 157, 326, 393, 440, 456, 572, 577** filter by <code>communication_type</code>:\n\n<code>// Current (broken):\ncommunications.filter((c) => c.communication_type === \"email\")\ncommunications.filter((c) => c.communication_type === \"text\")\n</code>\n\n**Impact:** Exports show wrong counts, missing content.\n\n<strong>3. folderExportService.ts (HIGH)</strong>\n\n**Lines 70-71, 101-102, 245-246** filter by <code>communication_type</code>:\n\n<code>// Current (broken):\nemailCount: communications.filter((c) => c.communication_type === \"email\").length\ntextCount: communications.filter((c) => c.communication_type === \"text\").length\n</code>\n\n**Impact:** Folder exports have incorrect categorization.\n\n<strong>4. pdfExportService.ts (HIGH)</strong>\n\n**Lines 511-518** check <code>communication_type</code>:\n\n<code>// Current (broken):\nc.communication_type === 'email' ||\nc.communication_type === 'sms' ||\nc.communication_type === 'imessage'\n</code>\n\n**Impact:** PDF exports may miscategorize communications.\n\n<strong>5. messageMatchingService.ts (MEDIUM)</strong>\n\nContains <code>communication_type</code> references - needs verification.\n\n---\n\n<strong>Schema Audit Findings to Address</strong>\n\nFull audit document: <code>.claude/docs/DATABASE-SCHEMA-AUDIT.md</code> (on <code>research/database-schema-audit</code> branch)\n\n<strong>CRITICAL Priority</strong>\n\n| Finding | Description | Status |\n|---------|-------------|--------|\n| FINDING-01 | Duplicate junction tables (transaction_participants vs transaction_contacts) | TODO |\n| FINDING-02 | Stale column reference in extracted_transaction_data (source_communication_id vs source_message_id) | TODO |\n| FINDING-03 | Orphaned feedback service code (queries deleted user_feedback table) | TODO |\n\n<strong>HIGH Priority</strong>\n\n| Finding | Description | Status |\n|---------|-------------|--------|\n| FINDING-04 | Dead FK columns on transactions (buyer_agent_id, seller_agent_id, etc.) | TODO |\n| FINDING-05 | Communications table legacy content duplication (20+ columns) | PARTIAL (addressed by thread refactor) |\n| FINDING-06 | Missing FK constraints on multiple tables | TODO |\n\n<strong>MEDIUM Priority</strong>\n\n| Finding | Description | Status |\n|---------|-------------|--------|\n| FINDING-07 | Inconsistent naming conventions | TODO (documentation) |\n| FINDING-08 | Redundant role storage in transaction_contacts | TODO |\n| FINDING-09 | JSON storage patterns inconsistent | TODO |\n| FINDING-10 | Potential orphan data risks (ON DELETE behaviors) | TODO |\n| FINDING-11 | Index coverage gaps | TODO |\n\n<strong>LOW Priority</strong>\n\n| Finding | Description | Status |\n|---------|-------------|--------|\n| FINDING-12 | Schema version tracking inconsistency | TODO |\n| FINDING-13 | CHECK constraint inconsistencies | TODO |\n| FINDING-14 | Deprecated fields still in schema | TODO (documented for future cleanup) |\n\n---\n\n<strong>Implementation Phases</strong>\n\n<strong>Phase 1: Critical Service Updates (Sprint-ready)</strong>\n\nUpdate services to work with new schema:\n\n1. **Update autoLinkService.ts**\n   - Join communications -> messages to access content\n   - Query <code>messages.channel</code> instead of <code>communication_type</code>\n   - Query <code>messages.participants</code> for sender/recipients\n   - Estimated: 2-3K tokens\n\n2. **Update enhancedExportService.ts**\n   - Change all <code>communication_type</code> filters to <code>channel</code>\n   - Ensure proper JOIN to messages table\n   - Estimated: 3-4K tokens\n\n3. **Update folderExportService.ts**\n   - Change type filters\n   - Verify export structure matches new data model\n   - Estimated: 2K tokens\n\n4. **Update pdfExportService.ts**\n   - Change type checks\n   - Verify PDF content rendering\n   - Estimated: 2K tokens\n\n5. **Update messageMatchingService.ts**\n   - Verify and update any communication_type usage\n   - Estimated: 1K tokens\n\n<strong>Phase 2: Data Integrity Fixes</strong>\n\n1. **Consolidate junction tables (FINDING-01)**\n   - Migrate transaction_participants data to transaction_contacts\n   - Update transaction_summary view\n   - Drop transaction_participants table\n   - Estimated: 3-4K tokens\n\n2. **Fix extracted_transaction_data (FINDING-02)**\n   - Update communicationDbService.ts to use source_message_id\n   - Migration to fix existing data\n   - Estimated: 2K tokens\n\n3. **Remove orphaned feedback service (FINDING-03)**\n   - Delete feedbackDbService.ts\n   - Remove any references\n   - Estimated: 1K tokens\n\n<strong>Phase 3: Schema Hardening</strong>\n\n1. **Add missing FK constraints (FINDING-06)**\n   - Add FKs for transaction contact columns\n   - Add FK for ignored_communications\n   - Estimated: 2K tokens\n\n2. **Remove dead FK columns (FINDING-04)**\n   - Migration to drop buyer_agent_id, seller_agent_id, etc.\n   - Update contactDbService backward compatibility code\n   - Estimated: 2-3K tokens\n\n3. **Drop legacy communications columns (FINDING-05)**\n   - Final cleanup of 20+ deprecated columns\n   - Update any remaining COALESCE queries\n   - Estimated: 3K tokens\n\n<strong>Phase 4: Index & Constraint Optimization</strong>\n\n1. **Add missing indexes (FINDING-11)**\n   - Composite indexes for common query patterns\n   - Estimated: 1K tokens\n\n2. **Fix CHECK constraints (FINDING-13)**\n   - Add 'archived' to transactions status\n   - Align 'text' vs 'sms' naming\n   - Estimated: 1K tokens\n\n3. **Normalize role storage (FINDING-08)**\n   - Consolidate role/role_category/specific_role\n   - Migration for existing data\n   - Estimated: 2K tokens\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n<strong>Phase 1 Complete</strong>\n\u2610 All export services produce correct output with new schema\n\u2610 Auto-linking correctly finds emails by contact email address\n\u2610 No runtime errors in affected services\n\u2610 Existing tests pass (update if needed)\n\n<strong>Phase 2 Complete</strong>\n\u2610 Single source of truth for transaction contacts\n\u2610 extracted_transaction_data correctly references messages\n\u2610 No dead code referencing deleted tables\n\n<strong>Phase 3 Complete</strong>\n\u2610 All FKs enforced at database level\n\u2610 No duplicate storage of contact assignments\n\u2610 Communications table is lean junction table\n\n<strong>Phase 4 Complete</strong>\n\u2610 Query performance improved for common patterns\n\u2610 Consistent naming and constraints\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 **SPRINT-036** (Completed): Thread-based message parsing\n\u2022 **Research Branch**: <code>research/database-schema-audit</code> contains full audit\n\n<strong>Risks</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Data loss during migration | Backup before each migration, reversible steps |\n| Breaking queries | Phase 1 focuses on reads, verify before writes |\n| Export format changes | Verify output matches expected format |\n\n---\n\n<strong>Related</strong>\n\n\u2022 <code>.claude/docs/DATABASE-SCHEMA-AUDIT.md</code> (on research branch)\n\u2022 SPRINT-036: Deterministic Message Parsing\n\u2022 BACKLOG-230: NULL thread_id Investigation\n\n---\n\n<strong>Estimated Total Effort</strong>\n\n| Phase | Estimated Tokens | Sprint Sizing |\n|-------|-----------------|---------------|\n| Phase 1 | 10-12K | 1 sprint |\n| Phase 2 | 6-8K | 1 sprint |\n| Phase 3 | 7-8K | 1 sprint |\n| Phase 4 | 4-5K | 0.5 sprint |\n| **Total** | **27-33K** | **3-4 sprints** |\n\n---\n\n<strong>Notes</strong>\n\nThis backlog item consolidates all schema-related technical debt identified by the SR Engineer audit. Individual tasks should be created when sprint planning begins. Phase 1 is the most urgent as it directly affects current functionality."
  },
  {
    "id": "BACKLOG-297",
    "title": "Startup Error Handling - User-Friendly Failure Screen",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~50K",
    "actual_tokens": "-",
    "variance": "Timeout + error screen on init failure",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-297.md](BACKLOG-297.md)",
    "description": "| Field | Value |\n|-------|-------|\n| **ID** | BACKLOG-297 |\n| **Title** | Startup Error Handling - User-Friendly Failure Screen |\n| **Type** | Enhancement |\n| **Priority** | Medium |\n| **Status** | Backlog |\n| **Created** | 2025-01-17 |\n| **Category** | UX / Error Handling |\n\n<strong>Problem Statement</strong>\n\nWhen the app fails to initialize (e.g., database schema mismatch, migration failure, native module issues), it shows \"Starting Magic Audit...\" indefinitely. The user has no visibility into what's wrong - the app just loops forever on the splash screen.\n\n<strong>Current Behavior</strong>\n\nUser sees: \"Starting Magic Audit...\" (forever)\n\nMeanwhile in logs:\n<code>ERROR [DatabaseService] Failed to initialize database\n{\n  \"error\": \"no such column: sent_at\"\n}\nERROR [SystemHandlers] Database initialization failed\n</code>\n\nThe user has no indication anything is wrong and no path to resolution.\n\n<strong>Impact</strong>\n\n\u2022 Users abandon the app thinking it's broken\n\u2022 Support burden increases (users report \"app won't start\")\n\u2022 No actionable information for troubleshooting\n\u2022 Poor first impression for new users\n\n<strong>Requested Behavior</strong>\n\n<strong>1. Startup Timeout (30 seconds)</strong>\n\nAdd a timeout on the startup/splash screen. If initialization does not complete within 30 seconds, transition to the error screen.\n\n<strong>2. User-Friendly Error Screen</strong>\n\nWhen initialization fails OR times out, display an error screen with:\n\n| Element | Content |\n|---------|---------|\n| **Heading** | \"Magic Audit encountered an error during startup\" |\n| **Error Summary** | Sanitized error message (no stack traces, no file paths) |\n| **Instructions** | \"Please contact support at [email/link]\" |\n| **Actions** | \"Try Again\" button, \"View Logs\" button |\n\n<strong>3. \"Try Again\" Action</strong>\n\n\u2022 Attempt re-initialization from scratch\n\u2022 Show splash screen again with timeout\n\u2022 If fails again, return to error screen\n\n<strong>4. \"View Logs\" Action</strong>\n\n\u2022 Open the app's log file location in the system file explorer\n\u2022 Or display last N lines of relevant logs in a modal\n\n<strong>5. Detailed Logging</strong>\n\nEnsure full error details are logged for debugging:\n\u2022 Error message and stack trace\n\u2022 Initialization phase that failed\n\u2022 System information (OS, Electron version)\n\u2022 Database state if available\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Splash screen has a 30-second timeout\n\u2610 Timeout or initialization failure shows error screen\n\u2610 Error screen displays user-friendly message\n\u2610 \"Try Again\" button attempts re-initialization\n\u2610 \"View Logs\" button helps users find/view logs\n\u2610 Full error details logged for developer debugging\n\u2610 Error screen is styled consistently with app design\n\u2610 Works on both macOS and Windows\n\n<strong>Technical Considerations</strong>\n\n<strong>Affected Components</strong>\n\n| Component | Changes |\n|-----------|---------|\n| <code>SplashScreen</code> / Loading component | Add timeout logic |\n| <code>useAppStateMachine</code> or equivalent | Add error state, timeout transition |\n| New <code>StartupErrorScreen</code> component | Error display, retry, view logs |\n| <code>App.tsx</code> | Route to error screen on failure |\n| Main process IPC | Expose log file path |\n\n<strong>Error Categories to Handle</strong>\n\n1. **Database initialization failure** - Schema mismatch, migration failure, corruption\n2. **Native module failure** - better-sqlite3 version mismatch\n3. **Configuration error** - Missing required settings\n4. **Timeout** - Any initialization taking > 30s\n5. **Unknown error** - Catch-all for unexpected failures\n\n<strong>Error Message Sanitization</strong>\n\nAvoid exposing in UI:\n\u2022 Full file paths (could contain usernames)\n\u2022 Stack traces\n\u2022 Internal service names\n\u2022 SQL statements\n\nShow in UI:\n\u2022 General error category\n\u2022 Brief explanation\n\u2022 Error code if available\n\n<strong>Estimation</strong>\n\n| Aspect | Estimate |\n|--------|----------|\n| Complexity | Medium |\n| Effort | 3-5 tasks |\n| Risk | Low |\n\n<strong>Related Items</strong>\n\n\u2022 Native module rebuild issues (documented in CLAUDE.md)\n\u2022 Database migration system\n\u2022 App state machine\n\n<strong>Notes</strong>\n\nThis is a UX improvement that will significantly reduce support burden and improve user experience when things go wrong. The implementation should be defensive - we want to catch and display errors gracefully rather than leaving users stranded."
  },
  {
    "id": "BACKLOG-298",
    "title": "Video Attachment Support in ConversationViewModal",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~35K",
    "actual_tokens": "-",
    "variance": "Videos filtered out, only images displayed",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-298.md](BACKLOG-298.md)",
    "description": "<strong>Type</strong>\nFeature Enhancement\n\n<strong>Priority</strong>\nMedium\n\n<strong>Status</strong>\nOpen\n\n<strong>Summary</strong>\nConversationViewModal only displays standard image attachments (<code>image/*</code> excluding HEIC). Non-image attachments like HEIC photos (<code>.heic</code>, <code>image/heic</code>), videos (<code>.mov</code>, <code>.mp4</code>), and other file types are filtered out and not displayed to users.\n\n<strong>Problem</strong>\nThe <code>isDisplayableImage()</code> function in <code>ConversationViewModal.tsx</code> (line 82-87) only accepts MIME types starting with <code>image/</code> and explicitly excludes HEIC:\n\n<code>function isDisplayableImage(mimeType: string | null): boolean {\n  if (!mimeType) return false;\n  return (\n    mimeType.startsWith(\"image/\") &&\n    !mimeType.includes(\"heic\") // HEIC requires conversion\n  );\n}\n</code>\n\nThis causes all of the following to be silently ignored:\n\u2022 HEIC images (common iPhone photo format)\n\u2022 Video attachments (<code>.mov</code>, <code>.mp4</code>, <code>.webm</code>)\n\u2022 Other file types (PDFs, documents, etc.)\n\nUsers expect to see these attachments in conversations, at minimum as clickable references that open in their default system application.\n\n<strong>Affected Files</strong>\n\u2022 <code>src/components/transactionDetailsModule/components/modals/ConversationViewModal.tsx</code>\n\u2022 <code>electron/preload/systemBridge.ts</code> (add openFile)\n\u2022 <code>electron/system-handlers.ts</code> (add handler)\n\n<strong>Solution Options</strong>\n\n<strong>Option A: Full Media Support (Complex)</strong>\n\u2022 Convert HEIC to displayable format on-the-fly\n\u2022 Add inline video player for video/* MIME types\n\u2022 Pros: Full native experience\n\u2022 Cons: Complex implementation, performance concerns, HEIC conversion dependencies\n\n<strong>Option B: Thumbnail with Click-to-Open (Medium)</strong>\n\u2022 Show first frame or placeholder thumbnail\n\u2022 Click opens file in system default player via shell\n\u2022 Pros: Visual preview, lower memory than inline video\n\u2022 Cons: Requires ffmpeg or similar for thumbnails, complex\n\n<strong>Option C: File Icon with Click-to-Open (Simple - RECOMMENDED)</strong>\n\u2022 Show a generic file icon (or type-specific icon for video/HEIC)\n\u2022 Display the filename\n\u2022 Click opens file in system default application via <code>shell.openPath()</code>\n\u2022 Pros: **Simple implementation (~15K tokens)**, clear UX, works for ALL file types\n\u2022 Cons: No preview (acceptable tradeoff for simplicity)\n\n<strong>Recommended Approach</strong>\n**Option C** - File Icon with Click-to-Open\n\nThis provides immediate value with minimal implementation effort. It makes previously invisible attachments visible and accessible. Can be enhanced to Options A/B later if needed.\n\n<strong>Acceptance Criteria</strong>\n\u2610 All attachments are visible in ConversationViewModal (not just displayable images)\n\u2610 Non-image attachments show a file icon with filename\n\u2610 Clicking non-image attachment opens file in system default application\n\u2610 HEIC images show file icon (no conversion required)\n\u2610 Video attachments show file icon (video-specific icon preferred)\n\u2610 Tests cover non-image attachment rendering\n\u2610 IPC handler for opening files in system app exists\n\n<strong>Dependencies</strong>\n\u2022 Requires <code>shell.openPath()</code> IPC handler (similar to existing <code>shell.showItemInFolder()</code>)\n\n<strong>Discovered During</strong>\nSPRINT-041 testing\n\n<strong>Notes</strong>\nThis is a UX gap - users see image attachments but HEIC photos and videos are simply missing with no indication they exist. Option C is a quick win that can be implemented in a single sprint.\n\n<strong>Related Tasks</strong>\n\u2022 TASK-1078: Show File Icon for Unsupported Attachments"
  },
  {
    "id": "BACKLOG-299",
    "title": "1:1 Chat Incorrectly Shown as Group Chat",
    "category": "fix",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-044",
    "est_tokens": "~25K",
    "actual_tokens": "~52K",
    "variance": "+108%",
    "created_at": "2026-01-17",
    "completed_at": "2026-01-18",
    "file": "PR #470",
    "description": "<strong>Type</strong>\nBug\n\n<strong>Priority</strong>\nMedium\n\n<strong>Status</strong>\nOpen (Needs Investigation)\n\n<strong>Summary</strong>\nA 1:1 conversation in MessageThreadCard is incorrectly displayed as \"Group Chat: Joanne Pauls Mom, unknown\". The presence of an \"unknown\" participant value causes <code>isGroupChat()</code> to return true when it should return false.\n\n<strong>Problem</strong>\nThe <code>isGroupChat()</code> function in <code>MessageThreadCard.tsx</code> (line 78-81) determines group status by counting participants:\n\n<code>function isGroupChat(messages: MessageLike[]): boolean {\n  const participants = getThreadParticipants(messages);\n  return participants.length > 1;\n}\n</code>\n\nWhen a participant is stored as \"unknown\" (instead of a valid phone number or being excluded), the participant count becomes 2, triggering group chat display for what is actually a 1:1 conversation.\n\n<strong>Root Cause Investigation Needed</strong>\n\nThe \"unknown\" value could originate from:\n\n1. **iOS/macOS Message Parser** - The parser may be storing \"unknown\" for participants it cannot resolve\n2. **Phone Number Normalization** - A normalization function may be producing \"unknown\" for edge cases\n3. **Database Import** - The messages table may have records with \"unknown\" in sender/recipient fields\n4. **Contact Resolution** - A lookup that fails may be writing \"unknown\" instead of null/undefined\n\n<strong>Investigation Steps</strong>\n1. Query messages table for records containing \"unknown\" in participant fields\n2. Trace the message import flow for this specific thread\n3. Check <code>getThreadParticipants()</code> implementation for how it handles missing data\n4. Review phone number normalization logic\n\n<strong>Affected Files</strong>\n\u2022 <code>src/components/transactionDetailsModule/components/MessageThreadCard.tsx</code>\n\u2022 Likely: message parsing/import services (to be identified)\n\u2022 Possibly: phone number normalization utilities\n\n<strong>Acceptance Criteria</strong>\n\u2610 Root cause of \"unknown\" participant values identified\n\u2610 Fix prevents \"unknown\" from being stored/used as a participant\n\u2610 Existing \"unknown\" values handled gracefully (excluded from participant count or cleaned)\n\u2610 1:1 chats display correctly as 1:1, not group\n\u2610 Test case covers the specific scenario\n\n<strong>Dependencies</strong>\nNone\n\n<strong>Discovered During</strong>\nSPRINT-041 testing\n\n<strong>Notes</strong>\nThis bug affects user trust in the data - seeing \"unknown\" participants and incorrect chat type labels creates confusion about what data was actually imported."
  },
  {
    "id": "BACKLOG-300",
    "title": "Display Contact Roles in User-Friendly Format",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "SPRINT-055a",
    "est_tokens": "~5K",
    "actual_tokens": "-",
    "variance": "Format snake_case roles as \"Title Case\"",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-300.md](BACKLOG-300.md)",
    "description": "<strong>Problem Statement</strong>\n\nWhen viewing linked contacts on a transaction, the role pills display raw database values like \"seller_agent\" instead of user-friendly labels like \"Seller Agent\". This creates a poor user experience as snake_case values are not human-readable.\n\n<strong>Current Behavior</strong>\n\nRole pills display raw database values:\n\u2022 <code>seller_agent</code>\n\u2022 <code>buyer_agent</code>\n\u2022 <code>escrow_officer</code>\n\u2022 <code>title_officer</code>\n\u2022 <code>lender</code>\n\u2022 etc.\n\n<strong>Expected Behavior</strong>\n\nRole pills should display formatted, human-readable labels:\n\u2022 \"seller_agent\" -> \"Seller Agent\"\n\u2022 \"buyer_agent\" -> \"Buyer Agent\"\n\u2022 \"escrow_officer\" -> \"Escrow Officer\"\n\u2022 \"title_officer\" -> \"Title Officer\"\n\u2022 \"lender\" -> \"Lender\"\n\u2022 etc.\n\n<strong>Proposed Solution</strong>\n\nAdd a simple formatting function to convert snake_case role values to Title Case display labels. Two approaches:\n\n<strong>Option A: String Manipulation (Generic)</strong>\n<code>const formatRole = (role: string): string =>\n  role.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');\n</code>\n\n<strong>Option B: Lookup Map (Explicit)</strong>\n<code>const ROLE_LABELS: Record<string, string> = {\n  seller_agent: 'Seller Agent',\n  buyer_agent: 'Buyer Agent',\n  escrow_officer: 'Escrow Officer',\n  title_officer: 'Title Officer',\n  lender: 'Lender',\n  // ... other roles\n};\n\nconst formatRole = (role: string): string => ROLE_LABELS[role] ?? role;\n</code>\n\nOption A is more flexible; Option B gives explicit control over labels.\n\n<strong>Affected Components</strong>\n\n\u2022 Transaction detail view (linked contacts section)\n\u2022 Contact role pills/badges\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Role pills display human-readable labels instead of snake_case values\n\u2610 All existing roles have proper formatting\n\u2610 Unknown roles gracefully fallback to the raw value (not crash)\n\n<strong>Notes</strong>\n\nThis is a cosmetic/polish fix with minimal risk. Very straightforward string formatting change."
  },
  {
    "id": "BACKLOG-301",
    "title": "Refactor Sync Coordination with SyncScheduler Service",
    "category": "refactor",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~65K",
    "actual_tokens": "-",
    "variance": "Centralize sync triggers, remove cross-hook flags",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-301.md](BACKLOG-301.md)",
    "description": "<strong>Problem Statement</strong>\n\nCurrently, background sync operations are triggered by multiple independent hooks with overlapping responsibilities:\n\n1. <code>useMacOSMessagesImport</code> - dedicated macOS Messages import (2000ms delay)\n2. <code>useAutoRefresh</code> - general sync for emails, messages, contacts (2500ms delay)\n\nBoth hooks have their own module-level guards, but they weren't coordinated, causing duplicate sync triggers. The current fix uses cross-hook flag exports (<code>hasMessagesImportTriggered()</code>), which works but creates:\n\n\u2022 Hidden coupling between hooks\n\u2022 Order dependency (relies on 500ms timing gap)\n\u2022 Testing complexity with module-level state\n\u2022 Difficulty adding new sync sources\n\n<strong>Proposed Solution</strong>\n\nImplement a **SyncScheduler Service** pattern:\n\n<code>                SyncScheduler (singleton service)\n                      |\n    +--------+--------+--------+--------+\n    |        |        |        |        |\n emails   messages  contacts  (future sources)\n</code>\n\n<strong>Architecture</strong>\n\n1. **SyncScheduler.ts** - Pure TypeScript singleton service (not a React hook)\n   - Tracks registered sync operations\n   - Prevents duplicate runs via internal state\n   - Exposes <code>request(type)</code>, <code>isRunning(type)</code>, <code>hasRun(type)</code>\n   - Handles sync priorities and dependencies\n\n2. **useSyncScheduler.ts** - Thin React hook wrapper\n   - Subscribes to SyncScheduler for React components\n   - Returns sync status for UI\n\n3. **Migration** - Existing hooks delegate to SyncScheduler\n   - <code>useMacOSMessagesImport</code> \u2192 <code>scheduler.request('messages')</code>\n   - <code>useAutoRefresh</code> \u2192 <code>scheduler.request('emails')</code>, etc.\n\n<strong>Benefits</strong>\n\n\u2022 Single source of truth for sync state\n\u2022 No cross-hook flag exports\n\u2022 Easy to add new sync sources (iPhone backup, cloud sync)\n\u2022 Easy to implement sync dependencies\n\u2022 Testable in isolation (no React required)\n\n<strong>Files Affected</strong>\n\n\u2022 <code>src/services/sync/SyncScheduler.ts</code> (new)\n\u2022 <code>src/hooks/useSyncScheduler.ts</code> (new)\n\u2022 <code>src/hooks/useMacOSMessagesImport.ts</code> (refactor)\n\u2022 <code>src/hooks/useAutoRefresh.ts</code> (refactor)\n\u2022 <code>src/appCore/BackgroundServices.tsx</code> (minor updates)\n\n<strong>Implementation Phases</strong>\n\n| Phase | Action | Risk | Effort |\n|-------|--------|------|--------|\n| 1 | Create SyncScheduler service | Low | ~15K tokens |\n| 2 | Create useSyncScheduler hook | Low | ~10K tokens |\n| 3 | Migrate useMacOSMessagesImport | Medium | ~15K tokens |\n| 4 | Migrate useAutoRefresh | Medium | ~20K tokens |\n| 5 | Deprecate cross-hook flags | Low | ~5K tokens |\n\n**Total Estimate:** ~65K tokens\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 SyncScheduler service created with full test coverage\n\u2610 All sync operations routed through SyncScheduler\n\u2610 No duplicate sync triggers on dashboard load\n\u2610 Cross-hook flag exports removed\n\u2610 Existing tests still pass\n\u2610 UI sync indicator works correctly\n\n<strong>Dependencies</strong>\n\nNone - this is a pure refactor with no feature changes.\n\n<strong>Related Items</strong>\n\n\u2022 TASK-1113: Fix Duplicate macOS Messages Sync (immediate fix)\n\u2022 BACKLOG-293: Duplicate macOS Messages Sync (original bug report)\n\n<strong>Notes</strong>\n\n\u2022 SR Engineer recommendation from architectural review\n\u2022 Should be completed before adding new sync sources (iPhone backup, Supabase cloud sync)\n\u2022 Current flag-based approach is acceptable short-term\n\n---\n\n<strong>SR Engineer Review</strong>\n\n**Status:** Pending"
  },
  {
    "id": "BACKLOG-302",
    "title": "Service Pattern Audit - Coordination Refactoring",
    "category": "refactor",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "Audit findings for sync coordination patterns",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-302.md](BACKLOG-302.md)",
    "description": "<strong>Summary</strong>\n\nCodebase audit for patterns that would benefit from centralized service/coordinator refactoring, similar to the SyncScheduler pattern recommended in BACKLOG-301.\n\n---\n\n<strong>Findings</strong>\n\n<strong>1. Sync Coordination (Already in BACKLOG-301)</strong>\n\n**Files:**\n\u2022 <code>src/hooks/useAutoRefresh.ts</code>\n\u2022 <code>src/hooks/useMacOSMessagesImport.ts</code>\n\n**Smells Found:**\n| Smell | Evidence |\n|-------|----------|\n| Cross-module flags | <code>hasMessagesImportTriggered()</code> exported, <code>shouldSkipMessagesSync()</code> exported |\n| Bidirectional imports | Each hook imports from the other |\n| Duplicate guards | Both have <code>let hasTriggered*</code> module-level flags |\n| Same API call | Both call <code>window.api.messages.importMacOSMessages()</code> |\n\n**Status:** Already documented in BACKLOG-301 (SyncScheduler)\n\n---\n\n<strong>2. Transaction Scan Duplication - NEW</strong>\n\n**Files:**\n\u2022 <code>src/hooks/useAutoRefresh.ts:288</code> - calls <code>transactions.scan()</code>\n\u2022 <code>src/components/transaction/hooks/useTransactionScan.ts:71</code> - calls <code>transactions.scan()</code>\n\u2022 <code>src/components/Transactions.tsx:195</code> - calls <code>transactions.scan()</code>\n\n**Smells Found:**\n| Smell | Evidence |\n|-------|----------|\n| Ownership ambiguity | 3 different places can trigger transaction scan |\n| No coordination | No guards or flags to prevent duplicate scans |\n| Hidden coupling | Components may trigger scans while auto-refresh is running |\n\n**Risk:** User could trigger manual scan while auto-refresh is running, causing duplicate processing.\n\n**Recommendation:** Include <code>transactions.scan</code> in the SyncScheduler service from BACKLOG-301.\n\n**Priority:** Medium\n\n---\n\n<strong>3. Messages Import Scatter - NEW</strong>\n\n**Files:**\n\u2022 <code>src/hooks/useAutoRefresh.ts:328</code> - auto-refresh trigger\n\u2022 <code>src/hooks/useMacOSMessagesImport.ts:88</code> - background trigger\n\u2022 <code>src/components/settings/MacOSMessagesImportSettings.tsx:59</code> - manual settings trigger\n\u2022 <code>src/components/onboarding/steps/PermissionsStep.tsx:263</code> - onboarding trigger\n\n**Smells Found:**\n| Smell | Evidence |\n|-------|----------|\n| Ownership ambiguity | 4 different places can trigger messages import |\n| Partial coordination | Some flags exist but not comprehensive |\n| Scattered entry points | Settings, onboarding, background, auto-refresh all trigger same operation |\n\n**Risk:** Already fixed short-term via cross-hook flags, but still fragile.\n\n**Recommendation:** Consolidate into SyncScheduler from BACKLOG-301.\n\n**Priority:** Medium (already mitigated short-term)\n\n---\n\n<strong>4. Tour State Management - LOW PRIORITY</strong>\n\n**Files:**\n\u2022 <code>src/hooks/useTour.ts:35</code> - uses <code>setTimeout(..., 500)</code> timing\n\n**Smells Found:**\n| Smell | Evidence |\n|-------|----------|\n| Timing-based coordination | 500ms delay to \"let UI settle\" |\n\n**Risk:** Low - isolated to tour functionality.\n\n**Recommendation:** Not urgent. Could be improved with proper state machine but low ROI.\n\n**Priority:** Low\n\n---\n\n<strong>Recommended Actions</strong>\n\n<strong>Phase 1: Extend SyncScheduler (BACKLOG-301)</strong>\n\nWhen implementing SyncScheduler, include these operations:\n\u2022 <code>messages</code> - macOS Messages import\n\u2022 <code>emails</code> - Email sync/scan\n\u2022 <code>contacts</code> - Contacts sync\n\u2022 <code>transactionScan</code> - Transaction detection scan (NEW)\n\nThis consolidates findings #1, #2, and #3 into a single service.\n\n<strong>Phase 2: Future Considerations</strong>\n\n| Area | Pattern | Action |\n|------|---------|--------|\n| Tour | Timing delay | Low priority - leave as-is |\n| Preferences | Multiple loaders | Monitor - not yet problematic |\n| OAuth | Token refresh | Already well-isolated |\n\n---\n\n<strong>Estimated Effort</strong>\n\nExtending BACKLOG-301 to include transaction scan:\n\u2022 Additional effort: ~10K tokens\n\u2022 Total SyncScheduler (revised): ~75K tokens\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-301: SyncScheduler Refactor (parent item)\n\n---\n\n<strong>Related Files</strong>\n\n<code>src/hooks/useAutoRefresh.ts\nsrc/hooks/useMacOSMessagesImport.ts\nsrc/components/transaction/hooks/useTransactionScan.ts\nsrc/components/Transactions.tsx\nsrc/components/settings/MacOSMessagesImportSettings.tsx\nsrc/components/onboarding/steps/PermissionsStep.tsx\n</code>\n\n---\n\n<strong>Notes</strong>\n\n\u2022 Audit was conducted via grep patterns for known smells\n\u2022 Most critical issues already addressed in BACKLOG-301\n\u2022 Transaction scan duplication is the main new finding\n\u2022 No urgent action needed - current mitigations are working"
  },
  {
    "id": "BACKLOG-303",
    "title": "Centralize dotenv.config() in supabaseService.ts",
    "category": "security",
    "priority": "Low",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "~3K",
    "actual_tokens": "~3K",
    "variance": "0%",
    "created_at": "2026-01-18",
    "completed_at": "",
    "file": "PR #466",
    "description": "<strong>Problem Statement</strong>\n\n<code>supabaseService.ts</code> still has its own <code>dotenv.config()</code> call. For consistency with the centralization pattern established in TASK-1118 (which centralized <code>googleAuthService.ts</code>), this should also be centralized to <code>electron/main.ts</code>.\n\n<strong>Current Behavior</strong>\n\n<code>supabaseService.ts</code> calls <code>dotenv.config()</code> directly within the service file, similar to how <code>googleAuthService.ts</code> previously did before TASK-1118.\n\n<strong>Expected Behavior</strong>\n\nEnvironment variables should be loaded once in <code>electron/main.ts</code> at application startup, and <code>supabaseService.ts</code> should rely on that centralized initialization rather than calling <code>dotenv.config()</code> itself.\n\n<strong>Proposed Solution</strong>\n\n1. Remove the <code>dotenv.config()</code> call from <code>supabaseService.ts</code>\n2. Ensure <code>electron/main.ts</code> loads environment variables early enough for Supabase initialization\n3. Verify Supabase client initialization still works correctly\n\n<strong>Affected Files</strong>\n\n\u2022 <code>electron/services/supabaseService.ts</code> - Remove <code>dotenv.config()</code> call\n\u2022 <code>electron/main.ts</code> - Verify centralized <code>dotenv.config()</code> is loaded early enough\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>dotenv.config()</code> call removed from <code>supabaseService.ts</code>\n\u2610 Supabase client initializes correctly using env vars from centralized config\n\u2610 No regression in cloud sync functionality\n\u2610 Pattern consistent with TASK-1118 (googleAuthService.ts centralization)\n\n<strong>Related</strong>\n\n\u2022 **TASK-1118**: Centralized dotenv.config() in googleAuthService.ts\n\u2022 **BACKLOG-248**: Original security audit that identified scattered dotenv calls\n\n<strong>Notes</strong>\n\nThis is a low-priority consistency improvement. It is not a security risk since the env vars are the same regardless of where <code>dotenv.config()</code> is called, but centralizing makes the codebase more maintainable and follows the established pattern."
  },
  {
    "id": "BACKLOG-304",
    "title": "Fix ESLint react-hooks/exhaustive-deps Rule Not Found",
    "category": "infra",
    "priority": "Low",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "~3K",
    "actual_tokens": "~1K",
    "variance": "-67%",
    "created_at": "2026-01-18",
    "completed_at": "2026-01-18",
    "file": "PR #468",
    "description": "<strong>Problem Statement</strong>\n\nDuring test runs, ESLint reports that the <code>react-hooks/exhaustive-deps</code> rule definition is not found in <code>ContactSelectModal.tsx</code>, generating a warning that clutters test output.\n\n<strong>Current Behavior</strong>\n\n<code>Warning: react-hooks/exhaustive-deps rule is not found at contactEditModule/components/ContactSelectModal.tsx\n</code>\n\nThis warning appears during <code>npm run lint</code> and test runs.\n\n<strong>Expected Behavior</strong>\n\nNo ESLint warnings about missing rule definitions. Either:\n1. The rule should be properly configured\n2. The rule should be removed if not needed\n3. The ESLint plugin should be properly installed\n\n<strong>Root Cause Analysis</strong>\n\nLikely one of:\n\u2022 <code>eslint-plugin-react-hooks</code> not installed\n\u2022 Plugin not configured in <code>.eslintrc</code>\n\u2022 Rule referenced in file but plugin not loaded\n\n<strong>Proposed Solution</strong>\n\n1. Check if <code>eslint-plugin-react-hooks</code> is in <code>package.json</code>\n2. Verify <code>.eslintrc</code> includes the plugin in <code>plugins</code> array\n3. Fix configuration or remove unnecessary rule reference\n\n<strong>Affected Files</strong>\n\n\u2022 <code>src/components/contactEditModule/components/ContactSelectModal.tsx</code> - File triggering warning\n\u2022 <code>.eslintrc.*</code> - ESLint configuration\n\u2022 <code>package.json</code> - Plugin dependencies\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>npm run lint</code> runs without \"rule not found\" warnings\n\u2610 ContactSelectModal.tsx lints cleanly\n\u2610 No regression in hook dependency checking\n\n<strong>Related</strong>\n\n\u2022 **TASK-1120**: Discovered during testing phase (caused 57% testing overhead)\n\n<strong>Notes</strong>\n\nThis is a low-priority cleanup item. The warning doesn't break anything but clutters output and may hide real issues."
  },
  {
    "id": "BACKLOG-305",
    "title": "Fix autoDetection.test.tsx Button Selector Failure",
    "category": "test",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "~5K",
    "actual_tokens": "~1K",
    "variance": "-80%",
    "created_at": "2026-01-18",
    "completed_at": "2026-01-18",
    "file": "PR #468",
    "description": "<strong>Problem Statement</strong>\n\nThe <code>autoDetection.test.tsx</code> test file has a failing test that expects to find a \"Start Detection\" button, but the button is not rendered or has a different text.\n\n<strong>Current Behavior</strong>\n\nTest failure in <code>autoDetection.test.tsx</code>:\n<code>Expected: \"Start Detection\"\nReceived: Unable to find an accessible element with the role \"button\" and name \"Start Detection\"\n</code>\n\nThe test expects a button with specific text that either:\n1. Doesn't exist in the component\n2. Has different text\n3. Is conditionally rendered and conditions aren't met in test\n\n<strong>Expected Behavior</strong>\n\nTest should pass consistently. Either:\n1. Component should render the expected button\n2. Test should be updated to match actual component behavior\n3. Test setup should provide correct conditions for button to render\n\n<strong>Root Cause Analysis</strong>\n\nNeed to investigate:\n1. What button text does the component actually render?\n2. Is the button conditionally rendered?\n3. Was the component updated without updating tests?\n\n<strong>Proposed Solution</strong>\n\n1. Run the failing test to get full error context\n2. Read <code>autoDetection.test.tsx</code> and related component\n3. Either fix component to render expected button, or fix test to match component\n4. Verify test passes 3x without flakiness\n\n<strong>Affected Files</strong>\n\n\u2022 <code>src/components/**/autoDetection.test.tsx</code> - Failing test\n\u2022 Related component file (need to identify)\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>npm test autoDetection.test.tsx</code> passes\n\u2610 Test runs 3x without flakiness\n\u2610 No regression in auto-detection functionality\n\n<strong>Related</strong>\n\n\u2022 **TASK-1120**: Discovered during testing phase (caused 57% testing overhead)\n\n<strong>Notes</strong>\n\nThis is a medium-priority item because failing tests in CI can mask real regressions. Pre-existing failures should be fixed to maintain test suite integrity."
  },
  {
    "id": "BACKLOG-306",
    "title": "Hide Phone/Email in Contact Selection Modal",
    "category": "ui",
    "priority": "Low",
    "status": "Completed",
    "sprint": "SPRINT-045",
    "est_tokens": "~8K",
    "actual_tokens": "~8K",
    "variance": "0%",
    "created_at": "2026-01-18",
    "completed_at": "2026-01-19",
    "file": "PR #472",
    "description": "**Status:** Done\n**Sprint:** SPRINT-045\n**PR:** #472\n**Completed:** 2026-01-19\n\n<strong>Summary</strong>\n\nIn the \"Select Contact\" / \"Link chats to\" modal, do not display phone numbers or email addresses for contacts. Only show the contact name.\n\n<strong>Current Behavior</strong>\n\nThe contact selection modal currently displays:\n\u2022 Contact name\n\u2022 Phone number (if available)\n\u2022 Email address (if available)\n\n<strong>Desired Behavior</strong>\n\nThe contact selection modal should only display:\n\u2022 Contact name\n\n<strong>Rationale</strong>\n\n\u2022 Cleaner UI with less visual clutter\n\u2022 Phone/email not needed for selection context\n\u2022 Privacy consideration - less PII displayed\n\n<strong>Affected Components</strong>\n\n\u2022 <code>ContactSelectModal.tsx</code> or similar contact picker component\n\u2022 Contact list item rendering\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Contact selection modal shows only contact names\n\u2610 No phone numbers displayed in the list\n\u2610 No email addresses displayed in the list\n\u2610 Selection functionality unchanged\n\n<strong>Estimated Effort</strong>\n\n~5K tokens (simple UI change)\n\n<strong>Priority</strong>\n\nLow - UI polish item\n\n<strong>References</strong>\n\n\u2022 User request: 2026-01-18"
  },
  {
    "id": "BACKLOG-307",
    "title": "Contact Select Modal Missing Message-Derived Contacts",
    "category": "fix",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-045",
    "est_tokens": "~45K",
    "actual_tokens": "~35K",
    "variance": "-22%",
    "created_at": "2026-01-18",
    "completed_at": "2026-01-19",
    "file": "PR #473",
    "description": "<strong>Type</strong>\nBug / UX\n\n<strong>Priority</strong>\nHigh\n\n<strong>Status</strong>\nDone\n\n**Sprint:** SPRINT-045\n**PR:** #473\n**Completed:** 2026-01-19\n\n<strong>Summary</strong>\n\nWhen using the \"Select Contact\" modal (e.g., in Attach Messages screen), contacts detected from imported messages do not appear. Users see \"2206 contacts with unlinked messages\" elsewhere in the app, but the Select Contact modal shows 0 contacts because it only queries \"imported\" contacts.\n\n<strong>Problem</strong>\n\n**User Report:**\n\u2022 Dashboard shows \"2206 contacts with unlinked messages\"\n\u2022 User has 0 \"imported\" contacts\n\u2022 When trying to attach messages to a transaction, contact \"Carol Graffius\" (who exists in their messages) does not appear in Select Contact modal\n\u2022 User cannot link messages to contacts they've communicated with\n\n**Root Cause:**\nThe <code>ContactSelectModal</code> calls:\n<code>await window.api.contacts.getAll(userId)\n// or\nawait window.api.contacts.getSortedByActivity(userId, propertyAddress)\n</code>\n\nBoth of these query <code>getImportedContactsByUserId()</code> which only returns contacts from the <code>contacts</code> table that were explicitly imported.\n\nContacts detected from messages (phone numbers, email addresses extracted during message import) are stored differently and not included in this query.\n\n<strong>Expected Behavior</strong>\n\nThe Select Contact modal should show:\n1. Explicitly imported contacts (from Contacts page import)\n2. Contacts derived from imported messages (anyone the user has communicated with)\n\nOr at minimum, provide a way to quickly import/create a contact from message-derived data.\n\n<strong>Affected Files</strong>\n\n\u2022 <code>src/components/ContactSelectModal.tsx</code> - Consumer of contact data\n\u2022 <code>src/components/transactionDetailsModule/components/modals/EditContactsModal.tsx</code> - Calls loadContacts\n\u2022 <code>electron/contact-handlers.ts</code> - <code>contacts:get-all</code> and <code>contacts:get-sorted-by-activity</code> handlers\n\u2022 <code>electron/services/databaseService.ts</code> - <code>getImportedContactsByUserId()</code> query\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Select Contact modal shows contacts the user has messaged\n\u2610 User can find \"Carol Graffius\" (or any contact from their messages) in the modal\n\u2610 Search works across both imported and message-derived contacts\n\u2610 Performance acceptable with 2000+ contacts\n\n<strong>Potential Solutions</strong>\n\n1. **Merge queries** - Combine imported contacts with unique senders/recipients from messages table\n2. **Auto-import on message sync** - Create contact records for all unique participants during message import\n3. **Separate section** - Show \"Recent Contacts\" from messages alongside imported contacts\n4. **On-demand creation** - Allow creating a contact directly from the modal search when no match found\n\n<strong>Dependencies</strong>\n\nNone\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-306: Hide Phone/Email in Contact Selection Modal (same modal, different issue)\n\n<strong>Discovered During</strong>\n\nUser testing - 2026-01-18\n\n<strong>Notes</strong>\n\nThis is a significant UX blocker - users import messages expecting to work with those contacts, but can't find them in the contact selection flow."
  },
  {
    "id": "BACKLOG-309",
    "title": "Import Contact Flow - Auto-Select and Refresh Issues",
    "category": "fix",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-045",
    "est_tokens": "~25K",
    "actual_tokens": "~25K",
    "variance": "0%",
    "created_at": "2026-01-18",
    "completed_at": "2026-01-19",
    "file": "PR #474",
    "description": "<strong>Type</strong>\nBug / UX\n\n<strong>Priority</strong>\nHigh\n\n<strong>Status</strong>\nDone\n\n**Sprint:** SPRINT-045\n**PR:** #474\n**Completed:** 2026-01-19\n\n<strong>Summary</strong>\n\nWhen importing contacts from within the Edit Transaction flow (via Select Contacts \u2192 Import Contacts), two issues occur:\n\n1. **Refresh Issue:** Sometimes the newly imported contact doesn't appear in the Select Contacts list after import completes\n2. **Missing Auto-Select:** Imported contacts should be automatically selected (checked) since the user clearly wants to add them to the transaction\n\n<strong>Current Behavior</strong>\n\n1. User is editing a transaction and wants to add a contact\n2. Opens Select Contacts modal\n3. Contact \"Carol Graffius\" isn't in the list (not imported yet)\n4. User clicks \"Import\" button \u2192 Import Contacts modal opens\n5. User finds and selects \"Carol Graffius\", clicks Import\n6. Import Contacts modal closes, returns to Select Contacts\n7. **Problem A:** Sometimes \"Carol Graffius\" doesn't appear in the list (refresh not working)\n8. **Problem B:** Even when it appears, user must manually find and check the contact they just imported\n\n<strong>Expected Behavior</strong>\n\n1. After importing contacts, Select Contacts list should **always** refresh and show the new contact(s)\n2. Newly imported contacts should be **automatically selected** (checkbox checked)\n3. User can immediately click \"Add\" to attach the contact to the transaction\n\n<strong>Root Cause Investigation</strong>\n\n<strong>Refresh Issue</strong>\n\u2022 <code>ContactSelectModal.tsx</code> has <code>onRefreshContacts</code> callback\n\u2022 <code>EditContactsModal.tsx</code> passes <code>loadContacts</code> as <code>onRefreshContacts</code>\n\u2022 Need to verify this callback is being invoked after import\n\u2022 May be a race condition - import completes but query returns before DB write commits\n\n<strong>Auto-Select Issue</strong>\n\u2022 <code>ImportContactsModal</code> returns via <code>onSuccess</code> callback\n\u2022 The imported contact IDs are not passed back to <code>ContactSelectModal</code>\n\u2022 <code>ContactSelectModal</code> has no way to know which contacts were just imported\n\n<strong>Affected Files</strong>\n\n\u2022 <code>src/components/ContactSelectModal.tsx</code> - Needs to receive and auto-select imported IDs\n\u2022 <code>src/components/contact/components/ImportContactsModal.tsx</code> - Needs to return imported contact IDs\n\u2022 <code>src/components/transactionDetailsModule/components/modals/EditContactsModal.tsx</code> - Orchestrates the flow\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 After importing contact(s), Select Contacts list always shows them\n\u2610 Newly imported contacts are automatically checked/selected\n\u2610 Works for single contact import\n\u2610 Works for multiple contact import\n\u2610 No race conditions causing missing contacts\n\n<strong>Proposed Solution</strong>\n\n<code>// ImportContactsModal should return imported contact IDs\nonSuccess?: (importedContactIds: string[]) => void;\n\n// ContactSelectModal should accept and auto-select\ninterface ContactSelectModalProps {\n  // ... existing props\n  autoSelectIds?: string[];  // IDs to auto-select when they appear\n}\n\n// Or simpler: pass imported IDs through and add to selectedIds state\n</code>\n\n<strong>Dependencies</strong>\n\nNone\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-307: Contact Select Modal Missing Message-Derived Contacts\n\u2022 BACKLOG-306: Hide Phone/Email in Contact Selection Modal\n\n<strong>Discovered During</strong>\n\nUser testing - 2026-01-18\n\n<strong>Notes</strong>\n\nThis is a workflow friction issue. The user's intent is clear (import + use contact), but the UI makes them do extra steps."
  },
  {
    "id": "BACKLOG-310",
    "title": "Remove Debug Console Logs from NotificationContext",
    "category": "refactor",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~3K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-19",
    "completed_at": "",
    "file": "[BACKLOG-310.md](items/BACKLOG-310.md)",
    "description": "<strong>Type</strong>\nDX / Cleanup\n\n<strong>Priority</strong>\nLow\n\n<strong>Status</strong>\nPending\n\n<strong>Summary</strong>\n\nRemove or guard the debug console logs in <code>NotificationContext.tsx</code> that spam the browser inspector with repeated messages.\n\n<strong>Current Behavior</strong>\n\nConsole shows repeated messages:\n<code>\ud83d\udd14 Notifications available in console: __notify.success('msg'), __notify.error('msg'), ...\n\ud83d\udd14 Notifications available in console: __notify.success('msg'), __notify.error('msg'), ...\n\ud83d\udd14 Notifications available in console: __notify.success('msg'), __notify.error('msg'), ...\n\ud83d\udd14 Notifications available in console: __notify.success('msg'), __notify.error('msg'), ...\n</code>\n\nThis appears on line 175 of <code>NotificationContext.tsx</code> and logs every time the context re-renders.\n\n<strong>Expected Behavior</strong>\n\nEither:\n1. Remove the debug log entirely\n2. Guard with <code>if (__DEV__)</code> or similar\n3. Log only once using a ref to track if already logged\n\n<strong>Affected Files</strong>\n\n\u2022 <code>src/contexts/NotificationContext.tsx</code> (line ~175)\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Console not spammed with notification helper messages\n\u2610 (Optional) Debug helper still available in development if useful\n\n<strong>Estimated Effort</strong>\n\n~3K tokens (simple cleanup)\n\n<strong>Discovered During</strong>\n\nUser testing - 2026-01-18"
  },
  {
    "id": "BACKLOG-311",
    "title": "EditContactsModal Performance - Lift Contact Loading",
    "category": "performance",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-045",
    "est_tokens": "~15K",
    "actual_tokens": "~25K",
    "variance": "+67%",
    "created_at": "2026-01-19",
    "completed_at": "2026-01-19",
    "file": "PRs #477, #478",
    "description": "<strong>Type</strong>\nPerformance / Architecture\n\n<strong>Priority</strong>\nMedium\n\n<strong>Status</strong>\nDone\n\n**Sprint:** SPRINT-045 (post-sprint fix)\n**PRs:** #477 (lift loading to parent), #478 (fix N+1 query)\n**Completed:** 2026-01-19\n\n<strong>Summary</strong>\n\nThe <code>EditContactsModal</code> freezes the UI when opened because each <code>EditRoleAssignment</code> component independently calls <code>loadContacts()</code> in its useEffect, triggering the expensive <code>getMessageDerivedContacts()</code> query multiple times (once per role: buyer, seller, listing_agent, etc.).\n\n<strong>Current Behavior</strong>\n\n1. User clicks \"Edit Contacts\" button on transaction Contacts page\n2. <code>EditContactsModal</code> renders multiple <code>EditRoleAssignment</code> components (one per role)\n3. EACH <code>EditRoleAssignment</code> calls <code>loadContacts()</code> in its useEffect\n4. Multiple simultaneous <code>getMessageDerivedContacts()</code> queries execute\n5. UI freezes until all queries complete\n\n**Quick Fix Applied:** Added <code>LIMIT 200</code> to <code>getMessageDerivedContacts()</code> query (commit a7f3de2 on develop) to reduce individual query impact. This is a band-aid, not a proper fix.\n\n<strong>Expected Behavior</strong>\n\n1. <code>EditContactsModal</code> parent component loads contacts ONCE on mount\n2. Contact data passed down as props to <code>EditRoleAssignment</code> components\n3. No duplicate queries, no UI freeze\n\n<strong>Root Cause</strong>\n\nReact anti-pattern: Child components independently fetching shared data instead of parent lifting state up and passing props down.\n\n<strong>Affected Files</strong>\n\n| File | Change Required |\n|------|-----------------|\n| <code>src/components/transactionDetailsModule/components/modals/EditContactsModal.tsx</code> | Add contact loading logic, pass contacts as props |\n| <code>EditRoleAssignment</code> component (inside same file or nearby) | Remove independent <code>loadContacts()</code> useEffect, accept contacts as prop |\n| <code>electron/services/db/contactDbService.ts</code> | No changes (already has LIMIT 200) |\n\n<strong>Implementation Approach</strong>\n\n1. **Add state to parent:**\n   <code>   // In EditContactsModal\n   const [contacts, setContacts] = useState<Contact[]>([]);\n   const [isLoadingContacts, setIsLoadingContacts] = useState(true);\n\n   useEffect(() => {\n     const loadContactsOnce = async () => {\n       setIsLoadingContacts(true);\n       const result = await window.api.getMessageDerivedContacts(transactionId);\n       setContacts(result);\n       setIsLoadingContacts(false);\n     };\n     loadContactsOnce();\n   }, [transactionId]);\n   </code>\n\n2. **Pass to children:**\n   <code>   <EditRoleAssignment\n     role=\"buyer\"\n     contacts={contacts}\n     isLoadingContacts={isLoadingContacts}\n     // ... other props\n   />\n   </code>\n\n3. **Update child to receive props:**\n   - Remove internal <code>loadContacts()</code> useEffect\n   - Use <code>contacts</code> and <code>isLoadingContacts</code> from props\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>EditContactsModal</code> calls <code>getMessageDerivedContacts()</code> exactly once on mount\n\u2610 <code>EditRoleAssignment</code> components receive contacts as props (no independent queries)\n\u2610 No UI freeze when opening Edit Contacts modal\n\u2610 Existing functionality preserved (role assignment, contact selection, etc.)\n\u2610 No TypeScript errors\n\u2610 Existing tests pass\n\n<strong>Technical Notes</strong>\n\n\u2022 The <code>LIMIT 200</code> in <code>getMessageDerivedContacts()</code> should remain as a safety net\n\u2022 Consider adding loading skeleton to <code>EditRoleAssignment</code> while contacts load\n\u2022 This is a textbook React \"lift state up\" refactor\n\n<strong>Estimated Effort</strong>\n\n~15K tokens (straightforward React refactor)\n\n<strong>Related</strong>\n\n\u2022 Commit a7f3de2 - Quick fix adding LIMIT 200\n\u2022 Standard React pattern: \"Lifting State Up\" (https://react.dev/learn/sharing-state-between-components)\n\n<strong>Discovered During</strong>\n\nUser testing - 2026-01-19"
  },
  {
    "id": "BACKLOG-317",
    "title": "Unified Contact Selection UX Refactor",
    "category": "ui",
    "priority": "Medium",
    "status": "Obsolete",
    "sprint": "-",
    "est_tokens": "~50K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-317.md](items/BACKLOG-317.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-318",
    "title": "Fix Loading State Layout Shift in EditContactsModal",
    "category": "ui",
    "priority": "Low",
    "status": "Completed",
    "sprint": "SPRINT-045",
    "est_tokens": "~5K",
    "actual_tokens": "~5K",
    "variance": "0%",
    "created_at": "2026-01-19",
    "completed_at": "2026-01-19",
    "file": "PR #484",
    "description": "<strong>Type</strong>\nUI / UX Polish\n\n<strong>Priority</strong>\nLow\n\n<strong>Status</strong>\nDone\n\n**Sprint:** SPRINT-045\n**PR:** #484\n**Completed:** 2026-01-19\n\n<strong>Summary</strong>\n\nWhen clicking \"Edit Contacts\", a \"Loading contacts...\" message appears briefly that shifts the interface down, then disappears when loading completes. This causes jarring layout shift and poor UX.\n\n<strong>Current Behavior</strong>\n\n1. User clicks \"Edit Contacts\" button\n2. Modal opens with \"Loading contacts...\" text at top of content area\n3. This text pushes the role assignment sections down\n4. When loading completes, the text disappears\n5. Content shifts up - jarring visual experience\n\n<strong>Expected Behavior (Options)</strong>\n\n**Option 1: Loading Overlay**\n\u2022 Semi-transparent overlay blocking the modal content\n\u2022 Centered spinner over existing layout\n\u2022 Content remains in place (no shift)\n\n**Option 2: Inline Spinner**\n\u2022 Small spinner that doesn't affect layout\n\u2022 Fixed position or absolute positioning\n\u2022 Content layout unchanged\n\n**Option 3: Skeleton/Placeholder**\n\u2022 Show placeholder content that matches final layout dimensions\n\u2022 Smooth transition to real content\n\n<strong>Affected Files</strong>\n\n\u2022 <code>src/components/transactionDetailsModule/components/modals/EditContactsModal.tsx</code>\n\u2022 The <code>useContactsLoader</code> hook shows loading state (lines ~420-428)\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 No visible layout shift when opening EditContactsModal\n\u2610 Loading indicator still present so user knows data is loading\n\u2610 Smooth visual transition from loading to loaded state\n\u2610 Works consistently regardless of load time\n\n<strong>Technical Notes</strong>\n\nThe loading state is managed by the <code>useContactsLoader</code> hook. The fix should modify how the loading UI is rendered rather than the loading logic itself.\n\n<strong>Estimated Effort</strong>\n\n~5K tokens (simple CSS/layout fix)\n\n<strong>Discovered During</strong>\n\nUser testing - 2026-01-19"
  },
  {
    "id": "BACKLOG-319",
    "title": "Transaction Details Tab Restructuring",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-319.md](items/BACKLOG-319.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-320",
    "title": "Hide Sale Price Field",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~3K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-320.md](items/BACKLOG-320.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-321",
    "title": "Hide Attachments Tab (Temporary)",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~3K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-321.md](items/BACKLOG-321.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-322",
    "title": "Reintroduce Attachments Tab with Full Support",
    "category": "feature",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~40K",
    "actual_tokens": "-",
    "variance": "Depends on BACKLOG-321",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-322.md](items/BACKLOG-322.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-323",
    "title": "Attach Messages Button Styling",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~2K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-323.md](items/BACKLOG-323.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-324",
    "title": "PDF Export Back Link Fix",
    "category": "fix",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-324.md](items/BACKLOG-324.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-325",
    "title": "PDF Header Redesign",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-325.md](items/BACKLOG-325.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-326",
    "title": "PDF Text Conversations Contact Name and Formatting",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-326.md](items/BACKLOG-326.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-327",
    "title": "PDF Export Show Rich HTML Emails",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-327.md](items/BACKLOG-327.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-329",
    "title": "Email Card Design Consistency with Message Cards",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~8K",
    "actual_tokens": "-",
    "variance": "Includes View button",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-329.md](items/BACKLOG-329.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-330",
    "title": "Sort Contacts by Most Recent Communication",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~8K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-330.md](items/BACKLOG-330.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-331",
    "title": "PDF Export Date Range Filtering",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-19",
    "completed_at": "",
    "file": "[BACKLOG-331.md](BACKLOG-331.md)",
    "description": "<strong>Summary</strong>\n\nFilter/truncate messages in PDF export based on transaction start date and closing date. Only include messages that fall within the transaction's date range.\n\n<strong>Problem</strong>\n\nCurrently, PDF exports include ALL linked messages regardless of when they occurred. Users need exports to only include communications relevant to the transaction timeframe.\n\n<strong>Requirements</strong>\n\n1. **Date range filtering at export time**\n   - Apply filtering during PDF generation (not at message linking time)\n   - Use transaction's start date as lower bound (if set)\n   - Use transaction's closing date as upper bound (if set)\n\n2. **Why at export time?**\n   - Closing date may not be known when messages are linked\n   - User may update closing date after linking messages\n   - Keeps linked messages intact for reference, only filters on export\n\n3. **Edge cases**\n   - If no start date: include all messages up to closing date\n   - If no closing date: include all messages from start date onwards\n   - If neither date set: include all linked messages (current behavior)\n\n<strong>Implementation Notes</strong>\n\n\u2022 Modify <code>pdfExportService.ts</code> to filter communications by date range\n\u2022 Use <code>sent_at</code> timestamp for filtering\n\u2022 Consider adding a small buffer (e.g., 1 day before start, 1 day after close) for edge cases\n\n<strong>Files Likely Affected</strong>\n\n\u2022 <code>electron/services/pdfExportService.ts</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Messages before transaction start date are excluded from PDF\n\u2610 Messages after closing date are excluded from PDF\n\u2610 Filtering only happens at export, linked messages remain in UI\n\u2610 Edge cases handled (missing dates)\n\u2610 Export summary shows filtered message count vs total linked\n\n<strong>Priority</strong>\n\nMedium - UX improvement for accurate audit reports\n\n<strong>Created</strong>\n\n2026-01-19"
  },
  {
    "id": "BACKLOG-332",
    "title": "Audit Package Missing Attachments and Text Messages",
    "category": "feature",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-049",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-19",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-332.md](BACKLOG-332.md)",
    "description": "<strong>Summary</strong>\n\nThe audit package export is missing actual attachments and text messages. Currently only shows a manifest file.\n\n<strong>Problem</strong>\n\nWhen exporting an audit package:\n1. **Attachments folder** - Only contains a manifest, no actual attachment files\n2. **Text messages** - Not included at all\n\n<strong>Requirements</strong>\n\n<strong>Attachments</strong>\n\u2022 Export actual attachment files to the attachments folder\n\u2022 Maintain manifest for reference\n\n<strong>Text Messages</strong>\n\u2022 Export text message threads as individual files (one file per thread)\n\u2022 Format should match the PDF export styling (conversation view)\n\u2022 Each thread file should include:\n  - Contact name and phone number\n  - All messages in the thread with timestamps\n  - Sender identification (You vs contact name)\n\n<strong>Expected Output Structure</strong>\n\n<code>audit-package/\n\u251c\u2500\u2500 manifest.json\n\u251c\u2500\u2500 transaction-summary.pdf\n\u251c\u2500\u2500 attachments/\n\u2502   \u251c\u2500\u2500 manifest.json\n\u2502   \u251c\u2500\u2500 document1.pdf\n\u2502   \u251c\u2500\u2500 image1.jpg\n\u2502   \u2514\u2500\u2500 ...\n\u251c\u2500\u2500 emails/\n\u2502   \u2514\u2500\u2500 ... (if applicable)\n\u2514\u2500\u2500 text-messages/\n    \u251c\u2500\u2500 thread-1-contact-name.pdf (or .txt/.html)\n    \u251c\u2500\u2500 thread-2-contact-name.pdf\n    \u2514\u2500\u2500 ...\n</code>\n\n<strong>Files Likely Affected</strong>\n\n\u2022 Audit package export service (needs investigation)\n\u2022 May need to create new text message export functionality\n\n<strong>Priority</strong>\n\nHigh - Audit package is incomplete without actual content\n\n<strong>Created</strong>\n\n2026-01-19"
  },
  {
    "id": "BACKLOG-333",
    "title": "Gray Out Unimplemented Export Options with Coming Soon Label",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-19",
    "completed_at": "",
    "file": "[BACKLOG-333.md](BACKLOG-333.md)",
    "description": "<strong>Summary</strong>\n\nGray out unimplemented export format options and add a \"Coming Soon\" label to indicate they are not yet available.\n\n<strong>Options to Gray Out</strong>\n\n\u2022 CSV\n\u2022 TXT+EML\n\u2022 JSON\n\u2022 Excel\n\n<strong>Requirements</strong>\n\n1. Gray out these options in the export format selector\n2. Add \"Coming Soon\" label/badge next to each\n3. Make them non-selectable/disabled\n4. Keep them visible so users know they're planned\n\n<strong>Design</strong>\n\n<code>Export Format:\n\u25cb PDF                    [Selected]\n\u25cb Audit Package\n\u25cb CSV          (Coming Soon)\n\u25cb TXT+EML      (Coming Soon)\n\u25cb JSON         (Coming Soon)\n\u25cb Excel        (Coming Soon)\n</code>\n\n<strong>Files Likely Affected</strong>\n\n\u2022 Export modal/dialog component (needs investigation)\n\n<strong>Priority</strong>\n\nLow - UX polish, not blocking functionality\n\n<strong>Created</strong>\n\n2026-01-19"
  },
  {
    "id": "BACKLOG-334",
    "title": "Export Settings - Persist Default Export Options and Format",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-19",
    "completed_at": "",
    "file": "[BACKLOG-334.md](BACKLOG-334.md)",
    "description": "<strong>Summary</strong>\n\nAdd settings to configure default export preferences so users don't have to re-select options each time they export.\n\n<strong>Requirements</strong>\n\n<strong>Settings to Add</strong>\n\n1. **Default Export Options** (what content to include)\n   - Emails only\n   - Text messages only\n   - Both (DEFAULT)\n\n2. **Default Export Format**\n   - Full PDF (DEFAULT)\n   - Summary PDF\n   - Audit Package\n   - (Future: CSV, JSON, Excel, TXT+EML)\n\n<strong>Behavior</strong>\n\n\u2022 Settings should persist across app sessions\n\u2022 Export dialog should pre-select the user's default preferences\n\u2022 User can still change options per-export in the dialog\n\u2022 Software defaults: \"Full PDF\" format + \"Both\" content\n\n<strong>UI Location</strong>\n\nSettings page \u2192 Export section (or new \"Export\" tab)\n\n<code>Export Defaults\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nDefault Content:    [Both \u25bc]\n                    \u2022 Emails only\n                    \u2022 Text messages only  \n                    \u2022 Both \u2713\n\nDefault Format:     [Full PDF \u25bc]\n                    \u2022 Full PDF \u2713\n                    \u2022 Summary PDF\n                    \u2022 Audit Package\n</code>\n\n<strong>Files Likely Affected</strong>\n\n\u2022 Settings page component\n\u2022 Settings store/state\n\u2022 Export dialog (read defaults)\n\u2022 Electron settings persistence\n\n<strong>Priority</strong>\n\nMedium - UX improvement for frequent exporters\n\n<strong>Created</strong>\n\n2026-01-19"
  },
  {
    "id": "BACKLOG-335",
    "title": "Enforce Transaction Start Date with Historical Message Filtering",
    "category": "service",
    "priority": "High",
    "status": "Pending",
    "sprint": "SPRINT-049",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-19",
    "completed_at": "",
    "file": "[BACKLOG-335.md](BACKLOG-335.md)",
    "description": "<strong>Summary</strong>\n\nMake transaction start date a required field for manual transactions. This date represents when the agent officially started representing the client and is used for historical message filtering.\n\n<strong>Problem</strong>\n\nThe start date is critical for:\n1. Filtering out messages that predate the transaction\n2. Ensuring audit reports only contain relevant communications\n3. Compliance and accuracy of transaction records\n\n<strong>Requirements</strong>\n\n<strong>1. Enforce Start Date on Manual Transaction Creation</strong>\n\u2022 Make start date a **required field** when creating transactions manually\n\u2022 Cannot save/create transaction without a start date\n\u2022 Label: \"Representation Start Date\" or \"Started Representing Client\"\n\u2022 Tooltip: \"The date you officially started representing this client\"\n\u2022 Provide date picker with sensible defaults\n\n<strong>2. Historical Message Filtering</strong>\n\u2022 Filter out ALL messages with sent_at before the transaction start date\n\u2022 Apply at:\n  - Message linking time (don't link old messages)\n  - Export time (double-check filter)\n  - UI display (show warning if old messages exist)\n\n<strong>3. Validation</strong>\n\u2022 Show clear error if user tries to save without start date\n\u2022 Prevent form submission until date is provided\n\n<strong>Files Likely Affected</strong>\n\n\u2022 Transaction creation form/modal (AuditTransactionModal.tsx)\n\u2022 Transaction validation logic\n\u2022 Message linking service\n\u2022 Export services (PDF, audit package)\n\n<strong>Priority</strong>\n\nHIGH - Critical for audit accuracy and compliance\n\n<strong>Created</strong>\n\n2026-01-19\n\n<strong>Notes</strong>\n\nAI-extracted date verification moved to separate backlog item (BACKLOG-384)."
  },
  {
    "id": "BACKLOG-336",
    "title": "Export Text Message Attachments with Message References",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-336.md](items/BACKLOG-336.md)",
    "description": "<strong>Summary</strong>\n\nInclude text message attachments (images, GIFs, files) in the audit package export, with proper references to the originating message and optional thumbnail previews in the manifest.\n\n<strong>Problem</strong>\n\nCurrently TASK-1141 only exports email attachments. Text message attachments are stored in the same <code>attachments</code> table but are not included because <code>exportAttachments()</code> is only called with email communications, not text messages.\n\nText message attachments include:\n\u2022 Photos shared via iMessage/SMS\n\u2022 GIFs and videos (videos deferred)\n\u2022 Files and documents\n\u2022 Voice messages (deferred)\n\n<strong>Requirements</strong>\n\n<strong>1. Include Text Attachments in Export</strong>\n\u2022 Call <code>exportAttachments()</code> with both <code>emails</code> AND <code>texts</code> arrays\n\u2022 Or pass all linked communications regardless of type\n\u2022 Use <code>communication_id</code> (not <code>message_id</code> column name) for unified lookup\n\n<strong>2. Message Reference in Manifest</strong>\n\u2022 Add <code>messageType</code> field to manifest entry: <code>\"email\"</code> or <code>\"text\"</code>\n\u2022 Add <code>messagePreview</code> field: first 100 chars of the message body\n\u2022 Add <code>conversationContext</code> for texts: contact name + thread identifier\n\n<strong>3. Thumbnail Support (Optional Enhancement)</strong>\n\u2022 For image attachments, generate a small thumbnail\n\u2022 Store thumbnail path in manifest\n\u2022 Display thumbnails in summary PDF or HTML manifest viewer\n\n<strong>Implementation Notes</strong>\n\n<strong>Current Code (folderExportService.ts)</strong>\n\n<code>// Line 179 - Only passes emails\nawait this.exportAttachments(transaction, emails, attachmentsPath);\n</code>\n\n<strong>Proposed Change</strong>\n\n<code>// Pass all communications (emails + texts)\nconst allCommunications = [...emails, ...texts];\nawait this.exportAttachments(transaction, allCommunications, attachmentsPath);\n</code>\n\n<strong>Manifest Enhancement</strong>\n\n<code>interface AttachmentManifestEntry {\n  filename: string;\n  originalMessage: string;  // Subject for emails, first line for texts\n  date: string;\n  size: number;\n  sourceEmailIndex?: number;  // Keep for backward compat\n  sourceMessageIndex?: number;  // Add for texts\n  messageType: \"email\" | \"text\";  // NEW\n  messagePreview?: string;  // NEW - first 100 chars\n  conversationContact?: string;  // NEW - for texts\n  status?: \"exported\" | \"file_not_found\" | \"copy_failed\";\n}\n</code>\n\n<strong>Files Likely Affected</strong>\n\n\u2022 <code>electron/services/folderExportService.ts</code> - Main export logic\n\u2022 Manifest interface (same file)\n\n<strong>Priority</strong>\n\nMEDIUM - Enhancement to TASK-1141, not critical but improves audit completeness\n\n<strong>Depends On</strong>\n\n\u2022 TASK-1141 (merged)\n\n<strong>Created</strong>\n\n2026-01-19"
  },
  {
    "id": "BACKLOG-337",
    "title": "Show Agent Name Instead of \"You\" in PDF Exports",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-337.md](items/BACKLOG-337.md)",
    "description": "<strong>Summary</strong>\n\nIn exported PDFs (both text thread PDFs and the main PDF export), outbound messages currently show \"You\" as the sender. Instead, show the actual real estate agent's name for a more professional audit document.\n\n<strong>Problem</strong>\n\nWhen exporting transaction communications for compliance/audit purposes, the PDFs show:\n\u2022 \"You\" for outbound messages\n\u2022 Contact name for inbound messages\n\nThis is informal and doesn't clearly identify who sent the message in an audit context. The agent's name should be displayed for professional documentation.\n\n<strong>Requirements</strong>\n\n<strong>1. Use Agent Name for Outbound Messages</strong>\n\u2022 Get the agent's display name from user profile/settings\n\u2022 Replace \"You\" with the agent's actual name in:\n  - Text thread PDFs (folderExportService.ts)\n  - Main PDF export conversation view (pdfExportService.ts)\n\n<strong>2. Fallback Behavior</strong>\n\u2022 If agent name is not set, fall back to email address\n\u2022 If neither available, use \"Agent\" instead of \"You\"\n\n<strong>Current Code</strong>\n\n**folderExportService.ts** (text thread PDFs):\n<code>// Line ~858 in generateTextMessageHTML\nconst isOutbound = msg.direction === 'outbound';\nlet senderName = 'You';  // <- Should be agent name\n</code>\n\n**pdfExportService.ts** (main PDF export):\n<code>// Similar pattern - uses \"You\" for outbound\n</code>\n\n<strong>Implementation Notes</strong>\n\n\u2022 Need to pass user/agent info to export services\n\u2022 Get agent name from: <code>user.display_name</code> or <code>user.email</code>\n\u2022 May need to update service method signatures\n\n<strong>Files Likely Affected</strong>\n\n\u2022 <code>electron/services/folderExportService.ts</code>\n\u2022 <code>electron/services/pdfExportService.ts</code>\n\u2022 <code>electron/transaction-handlers.ts</code> (to pass user info)\n\n<strong>Priority</strong>\n\nLOW - Cosmetic improvement for professionalism\n\n<strong>Created</strong>\n\n2026-01-20"
  },
  {
    "id": "BACKLOG-338",
    "title": "Google Profile Image Display Issue",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-20",
    "completed_at": "",
    "file": "[BACKLOG-338.md](items/BACKLOG-338.md)",
    "description": "<strong>Summary</strong>\n\nGoogle profile images not displaying correctly in circular avatar frames when user logs in with Google OAuth.\n\n<strong>Problem</strong>\n\nThe circular profile picture placeholder has display issues when showing Google profile images:\n\u2022 Images may appear broken or improperly cropped\n\u2022 The <code>rounded-full</code> class may not be properly containing the image\n\u2022 Potential CORS or loading issues with Google's image URLs\n\n<strong>Current Implementation</strong>\n\n<code><!-- Large avatar in profile section -->\n<img src=\"https://lh3.googleusercontent.com/a/...\"\n     alt=\"Username\"\n     class=\"w-16 h-16 rounded-full border-2 border-gray-200\">\n\n<!-- Small avatar in header button -->\n<button class=\"w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-purple-500...\">\n  <img src=\"https://lh3.googleusercontent.com/a/...\"\n       alt=\"Profile\"\n       class=\"w-8 h-8 rounded-full\">\n</button>\n</code>\n\n<strong>Potential Fixes</strong>\n\n1. **Add <code>object-cover</code> class** to ensure image fills the circular frame properly:\n   <code>   <img src=\"...\" class=\"w-8 h-8 rounded-full object-cover\">\n   </code>\n\n2. **Add fallback for failed image loads** - show initials or default avatar if Google image fails\n\n3. **Check for CORS issues** - Google images may need referrer policy adjustments\n\n4. **Add loading state** - show placeholder while image loads\n\n<strong>Files Likely Affected</strong>\n\n\u2022 <code>src/components/layout/AppHeader.tsx</code> or similar header component\n\u2022 <code>src/components/profile/</code> - profile-related components\n\u2022 Any component rendering user avatars\n\n<strong>Priority</strong>\n\nLOW - Visual polish, not blocking functionality\n\n<strong>Category</strong>\n\nUI"
  },
  {
    "id": "BACKLOG-339",
    "title": "Export Progress Indicator with Time Estimate",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-20",
    "completed_at": "",
    "file": "[BACKLOG-339.md](items/BACKLOG-339.md)",
    "description": "<strong>Summary</strong>\n\nAdd time estimate or detailed progress bar to export process instead of just a spinning loader.\n\n<strong>Problem</strong>\n\nCurrently the PDF export shows only a spinning loader with no indication of:\n\u2022 How long the export will take\n\u2022 What percentage is complete\n\u2022 What step the export is on\n\nNote: Audit Package export already has a progress bar showing current/total items.\n\n<strong>Desired Behavior</strong>\n\nFor PDF export:\n\u2022 Show estimated time remaining (e.g., \"~30 seconds remaining\")\n\u2022 Or show a progress bar with percentage\n\u2022 Or show current step (e.g., \"Generating page 3 of 15...\")\n\n<strong>Implementation Ideas</strong>\n\n1. **Time-based estimate**: Track average export time per message, estimate based on message count\n2. **Step-based progress**: Report progress from pdfExportService as it processes each communication\n3. **Indeterminate with steps**: Show what's happening (\"Loading communications...\", \"Rendering PDF...\", \"Saving file...\")\n\n<strong>Current Implementation</strong>\n\nPDF export in ExportModal.tsx (step 3):\n<code>{step === 3 && (\n  <div className=\"py-8 text-center\">\n    <div className=\"w-16 h-16 border-4 border-purple-600 border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n    <h4>Exporting...</h4>\n    <p>Creating your compliance audit export. This may take a moment.</p>\n  </div>\n)}\n</code>\n\nAudit Package already has progress:\n<code>{exportProgress && exportFormat === \"folder\" && (\n  <div className=\"mt-4 max-w-xs mx-auto\">\n    <div className=\"h-2 bg-gray-200 rounded-full overflow-hidden\">\n      <div className=\"h-full bg-purple-600\" style={{ width: <code>${percent}%</code> }} />\n    </div>\n    <p>{exportProgress.current} / {exportProgress.total}</p>\n  </div>\n)}\n</code>\n\n<strong>Files Likely Affected</strong>\n\n\u2022 <code>src/components/ExportModal.tsx</code> - UI changes\n\u2022 <code>electron/services/pdfExportService.ts</code> - Add progress callback\n\u2022 <code>electron/services/enhancedExportService.ts</code> - Pass progress to PDF service\n\n<strong>Priority</strong>\n\nLOW - UX improvement, not blocking functionality\n\n<strong>Category</strong>\n\nUI"
  },
  {
    "id": "BACKLOG-340",
    "title": "Show/Hide Messages Outside Date Range",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-340.md](items/BACKLOG-340.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-341",
    "title": "Add Year to Message Timestamps in Viewer",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-341.md](items/BACKLOG-341.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-342",
    "title": "Include Orphan Messages in Audit Export",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-342.md](items/BACKLOG-342.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-343",
    "title": "Show User's Actual Identifier in Group Chat Exports",
    "category": "feature",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-17",
    "completed_at": "",
    "file": "[BACKLOG-343.md](items/BACKLOG-343.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-344",
    "title": "Add Audit Package as Default Export Format Option",
    "category": "ui",
    "priority": "Medium",
    "status": "Obsolete",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "Superseded by BACKLOG-360",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-344.md](BACKLOG-344.md)",
    "description": "<strong>Description</strong>\n\nThe default export format dropdown in settings/preferences is missing \"Audit Package\" (folder export) as an option. Users should be able to select audit package as their preferred default export format.\n\n<strong>Current Behavior</strong>\n\n\u2022 Default export format options likely only include PDF and possibly other formats\n\u2022 Audit Package (folder with organized PDFs + attachments) is not available as a default choice\n\n<strong>Expected Behavior</strong>\n\n\u2022 \"Audit Package\" should appear in the default export format dropdown\n\u2022 When selected, clicking export on a transaction should default to folder export\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Audit Package appears in default format dropdown\n\u2610 Selecting it sets folder export as the default\n\u2610 Setting persists across app restarts\n\n<strong>Related</strong>\n\n\u2022 Folder export feature (already implemented)\n\u2022 Export modal component"
  },
  {
    "id": "BACKLOG-345",
    "title": "Verify PDF Export Uses Audit Package as Foundation",
    "category": "architecture",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-345.md](BACKLOG-345.md)",
    "description": "<strong>Description</strong>\n\nThe PDF export should be refactored to use the Audit Package (folder export) as its foundation, then add dynamic internal links on top. This consolidates the export logic into a single code path.\n\n<strong>Current State</strong>\n\nCurrently there are two separate export code paths:\n\u2022 <code>pdfExportService.ts</code> - generates PDF directly\n\u2022 <code>folderExportService.ts</code> - generates audit package (folder with PDFs + attachments)\n\nThis has led to:\n\u2022 Inconsistent date filtering logic between the two exports\n\u2022 Duplicate code for contact resolution, message formatting, etc.\n\u2022 Different behavior that confuses users\n\n<strong>Expected Architecture</strong>\n\n<code>folderExportService.ts (Audit Package)\n        \u2502\n        \u251c\u2500\u2500 Generates all PDFs (emails, texts, attachments)\n        \u251c\u2500\u2500 Handles date filtering (single source of truth)\n        \u251c\u2500\u2500 Resolves contact names\n        \u2514\u2500\u2500 Exports to folder structure\n              \u2502\n              \u25bc\npdfExportService.ts (PDF Report)\n        \u2502\n        \u251c\u2500\u2500 Uses Audit Package output as base\n        \u251c\u2500\u2500 Adds dynamic internal links (table of contents, navigation)\n        \u2514\u2500\u2500 Combines into single PDF document\n</code>\n\n<strong>Verification Checklist</strong>\n\n\u2610 PDF export date filtering matches Audit Package filtering exactly\n\u2610 Contact name resolution is consistent between both exports\n\u2610 Message formatting is identical in both outputs\n\u2610 No duplicate code for export logic\n\u2610 PDF-specific features (links, TOC) layer cleanly on top\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 PDF export uses <code>folderExportService</code> for content generation\n\u2610 Only PDF-specific logic (internal links, single document assembly) in <code>pdfExportService</code>\n\u2610 Date filtering happens in ONE place only\n\u2610 Both exports produce identical content (aside from format/linking)\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-331: PDF Export Date Range Filtering\n\u2022 SR Engineer review finding: \"Inconsistent date filtering logic between exports\"\n\n<strong>Notes</strong>\n\nThis is a verification task to ensure the consolidation is complete and working correctly. The refactoring may have already been partially done - need to audit current state."
  },
  {
    "id": "BACKLOG-346",
    "title": "Add Test Coverage for folderExportService.ts",
    "category": "test",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-346.md](BACKLOG-346.md)",
    "description": "<strong>Description</strong>\n\n<code>folderExportService.ts</code> is a critical 2057-line file with 0% test coverage. It handles all audit package exports and has significant business logic that needs testing.\n\n<strong>Source</strong>\n\nSR Engineer review (2026-01-21): \"The folderExportService.ts file (2057 lines) has significant new functionality... No test file exists.\"\n\n<strong>Functions to Test</strong>\n\n\u2022 <code>_isGroupChat()</code> - group chat detection logic\n\u2022 <code>getGroupChatParticipants()</code> - participant extraction from messages\n\u2022 <code>_filterCommunicationsByDate()</code> - date range filtering\n\u2022 File naming logic (<code>email_</code>, <code>text_</code> prefixes)\n\u2022 Contact name resolution\n\u2022 Attachment export with fallback lookups\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Create <code>electron/services/__tests__/folderExportService.test.ts</code>\n\u2610 Test group chat detection edge cases\n\u2610 Test date filtering boundary conditions\n\u2610 Test file naming conventions\n\u2610 Achieve >60% coverage for the service\n\n<strong>Priority</strong>\n\nHigh - Critical export functionality without safety net"
  },
  {
    "id": "BACKLOG-347",
    "title": "Enable Branch Protection Rules on develop",
    "category": "infra",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-347.md](BACKLOG-347.md)",
    "description": "<strong>Description</strong>\n\nEnable GitHub branch protection rules to prevent direct commits to <code>develop</code> branch. All changes should go through PR workflow.\n\n<strong>Source</strong>\n\nSR Engineer review (2026-01-21): \"Many commits were pushed directly to the develop branch without going through a PR review process (~20+ commits).\"\n\nCLAUDE.md states: \"ALL work MUST go through a branch + PR workflow. There are NO exceptions.\"\n\n<strong>Implementation</strong>\n\n1. Go to GitHub repo Settings > Branches\n2. Add branch protection rule for <code>develop</code>:\n   - Require pull request before merging\n   - Require at least 1 approval (optional)\n   - Require status checks to pass (CI)\n   - Do not allow bypassing the above settings\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Branch protection enabled on <code>develop</code>\n\u2610 Direct pushes blocked\n\u2610 PRs required for all changes\n\u2610 CI must pass before merge\n\n<strong>Priority</strong>\n\nHigh - Process enforcement to prevent future violations"
  },
  {
    "id": "BACKLOG-348",
    "title": "Consolidate Field Allowlists (Single Source of Truth)",
    "category": "refactor",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-348.md](BACKLOG-348.md)",
    "description": "<strong>Description</strong>\n\nField allowlists are maintained in two places, causing potential drift and confusion:\n\u2022 <code>electron/services/db/transactionDbService.ts</code> - <code>allowedFields</code> array\n\u2022 <code>electron/utils/sqlFieldWhitelist.ts</code> - centralized whitelist utility\n\n<strong>Source</strong>\n\nSR Engineer review (2026-01-21): \"started_at, closed_at, and closing_date were added to allowedFields in transactionDbService.ts, but the corresponding sqlFieldWhitelist.ts already had these fields. The duplication could cause confusion.\"\n\n<strong>Current State</strong>\n\n<code>// transactionDbService.ts (lines 295-297)\nconst allowedFields = [..., 'started_at', 'closed_at', 'closing_deadline'];\n\n// sqlFieldWhitelist.ts (lines 98-99)\nTRANSACTION_UPDATE_FIELDS = [..., 'started_at', 'closed_at', ...];\n</code>\n\n<strong>Expected State</strong>\n\n\u2022 <code>sqlFieldWhitelist.ts</code> is the ONLY source of truth for allowed fields\n\u2022 <code>transactionDbService.ts</code> imports and uses <code>validateFields()</code> from whitelist utility\n\u2022 No inline <code>allowedFields</code> arrays in service files\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Remove duplicate <code>allowedFields</code> from transactionDbService.ts\n\u2610 Use <code>validateFields()</code> from sqlFieldWhitelist.ts\n\u2610 Audit other services for similar duplication\n\u2610 Single source of truth for all SQL field validation\n\n<strong>Priority</strong>\n\nMedium - Prevents allowlist drift and simplifies maintenance"
  },
  {
    "id": "BACKLOG-349",
    "title": "Share FolderExportProgress Type Across IPC Boundary",
    "category": "refactor",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-349.md](BACKLOG-349.md)",
    "description": "<strong>Description</strong>\n\nThe <code>FolderExportProgress</code> type is defined inline in <code>eventBridge.ts</code> instead of being imported from a shared location. This creates type duplication that can drift over time.\n\n<strong>Source</strong>\n\nSR Engineer review (2026-01-21): \"New onExportFolderProgress listener added with inline type definition... The type is duplicated from the interface FolderExportProgress in folderExportService.ts.\"\n\n<strong>Current State</strong>\n\n<code>// eventBridge.ts (inline definition)\n(callback: (progress: { stage: string; current: number; total: number; message: string }) => void)\n\n// folderExportService.ts (proper interface)\ninterface FolderExportProgress {\n  stage: string;\n  current: number;\n  total: number;\n  message: string;\n}\n</code>\n\n<strong>Expected State</strong>\n\n\u2022 Export <code>FolderExportProgress</code> from <code>folderExportService.ts</code> or define in <code>electron/types/ipc.ts</code>\n\u2022 Import and use in <code>eventBridge.ts</code>\n\u2022 Single type definition shared across IPC boundary\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Move/export FolderExportProgress to shared types location\n\u2610 Import in eventBridge.ts\n\u2610 No inline type definitions for IPC events\n\n<strong>Priority</strong>\n\nMedium - Prevents type drift in IPC layer"
  },
  {
    "id": "BACKLOG-350",
    "title": "Refactor folderExportService.ts (2057 Lines)",
    "category": "refactor",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-350.md](BACKLOG-350.md)",
    "description": "<strong>Description</strong>\n\n<code>folderExportService.ts</code> has grown to 2057 lines and handles multiple responsibilities. Consider splitting into focused modules.\n\n<strong>Source</strong>\n\nSR Engineer review (2026-01-21): \"The file has grown substantially with all the new features. It contains: PDF generation, Text thread handling, Attachment management, Contact name resolution, Multiple HTML template generators.\"\n\n<strong>Suggested Split</strong>\n\n<code>electron/services/export/\n\u251c\u2500\u2500 folderExportService.ts      # Orchestration + folder structure\n\u251c\u2500\u2500 pdfGenerationService.ts     # PDF creation with puppeteer\n\u251c\u2500\u2500 textThreadExportService.ts  # Text/SMS thread handling\n\u251c\u2500\u2500 attachmentExportService.ts  # Attachment copying + fallbacks\n\u2514\u2500\u2500 exportTemplates.ts          # HTML template generators\n</code>\n\n<strong>Benefits</strong>\n\n\u2022 Easier to test individual modules\n\u2022 Clearer responsibility boundaries\n\u2022 Reduced cognitive load when editing\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Split into focused modules\n\u2610 Maintain existing public API\n\u2610 No behavior changes\n\u2610 Tests pass after refactor\n\n<strong>Priority</strong>\n\nLow - Future refactoring when time permits"
  },
  {
    "id": "BACKLOG-351",
    "title": "Add Logging to Empty Catch Blocks in Export Services",
    "category": "refactor",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-351.md](BACKLOG-351.md)",
    "description": "<strong>Description</strong>\n\nMultiple catch blocks in <code>folderExportService.ts</code> silently swallow errors, making debugging difficult.\n\n<strong>Source</strong>\n\nSR Engineer review (2026-01-21): \"Multiple catch blocks that silently continue... Errors are silently swallowed, making debugging difficult.\"\n\n<strong>Locations</strong>\n\n\u2022 <code>folderExportService.ts</code> lines: 148, 795, 836, 908, 940, 1015\n\u2022 Pattern: <code>} catch { // Continue }</code>\n\n<strong>Expected</strong>\n\nReplace silent catches with at least debug-level logging:\n\n<code>// Before\n} catch {\n  // Continue\n}\n\n// After\n} catch (error) {\n  logService.debug('Parse error in thread extraction', { error, context: '...' });\n}\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Audit all catch blocks in export services\n\u2610 Add debug-level logging with context\n\u2610 Errors are traceable in logs\n\u2610 No silent failures\n\n<strong>Priority</strong>\n\nLow - Improves debuggability when issues occur"
  },
  {
    "id": "BACKLOG-352",
    "title": "Export Success Message with Finder Link and Close Transaction Prompt",
    "category": "ui",
    "priority": "High",
    "status": "Pending",
    "sprint": "SPRINT-049",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-352.md](items/BACKLOG-352.md)",
    "description": "<strong>Description</strong>\n\nImprove the export completion experience with better button styling and persistent export history in the Overview tab.\n\n<strong>Current State</strong>\n\nExport complete screen shows:\n<code>Export Complete!\nYour export has been saved successfully.\n\n[Open in Finder]  (link style)\n[Done]            (button style)\n</code>\n\nAlso shows a green auto-dismiss success bar in transaction details.\n\n<strong>Required Changes</strong>\n\n<strong>1. Export Complete Screen - Button Styling</strong>\n\u2022 Make \"Open in Finder\" look like the \"Done\" button (styled as a button, keep the folder icon)\n\u2022 Put both buttons **side by side**\n\n<code>Export Complete!\nYour export has been saved successfully.\n\n[Open in Finder]  [Done]\n     \u2191 same style as Done button, with folder icon\n</code>\n\n<strong>2. Remove Auto-Dismiss Success Bar</strong>\nRemove the green success bar that appears and auto-dismisses in transaction details after export. It's redundant now.\n\n<strong>3. Persistent Export History in Overview Tab</strong>\nInstead of the temporary green bar, add a persistent section in the Overview tab:\n\n<code>Last Exported\nJan 22, 2026 at 3:45 PM\n[Open in Finder]\n</code>\n\n\u2022 Shows when transaction was last exported\n\u2022 Button to open the exported file location\n\u2022 Only shows if transaction has been exported at least once\n\u2022 If never exported, don't show this section (or show \"Not exported yet\")\n\n<strong>Database Changes (from BACKLOG-382)</strong>\n\n<code>ALTER TABLE transactions ADD COLUMN last_exported_at TEXT;\nALTER TABLE transactions ADD COLUMN last_export_path TEXT;\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 \"Open in Finder\" button styled same as \"Done\" button\n\u2610 Both buttons side by side on export complete screen\n\u2610 Green auto-dismiss success bar removed\n\u2610 Overview tab shows \"Last Exported\" section with date and open button\n\u2610 Export updates last_exported_at and last_export_path in database\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-382 (Persistent Export History - can be merged with this)\n\u2022 ExportModal.tsx\n\u2022 TransactionDetailsTab.tsx (Overview section)"
  },
  {
    "id": "BACKLOG-353",
    "title": "PDF Authenticity Hash Verification via Supabase",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-353.md](items/BACKLOG-353.md)",
    "description": "<strong>Description</strong>\n\nCreate a system to verify the authenticity of exported audit PDFs. When a PDF is generated, compute a cryptographic hash and store it in Supabase. Later, if someone wants to verify a PDF hasn't been tampered with, they can check the hash against the stored record.\n\n<strong>Technical Approach</strong>\n\n1. **On Export**:\n   - Generate PDF\n   - Compute SHA-256 hash of the PDF file\n   - Store in Supabase: <code>{ transaction_id, hash, exported_at, file_name }</code>\n\n2. **Verification** (future feature):\n   - User uploads or selects a PDF\n   - App computes hash\n   - Compares against Supabase record\n   - Shows \"Verified\" or \"Hash mismatch - file may have been modified\"\n\n<strong>Database Schema</strong>\n\n<code>CREATE TABLE audit_hashes (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  transaction_id UUID REFERENCES transactions(id),\n  file_hash VARCHAR(64) NOT NULL,  -- SHA-256 hex\n  file_name VARCHAR(255),\n  exported_at TIMESTAMP DEFAULT NOW(),\n  exported_by UUID REFERENCES users(id)\n);\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Hash computed on PDF export\n\u2610 Hash stored in Supabase with transaction reference\n\u2610 (Future) Verification endpoint/UI to check hash\n\n<strong>Notes</strong>\n\nThis provides a way to certify authenticity of audit documents - important for legal/compliance purposes in real estate transactions."
  },
  {
    "id": "BACKLOG-354",
    "title": "Remove Phone Number Under Each Text in 1:1 Chat Exports",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "SPRINT-049",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-354.md](items/BACKLOG-354.md)",
    "description": "<strong>Description</strong>\n\nIn the PDF export for 1:1 text conversations, the phone number is shown under every message. This is redundant since it's the same person throughout the conversation.\n\n**Before:**\n<code>GianCarlo Jan 6, 2026, 02:05 PM\n+14243335133\n</code>\n\n**After:**\n<code>GianCarlo Jan 6, 2026, 02:05 PM\n</code>\n\n**Note**: This should ONLY apply to 1:1 chats. Group chats still need the phone number to identify who sent each message.\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 1:1 chat exports don't show phone number under each message\n\u2610 Group chat exports still show phone number under each message\n\u2610 Contact name still displays for all messages\n\n<strong>Technical Notes</strong>\n\nNeed to check if this was already completed. The logic should detect if it's a group chat (multiple participants) vs 1:1 chat (single contact) and conditionally show the phone number.\n\n<strong>Related</strong>\n\n\u2022 folderExportService.ts\n\u2022 pdfExportService.ts"
  },
  {
    "id": "BACKLOG-355",
    "title": "Add Back to Email Threads Link in Full Audit PDF",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "SPRINT-049",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-355.md](items/BACKLOG-355.md)",
    "description": "<strong>Description</strong>\n\nIn the full audit PDF (not audit package), text conversations have a \"\u2190 Back to Text Conversations\" link that navigates back to the index. The same functionality is needed for email threads - they should have \"\u2190 Back to Email Threads\" that jumps to the Email Threads section.\n\n<strong>Current State</strong>\n\n\u2022 Text threads have: \"\u2190 Back to Text Conversations\" link\n\u2022 Email threads: No back link\n\n<strong>Expected State</strong>\n\n\u2022 Text threads: \"\u2190 Back to Text Conversations\" (existing)\n\u2022 Email threads: \"\u2190 Back to Email Threads\" (new)\n\nBoth should use PDF internal links to navigate to their respective index sections.\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Email thread pages have \"\u2190 Back to Email Threads\" link\n\u2610 Link navigates to Email Threads index section in PDF\n\u2610 Styling consistent with text conversation back link\n\n<strong>Related</strong>\n\n\u2022 pdfExportService.ts\n\u2022 Similar to existing text thread back link implementation"
  },
  {
    "id": "BACKLOG-356",
    "title": "Redesign Text Conversation Cards - Date Range and No Preview",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "SPRINT-049",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-356.md](items/BACKLOG-356.md)",
    "description": "<strong>Description</strong>\n\nRefine the text conversation cards in transaction details for consistency.\n\n<strong>Current State</strong>\n\nCards already show the compact format with date range. Just need consistency tweaks.\n\n<strong>Required Changes</strong>\n\n<strong>1. 1:1 Chats - Consistent Phone Layout</strong>\nPut the phone number on its own line under the contact name (for design consistency):\n\n<code>GianCarlo\n+14243335133\nJan 1 - Jan 6                    View Full \u2192\n</code>\n\n(Currently it wraps to second line only if name is long - make it always on second line)\n\n<strong>2. Group Chats - Recipients Format</strong>\n\u2022 Remove the colon after \"Group Chat\" (or header)\n\u2022 Put all recipients on a new line\n\u2022 Use same font styling as phone number in 1:1 chats\n\n<code>Group Chat\nJohn, Sarah, Mike\nJan 1 - Jan 6                    View Full \u2192\n</code>\n\nNOT:\n<code>Group Chat: John, Sarah, Mike    (wrong - has colon)\n</code>\n\n<strong>3. Prioritize Contact Names</strong>\n\u2022 Always show contact display name if available\n\u2022 Only show phone number if no contact name exists\n\u2022 For group chats, show all names (not phone numbers)\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 1:1 chats: Phone number always on separate line under name\n\u2610 Group chats: No colon, recipients on their own line\n\u2610 Group chat recipients use same font as 1:1 phone numbers\n\u2610 Contact names prioritized over phone numbers\n\u2610 Consistent styling between 1:1 and group chat cards\n\n<strong>Related</strong>\n\n\u2022 MessageThreadCard.tsx\n\u2022 TransactionMessagesTab.tsx"
  },
  {
    "id": "BACKLOG-357",
    "title": "Filter Text Preview by Audit Dates with Toggle",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "SPRINT-049",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-357.md](items/BACKLOG-357.md)",
    "description": "<strong>Description</strong>\n\nAdd a toggle to filter the text message **card list** by the transaction's audit date range.\n\n<strong>Current State</strong>\n\n\u2022 **Conversation preview modal**: Has date filtering toggle \u2713 DONE\n\u2022 **Text message card list**: No date filtering toggle \u2717 PENDING\n\n<strong>Required Changes</strong>\n\n<strong>Add Toggle to Text Message Card List</strong>\n\nNear the \"Text Messages (X) in Y conversations\" header, add a toggle to filter by audit dates:\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Text Messages (45)              [\u2611 Audit period]   \u2502\n\u2502 in 4 conversations                                  \u2502\n\u2502                                                     \u2502\n\u2502 (Showing 45 of 571 messages within Nov 8 - Jan 27) \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 [Thread cards...]                                   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n**Behavior:**\n\u2022 Toggle ON (default): Shows only threads/messages within audit date range (started_at to closed_at)\n\u2022 Toggle OFF: Shows all threads/messages\n\u2022 Count updates to reflect filtered totals\n\u2022 Threads with NO messages in audit period are hidden when toggle is ON\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Toggle button in text messages header area\n\u2610 Default: ON (show audit period only)\n\u2610 Updates message count and conversation count when toggled\n\u2610 Shows date range in UI (e.g., \"Nov 8 - Jan 27\")\n\u2610 Threads with no messages in audit period are hidden when toggle is ON\n\u2610 Toggle state persists during session\n\u2610 Handles missing dates gracefully (if no dates set, show all)\n\n<strong>Technical Notes</strong>\n\n\u2022 TransactionMessagesTab.tsx - Main list view\n\u2022 Need access to transaction.started_at and transaction.closed_at\n\u2022 Filter logic similar to enhancedExportService._filterCommunicationsByDate()\n\u2022 Match the toggle styling from ConversationViewModal\n\n<strong>Related</strong>\n\n\u2022 ConversationViewModal.tsx (already has this feature - use as reference)\n\u2022 Export filtering uses same date range logic"
  },
  {
    "id": "BACKLOG-358",
    "title": "Deleted Messages Tab in Transaction Details",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-358.md](items/BACKLOG-358.md)",
    "description": "<strong>Description</strong>\n\nAdd a new tab in the transaction details view to show deleted messages. These are orphan messages that might have been deleted during the time of the transaction. Since we know they were deleted, they should be visible in the audit even though they can't be 100% associated with a specific conversation.\n\n<strong>Why This Matters</strong>\n\nIn real estate audits, deleted messages during a transaction period could be significant. By surfacing these deleted/orphan messages, auditors can:\n\u2022 See communications that may have been intentionally hidden\n\u2022 Identify gaps in conversation threads\n\u2022 Provide a more complete audit trail\n\n<strong>Implementation</strong>\n\n1. Add a new \"Deleted Messages\" tab in TransactionDetailsPage\n2. Query for messages marked as deleted or orphaned within the transaction date range\n3. Display with appropriate warnings that these couldn't be matched to conversations\n4. Show metadata: date, approximate time, any recoverable content\n\n<strong>UI Mockup</strong>\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 [Messages] [Emails] [Contacts] [Deleted Messages (3)]        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 \u26a0\ufe0f These messages were deleted during the transaction period \u2502\n\u2502 and could not be matched to a specific conversation.        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Jan 3, 2026 2:15 PM - Unknown Sender                        \u2502\n\u2502 [Content if recoverable, or \"Message content deleted\"]      \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Jan 4, 2026 10:30 AM - +14155551234                         \u2502\n\u2502 \"Partial message content...\"                                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 New \"Deleted Messages\" tab in transaction details\n\u2610 Queries deleted/orphan messages within transaction date range\n\u2610 Shows warning banner explaining these are deleted messages\n\u2610 Displays available metadata and content\n\u2610 Count shown in tab title\n\u2610 Excluded from main Messages tab\n\n<strong>Technical Notes</strong>\n\nNeed to investigate:\n\u2022 How iOS backup marks deleted messages\n\u2022 Whether we're already storing this data\n\u2022 If not, may need to enhance import to capture deleted message records\n\n<strong>Related</strong>\n\n\u2022 TransactionDetailsPage.tsx\n\u2022 Messages import service\n\u2022 iOS backup parser"
  },
  {
    "id": "BACKLOG-359",
    "title": "Add Audit Date Range to Summary PDF Title",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-359.md](items/BACKLOG-359.md)",
    "description": "<strong>Description</strong>\n\nIn the summary PDF export, add the date range that the transaction audit covers directly under the title. This makes it immediately clear what time period the audit represents.\n\n<strong>Current State</strong>\n\n<code>Transaction Audit Summary\n123 Main Street, Los Angeles, CA\n\n[Summary content...]\n</code>\n\n<strong>Expected State</strong>\n\n<code>Transaction Audit Summary\n123 Main Street, Los Angeles, CA\nAudit Period: January 1, 2026 - January 15, 2026\n\n[Summary content...]\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Date range displayed under title in summary PDF\n\u2610 Uses transaction start_date and closed_at/end_date\n\u2610 Human-readable date format (e.g., \"January 1, 2026\")\n\u2610 Labeled as \"Audit Period:\" for clarity\n\n<strong>Related</strong>\n\n\u2022 pdfExportService.ts\n\u2022 Transaction start_date and closed_at fields"
  },
  {
    "id": "BACKLOG-360",
    "title": "Default Export to Audit Package - One PDF as Coming Soon",
    "category": "ui",
    "priority": "High",
    "status": "Pending",
    "sprint": "SPRINT-049",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-360.md](items/BACKLOG-360.md)",
    "description": "<strong>Description</strong>\n\nUpdate the export modal to:\n1. Default selection to \"Audit Package\" (folder export)\n2. Mark \"One PDF\" option as \"Coming Soon\" and disable it for now\n\nThis prioritizes the more complete Audit Package export as the default user experience.\n\n<strong>Current State</strong>\n\n\u2022 Export modal shows multiple format options\n\u2022 No clear default or one may be PDF\n\n<strong>Expected State</strong>\n\n\u2022 \"Audit Package\" is pre-selected by default\n\u2022 \"One PDF\" option shows \"(Coming Soon)\" label and is disabled/greyed out\n\u2022 Other options available as before\n\n<strong>UI Mockup</strong>\n\n<code>Export Format:\n\u25c9 Audit Package (Recommended)\n  Organized folder with PDFs and attachments\n\n\u25cb One PDF (Coming Soon)\n  Single combined PDF document\n  [Disabled/greyed out]\n\n\u25cb Summary Only\n  Brief overview PDF\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Audit Package is default selected option\n\u2610 One PDF shows \"(Coming Soon)\" label\n\u2610 One PDF option is disabled and cannot be selected\n\u2610 Clear visual distinction for disabled option\n\u2610 Default persists on modal reopen\n\n<strong>Notes</strong>\n\nThis supersedes BACKLOG-344 which only addressed adding Audit Package to settings. This item specifically addresses the export modal defaults.\n\n<strong>Related</strong>\n\n\u2022 ExportModal.tsx\n\u2022 BACKLOG-344 (related but different scope)"
  },
  {
    "id": "BACKLOG-361",
    "title": "Remove Progress Bar from Audit Package Exporter",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-361.md](items/BACKLOG-361.md)",
    "description": "<strong>Description</strong>\n\nIn the Audit Package export process, remove the progress bar and the \"X/X\" count display. Keep only the spinning animation to indicate the export is in progress.\n\n<strong>Current State</strong>\n\n<code>Exporting...\n[\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591]\n15 / 47\n</code>\n\n<strong>Expected State</strong>\n\n<code>Exporting...\n[Spinning animation only]\n</code>\n\n<strong>Rationale</strong>\n\nThe detailed progress can create anxiety if it seems slow, and the current implementation may not accurately reflect actual progress. A simple animation is cleaner and sets appropriate expectations.\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Progress bar removed from Audit Package export\n\u2610 X/X count removed\n\u2610 Spinning/loading animation remains\n\u2610 \"Exporting...\" or similar status text remains\n\n<strong>Related</strong>\n\n\u2022 ExportModal.tsx\n\u2022 Note: This is opposite of BACKLOG-339 which wanted to ADD progress to PDF export"
  },
  {
    "id": "BACKLOG-362",
    "title": "Increase Export Success Popup Visibility Duration",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "SPRINT-049",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-362.md](items/BACKLOG-362.md)",
    "description": "<strong>Description</strong>\n\nThe popup message that appears after export completion (showing the link to open the audit folder in Finder) auto-dismisses too quickly. Users may miss the link before they can click it. Increase the display duration significantly.\n\n<strong>Current Behavior</strong>\n\n\u2022 Success popup appears\n\u2022 Auto-dismisses after ~3-5 seconds (estimated)\n\u2022 User may miss the Finder link\n\n<strong>Expected Behavior</strong>\n\n\u2022 Success popup appears\n\u2022 Stays visible for much longer (15-30 seconds) OR\n\u2022 Requires manual dismissal (preferred)\n\u2022 User has plenty of time to click \"Open in Finder\" link\n\n<strong>Options</strong>\n\n1. **Manual dismiss only**: Popup stays until user clicks X or \"Got it\"\n2. **Extended timer**: 30 second auto-dismiss\n3. **Hybrid**: 30 seconds with manual dismiss option\n\nRecommendation: Manual dismiss only, since this is an important action point.\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Success popup with Finder link visible for longer\n\u2610 User has ample time to click the link\n\u2610 Clear dismiss button/action\n\u2610 Works for both PDF and Audit Package exports\n\n<strong>Related</strong>\n\n\u2022 ExportModal.tsx\n\u2022 BACKLOG-352 (export success flow improvements)"
  },
  {
    "id": "BACKLOG-363",
    "title": "Reorganize Transaction Details Tabs - Move Emails to Own Tab",
    "category": "ui",
    "priority": "High",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "Already implemented - TransactionEmailsTab.tsx exists",
    "created_at": "2026-01-21",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-363.md](items/BACKLOG-363.md)",
    "description": "<strong>Description</strong>\n\nReorganize the transaction details page tabs:\n\n1. **Move** \"Related Emails\" from the current details tab to its own \"Emails\" tab\n2. **Add** relevant transaction details to the default/overview tab:\n   - Audit start and end dates\n   - Contacts with their roles (moved from Contacts tab or duplicated)\n\n<strong>Current Tab Structure</strong>\n\n<code>[Details] [Messages] [Contacts] [...]\n   \u2514\u2500\u2500 Related Emails section\n   \u2514\u2500\u2500 Other details\n</code>\n\n<strong>Expected Tab Structure</strong>\n\n<code>[Overview] [Messages] [Emails] [Contacts] [...]\n   \u2502          \u2502         \u2502        \u2502\n   \u2502          \u2502         \u2502        \u2514\u2500\u2500 Contact list only\n   \u2502          \u2502         \u2514\u2500\u2500 Dedicated email threads section\n   \u2502          \u2514\u2500\u2500 Text conversations\n   \u2514\u2500\u2500 Transaction info:\n       - Audit period (start - end date)\n       - Contacts & their roles\n       - Property address\n       - Status\n</code>\n\n<strong>Changes Summary</strong>\n\n1. **New \"Emails\" tab**: Dedicated space for email threads\n2. **Rename \"Details\" to \"Overview\"** (optional, for clarity)\n3. **Add to Overview tab**:\n   - Audit period prominently displayed\n   - Contacts with roles (may be summary/quick view)\n4. **Remove from Overview tab**:\n   - Related Emails section (moved to Emails tab)\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 New \"Emails\" tab created\n\u2610 Email threads moved from details to Emails tab\n\u2610 Audit date range shown in overview/default tab\n\u2610 Contacts with roles shown in overview/default tab\n\u2610 Navigation between tabs works smoothly\n\u2610 Tab counts/badges updated appropriately\n\n<strong>Related</strong>\n\n\u2022 TransactionDetailsPage.tsx\n\u2022 TransactionDetailsTab.tsx\n\u2022 TransactionEmailsTab.tsx (may need to create)\n\u2022 TransactionContactsTab.tsx"
  },
  {
    "id": "BACKLOG-364",
    "title": "Remove Duplicate transaction_participants Table",
    "category": "technical debt",
    "priority": "Critical",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-364.md](items/BACKLOG-364.md)",
    "description": "<strong>Problem Statement</strong>\n\nThe schema contains TWO junction tables for linking contacts to transactions:\n\n1. <code>transaction_participants</code> - Defined in schema but **NOT used by any service**\n2. <code>transaction_contacts</code> - The actual table used by contactDbService\n\nThis creates confusion and potential data integrity issues:\n\u2022 Developers may use the wrong table\n\u2022 <code>transaction_summary</code> view references <code>transaction_participants</code> (line 849)\n\u2022 Schema has indexes for both tables, wasting space\n\n<strong>Evidence</strong>\n\n**Schema (schema.sql lines 352-385):**\n<code>CREATE TABLE IF NOT EXISTS transaction_participants (\n  id TEXT PRIMARY KEY,\n  transaction_id TEXT NOT NULL,\n  contact_id TEXT NOT NULL,\n  role TEXT CHECK (role IN (...)),\n  ...\n);\n</code>\n\n**Schema (schema.sql lines 387-409):**\n<code>CREATE TABLE IF NOT EXISTS transaction_contacts (\n  id TEXT PRIMARY KEY,\n  transaction_id TEXT NOT NULL,\n  contact_id TEXT NOT NULL,\n  role TEXT,\n  role_category TEXT,\n  specific_role TEXT,\n  ...\n);\n</code>\n\n**The view uses transaction_participants:**\n<code>(SELECT COUNT(*) FROM transaction_participants tp WHERE tp.transaction_id = t.id) as participant_count\n</code>\n\n<strong>Required Changes</strong>\n\n<strong>1. Migration Script</strong>\n\u2022 Migrate any data from <code>transaction_participants</code> to <code>transaction_contacts</code> (if any exists)\n\u2022 Update <code>transaction_summary</code> view to use <code>transaction_contacts</code>\n\u2022 Drop <code>transaction_participants</code> table and its indexes\n\n<strong>2. Schema Update</strong>\n\u2022 Remove <code>transaction_participants</code> table definition\n\u2022 Remove associated indexes\n\u2022 Update <code>transaction_summary</code> view\n\n<strong>3. Verification</strong>\n\u2022 Confirm no services reference <code>transaction_participants</code>\n\u2022 Confirm view works correctly after update\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 No <code>transaction_participants</code> table in schema\n\u2610 <code>transaction_summary</code> view uses <code>transaction_contacts</code>\n\u2610 Migration handles any existing data\n\u2610 All existing tests pass\n\u2610 No code references <code>transaction_participants</code>\n\n<strong>Estimation</strong>\n\n\u2022 **Category:** database/migration\n\u2022 **Estimated Tokens:** ~5K\n\u2022 **Risk:** Low (table appears unused)\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-296 (FINDING-01): Originally identified this issue\n\u2022 contactDbService.ts: Uses transaction_contacts"
  },
  {
    "id": "BACKLOG-365",
    "title": "Fix feedbackService Table Reference Mismatch",
    "category": "bug",
    "priority": "Critical",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-365.md](items/BACKLOG-365.md)",
    "description": "<strong>Problem Statement</strong>\n\nThe feedback system has a table mismatch that could cause runtime errors:\n\n\u2022 **feedbackService.ts** calls <code>window.api.feedback.*</code> methods\n\u2022 **Migration <code>add_user_feedback.sql</code>** creates <code>user_feedback</code> table\n\u2022 **Schema <code>schema.sql</code>** defines <code>classification_feedback</code> table (different structure)\n\nThe IPC handlers (via window.api.feedback) may be querying a table that doesn't exist or has the wrong structure.\n\n<strong>Evidence</strong>\n\n**add_user_feedback.sql (migration):**\n<code>CREATE TABLE IF NOT EXISTS user_feedback (\n  id TEXT PRIMARY KEY,\n  user_id TEXT NOT NULL,\n  transaction_id TEXT NOT NULL,\n  field_name TEXT NOT NULL,\n  original_value TEXT,\n  corrected_value TEXT,\n  feedback_type TEXT CHECK (feedback_type IN ('correction', 'confirmation', 'rejection')),\n  source_communication_id TEXT,\n  ...\n);\n</code>\n\n**schema.sql (lines 498-533):**\n<code>CREATE TABLE IF NOT EXISTS classification_feedback (\n  id TEXT PRIMARY KEY,\n  user_id TEXT NOT NULL,\n  message_id TEXT,\n  attachment_id TEXT,\n  transaction_id TEXT,\n  contact_id TEXT,\n  feedback_type TEXT CHECK (feedback_type IN ('message_relevance', 'transaction_link', ...)),\n  original_value TEXT,\n  corrected_value TEXT,\n  ...\n);\n</code>\n\n**Key Differences:**\n| Field | user_feedback | classification_feedback |\n|-------|---------------|------------------------|\n| transaction_id | NOT NULL | Nullable |\n| field_name | Present | Absent |\n| message_id | Absent | Present |\n| feedback_type values | correction/confirmation/rejection | message_relevance/transaction_link/etc. |\n\n<strong>Investigation Needed</strong>\n\n1. Check which table the IPC handlers actually query\n2. Determine if <code>user_feedback</code> migration was ever run\n3. Identify if data exists in either table\n4. Determine intended feedback workflow\n\n<strong>Potential Solutions</strong>\n\n<strong>Option A: Align feedbackService with classification_feedback</strong>\n\u2022 Update feedbackService.ts to use classification_feedback schema\n\u2022 Update IPC handlers to query classification_feedback\n\u2022 Deprecate user_feedback migration\n\n<strong>Option B: Keep Both Tables for Different Purposes</strong>\n\u2022 <code>user_feedback</code> for field-level corrections (closing_date, sale_price)\n\u2022 <code>classification_feedback</code> for AI classification corrections (message relevance, roles)\n\u2022 Update services to use correct table for each purpose\n\n<strong>Option C: Merge Tables</strong>\n\u2022 Create unified feedback table supporting both use cases\n\u2022 Migrate data from both tables\n\u2022 Update all services\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Feedback service successfully reads/writes data\n\u2610 No runtime errors when using feedback features\n\u2610 Clear documentation of feedback data model\n\u2610 Migration handles any existing data\n\n<strong>Estimation</strong>\n\n\u2022 **Category:** database/service refactor\n\u2022 **Estimated Tokens:** ~8K (includes investigation)\n\u2022 **Risk:** Medium (need to understand current data and usage)\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-296 (FINDING-03): Originally identified this issue\n\u2022 feedbackService.ts: Renderer-side abstraction\n\u2022 electron/handlers/feedbackHandler.ts: IPC handlers (if exists)"
  },
  {
    "id": "BACKLOG-366",
    "title": "Verify TransactionStatus Type/Schema Alignment",
    "category": "bug",
    "priority": "Critical",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~5K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-366.md](items/BACKLOG-366.md)",
    "description": "<strong>Problem Statement</strong>\n\nThe SR Engineer audit flagged a potential mismatch between TypeScript <code>TransactionStatus</code> type and the database CHECK constraint.\n\n**Audit Finding:** TypeScript allows <code>\"archived\"</code> status but schema doesn't include it.\n\n<strong>Current State (Needs Verification)</strong>\n\n<strong>TypeScript Definition (transactionService.ts:18)</strong>\n<code>export type TransactionStatus = \"pending\" | \"active\" | \"closed\" | \"rejected\";\n</code>\n\n<strong>Schema CHECK Constraint (schema.sql:307)</strong>\n<code>status TEXT DEFAULT 'active' CHECK (status IN ('pending', 'active', 'closed', 'rejected'))\n</code>\n\n**Based on current code inspection:** Both appear to match. No <code>\"archived\"</code> status found in either.\n\n<strong>Investigation Required</strong>\n\n1. Verify if there's another TypeScript file with different TransactionStatus definition\n2. Check if any UI component references \"archived\" status\n3. Verify runtime database state vs schema file\n4. Determine if \"archived\" was planned but not implemented\n\n<strong>Potential Issues If Mismatch Exists</strong>\n\n\u2022 TypeScript may allow setting a status that fails at database level\n\u2022 Runtime errors when trying to archive transactions\n\u2022 Inconsistent state between UI and database\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Confirm TypeScript type matches schema CHECK constraint\n\u2610 If mismatch found: align both to same set of valid statuses\n\u2610 Add \"archived\" to both if feature is needed\n\u2610 Update any UI components that reference invalid statuses\n\n<strong>Estimation</strong>\n\n\u2022 **Category:** investigation / fix\n\u2022 **Estimated Tokens:** ~2K (investigation), ~3K (fix if needed)\n\u2022 **Risk:** Low if already aligned, Medium if changes needed\n\n<strong>Notes</strong>\n\nInitial investigation shows both TypeScript and schema use the same values:\n\u2022 pending\n\u2022 active\n\u2022 closed\n\u2022 rejected\n\nThe audit finding may have been based on outdated code or a planned feature. Recommend quick verification before closing.\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-296 (FINDING-13): CHECK constraint inconsistencies\n\u2022 transactionService.ts: TypeScript type definition\n\u2022 TransactionStatusWrapper.tsx: UI status component"
  },
  {
    "id": "BACKLOG-367",
    "title": "Consolidate Duplicate Export Date Columns",
    "category": "technical debt",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-367.md](items/BACKLOG-367.md)",
    "description": "<strong>Problem Statement</strong>\n\nThe <code>transactions</code> table has TWO columns tracking last export timestamp:\n\n1. <code>last_exported_at</code> - In main schema.sql (line 342)\n2. <code>last_exported_on</code> - Added by add_export_tracking.sql migration (line 32)\n\nThis duplication causes:\n\u2022 Confusion about which column to use\n\u2022 Potential data inconsistency (one updated, other not)\n\u2022 Wasted storage\n\u2022 Trigger complexity\n\n<strong>Evidence</strong>\n\n**schema.sql (line 342):**\n<code>last_exported_at DATETIME,\n</code>\n\n**add_export_tracking.sql migration:**\n<code>-- Step 4: Rename export_generated_at to last_exported_on for clarity\nALTER TABLE transactions ADD COLUMN last_exported_on DATETIME;\n\n-- Migrate existing export_generated_at data to last_exported_on\nUPDATE transactions SET last_exported_on = export_generated_at WHERE export_generated_at IS NOT NULL;\n</code>\n\n**Also in migration (line 48-57):**\n<code>CREATE TRIGGER IF NOT EXISTS update_transaction_export_timestamp\nAFTER UPDATE OF export_status ON transactions\nWHEN NEW.export_status = 'exported'\nBEGIN\n  UPDATE transactions\n  SET\n    last_exported_on = CURRENT_TIMESTAMP,\n    export_count = COALESCE(export_count, 0) + 1\n  WHERE id = NEW.id ...\nEND;\n</code>\n\n<strong>Required Changes</strong>\n\n<strong>1. Determine Canonical Column</strong>\n\u2022 **Recommendation:** Use <code>last_exported_at</code> (matches schema naming convention: <code>*_at</code> for timestamps)\n\u2022 Or use <code>last_exported_on</code> if already in production with data\n\n<strong>2. Migration Script</strong>\n\u2022 Copy data from deprecated column to canonical column\n\u2022 Update trigger to use canonical column\n\u2022 Drop deprecated column\n\n<strong>3. Service Updates</strong>\n\u2022 Search for all references to both column names\n\u2022 Update to use canonical column only\n\n<strong>4. Schema Update</strong>\n\u2022 Remove deprecated column definition\n\u2022 Keep only one export timestamp column\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Single export timestamp column in schema\n\u2610 All services use the same column name\n\u2610 Trigger updated to use canonical column\n\u2610 Migration preserves existing data\n\u2610 No code references deprecated column name\n\n<strong>Estimation</strong>\n\n\u2022 **Category:** database/migration\n\u2022 **Estimated Tokens:** ~4K\n\u2022 **Risk:** Low (straightforward consolidation)\n\n<strong>Related</strong>\n\n\u2022 add_export_tracking.sql: Migration that added duplicate\n\u2022 transactionService.ts: May reference export columns\n\u2022 Export services: folderExportService, pdfExportService, enhancedExportService"
  },
  {
    "id": "BACKLOG-368",
    "title": "Create transactionStageHistoryDbService",
    "category": "technical debt",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-368.md](items/BACKLOG-368.md)",
    "description": "<strong>Problem Statement</strong>\n\nThe <code>transaction_stage_history</code> table exists in the schema but has no corresponding database service:\n\n\u2022 Table is defined (schema.sql lines 478-496)\n\u2022 Indexes exist for the table (lines 633-634)\n\u2022 **No service to read/write data**\n\nThis table is designed for timeline reconstruction and stage tracking, but is currently unused.\n\n<strong>Schema Definition</strong>\n\n<code>CREATE TABLE IF NOT EXISTS transaction_stage_history (\n  id TEXT PRIMARY KEY,\n  transaction_id TEXT NOT NULL,\n\n  stage TEXT NOT NULL,\n  source TEXT CHECK (source IN ('pattern', 'llm', 'user')),\n  confidence REAL,\n  changed_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n\n  -- Optional: what triggered this change\n  trigger_message_id TEXT,\n\n  FOREIGN KEY (transaction_id) REFERENCES transactions(id) ON DELETE CASCADE,\n  FOREIGN KEY (trigger_message_id) REFERENCES messages(id) ON DELETE SET NULL\n);\n</code>\n\n<strong>Purpose</strong>\n\nThe table supports:\n1. **Timeline reconstruction** - Show how a transaction progressed through stages\n2. **Audit trail** - Track which message triggered stage changes\n3. **AI/Agent analysis** - Future agents can analyze stage progression patterns\n4. **Stage regression detection** - Identify if a transaction moved backward unexpectedly\n\n<strong>Required Implementation</strong>\n\n<strong>1. Create transactionStageHistoryDbService.ts</strong>\n\n<code>// Suggested API:\ninterface StageHistoryEntry {\n  id: string;\n  transactionId: string;\n  stage: string;\n  source: 'pattern' | 'llm' | 'user';\n  confidence: number | null;\n  changedAt: string;\n  triggerMessageId: string | null;\n}\n\n// Methods:\nrecordStageChange(transactionId: string, stage: string, source: string, options?: {\n  confidence?: number;\n  triggerMessageId?: string;\n}): Promise<StageHistoryEntry>\n\ngetHistoryForTransaction(transactionId: string): Promise<StageHistoryEntry[]>\n\ngetLatestStage(transactionId: string): Promise<StageHistoryEntry | null>\n</code>\n\n<strong>2. IPC Handler Integration</strong>\n\u2022 Add handler to electron/handlers/\n\u2022 Expose via window.api.stageHistory\n\n<strong>3. Integration Points</strong>\n\u2022 Call when transaction.stage is updated\n\u2022 Could be triggered from transactionService.updateTransaction()\n\u2022 Or from a dedicated stage update function\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 transactionStageHistoryDbService.ts created with CRUD operations\n\u2610 IPC handler exposes service to renderer\n\u2610 Stage changes recorded when transaction stage updates\n\u2610 History retrievable for transaction timeline display\n\u2610 Unit tests for new service\n\n<strong>Estimation</strong>\n\n\u2022 **Category:** feature/service\n\u2022 **Estimated Tokens:** ~6K\n\u2022 **Risk:** Low (new code, no breaking changes)\n\n<strong>Future Considerations</strong>\n\n\u2022 UI component to display stage history timeline\n\u2022 Stage progression visualization in transaction details\n\u2022 Anomaly detection for unusual stage patterns\n\n<strong>Related</strong>\n\n\u2022 transactions.stage: Current stage storage\n\u2022 transactionService.ts: May need integration for auto-recording\n\u2022 Timeline/history UI components (future)"
  },
  {
    "id": "BACKLOG-369",
    "title": "Align Audit Log Schema Between Migration and Main Schema",
    "category": "technical debt",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-369.md](items/BACKLOG-369.md)",
    "description": "<strong>Problem Statement</strong>\n\nThe <code>audit_logs</code> table definition differs between the migration file and the main schema file. This can cause:\n\u2022 Different behavior depending on which schema was applied\n\u2022 Runtime errors if code expects one schema but runs against another\n\u2022 Inconsistent data validation\n\n<strong>Differences Found</strong>\n\n<strong>Table Definition</strong>\n\n| Field/Aspect | add_audit_logs.sql (Migration) | schema.sql (Main) |\n|--------------|--------------------------------|-------------------|\n| resource_type | <code>NOT NULL</code> | No NOT NULL |\n| details | Not present | <code>details TEXT</code> |\n| metadata | <code>metadata TEXT</code> | <code>metadata TEXT</code> |\n| user_id FK | No FK (independent) | <code>FOREIGN KEY (user_id) REFERENCES users_local(id)</code> |\n\n<strong>Action CHECK Constraint</strong>\n\n**Migration (lines 25-31):**\n<code>CHECK (action IN (\n  'LOGIN', 'LOGOUT', 'LOGIN_FAILED',\n  'DATA_ACCESS', 'DATA_EXPORT', 'DATA_DELETE',\n  'TRANSACTION_CREATE', 'TRANSACTION_UPDATE', 'TRANSACTION_DELETE',\n  'CONTACT_CREATE', 'CONTACT_UPDATE', 'CONTACT_DELETE',\n  'SETTINGS_CHANGE', 'MAILBOX_CONNECT', 'MAILBOX_DISCONNECT'\n))\n</code>\n\n**Main Schema (lines 419-426):**\n<code>CHECK (action IN (\n  'LOGIN', 'LOGOUT', 'SESSION_REFRESH',\n  'TRANSACTION_CREATE', 'TRANSACTION_UPDATE', 'TRANSACTION_DELETE',\n  'CONTACT_CREATE', 'CONTACT_UPDATE', 'CONTACT_DELETE',\n  'EXPORT_START', 'EXPORT_COMPLETE', 'EXPORT_FAIL',\n  'MAILBOX_CONNECT', 'MAILBOX_DISCONNECT',\n  'SETTINGS_UPDATE', 'TERMS_ACCEPT'\n))\n</code>\n\n**Missing in Main Schema:**\n\u2022 LOGIN_FAILED\n\u2022 DATA_ACCESS\n\u2022 DATA_EXPORT\n\u2022 DATA_DELETE\n\u2022 SETTINGS_CHANGE\n\n**Missing in Migration:**\n\u2022 SESSION_REFRESH\n\u2022 EXPORT_START\n\u2022 EXPORT_COMPLETE\n\u2022 EXPORT_FAIL\n\u2022 SETTINGS_UPDATE\n\u2022 TERMS_ACCEPT\n\n<strong>Resource Type CHECK Constraint</strong>\n\n**Migration (lines 33-36):**\n<code>CHECK (resource_type IN (\n  'USER', 'SESSION', 'TRANSACTION', 'CONTACT',\n  'COMMUNICATION', 'EXPORT', 'MAILBOX', 'SETTINGS'\n))\n</code>\n\n**Main Schema:**\nNo CHECK constraint on resource_type.\n\n<strong>Foreign Key Difference</strong>\n\n**Migration:** No FK - intentionally independent for persistence\n**Main Schema:** Has FK to users_local with ON DELETE CASCADE\n\nThis is a significant architectural difference. Migration approach is correct for audit log integrity.\n\n<strong>Recommendation</strong>\n\nUse the migration file as the source of truth because:\n1. No FK ensures audit logs persist even if user deleted (compliance requirement)\n2. More comprehensive action types for security tracking\n3. Resource type constraint prevents invalid values\n\n<strong>Required Changes</strong>\n\n<strong>1. Update schema.sql to Match Migration</strong>\n\u2022 Remove user_id foreign key\n\u2022 Add resource_type NOT NULL and CHECK constraint\n\u2022 Merge action CHECK constraints (superset of both)\n\u2022 Remove <code>details</code> column if not used, or add to migration\n\n<strong>2. Create Reconciliation Migration</strong>\n\u2022 For existing databases, alter table to add missing constraints\n\u2022 Handle any invalid data that doesn't meet new constraints\n\n<strong>3. Update AuditService</strong>\n\u2022 Verify it uses correct action values\n\u2022 Ensure all audit log writes use valid action/resource_type values\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 schema.sql and migration have identical audit_logs definition\n\u2610 No foreign key on user_id (preserves audit integrity)\n\u2610 Comprehensive CHECK constraints for action and resource_type\n\u2610 AuditService uses valid action values\n\u2610 Existing data validated/migrated if needed\n\n<strong>Estimation</strong>\n\n\u2022 **Category:** database/schema alignment\n\u2022 **Estimated Tokens:** ~5K\n\u2022 **Risk:** Medium (need to verify existing data compatibility)\n\n<strong>Related</strong>\n\n\u2022 AuditService.ts: Main audit logging service\n\u2022 Compliance requirements: Audit logs must be immutable\n\u2022 BACKLOG-296: Database schema audit findings"
  },
  {
    "id": "BACKLOG-370",
    "title": "Add Unique Constraint for Thread-Based Communication Links",
    "category": "data integrity",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-370.md](items/BACKLOG-370.md)",
    "description": "<strong>Problem Statement</strong>\n\nThe <code>communications</code> table supports thread-based linking (TASK-1114), but there's no uniqueness constraint to prevent duplicate links of the same thread to the same transaction.\n\n**Current State:**\n\u2022 <code>thread_id</code> column exists for thread-based linking\n\u2022 Indexes exist: <code>idx_communications_thread_id</code>, <code>idx_communications_thread_txn</code>\n\u2022 **No UNIQUE constraint on (thread_id, transaction_id)**\n\nThis allows:\n<code>-- Both inserts succeed, creating duplicates\nINSERT INTO communications (id, thread_id, transaction_id, ...) VALUES ('1', 'thread-abc', 'txn-123', ...);\nINSERT INTO communications (id, thread_id, transaction_id, ...) VALUES ('2', 'thread-abc', 'txn-123', ...);\n</code>\n\n<strong>Impact</strong>\n\nWithout the constraint:\n1. **Duplicate thread links** - Same thread linked multiple times to same transaction\n2. **Incorrect counts** - Communication counts inflated\n3. **Performance degradation** - More rows to process\n4. **Unlink issues** - May not remove all duplicate links\n\n<strong>Evidence</strong>\n\n**Schema (lines 728-732):**\n<code>-- TASK-1114: Thread-based linking (SPRINT-042)\nthread_id TEXT,\n</code>\n\n**Existing Indexes (lines 780-782):**\n<code>CREATE INDEX IF NOT EXISTS idx_communications_thread_id ON communications(thread_id);\nCREATE INDEX IF NOT EXISTS idx_communications_thread_txn ON communications(thread_id, transaction_id);\n</code>\n\n**Missing:**\n<code>-- Should exist to prevent duplicates\nCREATE UNIQUE INDEX IF NOT EXISTS idx_communications_thread_txn_unique\n  ON communications(thread_id, transaction_id)\n  WHERE thread_id IS NOT NULL;\n</code>\n\n<strong>Required Changes</strong>\n\n<strong>1. Add Unique Constraint (Partial Index)</strong>\n<code>-- Only enforce uniqueness when thread_id is set\n-- This allows multiple message_id based links without thread_id\nCREATE UNIQUE INDEX IF NOT EXISTS idx_communications_thread_txn_unique\n  ON communications(thread_id, transaction_id)\n  WHERE thread_id IS NOT NULL AND transaction_id IS NOT NULL;\n</code>\n\n<strong>2. Migration to Handle Existing Duplicates</strong>\nBefore adding constraint:\n1. Identify duplicate (thread_id, transaction_id) pairs\n2. Keep most recent link, delete duplicates\n3. Then add constraint\n\n<strong>3. Update Services</strong>\n\u2022 Ensure link operations use INSERT OR IGNORE or handle constraint violations\n\u2022 communicationService.ts: Update linkThreadToTransaction()\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Unique constraint added for (thread_id, transaction_id)\n\u2610 Migration handles existing duplicate data\n\u2610 Services handle constraint violations gracefully\n\u2610 No duplicate thread links possible after migration\n\u2610 Existing functionality unchanged (tests pass)\n\n<strong>Estimation</strong>\n\n\u2022 **Category:** database/migration\n\u2022 **Estimated Tokens:** ~4K\n\u2022 **Risk:** Low-Medium (need to check for existing duplicates)\n\n<strong>Technical Notes</strong>\n\n<strong>SQLite Partial Index Syntax</strong>\n<code>CREATE UNIQUE INDEX idx_name ON table(col1, col2) WHERE condition;\n</code>\n\n<strong>Why Partial Index?</strong>\n\u2022 Some communications use message_id linking (not thread-based)\n\u2022 Those records have NULL thread_id\n\u2022 We only want to enforce uniqueness for thread-based links\n\n<strong>Related</strong>\n\n\u2022 TASK-1114: Thread-based linking implementation\n\u2022 TASK-1115/1116: Thread-based linking refinements\n\u2022 communicationService.ts: Service that manages links"
  },
  {
    "id": "BACKLOG-371",
    "title": "Contact Update Sync and Re-link Messages",
    "category": "feature",
    "priority": "High",
    "status": "Pending",
    "sprint": "SPRINT-049",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-371.md](items/BACKLOG-371.md)",
    "description": "<strong>Category</strong>\nfeature\n\n<strong>Priority</strong>\nHigh\n\n<strong>Status</strong>\nPending\n\n<strong>Description</strong>\n\nUsers need the ability to refresh contacts and re-link messages when contact information changes after initial import. Currently, if a user creates a transaction with contacts but later updates a contact's email or phone number in their address book, the system has no way to:\n1. Detect the contact information has changed\n2. Re-run the email/text matching logic for affected transactions\n\nThis creates a usability gap where users must manually manage message associations for updated contacts.\n\n<strong>User Story</strong>\n\n1. User creates a transaction and assigns contacts to it\n2. User forgets to add an email to one of the contacts at that time\n3. User later updates the contact externally (in their phone/address book) to add the email\n4. The software needs to detect this contact update\n5. The software should allow users to re-trigger email and text lookup based on the updated contact info\n\n<strong>Feature Requirements</strong>\n\n<strong>1. Contact Sync/Refresh</strong>\n\u2022 Ability to re-sync contacts from the source (phone/address book)\n\u2022 Compare local contact data with source data\n\u2022 Update local contact records when changes detected\n\n<strong>2. Change Detection</strong>\n\u2022 Detect when contact info has changed (email added, phone number changed, etc.)\n\u2022 Track which fields were modified\n\u2022 Identify transactions that have the changed contact assigned\n\n<strong>3. Re-trigger Message Lookup</strong>\n\u2022 When a contact is updated, re-run the email/text matching logic\n\u2022 Only process transactions that have that contact assigned\n\u2022 Associate newly matched messages with the transaction\n\u2022 Avoid duplicating already-linked messages\n\n<strong>4. UI for Manual Trigger</strong>\n\u2022 Allow user to manually trigger a \"refresh contact and re-link messages\" action\n\u2022 Provide this action at both:\n  - Contact level (refresh this contact across all transactions)\n  - Transaction level (refresh all contacts for this transaction)\n\u2022 Show progress/results of the re-linking operation\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 User can refresh/re-sync a contact's info from their device\n\u2610 System detects changes to contact email/phone\n\u2610 User can trigger re-linking of messages for updated contacts\n\u2610 Newly found emails/texts are associated with the transaction\n\u2610 Previously linked messages are not duplicated\n\u2610 UI provides feedback on what was found/linked during refresh\n\u2610 Works for both email and text message matching\n\n<strong>Technical Considerations</strong>\n\n\u2022 Leverage existing <code>autoLinkService</code> for message matching logic\n\u2022 May need to add a \"last synced\" timestamp to contacts\n\u2022 Consider batch processing for contacts with many transactions\n\u2022 Ensure proper handling of deleted contacts in source\n\u2022 May need to coordinate with existing sync mechanisms\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-207: Auto-Link Communications When Contact Added\n\u2022 BACKLOG-143: Prevent Duplicate Contact Imports\n\u2022 BACKLOG-016: Refactor Contact Import\n\u2022 BACKLOG-018: Smart Contact Sync\n\n<strong>Estimated Tokens</strong>\n\n~50K (involves contact sync, change detection, message re-linking, and UI)"
  },
  {
    "id": "BACKLOG-372",
    "title": "Switch Mac to iPhone Backup for Messages/Contacts",
    "category": "architecture",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-372.md](items/BACKLOG-372.md)",
    "description": "<strong>Summary</strong>\n\nAdd a setting for Mac users to choose their message source:\n\u2022 **Local macOS Messages** (current default) - reads from Messages.app database directly\n\u2022 **iPhone Cable Sync** (same as Windows) - uses iPhone backup files\n\nThis enables unified testing across platforms and gives users flexibility.\n\n<strong>Category</strong>\n\narchitecture / settings\n\n<strong>Priority</strong>\n\nHigh\n\n<strong>Status</strong>\n\nPending\n\n<strong>User Story</strong>\n\n**As a** Mac user with an iPhone,\n**I want** to choose between using my Mac's local Messages database or syncing via iPhone cable,\n**So that** I can use whichever method works best for my setup.\n\n**As a** developer/support team,\n**I want** the option to have all users use iPhone cable sync,\n**So that** we have one unified code path to test, debug, and support across both platforms.\n\n<strong>Current Behavior</strong>\n\n\u2022 **Mac**: Accesses Messages.app database and Contacts.app directly via macOS APIs\n\u2022 **Windows**: Uses iPhone backup files to extract messages and contacts\n\u2022 Results in two separate code paths requiring separate testing and support procedures\n\u2022 No user choice on Mac - always uses local Messages.app\n\n<strong>Proposed Behavior</strong>\n\n\u2022 **Mac**: Setting to choose between:\n  - Local macOS Messages (existing behavior)\n  - iPhone Cable Sync (same as Windows)\n\u2022 **Windows**: Continue using iPhone backup files (no change)\n\u2022 Default can be set to \"iPhone Cable Sync\" for unified testing\n\n<strong>Feature Requirements</strong>\n\n1. **Settings Toggle** - Add setting in Settings > Data & Privacy to choose message source:\n   - \"Use Mac Messages\" (local)\n   - \"Use iPhone Sync\" (cable)\n\n2. **iPhone Backup Detection on Mac** - Detect iPhone backups at <code>~/Library/Application Support/MobileSync/Backup/</code>\n\n3. **Conditional Service Routing** - Based on setting, route to:\n   - <code>macOSMessagesImportService</code> for local\n   - <code>iosBackupService</code> for iPhone sync\n\n4. **Keep Both Paths Working** - Don't deprecate local access, keep as option\n\n5. **Unified Default** - Can set iPhone Sync as default for unified testing experience\n\n<strong>Benefits</strong>\n\n| Benefit | Description |\n|---------|-------------|\n| Consistency | Same behavior across Mac and Windows |\n| Simpler Testing | One code path to test instead of two |\n| Easier Support | One method to troubleshoot |\n| Reduced Maintenance | Less platform-specific code to maintain |\n| Faster Rollout | Single implementation to validate |\n\n<strong>Technical Notes</strong>\n\n<strong>Current Architecture (to be deprecated)</strong>\n\n\u2022 <code>src/electron/services/macOS/</code> - Direct macOS Messages.app and Contacts.app access\n\u2022 Platform detection determines which code path to use\n\n<strong>Target Architecture</strong>\n\n\u2022 Unified iPhone backup parsing across both platforms\n\u2022 Remove or deprecate macOS-specific direct access services\n\u2022 Same user flow: backup iPhone, then sync\n\n<strong>Files Potentially Affected</strong>\n\n\u2022 <code>src/electron/services/macOS/macOSMessagesImportService.ts</code> - Deprecate/remove\n\u2022 <code>src/electron/services/macOS/contactsService.ts</code> - Deprecate/remove\n\u2022 <code>src/electron/services/iosBackupService.ts</code> - May need Mac-specific backup paths\n\u2022 Platform detection logic\n\u2022 Onboarding flow (same instructions for both platforms)\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Settings UI shows message source toggle (Mac only)\n\u2610 \"Use Mac Messages\" option works (existing local behavior)\n\u2610 \"Use iPhone Sync\" option works (same as Windows flow)\n\u2610 iPhone backup path detected correctly on Mac\n\u2610 Setting persists across app restarts\n\u2610 Onboarding adapts based on setting (shows cable instructions if iPhone Sync)\n\u2610 Both code paths continue to work (no deprecation)\n\u2610 Tests cover both paths\n\n<strong>Dependencies</strong>\n\n\u2022 iPhone backup path detection on macOS (<code>~/Library/Application Support/MobileSync/Backup/</code>)\n\u2022 User must have iPhone backup available if using iPhone Sync option\n\n<strong>Estimated Effort</strong>\n\n~40-50K tokens (medium - both code paths exist, need routing + UI)\n\n<strong>Implementation Notes</strong>\n\n<strong>Settings UI</strong>\n<code>// In Settings component\n<Select value={messageSource} onChange={setMessageSource}>\n  <Option value=\"local\">Use Mac Messages (local)</Option>\n  <Option value=\"iphone\">Use iPhone Sync (cable)</Option>\n</Select>\n</code>\n\n<strong>Service Routing</strong>\n<code>// In message import logic\nif (platform === 'darwin' && settings.messageSource === 'iphone') {\n  // Use iOS backup service (same as Windows)\n  return iosBackupService.importMessages();\n} else if (platform === 'darwin') {\n  // Use local macOS Messages\n  return macOSMessagesImportService.importMessages();\n}\n</code>\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-172: macOS Messages Import (may become obsolete with this change)\n\u2022 BACKLOG-040: ContactsService macOS Paths (may become obsolete)"
  },
  {
    "id": "BACKLOG-373",
    "title": "Android Device Support",
    "category": "feature",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~150K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-373.md](items/BACKLOG-373.md)",
    "description": "<strong>Summary</strong>\n\nCurrently the app only supports iPhone. Users with Android phones cannot use the app to audit their text messages. Need to add Android support to significantly expand the user base.\n\n<strong>Category</strong>\n\nfeature\n\n<strong>Priority</strong>\n\nHigh\n\n<strong>Status</strong>\n\nPending\n\n<strong>User Story</strong>\n\n**As a** real estate professional with an Android phone,\n**I want** to import and audit my text messages from my Android device,\n**So that** I can maintain compliance records and audit trails for my real estate transactions.\n\n<strong>Current Behavior</strong>\n\n\u2022 App only supports iPhone message import\n\u2022 Onboarding shows \"Android\" option but displays \"coming soon\" message\n\u2022 Users with Android devices cannot use the text message audit functionality\n\u2022 Only iPhone backup files are supported\n\n<strong>Proposed Behavior</strong>\n\n\u2022 Full Android device support alongside iPhone\n\u2022 Users can select Android in onboarding and proceed through full flow\n\u2022 Android backup files can be imported and parsed\n\u2022 Android SMS/MMS messages displayed in same format as iMessage\n\u2022 Same audit and export functionality available for Android users\n\n<strong>Feature Requirements</strong>\n\n1. **Android Backup Parsing** - Support Android backup file formats:\n   - ADB backup (.ab files)\n   - Google backup (Google One/Drive)\n   - Samsung Smart Switch backup\n   - Other manufacturer-specific formats as needed\n\n2. **Android Message Formats** - Parse Android SMS/MMS database formats:\n   - Different storage format than iMessage\n   - SMS stored in mmssms.db typically\n   - MMS attachments stored separately\n   - Handle various Android OS versions\n\n3. **Android Contacts Import** - Import contacts from Android backup:\n   - Parse Android contacts database\n   - Map to existing contact schema\n   - Handle different backup formats\n\n4. **Onboarding Flow Update** - Update phone type selection:\n   - Remove \"coming soon\" label from Android option\n   - Full Android onboarding path\n   - Android-specific instructions for creating backups\n   - Platform-appropriate guidance\n\n5. **Platform Detection** - Detect when Android device/backup is connected:\n   - Identify Android backup files\n   - Distinguish from iPhone backups\n   - Appropriate error handling for unsupported formats\n\n<strong>Technical Considerations</strong>\n\n<strong>Backup Format Variability</strong>\n\n| Manufacturer | Backup Format | Notes |\n|--------------|---------------|-------|\n| Google Pixel | Google backup | Cloud-based, may need different approach |\n| Samsung | Smart Switch | Proprietary format |\n| Generic | ADB backup | Standard Android backup format |\n| Various | Local files | May have manufacturer customizations |\n\n<strong>Message Storage Differences</strong>\n\n\u2022 Android uses SQLite database (mmssms.db) vs iPhone backup format\n\u2022 No iMessage-specific features (reactions, tapbacks, read receipts style)\n\u2022 MMS handling differs from iMessage attachments\n\u2022 Thread structure may differ\n\n<strong>Android Version Considerations</strong>\n\n\u2022 Database schema may vary across Android versions\n\u2022 Encryption handling differs from iOS\n\u2022 Permissions model is different\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Users can select Android in onboarding (remove \"coming soon\")\n\u2610 At least one Android backup format can be imported (ADB recommended as baseline)\n\u2610 Android SMS messages parsed and stored in database\n\u2610 Android MMS messages with attachments handled\n\u2610 Android contacts imported and mapped correctly\n\u2610 Messages displayed in conversation view (same UX as iPhone)\n\u2610 Export functionality works for Android messages (PDF, audit package)\n\u2610 Onboarding provides Android-specific backup instructions\n\u2610 Error handling for unsupported Android backup formats\n\u2610 Tests cover Android parsing logic\n\n<strong>Out of Scope (Initial Release)</strong>\n\n\u2022 RCS messages (rich messaging) - may be added later\n\u2022 WhatsApp/Signal/Telegram integration\n\u2022 Real-time Android device sync (backup file approach only)\n\u2022 Every manufacturer's proprietary backup format (focus on ADB + 1-2 major ones)\n\n<strong>Dependencies</strong>\n\n\u2022 Research into Android backup file formats\n\u2022 Test devices/backups for development\n\u2022 May need manufacturer-specific documentation\n\n<strong>Files Potentially Affected</strong>\n\n\u2022 <code>src/components/onboarding/</code> - Phone type selection\n\u2022 New: <code>src/electron/services/android/</code> - Android parsing services\n\u2022 New: <code>src/electron/services/android/androidBackupParser.ts</code>\n\u2022 New: <code>src/electron/services/android/androidMessagesParser.ts</code>\n\u2022 New: <code>src/electron/services/android/androidContactsParser.ts</code>\n\u2022 <code>src/electron/services/iosBackupService.ts</code> - May need abstraction\n\u2022 Database schema (if Android-specific fields needed)\n\u2022 IPC handlers for Android operations\n\n<strong>Estimated Effort</strong>\n\n~150K tokens (large feature with multiple components)\n\n<strong>Risk Assessment</strong>\n\n| Risk | Likelihood | Impact | Mitigation |\n|------|------------|--------|------------|\n| Backup format variability | High | Medium | Start with ADB format, add others incrementally |\n| Android version differences | Medium | Medium | Test across major versions, graceful degradation |\n| Encryption in backups | Medium | High | Research encryption handling upfront |\n| Scope creep | Medium | High | Define clear MVP with one backup format |\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-172: macOS Messages Import (similar expansion pattern)\n\u2022 BACKLOG-372: Switch Mac to iPhone Backup (architecture consideration)"
  },
  {
    "id": "BACKLOG-374",
    "title": "Add App Logo and Branding",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-374.md](items/BACKLOG-374.md)",
    "description": "<strong>Description</strong>\n\nThe app currently doesn't have proper logo/branding - it uses the default Electron icon. Need to add a custom logo throughout the app including the app icon, header, loading screen, and about screen.\n\n<strong>User Story</strong>\n\nAs a user, I want to see a professional branded app with a custom logo, so that the application feels polished and trustworthy for professional real estate auditing work.\n\n<strong>Current Behavior</strong>\n\n\u2022 App shows default Electron icon in dock (Mac) / taskbar (Windows)\n\u2022 No logo in app header\n\u2022 No logo on loading/splash screen\n\u2022 No logo on about screen\n\n<strong>Desired Behavior</strong>\n\n\u2022 Custom Magic Audit logo in dock/taskbar\n\u2022 Logo visible in app header or title area\n\u2022 Logo displayed during app startup/loading\n\u2022 Logo on the about/settings page\n\u2022 (Optional) Logo on exported PDFs/audit packages\n\n<strong>Feature Requirements</strong>\n\n1. **App Icon** - Logo for dock (Mac) / taskbar (Windows) / desktop shortcut\n2. **Title Bar/Header** - Logo in the app header or title area\n3. **Loading/Splash Screen** - Logo displayed during app startup\n4. **About Screen** - Logo on the about/settings page\n5. **Export Branding** - Logo on exported PDFs/audit packages (optional/stretch goal)\n\n<strong>Technical Approach</strong>\n\n<strong>Icon Sizes Required</strong>\n\nMultiple icon sizes needed for different contexts:\n\u2022 16x16 (small icons, menus)\n\u2022 32x32 (small taskbar)\n\u2022 64x64 (medium icons)\n\u2022 128x128 (large icons)\n\u2022 256x256 (Windows, high-DPI)\n\u2022 512x512 (macOS dock)\n\u2022 1024x1024 (macOS App Store, high-DPI)\n\n<strong>Platform-Specific Formats</strong>\n\n| Platform | Format | Tool/Process |\n|----------|--------|--------------|\n| Windows | <code>.ico</code> (multi-resolution) | Use <code>icon-gen</code> or similar to create ICO with all sizes |\n| macOS | <code>.icns</code> | Use <code>iconutil</code> or <code>makeicns</code> to create ICNS bundle |\n| In-app | <code>.svg</code> | Scalable for any size, clean rendering |\n| Fallback | <code>.png</code> | Various sizes for web/renderer contexts |\n\n<strong>Electron Configuration</strong>\n\n<code>// electron-builder.config.js or package.json\n{\n  \"build\": {\n    \"appId\": \"com.magicaudit.app\",\n    \"mac\": {\n      \"icon\": \"build/icons/icon.icns\"\n    },\n    \"win\": {\n      \"icon\": \"build/icons/icon.ico\"\n    },\n    \"linux\": {\n      \"icon\": \"build/icons\"  // folder with PNG files\n    }\n  }\n}\n</code>\n\n<strong>In-App Logo Component</strong>\n\n<code>// src/components/common/Logo.tsx\ninterface LogoProps {\n  size?: 'sm' | 'md' | 'lg';\n  className?: string;\n}\n\nexport const Logo: React.FC<LogoProps> = ({ size = 'md', className }) => {\n  const sizes = { sm: 24, md: 48, lg: 96 };\n  return (\n    <img\n      src=\"/assets/logo.svg\"\n      alt=\"Magic Audit\"\n      width={sizes[size]}\n      height={sizes[size]}\n      className={className}\n    />\n  );\n};\n</code>\n\n<strong>Files to Create/Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>build/icons/icon.icns</code> | macOS app icon |\n| <code>build/icons/icon.ico</code> | Windows app icon |\n| <code>build/icons/*.png</code> | PNG icons at various sizes |\n| <code>src/assets/logo.svg</code> | In-app SVG logo |\n| <code>src/assets/logo-*.png</code> | PNG fallbacks |\n| <code>src/components/common/Logo.tsx</code> | Reusable logo component |\n| <code>electron-builder.config.js</code> | Icon configuration |\n| <code>src/components/AppShell.tsx</code> | Add logo to header |\n| <code>src/components/LoadingScreen.tsx</code> | Add logo to loading screen |\n| <code>src/components/Settings.tsx</code> | Add logo to about section |\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 App has custom icon in dock (Mac) - not default Electron icon\n\u2610 App has custom icon in taskbar (Windows)\n\u2610 Logo visible in app header\n\u2610 Logo displayed on loading/splash screen\n\u2610 Logo on about/settings page\n\u2610 Logo assets properly sized for all platforms (Mac + Windows)\n\u2610 SVG logo available for in-app scalable use\n\n<strong>Estimate</strong>\n\n~25K-40K tokens\n\n\u2022 Icon generation and configuration: ~10K\n\u2022 Logo component creation: ~5K\n\u2022 Integration into header/loading/about screens: ~10K-15K\n\u2022 Testing across platforms: ~5K-10K\n\n<strong>Dependencies</strong>\n\n\u2022 Logo design asset (SVG source file) must be provided\n\u2022 Design review/approval before implementation\n\n<strong>Notes</strong>\n\n\u2022 This is a polish/branding task, not a functional blocker\n\u2022 Recommend getting logo design finalized before starting implementation\n\u2022 Consider accessibility (logo should work on both light and dark backgrounds if dark mode is planned)\n\u2022 ICO files should contain multiple resolutions in a single file for Windows compatibility\n\u2022 See BACKLOG-028 which was a placeholder for this work\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-028: Create App Logo & Branding (original placeholder)\n\u2022 BACKLOG-006: Dark Mode (logo should work with both themes)"
  },
  {
    "id": "BACKLOG-375",
    "title": "SSO (Single Sign-On) for Enterprise Authentication",
    "category": "feature",
    "priority": "High",
    "status": "Obsolete",
    "sprint": "-",
    "est_tokens": "~150K",
    "actual_tokens": "-",
    "variance": "Superseded by SPRINT-058 unified browser auth",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-375.md](items/BACKLOG-375.md)",
    "description": "<strong>User Story</strong>\n\nEnterprise customers need to authenticate users through their corporate identity provider instead of individual email/password accounts.\n\n<strong>Category</strong>\n\nfeature\n\n<strong>Priority</strong>\n\nHigh (enterprise requirement)\n\n<strong>Status</strong>\n\nPending\n\n<strong>Feature Requirements</strong>\n\n<strong>1. SAML 2.0 Support</strong>\n\u2022 Integrate with enterprise identity providers (Okta, Azure AD, OneLogin, etc.)\n\u2022 Implement SAML assertion parsing and validation\n\u2022 Support IdP-initiated and SP-initiated SSO flows\n\u2022 Handle SAML metadata exchange for configuration\n\n<strong>2. OIDC Support</strong>\n\u2022 OpenID Connect for modern identity providers\n\u2022 Support authorization code flow with PKCE\n\u2022 Implement token refresh and revocation\n\u2022 Handle ID token validation and claims extraction\n\n<strong>3. SSO Configuration</strong>\n\u2022 Admin portal to configure SSO settings\n\u2022 Support for multiple SSO providers per organization\n\u2022 Configuration import from IdP metadata URL\n\u2022 Test connection functionality before enabling\n\n<strong>4. Just-in-Time Provisioning</strong>\n\u2022 Create user accounts on first SSO login\n\u2022 Map IdP attributes to user profile fields\n\u2022 Support group/role claims from IdP\n\u2022 Handle provisioning errors gracefully\n\n<strong>5. Session Management</strong>\n\u2022 Proper session handling with SSO logout\n\u2022 Support for Single Logout (SLO)\n\u2022 Session timeout aligned with IdP policies\n\u2022 Handle concurrent sessions across devices\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Users can log in via corporate SSO\n\u2610 Support for major identity providers (Okta, Azure AD, Google Workspace)\n\u2610 SSO configuration UI for admins\n\u2610 Proper session/token handling\n\u2610 JIT provisioning creates users on first login\n\u2610 Single Logout (SLO) works correctly\n\u2610 Error handling for SSO failures with user-friendly messages\n\n<strong>Technical Considerations</strong>\n\n\u2022 Evaluate passport.js SAML/OIDC strategies vs custom implementation\n\u2022 Consider electron-specific OAuth flow handling (custom protocol handlers)\n\u2022 Plan for secure storage of SSO configuration (encryption at rest)\n\u2022 Design database schema for SSO provider configurations\n\u2022 Consider offline access scenarios when IdP is unreachable\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-376 (SCIM User Provisioning) - related but can be implemented independently\n\u2022 Existing authentication system refactoring may be required\n\n<strong>Estimated Tokens</strong>\n\n~150K (large feature with multiple integrations)\n\n<strong>Notes</strong>\n\n\u2022 Related to BACKLOG-070 (Enterprise User Management - Deferred)\n\u2022 This is part of enterprise tier features\n\u2022 May require Supabase Auth enterprise features or self-hosted auth solution"
  },
  {
    "id": "BACKLOG-376",
    "title": "SCIM User Provisioning & Role Management",
    "category": "feature",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~120K",
    "actual_tokens": "-",
    "variance": "Partially superseded - invitation system in SPRINT-058",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-376.md](items/BACKLOG-376.md)",
    "description": "<strong>User Story</strong>\n\nIT administrators need to automatically provision/deprovision users, assign licenses, and manage roles through their identity provider or admin portal.\n\n<strong>Category</strong>\n\nfeature\n\n<strong>Priority</strong>\n\nHigh (enterprise requirement)\n\n<strong>Status</strong>\n\nPending\n\n<strong>Feature Requirements</strong>\n\n<strong>1. SCIM 2.0 Support</strong>\n\u2022 Implement SCIM 2.0 API endpoints for user provisioning\n\u2022 Support user Create, Read, Update, Delete (CRUD) operations\n\u2022 Handle group provisioning and membership\n\u2022 Automatic user deprovisioning from identity providers\n\u2022 Support for bulk operations\n\n<strong>2. Role Management</strong>\nDefine and assign user roles with appropriate permissions:\n\n| Role | Permissions |\n|------|-------------|\n| IT Admin | Manage users, configure settings, view audit logs |\n| Billing Admin | Manage licenses, payments, view billing history |\n| Transaction Reviewer | View/audit transactions (read-only) |\n| Real Estate Agent | Create/manage own transactions |\n| Transaction Coordinator | Manage transactions for assigned agents |\n\n<strong>3. License Assignment</strong>\n\u2022 Assign/revoke licenses per user\n\u2022 License pool management for organization\n\u2022 Usage tracking and reporting\n\u2022 Grace period handling for expired licenses\n\u2022 Bulk license assignment\n\n<strong>4. Admin Portal</strong>\n\u2022 UI for IT admins to manage users and roles\n\u2022 User search and filtering\n\u2022 Bulk user operations (invite, suspend, delete)\n\u2022 Role assignment interface\n\u2022 Organization settings management\n\n<strong>5. Audit Log</strong>\n\u2022 Track user provisioning events\n\u2022 Log role changes with timestamp and actor\n\u2022 License assignment history\n\u2022 Export audit logs for compliance\n\u2022 Retention policy configuration\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 SCIM 2.0 endpoint operational and compliant with spec\n\u2610 All defined roles implemented with correct permissions\n\u2610 Admin portal allows full user/role management\n\u2610 License management functional with usage tracking\n\u2610 Audit trail captures all admin actions\n\u2610 Integration tested with major IdPs (Okta, Azure AD)\n\u2610 Documentation for SCIM endpoint configuration\n\n<strong>Technical Considerations</strong>\n\n\u2022 SCIM endpoint security (bearer token authentication)\n\u2022 Rate limiting for SCIM operations\n\u2022 Conflict resolution for concurrent provisioning\n\u2022 Database schema for roles, permissions, licenses\n\u2022 Consider RBAC (Role-Based Access Control) implementation pattern\n\u2022 Plan for role hierarchy and permission inheritance\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-375 (SSO) - SSO should be implemented first for seamless enterprise auth\n\u2022 BACKLOG-021 (License Management System) - may need to consolidate or extend\n\u2022 Database schema changes for user roles and permissions\n\n<strong>Estimated Tokens</strong>\n\n~120K (complex feature with SCIM API + admin UI)\n\n<strong>Notes</strong>\n\n\u2022 Related to BACKLOG-070 (Enterprise User Management - Deferred)\n\u2022 SCIM compliance is often required for enterprise sales\n\u2022 Consider SOC 2 compliance requirements for audit logging\n\u2022 Role permissions should be configurable per organization in future"
  },
  {
    "id": "BACKLOG-377",
    "title": "AI-Powered Audit Analysis",
    "category": "feature",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~150K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-377.md](items/BACKLOG-377.md)",
    "description": "<strong>Metadata</strong>\n| Field | Value |\n|-------|-------|\n| **ID** | BACKLOG-377 |\n| **Title** | AI-Powered Audit Analysis |\n| **Category** | feature |\n| **Priority** | High |\n| **Status** | Pending |\n| **Est. Tokens** | ~150K |\n| **Created** | 2026-01-21 |\n\n<strong>User Story</strong>\n\n**As a** broker reviewing transaction audits,\n**I want** AI-powered analysis of communications,\n**So that** I can quickly identify potential compliance issues, red flags, or problems that require attention.\n\n<strong>Problem Statement</strong>\n\nBrokers manually reviewing transaction audits must read through potentially hundreds of emails and text messages to identify issues. This is time-consuming and error-prone. An AI analysis feature would automatically scan communications and highlight areas of concern, saving time and reducing the risk of missing critical issues.\n\n<strong>Feature Requirements</strong>\n\n<strong>1. AI Communication Analysis</strong>\nAnalyze emails and texts for potential issues including:\n\u2022 **Compliance red flags**: Missing disclosures, deadline issues, regulatory violations\n\u2022 **Communication gaps**: Unanswered questions, delayed responses, dropped threads\n\u2022 **Sentiment issues**: Frustrated clients, escalating conflicts, negative tone patterns\n\u2022 **Missing documentation mentions**: References to documents not in the audit\n\u2022 **Price/term discrepancies**: Inconsistencies in discussed terms across messages\n\n<strong>2. Issue Flagging System</strong>\nCategorize and flag potential problems with:\n\u2022 **Severity levels**: High / Medium / Low\n\u2022 **Issue types**: Compliance, Communication, Documentation, Legal\n\u2022 **Message citations**: Specific messages/threads involved\n\u2022 **Confidence score**: AI confidence in the flagged issue\n\n<strong>3. Summary Report Generation</strong>\nAI-generated summary of findings:\n\u2022 Executive summary for quick broker review\n\u2022 Categorized list of issues with message citations\n\u2022 Recommended actions for each issue type\n\u2022 Timeline of concern patterns (if issues escalate over time)\n\n<strong>4. Integration with Export</strong>\nInclude AI findings in audit exports:\n\u2022 Optional AI analysis section in PDF export\n\u2022 Highlighted/flagged messages in export\n\u2022 Summary page at beginning of audit package\n\u2022 Issue severity indicators on individual messages\n\n<strong>5. Configurable Rules</strong>\nAllow customization of analysis:\n\u2022 Industry-specific compliance rules (residential, commercial, etc.)\n\u2022 Brokerage-specific policies and standards\n\u2022 Sensitivity thresholds for flagging\n\u2022 Custom keywords/phrases to watch for\n\u2022 Enable/disable specific issue categories\n\n<strong>Use Cases</strong>\n\n| Use Case | Description |\n|----------|-------------|\n| Compliance Review | Broker reviewing agent's transaction for regulatory compliance |\n| Risk Management | Risk team auditing closed transactions for liability exposure |\n| Training/Coaching | Using flagged issues to coach agents on communication best practices |\n| Pre-Closing Review | Catching issues before closing to address proactively |\n| Dispute Resolution | Identifying communication patterns relevant to disputes |\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 AI analyzes all transaction communications (emails and texts)\n\u2610 Issues are flagged with severity (High/Medium/Low) and category\n\u2610 Summary report is generated with executive overview\n\u2610 Individual issues include citations to specific messages\n\u2610 Findings can be included in audit package export\n\u2610 Broker can review and dismiss false positives\n\u2610 Dismissed issues are remembered for the transaction\n\u2610 Analysis can be re-run after adding new messages\n\u2610 Configurable rules allow customization per brokerage\n\u2610 Performance: Analysis completes within reasonable time (<60s for typical transaction)\n\n<strong>Technical Considerations</strong>\n\n<strong>LLM Integration</strong>\n\u2022 Leverage existing LLM infrastructure (BACKLOG-074, BACKLOG-075)\n\u2022 Consider batch processing for large message sets\n\u2022 Implement caching to avoid re-analyzing unchanged messages\n\u2022 PII masking must be applied before sending to LLM (see BACKLOG-236)\n\n<strong>Data Model</strong>\n\u2022 New tables: <code>audit_analysis</code>, <code>audit_issues</code>, <code>analysis_rules</code>\n\u2022 Link issues to specific messages via <code>message_id</code>\n\u2022 Store dismissed issues for user preference learning\n\n<strong>UI Components</strong>\n\u2022 Analysis results panel in Transaction Details\n\u2022 Issue severity badges on message cards\n\u2022 Summary report view/modal\n\u2022 Export options integration\n\u2022 Rules configuration in Settings\n\n<strong>Dependencies</strong>\n\n| Dependency | Status | Notes |\n|------------|--------|-------|\n| BACKLOG-074 (LLM Infrastructure) | Completed | Foundation for AI analysis |\n| BACKLOG-075 (AI Analysis Tools) | Completed | Analysis pipeline exists |\n| BACKLOG-236 (PII Masking) | Completed | Required for secure LLM calls |\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-052: AI Transaction Timeline (complementary feature)\n\u2022 BACKLOG-067: AI Timeline Builder (related AI feature)\n\u2022 BACKLOG-332: Audit Package Missing Attachments (export integration)\n\n<strong>Estimate Breakdown</strong>\n\n| Component | Est. Tokens |\n|-----------|-------------|\n| Schema & data model | ~15K |\n| Analysis service (LLM integration) | ~40K |\n| Issue flagging & categorization | ~25K |\n| Summary report generation | ~20K |\n| UI components (results, badges, config) | ~35K |\n| Export integration | ~15K |\n| **Total** | **~150K** |\n\n<strong>Notes</strong>\n\n\u2022 This is a key differentiator feature with high value for brokers\n\u2022 Consider starting with a focused MVP (compliance analysis only) and expanding\n\u2022 May want to offer this as a premium/paid feature\n\u2022 Privacy considerations: ensure users understand AI is analyzing their communications"
  },
  {
    "id": "BACKLOG-378",
    "title": "Call Log Support for Transaction Audits",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~60K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-378.md](items/BACKLOG-378.md)",
    "description": "<strong>Summary</strong>\n\nReal estate agents make many phone calls during transactions. Auditors need visibility into call logs (incoming, outgoing, missed calls) with contacts involved in a transaction to have a complete communication audit trail.\n\n<strong>Category</strong>\n\nfeature\n\n<strong>Priority</strong>\n\nMedium\n\n<strong>Status</strong>\n\nPending\n\n<strong>User Story</strong>\n\n**As a** real estate compliance auditor,\n**I want** to see phone call logs alongside emails and text messages in transaction audits,\n**So that** I have a complete picture of all communications for compliance and record-keeping purposes.\n\n<strong>Current Behavior</strong>\n\n\u2022 Only email and text message communications are tracked\n\u2022 Phone calls are not captured or displayed\n\u2022 Audit exports only include written communications\n\u2022 No visibility into call frequency, duration, or direction with transaction contacts\n\n<strong>Proposed Behavior</strong>\n\n\u2022 Call logs imported from iPhone backup\n\u2022 New \"Calls\" tab in transaction details\n\u2022 Call logs filtered by transaction contacts\n\u2022 Call logs included in audit exports\n\u2022 Calls displayed in timeline alongside emails and texts\n\n<strong>Feature Requirements</strong>\n\n<strong>1. Call Log Import</strong>\n\nImport call logs from iPhone backup:\n\u2022 Phone number\n\u2022 Call direction (incoming, outgoing, missed)\n\u2022 Call duration (seconds)\n\u2022 Timestamp\n\u2022 Contact name (if matched in contacts database)\n\n<strong>2. Call Log Storage</strong>\n\nStore call logs in database:\n\u2022 New <code>call_logs</code> table with appropriate schema\n\u2022 Link to contacts (via phone number matching)\n\u2022 Link to transactions (via contact association)\n\u2022 Searchable and filterable\n\n<strong>3. Transaction Details Tab - Calls</strong>\n\nNew \"Calls\" tab in transaction details:\n\u2022 List all calls to/from contacts assigned to the transaction\n\u2022 Filter by: incoming, outgoing, missed\n\u2022 Sort by date (newest first default)\n\u2022 Show call duration (formatted: 0:00, 1:23, etc.)\n\u2022 Show contact name and phone number\n\u2022 Show call direction icon\n\u2022 Empty state when no calls found\n\n<strong>4. Export Integration</strong>\n\nInclude call logs in audit exports:\n\u2022 Call log summary section in PDF\n\u2022 Call log appendix with detailed list\n\u2022 Timeline integration (calls shown alongside emails/texts)\n\u2022 Call statistics per contact (total calls, total duration)\n\n<strong>5. Android Support (Future)</strong>\n\nWhen Android is added (BACKLOG-373), include Android call logs:\n\u2022 Same schema and UI\n\u2022 Android call log database parsing\n\u2022 Platform-agnostic call log display\n\n<strong>Technical Considerations</strong>\n\n<strong>Database Schema</strong>\n\n<code>CREATE TABLE call_logs (\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\n  phone_number TEXT NOT NULL,\n  contact_id INTEGER,\n  direction TEXT NOT NULL, -- 'incoming', 'outgoing', 'missed'\n  duration INTEGER, -- seconds\n  timestamp TEXT NOT NULL,\n  device_source TEXT, -- 'iphone', 'android'\n  created_at TEXT DEFAULT CURRENT_TIMESTAMP,\n  FOREIGN KEY (contact_id) REFERENCES contacts(id)\n);\n\nCREATE INDEX idx_call_logs_phone ON call_logs(phone_number);\nCREATE INDEX idx_call_logs_contact ON call_logs(contact_id);\nCREATE INDEX idx_call_logs_timestamp ON call_logs(timestamp);\n</code>\n\n<strong>iPhone Backup Location</strong>\n\nCall history is stored in:\n\u2022 <code>HomeDomain/Library/CallHistoryDB/CallHistory.storedata</code> (iOS 8+)\n\u2022 SQLite database with <code>ZCALLRECORD</code> table\n\n<strong>Call Record Fields (iOS)</strong>\n\n| iOS Field | Mapped Field |\n|-----------|--------------|\n| ZADDRESS | phone_number |\n| ZCALLTYPE | direction (4=incoming, 1=outgoing, 16=missed) |\n| ZDURATION | duration |\n| ZDATE | timestamp (Core Data timestamp) |\n\n<strong>Phone Number Matching</strong>\n\n\u2022 Normalize phone numbers before matching (strip formatting)\n\u2022 Match to existing contacts by phone number\n\u2022 Handle multiple phone numbers per contact\n\u2022 Consider international number formats\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Call logs imported from iPhone backup during sync\n\u2610 New <code>call_logs</code> database table created and populated\n\u2610 Calls linked to contacts by phone number\n\u2610 New \"Calls\" tab visible in transaction details\n\u2610 Calls filtered by contacts assigned to transaction\n\u2610 Incoming/outgoing/missed filter works\n\u2610 Sort by date works\n\u2610 Call duration displayed in human-readable format\n\u2610 Contact name displayed (or \"Unknown\" if no match)\n\u2610 Call logs included in PDF export\n\u2610 Call logs included in audit package export\n\u2610 Timeline shows calls (if timeline feature exists)\n\u2610 Tests cover call log parsing and display\n\u2610 Empty state shown when no calls for transaction\n\n<strong>Out of Scope (Initial Release)</strong>\n\n\u2022 VoIP calls (FaceTime Audio, WhatsApp calls, etc.)\n\u2022 Call recordings (not accessible)\n\u2022 Real-time call monitoring\n\u2022 Android call logs (deferred to BACKLOG-373)\n\u2022 Call transcription\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-373: Android Device Support (for future Android call logs)\n\u2022 Existing iPhone backup parsing infrastructure\n\u2022 Contact matching service\n\n<strong>Files Potentially Affected</strong>\n\n\u2022 New: <code>src/electron/services/callLogService.ts</code> - Call log parsing and storage\n\u2022 New: <code>src/electron/services/callLogParser.ts</code> - iPhone call history parsing\n\u2022 <code>src/electron/services/iosBackupService.ts</code> - Add call log file extraction\n\u2022 New: <code>src/components/transactionDetails/CallsTab.tsx</code> - Calls tab UI\n\u2022 <code>src/components/transactionDetails/TransactionDetails.tsx</code> - Add tab\n\u2022 Database migrations - New <code>call_logs</code> table\n\u2022 <code>src/electron/services/folderExportService.ts</code> - Add call export\n\u2022 <code>src/electron/services/pdfExportService.ts</code> - Add call section\n\u2022 IPC handlers for call log operations\n\n<strong>Estimated Effort</strong>\n\n~60K tokens (medium feature with parsing, storage, UI, and export components)\n\n<strong>Risk Assessment</strong>\n\n| Risk | Likelihood | Impact | Mitigation |\n|------|------------|--------|------------|\n| iOS version call log format changes | Low | Medium | Test across iOS versions |\n| Phone number matching accuracy | Medium | Medium | Implement robust normalization |\n| Large call logs affecting performance | Low | Low | Pagination and virtualization |\n| Encrypted backup call logs | Medium | High | Ensure backup decryption covers call DB |\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-373: Android Device Support (Android call logs)\n\u2022 BACKLOG-105: Text Messages Tab (similar UI pattern)\n\u2022 BACKLOG-332: Audit Package Missing Attachments and Text Messages (export completeness)\n\u2022 BACKLOG-342: Include Orphan Messages in Audit Export (timeline integration)"
  },
  {
    "id": "BACKLOG-379",
    "title": "Continue Setup Button No-Op (goToEmailOnboarding)",
    "category": "fix",
    "priority": "High",
    "status": "Pending",
    "sprint": "SPRINT-049",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-379.md](items/BACKLOG-379.md)",
    "description": "<strong>Description</strong>\n\nThe \"Continue Setup\" button on the Dashboard (which appears when email is not connected) does nothing when clicked. The underlying <code>goToEmailOnboarding()</code> function is implemented as a no-op.\n\n<strong>Current Behavior</strong>\n\n1. User logs in and reaches Dashboard\n2. If email is not connected, \"Continue Setup\" prompt appears\n3. Clicking \"Continue Setup\" button triggers <code>goToEmailOnboarding()</code>\n4. Nothing happens - function is a no-op\n\n<strong>Root Cause</strong>\n\nIn <code>/Users/daniel/Documents/Mad/src/appCore/state/flows/useNavigationFlow.ts</code>:\n<code>const goToEmailOnboarding = useCallback(() => {\n  // No-op: state machine drives navigation\n}, []);\n</code>\n\nThe function was intentionally left as a no-op during the state machine migration, but the Dashboard still uses it expecting actual navigation.\n\n<strong>Expected Behavior</strong>\n\nClicking \"Continue Setup\" should navigate the user to email onboarding/connection flow.\n\n<strong>Files Affected</strong>\n\n| File | Purpose |\n|------|---------|\n| <code>src/appCore/state/flows/useNavigationFlow.ts</code> | Contains the no-op implementation |\n| <code>src/appCore/AppRouter.tsx:151</code> | Passes <code>goToEmailOnboarding</code> to Dashboard |\n| <code>src/components/Dashboard.tsx</code> | Uses <code>onContinueSetup</code> callback |\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 \"Continue Setup\" button navigates user to email connection flow\n\u2610 Works for both new users and returning users who haven't connected email\n\u2610 Proper state machine transition (if applicable)\n\u2610 Button is removed/hidden after email is successfully connected\n\n<strong>Technical Notes</strong>\n\nOptions:\n1. Implement actual navigation in <code>goToEmailOnboarding()</code> via state machine dispatch\n2. Replace with a direct Settings navigation to email section\n3. Open a modal for email connection options\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-211: Email Onboarding State Mismatch\n\u2022 BACKLOG-380: hasEmailConnected State Sync Issue"
  },
  {
    "id": "BACKLOG-380",
    "title": "hasEmailConnected Returns False Despite Working Email Sync",
    "category": "fix",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-21",
    "completed_at": "",
    "file": "[BACKLOG-380.md](items/BACKLOG-380.md)",
    "description": "<strong>Description</strong>\n\nThe <code>hasEmailConnected</code> state returns <code>false</code> even when email sync is actually working. This causes the \"Continue Setup\" prompt to appear unnecessarily on the Dashboard and creates confusion about the app's state.\n\n<strong>Current Behavior</strong>\n\n1. User has connected their email account\n2. Email sync runs successfully (new emails are detected/imported)\n3. <code>hasEmailConnected</code> returns <code>false</code>\n4. Dashboard shows \"Continue Setup\" prompt incorrectly\n5. Settings may show \"Connected\" status (inconsistent)\n6. **Banner does not auto-dismiss after successful email reconnection** - requires page refresh\n\n<strong>Expected Behavior</strong>\n\n1. User has connected their email account\n2. Email sync works\n3. <code>hasEmailConnected</code> returns <code>true</code>\n4. Dashboard shows normal state (no setup prompt)\n5. Settings shows \"Connected\" status (consistent)\n\n<strong>Investigation Areas</strong>\n\n1. **State derivation**: Where is <code>hasEmailConnected</code> derived from?\n2. **Database flag**: Check <code>email_onboarding_completed</code> in user settings\n3. **Token check**: Is there a valid OAuth token that's not being detected?\n4. **State machine**: Is the connected state being properly set in machine context?\n\n<strong>Files to Investigate</strong>\n\n| File | Purpose |\n|------|---------|\n| <code>src/appCore/state/machine/selectors/userDataSelectors.ts</code> | May contain hasEmailConnected derivation |\n| <code>electron/handlers/sessionHandlers.ts</code> | <code>handleCheckEmailOnboarding</code> |\n| <code>electron/services/connectionStatusService.ts</code> | Connection status logic |\n| State machine context | Where email connection state is stored |\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>hasEmailConnected</code> returns <code>true</code> when email sync is working\n\u2610 Dashboard does not show \"Continue Setup\" when email is connected\n\u2610 State is consistent across Dashboard and Settings\n\u2610 No false positives (don't show connected if not actually connected)\n\u2610 Banner auto-dismisses after successful email connection (no refresh needed)\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-211: Email Onboarding State Mismatch (very similar, may be duplicate)\n\u2022 BACKLOG-379: Continue Setup Button No-Op\n\n<strong>Notes</strong>\n\nThis may be the same root cause as BACKLOG-211. If so, fixing BACKLOG-211 should resolve this. Recommend investigating together.\n\n<strong>Debug Session Findings (2026-01-21)</strong>\n\nConsole debugging revealed:\n<code>// Email onboarding thinks setup is complete\ncheckEmailOnboarding: { success: true, completed: true }\n\n// But actual Google connection shows expired token\ncheckGoogleConnection: { connected: false, error: { type: 'TOKEN_REFRESH_FAILED', userMessage: 'Gmail connection expired' }}\n</code>\n\n**Root cause**: <code>email_onboarding_completed</code> flag is set to <code>true</code> once, but actual token can expire later. The banner logic checks the flag (completed=true, so should hide) but something else is triggering the banner to show. Need to trace the banner's visibility logic."
  },
  {
    "id": "BACKLOG-381",
    "title": "Transaction Details Header Improvements (Audit Period + Type + Edit Button)",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "SPRINT-049",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "",
    "file": "[BACKLOG-381.md](items/BACKLOG-381.md)",
    "description": "<strong>Description</strong>\n\nImprove the transaction details view with better information display and consistent edit button placement.\n\n<strong>Changes Required</strong>\n\n<strong>1. Add Audit Period Display</strong>\nShow the transaction's audit date range prominently in the details:\n\u2022 Format: \"Audit Period: Nov 8, 2025 - Jan 27, 2026\"\n\u2022 Location: Near the top of transaction details (Overview section)\n\n<strong>2. Add Transaction Type Display</strong>\nShow whether the transaction is a Purchase or Sale:\n\u2022 Format: \"Type: Purchase\" or \"Type: Sale\"\n\u2022 Could use badge/pill styling for visual distinction\n\n<strong>3. Move Edit Details Button</strong>\nCurrently the \"Edit Details\" button is in the header bar of transaction details. Since we now have section-specific edit buttons (Edit Contacts, etc.), this is inconsistent.\n\n**Current**: Edit button in top header bar\n**Expected**: Edit button within the Overview/Details section, consistent with other section edit buttons\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Audit period (started_at - closed_at) displayed in Overview section\n\u2610 Transaction type (purchase/sale) displayed prominently\n\u2610 Edit Details button moved from header bar to Overview section\n\u2610 Edit button styling consistent with other section edit buttons\n\u2610 Handles missing dates gracefully (shows \"Not set\" or similar)\n\n<strong>Related</strong>\n\n\u2022 TransactionDetails.tsx\n\u2022 TransactionDetailsTab.tsx (Overview section)\n\u2022 BACKLOG-335 (Enforce Transaction Start Date)"
  },
  {
    "id": "BACKLOG-382",
    "title": "Persistent Export History in Transaction Details",
    "category": "feature",
    "priority": "Medium",
    "status": "Obsolete",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "",
    "file": "[BACKLOG-382.md](items/BACKLOG-382.md)",
    "description": "<strong>Description</strong>\n\nShow last export information in both the transaction card (dashboard list) and transaction details page. Users should be able to see at a glance which transactions have been exported and when.\n\n<strong>Current Behavior</strong>\n\n\u2022 Export success message appears briefly after export\n\u2022 User may miss the Finder link if message auto-dismisses\n\u2022 No way to find the exported file later without re-exporting\n\u2022 No indication on dashboard which transactions have been exported\n\n<strong>Expected Behavior</strong>\n\n<strong>Transaction Card (Dashboard)</strong>\nShow compact export status:\n<code>123 Main St                    Exported: Jan 22\nPurchase | 5 emails, 3 texts   [or \"Not exported\" in muted text]\n</code>\n\n<strong>Transaction Details (Overview Tab)</strong>\nShow full export section:\n<code>Last Export\nExported: Jan 22, 2026 at 3:45 PM\nLocation: ~/Documents/Audits/123-Main-St.pdf\n[Open in Finder]\n</code>\n\n<strong>Requirements</strong>\n\n<strong>Transaction Card Display</strong>\n\u2022 Show \"Exported: [date]\" if exported (compact format, e.g., \"Jan 22\")\n\u2022 Show \"Not exported\" in muted/gray text if never exported\n\u2022 Keep it subtle - don't clutter the card\n\n<strong>Transaction Details Display</strong>\n\u2022 Show \"Last Export\" section if transaction has been exported\n\u2022 Show \"Not exported yet\" if never exported\n\u2022 Display export date/time (full format)\n\u2022 Display file path (truncated if too long)\n\u2022 Clickable \"Open in Finder\" link\n\n<strong>Data Storage</strong>\n\u2022 Store last export timestamp in transaction record\n\u2022 Store last export file path in transaction record\n\u2022 Update on each successful export\n\n<strong>Database Changes</strong>\n<code>ALTER TABLE transactions ADD COLUMN last_exported_at TEXT;\nALTER TABLE transactions ADD COLUMN last_export_path TEXT;\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n<strong>Transaction Card</strong>\n\u2610 Shows \"Exported: [date]\" on cards for exported transactions\n\u2610 Shows \"Not exported\" (muted) for never-exported transactions\n\u2610 Date format is compact (e.g., \"Jan 22\" or \"Jan 22, 2026\")\n\n<strong>Transaction Details</strong>\n\u2610 Export history section visible in Overview tab\n\u2610 Shows full date/time of last export\n\u2610 Shows file path of last export\n\u2610 \"Open in Finder\" button works\n\u2610 Handles never-exported state gracefully\n\n<strong>General</strong>\n\u2610 Updates after each new export\n\u2610 Database columns added (<code>last_exported_at</code>, <code>last_export_path</code>)\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-352 (Export Success Message with Finder Link)\n\u2022 BACKLOG-367 (Consolidate duplicate export date columns)\n\u2022 TransactionCard.tsx\n\u2022 TransactionDetails.tsx\n\u2022 Export services"
  },
  {
    "id": "BACKLOG-383",
    "title": "Format Role Pills with Human-Readable Labels",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "SPRINT-049",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "",
    "file": "[BACKLOG-383.md](items/BACKLOG-383.md)",
    "description": "<strong>Description</strong>\n\nThe role pills/badges on contact cards in the transaction details Overview page display raw database values like \"seller_agent\" instead of formatted labels like \"Seller Agent\".\n\n<strong>Current Behavior</strong>\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 John Smith                  \u2502\n\u2502 [seller_agent] [primary]    \u2502  \u2190 Looks like code\n\u2502 john@example.com            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n<strong>Expected Behavior</strong>\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 John Smith                  \u2502\n\u2502 [Seller Agent] [Primary]    \u2502  \u2190 Professional\n\u2502 john@example.com            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n<strong>Role Mappings</strong>\n\n| Database Value | Display Label |\n|----------------|---------------|\n| seller_agent | Seller Agent |\n| buyer_agent | Buyer Agent |\n| seller | Seller |\n| buyer | Buyer |\n| lender | Lender |\n| escrow | Escrow |\n| title | Title |\n| inspector | Inspector |\n| appraiser | Appraiser |\n| attorney | Attorney |\n| other | Other |\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 All role pills display human-readable labels\n\u2610 Labels use Title Case formatting\n\u2610 Underscores replaced with spaces\n\u2610 Consistent styling across all contact cards\n\u2610 Works in both Overview and any other places roles are displayed\n\n<strong>Technical Notes</strong>\n\nCreate a utility function like:\n<code>function formatRoleLabel(role: string): string {\n  return role\n    .split('_')\n    .map(word => word.charAt(0).toUpperCase() + word.slice(1))\n    .join(' ');\n}\n</code>\n\n<strong>Related</strong>\n\n\u2022 TransactionDetailsTab.tsx (Overview section)\n\u2022 Contact cards component"
  },
  {
    "id": "BACKLOG-384",
    "title": "AI-Extracted Date Verification Badges",
    "category": "feature",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "",
    "file": "[BACKLOG-384.md](items/BACKLOG-384.md)",
    "description": "<strong>Description</strong>\n\nWhen the AI extracts transaction dates from emails, add verification UI to help agents confirm or adjust the dates.\n\n<strong>Requirements</strong>\n\n<strong>1. AI-Extracted Start Date Verification</strong>\n\u2022 When start date is extracted from emails using AI, flag it for verification\n\u2022 Show indicator: \"Start date extracted from emails - please verify\"\n\u2022 Real estate agent must confirm/adjust the date before it's considered final\n\u2022 Store verification status (verified/unverified)\n\n<strong>2. UI Indicators</strong>\n\u2022 Show \"Verified\" badge if agent confirmed the start date\n\u2022 Show \"Needs Verification\" badge if AI-extracted and unconfirmed\n\u2022 Warn if linked messages exist before start date\n\n<strong>3. Database Changes</strong>\n\n<code>ALTER TABLE transactions ADD COLUMN start_date_verified BOOLEAN DEFAULT FALSE;\nALTER TABLE transactions ADD COLUMN start_date_source TEXT; -- 'manual', 'ai_extracted'\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 AI-extracted dates show \"Needs Verification\" badge\n\u2610 User can click to verify/confirm the date\n\u2610 Verified dates show \"Verified\" badge\n\u2610 Verification status stored in database\n\u2610 Manual transactions auto-verified\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-335 (Enforce Transaction Start Date)\n\u2022 AI extraction service\n\n<strong>Notes</strong>\n\nSplit from BACKLOG-335 to focus on manual transaction flow first."
  },
  {
    "id": "BACKLOG-385",
    "title": "Contact Email Missing Prompt",
    "category": "ux",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-050",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-385.md](items/BACKLOG-385.md)",
    "description": "<strong>Description</strong>\n\nWhen adding contacts to a transaction, if any contacts are missing email addresses, show a popup prompting the user to add emails now. This ensures contacts have the information needed for email linking.\n\n<strong>User Flow</strong>\n\n1. User adds contacts to a transaction\n2. On save/confirm, system checks if any added contacts lack email addresses\n3. If contacts are missing emails, show popup:\n   <code>   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n   \u2502 Missing Email Addresses                             \u2502\n   \u2502                                                     \u2502\n   \u2502 The following contacts don't have email addresses.  \u2502\n   \u2502 Would you like to add them now?                     \u2502\n   \u2502                                                     \u2502\n   \u2502 \u2610 John Smith                                        \u2502\n   \u2502 \u2610 Sarah Johnson                                     \u2502\n   \u2502                                                     \u2502\n   \u2502 Adding email addresses helps us find related        \u2502\n   \u2502 emails for your transaction audit.                  \u2502\n   \u2502                                                     \u2502\n   \u2502         [Add Emails Now]  [Skip for Now]            \u2502\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n   </code>\n4. If user clicks \"Add Emails Now\", show inline email input for each contact\n5. Save emails and continue\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 System detects contacts without email addresses on transaction save\n\u2610 Popup appears listing contacts missing emails\n\u2610 User can add email directly in the popup\n\u2610 User can skip and proceed without adding emails\n\u2610 Added emails are saved to contact records\n\u2610 Emails are validated before saving\n\u2610 Works in both new transaction creation and edit flows\n\n<strong>Technical Notes</strong>\n\n\u2022 Check contact.email field for null/empty\n\u2022 Could reuse inline edit pattern from contact cards\n\u2022 Should not block transaction save - just prompt\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-371 (Contact Update Sync and Re-link Messages)\n\u2022 Transaction creation flow\n\u2022 Contact editing"
  },
  {
    "id": "BACKLOG-386",
    "title": "Unified Contact Selection and Management UX",
    "category": "ux",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-050",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-386.md](items/BACKLOG-386.md)",
    "description": "<strong>Description</strong>\n\nSimplify and unify the contact selection experience across the app. Currently there are separate flows for \"Select Contacts\" (in transaction) and \"Contacts\" (dashboard). These should share components and have consistent behavior.\n\n<strong>Current Problems</strong>\n\n1. **Separate Import Flow**: Users must explicitly click \"Import\" to bring in external contacts\n2. **Inconsistent UX**: Dashboard Contacts screen and Select Contacts modal have different layouts\n3. **No Source Tags**: Can't tell which contacts are imported vs. external vs. manually created\n4. **Message Contacts Mixed In**: Weird numbers like 1800, *166 show up in contact lists\n\n<strong>Solution</strong>\n\n<strong>1. Single Unified Contact List with Source Tags</strong>\n\nShow ALL contacts in one list with visual tags:\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Contacts                              [+ New Contact]\u2502\n\u2502                                                      \u2502\n\u2502 Filter: [Imported \u2713] [External \u2713] [Manual \u2713] [Msgs \u25cb]\u2502\n\u2502                                                      \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502 \u2502 John Smith                        [IMPORTED]   \u2502  \u2502\n\u2502 \u2502 john@email.com                                 \u2502  \u2502\n\u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502 \u2502 Sarah Johnson                     [EXTERNAL]   \u2502  \u2502\n\u2502 \u2502 +1 (424) 555-1234                              \u2502  \u2502\n\u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502 \u2502 Bob Wilson                        [MANUAL]     \u2502  \u2502\n\u2502 \u2502 bob@company.com                                \u2502  \u2502\n\u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n<strong>2. Contact Source Types</strong>\n\n| Type | Tag | Description |\n|------|-----|-------------|\n| Imported | <code>[IMPORTED]</code> | Synced from device contacts/address book |\n| External | <code>[EXTERNAL]</code> | From email headers or phone contacts app, not yet imported |\n| Manual | <code>[MANUAL]</code> | Created manually in the app |\n| Message | <code>[MSG]</code> | Derived from message threads (phone numbers only) |\n\n<strong>3. Auto-Import on Selection</strong>\n\n\u2022 When user selects an EXTERNAL contact, automatically import it\n\u2022 No separate \"Import\" button needed\n\u2022 Contact becomes IMPORTED after selection\n\n<strong>4. Filter Controls</strong>\n\n**Default filters (ON):**\n\u2022 Imported \u2713\n\u2022 External \u2713\n\u2022 Manual \u2713\n\n**Default filters (OFF):**\n\u2022 Message contacts \u2717 (hide weird numbers like 1800, *166)\n\n<strong>5. Consistent Across Screens</strong>\n\n| Screen | Location | Behavior |\n|--------|----------|----------|\n| Dashboard \u2192 Contacts | Full contact management | All features, delete, edit |\n| Transaction \u2192 Select Contacts | Modal | Same list, selection mode, auto-import |\n\n**Reuse Components:**\n\u2022 Share the same <code>ContactList</code> component\n\u2022 Share the same filter controls\n\u2022 Share the same tag styling\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Single contact list component used in both locations\n\u2610 Source tags visible on all contact cards\n\u2610 Filter bar with toggles for each source type\n\u2610 Message contacts hidden by default\n\u2610 External contacts auto-import when selected\n\u2610 No separate \"Import\" button/flow needed\n\u2610 Dashboard Contacts and Select Contacts modal look consistent\n\u2610 Prioritize showing contact names over phone numbers\n\n<strong>Technical Notes</strong>\n\n\u2022 Add <code>source</code> field to contact model: 'imported' | 'external' | 'manual' | 'message'\n\u2022 Create shared <code><ContactListWithFilters></code> component\n\u2022 May need to refactor existing Contacts.tsx and SelectContactsModal.tsx\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-317 (Unified Contact Selection UX Refactor) - supersedes this\n\u2022 BACKLOG-143 (Prevent Duplicate Contact Imports)\n\u2022 BACKLOG-165 (Duplicate Contacts in Import Contacts Page)\n\u2022 BACKLOG-016 (Refactor Contact Import)"
  },
  {
    "id": "BACKLOG-387",
    "title": "Supabase Schema - Organizations Members Submissions",
    "category": "schema",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-050",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-387.md](items/BACKLOG-387.md)",
    "description": "<strong>Summary</strong>\n\nCreate the complete Supabase database schema for the B2B broker portal feature. This includes all tables needed for multi-tenant organization support, user membership with roles, transaction submissions for broker review, and related messages/attachments.\n\n---\n\n<strong>Problem Statement</strong>\n\nMagic Audit currently operates as a single-user B2C application with all data stored locally. To support B2B broker workflows, we need:\n\u2022 Organization/tenant model for broker firms\n\u2022 User-organization relationships with role-based access\n\u2022 Cloud storage of submitted transactions for broker review\n\u2022 Message and attachment records for compliance review\n\n---\n\n<strong>Proposed Solution</strong>\n\nCreate a new migration file with all required tables and their relationships.\n\n<strong>Tables to Create</strong>\n\n#### 1. organizations\n<code>CREATE TABLE organizations (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  name VARCHAR(255) NOT NULL,\n  slug VARCHAR(100) UNIQUE NOT NULL,  -- for URLs: acme-realty\n  plan VARCHAR(50) DEFAULT 'trial',   -- trial, pro, enterprise\n  max_seats INTEGER DEFAULT 5,\n  retention_years INTEGER DEFAULT 7,  -- compliance archive period\n  settings JSONB DEFAULT '{}',\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n</code>\n\n#### 2. organization_members\n<code>CREATE TABLE organization_members (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,\n  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,\n  role VARCHAR(50) NOT NULL,  -- 'agent', 'broker', 'admin', 'it_admin'\n  license_status VARCHAR(50) DEFAULT 'active',  -- active, suspended, expired\n  invited_at TIMESTAMPTZ DEFAULT NOW(),\n  joined_at TIMESTAMPTZ,\n  invited_by UUID REFERENCES auth.users(id),\n  -- SR Engineer additions\n  invited_email VARCHAR(255),      -- email for pending invitations\n  invitation_token VARCHAR(255),   -- token for invite redemption\n  UNIQUE(organization_id, user_id)\n);\n</code>\n\n#### 3. transaction_submissions\n<code>CREATE TABLE transaction_submissions (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  organization_id UUID REFERENCES organizations(id),\n  submitted_by UUID REFERENCES auth.users(id),  -- the agent\n\n  -- Transaction Data (denormalized from desktop)\n  local_transaction_id TEXT NOT NULL,  -- ID from desktop SQLite\n  property_address TEXT NOT NULL,\n  property_city TEXT,\n  property_state TEXT,\n  property_zip TEXT,\n  transaction_type VARCHAR(50),  -- purchase, sale, other\n  listing_price NUMERIC,\n  sale_price NUMERIC,\n  started_at TIMESTAMPTZ,\n  closed_at TIMESTAMPTZ,\n\n  -- Review Workflow\n  status VARCHAR(50) DEFAULT 'submitted',\n  -- submitted -> under_review -> needs_changes -> resubmitted -> approved/rejected\n  reviewed_by UUID REFERENCES auth.users(id),  -- the broker\n  reviewed_at TIMESTAMPTZ,\n  review_notes TEXT,  -- broker's feedback\n\n  -- SR Engineer additions for resubmission tracking\n  version INTEGER DEFAULT 1,\n  parent_submission_id UUID REFERENCES transaction_submissions(id),\n\n  -- Counts (denormalized for list performance)\n  message_count INTEGER DEFAULT 0,\n  attachment_count INTEGER DEFAULT 0,\n\n  -- Metadata\n  submission_metadata JSONB,  -- detection_source, confidence, etc.\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW(),\n\n  UNIQUE(organization_id, local_transaction_id, version)\n);\n</code>\n\n#### 4. submission_messages\n<code>CREATE TABLE submission_messages (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  submission_id UUID REFERENCES transaction_submissions(id) ON DELETE CASCADE,\n  local_message_id TEXT,  -- ID from desktop\n\n  channel VARCHAR(50),  -- email, sms, imessage\n  direction VARCHAR(50),  -- inbound, outbound\n  subject TEXT,\n  body_text TEXT,\n  participants JSONB,  -- {from, to, cc, bcc}\n  sent_at TIMESTAMPTZ,\n  thread_id TEXT,\n\n  has_attachments BOOLEAN DEFAULT FALSE,\n  attachment_count INTEGER DEFAULT 0,\n\n  created_at TIMESTAMPTZ DEFAULT NOW()\n);\n</code>\n\n#### 5. submission_attachments\n<code>CREATE TABLE submission_attachments (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  submission_id UUID REFERENCES transaction_submissions(id) ON DELETE CASCADE,\n  message_id UUID REFERENCES submission_messages(id),\n\n  filename VARCHAR(255) NOT NULL,\n  mime_type VARCHAR(100),\n  file_size_bytes INTEGER,\n  storage_path TEXT NOT NULL,  -- Supabase Storage path\n\n  document_type VARCHAR(50),  -- offer, inspection, contract, etc.\n\n  created_at TIMESTAMPTZ DEFAULT NOW()\n);\n</code>\n\n#### 6. submission_comments (SR Engineer addition)\n<code>CREATE TABLE submission_comments (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  submission_id UUID REFERENCES transaction_submissions(id) ON DELETE CASCADE,\n  author_id UUID REFERENCES auth.users(id),\n\n  content TEXT NOT NULL,\n  comment_type VARCHAR(50) DEFAULT 'feedback',  -- feedback, question, internal_note\n\n  -- For threaded comments\n  parent_comment_id UUID REFERENCES submission_comments(id),\n\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n</code>\n\n<strong>Indexes</strong>\n\n<code>-- Performance indexes\nCREATE INDEX idx_org_members_user ON organization_members(user_id);\nCREATE INDEX idx_org_members_org ON organization_members(organization_id);\nCREATE INDEX idx_submissions_org ON transaction_submissions(organization_id);\nCREATE INDEX idx_submissions_status ON transaction_submissions(status);\nCREATE INDEX idx_submissions_submitted_by ON transaction_submissions(submitted_by);\nCREATE INDEX idx_submission_messages_submission ON submission_messages(submission_id);\nCREATE INDEX idx_submission_attachments_submission ON submission_attachments(submission_id);\nCREATE INDEX idx_submission_comments_submission ON submission_comments(submission_id);\n</code>\n\n---\n\n<strong>Files to Create/Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>supabase/migrations/YYYYMMDD_b2b_schema.sql</code> | New migration with all tables |\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 None (first task in sprint)\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Migration file created with all 6 tables\n\u2610 All foreign key relationships properly defined\n\u2610 Indexes created for common query patterns\n\u2610 Migration runs successfully on Supabase\n\u2610 Tables visible in Supabase Dashboard\n\u2610 No breaking changes to existing <code>users</code> table\n\n---\n\n<strong>Technical Notes</strong>\n\n<strong>Existing Schema Considerations</strong>\n\nThe <code>users</code> table already exists with auth fields. The new <code>organization_members</code> table references <code>auth.users(id)</code> (Supabase's auth schema), not a custom users table.\n\n<strong>Status Values</strong>\n\nFor <code>transaction_submissions.status</code>:\n\u2022 <code>submitted</code> - Initial state after agent submits\n\u2022 <code>under_review</code> - Broker has opened for review\n\u2022 <code>needs_changes</code> - Broker requested modifications\n\u2022 <code>resubmitted</code> - Agent has resubmitted after changes\n\u2022 <code>approved</code> - Broker approved\n\u2022 <code>rejected</code> - Broker rejected\n\n<strong>JSONB Fields</strong>\n\n\u2022 <code>organizations.settings</code> - Future extensibility for org preferences\n\u2022 <code>transaction_submissions.submission_metadata</code> - Source info, confidence scores\n\u2022 <code>submission_messages.participants</code> - Structured email addresses\n\n---\n\n<strong>Testing Plan</strong>\n\n1. Run migration in development Supabase project\n2. Verify all tables created with correct columns\n3. Test foreign key constraints work correctly\n4. Test unique constraints prevent duplicates\n5. Verify indexes created\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-388: RLS Policies + Storage Bucket (depends on this)\n\u2022 BACKLOG-389: Demo Seed Data (depends on this)\n\u2022 SPRINT-050: B2B Broker Portal Demo"
  },
  {
    "id": "BACKLOG-388",
    "title": "RLS Policies + Storage Bucket",
    "category": "security",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-050",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-388.md](items/BACKLOG-388.md)",
    "description": "<strong>Summary</strong>\n\nCreate Row-Level Security (RLS) policies for all B2B tables and configure a Supabase Storage bucket for submission attachments with proper access controls.\n\n---\n\n<strong>Problem Statement</strong>\n\nThe schema created in BACKLOG-387 has no security policies. Without RLS:\n\u2022 Any authenticated user could see all organizations' data\n\u2022 Agents could see other agents' submissions\n\u2022 Brokers could access data from other organizations\n\u2022 Storage files would be publicly accessible\n\n---\n\n<strong>Proposed Solution</strong>\n\n<strong>RLS Policies</strong>\n\n#### organizations Table\n\n<code>-- Enable RLS\nALTER TABLE organizations ENABLE ROW LEVEL SECURITY;\n\n-- Users can see their own organization(s)\nCREATE POLICY \"Users can view their organizations\"\n  ON organizations FOR SELECT\n  USING (\n    id IN (\n      SELECT organization_id FROM organization_members\n      WHERE user_id = auth.uid()\n    )\n  );\n\n-- Only admins can update organization settings\nCREATE POLICY \"Admins can update organization\"\n  ON organizations FOR UPDATE\n  USING (\n    id IN (\n      SELECT organization_id FROM organization_members\n      WHERE user_id = auth.uid() AND role IN ('admin', 'it_admin')\n    )\n  );\n</code>\n\n#### organization_members Table\n\n<code>ALTER TABLE organization_members ENABLE ROW LEVEL SECURITY;\n\n-- Users can see members in their organization\nCREATE POLICY \"View org members\"\n  ON organization_members FOR SELECT\n  USING (\n    organization_id IN (\n      SELECT organization_id FROM organization_members\n      WHERE user_id = auth.uid()\n    )\n  );\n\n-- Admins can manage members\nCREATE POLICY \"Admins manage members\"\n  ON organization_members FOR ALL\n  USING (\n    organization_id IN (\n      SELECT organization_id FROM organization_members\n      WHERE user_id = auth.uid() AND role IN ('admin', 'it_admin', 'broker')\n    )\n  );\n</code>\n\n#### transaction_submissions Table\n\n<code>ALTER TABLE transaction_submissions ENABLE ROW LEVEL SECURITY;\n\n-- Agents see their own submissions\nCREATE POLICY \"Agents view own submissions\"\n  ON transaction_submissions FOR SELECT\n  USING (submitted_by = auth.uid());\n\n-- Agents can create submissions\nCREATE POLICY \"Agents create submissions\"\n  ON transaction_submissions FOR INSERT\n  WITH CHECK (submitted_by = auth.uid());\n\n-- Agents can update own submissions (for resubmission)\nCREATE POLICY \"Agents update own submissions\"\n  ON transaction_submissions FOR UPDATE\n  USING (submitted_by = auth.uid());\n\n-- Brokers/admins see all org submissions\nCREATE POLICY \"Brokers view org submissions\"\n  ON transaction_submissions FOR SELECT\n  USING (\n    organization_id IN (\n      SELECT organization_id FROM organization_members\n      WHERE user_id = auth.uid() AND role IN ('broker', 'admin')\n    )\n  );\n\n-- Brokers can update submissions (review actions)\nCREATE POLICY \"Brokers review submissions\"\n  ON transaction_submissions FOR UPDATE\n  USING (\n    organization_id IN (\n      SELECT organization_id FROM organization_members\n      WHERE user_id = auth.uid() AND role IN ('broker', 'admin')\n    )\n  );\n</code>\n\n#### submission_messages Table\n\n<code>ALTER TABLE submission_messages ENABLE ROW LEVEL SECURITY;\n\n-- Access follows submission access\nCREATE POLICY \"View submission messages\"\n  ON submission_messages FOR SELECT\n  USING (\n    submission_id IN (\n      SELECT id FROM transaction_submissions\n      WHERE submitted_by = auth.uid()\n      OR organization_id IN (\n        SELECT organization_id FROM organization_members\n        WHERE user_id = auth.uid() AND role IN ('broker', 'admin')\n      )\n    )\n  );\n\n-- Agents can insert messages on their submissions\nCREATE POLICY \"Insert submission messages\"\n  ON submission_messages FOR INSERT\n  WITH CHECK (\n    submission_id IN (\n      SELECT id FROM transaction_submissions\n      WHERE submitted_by = auth.uid()\n    )\n  );\n</code>\n\n#### submission_attachments Table\n\n<code>ALTER TABLE submission_attachments ENABLE ROW LEVEL SECURITY;\n\n-- Same pattern as messages\nCREATE POLICY \"View submission attachments\"\n  ON submission_attachments FOR SELECT\n  USING (\n    submission_id IN (\n      SELECT id FROM transaction_submissions\n      WHERE submitted_by = auth.uid()\n      OR organization_id IN (\n        SELECT organization_id FROM organization_members\n        WHERE user_id = auth.uid() AND role IN ('broker', 'admin')\n      )\n    )\n  );\n\nCREATE POLICY \"Insert submission attachments\"\n  ON submission_attachments FOR INSERT\n  WITH CHECK (\n    submission_id IN (\n      SELECT id FROM transaction_submissions\n      WHERE submitted_by = auth.uid()\n    )\n  );\n</code>\n\n#### submission_comments Table\n\n<code>ALTER TABLE submission_comments ENABLE ROW LEVEL SECURITY;\n\n-- View comments on accessible submissions\nCREATE POLICY \"View submission comments\"\n  ON submission_comments FOR SELECT\n  USING (\n    submission_id IN (\n      SELECT id FROM transaction_submissions\n      WHERE submitted_by = auth.uid()\n      OR organization_id IN (\n        SELECT organization_id FROM organization_members\n        WHERE user_id = auth.uid() AND role IN ('broker', 'admin')\n      )\n    )\n  );\n\n-- Brokers can add comments\nCREATE POLICY \"Brokers add comments\"\n  ON submission_comments FOR INSERT\n  WITH CHECK (\n    author_id = auth.uid() AND\n    submission_id IN (\n      SELECT id FROM transaction_submissions\n      WHERE organization_id IN (\n        SELECT organization_id FROM organization_members\n        WHERE user_id = auth.uid() AND role IN ('broker', 'admin')\n      )\n    )\n  );\n</code>\n\n<strong>Storage Bucket Configuration</strong>\n\n<code>-- Create the storage bucket\nINSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)\nVALUES (\n  'submission-attachments',\n  'submission-attachments',\n  false,  -- Private bucket\n  52428800,  -- 50MB limit per file\n  ARRAY['image/jpeg', 'image/png', 'image/gif', 'application/pdf', \n        'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n        'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n        'text/plain']\n);\n\n-- Storage path pattern: {org_id}/{submission_id}/{filename}\n\n-- Storage policies\nCREATE POLICY \"Agents upload to own submissions\"\n  ON storage.objects FOR INSERT\n  WITH CHECK (\n    bucket_id = 'submission-attachments' AND\n    (storage.foldername(name))[1] IN (\n      SELECT organization_id::text FROM organization_members\n      WHERE user_id = auth.uid()\n    )\n  );\n\nCREATE POLICY \"View own org attachments\"\n  ON storage.objects FOR SELECT\n  USING (\n    bucket_id = 'submission-attachments' AND\n    (storage.foldername(name))[1] IN (\n      SELECT organization_id::text FROM organization_members\n      WHERE user_id = auth.uid()\n    )\n  );\n</code>\n\n---\n\n<strong>Files to Create/Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>supabase/migrations/YYYYMMDD_b2b_rls_policies.sql</code> | All RLS policies |\n| <code>supabase/migrations/YYYYMMDD_b2b_storage_bucket.sql</code> | Storage bucket setup |\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-387: Schema must exist before policies can be created\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 RLS enabled on all 6 B2B tables\n\u2610 Agent can only see own submissions\n\u2610 Broker can see all submissions in their org\n\u2610 Agent cannot see other agents' submissions\n\u2610 Broker cannot see other orgs' submissions\n\u2610 Storage bucket created with correct MIME type restrictions\n\u2610 Storage policies enforce org-scoped access\n\n---\n\n<strong>Technical Notes</strong>\n\n<strong>Demo Considerations</strong>\n\nFor demo purposes, the service key approach is acceptable:\n\u2022 Desktop app uses service key (bypasses RLS)\n\u2022 Portal uses user JWT (RLS enforced)\n\n**Production Migration Required:**\n\u2022 Desktop must eventually authenticate users properly\n\u2022 RLS will then protect desktop queries too\n\n<strong>Testing RLS Policies</strong>\n\n<code>-- Test as agent user\nSET LOCAL role TO 'authenticated';\nSET LOCAL request.jwt.claims TO '{\"sub\": \"agent-uuid-here\"}';\n\n-- Should only see own submissions\nSELECT * FROM transaction_submissions;\n\n-- Test as broker user\nSET LOCAL request.jwt.claims TO '{\"sub\": \"broker-uuid-here\"}';\n\n-- Should see all org submissions\nSELECT * FROM transaction_submissions;\n</code>\n\n<strong>Storage Path Convention</strong>\n\n<code>submission-attachments/\n  {org_id}/\n    {submission_id}/\n      document.pdf\n      photo.jpg\n</code>\n\nThis allows RLS policies to check org membership from the path.\n\n---\n\n<strong>Security Considerations</strong>\n\n1. **No Service Key in Portal**: Web portal uses only anon key + user JWT\n2. **Defense in Depth**: Even if RLS bypassed, API validation exists\n3. **Audit Logging**: Consider adding audit log triggers (post-demo)\n4. **Rate Limiting**: Consider per-user upload limits (post-demo)\n\n---\n\n<strong>Testing Plan</strong>\n\n1. Create test users: agent1, agent2, broker1 (same org), broker2 (different org)\n2. Agent1 creates submission - verify only agent1 sees it\n3. Broker1 reviews - verify broker1 sees submission\n4. Broker2 queries - verify broker2 does NOT see submission\n5. Agent2 queries - verify agent2 does NOT see submission\n6. Test storage: agent1 uploads file, broker1 can download, agent2/broker2 cannot\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-387: Supabase Schema (dependency)\n\u2022 BACKLOG-389: Demo Seed Data (depends on this)\n\u2022 SPRINT-050: B2B Broker Portal Demo"
  },
  {
    "id": "BACKLOG-389",
    "title": "Demo Seed Data",
    "category": "data",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-050",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-389.md](items/BACKLOG-389.md)",
    "description": "<strong>Summary</strong>\n\nCreate seed data for the B2B broker portal demo including one organization, multiple test users with different roles, and sample submissions for demonstration.\n\n---\n\n<strong>Problem Statement</strong>\n\nAfter schema (BACKLOG-387) and RLS (BACKLOG-388) are in place, we need test data to:\n\u2022 Verify RLS policies work correctly\n\u2022 Enable development of portal and desktop features\n\u2022 Provide realistic demo scenario data\n\n---\n\n<strong>Proposed Solution</strong>\n\nCreate a SQL seed script that populates the demo environment with:\n1. One organization (demo broker firm)\n2. Multiple users with different roles\n3. Sample transaction submissions in various states\n\n<strong>Demo Organization</strong>\n\n<code>-- Demo organization\nINSERT INTO organizations (id, name, slug, plan, max_seats, retention_years)\nVALUES (\n  'org-demo-001',  -- Fixed UUID for easy reference\n  'Acme Realty Group',\n  'acme-realty',\n  'pro',\n  10,\n  7\n);\n</code>\n\n<strong>Demo Users</strong>\n\nCreate users in Supabase Auth first (via Dashboard or API), then link to organization.\n\n**Roles:**\n| User | Email | Role | Purpose |\n|------|-------|------|---------|\n| Agent Alice | alice@acme-demo.test | agent | Primary demo agent |\n| Agent Bob | bob@acme-demo.test | agent | Secondary agent |\n| Broker Carol | carol@acme-demo.test | broker | Primary demo broker |\n| Admin Dana | dana@acme-demo.test | admin | Organization admin |\n\n<code>-- After creating auth users, link to organization\n-- (UUIDs will come from auth.users table)\n\nINSERT INTO organization_members (organization_id, user_id, role, license_status, joined_at)\nVALUES\n  ('org-demo-001', 'alice-auth-uuid', 'agent', 'active', NOW()),\n  ('org-demo-001', 'bob-auth-uuid', 'agent', 'active', NOW()),\n  ('org-demo-001', 'carol-auth-uuid', 'broker', 'active', NOW()),\n  ('org-demo-001', 'dana-auth-uuid', 'admin', 'active', NOW());\n</code>\n\n<strong>Sample Submissions</strong>\n\nCreate submissions in various workflow states for demo:\n\n<code>-- Submission 1: Approved (happy path)\nINSERT INTO transaction_submissions (\n  id, organization_id, submitted_by,\n  local_transaction_id, property_address, property_city, property_state, property_zip,\n  transaction_type, listing_price, sale_price,\n  status, reviewed_by, reviewed_at, review_notes,\n  message_count, attachment_count\n) VALUES (\n  gen_random_uuid(), 'org-demo-001', 'alice-auth-uuid',\n  'txn-local-001', '123 Oak Street', 'Los Angeles', 'CA', '90210',\n  'sale', 850000, 825000,\n  'approved', 'carol-auth-uuid', NOW() - INTERVAL '2 days', 'All documents in order. Approved.',\n  15, 8\n);\n\n-- Submission 2: Needs Changes\nINSERT INTO transaction_submissions (\n  id, organization_id, submitted_by,\n  local_transaction_id, property_address, property_city, property_state, property_zip,\n  transaction_type, listing_price,\n  status, reviewed_by, reviewed_at, review_notes,\n  message_count, attachment_count\n) VALUES (\n  gen_random_uuid(), 'org-demo-001', 'alice-auth-uuid',\n  'txn-local-002', '456 Maple Ave', 'Santa Monica', 'CA', '90401',\n  'purchase', 1200000,\n  'needs_changes', 'carol-auth-uuid', NOW() - INTERVAL '1 day', 'Missing inspection report. Please upload and resubmit.',\n  12, 5\n);\n\n-- Submission 3: Newly Submitted (for demo action)\nINSERT INTO transaction_submissions (\n  id, organization_id, submitted_by,\n  local_transaction_id, property_address, property_city, property_state, property_zip,\n  transaction_type, listing_price,\n  status,\n  message_count, attachment_count\n) VALUES (\n  gen_random_uuid(), 'org-demo-001', 'bob-auth-uuid',\n  'txn-local-003', '789 Pine Road', 'Beverly Hills', 'CA', '90212',\n  'sale', 2500000,\n  'submitted',\n  20, 12\n);\n\n-- Submission 4: Under Review\nINSERT INTO transaction_submissions (\n  id, organization_id, submitted_by,\n  local_transaction_id, property_address, property_city, property_state, property_zip,\n  transaction_type, listing_price, sale_price,\n  status, reviewed_by,\n  message_count, attachment_count\n) VALUES (\n  gen_random_uuid(), 'org-demo-001', 'alice-auth-uuid',\n  'txn-local-004', '321 Elm Court', 'Malibu', 'CA', '90265',\n  'sale', 4200000, 4100000,\n  'under_review', 'carol-auth-uuid',\n  25, 15\n);\n</code>\n\n<strong>Sample Messages (for one submission)</strong>\n\n<code>-- Get the first submission ID\nWITH sub AS (\n  SELECT id FROM transaction_submissions \n  WHERE local_transaction_id = 'txn-local-001' LIMIT 1\n)\nINSERT INTO submission_messages (submission_id, local_message_id, channel, direction, subject, body_text, sent_at)\nSELECT \n  sub.id,\n  'msg-' || n,\n  CASE WHEN n % 3 = 0 THEN 'email' WHEN n % 3 = 1 THEN 'sms' ELSE 'email' END,\n  CASE WHEN n % 2 = 0 THEN 'inbound' ELSE 'outbound' END,\n  CASE WHEN n % 3 != 1 THEN 'RE: 123 Oak Street Transaction' ELSE NULL END,\n  'Sample message content for demo ' || n,\n  NOW() - (n || ' days')::INTERVAL\nFROM sub, generate_series(1, 15) AS n;\n</code>\n\n---\n\n<strong>Files to Create/Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>supabase/seed/demo_seed.sql</code> | Demo data script |\n| <code>supabase/seed/README.md</code> | Instructions for running seed |\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-387: Schema must exist\n\u2022 BACKLOG-388: RLS policies must be in place (seed runs as admin)\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Demo organization created\n\u2610 Four demo users with correct roles\n\u2610 At least 4 submissions in different states\n\u2610 Sample messages attached to at least one submission\n\u2610 Seed can be run repeatedly (idempotent with ON CONFLICT)\n\u2610 README documents how to run seed data\n\n---\n\n<strong>Technical Notes</strong>\n\n<strong>Creating Auth Users</strong>\n\nDemo users must be created in Supabase Auth first. Options:\n1. **Supabase Dashboard**: Manually create users in Authentication > Users\n2. **CLI**: Use <code>supabase auth create-user</code> commands\n3. **Script**: Use Admin API with service key\n\nFor demo, recommend manual creation in Dashboard to ensure OAuth providers are linked.\n\n<strong>Idempotent Seed</strong>\n\nUse <code>ON CONFLICT DO NOTHING</code> or <code>INSERT ... ON CONFLICT DO UPDATE</code> to make seed rerunnable:\n\n<code>INSERT INTO organizations (id, name, slug, ...)\nVALUES (...)\nON CONFLICT (id) DO UPDATE SET\n  name = EXCLUDED.name,\n  updated_at = NOW();\n</code>\n\n<strong>Demo User Credentials</strong>\n\nFor OAuth demo:\n\u2022 Use real Google/Microsoft accounts or\n\u2022 Create test accounts in provider\n\u2022 Document login credentials securely\n\n---\n\n<strong>Demo Scenario Support</strong>\n\nThe seed data supports the full demo scenario:\n\n| Step | Data Required |\n|------|---------------|\n| 1. Agent completes audit | Local SQLite (not seeded here) |\n| 2. Agent submits | Creates new submission |\n| 3. Broker sees list | Existing submissions in various states |\n| 4. Broker reviews | Submission txn-local-003 (newly submitted) |\n| 5. Broker requests changes | Updates submission status |\n| 6. Agent sees notes | Status sync to desktop |\n| 7. Agent resubmits | Creates version 2 |\n| 8. Broker approves | Final approval |\n\n---\n\n<strong>Testing Plan</strong>\n\n1. Run seed script in development Supabase\n2. Login as each demo user\n3. Verify:\n   - Alice sees 3 submissions (her own)\n   - Bob sees 1 submission (his own)\n   - Carol sees all 4 submissions (broker)\n   - Dana sees all 4 submissions (admin)\n4. Verify messages and attachments accessible\n5. Test RLS enforcement for each role\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-387: Supabase Schema (dependency)\n\u2022 BACKLOG-388: RLS Policies (dependency)\n\u2022 SPRINT-050: B2B Broker Portal Demo"
  },
  {
    "id": "BACKLOG-390",
    "title": "Desktop - Local Schema Changes (submission_status)",
    "category": "schema",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-050",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-390.md](items/BACKLOG-390.md)",
    "description": "<strong>Summary</strong>\n\nTwo changes to desktop app infrastructure:\n1. Add submission tracking fields to local SQLite <code>transactions</code> table\n2. Migrate auth to use Supabase Auth (signInWithIdToken after direct OAuth)\n\n---\n\n<strong>Problem Statement</strong>\n\n<strong>Part 1: Submission Tracking</strong>\nThe desktop app needs to track:\n\u2022 Whether a transaction has been submitted for broker review\n\u2022 The cloud submission ID for syncing status updates\n\u2022 When the transaction was last submitted\n\u2022 Broker review notes received from the cloud\n\nCurrently, transactions have no awareness of the broker review workflow.\n\n<strong>Part 2: Auth Migration</strong>\nThe desktop app currently uses:\n\u2022 Direct Google/Microsoft OAuth (handles flow itself)\n\u2022 Service key to access Supabase (bypasses all RLS)\n\nFor B2B, we need:\n\u2022 Supabase Auth session so RLS policies work\n\u2022 <code>auth.uid()</code> returns the user's ID in database queries\n\u2022 Same OAuth flow, but tell Supabase about the token after\n\n---\n\n<strong>Proposed Solution</strong>\n\nAdd four new columns to the local <code>transactions</code> table:\n\n<code>ALTER TABLE transactions ADD COLUMN submission_status TEXT DEFAULT 'not_submitted';\n-- Values: not_submitted, submitted, under_review, needs_changes, resubmitted, approved, rejected\n\nALTER TABLE transactions ADD COLUMN submission_id TEXT;\n-- UUID reference to transaction_submissions in Supabase\n\nALTER TABLE transactions ADD COLUMN submitted_at TEXT;\n-- ISO timestamp of last submission\n\nALTER TABLE transactions ADD COLUMN last_review_notes TEXT;\n-- Most recent broker feedback (synced from cloud)\n</code>\n\n<strong>Migration File</strong>\n\nCreate <code>electron/migrations/XXXX_add_submission_tracking.sql</code>:\n\n<code>-- Migration: Add submission tracking fields\n-- Purpose: Track broker review workflow for B2B portal\n-- Date: 2026-01-XX\n-- Sprint: SPRINT-050\n\n-- Check if columns exist before adding (SQLite doesn't support IF NOT EXISTS for columns)\n-- This will be handled in the migration runner with try/catch\n\nALTER TABLE transactions ADD COLUMN submission_status TEXT DEFAULT 'not_submitted';\nALTER TABLE transactions ADD COLUMN submission_id TEXT;\nALTER TABLE transactions ADD COLUMN submitted_at TEXT;\nALTER TABLE transactions ADD COLUMN last_review_notes TEXT;\n\n-- Create index for filtering by submission status\nCREATE INDEX IF NOT EXISTS idx_transactions_submission_status \nON transactions(submission_status);\n</code>\n\n<strong>TypeScript Types</strong>\n\nUpdate transaction types in <code>src/types/</code>:\n\n<code>// Add to Transaction interface\nexport interface Transaction {\n  // ... existing fields ...\n  \n  // Submission tracking (B2B)\n  submission_status: SubmissionStatus;\n  submission_id: string | null;\n  submitted_at: string | null;\n  last_review_notes: string | null;\n}\n\nexport type SubmissionStatus = \n  | 'not_submitted'\n  | 'submitted'\n  | 'under_review'\n  | 'needs_changes'\n  | 'resubmitted'\n  | 'approved'\n  | 'rejected';\n</code>\n\n<strong>Part 2: Auth Migration</strong>\n\nUpdate the auth flow to create a Supabase session after direct OAuth:\n\n<code>// In electron/services/supabaseService.ts or auth service\n\n// Current: Direct OAuth with Google/Microsoft\nconst tokens = await googleOAuth.getTokens(); // or microsoftOAuth\n\n// NEW: Tell Supabase about this user (creates session + JWT)\nconst { data, error } = await supabase.auth.signInWithIdToken({\n  provider: 'google', // or 'azure' for Microsoft\n  token: tokens.id_token,\n});\n\nif (error) {\n  console.error('Supabase auth failed:', error);\n  // Fall back to service key for now, but log warning\n}\n\n// Now supabase queries include JWT, RLS works\n// auth.uid() returns user's ID\n</code>\n\n**Key Points:**\n\u2022 Keep existing OAuth flow unchanged (user experience same)\n\u2022 Add one call after OAuth completes\n\u2022 Supabase validates the ID token cryptographically (secure)\n\u2022 Creates user in <code>auth.users</code> if first login\n\u2022 Triggers <code>on_auth_user_created</code> \u2192 creates profile\n\u2022 RLS policies now work with <code>auth.uid()</code>\n\n**For Microsoft OAuth:**\n<code>const { data, error } = await supabase.auth.signInWithIdToken({\n  provider: 'azure',\n  token: microsoftTokens.id_token,\n});\n</code>\n\n---\n\n<strong>Files to Create/Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>electron/migrations/XXXX_add_submission_tracking.sql</code> | New migration file |\n| <code>electron/services/databaseService.ts</code> | Add migration to runner, update queries |\n| <code>electron/services/supabaseService.ts</code> | Add signInWithIdToken after OAuth |\n| <code>electron/services/authService.ts</code> | Update to call Supabase after OAuth |\n| <code>src/types/transaction.ts</code> or similar | Add new fields to type |\n| <code>electron/utils/databaseSchema.ts</code> | Update schema version |\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-387: Cloud schema should be defined first (for alignment)\n\u2022 BACKLOG-388: No direct dependency, but good to have RLS ready\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n<strong>Schema Changes</strong>\n\u2610 Migration creates all 4 new columns\n\u2610 Migration is idempotent (can run multiple times safely)\n\u2610 TypeScript types updated with new fields\n\u2610 Existing transactions get default <code>not_submitted</code> status\n\u2610 Index created for status queries\n\u2610 Database queries include new fields in SELECT/INSERT/UPDATE\n\u2610 App starts successfully after migration\n\n<strong>Auth Migration</strong>\n\u2610 After Google OAuth, <code>signInWithIdToken</code> is called\n\u2610 After Microsoft OAuth, <code>signInWithIdToken</code> is called (provider: 'azure')\n\u2610 User is created in Supabase <code>auth.users</code> on first login\n\u2610 Profile is auto-created via trigger\n\u2610 Supabase client has valid session after login\n\u2610 Graceful fallback if Supabase auth fails (log warning, continue with service key)\n\u2610 Existing login UX unchanged (same popups, same flow)\n\n---\n\n<strong>Technical Notes</strong>\n\n<strong>SQLite Migration Handling</strong>\n\nSQLite doesn't support <code>IF NOT EXISTS</code> for <code>ALTER TABLE ADD COLUMN</code>. The migration runner should:\n1. Check if column exists before adding\n2. Or wrap in try/catch and ignore \"duplicate column\" errors\n\n<code>// In migration runner\ntry {\n  db.exec('ALTER TABLE transactions ADD COLUMN submission_status TEXT DEFAULT \"not_submitted\"');\n} catch (e) {\n  if (!e.message.includes('duplicate column')) throw e;\n}\n</code>\n\n<strong>Backward Compatibility</strong>\n\n\u2022 New columns have defaults, so existing data works\n\u2022 UI should handle null/undefined for new fields gracefully\n\u2022 Don't break exports that serialize transactions\n\n<strong>Status Sync Pattern</strong>\n\nStatus updates come from cloud to local:\n1. Desktop polls <code>transaction_submissions</code> for status changes\n2. Matches by <code>submission_id</code> \n3. Updates local <code>submission_status</code> and <code>last_review_notes</code>\n\n---\n\n<strong>Testing Plan</strong>\n\n<strong>Schema Changes</strong>\n1. Run migration on fresh database\n2. Run migration on database with existing transactions\n3. Verify default values applied\n4. Query transactions and verify new fields present\n5. Update a transaction's submission_status\n6. Restart app and verify data persisted\n\n<strong>Auth Migration</strong>\n1. Login with Google - verify user created in Supabase auth.users\n2. Login with Microsoft - verify user created in Supabase auth.users\n3. Check Supabase dashboard: profile auto-created with 14-day trial\n4. Verify <code>supabase.auth.getUser()</code> returns valid user after login\n5. Test logout and re-login\n6. Test with network offline - should fall back gracefully\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-387: Supabase Schema (cloud equivalent)\n\u2022 BACKLOG-391: Submit for Review UI (uses these fields)\n\u2022 BACKLOG-395: Status Sync (reads/writes these fields)\n\u2022 SPRINT-050: B2B Broker Portal Demo"
  },
  {
    "id": "BACKLOG-391",
    "title": "Desktop - Submit for Review UI (detail page)",
    "category": "ui",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-050",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-391.md](items/BACKLOG-391.md)",
    "description": "<strong>Summary</strong>\n\nAdd a \"Submit for Review\" button and workflow to the transaction detail page, allowing agents to submit individual transactions to the broker portal for compliance review.\n\n---\n\n<strong>Problem Statement</strong>\n\nCurrently, transaction data stays entirely local on the agent's machine. For B2B broker compliance, agents need to:\n1. Submit completed audits to their broker for review\n2. See the current submission status\n3. View broker feedback when changes are requested\n4. Resubmit after making corrections\n\n---\n\n<strong>Proposed Solution</strong>\n\n<strong>UI Changes</strong>\n\n#### Transaction Detail Header\n\nAdd submission status badge and action button to the transaction detail header:\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  123 Oak Street, Los Angeles, CA                                    \u2502\n\u2502  Transaction: Sale | Status: Closed                                 \u2502\n\u2502                                                                     \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 Submission:      \u2502   \u2502 [Submit for Review]     [Edit] [Export] \u2502\n\u2502  \u2502 Not Submitted    \u2502   \u2502 (or [View Submission] if submitted)    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n#### Status Badge Colors\n\n| Status | Color | Icon |\n|--------|-------|------|\n| <code>not_submitted</code> | Gray | - |\n| <code>submitted</code> | Blue | Clock |\n| <code>under_review</code> | Yellow | Eye |\n| <code>needs_changes</code> | Orange | Warning |\n| <code>resubmitted</code> | Blue | Refresh |\n| <code>approved</code> | Green | Check |\n| <code>rejected</code> | Red | X |\n\n#### Submit Modal\n\nWhen clicking \"Submit for Review\":\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    Submit Transaction for Review                     \u2502\n\u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\n\u2502                                                                      \u2502\n\u2502  Property: 123 Oak Street, Los Angeles, CA                          \u2502\n\u2502                                                                      \u2502\n\u2502  This submission will include:                                       \u2502\n\u2502  \u2022 15 email messages                                                 \u2502\n\u2502  \u2022 8 text messages                                                   \u2502\n\u2502  \u2022 12 attachments (34.2 MB)                                         \u2502\n\u2502                                                                      \u2502\n\u2502  \u26a0\ufe0f  Your broker will be able to view all communications            \u2502\n\u2502     and documents attached to this transaction.                      \u2502\n\u2502                                                                      \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u2502\n\u2502  \u2502 \u25a1 Export a local copy before submitting                    \u2502      \u2502\n\u2502  \u2502   \u25a1 Remember my choice                                     \u2502      \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2502\n\u2502                                                                      \u2502\n\u2502  [Cancel]                                      [Submit for Review]   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n#### Review Notes Display\n\nWhen status is <code>needs_changes</code>, show broker feedback prominently:\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  \u26a0\ufe0f  Changes Requested by Broker                                    \u2502\n\u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\n\u2502  \"Missing inspection report. Please upload and resubmit.\"           \u2502\n\u2502                                                                      \u2502\n\u2502  Reviewed by: Carol (Broker) on Jan 21, 2026                        \u2502\n\u2502                                                                      \u2502\n\u2502  [Resubmit for Review]                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n<strong>Validation Before Submit</strong>\n\nCheck before allowing submission:\n1. Transaction has at least one contact assigned\n2. Transaction has a property address\n3. Transaction has start date set\n4. At least one message or attachment attached\n\n<strong>Submit Flow</strong>\n\n1. User clicks \"Submit for Review\"\n2. Show confirmation modal with summary\n3. If \"export local copy\" checked, trigger export first\n4. Call submission service (BACKLOG-394)\n5. Show progress indicator\n6. Update local <code>submission_status</code> to <code>submitted</code>\n7. Show success message\n\n---\n\n<strong>Files to Create/Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>src/components/transactionDetailsModule/TransactionDetailsTab.tsx</code> | Add status badge, submit button |\n| <code>src/components/transactionDetailsModule/components/SubmitForReviewModal.tsx</code> | New modal component |\n| <code>src/components/transactionDetailsModule/components/ReviewNotesPanel.tsx</code> | New component for broker feedback |\n| <code>src/components/transactionDetailsModule/components/SubmissionStatusBadge.tsx</code> | New badge component |\n| <code>src/hooks/useSubmitForReview.ts</code> | New hook for submission logic |\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-390: Local schema changes (submission_status fields)\n\u2022 BACKLOG-393: Attachment upload service (uploads files first)\n\u2022 BACKLOG-394: Transaction push service (actually submits)\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 \"Submit for Review\" button visible on transaction detail\n\u2610 Button disabled with tooltip if validation fails\n\u2610 Confirmation modal shows accurate counts\n\u2610 Export option works before submission\n\u2610 \"Remember my choice\" persists preference\n\u2610 Progress indicator during upload\n\u2610 Status badge updates after submission\n\u2610 Review notes display when status is <code>needs_changes</code>\n\u2610 \"Resubmit\" option available after changes requested\n\u2610 Status colors match design spec\n\n---\n\n<strong>Technical Notes</strong>\n\n<strong>Organization Context</strong>\n\nThe submission needs the user's organization ID. This should come from:\n1. User's organization membership (stored after login)\n2. Or: Fetch from Supabase on first submission\n\nFor demo, can store org_id in user preferences after first successful auth.\n\n<strong>Error Handling</strong>\n\n| Error | User Message | Action |\n|-------|--------------|--------|\n| Network offline | \"No internet connection\" | Retry button |\n| Upload failed | \"Upload failed. Retry?\" | Retry/Cancel |\n| Auth expired | \"Session expired\" | Re-authenticate |\n| Already submitted | \"Transaction already under review\" | Show status |\n\n<strong>State Management</strong>\n\nUse local React state for modal, but persist submission status to database immediately after successful submit.\n\n---\n\n<strong>UI Mockups</strong>\n\n<strong>Status Badge States</strong>\n\n<code>[ Not Submitted ]    - gray background\n[ Submitted ]        - blue background, clock icon\n[ Under Review ]     - yellow background, eye icon  \n[ Changes Requested ] - orange background, warning icon\n[ Approved \u2713 ]       - green background, check icon\n[ Rejected \u2717 ]       - red background, x icon\n</code>\n\n<strong>Button State Logic</strong>\n\n<code>const getButtonConfig = (status: SubmissionStatus) => {\n  switch (status) {\n    case 'not_submitted':\n      return { text: 'Submit for Review', disabled: false };\n    case 'submitted':\n    case 'under_review':\n      return { text: 'View Submission', disabled: false };\n    case 'needs_changes':\n      return { text: 'Resubmit for Review', disabled: false };\n    case 'approved':\n    case 'rejected':\n      return { text: 'View Submission', disabled: false };\n    case 'resubmitted':\n      return { text: 'View Submission', disabled: false };\n  }\n};\n</code>\n\n---\n\n<strong>Testing Plan</strong>\n\n1. Test button visibility on transaction detail\n2. Test validation prevents submit when missing required data\n3. Test confirmation modal content accuracy\n4. Test export before submit option\n5. Test progress indicator during upload\n6. Test status updates after success\n7. Test error handling for network failures\n8. Test review notes display\n9. Test resubmit flow\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-390: Local Schema Changes (dependency)\n\u2022 BACKLOG-392: Bulk Submit UI (similar pattern)\n\u2022 BACKLOG-393: Attachment Upload Service (dependency)\n\u2022 BACKLOG-394: Transaction Push Service (dependency)\n\u2022 BACKLOG-395: Status Sync (updates status)\n\u2022 SPRINT-050: B2B Broker Portal Demo"
  },
  {
    "id": "BACKLOG-392",
    "title": "Desktop - Bulk Submit UI (list page)",
    "category": "ui",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-050",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-392.md](items/BACKLOG-392.md)",
    "description": "<strong>Summary</strong>\n\nAdd bulk submission capability to the transaction list page, allowing agents to submit multiple transactions for broker review at once.\n\n---\n\n<strong>Problem Statement</strong>\n\nAgents may have multiple completed audits ready for broker review. Submitting them one by one is tedious. A bulk submission feature lets agents:\n1. Select multiple transactions from the list\n2. Submit all selected in one action\n3. See submission status for each in the list\n\n---\n\n<strong>Proposed Solution</strong>\n\n<strong>Transaction List Enhancements</strong>\n\n#### Status Column\n\nAdd a \"Submission\" column to the transaction list:\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 \u25a1 | Address              | Type | Status | Submission      | Messages | \u25bc \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 \u25a1 | 123 Oak Street       | Sale | Closed | \u2713 Approved      | 15       |   \u2502\n\u2502 \u25a0 | 456 Maple Ave        | Buy  | Active | \u26a0 Changes Req   | 12       |   \u2502\n\u2502 \u25a0 | 789 Pine Road        | Sale | Closed | \u2014 Not Submitted | 20       |   \u2502\n\u2502 \u25a1 | 321 Elm Court        | Sale | Closed | \u25cf Under Review  | 25       |   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nSelected: 2 transactions                    [Submit Selected for Review]\n</code>\n\n#### Bulk Action Bar\n\nWhen transactions are selected, show a bulk action bar:\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 2 transactions selected                                                     \u2502\n\u2502                                                                             \u2502\n\u2502 [Submit for Review]  [Export]  [Delete]  [Clear Selection]                 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n#### Selection Rules\n\nOnly allow selecting transactions that are:\n\u2022 <code>not_submitted</code> - Can submit\n\u2022 <code>needs_changes</code> - Can resubmit\n\u2022 <code>rejected</code> - Can resubmit (after fixes)\n\nDisable selection (or show warning) for:\n\u2022 <code>submitted</code> - Already pending\n\u2022 <code>under_review</code> - Being reviewed\n\u2022 <code>approved</code> - Already complete\n\n<strong>Bulk Submit Modal</strong>\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    Submit 3 Transactions for Review                  \u2502\n\u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\n\u2502                                                                      \u2502\n\u2502  The following transactions will be submitted:                       \u2502\n\u2502                                                                      \u2502\n\u2502  1. 456 Maple Ave, Santa Monica         (Resubmission)              \u2502\n\u2502     \u2022 12 messages, 5 attachments                                     \u2502\n\u2502                                                                      \u2502\n\u2502  2. 789 Pine Road, Beverly Hills        (New)                       \u2502\n\u2502     \u2022 20 messages, 12 attachments                                    \u2502\n\u2502                                                                      \u2502\n\u2502  3. 555 Cedar Lane, Pasadena            (New)                       \u2502\n\u2502     \u2022 8 messages, 3 attachments                                      \u2502\n\u2502                                                                      \u2502\n\u2502  Total: 40 messages, 20 attachments (52.4 MB)                       \u2502\n\u2502                                                                      \u2502\n\u2502  \u25a1 Export local copies before submitting                            \u2502\n\u2502    \u25a1 Remember my choice                                             \u2502\n\u2502                                                                      \u2502\n\u2502  [Cancel]                                      [Submit All]          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n<strong>Progress Modal</strong>\n\nShow progress for each transaction:\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    Submitting Transactions...                        \u2502\n\u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\n\u2502                                                                      \u2502\n\u2502  456 Maple Ave        [\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588] \u2713 Complete             \u2502\n\u2502  789 Pine Road        [\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591] 50% - Uploading...     \u2502\n\u2502  555 Cedar Lane       [\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591] Waiting...             \u2502\n\u2502                                                                      \u2502\n\u2502  Overall: 1 of 3 complete                                           \u2502\n\u2502                                                                      \u2502\n\u2502  [Cancel Remaining]                                                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n<strong>Results Summary</strong>\n\nAfter completion:\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    Submission Complete                               \u2502\n\u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\n\u2502                                                                      \u2502\n\u2502  \u2713 456 Maple Ave        - Submitted successfully                    \u2502\n\u2502  \u2713 789 Pine Road        - Submitted successfully                    \u2502\n\u2502  \u2717 555 Cedar Lane       - Failed (network error)                    \u2502\n\u2502                                                                      \u2502\n\u2502  2 of 3 transactions submitted.                                     \u2502\n\u2502                                                                      \u2502\n\u2502  [Retry Failed]                                         [Close]      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n---\n\n<strong>Files to Create/Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>src/components/Transactions.tsx</code> | Add selection, status column |\n| <code>src/components/BulkActionBar.tsx</code> | Extend with submission action |\n| <code>src/components/BulkSubmitModal.tsx</code> | New modal component |\n| <code>src/components/SubmissionProgressModal.tsx</code> | New progress component |\n| <code>src/hooks/useBulkSubmit.ts</code> | New hook for batch operations |\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-390: Local schema changes (status fields)\n\u2022 BACKLOG-391: Single submit UI (shares components)\n\u2022 BACKLOG-393: Attachment upload service\n\u2022 BACKLOG-394: Transaction push service\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Submission status column visible in transaction list\n\u2610 Checkbox selection available for eligible transactions\n\u2610 Bulk action bar appears when transactions selected\n\u2610 Cannot select already-submitted transactions (or shows warning)\n\u2610 Confirmation modal shows all selected transactions\n\u2610 Progress modal shows individual progress\n\u2610 Failed submissions can be retried\n\u2610 Status updates in list after completion\n\u2610 Cancel stops remaining submissions\n\n---\n\n<strong>Technical Notes</strong>\n\n<strong>Sequential vs Parallel</strong>\n\nFor reliability, submit transactions **sequentially** (not parallel):\n\u2022 Easier progress tracking\n\u2022 Simpler error handling\n\u2022 Less likely to hit rate limits\n\u2022 User can cancel cleanly between items\n\n<strong>Error Recovery</strong>\n\nIf one submission fails:\n1. Continue with remaining\n2. Track failures separately\n3. Allow retry of just the failed ones\n4. Don't rollback successful submissions\n\n<strong>List Performance</strong>\n\nWith status column added:\n\u2022 Use existing virtualization (if any)\n\u2022 Status badge is lightweight component\n\u2022 Don't fetch full submission details for list\n\n---\n\n<strong>Testing Plan</strong>\n\n1. Test selection behavior for different statuses\n2. Test bulk action bar visibility\n3. Test confirmation modal content\n4. Test progress tracking accuracy\n5. Test partial failure handling\n6. Test retry functionality\n7. Test cancel during submission\n8. Test list updates after completion\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-390: Local Schema Changes (dependency)\n\u2022 BACKLOG-391: Submit UI Detail Page (shares patterns)\n\u2022 BACKLOG-393: Attachment Upload Service (dependency)\n\u2022 BACKLOG-394: Transaction Push Service (dependency)\n\u2022 SPRINT-050: B2B Broker Portal Demo"
  },
  {
    "id": "BACKLOG-393",
    "title": "Desktop - Attachment Upload Service",
    "category": "service",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-050",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-393.md](items/BACKLOG-393.md)",
    "description": "<strong>Summary</strong>\n\nCreate a service to upload transaction attachments from the local filesystem to Supabase Storage, with progress tracking, retry logic, and proper path organization.\n\n---\n\n<strong>Problem Statement</strong>\n\nWhen submitting transactions for broker review, all attachments must be uploaded to Supabase Storage so the broker can view them in the web portal. This requires:\n1. Reading local files from disk\n2. Uploading to Supabase Storage\n3. Organizing files by org/submission/filename\n4. Handling large files and network issues\n5. Tracking upload progress for UI\n\n---\n\n<strong>Proposed Solution</strong>\n\n<strong>Service Architecture</strong>\n\nCreate <code>electron/services/supabaseStorageService.ts</code>:\n\n<code>interface UploadProgress {\n  filename: string;\n  bytesUploaded: number;\n  totalBytes: number;\n  percentage: number;\n  status: 'pending' | 'uploading' | 'complete' | 'failed';\n  error?: string;\n}\n\ninterface AttachmentUploadResult {\n  localId: string;\n  storagePath: string;\n  publicUrl?: string;\n  success: boolean;\n  error?: string;\n}\n\nclass SupabaseStorageService {\n  /**\n   * Upload a single attachment to Supabase Storage\n   */\n  async uploadAttachment(\n    orgId: string,\n    submissionId: string,\n    localPath: string,\n    filename: string,\n    onProgress?: (progress: UploadProgress) => void\n  ): Promise<AttachmentUploadResult>;\n\n  /**\n   * Upload multiple attachments for a submission\n   */\n  async uploadAttachments(\n    orgId: string,\n    submissionId: string,\n    attachments: LocalAttachment[],\n    onProgress?: (overall: number, current: UploadProgress) => void\n  ): Promise<AttachmentUploadResult[]>;\n\n  /**\n   * Get signed URL for viewing (broker portal use)\n   */\n  async getSignedUrl(storagePath: string, expiresIn?: number): Promise<string>;\n\n  /**\n   * Delete attachment from storage (cleanup on failure)\n   */\n  async deleteAttachment(storagePath: string): Promise<void>;\n}\n</code>\n\n<strong>Storage Path Convention</strong>\n\n<code>submission-attachments/\n  {org_id}/\n    {submission_id}/\n      {original_filename}\n</code>\n\nExample:\n<code>submission-attachments/\n  org-demo-001/\n    sub-abc-123/\n      inspection_report.pdf\n      property_photo_1.jpg\n      contract_signed.pdf\n</code>\n\n<strong>File Reading</strong>\n\nRead files from local paths stored in the attachments table:\n\n<code>async function readLocalFile(localPath: string): Promise<Buffer> {\n  // Handle different attachment sources:\n  // 1. Email attachments (stored path)\n  // 2. iMessage attachments (~/Library/Messages/...)\n  // 3. Manually added files\n  \n  const absolutePath = resolveAttachmentPath(localPath);\n  return fs.promises.readFile(absolutePath);\n}\n</code>\n\n<strong>Upload Implementation</strong>\n\n<code>async uploadAttachment(\n  orgId: string,\n  submissionId: string,\n  localPath: string,\n  filename: string,\n  onProgress?: (progress: UploadProgress) => void\n): Promise<AttachmentUploadResult> {\n  const storagePath = <code>${orgId}/${submissionId}/${sanitizeFilename(filename)}</code>;\n  \n  try {\n    // Read local file\n    const fileBuffer = await readLocalFile(localPath);\n    const mimeType = getMimeType(filename);\n    \n    // Report starting\n    onProgress?.({\n      filename,\n      bytesUploaded: 0,\n      totalBytes: fileBuffer.length,\n      percentage: 0,\n      status: 'uploading'\n    });\n    \n    // Upload to Supabase\n    // Note: Supabase JS client doesn't support progress for small files\n    // For large files, consider chunked upload (post-demo)\n    const { data, error } = await supabase.storage\n      .from('submission-attachments')\n      .upload(storagePath, fileBuffer, {\n        contentType: mimeType,\n        upsert: false // Don't overwrite\n      });\n    \n    if (error) throw error;\n    \n    // Report complete\n    onProgress?.({\n      filename,\n      bytesUploaded: fileBuffer.length,\n      totalBytes: fileBuffer.length,\n      percentage: 100,\n      status: 'complete'\n    });\n    \n    return {\n      localId: localPath,\n      storagePath: data.path,\n      success: true\n    };\n    \n  } catch (error) {\n    onProgress?.({\n      filename,\n      bytesUploaded: 0,\n      totalBytes: 0,\n      percentage: 0,\n      status: 'failed',\n      error: error.message\n    });\n    \n    return {\n      localId: localPath,\n      storagePath: '',\n      success: false,\n      error: error.message\n    };\n  }\n}\n</code>\n\n<strong>Retry Logic</strong>\n\n<code>async uploadWithRetry(\n  ...args: Parameters<typeof uploadAttachment>,\n  maxRetries = 3\n): Promise<AttachmentUploadResult> {\n  let lastError: Error;\n  \n  for (let attempt = 1; attempt <= maxRetries; attempt++) {\n    try {\n      return await this.uploadAttachment(...args);\n    } catch (error) {\n      lastError = error;\n      if (attempt < maxRetries) {\n        // Exponential backoff: 1s, 2s, 4s\n        await sleep(1000 * Math.pow(2, attempt - 1));\n      }\n    }\n  }\n  \n  throw lastError;\n}\n</code>\n\n---\n\n<strong>Files to Create/Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>electron/services/supabaseStorageService.ts</code> | New service file |\n| <code>electron/services/supabaseService.ts</code> | Export storage client |\n| <code>electron/preload/preload.ts</code> | Expose upload IPC |\n| <code>src/services/attachmentUploadService.ts</code> | Renderer-side wrapper |\n| <code>electron/utils/fileUtils.ts</code> | Path resolution helpers |\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-388: Storage bucket must exist with proper policies\n\u2022 BACKLOG-390: Local schema (to read attachment records)\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Can upload single attachment to Supabase Storage\n\u2610 Can upload multiple attachments with progress\n\u2610 Proper path organization (org/submission/file)\n\u2610 Handles missing local files gracefully\n\u2610 Retry logic for transient failures\n\u2610 Progress callbacks work correctly\n\u2610 Cleanup on partial failure\n\u2610 MIME types set correctly\n\u2610 Filename sanitization (no special chars)\n\n---\n\n<strong>Technical Notes</strong>\n\n<strong>Auth Context</strong>\n\nFor demo, use service key for uploads (bypasses RLS):\n\n<code>const supabaseAdmin = createClient(\n  process.env.SUPABASE_URL,\n  process.env.SUPABASE_SERVICE_KEY  // Service key, not anon key\n);\n</code>\n\n**Production Migration:** Must authenticate user and use their JWT.\n\n<strong>File Size Limits</strong>\n\nSupabase Storage default limits:\n\u2022 Max file size: 50MB (configured in bucket)\n\u2022 Max request size: 6MB (needs chunked upload for larger)\n\nFor demo, 50MB per file is acceptable. Chunked uploads are post-demo.\n\n<strong>MIME Type Detection</strong>\n\n<code>import mime from 'mime-types';\n\nfunction getMimeType(filename: string): string {\n  return mime.lookup(filename) || 'application/octet-stream';\n}\n</code>\n\n<strong>Filename Sanitization</strong>\n\n<code>function sanitizeFilename(filename: string): string {\n  return filename\n    .replace(/[^a-zA-Z0-9._-]/g, '_')  // Replace special chars\n    .replace(/__+/g, '_')               // Collapse multiple underscores\n    .substring(0, 255);                 // Limit length\n}\n</code>\n\n<strong>Deduplication</strong>\n\nIf same file is submitted multiple times, use <code>upsert: false</code> to error on duplicate. Alternatively, add timestamp or UUID to path.\n\n---\n\n<strong>Testing Plan</strong>\n\n1. Upload single small file (~100KB)\n2. Upload single large file (~10MB)\n3. Upload multiple files in batch\n4. Test progress callback accuracy\n5. Test retry on network failure\n6. Test missing local file handling\n7. Test filename sanitization\n8. Test MIME type detection\n9. Verify files accessible via signed URL\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-388: RLS Policies + Storage (dependency)\n\u2022 BACKLOG-394: Transaction Push Service (uses this)\n\u2022 BACKLOG-401: Attachment Viewer (consumes uploaded files)\n\u2022 SPRINT-050: B2B Broker Portal Demo"
  },
  {
    "id": "BACKLOG-394",
    "title": "Desktop - Transaction Push Service",
    "category": "service",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-050",
    "est_tokens": "~35K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-394.md](items/BACKLOG-394.md)",
    "description": "<strong>Summary</strong>\n\nCreate a service to push complete transaction data (transaction details, messages, and attachment metadata) from local SQLite to Supabase cloud for broker review.\n\n---\n\n<strong>Problem Statement</strong>\n\nWhen an agent submits a transaction for review, we need to:\n1. Collect all transaction data from local SQLite\n2. Collect all linked messages\n3. Upload attachments first (BACKLOG-393)\n4. Push transaction record to <code>transaction_submissions</code>\n5. Push messages to <code>submission_messages</code>\n6. Push attachment metadata to <code>submission_attachments</code>\n7. Update local submission status\n8. Handle resubmissions (version tracking)\n\n---\n\n<strong>Proposed Solution</strong>\n\n<strong>Service Architecture</strong>\n\nCreate <code>electron/services/submissionService.ts</code>:\n\n<code>interface SubmissionResult {\n  success: boolean;\n  submissionId: string | null;\n  error?: string;\n  attachmentsFailed: number;\n  messagesCount: number;\n  attachmentsCount: number;\n}\n\ninterface SubmissionProgress {\n  stage: 'preparing' | 'attachments' | 'transaction' | 'messages' | 'complete' | 'failed';\n  stageProgress: number;  // 0-100 within current stage\n  overallProgress: number; // 0-100 total\n  currentItem?: string;\n}\n\nclass SubmissionService {\n  /**\n   * Submit a transaction for broker review\n   */\n  async submitTransaction(\n    transactionId: string,\n    onProgress?: (progress: SubmissionProgress) => void\n  ): Promise<SubmissionResult>;\n\n  /**\n   * Resubmit a transaction (creates new version)\n   */\n  async resubmitTransaction(\n    transactionId: string,\n    onProgress?: (progress: SubmissionProgress) => void\n  ): Promise<SubmissionResult>;\n\n  /**\n   * Get submission status from cloud\n   */\n  async getSubmissionStatus(submissionId: string): Promise<SubmissionStatus>;\n}\n</code>\n\n<strong>Submission Flow</strong>\n\n<code>async submitTransaction(\n  transactionId: string,\n  onProgress?: (progress: SubmissionProgress) => void\n): Promise<SubmissionResult> {\n  \n  // 1. Prepare: Load local data\n  onProgress?.({ stage: 'preparing', stageProgress: 0, overallProgress: 0 });\n  \n  const transaction = await this.loadTransaction(transactionId);\n  const messages = await this.loadTransactionMessages(transactionId);\n  const attachments = await this.loadTransactionAttachments(transactionId);\n  const orgId = await this.getUserOrganizationId();\n  \n  if (!orgId) {\n    throw new Error('User is not a member of any organization');\n  }\n  \n  // 2. Generate submission ID\n  const submissionId = crypto.randomUUID();\n  \n  // 3. Upload attachments (30% of progress)\n  onProgress?.({ stage: 'attachments', stageProgress: 0, overallProgress: 10 });\n  \n  const attachmentResults = await this.uploadAttachments(\n    orgId, submissionId, attachments,\n    (pct) => onProgress?.({ \n      stage: 'attachments', \n      stageProgress: pct, \n      overallProgress: 10 + (pct * 0.3) \n    })\n  );\n  \n  // 4. Push transaction to Supabase (20% of progress)\n  onProgress?.({ stage: 'transaction', stageProgress: 0, overallProgress: 40 });\n  \n  const submissionRecord = this.mapToSubmission(transaction, orgId, submissionId);\n  await this.insertSubmission(submissionRecord);\n  \n  onProgress?.({ stage: 'transaction', stageProgress: 100, overallProgress: 60 });\n  \n  // 5. Push messages (30% of progress)\n  onProgress?.({ stage: 'messages', stageProgress: 0, overallProgress: 60 });\n  \n  const messageRecords = messages.map(m => this.mapToSubmissionMessage(m, submissionId));\n  await this.insertMessages(messageRecords, (pct) => \n    onProgress?.({ stage: 'messages', stageProgress: pct, overallProgress: 60 + (pct * 0.3) })\n  );\n  \n  // 6. Push attachment metadata (10% of progress)\n  const attachmentRecords = attachmentResults\n    .filter(r => r.success)\n    .map(r => this.mapToSubmissionAttachment(r, submissionId));\n  await this.insertAttachmentRecords(attachmentRecords);\n  \n  // 7. Update local status\n  await this.updateLocalSubmissionStatus(transactionId, {\n    submission_status: 'submitted',\n    submission_id: submissionId,\n    submitted_at: new Date().toISOString()\n  });\n  \n  onProgress?.({ stage: 'complete', stageProgress: 100, overallProgress: 100 });\n  \n  return {\n    success: true,\n    submissionId,\n    messagesCount: messages.length,\n    attachmentsCount: attachmentResults.filter(r => r.success).length,\n    attachmentsFailed: attachmentResults.filter(r => !r.success).length\n  };\n}\n</code>\n\n<strong>Data Mapping</strong>\n\n<code>mapToSubmission(transaction: LocalTransaction, orgId: string, submissionId: string): SubmissionRecord {\n  return {\n    id: submissionId,\n    organization_id: orgId,\n    submitted_by: this.getCurrentUserId(),\n    local_transaction_id: transaction.id,\n    property_address: transaction.property_address,\n    property_city: transaction.property_city,\n    property_state: transaction.property_state,\n    property_zip: transaction.property_zip,\n    transaction_type: transaction.transaction_type,\n    listing_price: transaction.listing_price,\n    sale_price: transaction.sale_price,\n    started_at: transaction.started_at,\n    closed_at: transaction.closed_at,\n    status: 'submitted',\n    message_count: 0,  // Updated after messages inserted\n    attachment_count: 0,  // Updated after attachments inserted\n    submission_metadata: {\n      desktop_version: app.getVersion(),\n      submitted_from_device: this.getDeviceId()\n    }\n  };\n}\n\nmapToSubmissionMessage(message: LocalMessage, submissionId: string): SubmissionMessageRecord {\n  return {\n    submission_id: submissionId,\n    local_message_id: message.id,\n    channel: message.channel,  // 'email', 'sms', 'imessage'\n    direction: message.direction,\n    subject: message.subject,\n    body_text: message.body_text,\n    participants: {\n      from: message.from_address,\n      to: message.to_addresses,\n      cc: message.cc_addresses,\n      bcc: message.bcc_addresses\n    },\n    sent_at: message.sent_at,\n    thread_id: message.thread_id,\n    has_attachments: message.attachment_count > 0,\n    attachment_count: message.attachment_count\n  };\n}\n</code>\n\n<strong>Resubmission Logic</strong>\n\n<code>async resubmitTransaction(transactionId: string, ...): Promise<SubmissionResult> {\n  const transaction = await this.loadTransaction(transactionId);\n  \n  if (!transaction.submission_id) {\n    throw new Error('Transaction has not been submitted before');\n  }\n  \n  // Get current version\n  const { data: existingSubmission } = await supabase\n    .from('transaction_submissions')\n    .select('version')\n    .eq('id', transaction.submission_id)\n    .single();\n  \n  const newVersion = (existingSubmission?.version || 1) + 1;\n  const newSubmissionId = crypto.randomUUID();\n  \n  // Submit with version and parent reference\n  const result = await this.submitTransactionInternal(transactionId, {\n    version: newVersion,\n    parent_submission_id: transaction.submission_id\n  });\n  \n  // Update local status\n  await this.updateLocalSubmissionStatus(transactionId, {\n    submission_status: 'resubmitted',\n    submission_id: newSubmissionId,\n    submitted_at: new Date().toISOString()\n  });\n  \n  return result;\n}\n</code>\n\n---\n\n<strong>Files to Create/Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>electron/services/submissionService.ts</code> | New service file |\n| <code>electron/services/supabaseService.ts</code> | Add submission queries |\n| <code>electron/handlers/submission-handlers.ts</code> | IPC handlers |\n| <code>electron/preload/preload.ts</code> | Expose submission API |\n| <code>src/services/submissionService.ts</code> | Renderer-side wrapper |\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-387: Cloud schema (tables must exist)\n\u2022 BACKLOG-388: RLS policies (for service key access)\n\u2022 BACKLOG-390: Local schema (submission_status fields)\n\u2022 BACKLOG-393: Attachment upload service (uploads first)\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Can submit transaction with messages and attachments\n\u2610 Progress callback provides accurate status\n\u2610 Local submission_status updated on success\n\u2610 submission_id stored locally for sync\n\u2610 Resubmission creates new version\n\u2610 Parent submission linked correctly\n\u2610 Message counts updated in submission record\n\u2610 Attachment counts updated in submission record\n\u2610 Graceful handling of partial attachment failures\n\u2610 Error recovery doesn't leave orphan cloud records\n\n---\n\n<strong>Technical Notes</strong>\n\n<strong>Auth Context (Demo)</strong>\n\nUse service key for Supabase operations:\n\n<code>const supabaseAdmin = createClient(\n  process.env.SUPABASE_URL,\n  process.env.SUPABASE_SERVICE_KEY\n);\n</code>\n\n**Production:** Authenticate user, use their JWT.\n\n<strong>Transaction Isolation</strong>\n\nIf submission fails mid-way:\n1. Cloud records may be partially created\n2. Local status should NOT be updated to 'submitted'\n3. User can retry, which should clean up partial data\n\nConsider using Supabase transactions or manual cleanup:\n\n<code>// On failure, clean up partial cloud data\nif (error) {\n  await this.cleanupFailedSubmission(submissionId);\n  throw error;\n}\n</code>\n\n<strong>Message Batching</strong>\n\nFor transactions with many messages (100+), batch inserts:\n\n<code>const BATCH_SIZE = 50;\nfor (let i = 0; i < messages.length; i += BATCH_SIZE) {\n  const batch = messages.slice(i, i + BATCH_SIZE);\n  await supabase.from('submission_messages').insert(batch);\n  onProgress?.((i + batch.length) / messages.length * 100);\n}\n</code>\n\n<strong>Count Updates</strong>\n\nAfter inserting messages/attachments, update the submission record:\n\n<code>await supabase\n  .from('transaction_submissions')\n  .update({\n    message_count: actualMessageCount,\n    attachment_count: actualAttachmentCount\n  })\n  .eq('id', submissionId);\n</code>\n\n---\n\n<strong>Testing Plan</strong>\n\n1. Submit transaction with 0 messages, 0 attachments\n2. Submit transaction with 10 messages, 5 attachments\n3. Submit transaction with 100+ messages\n4. Test progress callback accuracy\n5. Test partial attachment failure handling\n6. Test resubmission creates new version\n7. Test parent_submission_id linked\n8. Test local status updates correctly\n9. Test cleanup on failure\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-387: Supabase Schema (dependency)\n\u2022 BACKLOG-390: Local Schema Changes (dependency)\n\u2022 BACKLOG-391: Submit UI (calls this service)\n\u2022 BACKLOG-392: Bulk Submit UI (calls this service)\n\u2022 BACKLOG-393: Attachment Upload (dependency)\n\u2022 BACKLOG-395: Status Sync (reads status back)\n\u2022 SPRINT-050: B2B Broker Portal Demo"
  },
  {
    "id": "BACKLOG-395",
    "title": "Desktop - Status Sync + Review Notes Display",
    "category": "service",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-050",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-395.md](items/BACKLOG-395.md)",
    "description": "<strong>Summary</strong>\n\nCreate a service to sync submission status changes from Supabase cloud to the local SQLite database, and display broker review notes to the agent when changes are requested.\n\n---\n\n<strong>Problem Statement</strong>\n\nAfter an agent submits a transaction, the broker reviews it in the web portal. The agent needs to:\n1. See status changes (under_review, needs_changes, approved, rejected)\n2. Read broker feedback when changes are requested\n3. Know when to resubmit after making corrections\n\nCurrently, there's no mechanism to sync cloud status back to the desktop app.\n\n---\n\n<strong>Proposed Solution</strong>\n\n<strong>Sync Service</strong>\n\nCreate <code>electron/services/submissionSyncService.ts</code>:\n\n<code>interface SyncResult {\n  updated: number;\n  failed: number;\n  details: Array<{\n    transactionId: string;\n    oldStatus: SubmissionStatus;\n    newStatus: SubmissionStatus;\n    reviewNotes?: string;\n  }>;\n}\n\nclass SubmissionSyncService {\n  /**\n   * Sync status for all submitted transactions\n   */\n  async syncAllSubmissions(): Promise<SyncResult>;\n\n  /**\n   * Sync status for a specific transaction\n   */\n  async syncSubmission(transactionId: string): Promise<boolean>;\n\n  /**\n   * Start periodic sync (polling)\n   */\n  startPeriodicSync(intervalMs?: number): void;\n\n  /**\n   * Stop periodic sync\n   */\n  stopPeriodicSync(): void;\n}\n</code>\n\n<strong>Sync Implementation</strong>\n\n<code>async syncAllSubmissions(): Promise<SyncResult> {\n  // 1. Get all local transactions with submission_id\n  const submittedTransactions = await db.query(<code>\n    SELECT id, submission_id, submission_status, last_review_notes\n    FROM transactions\n    WHERE submission_id IS NOT NULL\n    AND submission_status NOT IN ('approved', 'rejected')\n  </code>);\n  \n  if (submittedTransactions.length === 0) {\n    return { updated: 0, failed: 0, details: [] };\n  }\n  \n  // 2. Fetch cloud statuses\n  const submissionIds = submittedTransactions.map(t => t.submission_id);\n  const { data: cloudStatuses, error } = await supabase\n    .from('transaction_submissions')\n    .select('id, status, review_notes, reviewed_at, reviewed_by')\n    .in('id', submissionIds);\n  \n  if (error) throw error;\n  \n  // 3. Compare and update\n  const results: SyncResult = { updated: 0, failed: 0, details: [] };\n  \n  for (const local of submittedTransactions) {\n    const cloud = cloudStatuses.find(c => c.id === local.submission_id);\n    if (!cloud) continue;\n    \n    // Check if status changed\n    if (cloud.status !== local.submission_status || \n        cloud.review_notes !== local.last_review_notes) {\n      \n      try {\n        await db.run(<code>\n          UPDATE transactions\n          SET submission_status = ?,\n              last_review_notes = ?\n          WHERE id = ?\n        </code>, [cloud.status, cloud.review_notes, local.id]);\n        \n        results.updated++;\n        results.details.push({\n          transactionId: local.id,\n          oldStatus: local.submission_status,\n          newStatus: cloud.status,\n          reviewNotes: cloud.review_notes\n        });\n        \n        // Emit event for UI notification\n        if (cloud.status !== local.submission_status) {\n          this.emitStatusChange(local.id, cloud.status, cloud.review_notes);\n        }\n        \n      } catch (e) {\n        results.failed++;\n      }\n    }\n  }\n  \n  return results;\n}\n</code>\n\n<strong>Periodic Polling</strong>\n\n<code>private syncInterval: NodeJS.Timeout | null = null;\n\nstartPeriodicSync(intervalMs = 60000) { // Default: 1 minute\n  if (this.syncInterval) return;\n  \n  this.syncInterval = setInterval(async () => {\n    try {\n      await this.syncAllSubmissions();\n    } catch (error) {\n      console.error('Sync failed:', error);\n    }\n  }, intervalMs);\n  \n  // Also sync immediately on start\n  this.syncAllSubmissions().catch(console.error);\n}\n\nstopPeriodicSync() {\n  if (this.syncInterval) {\n    clearInterval(this.syncInterval);\n    this.syncInterval = null;\n  }\n}\n</code>\n\n<strong>UI Notifications</strong>\n\nWhen status changes to <code>needs_changes</code>:\n\n<code>emitStatusChange(transactionId: string, newStatus: string, reviewNotes?: string) {\n  // Emit to renderer for toast notification\n  mainWindow?.webContents.send('submission-status-changed', {\n    transactionId,\n    newStatus,\n    reviewNotes,\n    title: this.getNotificationTitle(newStatus),\n    message: this.getNotificationMessage(newStatus, reviewNotes)\n  });\n}\n\ngetNotificationTitle(status: SubmissionStatus): string {\n  switch (status) {\n    case 'under_review': return 'Submission Under Review';\n    case 'needs_changes': return 'Changes Requested';\n    case 'approved': return 'Submission Approved!';\n    case 'rejected': return 'Submission Rejected';\n    default: return 'Submission Status Updated';\n  }\n}\n</code>\n\n<strong>Review Notes Display</strong>\n\nIn the transaction detail page, when <code>submission_status === 'needs_changes'</code>:\n\n<code>{transaction.submission_status === 'needs_changes' && (\n  <ReviewNotesPanel\n    notes={transaction.last_review_notes}\n    reviewedAt={transaction.reviewed_at}\n    onResubmit={() => handleResubmit(transaction.id)}\n  />\n)}\n</code>\n\nComponent:\n\n<code>function ReviewNotesPanel({ notes, reviewedAt, onResubmit }) {\n  return (\n    <div className=\"bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4\">\n      <div className=\"flex items-center gap-2 mb-2\">\n        <AlertTriangle className=\"h-5 w-5 text-orange-500\" />\n        <h3 className=\"font-semibold text-orange-700\">Changes Requested</h3>\n      </div>\n      \n      <blockquote className=\"border-l-4 border-orange-300 pl-4 my-3 italic\">\n        \"{notes}\"\n      </blockquote>\n      \n      {reviewedAt && (\n        <p className=\"text-sm text-gray-500\">\n          Reviewed on {formatDate(reviewedAt)}\n        </p>\n      )}\n      \n      <button\n        onClick={onResubmit}\n        className=\"mt-3 px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600\"\n      >\n        Resubmit for Review\n      </button>\n    </div>\n  );\n}\n</code>\n\n---\n\n<strong>Files to Create/Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>electron/services/submissionSyncService.ts</code> | New service file |\n| <code>electron/main.ts</code> | Start periodic sync on app ready |\n| <code>electron/preload/preload.ts</code> | Expose sync API and events |\n| <code>src/hooks/useSubmissionSync.ts</code> | React hook for UI |\n| <code>src/components/transactionDetailsModule/components/ReviewNotesPanel.tsx</code> | New component |\n| <code>src/components/Notifications/SubmissionStatusToast.tsx</code> | New toast component |\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-390: Local schema (submission_status, last_review_notes fields)\n\u2022 BACKLOG-394: Transaction push service (creates submission_id)\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Sync runs automatically on app start\n\u2610 Sync runs periodically (configurable interval)\n\u2610 Manual sync trigger available\n\u2610 Local status updated when cloud status changes\n\u2610 Review notes stored locally\n\u2610 Toast notification on status change\n\u2610 Review notes panel shows in transaction detail\n\u2610 Resubmit button available when changes requested\n\u2610 Sync doesn't run for approved/rejected (terminal states)\n\u2610 Sync handles offline gracefully (skip, retry later)\n\n---\n\n<strong>Technical Notes</strong>\n\n<strong>Polling vs Realtime</strong>\n\nFor demo, polling is acceptable:\n\u2022 Simpler implementation\n\u2022 Works offline (just skips sync)\n\u2022 1-minute interval is responsive enough\n\n**Production Enhancement:** Use Supabase Realtime subscriptions for instant updates.\n\n<strong>Auth Context</strong>\n\nUse service key for sync queries (same as submission):\n\n<code>const supabaseAdmin = createClient(\n  process.env.SUPABASE_URL,\n  process.env.SUPABASE_SERVICE_KEY\n);\n</code>\n\n<strong>Offline Handling</strong>\n\n<code>async syncAllSubmissions(): Promise<SyncResult> {\n  if (!navigator.onLine) {\n    console.log('Offline, skipping sync');\n    return { updated: 0, failed: 0, details: [] };\n  }\n  // ... rest of sync\n}\n</code>\n\n<strong>App Lifecycle</strong>\n\n<code>// In main.ts\napp.on('ready', () => {\n  // Start sync after auth is confirmed\n  authService.onAuthenticated(() => {\n    submissionSyncService.startPeriodicSync();\n  });\n});\n\napp.on('before-quit', () => {\n  submissionSyncService.stopPeriodicSync();\n});\n</code>\n\n<strong>React Integration</strong>\n\n<code>// useSubmissionSync.ts\nexport function useSubmissionSync() {\n  const [lastSynced, setLastSynced] = useState<Date | null>(null);\n  const [syncing, setSyncing] = useState(false);\n  \n  useEffect(() => {\n    // Listen for status change events\n    const unsubscribe = window.api.onSubmissionStatusChanged((data) => {\n      // Trigger local state refresh\n      queryClient.invalidateQueries(['transaction', data.transactionId]);\n      \n      // Show toast\n      toast.info(data.title, { description: data.message });\n    });\n    \n    return unsubscribe;\n  }, []);\n  \n  const syncNow = async () => {\n    setSyncing(true);\n    try {\n      await window.api.syncSubmissions();\n      setLastSynced(new Date());\n    } finally {\n      setSyncing(false);\n    }\n  };\n  \n  return { lastSynced, syncing, syncNow };\n}\n</code>\n\n---\n\n<strong>Testing Plan</strong>\n\n1. Submit transaction, verify initial sync sees 'submitted'\n2. Change status in Supabase directly, verify sync updates local\n3. Add review notes in Supabase, verify notes synced\n4. Test toast notification on status change\n5. Test review notes panel display\n6. Test resubmit from panel\n7. Test offline behavior (no crash, graceful skip)\n8. Test sync stops for terminal states\n9. Test periodic sync interval\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-390: Local Schema Changes (dependency)\n\u2022 BACKLOG-391: Submit UI (displays status)\n\u2022 BACKLOG-394: Transaction Push (creates submissions)\n\u2022 BACKLOG-400: Review Actions (broker side)\n\u2022 SPRINT-050: B2B Broker Portal Demo"
  },
  {
    "id": "BACKLOG-396",
    "title": "Portal - Next.js Setup + Vercel Deploy",
    "category": "infrastructure",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-050",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-396.md](items/BACKLOG-396.md)",
    "description": "<strong>Summary</strong>\n\nCreate the Next.js 14 (App Router) project for the Broker Portal in a <code>broker-portal/</code> subdirectory, configure it for Vercel deployment, and ensure it's isolated from the Electron build.\n\n---\n\n<strong>Problem Statement</strong>\n\nThe B2B broker portal needs:\n1. A separate web application for brokers to review submissions\n2. Deployed to Vercel (user preference)\n3. Isolated from the Electron desktop app build\n4. Shared TypeScript types with the desktop app\n5. Basic project structure for subsequent development\n\n---\n\n<strong>Proposed Solution</strong>\n\n<strong>Project Structure</strong>\n\n<code>Mad/\n\u251c\u2500\u2500 broker-portal/           # NEW: Next.js web app\n\u2502   \u251c\u2500\u2500 app/\n\u2502   \u2502   \u251c\u2500\u2500 layout.tsx       # Root layout\n\u2502   \u2502   \u251c\u2500\u2500 page.tsx         # Landing/redirect\n\u2502   \u2502   \u251c\u2500\u2500 globals.css      # Tailwind styles\n\u2502   \u2502   \u251c\u2500\u2500 login/\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 page.tsx     # OAuth login\n\u2502   \u2502   \u2514\u2500\u2500 dashboard/\n\u2502   \u2502       \u251c\u2500\u2500 layout.tsx   # Dashboard shell\n\u2502   \u2502       \u251c\u2500\u2500 page.tsx     # Overview\n\u2502   \u2502       \u2514\u2500\u2500 submissions/\n\u2502   \u2502           \u251c\u2500\u2500 page.tsx # List\n\u2502   \u2502           \u2514\u2500\u2500 [id]/\n\u2502   \u2502               \u2514\u2500\u2500 page.tsx # Detail\n\u2502   \u251c\u2500\u2500 components/          # React components\n\u2502   \u2502   \u2514\u2500\u2500 ui/              # shadcn/ui components\n\u2502   \u251c\u2500\u2500 lib/\n\u2502   \u2502   \u251c\u2500\u2500 supabase.ts      # Supabase client\n\u2502   \u2502   \u2514\u2500\u2500 utils.ts         # Utilities\n\u2502   \u251c\u2500\u2500 middleware.ts        # Auth protection\n\u2502   \u251c\u2500\u2500 tailwind.config.ts   # Tailwind config\n\u2502   \u251c\u2500\u2500 next.config.mjs      # Next.js config\n\u2502   \u251c\u2500\u2500 package.json         # Separate dependencies\n\u2502   \u251c\u2500\u2500 tsconfig.json        # TypeScript config\n\u2502   \u2514\u2500\u2500 .env.local.example   # Environment template\n\u251c\u2500\u2500 shared/                  # NEW: Shared types\n\u2502   \u2514\u2500\u2500 types/\n\u2502       \u2514\u2500\u2500 submissions.ts   # Shared interfaces\n\u251c\u2500\u2500 electron/                # Unchanged\n\u251c\u2500\u2500 src/                     # Unchanged\n\u2514\u2500\u2500 package.json             # Root workspace config\n</code>\n\n<strong>Next.js Project Setup</strong>\n\n<code>cd Mad\nnpx create-next-app@latest broker-portal \\\n  --typescript \\\n  --tailwind \\\n  --eslint \\\n  --app \\\n  --src-dir=false \\\n  --import-alias=\"@/*\"\n</code>\n\n<strong>Root package.json Workspace</strong>\n\nAdd workspace configuration to root <code>package.json</code>:\n\n<code>{\n  \"workspaces\": [\n    \"broker-portal\"\n  ],\n  \"scripts\": {\n    \"portal:dev\": \"npm run dev -w broker-portal\",\n    \"portal:build\": \"npm run build -w broker-portal\",\n    \"portal:lint\": \"npm run lint -w broker-portal\"\n  }\n}\n</code>\n\n<strong>broker-portal/package.json</strong>\n\n<code>{\n  \"name\": \"magic-audit-broker-portal\",\n  \"version\": \"0.1.0\",\n  \"private\": true,\n  \"scripts\": {\n    \"dev\": \"next dev\",\n    \"build\": \"next build\",\n    \"start\": \"next start\",\n    \"lint\": \"next lint\"\n  },\n  \"dependencies\": {\n    \"next\": \"14.x\",\n    \"react\": \"18.x\",\n    \"react-dom\": \"18.x\",\n    \"@supabase/supabase-js\": \"^2.x\",\n    \"@supabase/ssr\": \"^0.x\",\n    \"tailwindcss\": \"^3.x\",\n    \"lucide-react\": \"^0.x\"\n  },\n  \"devDependencies\": {\n    \"@types/node\": \"^20.x\",\n    \"@types/react\": \"^18.x\",\n    \"@types/react-dom\": \"^18.x\",\n    \"typescript\": \"^5.x\",\n    \"autoprefixer\": \"^10.x\",\n    \"postcss\": \"^8.x\"\n  }\n}\n</code>\n\n<strong>Vercel Configuration</strong>\n\nCreate <code>broker-portal/vercel.json</code>:\n\n<code>{\n  \"framework\": \"nextjs\",\n  \"buildCommand\": \"npm run build\",\n  \"outputDirectory\": \".next\",\n  \"devCommand\": \"npm run dev\",\n  \"installCommand\": \"npm install\"\n}\n</code>\n\n<strong>Environment Variables</strong>\n\nCreate <code>broker-portal/.env.local.example</code>:\n\n<code># Supabase\nNEXT_PUBLIC_SUPABASE_URL=your-project-url\nNEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key\n\n# App\nNEXT_PUBLIC_APP_URL=http://localhost:3000\n</code>\n\n<strong>Shared Types</strong>\n\nCreate <code>shared/types/submissions.ts</code>:\n\n<code>// Shared between desktop app and broker portal\n\nexport type SubmissionStatus = \n  | 'submitted'\n  | 'under_review'\n  | 'needs_changes'\n  | 'resubmitted'\n  | 'approved'\n  | 'rejected';\n\nexport interface TransactionSubmission {\n  id: string;\n  organization_id: string;\n  submitted_by: string;\n  local_transaction_id: string;\n  property_address: string;\n  property_city: string | null;\n  property_state: string | null;\n  property_zip: string | null;\n  transaction_type: 'purchase' | 'sale' | 'other';\n  listing_price: number | null;\n  sale_price: number | null;\n  started_at: string | null;\n  closed_at: string | null;\n  status: SubmissionStatus;\n  reviewed_by: string | null;\n  reviewed_at: string | null;\n  review_notes: string | null;\n  version: number;\n  parent_submission_id: string | null;\n  message_count: number;\n  attachment_count: number;\n  created_at: string;\n  updated_at: string;\n}\n\nexport interface SubmissionMessage {\n  id: string;\n  submission_id: string;\n  local_message_id: string | null;\n  channel: 'email' | 'sms' | 'imessage';\n  direction: 'inbound' | 'outbound';\n  subject: string | null;\n  body_text: string | null;\n  participants: {\n    from?: string;\n    to?: string[];\n    cc?: string[];\n    bcc?: string[];\n  };\n  sent_at: string | null;\n  thread_id: string | null;\n  has_attachments: boolean;\n  attachment_count: number;\n  created_at: string;\n}\n\nexport interface SubmissionAttachment {\n  id: string;\n  submission_id: string;\n  message_id: string | null;\n  filename: string;\n  mime_type: string | null;\n  file_size_bytes: number | null;\n  storage_path: string;\n  document_type: string | null;\n  created_at: string;\n}\n</code>\n\n<strong>Basic App Layout</strong>\n\nCreate <code>broker-portal/app/layout.tsx</code>:\n\n<code>import { Inter } from 'next/font/google'\nimport './globals.css'\n\nconst inter = Inter({ subsets: ['latin'] })\n\nexport const metadata = {\n  title: 'Magic Audit - Broker Portal',\n  description: 'Review and approve transaction audits',\n}\n\nexport default function RootLayout({\n  children,\n}: {\n  children: React.ReactNode\n}) {\n  return (\n    <html lang=\"en\">\n      <body className={inter.className}>\n        {children}\n      </body>\n    </html>\n  )\n}\n</code>\n\n<strong>Landing Page</strong>\n\nCreate <code>broker-portal/app/page.tsx</code>:\n\n<code>import { redirect } from 'next/navigation'\nimport { createClient } from '@/lib/supabase/server'\n\nexport default async function Home() {\n  const supabase = createClient()\n  const { data: { session } } = await supabase.auth.getSession()\n  \n  if (session) {\n    redirect('/dashboard')\n  } else {\n    redirect('/login')\n  }\n}\n</code>\n\n---\n\n<strong>Files to Create/Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>broker-portal/*</code> | New Next.js project |\n| <code>shared/types/submissions.ts</code> | Shared TypeScript types |\n| <code>package.json</code> (root) | Add workspaces config |\n| <code>.gitignore</code> | Add <code>broker-portal/.next/</code> |\n| <code>electron-builder.yml</code> | Verify isolation (should already exclude) |\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-388: RLS policies (portal queries will use them)\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Next.js project created in <code>broker-portal/</code>\n\u2610 <code>npm run portal:dev</code> starts development server\n\u2610 <code>npm run portal:build</code> builds successfully\n\u2610 Tailwind CSS configured and working\n\u2610 Supabase client configured\n\u2610 Shared types accessible from both projects\n\u2610 Electron build excludes <code>broker-portal/</code>\n\u2610 Vercel deployment works (preview deploy)\n\u2610 Environment variables documented\n\n---\n\n<strong>Technical Notes</strong>\n\n<strong>Build Isolation</strong>\n\nThe <code>electron-builder.yml</code> already only bundles specific directories. Verify it doesn't include <code>broker-portal/</code>:\n\n<code>files:\n  - \"electron/**/*\"\n  - \"dist/**/*\"\n  - \"node_modules/**/*\"\n  - \"package.json\"\n  # broker-portal/ is NOT listed = excluded\n</code>\n\n<strong>Path Aliases</strong>\n\nIn <code>broker-portal/tsconfig.json</code>:\n\n<code>{\n  \"compilerOptions\": {\n    \"baseUrl\": \".\",\n    \"paths\": {\n      \"@/*\": [\"./*\"],\n      \"@shared/*\": [\"../shared/*\"]\n    }\n  }\n}\n</code>\n\n<strong>Supabase Client Setup</strong>\n\nCreate <code>broker-portal/lib/supabase/client.ts</code>:\n\n<code>import { createBrowserClient } from '@supabase/ssr'\n\nexport function createClient() {\n  return createBrowserClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\n  )\n}\n</code>\n\nCreate <code>broker-portal/lib/supabase/server.ts</code>:\n\n<code>import { createServerClient, type CookieOptions } from '@supabase/ssr'\nimport { cookies } from 'next/headers'\n\nexport function createClient() {\n  const cookieStore = cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        get(name: string) {\n          return cookieStore.get(name)?.value\n        },\n        set(name: string, value: string, options: CookieOptions) {\n          cookieStore.set({ name, value, ...options })\n        },\n        remove(name: string, options: CookieOptions) {\n          cookieStore.set({ name, value: '', ...options })\n        },\n      },\n    }\n  )\n}\n</code>\n\n<strong>Vercel Deployment</strong>\n\n1. Connect GitHub repo to Vercel\n2. Set root directory to <code>broker-portal</code>\n3. Add environment variables in Vercel dashboard\n4. Enable preview deployments for PRs\n\n---\n\n<strong>Testing Plan</strong>\n\n1. Run <code>npm run portal:dev</code>, verify starts on localhost:3000\n2. Run <code>npm run portal:build</code>, verify builds without errors\n3. Verify Tailwind styles apply\n4. Verify landing page redirects appropriately\n5. Test Vercel preview deployment\n6. Verify Electron build still works (<code>npm run build</code>)\n7. Verify shared types import correctly\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-388: RLS Policies (portal needs these)\n\u2022 BACKLOG-397: Supabase Auth (next task)\n\u2022 BACKLOG-398: Dashboard + List (uses this structure)\n\u2022 SPRINT-050: B2B Broker Portal Demo"
  },
  {
    "id": "BACKLOG-397",
    "title": "Portal - Supabase Auth (OAuth)",
    "category": "auth",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-050",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-397.md](items/BACKLOG-397.md)",
    "description": "<strong>Summary</strong>\n\nImplement authentication for the broker portal using Supabase Auth with Google and Microsoft OAuth providers, matching the desktop app's authentication experience.\n\n---\n\n<strong>Problem Statement</strong>\n\nThe broker portal needs:\n1. Secure authentication before accessing submissions\n2. OAuth with Google and Microsoft (same as desktop)\n3. Session management with Supabase\n4. Route protection (middleware)\n5. User context for RLS policies\n\n---\n\n<strong>Proposed Solution</strong>\n\n<strong>Login Page</strong>\n\nCreate <code>broker-portal/app/login/page.tsx</code>:\n\n<code>'use client'\n\nimport { createClient } from '@/lib/supabase/client'\nimport { useRouter } from 'next/navigation'\n\nexport default function LoginPage() {\n  const router = useRouter()\n  const supabase = createClient()\n\n  const signInWithGoogle = async () => {\n    const { error } = await supabase.auth.signInWithOAuth({\n      provider: 'google',\n      options: {\n        redirectTo: <code>${window.location.origin}/auth/callback</code>,\n        queryParams: {\n          access_type: 'offline',\n          prompt: 'consent',\n        },\n      },\n    })\n    if (error) console.error('Error:', error)\n  }\n\n  const signInWithMicrosoft = async () => {\n    const { error } = await supabase.auth.signInWithOAuth({\n      provider: 'azure',\n      options: {\n        redirectTo: <code>${window.location.origin}/auth/callback</code>,\n        scopes: 'email profile openid',\n      },\n    })\n    if (error) console.error('Error:', error)\n  }\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\n      <div className=\"max-w-md w-full space-y-8 p-8 bg-white rounded-lg shadow\">\n        <div className=\"text-center\">\n          <h1 className=\"text-3xl font-bold text-gray-900\">\n            Magic Audit\n          </h1>\n          <p className=\"mt-2 text-gray-600\">\n            Broker Portal\n          </p>\n        </div>\n\n        <div className=\"space-y-4\">\n          <button\n            onClick={signInWithGoogle}\n            className=\"w-full flex items-center justify-center gap-3 px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition\"\n          >\n            <GoogleIcon className=\"h-5 w-5\" />\n            <span>Continue with Google</span>\n          </button>\n\n          <button\n            onClick={signInWithMicrosoft}\n            className=\"w-full flex items-center justify-center gap-3 px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition\"\n          >\n            <MicrosoftIcon className=\"h-5 w-5\" />\n            <span>Continue with Microsoft</span>\n          </button>\n        </div>\n\n        <p className=\"text-sm text-center text-gray-500\">\n          Sign in with your brokerage email to access submissions.\n        </p>\n      </div>\n    </div>\n  )\n}\n</code>\n\n<strong>Auth Callback Handler</strong>\n\nCreate <code>broker-portal/app/auth/callback/route.ts</code>:\n\n<code>import { createClient } from '@/lib/supabase/server'\nimport { NextResponse } from 'next/server'\n\nexport async function GET(request: Request) {\n  const requestUrl = new URL(request.url)\n  const code = requestUrl.searchParams.get('code')\n  const origin = requestUrl.origin\n\n  if (code) {\n    const supabase = createClient()\n    \n    const { error } = await supabase.auth.exchangeCodeForSession(code)\n    \n    if (error) {\n      console.error('Auth error:', error)\n      return NextResponse.redirect(<code>${origin}/login?error=auth_failed</code>)\n    }\n    \n    // Verify user is a member of an organization with broker/admin role\n    const { data: { user } } = await supabase.auth.getUser()\n    \n    if (user) {\n      const { data: membership } = await supabase\n        .from('organization_members')\n        .select('role')\n        .eq('user_id', user.id)\n        .in('role', ['broker', 'admin'])\n        .single()\n      \n      if (!membership) {\n        // User exists but is not a broker/admin\n        await supabase.auth.signOut()\n        return NextResponse.redirect(<code>${origin}/login?error=not_authorized</code>)\n      }\n    }\n  }\n\n  return NextResponse.redirect(<code>${origin}/dashboard</code>)\n}\n</code>\n\n<strong>Middleware (Route Protection)</strong>\n\nCreate <code>broker-portal/middleware.ts</code>:\n\n<code>import { createServerClient, type CookieOptions } from '@supabase/ssr'\nimport { NextResponse, type NextRequest } from 'next/server'\n\nexport async function middleware(request: NextRequest) {\n  let response = NextResponse.next({\n    request: {\n      headers: request.headers,\n    },\n  })\n\n  const supabase = createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        get(name: string) {\n          return request.cookies.get(name)?.value\n        },\n        set(name: string, value: string, options: CookieOptions) {\n          request.cookies.set({\n            name,\n            value,\n            ...options,\n          })\n          response = NextResponse.next({\n            request: {\n              headers: request.headers,\n            },\n          })\n          response.cookies.set({\n            name,\n            value,\n            ...options,\n          })\n        },\n        remove(name: string, options: CookieOptions) {\n          request.cookies.set({\n            name,\n            value: '',\n            ...options,\n          })\n          response = NextResponse.next({\n            request: {\n              headers: request.headers,\n            },\n          })\n          response.cookies.set({\n            name,\n            value: '',\n            ...options,\n          })\n        },\n      },\n    }\n  )\n\n  const { data: { session } } = await supabase.auth.getSession()\n\n  // Protected routes\n  if (request.nextUrl.pathname.startsWith('/dashboard')) {\n    if (!session) {\n      return NextResponse.redirect(new URL('/login', request.url))\n    }\n  }\n\n  // Redirect logged-in users away from login\n  if (request.nextUrl.pathname === '/login' && session) {\n    return NextResponse.redirect(new URL('/dashboard', request.url))\n  }\n\n  return response\n}\n\nexport const config = {\n  matcher: [\n    '/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',\n  ],\n}\n</code>\n\n<strong>Auth Context</strong>\n\nCreate <code>broker-portal/components/providers/AuthProvider.tsx</code>:\n\n<code>'use client'\n\nimport { createContext, useContext, useEffect, useState } from 'react'\nimport { User, Session } from '@supabase/supabase-js'\nimport { createClient } from '@/lib/supabase/client'\n\ninterface AuthContextType {\n  user: User | null\n  session: Session | null\n  loading: boolean\n  signOut: () => Promise<void>\n}\n\nconst AuthContext = createContext<AuthContextType>({\n  user: null,\n  session: null,\n  loading: true,\n  signOut: async () => {},\n})\n\nexport function AuthProvider({ children }: { children: React.ReactNode }) {\n  const [user, setUser] = useState<User | null>(null)\n  const [session, setSession] = useState<Session | null>(null)\n  const [loading, setLoading] = useState(true)\n  const supabase = createClient()\n\n  useEffect(() => {\n    // Get initial session\n    supabase.auth.getSession().then(({ data: { session } }) => {\n      setSession(session)\n      setUser(session?.user ?? null)\n      setLoading(false)\n    })\n\n    // Listen for auth changes\n    const { data: { subscription } } = supabase.auth.onAuthStateChange(\n      (_event, session) => {\n        setSession(session)\n        setUser(session?.user ?? null)\n        setLoading(false)\n      }\n    )\n\n    return () => subscription.unsubscribe()\n  }, [])\n\n  const signOut = async () => {\n    await supabase.auth.signOut()\n  }\n\n  return (\n    <AuthContext.Provider value={{ user, session, loading, signOut }}>\n      {children}\n    </AuthContext.Provider>\n  )\n}\n\nexport const useAuth = () => useContext(AuthContext)\n</code>\n\n<strong>Logout Handler</strong>\n\nCreate <code>broker-portal/app/auth/logout/route.ts</code>:\n\n<code>import { createClient } from '@/lib/supabase/server'\nimport { NextResponse } from 'next/server'\n\nexport async function POST(request: Request) {\n  const supabase = createClient()\n  await supabase.auth.signOut()\n  \n  const requestUrl = new URL(request.url)\n  return NextResponse.redirect(<code>${requestUrl.origin}/login</code>)\n}\n</code>\n\n---\n\n<strong>Files to Create/Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>broker-portal/app/login/page.tsx</code> | Login page with OAuth buttons |\n| <code>broker-portal/app/auth/callback/route.ts</code> | OAuth callback handler |\n| <code>broker-portal/app/auth/logout/route.ts</code> | Logout handler |\n| <code>broker-portal/middleware.ts</code> | Route protection |\n| <code>broker-portal/components/providers/AuthProvider.tsx</code> | Auth context |\n| <code>broker-portal/app/layout.tsx</code> | Wrap with AuthProvider |\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-396: Next.js project setup\n\u2022 BACKLOG-388: RLS policies (auth enables RLS)\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Login page displays with Google and Microsoft options\n\u2610 Google OAuth redirects and authenticates\n\u2610 Microsoft OAuth redirects and authenticates\n\u2610 Auth callback exchanges code for session\n\u2610 Non-broker users rejected with error message\n\u2610 Middleware protects /dashboard routes\n\u2610 Session persists across page refreshes\n\u2610 Logout clears session and redirects\n\u2610 Auth state available via useAuth hook\n\n---\n\n<strong>Technical Notes</strong>\n\n<strong>Supabase Auth Providers</strong>\n\nBoth Google and Microsoft are already configured in the Supabase project (used by desktop app). The broker portal uses the same providers.\n\n<strong>Role Verification</strong>\n\nAfter successful OAuth, verify the user has a broker or admin role:\n\n<code>const { data: membership } = await supabase\n  .from('organization_members')\n  .select('role, organization_id')\n  .eq('user_id', user.id)\n  .in('role', ['broker', 'admin'])\n  .single()\n</code>\n\nIf no membership found, sign out and show error.\n\n<strong>Session Storage</strong>\n\nSupabase SSR uses cookies for session storage. This enables:\n\u2022 Server-side session access\n\u2022 Middleware protection\n\u2022 Automatic refresh\n\n<strong>Error States</strong>\n\nHandle these error cases on login page:\n\n| Error Code | Message |\n|------------|---------|\n| <code>auth_failed</code> | \"Authentication failed. Please try again.\" |\n| <code>not_authorized</code> | \"Your account is not authorized for the broker portal.\" |\n\n<code>const searchParams = useSearchParams()\nconst error = searchParams.get('error')\n\n{error === 'not_authorized' && (\n  <Alert variant=\"error\">\n    Your account is not authorized to access the broker portal.\n    Contact your administrator.\n  </Alert>\n)}\n</code>\n\n---\n\n<strong>Testing Plan</strong>\n\n1. Click Google login, complete OAuth flow\n2. Click Microsoft login, complete OAuth flow\n3. Verify redirect to dashboard after auth\n4. Access /dashboard without login, verify redirect to /login\n5. Create user without broker role, verify rejected\n6. Click logout, verify session cleared\n7. Refresh page, verify session persists\n8. Test error message display\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-396: Next.js Setup (dependency)\n\u2022 BACKLOG-388: RLS Policies (auth enables RLS)\n\u2022 BACKLOG-398: Dashboard (uses auth context)\n\u2022 SPRINT-050: B2B Broker Portal Demo"
  },
  {
    "id": "BACKLOG-398",
    "title": "Portal - Dashboard + Submission List",
    "category": "ui",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-050",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-398.md](items/BACKLOG-398.md)",
    "description": "<strong>Summary</strong>\n\nCreate the broker portal dashboard with summary statistics and a filterable list of transaction submissions for review.\n\n---\n\n<strong>Problem Statement</strong>\n\nOnce authenticated, brokers need to:\n1. See an overview of pending submissions\n2. View a list of all submissions with status filtering\n3. Navigate to individual submissions for review\n4. Understand workload at a glance\n\n---\n\n<strong>Proposed Solution</strong>\n\n<strong>Dashboard Layout</strong>\n\nCreate <code>broker-portal/app/dashboard/layout.tsx</code>:\n\n<code>import { AuthProvider } from '@/components/providers/AuthProvider'\nimport { Sidebar } from '@/components/Sidebar'\nimport { Header } from '@/components/Header'\n\nexport default function DashboardLayout({\n  children,\n}: {\n  children: React.ReactNode\n}) {\n  return (\n    <AuthProvider>\n      <div className=\"min-h-screen bg-gray-50\">\n        <Sidebar />\n        <div className=\"lg:pl-64\">\n          <Header />\n          <main className=\"py-8 px-4 sm:px-6 lg:px-8\">\n            {children}\n          </main>\n        </div>\n      </div>\n    </AuthProvider>\n  )\n}\n</code>\n\n<strong>Dashboard Overview</strong>\n\nCreate <code>broker-portal/app/dashboard/page.tsx</code>:\n\n<code>import { createClient } from '@/lib/supabase/server'\nimport { StatCard } from '@/components/StatCard'\nimport { RecentSubmissions } from '@/components/RecentSubmissions'\n\nexport default async function DashboardPage() {\n  const supabase = createClient()\n  \n  // Get user's organization\n  const { data: { user } } = await supabase.auth.getUser()\n  const { data: membership } = await supabase\n    .from('organization_members')\n    .select('organization_id')\n    .eq('user_id', user?.id)\n    .single()\n  \n  if (!membership) {\n    return <div>No organization found</div>\n  }\n  \n  // Get submission counts\n  const { data: submissions } = await supabase\n    .from('transaction_submissions')\n    .select('id, status')\n    .eq('organization_id', membership.organization_id)\n  \n  const stats = {\n    pending: submissions?.filter(s => s.status === 'submitted').length || 0,\n    underReview: submissions?.filter(s => s.status === 'under_review').length || 0,\n    needsChanges: submissions?.filter(s => \n      s.status === 'needs_changes' || s.status === 'resubmitted'\n    ).length || 0,\n    approved: submissions?.filter(s => s.status === 'approved').length || 0,\n    rejected: submissions?.filter(s => s.status === 'rejected').length || 0,\n  }\n  \n  return (\n    <div className=\"space-y-8\">\n      <div>\n        <h1 className=\"text-2xl font-bold text-gray-900\">Dashboard</h1>\n        <p className=\"text-gray-600\">Overview of transaction submissions</p>\n      </div>\n\n      {/* Stats Grid */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4\">\n        <StatCard\n          title=\"Pending Review\"\n          value={stats.pending}\n          icon=\"clock\"\n          color=\"blue\"\n          href=\"/dashboard/submissions?status=submitted\"\n        />\n        <StatCard\n          title=\"Under Review\"\n          value={stats.underReview}\n          icon=\"eye\"\n          color=\"yellow\"\n          href=\"/dashboard/submissions?status=under_review\"\n        />\n        <StatCard\n          title=\"Changes Requested\"\n          value={stats.needsChanges}\n          icon=\"alert\"\n          color=\"orange\"\n          href=\"/dashboard/submissions?status=needs_changes\"\n        />\n        <StatCard\n          title=\"Approved\"\n          value={stats.approved}\n          icon=\"check\"\n          color=\"green\"\n          href=\"/dashboard/submissions?status=approved\"\n        />\n        <StatCard\n          title=\"Rejected\"\n          value={stats.rejected}\n          icon=\"x\"\n          color=\"red\"\n          href=\"/dashboard/submissions?status=rejected\"\n        />\n      </div>\n\n      {/* Recent Submissions */}\n      <div className=\"bg-white rounded-lg shadow\">\n        <div className=\"px-6 py-4 border-b\">\n          <h2 className=\"text-lg font-semibold\">Recent Submissions</h2>\n        </div>\n        <RecentSubmissions organizationId={membership.organization_id} />\n      </div>\n    </div>\n  )\n}\n</code>\n\n<strong>Submission List Page</strong>\n\nCreate <code>broker-portal/app/dashboard/submissions/page.tsx</code>:\n\n<code>import { createClient } from '@/lib/supabase/server'\nimport { SubmissionList } from '@/components/SubmissionList'\nimport { StatusFilter } from '@/components/StatusFilter'\n\ninterface PageProps {\n  searchParams: { status?: string; search?: string }\n}\n\nexport default async function SubmissionsPage({ searchParams }: PageProps) {\n  const supabase = createClient()\n  const { status, search } = searchParams\n  \n  // Get user's organization\n  const { data: { user } } = await supabase.auth.getUser()\n  const { data: membership } = await supabase\n    .from('organization_members')\n    .select('organization_id')\n    .eq('user_id', user?.id)\n    .single()\n  \n  // Build query\n  let query = supabase\n    .from('transaction_submissions')\n    .select(<code>\n      id,\n      property_address,\n      property_city,\n      property_state,\n      transaction_type,\n      status,\n      submitted_by,\n      message_count,\n      attachment_count,\n      created_at,\n      updated_at,\n      users:submitted_by (\n        email,\n        raw_user_meta_data\n      )\n    </code>)\n    .eq('organization_id', membership?.organization_id)\n    .order('created_at', { ascending: false })\n  \n  // Apply filters\n  if (status && status !== 'all') {\n    query = query.eq('status', status)\n  }\n  \n  if (search) {\n    query = query.ilike('property_address', <code>%${search}%</code>)\n  }\n  \n  const { data: submissions } = await query\n  \n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-gray-900\">Submissions</h1>\n          <p className=\"text-gray-600\">\n            {submissions?.length || 0} submissions\n          </p>\n        </div>\n      </div>\n\n      {/* Filters */}\n      <div className=\"bg-white rounded-lg shadow p-4\">\n        <StatusFilter currentStatus={status || 'all'} />\n      </div>\n\n      {/* List */}\n      <SubmissionList submissions={submissions || []} />\n    </div>\n  )\n}\n</code>\n\n<strong>SubmissionList Component</strong>\n\nCreate <code>broker-portal/components/SubmissionList.tsx</code>:\n\n<code>import Link from 'next/link'\nimport { StatusBadge } from './StatusBadge'\nimport { formatDate, formatCurrency } from '@/lib/utils'\n\ninterface Submission {\n  id: string\n  property_address: string\n  property_city: string | null\n  property_state: string | null\n  transaction_type: string\n  status: string\n  message_count: number\n  attachment_count: number\n  created_at: string\n  users: {\n    email: string\n    raw_user_meta_data: { name?: string }\n  }\n}\n\nexport function SubmissionList({ submissions }: { submissions: Submission[] }) {\n  if (submissions.length === 0) {\n    return (\n      <div className=\"bg-white rounded-lg shadow p-8 text-center text-gray-500\">\n        No submissions found\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"bg-white rounded-lg shadow overflow-hidden\">\n      <table className=\"min-w-full divide-y divide-gray-200\">\n        <thead className=\"bg-gray-50\">\n          <tr>\n            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">\n              Property\n            </th>\n            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">\n              Agent\n            </th>\n            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">\n              Status\n            </th>\n            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">\n              Messages\n            </th>\n            <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase\">\n              Submitted\n            </th>\n            <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase\">\n              Actions\n            </th>\n          </tr>\n        </thead>\n        <tbody className=\"bg-white divide-y divide-gray-200\">\n          {submissions.map((submission) => (\n            <tr key={submission.id} className=\"hover:bg-gray-50\">\n              <td className=\"px-6 py-4\">\n                <div>\n                  <div className=\"font-medium text-gray-900\">\n                    {submission.property_address}\n                  </div>\n                  <div className=\"text-sm text-gray-500\">\n                    {submission.property_city}, {submission.property_state}\n                  </div>\n                </div>\n              </td>\n              <td className=\"px-6 py-4 text-sm text-gray-500\">\n                {submission.users?.raw_user_meta_data?.name || submission.users?.email}\n              </td>\n              <td className=\"px-6 py-4\">\n                <StatusBadge status={submission.status} />\n              </td>\n              <td className=\"px-6 py-4 text-sm text-gray-500\">\n                {submission.message_count} msgs, {submission.attachment_count} files\n              </td>\n              <td className=\"px-6 py-4 text-sm text-gray-500\">\n                {formatDate(submission.created_at)}\n              </td>\n              <td className=\"px-6 py-4 text-right\">\n                <Link\n                  href={<code>/dashboard/submissions/${submission.id}</code>}\n                  className=\"text-blue-600 hover:text-blue-900 font-medium\"\n                >\n                  Review\n                </Link>\n              </td>\n            </tr>\n          ))}\n        </tbody>\n      </table>\n    </div>\n  )\n}\n</code>\n\n<strong>StatusBadge Component</strong>\n\nCreate <code>broker-portal/components/StatusBadge.tsx</code>:\n\n<code>const statusConfig = {\n  submitted: { label: 'Pending', color: 'bg-blue-100 text-blue-800' },\n  under_review: { label: 'Under Review', color: 'bg-yellow-100 text-yellow-800' },\n  needs_changes: { label: 'Changes Requested', color: 'bg-orange-100 text-orange-800' },\n  resubmitted: { label: 'Resubmitted', color: 'bg-blue-100 text-blue-800' },\n  approved: { label: 'Approved', color: 'bg-green-100 text-green-800' },\n  rejected: { label: 'Rejected', color: 'bg-red-100 text-red-800' },\n}\n\nexport function StatusBadge({ status }: { status: string }) {\n  const config = statusConfig[status as keyof typeof statusConfig] || {\n    label: status,\n    color: 'bg-gray-100 text-gray-800',\n  }\n\n  return (\n    <span className={<code>inline-flex px-2.5 py-0.5 rounded-full text-xs font-medium ${config.color}</code>}>\n      {config.label}\n    </span>\n  )\n}\n</code>\n\n---\n\n<strong>Files to Create/Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>broker-portal/app/dashboard/layout.tsx</code> | Dashboard shell layout |\n| <code>broker-portal/app/dashboard/page.tsx</code> | Dashboard overview |\n| <code>broker-portal/app/dashboard/submissions/page.tsx</code> | Submission list |\n| <code>broker-portal/components/Sidebar.tsx</code> | Navigation sidebar |\n| <code>broker-portal/components/Header.tsx</code> | Top header with user menu |\n| <code>broker-portal/components/StatCard.tsx</code> | Statistics card |\n| <code>broker-portal/components/SubmissionList.tsx</code> | Submission table |\n| <code>broker-portal/components/StatusBadge.tsx</code> | Status badge |\n| <code>broker-portal/components/StatusFilter.tsx</code> | Filter buttons |\n| <code>broker-portal/components/RecentSubmissions.tsx</code> | Recent list for dashboard |\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-396: Next.js project setup\n\u2022 BACKLOG-397: Supabase Auth (user context)\n\u2022 BACKLOG-387: Schema (data to display)\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Dashboard layout with sidebar navigation\n\u2610 Stats cards show correct counts\n\u2610 Stats cards link to filtered list\n\u2610 Submission list shows all org submissions\n\u2610 Status filter works correctly\n\u2610 Search by address works\n\u2610 Clicking \"Review\" navigates to detail page\n\u2610 Empty state displayed when no submissions\n\u2610 Loading states for async data\n\u2610 Responsive design (mobile-friendly)\n\n---\n\n<strong>Technical Notes</strong>\n\n<strong>Data Fetching</strong>\n\nUse Server Components for initial data fetch:\n\u2022 No loading spinner needed\n\u2022 SEO friendly\n\u2022 Fast initial paint\n\nFor real-time updates (post-demo), add Supabase Realtime subscriptions.\n\n<strong>Organization Scoping</strong>\n\nAll queries include organization filter:\n<code>.eq('organization_id', membership.organization_id)\n</code>\n\nRLS also enforces this, providing defense in depth.\n\n<strong>User Display</strong>\n\nAgent names come from <code>users.raw_user_meta_data.name</code> (OAuth profile) or email fallback.\n\n<strong>Pagination</strong>\n\nFor demo, load all submissions. Post-demo, add pagination:\n\n<code>const PAGE_SIZE = 20\nconst { data, count } = await supabase\n  .from('transaction_submissions')\n  .select('*', { count: 'exact' })\n  .range(page * PAGE_SIZE, (page + 1) * PAGE_SIZE - 1)\n</code>\n\n---\n\n<strong>Testing Plan</strong>\n\n1. Login as broker, verify dashboard loads\n2. Verify stats show correct counts\n3. Click stat card, verify filtered list\n4. View submission list, verify all columns\n5. Filter by status, verify results\n6. Search by address, verify results\n7. Click \"Review\", verify navigation\n8. Test empty state (no submissions)\n9. Test responsive layout on mobile\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-396: Next.js Setup (dependency)\n\u2022 BACKLOG-397: Supabase Auth (dependency)\n\u2022 BACKLOG-399: Submission Detail (next page)\n\u2022 SPRINT-050: B2B Broker Portal Demo"
  },
  {
    "id": "BACKLOG-399",
    "title": "Portal - Submission Detail View",
    "category": "ui",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-050",
    "est_tokens": "~35K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-399.md](items/BACKLOG-399.md)",
    "description": "<strong>Summary</strong>\n\nCreate the submission detail page where brokers can view complete transaction information, messages, and attachments for compliance review.\n\n---\n\n<strong>Problem Statement</strong>\n\nWhen reviewing a submission, brokers need to:\n1. See transaction details (property, dates, parties)\n2. View all communications (emails, texts)\n3. Download/view attachments\n4. See submission history (versions, previous reviews)\n5. Take review actions (handled in BACKLOG-400)\n\n---\n\n<strong>Proposed Solution</strong>\n\n<strong>Detail Page Structure</strong>\n\nCreate <code>broker-portal/app/dashboard/submissions/[id]/page.tsx</code>:\n\n<code>import { createClient } from '@/lib/supabase/server'\nimport { notFound } from 'next/navigation'\nimport { SubmissionHeader } from '@/components/submission/SubmissionHeader'\nimport { TransactionInfo } from '@/components/submission/TransactionInfo'\nimport { MessageList } from '@/components/submission/MessageList'\nimport { AttachmentList } from '@/components/submission/AttachmentList'\nimport { ReviewActions } from '@/components/submission/ReviewActions'\nimport { SubmissionTimeline } from '@/components/submission/SubmissionTimeline'\n\ninterface PageProps {\n  params: { id: string }\n}\n\nexport default async function SubmissionDetailPage({ params }: PageProps) {\n  const supabase = createClient()\n  \n  // Fetch submission with messages and attachments\n  const { data: submission, error } = await supabase\n    .from('transaction_submissions')\n    .select(<code>\n      *,\n      submitted_by_user:submitted_by (\n        email,\n        raw_user_meta_data\n      ),\n      reviewed_by_user:reviewed_by (\n        email,\n        raw_user_meta_data\n      ),\n      messages:submission_messages (\n        id,\n        channel,\n        direction,\n        subject,\n        body_text,\n        participants,\n        sent_at,\n        has_attachments,\n        attachment_count\n      ),\n      attachments:submission_attachments (\n        id,\n        filename,\n        mime_type,\n        file_size_bytes,\n        storage_path,\n        document_type\n      ),\n      comments:submission_comments (\n        id,\n        content,\n        comment_type,\n        created_at,\n        author:author_id (\n          email,\n          raw_user_meta_data\n        )\n      )\n    </code>)\n    .eq('id', params.id)\n    .single()\n  \n  if (error || !submission) {\n    notFound()\n  }\n  \n  // Get submission history (previous versions)\n  const { data: history } = await supabase\n    .from('transaction_submissions')\n    .select('id, version, status, created_at, reviewed_at, review_notes')\n    .eq('local_transaction_id', submission.local_transaction_id)\n    .eq('organization_id', submission.organization_id)\n    .order('version', { ascending: true })\n  \n  return (\n    <div className=\"space-y-6\">\n      {/* Header with property address and status */}\n      <SubmissionHeader submission={submission} />\n      \n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        {/* Main content: 2 columns */}\n        <div className=\"lg:col-span-2 space-y-6\">\n          {/* Transaction Details */}\n          <TransactionInfo submission={submission} />\n          \n          {/* Messages (Tabs: All, Emails, Texts) */}\n          <MessageList messages={submission.messages} />\n          \n          {/* Attachments */}\n          <AttachmentList attachments={submission.attachments} />\n        </div>\n        \n        {/* Sidebar: 1 column */}\n        <div className=\"space-y-6\">\n          {/* Review Actions (separate task BACKLOG-400) */}\n          <ReviewActions \n            submission={submission} \n            disabled={submission.status === 'approved' || submission.status === 'rejected'}\n          />\n          \n          {/* Timeline / History */}\n          <SubmissionTimeline history={history || []} />\n          \n          {/* Comments */}\n          <CommentsPanel comments={submission.comments} submissionId={submission.id} />\n        </div>\n      </div>\n    </div>\n  )\n}\n</code>\n\n<strong>SubmissionHeader Component</strong>\n\n<code>import { StatusBadge } from '@/components/StatusBadge'\nimport { formatDate } from '@/lib/utils'\nimport { ArrowLeft, Calendar, User } from 'lucide-react'\nimport Link from 'next/link'\n\nexport function SubmissionHeader({ submission }) {\n  return (\n    <div className=\"bg-white rounded-lg shadow p-6\">\n      <div className=\"flex items-center gap-4 mb-4\">\n        <Link\n          href=\"/dashboard/submissions\"\n          className=\"p-2 hover:bg-gray-100 rounded-lg\"\n        >\n          <ArrowLeft className=\"h-5 w-5\" />\n        </Link>\n        <div className=\"flex-1\">\n          <h1 className=\"text-2xl font-bold text-gray-900\">\n            {submission.property_address}\n          </h1>\n          <p className=\"text-gray-500\">\n            {submission.property_city}, {submission.property_state} {submission.property_zip}\n          </p>\n        </div>\n        <StatusBadge status={submission.status} size=\"lg\" />\n      </div>\n      \n      <div className=\"flex items-center gap-6 text-sm text-gray-500\">\n        <div className=\"flex items-center gap-2\">\n          <User className=\"h-4 w-4\" />\n          <span>\n            Submitted by {submission.submitted_by_user?.raw_user_meta_data?.name || \n              submission.submitted_by_user?.email}\n          </span>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Calendar className=\"h-4 w-4\" />\n          <span>Submitted {formatDate(submission.created_at)}</span>\n        </div>\n        {submission.version > 1 && (\n          <span className=\"text-orange-600\">\n            Resubmission (v{submission.version})\n          </span>\n        )}\n      </div>\n    </div>\n  )\n}\n</code>\n\n<strong>TransactionInfo Component</strong>\n\n<code>import { formatCurrency, formatDate } from '@/lib/utils'\nimport { Home, DollarSign, Calendar, Users } from 'lucide-react'\n\nexport function TransactionInfo({ submission }) {\n  return (\n    <div className=\"bg-white rounded-lg shadow\">\n      <div className=\"px-6 py-4 border-b\">\n        <h2 className=\"text-lg font-semibold\">Transaction Details</h2>\n      </div>\n      <div className=\"p-6 grid grid-cols-2 gap-6\">\n        <InfoItem\n          icon={Home}\n          label=\"Transaction Type\"\n          value={capitalize(submission.transaction_type)}\n        />\n        <InfoItem\n          icon={DollarSign}\n          label=\"Listing Price\"\n          value={submission.listing_price ? formatCurrency(submission.listing_price) : 'N/A'}\n        />\n        <InfoItem\n          icon={DollarSign}\n          label=\"Sale Price\"\n          value={submission.sale_price ? formatCurrency(submission.sale_price) : 'N/A'}\n        />\n        <InfoItem\n          icon={Calendar}\n          label=\"Transaction Period\"\n          value={<code>${formatDate(submission.started_at)} - ${formatDate(submission.closed_at) || 'Ongoing'}</code>}\n        />\n        <InfoItem\n          icon={Users}\n          label=\"Communications\"\n          value={<code>${submission.message_count} messages, ${submission.attachment_count} attachments</code>}\n        />\n      </div>\n    </div>\n  )\n}\n</code>\n\n<strong>MessageList Component</strong>\n\n<code>'use client'\n\nimport { useState } from 'react'\nimport { MessageCard } from './MessageCard'\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/Tabs'\n\nexport function MessageList({ messages }) {\n  const [filter, setFilter] = useState('all')\n  \n  const filteredMessages = messages.filter(msg => {\n    if (filter === 'all') return true\n    if (filter === 'email') return msg.channel === 'email'\n    if (filter === 'text') return msg.channel === 'sms' || msg.channel === 'imessage'\n    return true\n  })\n  \n  const emailCount = messages.filter(m => m.channel === 'email').length\n  const textCount = messages.filter(m => m.channel !== 'email').length\n  \n  return (\n    <div className=\"bg-white rounded-lg shadow\">\n      <div className=\"px-6 py-4 border-b\">\n        <Tabs value={filter} onValueChange={setFilter}>\n          <TabsList>\n            <TabsTrigger value=\"all\">All ({messages.length})</TabsTrigger>\n            <TabsTrigger value=\"email\">Emails ({emailCount})</TabsTrigger>\n            <TabsTrigger value=\"text\">Texts ({textCount})</TabsTrigger>\n          </TabsList>\n        </Tabs>\n      </div>\n      \n      <div className=\"p-6 space-y-4 max-h-[600px] overflow-y-auto\">\n        {filteredMessages.length === 0 ? (\n          <p className=\"text-center text-gray-500 py-8\">No messages</p>\n        ) : (\n          filteredMessages.map(message => (\n            <MessageCard key={message.id} message={message} />\n          ))\n        )}\n      </div>\n    </div>\n  )\n}\n</code>\n\n<strong>MessageCard Component</strong>\n\n<code>import { Mail, MessageSquare, ArrowUp, ArrowDown } from 'lucide-react'\nimport { formatDateTime } from '@/lib/utils'\n\nexport function MessageCard({ message }) {\n  const isEmail = message.channel === 'email'\n  const Icon = isEmail ? Mail : MessageSquare\n  const DirectionIcon = message.direction === 'outbound' ? ArrowUp : ArrowDown\n  \n  return (\n    <div className=\"border rounded-lg p-4 hover:bg-gray-50\">\n      <div className=\"flex items-start gap-3\">\n        <div className={<code>p-2 rounded-lg ${isEmail ? 'bg-blue-100' : 'bg-green-100'}</code>}>\n          <Icon className={<code>h-4 w-4 ${isEmail ? 'text-blue-600' : 'text-green-600'}</code>} />\n        </div>\n        \n        <div className=\"flex-1 min-w-0\">\n          <div className=\"flex items-center gap-2 mb-1\">\n            <DirectionIcon className=\"h-3 w-3 text-gray-400\" />\n            <span className=\"text-sm font-medium\">\n              {message.participants?.from || 'Unknown'}\n            </span>\n            <span className=\"text-xs text-gray-400\">\n              {formatDateTime(message.sent_at)}\n            </span>\n          </div>\n          \n          {message.subject && (\n            <p className=\"font-medium text-gray-900 mb-1\">{message.subject}</p>\n          )}\n          \n          <p className=\"text-sm text-gray-600 line-clamp-3\">\n            {message.body_text}\n          </p>\n          \n          {message.has_attachments && (\n            <div className=\"mt-2 text-xs text-gray-500\">\n              {message.attachment_count} attachment(s)\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  )\n}\n</code>\n\n---\n\n<strong>Files to Create/Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>broker-portal/app/dashboard/submissions/[id]/page.tsx</code> | Detail page |\n| <code>broker-portal/components/submission/SubmissionHeader.tsx</code> | Header component |\n| <code>broker-portal/components/submission/TransactionInfo.tsx</code> | Transaction details |\n| <code>broker-portal/components/submission/MessageList.tsx</code> | Message list with tabs |\n| <code>broker-portal/components/submission/MessageCard.tsx</code> | Individual message |\n| <code>broker-portal/components/submission/AttachmentList.tsx</code> | Attachment grid |\n| <code>broker-portal/components/submission/SubmissionTimeline.tsx</code> | Version history |\n| <code>broker-portal/components/submission/CommentsPanel.tsx</code> | Broker comments |\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-396: Next.js setup\n\u2022 BACKLOG-397: Auth (for user context)\n\u2022 BACKLOG-398: Dashboard/List (navigation)\n\u2022 BACKLOG-401: Message viewer (for full message modal)\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Detail page loads with all submission data\n\u2610 Property address and status displayed prominently\n\u2610 Transaction details section shows all fields\n\u2610 Message list with filter tabs (All, Emails, Texts)\n\u2610 Messages display sender, date, subject, preview\n\u2610 Attachment list shows all files\n\u2610 Timeline shows submission history\n\u2610 Back navigation to list works\n\u2610 404 for invalid submission ID\n\u2610 Loading states for data fetch\n\n---\n\n<strong>Technical Notes</strong>\n\n<strong>Data Relationships</strong>\n\nSingle query fetches all related data:\n\u2022 <code>submission_messages</code> - All communications\n\u2022 <code>submission_attachments</code> - All documents\n\u2022 <code>submission_comments</code> - Broker feedback\n\u2022 <code>submitted_by_user</code> - Agent info (join on users)\n\u2022 <code>reviewed_by_user</code> - Reviewer info (join on users)\n\n<strong>Message Display</strong>\n\nMessages are sorted by <code>sent_at</code> descending (newest first).\n\nFor long messages, show first 200 chars with \"Show more\" (client-side).\n\n<strong>Attachment URLs</strong>\n\nAttachments use Supabase Storage. Generate signed URLs for viewing:\n\n<code>const { data: { signedUrl } } = await supabase.storage\n  .from('submission-attachments')\n  .createSignedUrl(attachment.storage_path, 3600) // 1 hour\n</code>\n\n<strong>Timeline Component</strong>\n\nShows version history for resubmissions:\n\n<code>v1 - Submitted Jan 15\nv1 - Changes requested Jan 16\nv2 - Resubmitted Jan 17\nv2 - Approved Jan 18\n</code>\n\n---\n\n<strong>Testing Plan</strong>\n\n1. Navigate to submission detail from list\n2. Verify header shows correct address and status\n3. Verify transaction details are accurate\n4. Filter messages by type\n5. Expand message to see full content\n6. View attachment list\n7. View timeline for resubmitted transactions\n8. Test 404 with invalid ID\n9. Test loading states\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-398: Dashboard/List (navigation)\n\u2022 BACKLOG-400: Review Actions (sidebar actions)\n\u2022 BACKLOG-401: Message Viewer (full message modal)\n\u2022 SPRINT-050: B2B Broker Portal Demo"
  },
  {
    "id": "BACKLOG-400",
    "title": "Portal - Review Actions (Approve/Reject/Changes)",
    "category": "feature",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-050",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-400.md](items/BACKLOG-400.md)",
    "description": "<strong>Summary</strong>\n\nImplement the review actions panel that allows brokers to approve, reject, or request changes on transaction submissions.\n\n---\n\n<strong>Problem Statement</strong>\n\nAfter reviewing a submission, brokers need to:\n1. Approve submissions that pass compliance\n2. Reject submissions with serious issues\n3. Request changes with detailed feedback\n4. Update submission status in the database\n5. Trigger status sync to the agent's desktop app\n\n---\n\n<strong>Proposed Solution</strong>\n\n<strong>ReviewActions Component</strong>\n\nCreate <code>broker-portal/components/submission/ReviewActions.tsx</code>:\n\n<code>'use client'\n\nimport { useState } from 'react'\nimport { useRouter } from 'next/navigation'\nimport { createClient } from '@/lib/supabase/client'\nimport { Check, X, AlertTriangle, Loader2 } from 'lucide-react'\n\ninterface ReviewActionsProps {\n  submission: {\n    id: string\n    status: string\n    organization_id: string\n  }\n  disabled?: boolean\n}\n\nexport function ReviewActions({ submission, disabled }: ReviewActionsProps) {\n  const [action, setAction] = useState<'approve' | 'reject' | 'changes' | null>(null)\n  const [notes, setNotes] = useState('')\n  const [loading, setLoading] = useState(false)\n  const router = useRouter()\n  const supabase = createClient()\n\n  const handleSubmitReview = async () => {\n    if (!action) return\n    \n    setLoading(true)\n    try {\n      const { data: { user } } = await supabase.auth.getUser()\n      \n      const statusMap = {\n        approve: 'approved',\n        reject: 'rejected',\n        changes: 'needs_changes',\n      }\n      \n      const { error } = await supabase\n        .from('transaction_submissions')\n        .update({\n          status: statusMap[action],\n          reviewed_by: user?.id,\n          reviewed_at: new Date().toISOString(),\n          review_notes: notes || null,\n        })\n        .eq('id', submission.id)\n      \n      if (error) throw error\n      \n      // Optionally add a comment for the record\n      if (notes) {\n        await supabase.from('submission_comments').insert({\n          submission_id: submission.id,\n          author_id: user?.id,\n          content: notes,\n          comment_type: action === 'approve' ? 'approval' : \n                        action === 'reject' ? 'rejection' : 'feedback',\n        })\n      }\n      \n      // Refresh page to show updated status\n      router.refresh()\n      \n      // Reset form\n      setAction(null)\n      setNotes('')\n      \n    } catch (error) {\n      console.error('Review error:', error)\n      alert('Failed to submit review. Please try again.')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  if (disabled) {\n    return (\n      <div className=\"bg-white rounded-lg shadow p-6\">\n        <h3 className=\"font-semibold mb-4\">Review Complete</h3>\n        <p className=\"text-sm text-gray-500\">\n          This submission has been {submission.status}.\n        </p>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"bg-white rounded-lg shadow p-6\">\n      <h3 className=\"font-semibold mb-4\">Review Actions</h3>\n      \n      {/* Action Buttons */}\n      <div className=\"space-y-2 mb-4\">\n        <ActionButton\n          icon={Check}\n          label=\"Approve\"\n          description=\"Transaction audit passes compliance\"\n          selected={action === 'approve'}\n          onClick={() => setAction('approve')}\n          color=\"green\"\n        />\n        <ActionButton\n          icon={AlertTriangle}\n          label=\"Request Changes\"\n          description=\"Agent needs to fix issues and resubmit\"\n          selected={action === 'changes'}\n          onClick={() => setAction('changes')}\n          color=\"orange\"\n        />\n        <ActionButton\n          icon={X}\n          label=\"Reject\"\n          description=\"Submission cannot be approved\"\n          selected={action === 'reject'}\n          onClick={() => setAction('reject')}\n          color=\"red\"\n        />\n      </div>\n      \n      {/* Notes Field */}\n      {action && (\n        <div className=\"space-y-4\">\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              {action === 'approve' ? 'Approval Notes (optional)' :\n               action === 'changes' ? 'What changes are needed?' :\n               'Rejection Reason'}\n            </label>\n            <textarea\n              value={notes}\n              onChange={(e) => setNotes(e.target.value)}\n              className=\"w-full border rounded-lg p-3 text-sm\"\n              rows={4}\n              placeholder={\n                action === 'approve' ? 'Add any notes for the record...' :\n                action === 'changes' ? 'Describe what needs to be fixed...' :\n                'Explain why this submission is being rejected...'\n              }\n              required={action !== 'approve'}\n            />\n          </div>\n          \n          <div className=\"flex gap-2\">\n            <button\n              onClick={handleSubmitReview}\n              disabled={loading || (action !== 'approve' && !notes.trim())}\n              className={<code>flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-white font-medium disabled:opacity-50 ${\n                action === 'approve' ? 'bg-green-600 hover:bg-green-700' :\n                action === 'changes' ? 'bg-orange-600 hover:bg-orange-700' :\n                'bg-red-600 hover:bg-red-700'\n              }</code>}\n            >\n              {loading ? (\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n              ) : (\n                <>\n                  {action === 'approve' && <Check className=\"h-4 w-4\" />}\n                  {action === 'changes' && <AlertTriangle className=\"h-4 w-4\" />}\n                  {action === 'reject' && <X className=\"h-4 w-4\" />}\n                  <span>\n                    {action === 'approve' ? 'Approve Submission' :\n                     action === 'changes' ? 'Request Changes' :\n                     'Reject Submission'}\n                  </span>\n                </>\n              )}\n            </button>\n            <button\n              onClick={() => {\n                setAction(null)\n                setNotes('')\n              }}\n              className=\"px-4 py-2 border rounded-lg hover:bg-gray-50\"\n            >\n              Cancel\n            </button>\n          </div>\n        </div>\n      )}\n    </div>\n  )\n}\n\nfunction ActionButton({ icon: Icon, label, description, selected, onClick, color }) {\n  const colors = {\n    green: 'border-green-500 bg-green-50',\n    orange: 'border-orange-500 bg-orange-50',\n    red: 'border-red-500 bg-red-50',\n  }\n  \n  return (\n    <button\n      onClick={onClick}\n      className={<code>w-full text-left p-3 rounded-lg border-2 transition ${\n        selected ? colors[color] : 'border-gray-200 hover:border-gray-300'\n      }</code>}\n    >\n      <div className=\"flex items-center gap-3\">\n        <Icon className={<code>h-5 w-5 ${\n          color === 'green' ? 'text-green-600' :\n          color === 'orange' ? 'text-orange-600' :\n          'text-red-600'\n        }</code>} />\n        <div>\n          <div className=\"font-medium\">{label}</div>\n          <div className=\"text-xs text-gray-500\">{description}</div>\n        </div>\n      </div>\n    </button>\n  )\n}\n</code>\n\n<strong>Confirmation Dialog</strong>\n\nFor reject action, add a confirmation step:\n\n<code>'use client'\n\nimport { useState } from 'react'\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/Dialog'\n\nfunction ConfirmRejectDialog({ open, onClose, onConfirm, notes }) {\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent>\n        <DialogHeader>\n          <DialogTitle>Confirm Rejection</DialogTitle>\n          <DialogDescription>\n            Are you sure you want to reject this submission? This action is final.\n          </DialogDescription>\n        </DialogHeader>\n        \n        <div className=\"py-4\">\n          <p className=\"text-sm text-gray-600 mb-2\">Rejection reason:</p>\n          <p className=\"text-sm bg-gray-100 p-3 rounded\">{notes}</p>\n        </div>\n        \n        <div className=\"flex justify-end gap-2\">\n          <button\n            onClick={onClose}\n            className=\"px-4 py-2 border rounded-lg hover:bg-gray-50\"\n          >\n            Cancel\n          </button>\n          <button\n            onClick={onConfirm}\n            className=\"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700\"\n          >\n            Yes, Reject Submission\n          </button>\n        </div>\n      </DialogContent>\n    </Dialog>\n  )\n}\n</code>\n\n<strong>Quick Review from List</strong>\n\nAdd quick actions to the submission list for common actions:\n\n<code>// In SubmissionList.tsx\n\n{submission.status === 'submitted' && (\n  <div className=\"flex gap-2\">\n    <button\n      onClick={() => handleQuickApprove(submission.id)}\n      className=\"p-1 text-green-600 hover:bg-green-50 rounded\"\n      title=\"Quick Approve\"\n    >\n      <Check className=\"h-4 w-4\" />\n    </button>\n    <Link\n      href={<code>/dashboard/submissions/${submission.id}</code>}\n      className=\"p-1 text-blue-600 hover:bg-blue-50 rounded\"\n      title=\"Review Details\"\n    >\n      <Eye className=\"h-4 w-4\" />\n    </Link>\n  </div>\n)}\n</code>\n\n---\n\n<strong>Files to Create/Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>broker-portal/components/submission/ReviewActions.tsx</code> | Main actions panel |\n| <code>broker-portal/components/submission/ConfirmDialog.tsx</code> | Confirmation modal |\n| <code>broker-portal/components/SubmissionList.tsx</code> | Quick action buttons |\n| <code>broker-portal/app/api/submissions/[id]/review/route.ts</code> | Optional: API route for review |\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-399: Submission Detail (displays this component)\n\u2022 BACKLOG-397: Auth (user context for reviewed_by)\n\u2022 BACKLOG-387: Schema (status field, comments table)\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Three action buttons: Approve, Request Changes, Reject\n\u2610 Selecting action shows notes field\n\u2610 Approve works with optional notes\n\u2610 Request Changes requires notes (minimum 10 chars)\n\u2610 Reject shows confirmation dialog\n\u2610 Reject requires notes\n\u2610 Status updates in database after action\n\u2610 reviewed_by and reviewed_at populated\n\u2610 review_notes saved\n\u2610 Comment created for record\n\u2610 Page refreshes to show new status\n\u2610 Actions disabled for terminal states\n\u2610 Loading states during submission\n\n---\n\n<strong>Technical Notes</strong>\n\n<strong>Status Transitions</strong>\n\nValid transitions:\n\u2022 <code>submitted</code> -> <code>under_review</code> (implicit on open)\n\u2022 <code>submitted</code> -> <code>approved</code>\n\u2022 <code>submitted</code> -> <code>needs_changes</code>\n\u2022 <code>submitted</code> -> <code>rejected</code>\n\u2022 <code>under_review</code> -> <code>approved</code>\n\u2022 <code>under_review</code> -> <code>needs_changes</code>\n\u2022 <code>under_review</code> -> <code>rejected</code>\n\u2022 <code>resubmitted</code> -> <code>approved</code>\n\u2022 <code>resubmitted</code> -> <code>needs_changes</code>\n\u2022 <code>resubmitted</code> -> <code>rejected</code>\n\nTerminal states (no further actions):\n\u2022 <code>approved</code>\n\u2022 <code>rejected</code>\n\n<strong>Under Review Transition</strong>\n\nOptionally mark as \"under_review\" when broker first opens:\n\n<code>// In detail page server component\nif (submission.status === 'submitted') {\n  await supabase\n    .from('transaction_submissions')\n    .update({ status: 'under_review' })\n    .eq('id', submission.id)\n}\n</code>\n\nFor demo, this is optional - direct to action is fine.\n\n<strong>Validation</strong>\n\n| Action | Notes Required | Validation |\n|--------|----------------|------------|\n| Approve | No | None |\n| Request Changes | Yes | Min 10 chars |\n| Reject | Yes | Min 10 chars, confirmation |\n\n<strong>RLS for Updates</strong>\n\nBrokers can update status because RLS policy allows:\n\n<code>CREATE POLICY \"Brokers review submissions\"\n  ON transaction_submissions FOR UPDATE\n  USING (\n    organization_id IN (\n      SELECT organization_id FROM organization_members\n      WHERE user_id = auth.uid() AND role IN ('broker', 'admin')\n    )\n  );\n</code>\n\n---\n\n<strong>Testing Plan</strong>\n\n1. Open submission as broker\n2. Click Approve, verify no notes required\n3. Submit approval, verify status changes\n4. Open different submission\n5. Click Request Changes, try submit without notes\n6. Add notes, submit, verify status and notes saved\n7. Open different submission\n8. Click Reject, try submit without notes\n9. Add notes, verify confirmation dialog\n10. Confirm rejection, verify status and notes\n11. Verify approved/rejected submissions show disabled state\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-399: Submission Detail (displays this)\n\u2022 BACKLOG-395: Status Sync (agent sees result)\n\u2022 SPRINT-050: B2B Broker Portal Demo"
  },
  {
    "id": "BACKLOG-401",
    "title": "Portal - Message & Attachment Viewer",
    "category": "ui",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-050",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-401.md](items/BACKLOG-401.md)",
    "description": "<strong>Summary</strong>\n\nCreate modal components for viewing full message content and downloading/previewing attachments in the broker portal.\n\n---\n\n<strong>Problem Statement</strong>\n\nIn the submission detail view, messages show only a preview. Brokers need to:\n1. View full message content (especially long emails)\n2. See complete participant lists\n3. View attachment previews (images, PDFs)\n4. Download attachments for offline review\n\n---\n\n<strong>Proposed Solution</strong>\n\n<strong>MessageViewerModal</strong>\n\nCreate <code>broker-portal/components/submission/MessageViewerModal.tsx</code>:\n\n<code>'use client'\n\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/Dialog'\nimport { Mail, MessageSquare, ArrowUp, ArrowDown, Paperclip } from 'lucide-react'\nimport { formatDateTime } from '@/lib/utils'\n\ninterface Message {\n  id: string\n  channel: 'email' | 'sms' | 'imessage'\n  direction: 'inbound' | 'outbound'\n  subject: string | null\n  body_text: string | null\n  participants: {\n    from?: string\n    to?: string[]\n    cc?: string[]\n    bcc?: string[]\n  }\n  sent_at: string | null\n  has_attachments: boolean\n  attachment_count: number\n}\n\ninterface MessageViewerModalProps {\n  message: Message | null\n  open: boolean\n  onClose: () => void\n  attachments?: Array<{\n    id: string\n    filename: string\n    mime_type: string\n    storage_path: string\n  }>\n}\n\nexport function MessageViewerModal({ message, open, onClose, attachments }: MessageViewerModalProps) {\n  if (!message) return null\n  \n  const isEmail = message.channel === 'email'\n  \n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-3xl max-h-[80vh] overflow-hidden flex flex-col\">\n        <DialogHeader>\n          <div className=\"flex items-center gap-3\">\n            <div className={<code>p-2 rounded-lg ${isEmail ? 'bg-blue-100' : 'bg-green-100'}</code>}>\n              {isEmail ? (\n                <Mail className={<code>h-5 w-5 text-blue-600</code>} />\n              ) : (\n                <MessageSquare className={<code>h-5 w-5 text-green-600</code>} />\n              )}\n            </div>\n            <div>\n              <DialogTitle className=\"text-left\">\n                {isEmail ? (message.subject || 'No Subject') : 'Text Message'}\n              </DialogTitle>\n              <p className=\"text-sm text-gray-500\">\n                {formatDateTime(message.sent_at)}\n              </p>\n            </div>\n          </div>\n        </DialogHeader>\n        \n        {/* Participants */}\n        {isEmail && (\n          <div className=\"border-y py-3 space-y-1 text-sm\">\n            <ParticipantRow label=\"From\" value={message.participants?.from} />\n            <ParticipantRow label=\"To\" value={message.participants?.to?.join(', ')} />\n            {message.participants?.cc?.length > 0 && (\n              <ParticipantRow label=\"Cc\" value={message.participants.cc.join(', ')} />\n            )}\n          </div>\n        )}\n        \n        {/* For text messages, show participant */}\n        {!isEmail && (\n          <div className=\"border-y py-3 text-sm\">\n            <div className=\"flex items-center gap-2\">\n              {message.direction === 'outbound' ? (\n                <ArrowUp className=\"h-4 w-4 text-gray-400\" />\n              ) : (\n                <ArrowDown className=\"h-4 w-4 text-gray-400\" />\n              )}\n              <span>\n                {message.direction === 'outbound' ? 'To: ' : 'From: '}\n                {message.participants?.from || message.participants?.to?.[0]}\n              </span>\n            </div>\n          </div>\n        )}\n        \n        {/* Message Body */}\n        <div className=\"flex-1 overflow-y-auto py-4\">\n          <div className={<code>whitespace-pre-wrap ${isEmail ? 'text-sm' : 'text-base'}</code>}>\n            {message.body_text || 'No content'}\n          </div>\n        </div>\n        \n        {/* Attachments */}\n        {message.has_attachments && attachments && attachments.length > 0 && (\n          <div className=\"border-t pt-4\">\n            <h4 className=\"text-sm font-medium flex items-center gap-2 mb-2\">\n              <Paperclip className=\"h-4 w-4\" />\n              Attachments ({attachments.length})\n            </h4>\n            <div className=\"flex flex-wrap gap-2\">\n              {attachments.map(att => (\n                <AttachmentChip key={att.id} attachment={att} />\n              ))}\n            </div>\n          </div>\n        )}\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nfunction ParticipantRow({ label, value }: { label: string; value?: string }) {\n  if (!value) return null\n  return (\n    <div className=\"flex\">\n      <span className=\"w-12 text-gray-500\">{label}:</span>\n      <span className=\"text-gray-900\">{value}</span>\n    </div>\n  )\n}\n\nfunction AttachmentChip({ attachment }) {\n  return (\n    <button\n      className=\"flex items-center gap-2 px-3 py-1.5 bg-gray-100 rounded-lg text-sm hover:bg-gray-200\"\n    >\n      <Paperclip className=\"h-3 w-3\" />\n      {attachment.filename}\n    </button>\n  )\n}\n</code>\n\n<strong>AttachmentViewerModal</strong>\n\nCreate <code>broker-portal/components/submission/AttachmentViewerModal.tsx</code>:\n\n<code>'use client'\n\nimport { useState, useEffect } from 'react'\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/Dialog'\nimport { Download, FileText, Image, X, Loader2 } from 'lucide-react'\nimport { createClient } from '@/lib/supabase/client'\n\ninterface Attachment {\n  id: string\n  filename: string\n  mime_type: string | null\n  file_size_bytes: number | null\n  storage_path: string\n}\n\ninterface AttachmentViewerModalProps {\n  attachment: Attachment | null\n  open: boolean\n  onClose: () => void\n}\n\nexport function AttachmentViewerModal({ attachment, open, onClose }: AttachmentViewerModalProps) {\n  const [signedUrl, setSignedUrl] = useState<string | null>(null)\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState<string | null>(null)\n  const supabase = createClient()\n  \n  useEffect(() => {\n    if (!attachment || !open) return\n    \n    const fetchUrl = async () => {\n      setLoading(true)\n      setError(null)\n      \n      try {\n        const { data, error } = await supabase.storage\n          .from('submission-attachments')\n          .createSignedUrl(attachment.storage_path, 3600) // 1 hour\n        \n        if (error) throw error\n        setSignedUrl(data.signedUrl)\n      } catch (e) {\n        setError('Failed to load attachment')\n        console.error(e)\n      } finally {\n        setLoading(false)\n      }\n    }\n    \n    fetchUrl()\n  }, [attachment, open])\n  \n  if (!attachment) return null\n  \n  const isImage = attachment.mime_type?.startsWith('image/')\n  const isPdf = attachment.mime_type === 'application/pdf'\n  const canPreview = isImage || isPdf\n  \n  const handleDownload = () => {\n    if (signedUrl) {\n      window.open(signedUrl, '_blank')\n    }\n  }\n  \n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-hidden flex flex-col\">\n        <DialogHeader className=\"flex-row items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            {isImage ? (\n              <Image className=\"h-5 w-5 text-blue-600\" />\n            ) : (\n              <FileText className=\"h-5 w-5 text-gray-600\" />\n            )}\n            <DialogTitle>{attachment.filename}</DialogTitle>\n          </div>\n          <button\n            onClick={handleDownload}\n            disabled={!signedUrl}\n            className=\"flex items-center gap-2 px-3 py-1.5 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 disabled:opacity-50\"\n          >\n            <Download className=\"h-4 w-4\" />\n            Download\n          </button>\n        </DialogHeader>\n        \n        <div className=\"flex-1 overflow-auto bg-gray-100 rounded-lg\">\n          {loading && (\n            <div className=\"flex items-center justify-center h-64\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-gray-400\" />\n            </div>\n          )}\n          \n          {error && (\n            <div className=\"flex items-center justify-center h-64 text-red-500\">\n              {error}\n            </div>\n          )}\n          \n          {signedUrl && !loading && (\n            <>\n              {isImage && (\n                <img\n                  src={signedUrl}\n                  alt={attachment.filename}\n                  className=\"max-w-full h-auto mx-auto\"\n                />\n              )}\n              \n              {isPdf && (\n                <iframe\n                  src={signedUrl}\n                  className=\"w-full h-[70vh]\"\n                  title={attachment.filename}\n                />\n              )}\n              \n              {!canPreview && (\n                <div className=\"flex flex-col items-center justify-center h-64 text-gray-500\">\n                  <FileText className=\"h-16 w-16 mb-4\" />\n                  <p>Preview not available for this file type</p>\n                  <p className=\"text-sm\">{attachment.mime_type}</p>\n                  <button\n                    onClick={handleDownload}\n                    className=\"mt-4 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300\"\n                  >\n                    Download to view\n                  </button>\n                </div>\n              )}\n            </>\n          )}\n        </div>\n        \n        {/* File info */}\n        <div className=\"text-sm text-gray-500 pt-2\">\n          {attachment.mime_type} | {formatFileSize(attachment.file_size_bytes)}\n        </div>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nfunction formatFileSize(bytes: number | null): string {\n  if (!bytes) return 'Unknown size'\n  if (bytes < 1024) return <code>${bytes} B</code>\n  if (bytes < 1024 * 1024) return <code>${(bytes / 1024).toFixed(1)} KB</code>\n  return <code>${(bytes / (1024 * 1024)).toFixed(1)} MB</code>\n}\n</code>\n\n<strong>AttachmentList Component</strong>\n\nCreate <code>broker-portal/components/submission/AttachmentList.tsx</code>:\n\n<code>'use client'\n\nimport { useState } from 'react'\nimport { FileText, Image, File, Download } from 'lucide-react'\nimport { AttachmentViewerModal } from './AttachmentViewerModal'\nimport { formatFileSize } from '@/lib/utils'\n\ninterface Attachment {\n  id: string\n  filename: string\n  mime_type: string | null\n  file_size_bytes: number | null\n  storage_path: string\n  document_type: string | null\n}\n\nexport function AttachmentList({ attachments }: { attachments: Attachment[] }) {\n  const [selectedAttachment, setSelectedAttachment] = useState<Attachment | null>(null)\n  \n  const getIcon = (mimeType: string | null) => {\n    if (mimeType?.startsWith('image/')) return Image\n    if (mimeType?.includes('pdf')) return FileText\n    return File\n  }\n  \n  if (attachments.length === 0) {\n    return (\n      <div className=\"bg-white rounded-lg shadow p-6 text-center text-gray-500\">\n        No attachments\n      </div>\n    )\n  }\n  \n  return (\n    <>\n      <div className=\"bg-white rounded-lg shadow\">\n        <div className=\"px-6 py-4 border-b\">\n          <h2 className=\"text-lg font-semibold\">\n            Attachments ({attachments.length})\n          </h2>\n        </div>\n        \n        <div className=\"p-6 grid grid-cols-2 md:grid-cols-3 gap-4\">\n          {attachments.map(attachment => {\n            const Icon = getIcon(attachment.mime_type)\n            \n            return (\n              <button\n                key={attachment.id}\n                onClick={() => setSelectedAttachment(attachment)}\n                className=\"flex items-center gap-3 p-3 border rounded-lg hover:bg-gray-50 text-left\"\n              >\n                <div className=\"p-2 bg-gray-100 rounded\">\n                  <Icon className=\"h-5 w-5 text-gray-600\" />\n                </div>\n                <div className=\"flex-1 min-w-0\">\n                  <p className=\"font-medium text-sm truncate\">\n                    {attachment.filename}\n                  </p>\n                  <p className=\"text-xs text-gray-500\">\n                    {formatFileSize(attachment.file_size_bytes)}\n                  </p>\n                </div>\n              </button>\n            )\n          })}\n        </div>\n      </div>\n      \n      <AttachmentViewerModal\n        attachment={selectedAttachment}\n        open={!!selectedAttachment}\n        onClose={() => setSelectedAttachment(null)}\n      />\n    </>\n  )\n}\n</code>\n\n<strong>Integration with MessageCard</strong>\n\nUpdate MessageCard to open viewer:\n\n<code>// In MessageCard.tsx\nconst [showViewer, setShowViewer] = useState(false)\n\nreturn (\n  <>\n    <div \n      className=\"border rounded-lg p-4 hover:bg-gray-50 cursor-pointer\"\n      onClick={() => setShowViewer(true)}\n    >\n      {/* ... existing content ... */}\n    </div>\n    \n    <MessageViewerModal\n      message={message}\n      open={showViewer}\n      onClose={() => setShowViewer(false)}\n      attachments={attachments}\n    />\n  </>\n)\n</code>\n\n---\n\n<strong>Files to Create/Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>broker-portal/components/submission/MessageViewerModal.tsx</code> | Full message viewer |\n| <code>broker-portal/components/submission/AttachmentViewerModal.tsx</code> | Attachment preview |\n| <code>broker-portal/components/submission/AttachmentList.tsx</code> | Attachment grid |\n| <code>broker-portal/components/submission/MessageCard.tsx</code> | Add click to expand |\n| <code>broker-portal/components/submission/MessageList.tsx</code> | Pass attachments context |\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-396: Next.js setup\n\u2022 BACKLOG-399: Submission Detail (uses these components)\n\u2022 BACKLOG-393: Attachment upload (created storage paths)\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Clicking message opens full viewer modal\n\u2610 Full message shows complete body text\n\u2610 Email shows From, To, Cc fields\n\u2610 Text messages show direction indicator\n\u2610 Modal shows message attachments if any\n\u2610 Clicking attachment opens preview modal\n\u2610 Images display inline in preview\n\u2610 PDFs display in iframe preview\n\u2610 Other files show download prompt\n\u2610 Download button works for all file types\n\u2610 File size displayed correctly\n\u2610 Loading states while fetching signed URLs\n\u2610 Error handling for failed loads\n\n---\n\n<strong>Technical Notes</strong>\n\n<strong>Signed URLs</strong>\n\nSupabase Storage files are private. Generate signed URLs with expiry:\n\n<code>const { data, error } = await supabase.storage\n  .from('submission-attachments')\n  .createSignedUrl(storagePath, 3600) // 1 hour expiry\n</code>\n\n<strong>PDF Preview</strong>\n\nModern browsers support PDF in iframe. For older browsers, fall back to download.\n\n<strong>Image Optimization</strong>\n\nFor demo, load images directly. Post-demo, consider:\n\u2022 Thumbnail generation (Supabase Storage Transformations)\n\u2022 Lazy loading for large attachment lists\n\u2022 Image compression\n\n<strong>Content Security</strong>\n\nSigned URLs include auth token. Don't expose in logs. URLs expire after 1 hour.\n\n<strong>Mobile Responsiveness</strong>\n\nModals should be:\n\u2022 Full-screen on mobile\n\u2022 Max-width constrained on desktop\n\u2022 Scrollable for long content\n\n---\n\n<strong>Testing Plan</strong>\n\n1. Click message card, verify modal opens\n2. Verify email shows all participant fields\n3. Verify text shows direction\n4. View long message, verify scrolling\n5. Click attachment from message\n6. View image attachment preview\n7. View PDF attachment preview\n8. Try downloading non-previewable file\n9. Test download button\n10. Test modal close (X, escape, backdrop)\n11. Test error state (invalid storage path)\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-399: Submission Detail (uses these)\n\u2022 BACKLOG-393: Attachment Upload (creates files)\n\u2022 SPRINT-050: B2B Broker Portal Demo"
  },
  {
    "id": "BACKLOG-402",
    "title": "File Size Limits per Plan Tier",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-402.md](items/BACKLOG-402.md)",
    "description": "<strong>Summary</strong>\n\nImplement file size limits for attachment uploads based on organization plan tier.\n\n---\n\n<strong>Problem Statement</strong>\n\nCurrently, there are no file size limits on uploads to Supabase Storage. This could lead to:\n\u2022 Storage cost overruns\n\u2022 Abuse by free-tier users\n\u2022 Slow upload experiences without feedback\n\n---\n\n<strong>Proposed Solution</strong>\n\n<strong>Plan-Based Limits</strong>\n\n| Plan | Per-File Limit | Per-Submission Limit |\n|------|----------------|---------------------|\n| Free/Trial | 25 MB | 100 MB |\n| Pro | 100 MB | 500 MB |\n| Enterprise | 500 MB | Unlimited |\n\n<strong>Implementation</strong>\n\n1. **Desktop App**: Check file size before upload, show error if exceeds limit\n2. **Supabase Storage Policy**: Add size check in RLS policy (if supported)\n3. **Portal**: Display limit in UI, show progress with remaining quota\n\n<code>// Before upload\nconst org = await getOrganization(orgId);\nconst maxFileSize = getMaxFileSize(org.plan); // returns bytes\n\nif (file.size > maxFileSize) {\n  throw new Error(<code>File exceeds ${formatBytes(maxFileSize)} limit for ${org.plan} plan</code>);\n}\n</code>\n\n<strong>UI Feedback</strong>\n\n\u2022 Show file size next to each attachment\n\u2022 Warning when approaching limit\n\u2022 Upgrade prompt when limit exceeded\n\n---\n\n<strong>Files to Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>electron/services/submissionService.ts</code> | Add size validation before upload |\n| <code>broker-portal/components/AttachmentUpload.tsx</code> | Add size validation |\n| <code>shared/constants/plans.ts</code> | Define limits per plan |\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Free/trial users cannot upload files > 25MB\n\u2610 Pro users cannot upload files > 100MB\n\u2610 Clear error message shows limit and current plan\n\u2610 Upgrade CTA shown when limit exceeded\n\u2610 Existing large files still accessible (grandfathered)\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-403: Malware Scanning\n\u2022 SPRINT-050: B2B Broker Portal (parent feature)"
  },
  {
    "id": "BACKLOG-403",
    "title": "Malware Scanning on Upload",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-403.md](items/BACKLOG-403.md)",
    "description": "<strong>Summary</strong>\n\nScan all uploaded attachments for malware before storing them. Quarantine or reject infected files.\n\n---\n\n<strong>Problem Statement</strong>\n\nAgents upload files from various sources (email attachments, client documents, third-party portals). These could contain:\n\u2022 Viruses/trojans\n\u2022 Ransomware\n\u2022 Malicious macros in Office documents\n\u2022 Embedded scripts in PDFs\n\nWithout scanning, infected files could:\n\u2022 Spread to brokers who download them\n\u2022 Compromise broker workstations\n\u2022 Create liability for the organization\n\u2022 Damage trust with enterprise customers\n\n---\n\n<strong>Proposed Solution</strong>\n\n<strong>Architecture Options</strong>\n\n| Option | Pros | Cons | Cost |\n|--------|------|------|------|\n| **ClamAV on Supabase Edge Function** | Open source, self-hosted | Latency, maintenance | ~$0 + compute |\n| **VirusTotal API** | Comprehensive, easy | Rate limits, privacy concerns | Free tier limited |\n| **AWS/Azure/GCP native scanning** | Integrated, scalable | Vendor lock-in | ~$0.01/GB |\n| **Cloudflare R2 + scanning** | Fast, integrated | Requires R2 migration | ~$0.015/GB |\n\n<strong>Recommended: Supabase Edge Function + ClamAV</strong>\n\n<code>// Supabase Edge Function: scan-attachment\nimport { ClamScan } from 'clamscan';\n\nDeno.serve(async (req) => {\n  const { bucket, path } = await req.json();\n\n  // Download file from storage\n  const file = await supabase.storage.from(bucket).download(path);\n\n  // Scan with ClamAV\n  const scanner = new ClamScan();\n  const result = await scanner.scanBuffer(await file.arrayBuffer());\n\n  if (result.isInfected) {\n    // Move to quarantine bucket\n    await supabase.storage.from('quarantine').upload(path, file);\n    await supabase.storage.from(bucket).remove([path]);\n\n    // Log incident\n    await supabase.from('security_incidents').insert({\n      type: 'malware_detected',\n      file_path: path,\n      threat_name: result.viruses.join(', '),\n      action: 'quarantined'\n    });\n\n    return new Response(JSON.stringify({\n      safe: false,\n      threat: result.viruses\n    }));\n  }\n\n  return new Response(JSON.stringify({ safe: true }));\n});\n</code>\n\n<strong>Upload Flow</strong>\n\n<code>User uploads file\n       \u2502\n       \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Supabase Storage\u2502 (temp location)\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Edge Function   \u2502 (scan-attachment)\n\u2502 ClamAV scan     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n    \u250c\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2510\n    \u2502         \u2502\n    \u25bc         \u25bc\n Clean     Infected\n    \u2502         \u2502\n    \u25bc         \u25bc\n Move to   Quarantine\n final     + Alert\n location\n</code>\n\n<strong>Alternative: Async Scanning</strong>\n\nFor better UX, scan asynchronously:\n1. Upload immediately with <code>scan_status: 'pending'</code>\n2. Trigger Edge Function via webhook\n3. Update status to <code>clean</code> or <code>infected</code>\n4. Broker sees warning badge until scanned\n5. Block download of infected files\n\n---\n\n<strong>Database Changes</strong>\n\n<code>-- Add scan status to attachments\nALTER TABLE submission_attachments\nADD COLUMN scan_status VARCHAR(20) DEFAULT 'pending'\nCHECK (scan_status IN ('pending', 'scanning', 'clean', 'infected', 'error'));\n\nALTER TABLE submission_attachments\nADD COLUMN scan_result JSONB;\n\n-- Quarantine tracking\nCREATE TABLE security_incidents (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  type VARCHAR(50) NOT NULL,\n  file_path TEXT,\n  threat_name TEXT,\n  action VARCHAR(50),\n  metadata JSONB,\n  created_at TIMESTAMPTZ DEFAULT NOW()\n);\n</code>\n\n---\n\n<strong>Files to Create/Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>supabase/functions/scan-attachment/index.ts</code> | New Edge Function |\n| <code>supabase/migrations/XXXX_add_scan_status.sql</code> | Add scan columns |\n| <code>electron/services/submissionService.ts</code> | Handle scan status |\n| <code>broker-portal/components/AttachmentCard.tsx</code> | Show scan badge |\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 All uploads trigger malware scan\n\u2610 Infected files moved to quarantine bucket\n\u2610 Users cannot download infected files\n\u2610 Security incident logged with threat details\n\u2610 Admin notification on detection\n\u2610 Scan completes within 30 seconds for files < 50MB\n\u2610 UI shows scan status (pending/clean/infected)\n\n---\n\n<strong>Testing Plan</strong>\n\n1. Upload EICAR test file (standard AV test file)\n2. Verify detection and quarantine\n3. Verify clean files pass through\n4. Test large file scanning (100MB+)\n5. Test timeout handling\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-402: File Size Limits\n\u2022 SPRINT-050: B2B Broker Portal (parent feature)\n\n---\n\n<strong>Security Notes</strong>\n\n\u2022 ClamAV database must be updated regularly (daily cron)\n\u2022 Consider additional scanning for Office macros (oletools)\n\u2022 PDF scanning for JavaScript/embedded objects\n\u2022 Log all scan results for audit trail"
  },
  {
    "id": "BACKLOG-404",
    "title": "Internal Admin Panel for User Management",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-404.md](items/BACKLOG-404.md)",
    "description": "<strong>Summary</strong>\n\nBuild an internal admin panel for dev team, customer service, and sales to manage user accounts, organizations, and access.\n\n---\n\n<strong>Problem Statement</strong>\n\nCurrently, managing user accounts requires direct database access. Internal teams need a UI to:\n\u2022 View and search user accounts\n\u2022 Grant/revoke access to organizations\n\u2022 Manage subscription tiers and trials\n\u2022 Troubleshoot user issues\n\u2022 Onboard new customers (sales demos)\n\n---\n\n<strong>Proposed Solution</strong>\n\n<strong>Admin Portal Features</strong>\n\n| Feature | Description | Access Level |\n|---------|-------------|--------------|\n| **User Search** | Search by email, name, org | All internal |\n| **User Details** | View profile, login history, orgs | All internal |\n| **Grant Org Access** | Add user to organization with role | Customer Service+ |\n| **Manage Subscription** | Upgrade/downgrade, extend trials | Sales+ |\n| **Impersonate User** | View portal as user (read-only) | Dev Team only |\n| **Audit Logs** | View all actions taken on account | All internal |\n\n<strong>Access Levels</strong>\n\n1. **Support**: View-only, can see user details\n2. **Customer Service**: Can grant access, reset accounts\n3. **Sales**: Can manage subscriptions, create demo orgs\n4. **Dev Team**: Full access including impersonation\n\n<strong>Implementation Options</strong>\n\n| Option | Pros | Cons |\n|--------|------|------|\n| **Separate admin app** | Isolated, secure | Another deployment |\n| **Admin routes in broker portal** | Shared codebase | More complex auth |\n| **Supabase Dashboard + RLS** | No code needed | Limited UX |\n| **Retool/Appsmith** | Fast to build | External tool, cost |\n\n<strong>Recommended: Admin routes in broker portal</strong>\n\nAdd <code>/admin/*</code> routes protected by internal email domain or special role:\n\n<code>// middleware.ts\nif (pathname.startsWith('/admin')) {\n  // Check if user has 'internal' role or @magicaudit.com email\n  const isInternal = user?.email?.endsWith('@magicaudit.com')\n    || membership?.role === 'internal_admin';\n  if (!isInternal) redirect('/dashboard');\n}\n</code>\n\n---\n\n<strong>Database Changes</strong>\n\n<code>-- Add internal admin role\nALTER TABLE organization_members\nDROP CONSTRAINT organization_members_role_check;\n\nALTER TABLE organization_members\nADD CONSTRAINT organization_members_role_check\nCHECK (role IN ('agent', 'broker', 'admin', 'it_admin', 'internal_admin'));\n\n-- Or create separate internal_users table\nCREATE TABLE internal_users (\n  id UUID PRIMARY KEY REFERENCES auth.users(id),\n  access_level VARCHAR(50) NOT NULL, -- support, cs, sales, dev\n  created_at TIMESTAMPTZ DEFAULT NOW()\n);\n</code>\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Internal team can search users by email/name\n\u2610 Internal team can view user's organizations and roles\n\u2610 Customer service can add users to organizations\n\u2610 Sales can extend trials and change subscription tiers\n\u2610 All admin actions are logged for audit\n\u2610 Access restricted to internal team only\n\n---\n\n<strong>Security Considerations</strong>\n\n\u2022 Require MFA for admin access\n\u2022 Log all admin actions with user ID and timestamp\n\u2022 Implement rate limiting on admin endpoints\n\u2022 Consider IP allowlisting for admin routes\n\u2022 Impersonation should be read-only and logged\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-389: Demo Seed Data\n\u2022 SPRINT-050: B2B Broker Portal"
  },
  {
    "id": "BACKLOG-405",
    "title": "Fix RLS Policies and Auth Triggers",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-405.md](items/BACKLOG-405.md)",
    "description": "<strong>Summary</strong>\n\nRe-enable RLS and fix auth triggers that were disabled during initial deployment debugging.\n\n---\n\n<strong>Current State (Demo)</strong>\n\nTo get the broker portal working, we disabled:\n\n1. **RLS on <code>profiles</code>** - <code>ALTER TABLE profiles DISABLE ROW LEVEL SECURITY;</code>\n2. **RLS on <code>organization_members</code>** - <code>ALTER TABLE organization_members DISABLE ROW LEVEL SECURITY;</code>\n3. **Triggers on <code>auth.users</code>**:\n   - <code>on_auth_user_created</code> \u2192 <code>handle_new_user_profile()</code>\n   - <code>on_auth_user_created_link_invitations</code> \u2192 <code>handle_new_user_invitation_link()</code>\n\n---\n\n<strong>Problems Identified</strong>\n\n<strong>1. Self-referential RLS Policy on organization_members</strong>\n\nThe policy requires user to be a member to see members:\n<code>CREATE POLICY \"members_can_read_org_members\" ON organization_members\n  FOR SELECT USING (\n    organization_id IN (\n      SELECT organization_id FROM organization_members\n      WHERE user_id = auth.uid()\n    )\n  );\n</code>\n\n**Problem**: Works for seeing OTHER members, but creates chicken-and-egg for seeing OWN membership during auth callback.\n\n**Fix**: Add policy allowing users to see their own row:\n<code>CREATE POLICY \"users_can_read_own_membership\" ON organization_members\n  FOR SELECT USING (user_id = auth.uid());\n</code>\n\n<strong>2. Trigger Execution Context</strong>\n\nThe <code>handle_new_user_profile()</code> trigger runs <code>SECURITY DEFINER</code> but may still hit RLS issues or constraint problems.\n\n**Investigation needed**: Check what exactly fails when trigger runs.\n\n---\n\n<strong>Fix Plan</strong>\n\n<strong>Step 1: Fix organization_members RLS</strong>\n\n<code>-- Re-enable RLS\nALTER TABLE organization_members ENABLE ROW LEVEL SECURITY;\n\n-- Add policy for users to read their own membership\nCREATE POLICY \"users_can_read_own_membership\" ON organization_members\n  FOR SELECT USING (user_id = auth.uid());\n</code>\n\n<strong>Step 2: Fix profiles RLS</strong>\n\n<code>-- Re-enable RLS\nALTER TABLE profiles ENABLE ROW LEVEL SECURITY;\n\n-- Ensure trigger can insert (SECURITY DEFINER should handle this)\n-- May need to grant INSERT to the function owner\n</code>\n\n<strong>Step 3: Recreate Triggers</strong>\n\n<code>-- Recreate profile trigger\nCREATE TRIGGER on_auth_user_created\n  AFTER INSERT ON auth.users\n  FOR EACH ROW EXECUTE FUNCTION handle_new_user_profile();\n\n-- Recreate invitation link trigger\nCREATE TRIGGER on_auth_user_created_link_invitations\n  AFTER INSERT ON auth.users\n  FOR EACH ROW EXECUTE FUNCTION handle_new_user_invitation_link();\n</code>\n\n<strong>Step 4: Test New User Signup</strong>\n\n1. Create new test user via OAuth\n2. Verify profile created automatically\n3. Verify user can see their org membership\n4. Verify auth callback works\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 RLS re-enabled on profiles\n\u2610 RLS re-enabled on organization_members\n\u2610 Auth triggers recreated and working\n\u2610 New user signup creates profile automatically\n\u2610 Existing user login works\n\u2610 Users can only see their own data (verify RLS)\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 SPRINT-050: B2B Broker Portal\n\u2022 BACKLOG-388: RLS Policies + Storage Bucket"
  },
  {
    "id": "BACKLOG-406",
    "title": "Fix Apple Signing Certificate for macOS Release",
    "category": "infrastructure",
    "priority": "High",
    "status": "Pending",
    "sprint": "SPRINT-056",
    "est_tokens": "~5K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "",
    "file": "[BACKLOG-406.md](items/BACKLOG-406.md)",
    "description": "<strong>Summary</strong>\n\nFix the Apple signing certificate issue preventing macOS builds from completing in the v2.0.0 release workflow.\n\n---\n\n<strong>Problem Statement</strong>\n\nThe v2.0.0 release workflow failed for macOS at the \"Import Apple Certificate\" step. Windows build succeeded and <code>MagicAudit.Setup.2.0.0.exe</code> was uploaded, but no macOS artifacts (<code>.dmg</code>, <code>.zip</code>) were produced.\n\n**Current state:**\n\u2022 Windows: SUCCESS - <code>MagicAudit.Setup.2.0.0.exe</code> available\n\u2022 macOS: FAILED - No artifacts, certificate import error\n\n---\n\n<strong>Proposed Solution</strong>\n\n1. **Export new Apple Developer certificate** as <code>.p12</code> file from Keychain Access\n2. **Base64 encode** the certificate: <code>base64 -i certificate.p12 | pbcopy</code>\n3. **Update GitHub Secrets:**\n   - <code>APPLE_CERTIFICATE</code> - base64-encoded .p12 content\n   - <code>APPLE_CERTIFICATE_PASSWORD</code> - password used when exporting\n4. **Verify Apple Developer credentials:**\n   - <code>APPLE_ID</code> - Apple Developer account email\n   - <code>APPLE_ID_PASSWORD</code> - App-specific password (not account password)\n   - <code>APPLE_TEAM_ID</code> - Team ID from Apple Developer portal\n5. **Re-run release workflow** or create new patch release (v2.0.1)\n\n---\n\n<strong>Files to Check</strong>\n\n| File | Purpose |\n|------|---------|\n| <code>.github/workflows/release.yml</code> | Release workflow with signing steps |\n| <code>scripts/notarize.js</code> | macOS notarization script |\n| <code>build/entitlements.mac.plist</code> | macOS entitlements |\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Apple certificate exported and base64 encoded\n\u2610 GitHub Secrets updated with valid credentials\n\u2610 Release workflow completes for macOS\n\u2610 Both <code>.dmg</code> and <code>.zip</code> artifacts uploaded to release\n\u2610 v2.0.0 (or v2.0.1) release has Windows AND macOS installers\n\n---\n\n<strong>Technical Notes</strong>\n\n<strong>Certificate Export Steps</strong>\n\n1. Open Keychain Access\n2. Find \"Developer ID Application\" certificate\n3. Right-click > Export\n4. Save as <code>.p12</code> with password\n5. Base64 encode: <code>base64 -i Certificates.p12 | pbcopy</code>\n6. Paste into GitHub Secrets as <code>APPLE_CERTIFICATE</code>\n\n<strong>App-Specific Password</strong>\n\nFor <code>APPLE_ID_PASSWORD</code>, create an app-specific password at:\nhttps://appleid.apple.com/account/manage > Security > App-Specific Passwords\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 Release v2.0.0: https://github.com/5hdaniel/Mad/releases/tag/v2.0.0\n\u2022 SPRINT-049: Testing sprint that preceded this release\n\u2022 **Supersedes:** BACKLOG-056 (macOS Code Signing Fix) - marked obsolete"
  },
  {
    "id": "BACKLOG-409",
    "title": "Align TypeScript Types with SQLite Schema",
    "category": "refactor",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-051",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-23",
    "file": "[BACKLOG-409.md](items/BACKLOG-409.md)",
    "description": "<strong>Description</strong>\n\nAlign TypeScript type definitions with actual SQLite schema to fix schema drift issues.\n\n<strong>Problem</strong>\n\nTypeScript types reference fields that don't exist in SQLite:\n\u2022 <code>detection_status</code> referenced in filter logic but doesn't exist\n\u2022 <code>archived</code> exists in TypeScript but not in SQLite CHECK constraint\n\n<strong>Solution</strong>\n\n1. Audit all TypeScript interfaces against SQLite schema\n2. Remove or add fields to align\n3. Update CHECK constraints if needed\n\n<strong>Files to Modify</strong>\n\n\u2022 <code>src/types/database.ts</code>\n\u2022 <code>src/types/transaction.ts</code>\n\u2022 Related service files\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 TypeScript types match SQLite schema exactly\n\u2610 No runtime errors from missing fields\n\u2610 Type-check passes\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-410: Add AI detection columns to SQLite\n\u2022 BACKLOG-411: Update base schema.sql\n\u2022 Phase 1 of schema alignment plan"
  },
  {
    "id": "BACKLOG-410",
    "title": "Add AI Detection Columns to SQLite (verify existing)",
    "category": "schema",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-053",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-410.md](items/BACKLOG-410.md)",
    "description": "<strong>IMPORTANT: Clarification Note (Added 2026-01-23)</strong>\n\n**SR Engineer Review Finding**: The description below is PARTIALLY OUTDATED.\n\nAfter schema audit, the following columns ALREADY EXIST in <code>schema.sql</code> (lines 355-362):\n\u2022 <code>detection_source TEXT</code> - already exists\n\u2022 <code>detection_status TEXT</code> - already exists\n\u2022 <code>detection_confidence REAL</code> - already exists\n\u2022 <code>detection_method TEXT</code> - already exists\n\nThe only column that may be missing is <code>detected_at</code> (not currently in schema).\n\n**Updated Scope**: This task should:\n1. Verify which columns exist in the LIVE database (migrations may not have run)\n2. Create migration ONLY for truly missing columns\n3. Verify TypeScript types match schema\n\n**See Also**: BACKLOG-413 references removing <code>detection_status</code> from filter logic, but the column DOES exist in schema.\n\n---\n\n<strong>Description</strong>\n\nAdd missing AI detection columns to SQLite schema that TypeScript expects.\n\n<strong>Columns to Verify/Add</strong>\n\n<code>-- These MAY already exist - verify first!\nALTER TABLE transactions ADD COLUMN detection_status TEXT;\nALTER TABLE transactions ADD COLUMN detection_confidence REAL;\nALTER TABLE transactions ADD COLUMN detected_at TEXT;  -- This one may be truly missing\n</code>\n\n<strong>Migration</strong>\n\nCreate migration file: <code>migrations/XXXX_add_detection_columns.sql</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Migration adds columns without data loss\n\u2610 Existing transactions unaffected\n\u2610 TypeScript types align with new columns\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-409: Align TypeScript types\n\u2022 BACKLOG-411: Update base schema.sql\n\u2022 Phase 1 of schema alignment plan"
  },
  {
    "id": "BACKLOG-411",
    "title": "Update Base schema.sql",
    "category": "refactor",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-051",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-23",
    "file": "[BACKLOG-411.md](items/BACKLOG-411.md)",
    "description": "<strong>Description</strong>\n\nUpdate the base schema.sql file to include all columns and constraints that have been added via migrations.\n\n<strong>Changes</strong>\n\n1. Add <code>detection_status</code>, <code>detection_confidence</code>, <code>detected_at</code> columns\n2. Update CHECK constraints to include <code>archived</code> status\n3. Add any other missing columns from migrations\n\n<strong>File to Modify</strong>\n\n\u2022 <code>electron/database/schema.sql</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Fresh installs get complete schema\n\u2610 Schema matches migrated databases\n\u2610 All CHECK constraints are correct\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-409: Align TypeScript types\n\u2022 BACKLOG-410: Add AI detection columns\n\u2022 Phase 1 of schema alignment plan"
  },
  {
    "id": "BACKLOG-412",
    "title": "Restore Closed Filter Tab",
    "category": "ui",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-051",
    "est_tokens": "~8K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-23",
    "file": "[BACKLOG-412.md](items/BACKLOG-412.md)",
    "description": "<strong>Description</strong>\n\nRestore the \"Closed\" filter tab that was removed. Users need to see historical/archived transactions.\n\n<strong>Problem</strong>\n\nThe \"Closed\" tab was removed from the transaction filter - users can't see historical transactions.\n\n<strong>Solution</strong>\n\nAdd \"Closed\" back to the filter tabs, filtering for transactions with status <code>closed</code> or <code>archived</code>.\n\n<strong>Files to Modify</strong>\n\n\u2022 Transaction list/filter component\n\u2022 Filter constants/types\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 \"Closed\" tab visible in filter bar\n\u2610 Clicking shows closed/archived transactions\n\u2610 Count badge shows correct number\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-413: Remove detection_status from filter logic\n\u2022 BACKLOG-414: Add visual separator between status domains\n\u2022 Phase 2 of schema alignment plan"
  },
  {
    "id": "BACKLOG-413",
    "title": "Investigate/Fix detection_status Filter Logic",
    "category": "refactor",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~5K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-413.md](items/BACKLOG-413.md)",
    "description": "<strong>IMPORTANT: Clarification Note (Added 2026-01-23)</strong>\n\n**SR Engineer Review Finding**: The description below is INACCURATE.\n\nThe <code>detection_status</code> column DOES exist in <code>schema.sql</code> (lines 356-362):\n<code>detection_status TEXT DEFAULT 'confirmed' CHECK (detection_status IN ('pending', 'confirmed', 'rejected'))\n</code>\n\n**Updated Scope**: This task should:\n1. Investigate WHY filter logic \"works by accident\" - the column exists\n2. Determine if the issue is:\n   - Filter queries not matching schema column name\n   - Migration not applied to some databases\n   - Filter referencing wrong status domain (transaction status vs detection status)\n3. Fix the actual issue once root cause is identified\n\n**Possible Real Issue**: Filter tabs may be conflating <code>detection_status</code> (AI detection result) with <code>status</code> (transaction lifecycle) or <code>submission_status</code> (broker review). The fix may be to clarify which status domain each filter tab uses.\n\n**See Also**: BACKLOG-410 also references detection columns - the column DOES exist.\n\n---\n\n<strong>Description</strong>\n\n~~Remove <code>detection_status</code> from filter logic - it's referenced but doesn't exist in SQLite (currently works by accident).~~\n\n**UPDATED**: Investigate and fix filter logic's use of <code>detection_status</code>. The column exists; the issue is likely domain confusion between different status fields.\n\n<strong>Problem</strong>\n\n~~Filter logic references <code>detection_status</code> field that doesn't exist in the database. It works by accident but is incorrect.~~\n\n**UPDATED**: Filter logic may be incorrectly mixing status domains (transaction status vs detection status vs submission status).\n\n<strong>Solution</strong>\n\n1. ~~Remove all references to <code>detection_status</code> in filter logic~~ **UPDATED**: Investigate actual issue\n2. Clarify which status domain each filter tab uses:\n   - <code>status</code>: Transaction lifecycle (pending, active, closed, rejected)\n   - <code>detection_status</code>: AI detection result (pending, confirmed, rejected)\n   - <code>submission_status</code>: Broker review (not_submitted, submitted, under_review, etc.)\n3. Ensure filter queries match the correct column for their purpose\n\n<strong>Files to Modify</strong>\n\n\u2022 Filter component(s)\n\u2022 Filter utility functions\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 No references to <code>detection_status</code> in filter logic\n\u2610 Filters still work correctly\n\u2610 No console errors\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-412: Restore \"Closed\" filter tab\n\u2022 BACKLOG-410: Add AI detection columns (for future use)\n\u2022 Phase 2 of schema alignment plan"
  },
  {
    "id": "BACKLOG-414",
    "title": "Add Visual Separator Between Status Domains",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~5K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-414.md](items/BACKLOG-414.md)",
    "description": "<strong>Description</strong>\n\nAdd visual separator in the filter tabs between different status domains (Local vs Submission).\n\n<strong>Problem</strong>\n\nFilter tabs mix local transaction statuses (All, Active, Closed) with submission statuses (Submitted, Under Review, Needs Changes, Approved) without clear separation.\n\n<strong>Solution</strong>\n\nAdd a visual divider or grouping between:\n\u2022 Local statuses: All | Active | Closed\n\u2022 Submission statuses: Submitted | Under Review | Needs Changes | Approved\n\n<strong>Mockup</strong>\n\n<code>[All] [Active] [Closed] | [Submitted] [Under Review] [Needs Changes] [Approved]\n                        ^\n                     separator\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Visual separator between status domains\n\u2610 Clear grouping of related statuses\n\u2610 Maintains existing filter functionality\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-412: Restore \"Closed\" filter tab\n\u2022 BACKLOG-413: Remove detection_status from filter logic\n\u2022 Phase 2 of schema alignment plan"
  },
  {
    "id": "BACKLOG-415",
    "title": "Submit Modal Shows Wrong Message Count",
    "category": "bug fix",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-050",
    "est_tokens": "~5K tokens",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-415.md](items/BACKLOG-415.md)",
    "description": "<strong>Problem</strong>\n\nThe Submit for Review modal shows 0 messages even when the transaction has linked messages. The modal calculates count from <code>emailCommunications.length + textMessages.length</code> which may be empty if communications aren't fetched properly.\n\n<strong>Root Cause</strong>\n\nThe modal uses dynamically calculated counts from fetched arrays:\n<code>messageCount={emailCommunications.length + textMessages.length}\n</code>\n\nBut the TransactionCard uses stored counts:\n<code>const textCount = transaction.text_thread_count || 0;\nconst emailCount = transaction.email_count || 0;\n</code>\n\nThis inconsistency means the card shows correct counts but the modal shows 0.\n\n<strong>Solution</strong>\n\nUpdate the Submit for Review modal to use stored counts from the transaction record instead of calculating from the communications array.\n\n<strong>Files to Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>src/components/TransactionDetails.tsx</code> | Change <code>messageCount</code> prop to use <code>transaction.text_thread_count + transaction.email_count</code> |\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Submit modal shows correct message count matching transaction card\n\u2610 Works for both text-only and email-only transactions\n\u2610 Works for transactions with both types\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-414: Submission Service Not Including Text Messages\n\u2022 SPRINT-050: B2B Broker Portal Demo"
  },
  {
    "id": "BACKLOG-416",
    "title": "Submitted Transactions Show as Active in Filter",
    "category": "bug fix",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~15K tokens",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-416.md](items/BACKLOG-416.md)",
    "description": "<strong>Problem</strong>\n\nTransactions that have been submitted for review still appear in the \"Active\" filter tab. Users expect submitted transactions to appear under \"Submitted\" or \"Under Review\" tabs, not \"Active\".\n\n<strong>Root Cause</strong>\n\nThe filter logic uses <code>transaction.status</code> for some tabs and <code>transaction.submission_status</code> for others, but doesn't properly exclude submitted transactions from the \"Active\" tab.\n\nCurrent behavior:\n\u2022 A transaction with <code>status: \"active\"</code> and <code>submission_status: \"submitted\"</code> appears in BOTH \"Active\" and \"Submitted\" tabs\n\nExpected behavior:\n\u2022 Once submitted, transaction should NOT appear in \"Active\" tab\n\u2022 Should only appear in the appropriate submission status tab\n\n<strong>Solution Options</strong>\n\n<strong>Option A: Mutually Exclusive Tabs</strong>\n\u2022 \"Active\" = <code>status === 'active' AND submission_status IS NULL</code>\n\u2022 \"Submitted\" = <code>submission_status === 'submitted'</code>\n\u2022 etc.\n\n<strong>Option B: Status Hierarchy</strong>\n\u2022 Submission status takes precedence over transaction status for filtering\n\u2022 Active tab excludes any transaction with a submission_status\n\n<strong>Option C: Separate Tab Groups (SPRINT-051 recommendation)</strong>\n\u2022 Transaction Status: All | Active | Closed\n\u2022 Submission Status: Submitted | Under Review | Needs Changes | Approved\n\u2022 Visual separator between groups\n\n<strong>Files to Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>src/components/transaction/hooks/useTransactionList.ts</code> | Update filter logic |\n| <code>src/components/transaction/components/TransactionToolbar.tsx</code> | Possibly add visual separator |\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Submitted transactions don't appear in \"Active\" tab\n\u2610 Each transaction appears in only ONE filter tab\n\u2610 Filter counts are accurate\n\u2610 No transactions are \"lost\" (all appear somewhere)\n\n<strong>Related</strong>\n\n\u2022 SPRINT-051: Transaction Status Architecture Realignment\n\u2022 BACKLOG-412: Restore \"Closed\" Filter Tab"
  },
  {
    "id": "BACKLOG-417",
    "title": "Display Price Fields in Transaction Summary",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~8K tokens",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-417.md](items/BACKLOG-417.md)",
    "description": "<strong>Description</strong>\n\nDisplay Listing Price and Sale Price in the transaction summary/overview section so users can see this information without opening the Edit modal.\n\n<strong>Current State</strong>\n\n\u2022 Price fields exist in Edit Transaction modal (Step 1)\n\u2022 Prices are saved to database (<code>listing_price</code>, <code>sale_price</code>)\n\u2022 Prices are NOT displayed anywhere in the transaction details view\n\n<strong>Expected State</strong>\n\nShow prices in the Overview tab of Transaction Details:\n\n<code>Transaction Summary\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nProperty:      123 Main St, City, ST 12345\nType:          Purchase\nAudit Period:  Jan 1, 2026 - Jan 21, 2026\n\nListing Price: $500,000\nSale Price:    $485,000\n</code>\n\n<strong>Requirements</strong>\n\n\u2022 Display in Overview/Summary section\n\u2022 Format as currency (e.g., \"$500,000\")\n\u2022 Show \"\u2014\" or \"Not set\" if price is null\n\u2022 Optional: Show price difference/negotiation amount\n\n<strong>Files to Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>src/components/transactionDetailsModule/components/TransactionDetailsTab.tsx</code> | Add price display |\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Listing Price displayed in Overview section\n\u2610 Sale Price displayed in Overview section\n\u2610 Prices formatted as currency\n\u2610 Handles null/undefined gracefully\n\u2610 Matches existing summary styling\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-381: Transaction Details Header Improvements\n\u2022 Price fields added in Edit Transaction modal"
  },
  {
    "id": "BACKLOG-418",
    "title": "Redesign Contact Selection UX (Select First, Assign Roles Second)",
    "category": "ux redesign",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "SPRINT-055b",
    "est_tokens": "~40K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-418.md](items/BACKLOG-418.md)",
    "description": "<strong>Problem</strong>\n\nCurrent Create Transaction flow has poor UX and performance:\n\n1. **Performance**: Each role (buyer, seller, listing_agent, etc.) has its own \"Select Contact\" button that independently loads contacts \u2192 N+1 queries \u2192 UI freeze\n2. **UX**: User must click through 4-6 separate contact selection modals to assign contacts to roles\n3. **Code Duplication**: 3 separate implementations of role assignment components\n\n<strong>Current Flow (Bad)</strong>\n\n<code>Step 2: Client & Agents\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Buyer           [Select Contact] \u2190\u2500\u2500 loads contacts\n\u2502 Seller          [Select Contact] \u2190\u2500\u2500 loads contacts again\n\u2502 Listing Agent   [Select Contact] \u2190\u2500\u2500 loads contacts again\n\u2502 Buying Agent    [Select Contact] \u2190\u2500\u2500 loads contacts again\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nStep 3: Other Parties\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Escrow          [Select Contact] \u2190\u2500\u2500 loads contacts again\n\u2502 Title           [Select Contact] \u2190\u2500\u2500 loads contacts again\n\u2502 Lender          [Select Contact] \u2190\u2500\u2500 loads contacts again\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n**Problems:**\n\u2022 6-7 separate contact loads (N+1 queries)\n\u2022 User clicks through 6-7 modals\n\u2022 Each modal is a context switch\n\n<strong>Proposed Flow (Good)</strong>\n\n<code>Step 2: Select Contacts\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Search: [_______________]               \u2502\n\u2502                                         \u2502\n\u2502 \u2611 John Smith (john@email.com)          \u2502\n\u2502 \u2611 Sarah Johnson (+1 424-555-1234)      \u2502\n\u2502 \u2611 Bob Wilson (bob@company.com)         \u2502\n\u2502 \u2610 Alice Brown (alice@example.com)      \u2502\n\u2502 \u2610 ...                                   \u2502\n\u2502                                         \u2502\n\u2502 Selected: 3 contacts                    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nStep 3: Assign Roles\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Drag contacts to roles or use dropdowns \u2502\n\u2502                                         \u2502\n\u2502 Buyer:         [John Smith \u25bc]          \u2502\n\u2502 Seller:        [Sarah Johnson \u25bc]       \u2502\n\u2502 Listing Agent: [Bob Wilson \u25bc]          \u2502\n\u2502 Buying Agent:  [-- Select --  \u25bc]       \u2502\n\u2502 Escrow:        [-- Select --  \u25bc]       \u2502\n\u2502                                         \u2502\n\u2502 Available: John, Sarah, Bob             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n**Benefits:**\n\u2022 **1 contact load** (Step 2 loads once)\n\u2022 **1 selection UI** (multi-select checklist)\n\u2022 **Step 3 is pure UI** (dropdowns from already-selected contacts, no API calls)\n\u2022 **Faster workflow** (2 steps instead of 6-7 modals)\n\n<strong>Implementation</strong>\n\n<strong>Step 2: Select Contacts</strong>\n\n\u2022 Single contact list with search/filter\n\u2022 Multi-select checkboxes\n\u2022 Show all contacts (imported, external, manual)\n\u2022 Load contacts ONCE when entering Step 2\n\u2022 Store selected contacts in modal state\n\n<strong>Step 3: Assign Roles</strong>\n\n\u2022 Show only the contacts selected in Step 2\n\u2022 Dropdown per role (populated from selected contacts)\n\u2022 No API calls - pure UI state\n\u2022 Allow same contact for multiple roles (if applicable)\n\u2022 Visual indication of unassigned contacts\n\n<strong>Shared Component</strong>\n\nCreate reusable components:\n\n<code>src/components/shared/\n\u251c\u2500\u2500 ContactSelector.tsx      # Step 2: Multi-select contact list\n\u251c\u2500\u2500 RoleAssigner.tsx         # Step 3: Role dropdowns from selected contacts\n\u2514\u2500\u2500 ContactRoleFlow.tsx      # Combines both for transaction flows\n</code>\n\n<strong>Files to Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>src/components/shared/ContactSelector.tsx</code> | **NEW** - Multi-select contact list |\n| <code>src/components/shared/RoleAssigner.tsx</code> | **NEW** - Role assignment from selected |\n| <code>src/components/audit/ContactAssignmentStep.tsx</code> | Replace with new flow |\n| <code>src/components/audit/RoleAssignment.tsx</code> | **DELETE** - replaced |\n| <code>src/components/transaction/components/EditTransactionModal.tsx</code> | Use new shared components |\n| <code>src/components/transactionDetailsModule/components/modals/EditContactsModal.tsx</code> | Use new shared components |\n| <code>src/hooks/useAuditTransaction.ts</code> | Update state shape if needed |\n\n<strong>State Shape</strong>\n\n<code>// In useAuditTransaction or modal state\ninterface ContactFlowState {\n  // Step 2: Selected contacts\n  selectedContacts: Contact[];\n\n  // Step 3: Role assignments (contactId per role)\n  roleAssignments: {\n    buyer?: string;\n    seller?: string;\n    listing_agent?: string;\n    buying_agent?: string;\n    escrow?: string;\n    title?: string;\n    lender?: string;\n    // ... other roles\n  };\n}\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Step 2 loads contacts exactly once\n\u2610 Step 2 shows multi-select contact list with search\n\u2610 Step 3 shows role dropdowns populated from Step 2 selections\n\u2610 No API calls in Step 3 (pure UI)\n\u2610 No UI freeze in Create Transaction flow\n\u2610 Edit Transaction modal uses same flow\n\u2610 Edit Contacts modal uses same flow\n\u2610 All 3 duplicate components removed\n\u2610 TypeScript compiles\n\u2610 Existing tests updated/pass\n\n<strong>Migration Notes</strong>\n\n\u2022 Existing transactions with contacts should still work\n\u2022 Role assignment data structure in DB unchanged\n\u2022 Only UI flow changes, not data model\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-311: EditContactsModal Performance (partial fix, superseded by this)\n\u2022 BACKLOG-386: Unified Contact Selection UX (related, may consolidate)\n\u2022 BACKLOG-217: Edit contacts button reuse (will use new shared components)\n\n<strong>Estimated Effort</strong>\n\n~40K tokens (UX redesign + component consolidation + 3 integration points)"
  },
  {
    "id": "BACKLOG-419",
    "title": "Audit and Restore RLS Policies",
    "category": "security",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-051",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-23",
    "file": "[BACKLOG-419.md](items/BACKLOG-419.md)",
    "description": "<strong>Problem</strong>\n\nDuring login troubleshooting, RLS (Row-Level Security) policies may have been disabled or modified in the Supabase Dashboard. This needs to be audited and restored.\n\n<strong>Background</strong>\n\n\u2022 RLS policies were potentially disabled to debug authentication issues\n\u2022 The B2B migration (<code>20260122_b2b_broker_portal.sql</code>) includes RLS policies but may not have been fully applied\n\u2022 Current state of RLS in production Supabase is unknown\n\n<strong>Tasks</strong>\n\n<strong>1. Audit Current State</strong>\n\nCheck each table in Supabase Dashboard:\n\n| Table | Expected RLS | Check |\n|-------|--------------|-------|\n| <code>profiles</code> | ENABLED | [ ] |\n| <code>user_email_settings</code> | ENABLED | [ ] |\n| <code>user_preferences</code> | ENABLED | [ ] |\n| <code>organizations</code> | ENABLED | [ ] |\n| <code>organization_members</code> | ENABLED | [ ] |\n| <code>transaction_submissions</code> | ENABLED | [ ] |\n| <code>submission_messages</code> | ENABLED | [ ] |\n| <code>submission_attachments</code> | ENABLED | [ ] |\n| <code>submission_comments</code> | ENABLED | [ ] |\n\n<strong>2. Document What Was Changed</strong>\n\n\u2022 List any tables with RLS disabled\n\u2022 List any policies that were dropped\n\u2022 Document reason for changes (login troubleshooting)\n\n<strong>3. Restore RLS Policies</strong>\n\nEither:\n\u2022 Re-run the migration SQL for affected tables\n\u2022 Or manually enable RLS and recreate policies in Dashboard\n\n<strong>4. Test After Restoration</strong>\n\n\u2022 Verify login still works with RLS enabled\n\u2022 Verify agents can only see their own data\n\u2022 Verify brokers can see their org's data\n\n<strong>SQL to Check RLS Status</strong>\n\n<code>-- Check RLS status for all tables\nSELECT\n  schemaname,\n  tablename,\n  rowsecurity\nFROM pg_tables\nWHERE schemaname = 'public'\nORDER BY tablename;\n\n-- List all RLS policies\nSELECT\n  schemaname,\n  tablename,\n  policyname,\n  permissive,\n  roles,\n  cmd,\n  qual\nFROM pg_policies\nWHERE schemaname = 'public'\nORDER BY tablename, policyname;\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 All tables audited for RLS status\n\u2610 RLS enabled on all tables that need it\n\u2610 All required policies exist and are correct\n\u2610 Login flow still works\n\u2610 Data access properly restricted by user/org\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-388: RLS Policies + Storage Bucket (B2B tables)\n\u2022 BACKLOG-405: Profiles RLS fix (may be related)\n\u2022 Login troubleshooting session where RLS was modified"
  },
  {
    "id": "BACKLOG-420",
    "title": "Broker Portal - Attachments Not Displaying",
    "category": "bug fix",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-050",
    "est_tokens": "~15K tokens",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-420.md](items/BACKLOG-420.md)",
    "description": "<strong>Problem</strong>\n\nAttachments are not displaying at all on the broker portal when viewing a submission.\n\n<strong>Expected Behavior</strong>\n\n\u2022 Attachments uploaded with the submission should be visible\n\u2022 Broker should be able to view/download attachments\n\n<strong>Investigation Needed</strong>\n\n1. Are attachments being uploaded to Supabase Storage? (Check BACKLOG-393)\n2. Are attachment records being created in <code>submission_attachments</code> table?\n3. Is the portal querying attachments correctly?\n4. Is there an RLS policy blocking access?\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-393: Desktop - Attachment Upload Service\n\u2022 BACKLOG-401: Portal - Message & Attachment Viewer\n\u2022 BACKLOG-419: Audit and Restore RLS Policies\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Attachments visible on broker portal submission detail\n\u2610 Broker can view/download attachments"
  },
  {
    "id": "BACKLOG-421",
    "title": "Broker Portal - Request Changes Text Color is White",
    "category": "bug fix",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-050",
    "est_tokens": "~3K tokens",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "2026-01-22",
    "file": "[BACKLOG-421.md](items/BACKLOG-421.md)",
    "description": "<strong>Problem</strong>\n\nWhen a broker uses \"Request Changes\" action, the text input field has white text on a light background, making it unreadable.\n\n<strong>Expected Behavior</strong>\n\n\u2022 Text in the feedback/notes textarea should be black (or dark color)\n\u2022 Text should be clearly visible while typing\n\n<strong>Fix</strong>\n\nFind the textarea/input component in the Review Actions and add proper text color:\n\n<code>// Change from:\n<textarea className=\"...\" />\n\n// To:\n<textarea className=\"... text-gray-900\" />\n</code>\n\n<strong>Files to Check</strong>\n\n\u2022 <code>broker-portal/app/dashboard/submissions/[id]/page.tsx</code>\n\u2022 <code>broker-portal/components/ReviewActions.tsx</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Text in Request Changes textarea is visible (black/dark color)"
  },
  {
    "id": "BACKLOG-422",
    "title": "Fix Broker Portal Review Actions",
    "category": "fix",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-051",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-23",
    "file": "[BACKLOG-422.md](items/BACKLOG-422.md)",
    "description": "<strong>Problem</strong>\n\nReview actions on the broker portal are not functioning:\n\n1. **Reject Submission**: Clicking \"Yes\" on the confirmation dialog does nothing\n2. **Request Changes**: Shows error \"Failed to submit review. Please try again.\"\n\n<strong>Symptoms</strong>\n\n<strong>Reject Flow</strong>\n\u2022 Broker clicks \"Reject\"\n\u2022 Confirmation dialog appears\n\u2022 Clicking \"Yes, Reject Submission\" does nothing\n\u2022 Dialog stays open, no status change\n\n<strong>Request Changes Flow</strong>\n\u2022 Broker clicks \"Request Changes\"\n\u2022 Enters feedback text\n\u2022 Clicks submit\n\u2022 Error: \"Failed to submit review. Please try again.\"\n\n<strong>Investigation Needed</strong>\n\n1. Check browser console for errors\n2. Check network tab for failed API requests\n3. Verify Supabase RLS allows broker to UPDATE submissions\n4. Check if <code>reviewed_by</code>, <code>reviewed_at</code>, <code>review_notes</code> columns exist\n5. Verify the update query in the portal\n\n<strong>Likely Causes</strong>\n\n\u2022 RLS policy blocking UPDATE for brokers\n\u2022 Missing broker role in organization_members\n\u2022 Column name mismatch between code and schema\n\u2022 Supabase client not authenticated properly\n\n<strong>Files to Check</strong>\n\n\u2022 <code>broker-portal/app/dashboard/submissions/[id]/page.tsx</code>\n\u2022 <code>broker-portal/components/ReviewActions.tsx</code>\n\u2022 <code>broker-portal/lib/supabase.ts</code>\n\u2022 <code>supabase/migrations/20260122_b2b_broker_portal.sql</code> (RLS policies)\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Reject action updates submission status to 'rejected'\n\u2610 Request Changes action updates status to 'needs_changes' with notes\n\u2610 Approve action updates status to 'approved'\n\u2610 Agent sees updated status on desktop app\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-419: Audit and Restore RLS Policies\n\u2022 BACKLOG-400: Portal - Review Actions (original implementation)"
  },
  {
    "id": "BACKLOG-423",
    "title": "Fix Transactions.test.tsx Missing Mock",
    "category": "test",
    "priority": "Medium",
    "status": "Completed",
    "sprint": "SPRINT-051",
    "est_tokens": "~5K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-23",
    "file": "[BACKLOG-423.md](items/BACKLOG-423.md)",
    "description": "<strong>Description</strong>\n\nThe <code>Transactions.test.tsx</code> file is failing because it doesn't mock the <code>transactions.onSubmissionStatusChanged</code> function used by <code>useSubmissionSync</code> hook.\n\n<strong>Error</strong>\n\n<code>TypeError: transactions.onSubmissionStatusChanged is not a function\n\nat src/hooks/useSubmissionSync.ts:66:38\n</code>\n\n<strong>Solution</strong>\n\nUpdate the test mock in <code>Transactions.test.tsx</code> to include:\n\n<code>// In the mock setup\nonSubmissionStatusChanged: jest.fn().mockReturnValue(() => {}),\n</code>\n\n<strong>Files to Modify</strong>\n\n\u2022 <code>src/components/__tests__/Transactions.test.tsx</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Test mock includes <code>onSubmissionStatusChanged</code>\n\u2610 All Transactions tests pass\n\u2610 CI passes\n\n<strong>Related</strong>\n\n\u2022 useSubmissionSync.ts hook\n\u2022 SPRINT-050 submission sync feature"
  },
  {
    "id": "BACKLOG-424",
    "title": "Broker Portal Submission List UX Tweaks",
    "category": "ux",
    "priority": "Low",
    "status": "Pending",
    "sprint": "SPRINT-051",
    "est_tokens": "-",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-424.md](items/BACKLOG-424.md)",
    "description": "<strong>Description</strong>\n\nTwo UX improvements for the submission list on the broker portal dashboard:\n\n<strong>1. Make Entire Row Clickable</strong>\n\nCurrently only the \"Review\" button navigates to the submission detail. The entire row should be clickable for better UX.\n\n**Before:**\n<code>| Property | Agent | Status | Messages | Actions |\n| 123 Oak  | John  | Pending| 15 msgs  | [Review] | <- only button clickable\n</code>\n\n**After:**\n<code>| Property | Agent | Status | Submitted |\n| 123 Oak  | John  | Pending| Jan 22    | <- entire row clickable\n</code>\n\n<strong>2. Remove Docs/Messages Column</strong>\n\nThe \"Messages\" column showing message and attachment counts is not needed on the list view. This information is visible on the detail page.\n\n---\n\n<strong>Files to Modify</strong>\n\n\u2022 <code>broker-portal/components/SubmissionList.tsx</code>\n\n---\n\n<strong>Implementation</strong>\n\n<code>// Make row clickable with cursor pointer\n<tr\n  key={submission.id}\n  className=\"hover:bg-gray-50 cursor-pointer\"\n  onClick={() => router.push(<code>/dashboard/submissions/${submission.id}</code>)}\n>\n  {/* Remove Messages column */}\n  {/* Remove Actions column with Review button */}\n</tr>\n</code>\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Clicking anywhere on the row navigates to submission detail\n\u2610 Row has hover state and pointer cursor\n\u2610 Messages/Docs column removed from table\n\u2610 Review button/Actions column removed (row click replaces it)\n\n---\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-398: Portal - Dashboard + Submission List\n\u2022 SPRINT-050: B2B Broker Portal Demo"
  },
  {
    "id": "BACKLOG-425",
    "title": "Test Desktop Status Sync",
    "category": "test",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-051",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-23",
    "file": "[BACKLOG-425.md](items/BACKLOG-425.md)",
    "description": "<strong>Description</strong>\n\nVerify the full round-trip workflow between desktop app and broker portal. These features were implemented in SPRINT-050 but deferred for testing until transaction status alignment is complete.\n\n---\n\n<strong>Test Cases</strong>\n\n<strong>Desktop App - Status Sync</strong>\n\n| Test | Expected Result |\n|------|-----------------|\n| Submit transaction \u2192 Check status | Shows \"Submitted\" or \"Under Review\" |\n| After broker approves \u2192 Check status | Shows \"Approved\" |\n| After broker rejects \u2192 Check status | Shows \"Rejected\" |\n| After broker requests changes \u2192 Check status | Shows \"Needs Changes\" |\n| See broker's review notes | Notes visible in transaction detail |\n| Resubmit after changes requested | Can resubmit, status updates |\n\n<strong>Broker Portal - Review Actions</strong>\n\n| Test | Expected Result |\n|------|-----------------|\n| Filter submissions by status | List filters correctly |\n| Approve a submission | Status changes to \"Approved\" |\n| Reject a submission with reason | Status changes to \"Rejected\", reason saved |\n| Request changes with notes | Status changes to \"Needs Changes\", notes saved |\n\n<strong>Full Round-Trip Flow</strong>\n\n1. Agent submits transaction from desktop\n2. Broker sees it in portal dashboard\n3. Broker clicks \"Request Changes\" with notes\n4. Agent sees status update + notes in desktop app\n5. Agent makes changes and resubmits\n6. Broker approves resubmission\n7. Agent sees \"Approved\" status in desktop app\n\n---\n\n<strong>Dependencies</strong>\n\n\u2022 Transaction status alignment (if separate backlog item)\n\u2022 SPRINT-050 features deployed and working\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 All desktop status sync tests pass\n\u2610 All broker portal review action tests pass\n\u2610 Full round-trip flow works end-to-end\n\u2610 No console errors during workflow\n\n---\n\n<strong>Related</strong>\n\n\u2022 SPRINT-050: B2B Broker Portal Demo (implementation)\n\u2022 BACKLOG-395: Desktop - Status Sync + Review Notes Display\n\u2022 BACKLOG-400: Portal - Review Actions"
  },
  {
    "id": "BACKLOG-426",
    "title": "License Type Database Schema Support",
    "category": "schema",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-051",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-23",
    "file": "[BACKLOG-426.md](items/BACKLOG-426.md)",
    "description": "<strong>Summary</strong>\n\nAdd database support for different license types (Individual, Team, AI Add-on) with proper schema for easy account upgrades and license-aware feature gating.\n\n<strong>Category</strong>\n\nSchema / Infrastructure\n\n<strong>Priority</strong>\n\nP0 - Critical (Foundation for license-aware features)\n\n<strong>Description</strong>\n\n<strong>Problem</strong>\n\nThe current schema has basic <code>subscription_tier</code> and <code>subscription_status</code> fields but lacks:\n\u2022 Clear license types (Individual vs Team)\n\u2022 AI Detection add-on tracking\n\u2022 Easy upgrade path from Individual to Team\n\u2022 Feature flags tied to license type\n\n<strong>Solution</strong>\n\nExtend the database schema to support:\n\n1. **License Types**:\n   - <code>individual</code> - Single user, local-only features, export capability\n   - <code>team</code> - B2B, broker review workflow, submit capability\n   - <code>enterprise</code> - Future expansion\n\n2. **AI Add-on**:\n   - Separate boolean flag <code>ai_detection_enabled</code>\n   - Can be enabled for any license type\n\n3. **Feature Access Matrix**:\n\n   **Base License Features:**\n   | Feature | Individual | Team |\n   |---------|------------|------|\n   | Export button | \u2705 Yes | \u274c No |\n   | Submit for Review button | \u274c No | \u2705 Yes |\n   | Manual transaction creation | \u2705 Yes | \u2705 Yes |\n\n   **AI Add-on Features (can be added to ANY base license):**\n   | Feature | Without AI | With AI Add-on |\n   |---------|------------|----------------|\n   | Auto-detection button | \u274c Hidden | \u2705 Shown |\n   | AI transaction filters | \u274c Hidden | \u2705 Shown |\n   | AI section in New Audit | \u274c Hidden | \u2705 Shown |\n\n   **Combined Examples:**\n   - Individual + No AI: Export, manual transactions only\n   - Individual + AI: Export, manual transactions, AI detection features\n   - Team + No AI: Submit for review, manual transactions only\n   - Team + AI: Submit for review, manual transactions, AI detection features\n\n<strong>Schema Changes</strong>\n\n**Supabase <code>profiles</code> table:**\n<code>ALTER TABLE profiles\n  ADD COLUMN license_type VARCHAR(50) DEFAULT 'individual'\n    CHECK (license_type IN ('individual', 'team', 'enterprise')),\n  ADD COLUMN ai_detection_enabled BOOLEAN DEFAULT FALSE,\n  ADD COLUMN team_upgraded_at TIMESTAMPTZ,\n  ADD COLUMN team_upgraded_from_profile_id UUID;\n</code>\n\n**Local SQLite <code>users</code> table:**\n<code>ALTER TABLE users\n  ADD COLUMN license_type TEXT DEFAULT 'individual'\n    CHECK (license_type IN ('individual', 'team', 'enterprise')),\n  ADD COLUMN ai_detection_enabled INTEGER DEFAULT 0,\n  ADD COLUMN organization_id TEXT;\n</code>\n\n<strong>Device Limits</strong>\n\n**Important:** Each license allows a maximum of 1 physical device (phone) per user.\n\u2022 Supersedes BACKLOG-020 (Device UUID Licensing) and BACKLOG-021 (License Management System)\n\u2022 Device UUID should be tracked to enforce this limit\n\u2022 If user tries to connect a second device, prompt them to deactivate the first\n\n<strong>Upgrade Flow</strong>\n\nWhen Individual user joins a Team:\n1. Set <code>license_type = 'team'</code>\n2. Set <code>organization_id</code> to the org they joined\n3. Record <code>team_upgraded_at</code> timestamp\n4. Keep <code>team_upgraded_from_profile_id</code> for audit trail\n5. Existing local transactions remain accessible\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Supabase migration adds license_type and ai_detection_enabled columns\n\u2610 Local SQLite schema includes license columns\n\u2610 TypeScript types updated for new columns\n\u2610 Migration preserves existing data (defaults to 'individual')\n\u2610 Account upgrade flow works (Individual to Team)\n\u2610 AI add-on can be enabled/disabled independently\n\n<strong>Estimated Effort</strong>\n\n~20K tokens\n\n<strong>Dependencies</strong>\n\n\u2022 None (foundation for other license tasks)\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-427: License-Aware UI Components\n\u2022 BACKLOG-428: License Context Provider\n\u2022 BACKLOG-419: RLS Policies (update for license checks)"
  },
  {
    "id": "BACKLOG-427",
    "title": "License-Aware UI Components",
    "category": "ui",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-051",
    "est_tokens": "~35K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-23",
    "file": "[BACKLOG-427.md](items/BACKLOG-427.md)",
    "description": "<strong>Summary</strong>\n\nImplement UI component wrappers and conditional rendering based on:\n1. **Base license type** (Individual vs Team) - determines Export vs Submit buttons\n2. **AI Detection add-on** (separate flag, can be added to ANY base license) - determines AI features\n\n**Important:** AI add-on is NOT a license type. It's an add-on feature that can be enabled for both Individual and Team licenses.\n\n<strong>Category</strong>\n\nUI / Feature Gating\n\n<strong>Priority</strong>\n\nP0 - Critical (Core license functionality)\n\n<strong>Description</strong>\n\n<strong>Problem</strong>\n\nCurrently all UI features are visible to all users regardless of license type. Need to:\n\u2022 Show/hide Export button based on license\n\u2022 Show/hide Submit button based on license\n\u2022 Show/hide AI Detection features based on add-on status\n\n<strong>Solution</strong>\n\nCreate a license-aware UI system:\n\n1. **LicenseGate Component**:\n<code>// Generic wrapper for license-gated features\n<LicenseGate requires=\"individual\" fallback={null}>\n  <ExportButton />\n</LicenseGate>\n\n<LicenseGate requires=\"team\" fallback={null}>\n  <SubmitForReviewButton />\n</LicenseGate>\n\n<LicenseGate requires=\"ai_addon\" fallback={null}>\n  <AutoDetectionButton />\n</LicenseGate>\n</code>\n\n2. **Feature-Specific Gates**:\n\n| Feature | Component | Show When |\n|---------|-----------|-----------|\n| Export button | Transaction Details | <code>license_type === 'individual'</code> |\n| Submit button | Transaction Details | <code>license_type === 'team' && hasOrg</code> |\n| Auto-detection button | Dashboard | <code>ai_detection_enabled === true</code> |\n| AI transaction filters | Transaction List | <code>ai_detection_enabled === true</code> |\n| AI section in New Audit | AuditTransactionModal | <code>ai_detection_enabled === true</code> |\n| Manual transaction | All screens | Always visible |\n\n3. **useLicense Hook**:\n<code>const {\n  licenseType,      // 'individual' | 'team' | 'enterprise'\n  hasAIAddon,       // boolean\n  canExport,        // computed: licenseType === 'individual'\n  canSubmit,        // computed: licenseType === 'team'\n  canAutoDetect,    // computed: hasAIAddon\n  organization      // org details if team member\n} = useLicense();\n</code>\n\n<strong>Files to Modify</strong>\n\n1. **New Files**:\n   - <code>src/contexts/LicenseContext.tsx</code> - License state management\n   - <code>src/components/common/LicenseGate.tsx</code> - Conditional rendering wrapper\n   - <code>src/hooks/useLicense.ts</code> - License access hook\n\n2. **Modified Files**:\n   - <code>src/components/TransactionDetails/TransactionDetailsHeader.tsx</code> - Export/Submit buttons\n   - <code>src/components/Dashboard/Dashboard.tsx</code> - Auto-detection button\n   - <code>src/components/Transactions/TransactionFilters.tsx</code> - AI filters\n   - <code>src/components/AuditTransactionModal/AuditTransactionModal.tsx</code> - AI section\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 LicenseGate component renders children only when license matches\n\u2610 useLicense hook provides all license state and computed flags\n\u2610 Export button visible only for Individual license\n\u2610 Submit button visible only for Team license\n\u2610 Auto-detection button visible only with AI add-on\n\u2610 AI transaction filters hidden without AI add-on\n\u2610 AI section in New Audit hidden without AI add-on\n\u2610 Manual transaction screen always visible\n\n<strong>Estimated Effort</strong>\n\n~35K tokens\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-426: License Type Database Schema Support\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-428: License Context Provider\n\u2022 BACKLOG-429: License Upgrade Flow UI"
  },
  {
    "id": "BACKLOG-428",
    "title": "License Context Provider",
    "category": "service",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-051",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-23",
    "file": "[BACKLOG-428.md](items/BACKLOG-428.md)",
    "description": "<strong>Summary</strong>\n\nCreate a React Context provider that loads and manages license state from the database, providing license information throughout the application.\n\n<strong>Category</strong>\n\nService / Context\n\n<strong>Priority</strong>\n\nP0 - Critical (Required for license-aware UI)\n\n<strong>Description</strong>\n\n<strong>Problem</strong>\n\nLicense information needs to be:\n\u2022 Loaded on app start\n\u2022 Available throughout the component tree\n\u2022 Synced between local SQLite and Supabase\n\u2022 Updated when user joins/leaves organization\n\n<strong>Solution</strong>\n\n1. **LicenseContext Provider**:\n<code>interface LicenseState {\n  // Core license info\n  licenseType: 'individual' | 'team' | 'enterprise';\n  aiDetectionEnabled: boolean;\n\n  // Organization info (if team)\n  organizationId: string | null;\n  organizationName: string | null;\n  userRole: 'agent' | 'broker' | 'admin' | 'it_admin' | null;\n\n  // Loading state\n  isLoading: boolean;\n  error: Error | null;\n\n  // Actions\n  refreshLicense: () => Promise<void>;\n  upgradeToTeam: (orgId: string) => Promise<void>;\n  enableAIAddon: () => Promise<void>;\n}\n</code>\n\n2. **Data Flow**:\n<code>App Start\n    |\n    v\nCheck Local SQLite for license_type\n    |\n    v\nIf authenticated, sync with Supabase profiles\n    |\n    v\nUpdate local cache if needed\n    |\n    v\nProvide via LicenseContext\n</code>\n\n3. **Sync Strategy**:\n\u2022 Local SQLite is the primary source (offline support)\n\u2022 On login/refresh, sync with Supabase\n\u2022 If Supabase has newer data (e.g., admin enabled AI add-on), update local\n\u2022 Organization membership synced on login\n\n<strong>Integration Points</strong>\n\n\u2022 **AppStateContext**: LicenseProvider wraps or integrates with app state\n\u2022 **AuthContext**: License refresh triggered after login\n\u2022 **Database Service**: New methods for license CRUD\n\u2022 **Supabase Service**: Profile license fields sync\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 LicenseContext provides all license state\n\u2610 License loaded on app start from local database\n\u2610 License synced with Supabase on authentication\n\u2610 Organization membership loaded for team users\n\u2610 useLicense hook works in all components\n\u2610 License refresh works without app restart\n\u2610 Offline mode uses cached license state\n\n<strong>Estimated Effort</strong>\n\n~25K tokens\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-426: License Type Database Schema Support\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-427: License-Aware UI Components\n\u2022 BACKLOG-429: License Upgrade Flow UI"
  },
  {
    "id": "BACKLOG-429",
    "title": "Team Workflow E2E Testing",
    "category": "test",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-051",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-22",
    "completed_at": "2026-01-23",
    "file": "[BACKLOG-429.md](items/BACKLOG-429.md)",
    "description": "<strong>Summary</strong>\n\nComprehensive end-to-end testing of the complete team workflow: creating a transaction, submitting for review, broker approve/reject/request changes, and round-trip for changes requested.\n\n<strong>Category</strong>\n\nTesting / QA\n\n<strong>Priority</strong>\n\nP0 - Critical (User explicitly requested flawless workflow)\n\n<strong>Description</strong>\n\n<strong>Problem</strong>\n\nThe B2B broker workflow was implemented in SPRINT-050 but needs comprehensive testing to ensure:\n\u2022 Complete flow works flawlessly\n\u2022 Status sync between desktop and portal is reliable\n\u2022 Broker actions (approve/reject/request changes) work correctly\n\u2022 Agent can respond to change requests\n\n<strong>Test Scenarios</strong>\n\n#### Scenario 1: Happy Path - Approval\n1. Agent creates transaction in desktop app\n2. Agent submits transaction for review\n3. Transaction appears in broker portal\n4. Broker approves transaction\n5. Desktop app shows \"Approved\" status\n\n#### Scenario 2: Request Changes Flow\n1. Agent creates and submits transaction\n2. Broker selects \"Request Changes\"\n3. Broker enters feedback notes\n4. Agent sees \"Changes Requested\" status in desktop\n5. Agent sees broker's notes\n6. Agent makes changes and resubmits\n7. Transaction appears as \"Resubmitted\" in portal\n8. Broker approves\n9. Desktop shows \"Approved\"\n\n#### Scenario 3: Rejection Flow\n1. Agent creates and submits transaction\n2. Broker rejects with reason\n3. Desktop shows \"Rejected\" status with broker notes\n\n#### Scenario 4: Multiple Rounds\n1. Agent submits -> Broker requests changes -> Agent resubmits\n2. Broker requests more changes -> Agent resubmits again\n3. Broker approves\n4. Verify all history preserved\n\n<strong>Test Points</strong>\n\n| Step | Desktop Action | Expected Portal | Expected Desktop |\n|------|----------------|-----------------|------------------|\n| Create | New transaction | - | Transaction saved |\n| Submit | Click Submit | Submission appears | Status: Submitted |\n| Review | - | Broker sees details | - |\n| Approve | - | Status: Approved | Status: Approved |\n| Reject | - | Status: Rejected | Status: Rejected |\n| Request | - | Status: Changes | Status: Changes |\n| Resubmit | Click Resubmit | Version 2 appears | Status: Resubmitted |\n\n<strong>Known Issues to Verify</strong>\n\nFrom SPRINT-051 planning, these issues were flagged:\n\u2610 Review actions (Approve/Reject/Request Changes) may be broken\n\u2610 BACKLOG-422: Portal review actions not working\n\u2610 Status sync timing/reliability\n\u2610 Broker notes display in desktop\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Happy path (submit -> approve) works end-to-end\n\u2610 Request changes flow works (submit -> request -> resubmit -> approve)\n\u2610 Rejection flow works with broker notes visible\n\u2610 Multiple round-trips work with version tracking\n\u2610 Status sync is reliable (desktop reflects portal changes)\n\u2610 Broker notes visible to agent in desktop app\n\u2610 All existing test cases pass\n\n<strong>Estimated Effort</strong>\n\n~25K tokens\n\n<strong>Dependencies</strong>\n\n\u2022 License system working (BACKLOG-426, 427, 428)\n\u2022 Review actions working (BACKLOG-422 if needed)\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-422: Broker Portal Review Actions Not Working\n\u2022 BACKLOG-425: Test Desktop Status Sync and Broker Portal Actions\n\u2022 SPRINT-050: B2B Broker Portal Demo"
  },
  {
    "id": "BACKLOG-452",
    "title": "Admin User Management UI",
    "category": "ui",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-452.md](items/BACKLOG-452.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-453",
    "title": "Multi-org broker auth fix",
    "category": "fix",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-051",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "2026-01-23",
    "file": "[BACKLOG-453.md](items/BACKLOG-453.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-454",
    "title": "Azure AD OAuth email config",
    "category": "auth",
    "priority": "Critical",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-454.md](items/BACKLOG-454.md)",
    "description": "<strong>Summary</strong>\n\nConfigure Azure AD OAuth for enterprise email connections, enabling organizations using Microsoft 365 with Azure Active Directory to connect their work email accounts.\n\n<strong>Category</strong>\n\nAuth / Integration\n\n<strong>Priority</strong>\n\nP0 - Critical (Enterprise customer requirement)\n\n<strong>Description</strong>\n\n<strong>Problem</strong>\n\nCurrently, the app supports Microsoft personal accounts (Outlook.com) via consumer OAuth. Enterprise customers using Microsoft 365 with Azure AD cannot connect their work email accounts because:\n\n1. Azure AD requires organization-specific OAuth configuration\n2. Admin consent may be required for certain permissions\n3. Different endpoints (login.microsoftonline.com vs login.live.com)\n\n<strong>Solution</strong>\n\n1. Register app in Azure Portal with multi-tenant support\n2. Configure OAuth to use Azure AD endpoints\n3. Request appropriate Graph API permissions (Mail.Read, User.Read)\n4. Handle admin consent flow gracefully\n5. Store and refresh Azure AD tokens\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Azure AD OAuth flow works for enterprise accounts\n\u2610 Tokens are stored and refreshed correctly\n\u2610 Email sync works with Azure AD authenticated accounts\n\u2610 Clear error handling for admin consent requirements\n\u2610 Works alongside existing consumer Microsoft OAuth\n\u2610 Environment variables documented\n\n<strong>Estimated Effort</strong>\n\n~20K tokens\n\n<strong>Dependencies</strong>\n\n\u2022 Azure Portal access for app registration\n\u2022 Microsoft 365 / Azure AD test account\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-458: Email Connection Status (token validation)\n\u2022 BACKLOG-457: Sync Emails from Provider (uses authenticated connection)"
  },
  {
    "id": "BACKLOG-455",
    "title": "RLS enablement on tables",
    "category": "security",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-051",
    "est_tokens": "~5K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "2026-01-23",
    "file": "[BACKLOG-455.md](items/BACKLOG-455.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-456",
    "title": "Unify Loading Animation UI",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-456.md](items/BACKLOG-456.md)",
    "description": "<strong>Summary</strong>\n\nThe \"Waiting for keychain\" and \"Starting Magic Audit...\" loading screens use different UI styles. They should be consistent.\n\n<strong>Category</strong>\n\nUI / Polish\n\n<strong>Priority</strong>\n\nP3 - Low (Visual consistency, not functional)\n\n<strong>Description</strong>\n\n<strong>Problem</strong>\n\nDuring app startup, users see two different loading states:\n1. \"Waiting for keychain...\" - one style\n2. \"Starting Magic Audit...\" - different style\n\nThis creates a jarring visual experience during the loading sequence.\n\n<strong>Solution</strong>\n\nUnify both loading states to use the same UI component:\n\u2022 Same animation style\n\u2022 Same typography\n\u2022 Same layout/positioning\n\u2022 Consistent branding\n\n<strong>Affected Screens</strong>\n\n\u2022 Keychain unlock waiting screen\n\u2022 App initialization loading screen\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Both loading states use identical UI component\n\u2610 Animation is smooth and consistent\n\u2610 Typography matches app design system\n\u2610 Loading messages are clear and informative\n\n<strong>Estimated Effort</strong>\n\n~10K tokens\n\n<strong>Dependencies</strong>\n\nNone\n\n<strong>Related Items</strong>\n\n\u2022 Onboarding flow polish"
  },
  {
    "id": "BACKLOG-457",
    "title": "Sync Emails must fetch from provider",
    "category": "feature",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-052",
    "est_tokens": "~50K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-457.md](items/BACKLOG-457.md)",
    "description": "<strong>Summary</strong>\n\nThe \"Sync Emails\" button in transaction detail view only auto-links existing emails from the local database. It should also fetch new emails from the connected email provider (Gmail/Outlook) for the transaction's contacts.\n\n<strong>Category</strong>\n\nFeature Enhancement\n\n<strong>Priority</strong>\n\nP0 - Critical (Core functionality gap - users expect Sync Emails to actually sync)\n\n<strong>Description</strong>\n\n<strong>Current Behavior</strong>\n\n1. User clicks \"Sync Emails\" in transaction detail\n2. System searches local <code>communications</code> table for emails matching transaction contacts\n3. Links found emails to the transaction\n4. **Problem**: If emails haven't been synced from Gmail/Outlook yet, they won't be found\n\n<strong>Desired Behavior</strong>\n\n1. User clicks \"Sync Emails\" in transaction detail\n2. System identifies contact emails associated with the transaction\n3. **NEW**: Efficiently fetches recent emails involving those contacts from the provider\n4. Stores new emails in <code>communications</code> table\n5. Auto-links all matching emails to the transaction\n\n<strong>Efficiency Considerations</strong>\n\nTo avoid fetching the entire mailbox:\n\u2022 Only fetch emails for contacts on THIS transaction\n\u2022 Use provider search APIs with email address filters (e.g., <code>from:contact@example.com OR to:contact@example.com</code>)\n\u2022 Limit to transaction date range (started_at to closed_at + buffer)\n\u2022 Skip emails already in the database (dedup by message ID)\n\u2022 Consider incremental sync (only fetch since last sync)\n\n<strong>Technical Approach</strong>\n\n<code>1. Get contact emails from transaction_contacts + contact_emails\n2. Build provider-specific search query:\n   - Gmail: <code>from:(email1 OR email2) OR to:(email1 OR email2) after:YYYY/MM/DD</code>\n   - Outlook: Similar OData filter\n3. Fetch matching emails (paginated, limited)\n4. Dedup against existing communications.external_id\n5. Store new emails\n6. Run existing auto-link logic\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Sync Emails fetches new emails from provider for transaction contacts\n\u2610 Uses efficient provider search (not full mailbox scan)\n\u2610 Respects transaction date range\n\u2610 Deduplicates against existing emails\n\u2610 Shows progress indicator during fetch\n\u2610 Works with both Gmail and Outlook\n\u2610 Falls back gracefully if provider unavailable\n\n<strong>Estimated Effort</strong>\n\n~50K tokens (involves email provider APIs, efficient querying)\n\n<strong>Dependencies</strong>\n\n\u2022 Existing Gmail/Outlook OAuth connections\n\u2022 Communications table schema\n\u2022 Auto-link service\n\n<strong>Related Items</strong>\n\n\u2022 Auto-link service (<code>autoLinkService.ts</code>)\n\u2022 Email sync handlers (<code>outlookHandlers.ts</code>, Gmail handlers)\n\u2022 BACKLOG-456: Unify Loading Animation UI"
  },
  {
    "id": "BACKLOG-458",
    "title": "Email connection status mismatch",
    "category": "fix",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-052",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-458.md](items/BACKLOG-458.md)",
    "description": "<strong>Summary</strong>\n\nThe Settings UI shows email accounts (Gmail/Outlook) as \"connected\" even when the session is idle/expired. This creates user confusion when email sync fails with \"No email account connected\" error.\n\n<strong>Category</strong>\n\nBug / UX\n\n<strong>Priority</strong>\n\nP1 - High (Causes user confusion and broken workflows)\n\n<strong>Description</strong>\n\n<strong>Problem</strong>\n\n1. User connects Gmail/Outlook account successfully\n2. Session expires or becomes idle\n3. Settings UI still shows account as \"connected\" (stale UI state)\n4. User tries to sync emails\n5. Backend returns \"No email account connected\" error\n6. User is confused because UI says it's connected\n\n<strong>Root Cause</strong>\n\nThe connection status in the UI is likely:\n\u2022 Cached/stored locally and not validated against backend\n\u2022 Not checking OAuth token validity\n\u2022 Not listening for session expiration events\n\n<strong>Expected Behavior</strong>\n\n1. Connection status should reflect actual backend state\n2. When session expires, UI should update to show disconnected or prompt re-auth\n3. Proactive token refresh before expiration\n4. Clear error messaging when re-authentication is needed\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Email connection status accurately reflects backend OAuth state\n\u2610 Expired tokens trigger UI update (show disconnected or re-auth prompt)\n\u2610 Session idle state clears cached connection status\n\u2610 User sees clear message when re-authentication is needed\n\u2610 Consider proactive token refresh before expiration\n\n<strong>Technical Investigation Needed</strong>\n\n\u2022 Where is connection status stored (local state vs backend check)?\n\u2022 How are OAuth tokens validated?\n\u2022 Is there a token refresh mechanism?\n\u2022 What events should trigger status re-check?\n\n<strong>Estimated Effort</strong>\n\n~30K tokens\n\n<strong>Dependencies</strong>\n\n\u2022 OAuth token management\n\u2022 Session management\n\u2022 Settings UI state management\n\n<strong>Related Items</strong>\n\n\u2022 Session idle handling\n\u2022 OAuth token refresh logic\n\u2022 BACKLOG-457: Enhance Sync Emails to Fetch from Provider"
  },
  {
    "id": "BACKLOG-459",
    "title": "Team License Export After Submission",
    "category": "feature",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-053",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-459.md](items/BACKLOG-459.md)",
    "description": "<strong>Problem</strong>\n\nCurrent license gating in BACKLOG-427 shows:\n\u2022 Individual license: Export button only\n\u2022 Team license: Submit button only\n\nUser requirement specifies Team licenses should have **both** options:\n\u2022 Primary: Submit for Review button\n\u2022 Secondary: Export options (available after submission OR as alternative)\n\n<strong>User Story</strong>\n\n**As a** Team license user (real estate agent with broker oversight)\n**I want** to see Submit options first, then Export options after submission\n**So that** I can submit to my broker for review AND export for my own records\n\n<strong>Current Behavior (BACKLOG-427)</strong>\n\n<code>Individual License:\n  [Export] button shown\n\nTeam License:\n  [Submit for Review] button shown\n</code>\n\n<strong>Expected Behavior</strong>\n\n<code>Individual License:\n  [Export] button shown\n\nTeam License:\n  [Submit for Review] button shown (primary)\n  [Export] dropdown shown (secondary, always available)\n\n  After submission:\n  Status badge shows: \"Submitted\" / \"Under Review\" / \"Approved\" / \"Rejected\"\n  [Export] remains available for agent's records\n</code>\n\n<strong>Implementation</strong>\n\n<strong>Option A: Dual Buttons (Recommended)</strong>\nShow both buttons for Team users:\n\u2022 Submit for Review (primary, outlined)\n\u2022 Export (secondary, text/icon button)\n\n<strong>Option B: Combined Dropdown</strong>\nSingle dropdown with grouped actions:\n\u2022 Review: Submit for Review\n\u2022 Export: PDF, Folder, etc.\n\n<strong>Files to Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>src/components/transactionDetailsModule/TransactionDetailsHeader.tsx</code> | Add export button alongside submit for Team |\n| <code>src/contexts/LicenseContext.tsx</code> | Add <code>canExportAsTeam</code> computed flag (always true) |\n| <code>src/components/common/LicenseGate.tsx</code> | May need <code>requiresAny</code> prop |\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Team users see Submit for Review as primary action\n\u2610 Team users see Export as secondary action (not hidden)\n\u2610 Export is available before and after submission\n\u2610 Individual users see only Export (unchanged)\n\u2610 TypeScript compiles\n\u2610 Tests pass\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-427: License-Aware UI Components (completed)\n\u2022 BACKLOG-428: License Context Provider (completed)\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-395: Desktop - Status Sync (shows submission status)\n\u2022 BACKLOG-391: Desktop - Submit for Review UI"
  },
  {
    "id": "BACKLOG-460",
    "title": "Dashboard Notifications for Status Changes",
    "category": "feature",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-460.md](items/BACKLOG-460.md)",
    "description": "<strong>Problem</strong>\n\nWhen a broker reviews a transaction (approves, rejects, or requests changes), the agent only sees the status change when they manually open the transaction details. There's no proactive notification to alert the agent.\n\n<strong>User Story</strong>\n\n**As a** real estate agent (Team license user)\n**I want** to be notified when my broker takes action on my submission\n**So that** I can respond promptly to review feedback\n\n<strong>Current Behavior</strong>\n\n1. Agent submits transaction\n2. Broker reviews and clicks \"Request Changes\"\n3. Agent opens app later\n4. Agent must manually check each transaction to see if status changed\n5. Agent may miss time-sensitive feedback\n\n<strong>Expected Behavior</strong>\n\n1. Agent submits transaction\n2. Broker reviews and clicks \"Request Changes\"\n3. Agent opens app later\n4. Dashboard shows notification: \"1 transaction needs attention\"\n5. Clicking notification navigates to the transaction\n6. Status badge shows \"Changes Requested\" with notes visible\n\n<strong>Implementation</strong>\n\n<strong>Dashboard Notification Badge</strong>\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Dashboard                                               \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                         \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502 [!] 2 transactions need attention                 \u2502 \u2502\n\u2502  \u2502     - 123 Main St: Changes Requested              \u2502 \u2502\n\u2502  \u2502     - 456 Oak Ave: Rejected                       \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502                                                         \u2502\n\u2502  Recent Transactions                                    \u2502\n\u2502  ...                                                    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code>\n\n<strong>Status Change Detection</strong>\n\n1. On app load (and periodic refresh), check <code>submission_status</code> changes\n2. Track \"last seen\" status per transaction\n3. If status changed since last seen -> show notification\n4. Dismiss notification when user views transaction\n\n<strong>Notification Types</strong>\n\n| Status Change | Notification | Priority |\n|---------------|--------------|----------|\n| <code>submitted</code> -> <code>under_review</code> | \"Being reviewed\" | Low (info only) |\n| <code>*</code> -> <code>changes_requested</code> | \"Needs attention\" | High |\n| <code>*</code> -> <code>rejected</code> | \"Rejected\" | High |\n| <code>*</code> -> <code>approved</code> | \"Approved!\" | Medium (success) |\n\n<strong>Files to Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>src/components/Dashboard/Dashboard.tsx</code> | Add notification banner |\n| <code>src/components/Dashboard/StatusNotificationBanner.tsx</code> | **NEW** - notification component |\n| <code>src/hooks/useStatusNotifications.ts</code> | **NEW** - detect status changes |\n| <code>electron/services/transactionService.ts</code> | Add <code>getStatusChanges()</code> method |\n| <code>src/contexts/NotificationContext.tsx</code> | May extend existing context |\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Dashboard shows notification banner when status changes detected\n\u2610 Notification shows transaction address and new status\n\u2610 Clicking notification navigates to transaction detail\n\u2610 Notification dismissed after viewing transaction\n\u2610 \"Changes Requested\" and \"Rejected\" shown with high priority styling\n\u2610 \"Approved\" shown with success styling\n\u2610 TypeScript compiles\n\u2610 Tests pass\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-395: Desktop - Status Sync (provides status data)\n\u2022 BACKLOG-289: Unified Notification System (completed - can use existing components)\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-400: Portal - Review Actions (triggers the status changes)"
  },
  {
    "id": "BACKLOG-461",
    "title": "Under Review Status When Broker Opens Submission",
    "category": "feature",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-461.md](items/BACKLOG-461.md)",
    "description": "<strong>Problem</strong>\n\nCurrently, when a broker opens a submission for review, the agent's desktop app may still show \"Submitted\" status. The user expects the status to change to \"Under Review\" immediately when the broker starts reviewing.\n\n<strong>User Story</strong>\n\n**As a** real estate agent\n**I want** to see \"Under Review\" status when my broker is actively reviewing my submission\n**So that** I know my submission is being processed\n\n<strong>Current Behavior (if any)</strong>\n\nStatus progression may be:\n1. <code>not_submitted</code>\n2. <code>submitted</code>\n3. <code>approved</code> / <code>rejected</code> / <code>changes_requested</code>\n\nMissing: <code>under_review</code> intermediate state\n\n<strong>Expected Behavior</strong>\n\nStatus progression:\n1. <code>not_submitted</code> - Agent hasn't submitted\n2. <code>submitted</code> - Agent clicked Submit\n3. <code>under_review</code> - Broker opened the submission\n4. <code>approved</code> / <code>rejected</code> / <code>changes_requested</code> - Broker took action\n\n<strong>Implementation</strong>\n\n<strong>Portal Side (Trigger)</strong>\n\nWhen broker opens submission detail view:\n<code>// broker-portal/app/submissions/[id]/page.tsx\nuseEffect(() => {\n  // Mark as under review when broker views\n  await markAsUnderReview(submissionId);\n}, [submissionId]);\n</code>\n\n<strong>Supabase Side</strong>\n\n<code>-- Update submission status\nUPDATE transaction_submissions\nSET status = 'under_review', reviewed_at = NOW()\nWHERE id = $1 AND status = 'submitted';\n</code>\n\n<strong>Desktop Side (Sync)</strong>\n\nExisting status sync (BACKLOG-395) should pick up the change on next poll/refresh.\n\n<strong>Files to Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>broker-portal/app/submissions/[id]/page.tsx</code> | Trigger status update on view |\n| <code>broker-portal/lib/submissions.ts</code> | Add <code>markAsUnderReview()</code> function |\n| <code>supabase/migrations/XXXX_add_under_review_status.sql</code> | Ensure status enum includes <code>under_review</code> |\n| <code>src/types/transaction.ts</code> | Add <code>under_review</code> to submission status enum |\n\n<strong>Status Enum Update</strong>\n\n<code>type SubmissionStatus =\n  | 'not_submitted'\n  | 'submitted'\n  | 'under_review'  // NEW\n  | 'approved'\n  | 'rejected'\n  | 'changes_requested';\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 When broker opens submission, status changes to <code>under_review</code>\n\u2610 Agent's desktop app shows \"Under Review\" after sync\n\u2610 Status only changes if current status is <code>submitted</code>\n\u2610 Multiple broker views don't reset status after action taken\n\u2610 TypeScript compiles\n\u2610 Tests pass\n\n<strong>Edge Cases</strong>\n\n\u2022 Broker opens then closes without action -> stays <code>under_review</code>\n\u2022 Multiple brokers open same submission -> first open triggers change\n\u2022 Re-submission after changes requested -> goes back to <code>submitted</code>\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-395: Desktop - Status Sync\n\u2022 BACKLOG-400: Portal - Review Actions\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-460: Dashboard Notifications (uses this status)"
  },
  {
    "id": "BACKLOG-462",
    "title": "Verify AI Add-on Feature Gating Completeness",
    "category": "qa",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-053",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-462.md](items/BACKLOG-462.md)",
    "description": "<strong>Problem</strong>\n\nBACKLOG-427 (License-Aware UI Components) was completed in SPRINT-051, but we need to verify that ALL AI features are properly gated when the AI add-on is disabled.\n\nUser requirement:\n> If user doesn't have AI add-on, hide:\n> - Auto-detection button\n> - AI consent in settings\n> - AI detections in new audit button\n\n<strong>Verification Checklist</strong>\n\n<strong>1. Auto-Detection Button (Dashboard)</strong>\n\n**Location**: Dashboard main view\n**Expected**: Hidden when <code>ai_detection_enabled === false</code>\n**Verify**:\n\u2610 Button not visible without AI add-on\n\u2610 No errors in console when hidden\n\u2610 Button appears immediately when AI add-on enabled\n\n<strong>2. AI Consent in Settings</strong>\n\n**Location**: Settings -> LLM Settings / AI Features section\n**Expected**: Section hidden when <code>ai_detection_enabled === false</code>\n**Verify**:\n\u2610 AI consent toggle not visible\n\u2610 AI settings section hidden or shows \"upgrade\" message\n\u2610 No console errors\n\n<strong>3. AI Detections in New Audit Button</strong>\n\n**Location**: AuditTransactionModal / New Transaction flow\n**Expected**: AI detection options hidden when <code>ai_detection_enabled === false</code>\n**Verify**:\n\u2610 AI detection toggle not visible in new audit modal\n\u2610 \"Auto-detect from emails\" option hidden\n\u2610 Manual transaction creation still works\n\n<strong>4. AI Transaction Filters</strong>\n\n**Location**: Transactions list filter bar\n**Expected**: AI-related filters hidden when <code>ai_detection_enabled === false</code>\n**Verify**:\n\u2610 \"AI Detected\" filter not visible\n\u2610 \"Detection Status\" filter not visible\n\u2610 Other filters work normally\n\n<strong>Implementation (if gaps found)</strong>\n\nIf any features are NOT properly gated, wrap with <code><LicenseGate></code>:\n\n<code><LicenseGate requires=\"ai_addon\" fallback={null}>\n  <AIFeatureComponent />\n</LicenseGate>\n</code>\n\n<strong>Files to Check</strong>\n\n| File | Feature |\n|------|---------|\n| <code>src/components/Dashboard/Dashboard.tsx</code> | Auto-detection button |\n| <code>src/components/Dashboard/AIStatusCard.tsx</code> | AI status display |\n| <code>src/components/Settings/Settings.tsx</code> | AI consent section |\n| <code>src/components/Settings/LLMSettings.tsx</code> | AI settings |\n| <code>src/components/AuditTransactionModal/*.tsx</code> | AI detection options |\n| <code>src/components/Transactions/TransactionFilters.tsx</code> | AI filters |\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 All 4 AI features verified as properly gated\n\u2610 Test with <code>ai_detection_enabled = false</code> in local SQLite\n\u2610 Test with <code>ai_detection_enabled = true</code> to confirm features appear\n\u2610 No console errors in either state\n\u2610 Document any fixes needed\n\n<strong>Test Approach</strong>\n\n1. Set user's <code>ai_detection_enabled</code> to <code>false</code> in database\n2. Launch app and navigate through all screens\n3. Verify each AI feature is hidden\n4. Set <code>ai_detection_enabled</code> to <code>true</code>\n5. Verify all features appear\n6. Document any discrepancies\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-427: License-Aware UI Components (completed)\n\u2022 BACKLOG-428: License Context Provider (completed)\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-081: Consolidate AI Consent into T&C"
  },
  {
    "id": "BACKLOG-463",
    "title": "Single-Screen Contact Management Flow",
    "category": "ux",
    "priority": "High",
    "status": "Pending",
    "sprint": "SPRINT-055b",
    "est_tokens": "~45K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-23",
    "completed_at": "",
    "file": "[BACKLOG-463.md](items/BACKLOG-463.md)",
    "description": "<strong>Problem</strong>\n\nCurrent contact flow is two-step:\n1. Import contacts (from address book, external sources)\n2. Add/select contacts for transactions\n\nUser wants a **single-screen flow** where users can select, import, AND add contacts all in one place.\n\n<strong>User Story</strong>\n\n**As a** real estate agent creating a transaction\n**I want** to select, import, or create contacts from a single screen\n**So that** I don't have to navigate between multiple screens to add a new contact\n\n<strong>Current Flow (BACKLOG-386 + BACKLOG-418)</strong>\n\n<code>Step 1: Select Contacts screen\n  - Shows imported contacts\n  - [Import] button -> goes to Import screen\n  - [Add New] button -> goes to Add Contact form\n  - User must navigate away and back\n\nStep 2: Import Contacts screen (separate)\n  - Shows address book contacts\n  - Imports selected contacts\n  - Returns to Select Contacts\n\nStep 3: Add Contact form (separate)\n  - Manual contact creation\n  - Returns to Select Contacts\n</code>\n\n<strong>Expected Flow (Single Screen)</strong>\n\n<code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Select Contacts for Transaction                      [Done]     \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                 \u2502\n\u2502 Search: [_______________________________] [+ Add New Contact]   \u2502\n\u2502                                                                 \u2502\n\u2502 \u250c\u2500 YOUR CONTACTS \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502 \u2502 \u2611 John Smith         john@email.com          [IMPORTED]     \u2502 \u2502\n\u2502 \u2502 \u2611 Sarah Johnson      +1 (424) 555-1234       [MANUAL]       \u2502 \u2502\n\u2502 \u2502 \u2610 Bob Wilson         bob@company.com         [IMPORTED]     \u2502 \u2502\n\u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502                                                                 \u2502\n\u2502 \u250c\u2500 FROM ADDRESS BOOK (click to import) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502 \u2502 \u2610 Alice Brown        alice@example.com       [+ Import]     \u2502 \u2502\n\u2502 \u2502 \u2610 Carol Davis        carol@work.com          [+ Import]     \u2502 \u2502\n\u2502 \u2502 \u2610 ...                                                       \u2502 \u2502\n\u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502                                                                 \u2502\n\u2502 Selected: 2 contacts                                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nWhen user selects address book contact:\n\u2022 Auto-import happens in background\n\u2022 Contact moves to \"Your Contacts\" section\n\u2022 Selection checkmark applied automatically\n</code>\n\n<strong>Key Features</strong>\n\n<strong>1. Unified List with Sections</strong>\n\nTwo sections in one view:\n\u2022 **Your Contacts**: Already imported + manual contacts\n\u2022 **From Address Book**: External contacts available to import\n\n<strong>2. Inline Import</strong>\n\nWhen user checks an address book contact:\n1. Import happens automatically (async)\n2. Contact moves to \"Your Contacts\" section\n3. Checkmark retained (already selected)\n4. No navigation required\n\n<strong>3. Inline Add Contact</strong>\n\n[+ Add New Contact] opens inline form (modal or expandable section):\n\u2022 Name, Email, Phone fields\n\u2022 Save creates contact AND selects it\n\u2022 Returns to same screen with new contact visible\n\n<strong>4. Search Across Both Sections</strong>\n\nSearch filters both:\n\u2022 Your contacts (name, email, phone)\n\u2022 Address book contacts (name, email, phone)\n\n<strong>Files to Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>src/components/shared/UnifiedContactSelector.tsx</code> | **NEW** - Single-screen component |\n| <code>src/components/shared/AddressBookSection.tsx</code> | **NEW** - External contacts section |\n| <code>src/components/shared/InlineAddContact.tsx</code> | **NEW** - Inline add form |\n| <code>src/components/ContactSelectModal.tsx</code> | Replace with UnifiedContactSelector |\n| <code>src/components/audit/ContactAssignmentStep.tsx</code> | Use UnifiedContactSelector |\n| <code>src/components/transactionDetailsModule/components/modals/EditContactsModal.tsx</code> | Use UnifiedContactSelector |\n\n<strong>Data Flow</strong>\n\n<code>interface UnifiedContactSelectorProps {\n  selectedContactIds: string[];\n  onSelectionChange: (ids: string[]) => void;\n  mode: 'select' | 'multiselect';\n}\n\n// Internal state\nconst [yourContacts, setYourContacts] = useState<Contact[]>([]);\nconst [addressBookContacts, setAddressBookContacts] = useState<ExternalContact[]>([]);\nconst [searchQuery, setSearchQuery] = useState('');\n\n// On address book contact selected:\nconst handleExternalSelect = async (contact: ExternalContact) => {\n  // 1. Import contact\n  const imported = await importContact(contact);\n\n  // 2. Move to yourContacts\n  setYourContacts(prev => [...prev, imported]);\n  setAddressBookContacts(prev => prev.filter(c => c.id !== contact.id));\n\n  // 3. Add to selection\n  onSelectionChange([...selectedContactIds, imported.id]);\n};\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Single screen shows both imported contacts and address book contacts\n\u2610 Selecting address book contact auto-imports it\n\u2610 Imported contact appears in \"Your Contacts\" section immediately\n\u2610 [+ Add New Contact] opens inline form (no navigation)\n\u2610 New contact created and selected without leaving screen\n\u2610 Search works across both sections\n\u2610 No \"Import\" button navigation required\n\u2610 Used in: Transaction creation, Edit Contacts modal\n\u2610 TypeScript compiles\n\u2610 Tests pass\n\n<strong>Migration Notes</strong>\n\n\u2022 Replace ContactSelectModal with UnifiedContactSelector\n\u2022 Remove separate ImportContactsModal navigation\n\u2022 Keep ImportContactsModal for bulk import from Dashboard (optional)\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-386: Unified Contact Selection (supersedes/extends)\n\u2022 BACKLOG-418: Redesign Contact Selection UX (complements - Step 2 uses this)\n\n<strong>Estimated Effort</strong>\n\n~45K tokens (new unified component + 3 integration points + data flow)"
  },
  {
    "id": "BACKLOG-464",
    "title": "OAuth Reconnect Popup Not Opening",
    "category": "bug",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-052",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "",
    "file": "[BACKLOG-464.md](items/BACKLOG-464.md)",
    "description": "<strong>Summary</strong>\n\nWhen email connection expires, a popup/notification appears on the Dashboard with a \"Reconnect\" button. That button does nothing when clicked.\n\n**Note:** The \"Connect\" button in Settings page WORKS fine - this is only about the Dashboard popup button.\n\n<strong>Category</strong>\n\nBug / UX\n\n<strong>Priority</strong>\n\nP1 - High (Confusing UX, but workaround exists via Settings)\n\n<strong>Description</strong>\n\n<strong>Problem</strong>\n\n1. User's email connection expires\n2. Dashboard shows a popup/notification about expired connection\n3. Popup has a button to reconnect\n4. **Button does nothing when clicked**\n5. User has to manually go to Settings to reconnect\n\n<strong>Expected Behavior</strong>\n\nThe dashboard popup button should either:\n1. **Option A:** Trigger OAuth popup directly (same as Settings), OR\n2. **Option B:** Navigate to Settings and auto-scroll to Email Connection section\n\nOption B is simpler to implement.\n\n<strong>How to Reproduce</strong>\n\n1. Have an expired email connection\n2. See the dashboard notification/popup about expired connection\n3. Click the reconnect button\n4. Observe: nothing happens\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Dashboard popup button navigates to Settings OR triggers OAuth\n\u2610 If navigating to Settings, auto-scroll to Email Connection section\n\u2610 User can successfully reconnect from the popup flow\n\n<strong>Estimated Effort</strong>\n\n~10K tokens (simple navigation fix)\n\n<strong>Related Items</strong>\n\n\u2022 BACKLOG-458: Email connection status mismatch\n\u2022 PR #568: Added more UI but button still doesn't work"
  },
  {
    "id": "BACKLOG-475",
    "title": "Verify Auto-Updater End-to-End",
    "category": "infrastructure",
    "priority": "High",
    "status": "Pending",
    "sprint": "SPRINT-056",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "",
    "file": "[BACKLOG-475.md](items/BACKLOG-475.md)",
    "description": "<strong>Summary</strong>\n\nTest the existing auto-updater code end-to-end with signed builds to verify it can detect, download, and install updates.\n\n<strong>Background</strong>\n\nThe auto-updater code exists in <code>electron/main.ts</code> and <code>electron/handlers/updaterHandlers.ts</code>, but has never been tested with actual signed builds. This is a critical path for consumer release.\n\n<strong>Requirements</strong>\n\n<strong>Test Plan</strong>\n\n1. **Install v1.0.X (current)**:\n   - Build and install signed version\n   - Note version number\n\n2. **Publish v1.0.X+1**:\n   - Bump version in package.json\n   - Build and publish to GitHub Releases\n   - Include <code>latest-mac.yml</code>\n\n3. **Verify Update Flow**:\n   - Open installed v1.0.X\n   - Check logs for \"Update available\"\n   - UI should show download progress\n   - \"Install & Restart\" should work\n   - App relaunches with new version\n\n<strong>Files to Check/Modify</strong>\n\n\u2022 <code>electron/main.ts</code> (update check logic)\n\u2022 <code>src/components/Settings.tsx</code> (update UI)\n\u2022 <code>package.json</code> (publish config)\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Auto-updater detects new version\n\u2610 Download progress shown in UI\n\u2610 \"Install & Restart\" button works\n\u2610 App relaunches with correct new version\n\u2610 No manual intervention required beyond clicking install\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-406: Apple signing must be working first\n\n<strong>Related Files</strong>\n\n\u2022 <code>electron/main.ts</code>\n\u2022 <code>electron/handlers/updaterHandlers.ts</code>\n\u2022 <code>src/components/Settings.tsx</code>\n\u2022 <code>AUTO_UPDATE_GUIDE.md</code>"
  },
  {
    "id": "BACKLOG-476",
    "title": "Complete Signed Release Cycle Test",
    "category": "infrastructure",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "SPRINT-056",
    "est_tokens": "~5K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "",
    "file": "[BACKLOG-476.md](items/BACKLOG-476.md)",
    "description": "<strong>Summary</strong>\n\nDocument and validate the complete release process from code to distributed signed app.\n\n<strong>Background</strong>\n\nAfter Apple signing and auto-updater are verified, we need a documented, repeatable process for future releases.\n\n<strong>Requirements</strong>\n\n<strong>Deliverables</strong>\n\n1. **Verified Release Checklist**:\n   - Pre-release verification steps\n   - Build commands\n   - Signing verification\n   - Upload to GitHub Releases\n   - Post-release verification\n\n2. **Updated AUTO_UPDATE_GUIDE.md**:\n   - Actual workflow (not theoretical)\n   - Troubleshooting section\n   - Rollback procedure\n\n3. **Release Notes Template**:\n   - Version number format\n   - Changelog format\n   - Breaking changes section\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Release checklist document created\n\u2610 AUTO_UPDATE_GUIDE.md updated with actual workflow\n\u2610 Release notes template created\n\u2610 Process tested end-to-end at least once\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-475: Auto-updater must be verified first\n\n<strong>Related Files</strong>\n\n\u2022 <code>AUTO_UPDATE_GUIDE.md</code>\n\u2022 <code>.github/workflows/release.yml</code>"
  },
  {
    "id": "BACKLOG-477",
    "title": "User License Schema in Supabase",
    "category": "schema",
    "priority": "Critical",
    "status": "Pending",
    "sprint": "SPRINT-057",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "",
    "file": "[BACKLOG-477.md](items/BACKLOG-477.md)",
    "description": "<strong>Summary</strong>\n\nCreate <code>user_licenses</code> and <code>device_registrations</code> tables in Supabase to track user subscription status and device limits.\n\n<strong>Background</strong>\n\nMoving from local-only licensing to Supabase enables:\n\u2022 Blocking expired licenses\n\u2022 Trial transaction/device limits\n\u2022 Future team license support\n\n<strong>Requirements</strong>\n\n<strong>Schema</strong>\n\n<code>-- User license and subscription info\nCREATE TABLE user_licenses (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,\n\n  -- License type\n  license_type TEXT NOT NULL DEFAULT 'trial'\n    CHECK (license_type IN ('trial', 'individual', 'team')),\n\n  -- Trial tracking\n  trial_status TEXT DEFAULT 'active'\n    CHECK (trial_status IN ('active', 'expired', 'converted')),\n  trial_started_at TIMESTAMPTZ DEFAULT now(),\n  trial_expires_at TIMESTAMPTZ DEFAULT (now() + INTERVAL '14 days'),\n\n  -- Usage tracking\n  transaction_count INTEGER DEFAULT 0,\n  transaction_limit INTEGER DEFAULT 5,\n\n  -- Add-ons\n  ai_detection_enabled BOOLEAN DEFAULT false,\n\n  -- Organization (for team license)\n  organization_id UUID REFERENCES organizations(id),\n\n  -- Subscription (for paid)\n  subscription_status TEXT DEFAULT 'none'\n    CHECK (subscription_status IN ('none', 'active', 'cancelled', 'past_due')),\n  subscription_started_at TIMESTAMPTZ,\n  subscription_ends_at TIMESTAMPTZ,\n\n  -- Metadata\n  created_at TIMESTAMPTZ DEFAULT now(),\n  updated_at TIMESTAMPTZ DEFAULT now(),\n\n  UNIQUE(user_id)\n);\n\n-- Device registrations\nCREATE TABLE device_registrations (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,\n\n  device_id TEXT NOT NULL,\n  device_name TEXT,\n  platform TEXT CHECK (platform IN ('macos', 'windows')),\n\n  registered_at TIMESTAMPTZ DEFAULT now(),\n  last_seen_at TIMESTAMPTZ DEFAULT now(),\n  is_active BOOLEAN DEFAULT true,\n\n  UNIQUE(user_id, device_id)\n);\n</code>\n\n<strong>RLS Policies</strong>\n\n\u2022 Users can read/update their own license\n\u2022 Users can manage their own devices\n\u2022 Device limit trigger function\n\n<strong>TypeScript Types</strong>\n\nCreate <code>shared/types/license.ts</code> with corresponding interfaces.\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>user_licenses</code> table created with all columns\n\u2610 <code>device_registrations</code> table created\n\u2610 RLS policies enabled and tested\n\u2610 Device limit trigger function working\n\u2610 TypeScript types generated/created\n\n<strong>Dependencies</strong>\n\n\u2022 SPRINT-056 must be complete\n\n<strong>Related Files</strong>\n\n\u2022 <code>supabase/migrations/XXXXXXXX_user_licenses.sql</code>\n\u2022 <code>shared/types/license.ts</code>"
  },
  {
    "id": "BACKLOG-478",
    "title": "License Validation Service",
    "category": "service",
    "priority": "Critical",
    "status": "Pending",
    "sprint": "SPRINT-057",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "",
    "file": "[BACKLOG-478.md](items/BACKLOG-478.md)",
    "description": "<strong>Summary</strong>\n\nCreate a service layer for validating user licenses against Supabase.\n\n<strong>Background</strong>\n\nThe license validation service will be called at app start and during sensitive operations to ensure the user has a valid license.\n\n<strong>Requirements</strong>\n\n<strong>Service Interface</strong>\n\n<code>// electron/services/licenseService.ts\nexport interface LicenseStatus {\n  isValid: boolean;\n  licenseType: 'trial' | 'individual' | 'team';\n  trialStatus?: 'active' | 'expired' | 'converted';\n  trialDaysRemaining?: number;\n  transactionCount: number;\n  transactionLimit: number;\n  canCreateTransaction: boolean;\n  deviceCount: number;\n  deviceLimit: number;\n  aiEnabled: boolean;\n  blockReason?: 'expired' | 'limit_reached' | 'no_license';\n}\n\nexport async function validateLicense(userId: string): Promise<LicenseStatus>;\nexport async function incrementTransactionCount(userId: string): Promise<void>;\nexport async function createUserLicense(userId: string): Promise<void>;\n</code>\n\n<strong>Implementation Requirements</strong>\n\n1. Fetch <code>user_licenses</code> from Supabase\n2. Check trial expiry (14 days from start)\n3. Check transaction limit (5 for trial)\n4. Return comprehensive status object\n5. Handle network failures gracefully (offline mode)\n\n<strong>Offline Behavior</strong>\n\n\u2022 Cache last known license status locally\n\u2022 Allow 24-hour grace period if cannot reach Supabase\n\u2022 Block after grace period expires\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>validateLicense()</code> returns correct status for all license types\n\u2610 <code>incrementTransactionCount()</code> updates Supabase\n\u2610 <code>createUserLicense()</code> creates trial license for new users\n\u2610 Offline grace period works correctly\n\u2610 All edge cases handled (no license, expired, etc.)\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-477: Schema must exist first\n\n<strong>Related Files</strong>\n\n\u2022 <code>electron/services/licenseService.ts</code>\n\u2022 <code>electron/license-handlers.ts</code>"
  },
  {
    "id": "BACKLOG-479",
    "title": "Device Registration Service",
    "category": "service",
    "priority": "High",
    "status": "Pending",
    "sprint": "SPRINT-057",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "",
    "file": "[BACKLOG-479.md](items/BACKLOG-479.md)",
    "description": "<strong>Summary</strong>\n\nCreate a service for managing device registrations and enforcing device limits.\n\n<strong>Background</strong>\n\nDevice limits prevent account sharing:\n\u2022 Trial: 1 device\n\u2022 Individual: 2 devices\n\u2022 Team: Unlimited\n\n<strong>Requirements</strong>\n\n<strong>Service Interface</strong>\n\n<code>// electron/services/deviceService.ts\nexport async function registerDevice(userId: string): Promise<{\n  success: boolean;\n  error?: 'device_limit_reached' | 'already_registered';\n}>;\n\nexport async function getDeviceId(): Promise<string>;\nexport async function deactivateDevice(userId: string, deviceId: string): Promise<void>;\nexport async function listDevices(userId: string): Promise<DeviceRegistration[]>;\n</code>\n\n<strong>Implementation Requirements</strong>\n\n1. **Device ID Generation**:\n   - Use machine-specific identifier (machine-id package or similar)\n   - Persist if regeneration is problematic\n\n2. **Registration Flow**:\n   - Check if device already registered\n   - If new, check against limit (trigger handles this)\n   - Register and return success\n\n3. **Device Management**:\n   - List active devices for user\n   - Deactivate device (for \"log out everywhere\" feature)\n\n<strong>Error Handling</strong>\n\n\u2022 Clear error message when device limit reached\n\u2022 UI should show which devices are registered\n\u2022 Option to deactivate a device remotely\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>getDeviceId()</code> returns consistent ID for same machine\n\u2610 <code>registerDevice()</code> succeeds when under limit\n\u2610 <code>registerDevice()</code> fails gracefully when limit reached\n\u2610 <code>deactivateDevice()</code> marks device inactive\n\u2610 <code>listDevices()</code> returns all registered devices\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-477: Schema must exist first\n\n<strong>Related Files</strong>\n\n\u2022 <code>electron/services/deviceService.ts</code>\n\u2022 <code>package.json</code> (may need machine-id dependency)"
  },
  {
    "id": "BACKLOG-480",
    "title": "License Check at App Start",
    "category": "service",
    "priority": "Critical",
    "status": "Pending",
    "sprint": "SPRINT-057",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "",
    "file": "[BACKLOG-480.md](items/BACKLOG-480.md)",
    "description": "<strong>Summary</strong>\n\nIntegrate license validation into the app startup flow to block users with expired or invalid licenses.\n\n<strong>Background</strong>\n\nAfter authentication, the app must validate the user's license before allowing access to the main application.\n\n<strong>Requirements</strong>\n\n<strong>App Start Flow</strong>\n\n<code>async function initializeLicense(userId: string): Promise<void> {\n  // 1. Validate license\n  const status = await validateLicense(userId);\n\n  // 2. If blocked, show appropriate screen\n  if (!status.isValid) {\n    switch (status.blockReason) {\n      case 'expired':\n        showUpgradeScreen('trial_expired');\n        break;\n      case 'limit_reached':\n        showUpgradeScreen('limit_reached');\n        break;\n      case 'no_license':\n        await createUserLicense(userId);\n        break;\n    }\n    return;\n  }\n\n  // 3. Register device if not already\n  const deviceResult = await registerDevice(userId);\n  if (!deviceResult.success && deviceResult.error === 'device_limit_reached') {\n    showDeviceLimitScreen();\n    return;\n  }\n\n  // 4. Continue to app\n}\n</code>\n\n<strong>Integration Points</strong>\n\n1. **Main Process** (<code>electron/main.ts</code>):\n   - Initialize license check after auth callback\n   - Send license status to renderer\n\n2. **App Component** (<code>src/App.tsx</code>):\n   - Add license gate before main app content\n   - Show blocking screens when appropriate\n\n3. **Auth Flow**:\n   - Integrate with existing useAuthFlow\n   - Handle license creation for new users\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 License validated on every app start\n\u2610 Expired trial blocks access with upgrade prompt\n\u2610 Transaction limit shows warning when approaching\n\u2610 Device limit blocks with device management option\n\u2610 New users get trial license created automatically\n\u2610 Offline grace period works\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-478: License service must exist\n\u2022 BACKLOG-479: Device service must exist\n\n<strong>Related Files</strong>\n\n\u2022 <code>electron/main.ts</code>\n\u2022 <code>src/App.tsx</code>\n\u2022 <code>src/appCore/state/flows/useAuthFlow.ts</code>"
  },
  {
    "id": "BACKLOG-481",
    "title": "Trial Limit Enforcement UI",
    "category": "ui",
    "priority": "High",
    "status": "Pending",
    "sprint": "SPRINT-057",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "",
    "file": "[BACKLOG-481.md](items/BACKLOG-481.md)",
    "description": "<strong>Summary</strong>\n\nCreate UI components to display trial status and enforce limits.\n\n<strong>Background</strong>\n\nUsers need clear feedback about their trial status, limits, and path to upgrade.\n\n<strong>Requirements</strong>\n\n<strong>Components</strong>\n\n1. **TrialStatusBanner**:\n   - Shows trial days remaining\n   - Progress bar for transaction count\n   - \"Upgrade\" CTA\n\n2. **TransactionLimitWarning**:\n   - Modal shown when approaching limit (4/5)\n   - Prevents creation when at limit (5/5)\n   - Clear upgrade path\n\n3. **UpgradeScreen**:\n   - Full-screen blocking when trial expired\n   - Clear value proposition\n   - Pricing and upgrade CTA\n\n4. **DeviceLimitScreen**:\n   - Shows registered devices\n   - Option to deactivate a device\n   - Explains why blocked\n\n<strong>Design Requirements</strong>\n\n\u2022 Consistent with existing app design\n\u2022 Non-intrusive banner for active trial\n\u2022 Clear, not aggressive upgrade messaging\n\u2022 Easy device management\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Trial banner shows in dashboard\n\u2610 Transaction limit warning appears at 4/5\n\u2610 Creation blocked at 5/5 with upgrade prompt\n\u2610 Upgrade screen blocks expired trials\n\u2610 Device limit screen allows deactivation\n\u2610 All components match app design\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-480: License check must be integrated\n\n<strong>Related Files</strong>\n\n\u2022 <code>src/components/license/TrialStatusBanner.tsx</code>\n\u2022 <code>src/components/license/TransactionLimitWarning.tsx</code>\n\u2022 <code>src/components/license/UpgradeScreen.tsx</code>\n\u2022 <code>src/components/license/DeviceLimitScreen.tsx</code>"
  },
  {
    "id": "BACKLOG-482",
    "title": "Desktop Deep Link Handler",
    "category": "infrastructure",
    "priority": "Critical",
    "status": "Pending",
    "sprint": "SPRINT-058",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "",
    "file": "[BACKLOG-482.md](items/BACKLOG-482.md)",
    "description": "<strong>Summary</strong>\n\nImplement <code>magicaudit://</code> URL scheme handling so the desktop app can receive authentication callbacks from the browser.\n\n<strong>Background</strong>\n\nBrowser-based auth requires the ability to redirect back to the desktop app via deep links (like Figma, Slack, VS Code).\n\n<strong>Requirements</strong>\n\n<strong>macOS Implementation</strong>\n\n1. **Register URL Scheme** (electron-builder config):\n   <code>   {\n     \"protocols\": {\n       \"name\": \"Magic Audit\",\n       \"schemes\": [\"magicaudit\"]\n     }\n   }\n   </code>\n\n2. **Entitlements** (build/entitlements.mac.plist):\n   <code>   <key>com.apple.developer.associated-domains</key>\n   <array>\n     <string>applinks:auth.magicaudit.com</string>\n   </array>\n   </code>\n\n3. **Handler** (electron/main.ts):\n   <code>   app.on('open-url', (event, url) => {\n     event.preventDefault();\n     handleAuthCallback(url);\n   });\n   </code>\n\n<strong>Windows Implementation</strong>\n\n<code>// Windows uses second instance\napp.on('second-instance', (event, commandLine) => {\n  const url = commandLine.find(arg => arg.startsWith('magicaudit://'));\n  if (url) handleAuthCallback(url);\n});\n</code>\n\n<strong>Callback Handler</strong>\n\n<code>function handleAuthCallback(url: string) {\n  const parsed = new URL(url);\n  // magicaudit://callback?access_token=...&refresh_token=...\n\n  const accessToken = parsed.searchParams.get('access_token');\n  const refreshToken = parsed.searchParams.get('refresh_token');\n\n  if (accessToken && refreshToken) {\n    mainWindow?.webContents.send('auth:callback', {\n      accessToken,\n      refreshToken\n    });\n  }\n}\n</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 URL scheme registered in electron-builder config\n\u2610 macOS <code>open-url</code> handler implemented\n\u2610 Windows <code>second-instance</code> handler implemented\n\u2610 Callback sends tokens to renderer\n\u2610 App opens when <code>magicaudit://callback?token=test</code> is triggered\n\u2610 Works when app is already running\n\u2610 Works when app is not running (cold start)\n\n<strong>Dependencies</strong>\n\n\u2022 SPRINT-057 must be complete\n\n<strong>Related Files</strong>\n\n\u2022 <code>electron/main.ts</code>\n\u2022 <code>electron-builder.yml</code> or <code>package.json</code>\n\u2022 <code>build/entitlements.mac.plist</code>\n\u2022 <code>electron/preload.ts</code>"
  },
  {
    "id": "BACKLOG-483",
    "title": "Browser Auth Landing Page",
    "category": "ui",
    "priority": "Critical",
    "status": "Pending",
    "sprint": "SPRINT-058",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "",
    "file": "[BACKLOG-483.md](items/BACKLOG-483.md)",
    "description": "<strong>Summary</strong>\n\nCreate a web page in the broker-portal that handles OAuth and redirects to the desktop app.\n\n<strong>Background</strong>\n\nThe browser auth page allows users to log in using their browser (better password manager support, familiar UX) and then redirects back to the desktop app.\n\n<strong>Requirements</strong>\n\n<strong>Pages to Create</strong>\n\n1. **Desktop Auth Page** (<code>/auth/desktop</code>):\n   <code>   // broker-portal/app/auth/desktop/page.tsx\n   export default function DesktopAuth() {\n     return (\n       <div className=\"min-h-screen flex items-center justify-center\">\n         <div className=\"space-y-4\">\n           <h1>Sign in to Magic Audit</h1>\n           <button onClick={loginWithGoogle}>Continue with Google</button>\n           <button onClick={loginWithMicrosoft}>Continue with Microsoft</button>\n         </div>\n       </div>\n     );\n   }\n   </code>\n\n2. **Callback Page** (<code>/auth/desktop/callback</code>):\n   - Gets session from Supabase after OAuth\n   - Redirects to <code>magicaudit://callback?access_token=...&refresh_token=...</code>\n   - Shows \"Redirecting to Magic Audit...\" message\n   - Fallback link if redirect doesn't work\n\n<strong>Flow</strong>\n\n<code>1. Desktop opens: https://app.magicaudit.com/auth/desktop\n2. User clicks login option\n3. OAuth flow in browser\n4. Callback redirects to magicaudit://callback\n5. Desktop receives tokens\n</code>\n\n<strong>Supabase Configuration</strong>\n\n\u2022 Add <code>https://app.magicaudit.com/auth/desktop/callback</code> to redirect URLs\n\u2022 Configure for both Google and Microsoft OAuth\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Auth page shows Google and Microsoft login buttons\n\u2610 OAuth flow completes successfully\n\u2610 Callback page redirects to desktop app\n\u2610 Fallback link works if auto-redirect fails\n\u2610 Loading/redirect states are clear to user\n\u2610 Works with both OAuth providers\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-482: Desktop deep link handler must work first\n\n<strong>Related Files</strong>\n\n\u2022 <code>broker-portal/app/auth/desktop/page.tsx</code>\n\u2022 <code>broker-portal/app/auth/desktop/callback/page.tsx</code>\n\u2022 Supabase dashboard (redirect URLs)"
  },
  {
    "id": "BACKLOG-484",
    "title": "License Validation at Auth",
    "category": "service",
    "priority": "Critical",
    "status": "completed",
    "sprint": "SPRINT-058",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "",
    "file": "[BACKLOG-484.md](items/BACKLOG-484.md)",
    "description": "<strong>Summary</strong>\n\nIntegrate license validation immediately after successful authentication to block users before they enter the app.\n\n<strong>Background</strong>\n\nLicense validation should happen as the final step of authentication, not as a separate gate inside the app. This ensures consistent blocking for expired licenses.\n\n<strong>Requirements</strong>\n\n<strong>Implementation</strong>\n\n<code>// In auth callback handler\nasync function handleAuthSuccess(accessToken: string, refreshToken: string) {\n  // 1. Set session\n  const { data: { user } } = await supabase.auth.setSession({\n    access_token: accessToken,\n    refresh_token: refreshToken\n  });\n\n  if (!user) {\n    showError('Login failed');\n    return;\n  }\n\n  // 2. Validate license\n  const licenseStatus = await validateLicense(user.id);\n\n  if (!licenseStatus.isValid) {\n    navigateTo('/license-blocked', { reason: licenseStatus.blockReason });\n    return;\n  }\n\n  // 3. Register device\n  const deviceResult = await registerDevice(user.id);\n\n  if (!deviceResult.success) {\n    navigateTo('/device-limit');\n    return;\n  }\n\n  // 4. Continue to app\n  navigateTo('/dashboard');\n}\n</code>\n\n<strong>Integration Points</strong>\n\n1. **Main Process**:\n   - Handle <code>auth:callback</code> from deep link\n   - Validate license before showing main window\n\n2. **Renderer**:\n   - Update app state based on license status\n   - Route to appropriate screen\n\n3. **License Context**:\n   - Update to read from Supabase\n   - Keep local cache for quick access\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 License validated immediately after auth\n\u2610 Expired license blocks before entering app\n\u2610 Device registration happens after license check\n\u2610 Device limit shows management screen\n\u2610 New users get trial license created\n\u2610 License context updated from Supabase\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-483: Browser auth must work first\n\u2022 Uses services from SPRINT-057\n\n<strong>Related Files</strong>\n\n\u2022 <code>electron/main.ts</code>\n\u2022 <code>src/App.tsx</code>\n\u2022 <code>src/contexts/LicenseContext.tsx</code>"
  },
  {
    "id": "BACKLOG-485",
    "title": "Deprecate OAuth Popup Flow",
    "category": "refactor",
    "priority": "Medium",
    "status": "pending",
    "sprint": "SPRINT-058",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "",
    "file": "[BACKLOG-485.md](items/BACKLOG-485.md)",
    "description": "<strong>Summary</strong>\n\nRemove or deprecate the old OAuth popup flow in favor of the new browser-based authentication.\n\n<strong>Background</strong>\n\nThe old OAuth popup approach has issues:\n\u2022 Password managers don't work well\n\u2022 Security concerns with Electron popups\n\u2022 Inconsistent UX across platforms\n\nThe new browser-based flow is the standard approach (Figma, Slack, VS Code).\n\n<strong>Requirements</strong>\n\n<strong>Deprecation Steps</strong>\n\n1. **Update Login UI**:\n   - \"Login with Google\" now opens browser\n   - \"Login with Microsoft\" now opens browser\n   - Remove popup-related code from UI\n\n2. **Deprecate (Don't Delete) Services**:\n   <code>   // electron/services/googleAuthService.ts\n   /**\n    * @deprecated Use browser-based auth flow instead\n    * This code is kept for reference but should not be used.\n    */\n   export async function signInWithPopup() {\n     throw new Error('Deprecated: Use browser-based auth');\n   }\n   </code>\n\n3. **Update Documentation**:\n   - <code>AUTO_UPDATE_GUIDE.md</code>\n   - Any auth-related docs\n\n<strong>Why Deprecate, Not Delete</strong>\n\n\u2022 Reference for edge cases\n\u2022 Rollback capability if browser flow has issues\n\u2022 Understanding of previous approach\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Login buttons open browser instead of popup\n\u2610 Popup code marked as deprecated\n\u2610 No popup windows opened during auth\n\u2610 Documentation updated\n\u2610 Both Google and Microsoft use browser flow\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-484: Browser auth must be fully working first\n\n<strong>Related Files</strong>\n\n\u2022 <code>src/components/LoginScreen.tsx</code> (or equivalent)\n\u2022 <code>electron/services/googleAuthService.ts</code>\n\u2022 <code>electron/services/microsoftAuthService.ts</code>\n\u2022 <code>electron/handlers/googleAuthHandlers.ts</code>\n\u2022 <code>electron/handlers/microsoftAuthHandlers.ts</code>"
  },
  {
    "id": "BACKLOG-486",
    "title": "PostHog SDK Integration",
    "category": "infrastructure",
    "priority": "Critical",
    "status": "Pending",
    "sprint": "SPRINT-059",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "",
    "file": "[BACKLOG-486.md](items/BACKLOG-486.md)",
    "description": "<strong>Summary</strong>\n\nInstall and configure PostHog analytics SDK for Electron.\n\n<strong>Background</strong>\n\nPostHog provides a generous free tier (1M events/month), official Electron support, and privacy-focused features including built-in opt-out.\n\n<strong>Requirements</strong>\n\n<strong>Installation</strong>\n\n<code>npm install posthog-js\n</code>\n\n<strong>Telemetry Service</strong>\n\n<code>// electron/services/telemetryService.ts\nimport posthog from 'posthog-js';\n\nconst POSTHOG_API_KEY = process.env.POSTHOG_API_KEY || '';\nconst POSTHOG_HOST = 'https://us.i.posthog.com';\n\nlet initialized = false;\n\nexport function initTelemetry(): void {\n  if (initialized || !POSTHOG_API_KEY) return;\n\n  const optedOut = getOptOutPreference();\n  if (optedOut) return;\n\n  posthog.init(POSTHOG_API_KEY, {\n    api_host: POSTHOG_HOST,\n    persistence: 'localStorage',\n    autocapture: false,\n    capture_pageview: false,\n    capture_pageleave: false,\n    disable_session_recording: true,\n  });\n\n  initialized = true;\n}\n\nexport function identify(userId: string, traits?: Record<string, unknown>): void;\nexport function track(event: string, properties?: Record<string, unknown>): void;\nexport function reset(): void;\n</code>\n\n<strong>Environment Variables</strong>\n\nAdd to <code>.env.example</code>:\n<code>POSTHOG_API_KEY=phc_xxxxxxxxxxxxx\n</code>\n\n<strong>Initialization</strong>\n\nCall <code>initTelemetry()</code> in <code>electron/main.ts</code> after app ready.\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 PostHog SDK installed\n\u2610 Telemetry service created with init/identify/track/reset\n\u2610 Environment variable configured\n\u2610 Initialized on app ready\n\u2610 Test event can be sent and appears in PostHog dashboard\n\n<strong>Dependencies</strong>\n\n\u2022 SPRINT-058 must be complete (need auth working to identify users)\n\n<strong>Related Files</strong>\n\n\u2022 <code>electron/services/telemetryService.ts</code>\n\u2022 <code>electron/main.ts</code>\n\u2022 <code>.env.example</code>\n\u2022 <code>package.json</code>"
  },
  {
    "id": "BACKLOG-487",
    "title": "Core Lifecycle Events",
    "category": "service",
    "priority": "Critical",
    "status": "Pending",
    "sprint": "SPRINT-059",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "",
    "file": "[BACKLOG-487.md](items/BACKLOG-487.md)",
    "description": "<strong>Summary</strong>\n\nImplement tracking for core app lifecycle events: app start, close, sign in, sign out.\n\n<strong>Background</strong>\n\nThese are the foundational events for understanding user sessions and authentication patterns.\n\n<strong>Requirements</strong>\n\n<strong>Events to Track</strong>\n\n| Event | When | Properties |\n|-------|------|------------|\n| <code>app_started</code> | App launch completes | <code>version</code>, <code>platform</code>, <code>license_type</code> |\n| <code>app_closed</code> | App closes | <code>session_duration_seconds</code> |\n| <code>user_signed_in</code> | Auth completes | <code>provider</code> |\n| <code>user_signed_out</code> | Logout | - |\n\n<strong>Implementation</strong>\n\n1. **App Lifecycle** (electron/main.ts):\n   <code>   app.on('ready', () => {\n     initTelemetry();\n     track('app_started', {\n       version: app.getVersion(),\n       platform: process.platform,\n     });\n   });\n\n   app.on('before-quit', () => {\n     track('app_closed', {\n       session_duration_seconds: getSessionDuration(),\n     });\n   });\n   </code>\n\n2. **Auth Events**:\n   <code>   // After successful auth\n   track('user_signed_in', { provider: 'google' });\n   identify(userId, {\n     license_type: licenseStatus.licenseType,\n     platform: process.platform,\n   });\n   </code>\n\n3. **Session Duration**:\n   - Track app start time\n   - Calculate duration on quit\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 <code>app_started</code> fires on launch with version and platform\n\u2610 <code>app_closed</code> fires on quit with session duration\n\u2610 <code>user_signed_in</code> fires after successful auth with provider\n\u2610 <code>user_signed_out</code> fires on logout\n\u2610 User identified with license type after sign in\n\u2610 Events appear in PostHog dashboard\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-486: PostHog SDK must be integrated\n\n<strong>Related Files</strong>\n\n\u2022 <code>electron/main.ts</code>\n\u2022 <code>electron/services/telemetryService.ts</code>\n\u2022 <code>src/appCore/state/flows/useAuthFlow.ts</code>"
  },
  {
    "id": "BACKLOG-488",
    "title": "Transaction & Feature Events",
    "category": "service",
    "priority": "High",
    "status": "Pending",
    "sprint": "SPRINT-059",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "",
    "file": "[BACKLOG-488.md](items/BACKLOG-488.md)",
    "description": "<strong>Summary</strong>\n\nImplement tracking for transaction lifecycle and feature usage events.\n\n<strong>Background</strong>\n\nUnderstanding how users interact with transactions and features drives product decisions.\n\n<strong>Requirements</strong>\n\n<strong>Transaction Events</strong>\n\n| Event | When | Properties |\n|-------|------|------------|\n| <code>transaction_created</code> | New transaction | <code>source</code> (manual/detected), <code>has_contacts</code> |\n| <code>transaction_updated</code> | Edit transaction | <code>fields_changed[]</code> |\n| <code>transaction_exported</code> | Export completes | <code>format</code>, <code>contact_count</code>, <code>message_count</code> |\n| <code>transaction_submitted</code> | Submit for review | <code>has_attachments</code> |\n| <code>transaction_closed</code> | Mark closed | <code>days_active</code> |\n\n<strong>Sync Events</strong>\n\n| Event | When | Properties |\n|-------|------|------------|\n| <code>sync_started</code> | Sync begins | <code>type</code>, <code>provider</code> |\n| <code>sync_completed</code> | Sync completes | <code>type</code>, <code>items_synced</code>, <code>duration_seconds</code> |\n| <code>sync_failed</code> | Sync errors | <code>type</code>, <code>error_code</code> |\n\n<strong>Feature Events</strong>\n\n| Event | When | Properties |\n|-------|------|------------|\n| <code>ai_detection_used</code> | AI analyzes | <code>message_count</code>, <code>transactions_detected</code> |\n| <code>contact_linked</code> | Contact added | <code>link_type</code> (manual/auto) |\n| <code>message_attached</code> | Message attached | <code>message_type</code> (email/text) |\n\n<strong>Implementation</strong>\n\nAdd tracking calls to relevant services:\n\u2022 <code>transactionService.ts</code>\n\u2022 <code>syncService.ts</code> / sync flows\n\u2022 <code>aiDetectionService.ts</code>\n\u2022 <code>contactService.ts</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Transaction lifecycle events tracked\n\u2610 Sync events tracked with duration\n\u2610 Feature usage events tracked\n\u2610 Properties capture relevant context (no PII)\n\u2610 Events appear in PostHog dashboard\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-486: PostHog SDK must be integrated\n\n<strong>Related Files</strong>\n\n\u2022 <code>electron/services/transactionService.ts</code>\n\u2022 <code>electron/services/syncService.ts</code>\n\u2022 <code>electron/services/aiDetectionService.ts</code>\n\u2022 <code>electron/services/contactService.ts</code>"
  },
  {
    "id": "BACKLOG-489",
    "title": "Privacy Controls & Error Tracking",
    "category": "service",
    "priority": "High",
    "status": "Pending",
    "sprint": "SPRINT-059",
    "est_tokens": "~5K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "",
    "file": "[BACKLOG-489.md](items/BACKLOG-489.md)",
    "description": "<strong>Summary</strong>\n\nImplement user opt-out controls and error tracking for debugging.\n\n<strong>Background</strong>\n\nUsers should be able to opt out of analytics, and errors should be tracked (without PII) for debugging.\n\n<strong>Requirements</strong>\n\n<strong>Privacy Controls</strong>\n\n1. **Settings Toggle**:\n   <code>   <Toggle\n     label=\"Send anonymous usage data\"\n     checked={!telemetryOptedOut}\n     onChange={(checked) => setTelemetryOptOut(!checked)}\n   />\n   <Text size=\"sm\" color=\"dimmed\">\n     Help improve Magic Audit by sharing anonymous usage statistics.\n     No personal data or message content is ever shared.\n   </Text>\n   </code>\n\n2. **Preference Storage**:\n   <code>   export function getOptOutPreference(): boolean {\n     return localStorage.getItem('telemetry_opt_out') === 'true';\n   }\n\n   export function setOptOutPreference(optOut: boolean): void {\n     localStorage.setItem('telemetry_opt_out', String(optOut));\n     if (optOut) {\n       posthog.opt_out_capturing();\n     } else {\n       posthog.opt_in_capturing();\n     }\n   }\n   </code>\n\n<strong>Error Tracking</strong>\n\n1. **Renderer Errors**:\n   <code>   window.addEventListener('error', (event) => {\n     track('error_occurred', {\n       error_type: event.error?.name || 'Unknown',\n       message: event.message,\n       component: 'renderer',\n     });\n   });\n   </code>\n\n2. **Main Process Errors**:\n   <code>   process.on('uncaughtException', (error) => {\n     track('error_occurred', {\n       error_type: error.name,\n       message: error.message,\n       component: 'main',\n     });\n   });\n   </code>\n\n<strong>Privacy Guarantees</strong>\n\n**DO NOT track**:\n\u2022 Message content\n\u2022 Contact names/emails\n\u2022 Transaction details\n\u2022 Full error stack traces\n\n**DO track**:\n\u2022 Error types and components\n\u2022 Anonymous usage patterns\n\u2022 Feature counts\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Opt-out toggle in Settings\n\u2610 Preference persisted and respected\n\u2610 PostHog stops capturing when opted out\n\u2610 Error tracking captures type and component\n\u2610 No PII in error events\n\u2610 Clear explanation text for users\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-487: Core events must be working\n\u2022 BACKLOG-488: Feature events must be working\n\n<strong>Related Files</strong>\n\n\u2022 <code>src/components/Settings.tsx</code>\n\u2022 <code>electron/services/telemetryService.ts</code>\n\u2022 <code>electron/main.ts</code>\n\u2022 <code>src/main.tsx</code>"
  },
  {
    "id": "BACKLOG-490",
    "title": "Fix EMAIL_CONNECTED Not Updating in Ready State",
    "category": "bug",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-052",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "2026-01-25",
    "file": "[BACKLOG-490.md](items/BACKLOG-490.md)",
    "description": "<strong>Summary</strong>\n\nDashboard shows \"Complete your account setup\" banner even after user connects email from Settings, because the <code>EMAIL_CONNECTED</code> action in the reducer only handles the onboarding state.\n\n<strong>Bug Report</strong>\n\n**Discovered**: SPRINT-052/053 testing\n**Severity**: High (affects user experience, confusing UI state)\n\n<strong>Symptoms</strong>\n\n1. User completes onboarding (first-time setup)\n2. Later, user connects Microsoft Outlook via Settings\n3. Settings shows email as \"Connected\" (green status)\n4. Dashboard still shows \"Complete your account setup\" banner\n5. Banner persists until app restart or manual refresh\n\n<strong>Root Cause</strong>\n\nThe <code>EMAIL_CONNECTED</code> action in the app state reducer only handles the onboarding state:\n\n<code>case \"EMAIL_CONNECTED\": {\n  if (state.status !== \"onboarding\") {\n    return state;  // DOES NOTHING if already in \"ready\" state!\n  }\n  // ... rest of onboarding logic\n}\n</code>\n\nWhen the user connects email from Settings (after onboarding is complete), <code>state.userData.hasEmailConnected</code> is never updated because the reducer returns early.\n\n<strong>Requirements</strong>\n\n<strong>Fix the Reducer</strong>\n\n1. **Handle EMAIL_CONNECTED in ready state**:\n   <code>   case \"EMAIL_CONNECTED\": {\n     if (state.status === \"ready\") {\n       return {\n         ...state,\n         userData: {\n           ...state.userData,\n           hasEmailConnected: true,\n         },\n       };\n     }\n     if (state.status !== \"onboarding\") {\n       return state;\n     }\n     // ... existing onboarding logic\n   }\n   </code>\n\n2. **Verify action dispatch**:\n   - Confirm <code>EMAIL_CONNECTED</code> action is dispatched from Settings email connect\n   - Check <code>src/appCore/state/flows/useEmailHandlers.ts</code> for dispatch logic\n\n<strong>Verify Dashboard Logic</strong>\n\n1. Confirm Dashboard uses <code>userData.hasEmailConnected</code> for banner visibility\n2. Ensure banner hides immediately when state updates (no stale state)\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Connect email from Settings updates <code>userData.hasEmailConnected</code> to true\n\u2610 Dashboard \"Complete your account setup\" banner disappears immediately\n\u2610 Works for both Gmail and Microsoft connections\n\u2610 No regression in onboarding flow\n\u2610 State persists across app restarts\n\n<strong>Files to Modify</strong>\n\n\u2022 <code>src/appCore/state/machine/reducer.ts</code> - Handle EMAIL_CONNECTED in ready state\n\u2022 <code>src/appCore/state/flows/useEmailHandlers.ts</code> - Verify action dispatch (may need changes)\n\n<strong>Testing</strong>\n\n1. Complete onboarding without connecting email\n2. Dashboard shows \"Complete your account setup\" banner\n3. Go to Settings > Connect Microsoft Outlook\n4. Verify Settings shows \"Connected\" status\n5. Return to Dashboard\n6. Verify banner is gone\n7. Restart app\n8. Verify banner stays gone\n\n<strong>Related Files</strong>\n\n\u2022 <code>src/appCore/state/machine/reducer.ts</code>\n\u2022 <code>src/appCore/state/flows/useEmailHandlers.ts</code>\n\u2022 <code>src/components/Dashboard.tsx</code> (verify banner logic)"
  },
  {
    "id": "BACKLOG-491",
    "title": "Remove Excessive NavigationButtons Logging",
    "category": "bug",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-052",
    "est_tokens": "~5K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "2026-01-25",
    "file": "[BACKLOG-491.md](items/BACKLOG-491.md)",
    "description": "<strong>Summary</strong>\n\nNavigationButtons component logs excessively to console (22+ repeated entries), cluttering debug output and indicating potential re-render issues.\n\n<strong>Bug Report</strong>\n\n**Discovered**: SPRINT-052/053 testing\n**Severity**: Low (console noise, possible performance)\n\n<strong>Symptoms</strong>\n\nConsole shows repeated logs:\n<code>NavigationButtons.tsx:76 [NavigationButtons] nextDisabled: true isStepComplete: true isNextDisabled: true\nNavigationButtons.tsx:76 [NavigationButtons] nextDisabled: true isStepComplete: true isNextDisabled: true\nNavigationButtons.tsx:76 [NavigationButtons] nextDisabled: true isStepComplete: true isNextDisabled: true\n(... 22+ times)\n</code>\n\n<strong>Issues</strong>\n\n1. **Excessive logging**: Debug logs should be removed or reduced for production\n2. **Possible logic issue**: <code>isStepComplete: true</code> but <code>nextDisabled: true</code> seems contradictory\n3. **Potential re-render**: 22+ logs suggests unnecessary re-renders\n\n<strong>Requirements</strong>\n\n<strong>Remove/Reduce Logging</strong>\n\n1. **Option A (Preferred)**: Remove the console.log entirely\n   <code>   // Remove this line:\n   console.log('[NavigationButtons] nextDisabled:', nextDisabled, 'isStepComplete:', isStepComplete, 'isNextDisabled:', isNextDisabled);\n   </code>\n\n2. **Option B**: Gate behind debug flag\n   <code>   if (process.env.NODE_ENV === 'development' && DEBUG_NAVIGATION) {\n     console.log('[NavigationButtons] ...', ...);\n   }\n   </code>\n\n<strong>Investigate Logic</strong>\n\n1. Review why <code>isStepComplete: true</code> results in <code>nextDisabled: true</code>\n2. This may be intentional (e.g., final step) but worth documenting\n3. If it's a bug, fix the logic\n\n<strong>Check Re-renders</strong>\n\n1. If 22+ logs occur, component may be re-rendering excessively\n2. Consider memoization if props/state cause unnecessary updates\n3. Use React DevTools to verify render count\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Console no longer shows repeated NavigationButtons logs\n\u2610 Debug information available if needed (dev flag or commented)\n\u2610 No regression in navigation button behavior\n\u2610 Verify component isn't re-rendering excessively\n\n<strong>Files to Modify</strong>\n\n\u2022 <code>src/components/onboarding/NavigationButtons.tsx</code> - Remove/gate logging\n\n<strong>Testing</strong>\n\n1. Run app in development mode\n2. Navigate through onboarding steps\n3. Verify console is not flooded with NavigationButtons logs\n4. Verify Next/Back buttons still work correctly\n\n<strong>Related Files</strong>\n\n\u2022 <code>src/components/onboarding/NavigationButtons.tsx</code>"
  },
  {
    "id": "BACKLOG-492",
    "title": "Test Outlook/Microsoft Email Sync",
    "category": "testing",
    "priority": "Critical",
    "status": "Deferred",
    "sprint": "-",
    "est_tokens": "~5K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "",
    "file": "[BACKLOG-492.md](items/BACKLOG-492.md)",
    "description": "<strong>Summary</strong>\n\nSPRINT-052 only tested Gmail email sync. Microsoft Outlook/Graph sync was never verified and needs manual testing.\n\n<strong>Bug Report</strong>\n\n**Discovered**: SPRINT-052/053 review\n**Severity**: Unknown (may be working, may be broken)\n\n<strong>Background</strong>\n\nEmail sync testing during SPRINT-052 focused on Gmail:\n\u2022 Gmail auth flow tested and working\n\u2022 Gmail email sync tested and working\n\u2022 Microsoft/Outlook was not tested\n\nThe Microsoft Graph API integration exists but has not been verified end-to-end.\n\n<strong>Requirements</strong>\n\n<strong>Manual Testing</strong>\n\n1. **Connect Microsoft Account**:\n   - Go to Settings\n   - Click \"Connect Microsoft Outlook\"\n   - Complete OAuth flow\n   - Verify \"Connected\" status appears\n\n2. **Create Test Transaction**:\n   - Create new transaction with unique subject line\n   - Example: <code>[Test-2026-01-24] Outlook Sync Test</code>\n\n3. **Send Test Email**:\n   - From connected Outlook account, send email with matching subject\n   - Wait for sync cycle (or trigger manual sync)\n\n4. **Verify Email Appears**:\n   - Open transaction\n   - Check Emails tab\n   - Verify test email appears with correct:\n     - Subject\n     - Sender\n     - Date\n     - Body preview\n\n<strong>Test Scenarios</strong>\n\n| Scenario | Expected Result |\n|----------|-----------------|\n| Connect Outlook | OAuth succeeds, \"Connected\" in Settings |\n| Send email to self | Email syncs to matching transaction |\n| Email with attachment | Attachment indicator visible |\n| Multiple emails | All matching emails sync |\n| Disconnect/reconnect | Sync resumes without duplicates |\n\n<strong>If Issues Found</strong>\n\n1. Document exact error (console, UI message)\n2. Create separate bug backlog item\n3. Do not attempt to fix within this testing task\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Microsoft OAuth flow works\n\u2610 Outlook shows \"Connected\" in Settings\n\u2610 Emails sync to transactions correctly\n\u2610 No duplicate emails\n\u2610 No console errors during sync\n\u2610 Document any issues found\n\n<strong>Prerequisites</strong>\n\n\u2022 Microsoft account (personal or work)\n\u2022 App running in development mode\n\u2022 Access to browser console for debugging\n\n<strong>Testing Notes</strong>\n\nThis is primarily a manual testing task. Token estimate is low because:\n\u2022 Mostly manual verification\n\u2022 May require minor debugging\n\u2022 May spawn new bug tickets if issues found\n\n<strong>Related Files</strong>\n\n\u2022 <code>electron/services/microsoftGraph/graphService.ts</code>\n\u2022 <code>electron/handlers/emailSyncHandlers.ts</code>\n\u2022 <code>src/components/Settings.tsx</code> (email connection UI)"
  },
  {
    "id": "BACKLOG-493",
    "title": "Cannot Unlink Emails from Transactions",
    "category": "bug",
    "priority": "High",
    "status": "Completed",
    "sprint": "SPRINT-052",
    "est_tokens": "~10K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "2026-01-25",
    "file": "[BACKLOG-493.md](items/BACKLOG-493.md)",
    "description": "<strong>Summary</strong>\n\nUser cannot unlink emails from transactions. The unlink operation fails with \"Communication not found\" error in console.\n\n**ROOT CAUSE IDENTIFIED**: ID mismatch between UI and backend - <code>getCommunicationsWithMessages()</code> returns <code>message.id</code> as the primary <code>id</code> field, but <code>unlinkCommunication()</code> expects <code>communication.id</code>.\n\n<strong>Bug Report</strong>\n\n**Discovered**: SPRINT-052 QA testing\n**Severity**: High (P1) - affects core functionality\n**Root Cause**: Confirmed - See detailed analysis in <code>/Users/daniel/Documents/Mad/.claude/qa/test-cases/TEST-BACKLOG-493-email-unlink-bug.md</code>\n\n<strong>Symptoms</strong>\n\n1. User navigates to a transaction with linked emails\n2. User attempts to unlink an email from the transaction\n3. Console shows error: <code>Failed to unlink communication: Communication not found</code>\n4. Unlink operation fails silently (or with error toast)\n5. Email remains linked to transaction\n\n<strong>Error Location</strong>\n\n<code>useTransactionCommunications.ts:46 Failed to unlink communication: Communication not found\n</code>\n\n<strong>Expected Behavior</strong>\n\n\u2022 User clicks unlink on an email\n\u2022 Email is successfully unlinked from the transaction\n\u2022 UI updates to reflect the change\n\u2022 No errors in console\n\n<strong>Actual Behavior</strong>\n\n\u2022 User clicks unlink on an email\n\u2022 Console shows \"Communication not found\" error\n\u2022 Email remains linked\n\u2022 UI may show error or silently fail\n\n<strong>Requirements</strong>\n\n<strong>Root Cause (IDENTIFIED)</strong>\n\nThe <code>getCommunicationsWithMessages()</code> function in <code>electron/services/db/communicationDbService.ts</code> returns:\n\n<code>COALESCE(m.id, c.id) as id,\nc.id as communication_id,\n</code>\n\nThis means when a communication has a <code>message_id</code>, the returned <code>id</code> field contains the **message ID**, not the communication ID.\n\n**The Bug Flow**:\n1. Frontend loads emails via <code>getCommunicationsWithMessages()</code>\n2. Query returns objects where <code>id = message.id</code> (from messages table)\n3. User clicks \"Remove\" button\n4. Frontend passes <code>comm.id</code> to <code>unlinkCommunication()</code>\n5. Backend tries to find communication with <code>WHERE id = ?</code> using the **message ID**\n6. No match found in communications table \u2192 Error: \"Communication not found\"\n\n<strong>Fix (Recommended)</strong>\n\n**Option 1 - Fix Frontend** (Recommended):\nUpdate <code>useTransactionCommunications.ts</code> line 40 to use <code>communication_id</code>:\n\n<code>const result = await window.api.transactions.unlinkCommunication(comm.communication_id);\n</code>\n\n**Pros**: Minimal change, preserves backend logic, clear separation\n**Cons**: Requires type updates\n\n**Option 2 - Fix Backend**:\nMake backend handler accept both communication ID and message ID, check both tables.\n\n**Pros**: More resilient\n**Cons**: More complex, doesn't fix root confusion\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Can unlink emails from transactions without errors\n\u2610 UI updates immediately after unlink\n\u2610 No console errors during unlink operation\n\u2610 Works for both auto-linked and manually linked emails\n\u2610 No regression in email linking functionality\n\n<strong>Files to Investigate</strong>\n\n\u2022 <code>src/hooks/useTransactionCommunications.ts</code> (line 46 - error location)\n\u2022 Related backend/IPC handlers for unlinking (likely in <code>electron/handlers/</code>)\n\u2022 Database service methods for communication unlinking\n\n<strong>Testing</strong>\n\n1. Create a transaction with contacts\n2. Sync emails (auto-link some emails)\n3. Attempt to unlink an auto-linked email\n4. Verify no errors in console\n5. Verify email no longer appears in transaction\n6. Manually link an email and test unlinking\n\n<strong>Related</strong>\n\n\u2022 SPRINT-052 Email Sync Production\n\u2022 BACKLOG-457 (Sync Emails from Provider)\n\u2022 BACKLOG-458 (Email Connection Status)"
  },
  {
    "id": "BACKLOG-494",
    "title": "Display Emails in Natural Thread Format",
    "category": "feature",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "SPRINT-052",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "2026-01-25",
    "file": "[BACKLOG-494.md](items/BACKLOG-494.md)",
    "description": "<strong>Summary</strong>\n\nEmails linked to transactions should be displayed in their natural thread format, similar to how messages (iMessage/SMS) are displayed. Currently emails may not be grouped by conversation thread.\n\n---\n\n<strong>User Story</strong>\n\nAs a real estate agent using Magic Audit, I want to see emails grouped by conversation thread so that I can easily follow the flow of communication with clients and colleagues, just like I see threaded text message conversations.\n\n---\n\n<strong>Requirements</strong>\n\n<strong>Email Thread Grouping</strong>\n\n1. Emails must be grouped by conversation/thread\n2. Thread grouping should use standard email headers:\n   - <code>In-Reply-To</code> header\n   - <code>References</code> header\n   - Subject line matching (fallback for broken threads)\n3. Thread displays in chronological order within each thread\n\n<strong>Display Requirements</strong>\n\n1. Reply chains should be visually connected\n2. UX should be consistent with text message thread display\n3. Thread view should show:\n   - Thread subject/topic\n   - Number of emails in thread\n   - Date range of thread\n   - Expandable/collapsible thread view\n\n<strong>Thread Detection Logic</strong>\n\n<code>1. Primary: Match on In-Reply-To / References headers\n2. Secondary: Match on Message-ID chains\n3. Fallback: Subject line normalization (strip Re:, Fwd:, etc.) + contact matching\n</code>\n\n---\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Emails grouped by conversation thread\n\u2610 Thread displays in chronological order\n\u2610 Reply chains are visually connected\n\u2610 Consistent with message thread display UX\n\u2610 Thread metadata visible (count, date range)\n\u2610 Individual emails within thread are expandable\n\u2610 Works for both Gmail and Outlook emails\n\n---\n\n<strong>Technical Approach</strong>\n\n<strong>Database/Service Layer</strong>\n\n1. Check if email threading metadata is stored during sync:\n   - <code>in_reply_to</code> header\n   - <code>references</code> header\n   - <code>message_id</code>\n2. Add thread grouping logic to communication fetching\n3. May need to add <code>thread_id</code> or <code>conversation_id</code> field\n\n<strong>UI Layer</strong>\n\n1. Modify email display component to group by thread\n2. Create thread container component (similar to message thread cards)\n3. Handle expand/collapse of threads\n4. Show thread summary when collapsed\n\n---\n\n<strong>Files Likely Involved</strong>\n\n| Area | Files |\n|------|-------|\n| Email Display | <code>src/components/TransactionDetail.tsx</code>, <code>TransactionEmailsTab.tsx</code> |\n| Communication Service | <code>electron/services/db/communicationDbService.ts</code> |\n| Email Sync | <code>electron/services/autoLinkService.ts</code>, <code>electron/services/email/</code> |\n| Types | <code>src/types/</code> email-related types |\n\n---\n\n<strong>Related Items</strong>\n\n\u2022 SPRINT-052 Email Sync Production\n\u2022 BACKLOG-457 (Sync Emails from Provider)\n\u2022 BACKLOG-458 (Email Connection Status)\n\u2022 Text message thread display (reference for UX consistency)\n\n---\n\n<strong>Testing</strong>\n\n1. Sync emails with a multi-message thread\n2. Verify emails are grouped by conversation\n3. Verify chronological ordering within thread\n4. Test expand/collapse functionality\n5. Test with both Gmail and Outlook emails\n6. Test with broken thread chains (missing headers)\n\n---\n\n<strong>Notes</strong>\n\nUser specifically requested this feature for SPRINT-052. The goal is UX parity with how text message conversations are displayed."
  },
  {
    "id": "BACKLOG-497",
    "title": "Move SQLite Queries to Worker Thread",
    "category": "refactor",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~150K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-24",
    "completed_at": "",
    "file": "[BACKLOG-497.md](items/BACKLOG-497.md)",
    "description": "<strong>Type</strong>\nRefactor / Performance\n\n<strong>Priority</strong>\nHigh\n\n<strong>Status</strong>\nOpen\n\n<strong>Description</strong>\n\nThe Magic Audit application experiences UI freezes during database operations because <code>better-sqlite3</code> uses a synchronous API that blocks Electron's main process event loop. Even though IPC handlers are async, the actual database queries execute synchronously on the main thread, causing the UI to become unresponsive during data-intensive operations.\n\n<strong>Problem Statement</strong>\n\n<strong>Current Behavior</strong>\n\u2022 Database queries block the Electron main process\n\u2022 UI becomes unresponsive during contact loading, email queries, transaction queries\n\u2022 Users experience visible freezes, especially with larger datasets\n\u2022 The app feels \"sluggish\" despite async IPC wrappers\n\n<strong>Root Cause</strong>\n\nThe <code>dbConnection.ts</code> module uses <code>better-sqlite3</code>'s synchronous API directly:\n\n<code>// electron/services/db/core/dbConnection.ts\n\nexport function dbGet<T = unknown>(sql: string, params: unknown[] = []): T | undefined {\n  const database = ensureDb();\n  const stmt = database.prepare(sql);\n  return stmt.get(...params) as T | undefined;  // SYNCHRONOUS - blocks main process\n}\n\nexport function dbAll<T = unknown>(sql: string, params: unknown[] = []): T[] {\n  const database = ensureDb();\n  const stmt = database.prepare(sql);\n  return stmt.all(...params) as T[];  // SYNCHRONOUS - blocks main process\n}\n\nexport function dbRun(sql: string, params: unknown[] = []): QueryResult {\n  const database = ensureDb();\n  const stmt = database.prepare(sql);\n  const result = stmt.run(...params);  // SYNCHRONOUS - blocks main process\n  return { lastInsertRowid: result.lastInsertRowid as number, changes: result.changes };\n}\n</code>\n\nThese functions are called by all database services:\n\u2022 <code>contactDbService.ts</code> - contact loading and search\n\u2022 <code>communicationDbService.ts</code> - email and message queries\n\u2022 <code>transactionDbService.ts</code> - transaction CRUD operations\n\u2022 <code>sessionDbService.ts</code> - session management\n\u2022 <code>oauthTokenDbService.ts</code> - token storage\n\u2022 <code>auditLogDbService.ts</code> - audit trail queries\n\u2022 <code>userDbService.ts</code> - user preferences\n\u2022 <code>transactionContactDbService.ts</code> - transaction-contact relationships\n\u2022 <code>feedbackDbService.ts</code> - user feedback\n\u2022 <code>llmSettingsDbService.ts</code> - AI model settings\n\n<strong>Affected Areas</strong>\n\n| Feature | Impact | Severity |\n|---------|--------|----------|\n| Contact List | Freezes when loading contacts | High |\n| Email View | Freezes when querying emails | High |\n| Transaction List | Freezes when loading transactions | High |\n| Search | Freezes during search queries | High |\n| Sync Operations | Extended freezes during bulk sync | Critical |\n| iPhone Import | Long freezes during message import | Critical |\n| Reindex Database (Settings) | Freezes during manual reindex | Medium |\n| General Navigation | Brief freezes on data-heavy screens | Medium |\n\n<strong>Proposed Solution</strong>\n\nMove all database operations to a dedicated worker thread using Node.js <code>worker_threads</code> module. The main process will communicate with the worker via message passing, making database operations truly asynchronous.\n\n<strong>Architecture</strong>\n\n<code>CURRENT:\n[Renderer] --IPC--> [Main Process] --sync--> [SQLite]\n                         ^\n                         |\n                    UI BLOCKED\n\nPROPOSED:\n[Renderer] --IPC--> [Main Process] --async msg--> [Worker Thread] --sync--> [SQLite]\n                         ^                              ^\n                         |                              |\n                    UI FREE                        DB BLOCKED (isolated)\n</code>\n\n<strong>Implementation Approach</strong>\n\n<strong>Phase 1: Worker Thread Infrastructure</strong>\n\n1. **Create Database Worker** (<code>electron/services/db/worker/dbWorker.ts</code>)\n   - Initialize database connection in worker\n   - Handle message-based query requests\n   - Return results via <code>parentPort.postMessage()</code>\n\n2. **Create Worker Manager** (<code>electron/services/db/worker/dbWorkerManager.ts</code>)\n   - Spawn and manage worker thread lifecycle\n   - Provide async API that wraps message passing\n   - Handle worker crashes and restarts\n   - Implement request queuing and response correlation\n\n<strong>Phase 2: Migrate Core Query Functions</strong>\n\n3. **Update dbConnection.ts**\n   - Convert <code>dbGet</code>, <code>dbAll</code>, <code>dbRun</code>, <code>dbExec</code> to async\n   - Route queries through worker manager\n   - Maintain backward compatibility during transition\n\n4. **Update All Database Services**\n   - <code>contactDbService.ts</code>\n   - <code>communicationDbService.ts</code>\n   - <code>transactionDbService.ts</code>\n   - <code>sessionDbService.ts</code>\n   - <code>oauthTokenDbService.ts</code>\n   - <code>auditLogDbService.ts</code>\n   - <code>userDbService.ts</code>\n   - <code>transactionContactDbService.ts</code>\n   - <code>feedbackDbService.ts</code>\n   - <code>llmSettingsDbService.ts</code>\n\n<strong>Phase 3: Handle Edge Cases</strong>\n\n5. **Transaction Support**\n   - Ensure transactions run atomically within worker\n   - Implement <code>dbTransaction</code> that batches operations\n\n6. **Encryption Handling**\n   - Pass encryption key securely to worker\n   - Ensure key never exposed in logs/errors\n\n7. **Bulk Operations**\n   - Optimize iPhone sync and bulk imports\n   - Consider batching strategies for large datasets\n\n<strong>Phase 4: Testing and Validation</strong>\n\n8. **Performance Testing**\n   - Benchmark before/after query response times\n   - Measure UI responsiveness improvements\n   - Test with large datasets (10K+ contacts, emails)\n\n9. **Integration Testing**\n   - Verify all database operations work correctly\n   - Test error handling and worker recovery\n   - Test concurrent operations\n\n<strong>Technical Considerations</strong>\n\n<strong>Worker Thread Communication</strong>\n\n<code>// Example worker manager interface\ninterface DbWorkerManager {\n  query<T>(sql: string, params: unknown[]): Promise<T>;\n  queryAll<T>(sql: string, params: unknown[]): Promise<T[]>;\n  execute(sql: string, params: unknown[]): Promise<QueryResult>;\n  executeRaw(sql: string): Promise<void>;\n  transaction<T>(operations: DbOperation[]): Promise<T>;\n}\n</code>\n\n<strong>Message Protocol</strong>\n\n<code>// Request message\ninterface DbRequest {\n  id: string;  // Correlation ID\n  type: 'get' | 'all' | 'run' | 'exec' | 'transaction';\n  sql: string;\n  params?: unknown[];\n}\n\n// Response message\ninterface DbResponse {\n  id: string;  // Correlation ID\n  success: boolean;\n  result?: unknown;\n  error?: { message: string; code?: string };\n}\n</code>\n\n<strong>Encryption Key Transfer</strong>\n\nThe encryption key must be passed to the worker during initialization. Options:\n1. Pass via <code>workerData</code> during worker creation (preferred - single transfer)\n2. Use secure IPC channel for key exchange\n3. Store encrypted key reference that worker can resolve\n\n<strong>Error Handling</strong>\n\n\u2022 Worker crashes should trigger automatic restart\n\u2022 Pending queries should be re-queued or rejected with clear error\n\u2022 Database corruption should be detected and reported\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Database worker thread created and manages SQLite connection\n\u2610 Worker manager provides async API for all query types\n\u2610 All <code>dbConnection.ts</code> functions converted to async\n\u2610 All database services updated to use async API\n\u2610 Encryption works correctly in worker thread\n\u2610 Transactions work atomically within worker\n\u2610 Worker crash recovery implemented\n\u2610 No UI freezes during database operations\n\u2610 Performance benchmarks show improvement\n\u2610 All existing database tests pass\n\u2610 New tests cover worker thread scenarios\n\u2610 Documentation updated for async database API\n\n<strong>Risks and Mitigations</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| Breaking existing code | Gradual migration with compatibility layer |\n| Worker communication overhead | Batch operations where possible |\n| Encryption key security | Single transfer at init, secure storage |\n| Complex transaction handling | Test thoroughly, maintain atomicity |\n| Debugging difficulty | Add comprehensive logging in worker |\n\n<strong>Estimated Complexity</strong>\n\n**High** - This change affects the entire database layer:\n\u2022 10+ database service files need updates\n\u2022 All async/await patterns must be verified\n\u2022 IPC handlers may need adjustment\n\u2022 Extensive testing required\n\u2022 Risk of subtle bugs during migration\n\n<strong>Estimated Effort</strong>\n\n\u2022 **Phase 1 (Infrastructure)**: ~40K tokens\n\u2022 **Phase 2 (Migration)**: ~60K tokens\n\u2022 **Phase 3 (Edge Cases)**: ~30K tokens\n\u2022 **Phase 4 (Testing)**: ~20K tokens\n\u2022 **Total**: ~150K tokens (large sprint or split across multiple)\n\n<strong>Related Files</strong>\n\n\u2022 <code>electron/services/db/core/dbConnection.ts</code> - Core query functions\n\u2022 <code>electron/services/db/contactDbService.ts</code> - Contact operations\n\u2022 <code>electron/services/db/communicationDbService.ts</code> - Email/message operations\n\u2022 <code>electron/services/db/transactionDbService.ts</code> - Transaction operations\n\u2022 <code>electron/services/db/sessionDbService.ts</code> - Session management\n\u2022 <code>electron/services/db/oauthTokenDbService.ts</code> - OAuth token storage\n\u2022 <code>electron/services/db/auditLogDbService.ts</code> - Audit logging\n\u2022 <code>electron/services/db/userDbService.ts</code> - User preferences\n\u2022 <code>electron/services/db/transactionContactDbService.ts</code> - Transaction-contact links\n\u2022 <code>electron/services/db/feedbackDbService.ts</code> - Feedback storage\n\u2022 <code>electron/services/db/llmSettingsDbService.ts</code> - AI settings\n\u2022 <code>electron/services/db/index.ts</code> - Database service exports\n\u2022 <code>electron/services/databaseEncryptionService.ts</code> - Encryption key management\n\n<strong>References</strong>\n\n\u2022 [Node.js Worker Threads](https://nodejs.org/api/worker_threads.html)\n\u2022 [better-sqlite3 Threading](https://github.com/WiseLibs/better-sqlite3/blob/master/docs/threads.md)\n\u2022 [Electron Performance Best Practices](https://www.electronjs.org/docs/latest/tutorial/performance)\n\n<strong>Created</strong>\n2026-01-24"
  },
  {
    "id": "BACKLOG-505",
    "title": "Fix Duplicate Text Messages in Conversation View",
    "category": "bug",
    "priority": "Critical",
    "status": "Completed",
    "sprint": "-",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-25",
    "completed_at": "2026-01-25",
    "file": "[BACKLOG-505.md](items/BACKLOG-505.md)",
    "description": "<strong>Priority: Critical (Hotfix)</strong>\n\n<strong>Category: bug</strong>\n\n<strong>Status: COMPLETED</strong>\n\n<strong>Summary</strong>\n\nText messages were appearing twice in the conversation view due to multiple root causes in the database architecture.\n\n<strong>Root Causes Identified</strong>\n\n1. **Missing UNIQUE constraint on messages.external_id**\n   - The import service uses <code>INSERT OR IGNORE</code> expecting deduplication\n   - Without a unique constraint, duplicates were inserted every import\n\n2. **Dual-storage pattern in communications table**\n   - Legacy: content stored directly in <code>body_plain</code>\n   - New: content in <code>messages</code> table, referenced via <code>message_id</code>\n   - Same message could exist in both patterns with different IDs\n\n3. **Content duplicates in messages table**\n   - Same <code>body_text + sent_at</code> could have different <code>external_id</code> values\n\n<strong>Fix Applied (PR #605)</strong>\n\n<strong>Migration 20</strong>\n\u2022 Deletes duplicate messages by <code>user_id + external_id</code>\n\u2022 Adds UNIQUE constraint: <code>idx_messages_user_external_id ON messages(user_id, external_id)</code>\n\n<strong>Migration 21</strong>\n\u2022 Deletes content-duplicate messages (same <code>body_text + sent_at</code>)\n\u2022 Catches duplicates that have different <code>external_id</code> values\n\n<strong>Migration 19</strong>\n\u2022 Deletes legacy communication records with <code>body_plain</code> content but no <code>message_id</code>\n\n<strong>Runtime Safety Net</strong>\n\u2022 Content-based deduplication in <code>getCommunicationsWithMessages()</code>\n\u2022 Filters by <code>body_text + sent_at</code> to catch any edge cases\n\n<strong>Files Changed</strong>\n\n\u2022 <code>electron/services/databaseService.ts</code> - Migrations 19, 20, 21\n\u2022 <code>electron/services/db/communicationDbService.ts</code> - Runtime deduplication\n\u2022 <code>electron/database/schema.sql</code> - Added unique index\n\n<strong>Testing</strong>\n\n\u2611 Open transaction with linked text messages\n\u2611 Verify each message appears exactly once\n\u2611 Verify message count is accurate\n\u2611 Verify no messages are missing\n\n<strong>Related</strong>\n\n\u2022 PR #605\n\u2022 SR Engineer Architecture Review (see BACKLOG-506)"
  },
  {
    "id": "BACKLOG-506",
    "title": "Database Architecture Cleanup - Eliminate Dual-Storage Pattern",
    "category": "refactor",
    "priority": "High",
    "status": "testing",
    "sprint": "SPRINT-060",
    "est_tokens": "~122K",
    "actual_tokens": "~150K",
    "variance": "+23%",
    "created_at": "2026-01-25",
    "completed_at": "2026-01-26",
    "file": "[BACKLOG-506.md](items/BACKLOG-506.md)",
    "description": "<strong>Priority: High</strong>\n\n<strong>Category: refactor/architecture</strong>\n\n<strong>Status: Pending</strong>\n\n<strong>Summary</strong>\n\nThe SR Engineer architectural review (from BACKLOG-505 investigation) identified that the <code>communications</code> table evolved from a content table to a junction table, but still has legacy content columns. This dual-storage pattern was the root cause of the duplicate messages bug.\n\n<strong>Problem</strong>\n\nThe <code>communications</code> table has two patterns:\n1. **Legacy (emails)**: Content stored directly in <code>body_plain</code>, <code>subject</code>, etc.\n2. **New (texts)**: Content in <code>messages</code> table, <code>communications</code> just links via <code>message_id</code>\n\nThis causes:\n\u2022 Confusion about where data lives\n\u2022 Potential for duplicates when both patterns exist for same content\n\u2022 Complex COALESCE queries to handle both patterns\n\u2022 Wasted storage (same data in two places)\n\n<strong>SR Engineer Recommendations</strong>\n\n<strong>Phase 1: Add Missing Unique Constraints</strong>\n<code>-- Prevent duplicate thread links\nCREATE UNIQUE INDEX idx_communications_thread_txn_unique\n  ON communications(thread_id, transaction_id)\n  WHERE thread_id IS NOT NULL AND message_id IS NULL;\n</code>\n\n<strong>Phase 2: Consolidate Contact Junction Tables</strong>\n\u2022 Migrate all <code>transaction_participants</code> records to <code>transaction_contacts</code>\n\u2022 Drop <code>transaction_participants</code> table\n\u2022 Single source of truth for contact-transaction relationships\n\n<strong>Phase 3: Remove Legacy Columns from Communications</strong>\nDrop these columns (since there are no production users):\n\u2022 <code>subject</code>, <code>body</code>, <code>body_plain</code>\n\u2022 <code>sender</code>, <code>recipients</code>, <code>cc</code>, <code>bcc</code>\n\u2022 <code>email_thread_id</code>, <code>sent_at</code>, <code>received_at</code>\n\u2022 <code>has_attachments</code>, <code>attachment_count</code>, <code>attachment_metadata</code>\n\u2022 <code>keywords_detected</code>, <code>parties_involved</code>, <code>communication_category</code>\n\u2022 <code>relevance_score</code>, <code>is_compliance_related</code>, <code>source</code>, <code>communication_type</code>\n\n<strong>Phase 4: Update All Code</strong>\nFiles that use <code>body_plain</code> and need updating:\n\u2022 <code>folderExportService.ts</code>\n\u2022 <code>pdfExportService.ts</code>\n\u2022 <code>enhancedExportService.ts</code>\n\u2022 <code>contactDbService.ts</code>\n\u2022 <code>communicationDbService.ts</code>\n\n<strong>Benefits</strong>\n\n1. **Duplicates impossible by design** - not just filtered at runtime\n2. **Simpler queries** - no COALESCE fallback logic\n3. **Single source of truth** - content only in <code>messages</code> table\n4. **Better ACID compliance** - clearer referential integrity\n5. **Smaller database** - no redundant data storage\n\n<strong>Effort Estimate</strong>\n\n\u2022 Phase 1: 2-3 turns (add constraints)\n\u2022 Phase 2: 5-8 turns (consolidate junction tables)\n\u2022 Phase 3: 8-12 turns (remove columns, update schema)\n\u2022 Phase 4: 10-15 turns (update all code references)\n\n**Total: ~25-38 turns**\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-505 must be merged first (provides foundation)\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-505 (Duplicate Messages Fix - COMPLETED)\n\u2022 BACKLOG-148 (databaseService migration - related refactor)"
  },
  {
    "id": "BACKLOG-507",
    "title": "Database Maintenance Button in Settings",
    "category": "feature",
    "priority": "Medium",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~50K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-25",
    "completed_at": "",
    "file": "[BACKLOG-507.md](items/BACKLOG-507.md)",
    "description": "<strong>Summary</strong>\n\nAdd a \"Database Maintenance\" button in Settings that allows users to manually optimize their database.\n\n<strong>Priority</strong>\n\nP2 - Enhancement\n\n<strong>Description</strong>\n\nWe recently added performance indexes (Migration 18) to speed up queries. This feature provides users with a manual way to trigger database maintenance when they notice slowdowns. The operations include:\n\n1. **REINDEX** - Rebuilds all indexes for optimal query performance\n2. **VACUUM** - Compacts the database file by reclaiming deleted space\n3. **ANALYZE** - Updates query planner statistics for better execution plans\n\n<strong>User Story</strong>\n\nAs a power user, I want to manually optimize my database so that I can maintain optimal performance without waiting for automatic maintenance.\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 \"Database Maintenance\" button visible in Settings under a new \"Advanced\" or \"Storage\" section\n\u2610 Clicking button shows a modal with options or runs all three operations\n\u2610 Progress indicator during maintenance (can take a few seconds)\n\u2610 Success/failure feedback after completion\n\u2610 Operations run in sequence: REINDEX -> ANALYZE -> VACUUM\n\u2610 UI remains responsive during maintenance (async execution)\n\u2610 <code>npm run type-check</code> passes\n\u2610 <code>npm run lint</code> passes\n\u2610 <code>npm test</code> passes\n\n<strong>Technical Details</strong>\n\n<strong>Existing Infrastructure</strong>\n\nThe backend already has partial support:\n\u2022 <code>electron/services/db/core/dbConnection.ts</code> has <code>vacuumDb()</code> function\n\u2022 <code>electron/services/databaseService.ts</code> exports <code>vacuum()</code> method\n\u2022 No IPC handler exposed yet\n\n<strong>Implementation Approach</strong>\n\n1. **Backend (electron)**:\n   - Add <code>reindexDb()</code> and <code>analyzeDb()</code> functions to <code>dbConnection.ts</code>\n   - Expose all three via databaseService methods\n   - Add IPC handler: <code>database:maintenance</code> or <code>database:optimize</code>\n\n2. **Frontend (renderer)**:\n   - Add button in Settings.tsx (new \"Advanced\" section)\n   - Add <code>window.api.database.optimize()</code> call\n   - Simple modal or inline progress indicator\n\n<strong>Files to Modify</strong>\n\n\u2022 <code>electron/services/db/core/dbConnection.ts</code> - Add REINDEX, ANALYZE functions\n\u2022 <code>electron/services/databaseService.ts</code> - Expose new methods\n\u2022 <code>electron/handlers.ts</code> or <code>electron/database-handlers.ts</code> - Add IPC handler\n\u2022 <code>electron/preload.ts</code> - Expose to renderer\n\u2022 <code>src/window.d.ts</code> - Add type definitions\n\u2022 <code>src/components/Settings.tsx</code> - Add UI button\n\n<strong>Estimate</strong>\n\n~50K tokens (simple UI + backend handler)\n\n<strong>Dependencies</strong>\n\n\u2022 Migration 18 (performance indexes) - Already merged\n\n<strong>Related Items</strong>\n\n\u2022 Migration 18: Performance indexes for communications table\n\u2022 BACKLOG-497: Move SQLite Queries to Worker Thread (future optimization)\n\n<strong>Sprint Assignment</strong>\n\nTo be assigned\n\n<strong>Notes</strong>\n\n\u2022 This is a nice-to-have feature for power users\n\u2022 Database file is encrypted with SQLCipher, these operations work normally\n\u2022 VACUUM requires temporary disk space (2x database size in worst case)"
  },
  {
    "id": "BACKLOG-508",
    "title": "Add Progress Bar for Message Import",
    "category": "ui",
    "priority": "Low",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~5K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-26",
    "completed_at": "",
    "file": "[BACKLOG-508.md](items/BACKLOG-508.md)",
    "description": "<strong>Type</strong>\nrefactor\n\n<strong>Priority</strong>\nlow\n\n<strong>Status</strong>\nin-progress\n\n<strong>Task File</strong>\n<code>.claude/plans/tasks/TASK-1201-consolidate-message-utilities.md</code>\n\n<strong>Description</strong>\n\nThere's significant code duplication between export services and UI fetching that could be consolidated into shared utilities.\n\n<strong>Duplicated Code Identified</strong>\n\n| Utility | Implementations | Locations |\n|---------|-----------------|-----------|\n| Phone normalization | 2 | Export services, UI components |\n| Contact name lookup | 2 | Export services, UI components |\n| Thread grouping | 2 | Export services, UI components |\n| Group chat detection | 2 | Export services, UI components |\n\n<strong>Proposed Solution</strong>\n\nCreate shared utility modules:\n\u2022 <code>electron/utils/phoneUtils.ts</code> - Phone normalization\n\u2022 <code>electron/utils/contactUtils.ts</code> - Contact name lookup\n\u2022 <code>electron/utils/threadUtils.ts</code> - Thread grouping and group chat detection\n\n<strong>Benefits</strong>\n\u2022 Single source of truth for each utility\n\u2022 Easier maintenance\n\u2022 Consistent behavior across export and UI\n\u2022 Reduced code size\n\n<strong>Related</strong>\n\u2022 BACKLOG-506 (Database Architecture Cleanup) - noted this opportunity but not blocking\n\n<strong>Acceptance Criteria</strong>\n\u2610 All phone normalization uses single shared implementation\n\u2610 All contact name lookup uses single shared implementation\n\u2610 All thread grouping uses single shared implementation\n\u2610 All group chat detection uses single shared implementation\n\u2610 No behavioral changes (pure refactor)\n\u2610 All tests pass"
  },
  {
    "id": "BACKLOG-509",
    "title": "Email embedded images blocked by CSP",
    "category": "bug",
    "priority": "low",
    "status": "pending",
    "sprint": "",
    "est_tokens": "",
    "actual_tokens": "UI",
    "variance": "cid: URLs for inline email images blocked by Content Security Policy. Need to either add cid: to img-src or strip/replace with placeholders.",
    "created_at": "",
    "completed_at": "",
    "file": "",
    "description": "<strong>Type</strong>\nui/ux\n\n<strong>Priority</strong>\nlow\n\n<strong>Status</strong>\nbacklog\n\n<strong>Description</strong>\n\nThe \"Starting Magic Audit...\" loading animation doesn't match the keychain waiting animation. This creates visual inconsistency in the app's loading states.\n\n<strong>Current State</strong>\n\n**Starting Magic Audit animation:**\n<code><div class=\"text-center\">\n  <div class=\"w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4\">\n    <svg class=\"w-8 h-8 text-blue-600 animate-spin\" fill=\"none\" viewBox=\"0 0 24 24\">\n      <circle class=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"4\"></circle>\n      <path class=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n    </svg>\n  </div>\n  <p class=\"text-gray-600 text-sm\">Starting Magic Audit...</p>\n</div>\n</code>\n\n**Keychain waiting animation:** (different style)\n\n<strong>Proposed Solution</strong>\n\n1. Create a shared <code>LoadingSpinner</code> component with consistent styling\n2. Use it in both locations:\n   - App startup \"Starting Magic Audit...\"\n   - Keychain access waiting state\n   - Any other loading states\n\n<strong>Benefits</strong>\n\u2022 Visual consistency across the app\n\u2022 Single source of truth for loading UI\n\u2022 Easier to update/rebrand loading animations\n\n<strong>Acceptance Criteria</strong>\n\u2610 Identify all loading animation locations in codebase\n\u2610 Create shared LoadingSpinner component\n\u2610 Update \"Starting Magic Audit\" to use shared component\n\u2610 Update keychain waiting to use shared component\n\u2610 Animations are visually identical\n\u2610 No functional changes"
  },
  {
    "id": "BACKLOG-510",
    "title": "Fix transaction card communication counters",
    "category": "bug",
    "priority": "medium",
    "status": "completed",
    "sprint": "SPRINT-061",
    "est_tokens": "",
    "actual_tokens": "UI",
    "variance": "Text and email thread counters on TransactionCard show wrong counts. Counters hidden until fixed. Need to recalculate counts based on new junction table architecture.",
    "created_at": "",
    "completed_at": "",
    "file": "",
    "description": "<strong>Type</strong>\nbug\n\n<strong>Priority</strong>\nmedium\n\n<strong>Status</strong>\nin_progress\n\n<strong>Sprint</strong>\nSPRINT-061\n\n<strong>Description</strong>\n\nText and email thread counters on TransactionCard show wrong counts. Counters are currently hidden (commented out in UI) until the counting logic is fixed to work with the new three-table architecture from BACKLOG-506.\n\n<strong>Root Cause (Investigation Needed)</strong>\n\nThe email count query in <code>transactionDbService.ts</code> uses:\n<code>COALESCE(m.channel, c.communication_type) = 'email'\n</code>\n\nBut <code>c.communication_type</code> was removed from the <code>communications</code> table in BACKLOG-506 (schema v23). The <code>communications</code> table is now a pure junction table.\n\n<strong>Current Workaround</strong>\n\nCounters are hidden in <code>TransactionCard.tsx</code> (lines 208-225) with comment:\n<code>{/* BACKLOG-510: Counters hidden until count accuracy is fixed */}\n</code>\n\n<strong>Technical Details</strong>\n\n**New Architecture (BACKLOG-506):**\n\u2022 <code>emails</code> table: stores email content\n\u2022 <code>messages</code> table: stores text message content\n\u2022 <code>communications</code> table: pure junction table linking content to transactions\n  - <code>email_id</code> FK -> emails (for email links)\n  - <code>message_id</code> FK -> messages (for text links)\n  - <code>thread_id</code> for batch text thread links\n  - NO <code>communication_type</code> column\n\n**Files Affected:**\n\u2022 <code>electron/services/db/transactionDbService.ts</code> - email count query (lines 119-125, 177-182)\n\u2022 <code>electron/services/db/communicationDbService.ts</code> - thread count logic\n\u2022 <code>src/components/transaction/components/TransactionCard.tsx</code> - counter display\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Email count correctly counts distinct emails linked via <code>communications.email_id</code>\n\u2610 Text thread count correctly counts distinct threads linked via <code>communications</code>\n\u2610 TransactionCard displays accurate counters (re-enable hidden UI)\n\u2610 Counts match between card view and transaction details view\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-506: Database architecture cleanup (parent issue)\n\u2022 BACKLOG-396: Text thread count consistency\n\u2022 SPRINT-061: Communication Display Fixes"
  },
  {
    "id": "BACKLOG-511",
    "title": "Support HEIC image attachments in text threads",
    "category": "enhancement",
    "priority": "low",
    "status": "pending",
    "sprint": "",
    "est_tokens": "",
    "actual_tokens": "UI",
    "variance": "HEIC images from iPhone don't display in text thread preview. Need to convert to displayable format or show placeholder.",
    "created_at": "",
    "completed_at": "",
    "file": "",
    "description": ""
  },
  {
    "id": "BACKLOG-512",
    "title": "Auto-trigger email sync on contact list changes",
    "category": "enhancement",
    "priority": "medium",
    "status": "pending",
    "sprint": "",
    "est_tokens": "",
    "actual_tokens": "Backend",
    "variance": "When contacts are added/modified on a transaction, automatically trigger email sync instead of requiring manual 'Sync Communications' click.",
    "created_at": "",
    "completed_at": "",
    "file": "",
    "description": ""
  },
  {
    "id": "BACKLOG-513",
    "title": "Fix unknown contact name display in text threads",
    "category": "bug",
    "priority": "medium",
    "status": "completed",
    "sprint": "SPRINT-061",
    "est_tokens": "",
    "actual_tokens": "UI",
    "variance": "When linking text threads to transactions, some 1:1 conversations display 'unknown' as contact name instead of actual contact. Contact lookup not finding phone number match.",
    "created_at": "",
    "completed_at": "",
    "file": "",
    "description": "<strong>Type</strong>\nbug\n\n<strong>Priority</strong>\nmedium\n\n<strong>Status</strong>\nin_progress\n\n<strong>Sprint</strong>\nSPRINT-061\n\n<strong>Description</strong>\n\nWhen linking text threads to transactions, some 1:1 conversations display \"unknown\" as the contact name instead of the actual contact name. The contact lookup is not finding a phone number match even when the contact exists in the contacts table.\n\n<strong>Steps to Reproduce</strong>\n\n1. Import contacts from iPhone/macOS\n2. Import text messages from macOS\n3. Create a transaction\n4. Link a text thread where the phone number has a known contact\n5. Observe that some contacts show \"unknown\" instead of their name\n\n<strong>Expected Behavior</strong>\n\n\u2022 1:1 text conversations should display the contact's name\n\u2022 Phone number lookup should match contacts regardless of phone format\n\n<strong>Actual Behavior</strong>\n\n\u2022 Some 1:1 conversations display \"unknown\"\n\u2022 Contact name resolution failing for certain phone number formats\n\n<strong>Technical Investigation Needed</strong>\n\n1. **Phone Format Mismatch**: Are phone numbers stored differently in <code>contact_phones</code> vs <code>messages.participants</code>?\n2. **Normalization**: Does <code>normalizePhoneForLookup()</code> handle all common formats (+1, parentheses, dashes)?\n3. **Lookup Flow**: Is the lookup using the correct normalization at all points?\n4. **Fallback Logic**: Is \"unknown\" returned too early before all lookup attempts?\n\n<strong>Files to Investigate</strong>\n\n\u2022 <code>src/components/transactionDetailsModule/components/MessageThreadCard.tsx</code> - lines 108-162\n\u2022 <code>electron/services/iosContactsParser.ts</code> - <code>lookupByPhone()</code> method (line 371)\n\u2022 <code>electron/services/db/contactDbService.ts</code> - contact phone lookup\n\u2022 <code>electron/services/contactsService.ts</code> - \"Unknown\" fallback handling\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 1:1 text conversations show contact name (not \"unknown\") when contact exists\n\u2610 Phone normalization handles: +1 (555) 123-4567, 555-123-4567, 5551234567\n\u2610 International numbers work correctly\n\u2610 \"Unknown\" only displayed when contact truly doesn't exist\n\n<strong>Related</strong>\n\n\u2022 SPRINT-061: Communication Display Fixes\n\u2022 Contact import functionality\n\u2022 Phone normalization utilities"
  },
  {
    "id": "BACKLOG-514",
    "title": "Fix thread deduplication during message import",
    "category": "bug",
    "priority": "medium",
    "status": "deferred",
    "sprint": "-",
    "est_tokens": "",
    "actual_tokens": "Backend",
    "variance": "Same conversation appears as multiple separate threads in UI. Messages from same thread imported with different thread_ids or grouping logic not consolidating properly.",
    "created_at": "",
    "completed_at": "",
    "file": "",
    "description": "<strong>Type</strong>\nbug\n\n<strong>Priority</strong>\nmedium\n\n<strong>Status</strong>\nin_progress\n\n<strong>Sprint</strong>\nSPRINT-061\n\n<strong>Description</strong>\n\nSame conversation appears as multiple separate threads in the UI. Messages from the same thread are being imported with different thread_ids, or the grouping logic is not consolidating them properly.\n\n<strong>Steps to Reproduce</strong>\n\n1. Import messages from macOS\n2. Note a specific conversation's thread count\n3. Re-run message import (re-sync)\n4. Check if same conversation now has multiple thread entries\n5. Link the conversation to a transaction\n6. Observe if it appears as multiple threads\n\n<strong>Expected Behavior</strong>\n\n\u2022 Each conversation appears as a single thread\n\u2022 Re-sync does not create duplicate threads\n\u2022 Thread IDs are consistent across imports\n\n<strong>Actual Behavior</strong>\n\n\u2022 Same conversation may appear as multiple threads\n\u2022 Re-sync can create additional thread entries\n\u2022 Thread deduplication not working consistently\n\n<strong>Technical Investigation Needed</strong>\n\n1. **Import Thread Assignment**: How does <code>macOSMessagesImportService.ts</code> assign <code>thread_id</code>?\n   - Is it based on <code>chat_id</code> from macOS database?\n   - Is it deterministic for the same conversation?\n\n2. **GUID Deduplication**: Is GUID-based deduplication preventing duplicate messages?\n   - What happens on re-import?\n   - Are existing records updated or new ones created?\n\n3. **Frontend vs Backend Grouping**: Do they use the same logic?\n   - Frontend: <code>TransactionMessagesTab.tsx</code> thread grouping\n   - Backend: <code>countTextThreadsForTransaction()</code> in communicationDbService\n\n4. **Edge Cases**:\n   - NULL thread_id handling\n   - Thread ID changes across macOS versions\n\n<strong>Files to Investigate</strong>\n\n\u2022 <code>electron/services/macOSMessagesImportService.ts</code> - thread_id assignment, GUID deduplication\n\u2022 <code>electron/services/db/communicationDbService.ts</code> - <code>countTextThreadsForTransaction()</code> (lines 837-870)\n\u2022 <code>src/components/transactionDetailsModule/components/TransactionMessagesTab.tsx</code> - frontend grouping\n\u2022 <code>electron/database/schema.sql</code> - messages table structure\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Same conversation gets consistent thread_id across re-imports\n\u2610 GUID deduplication prevents message duplicates\n\u2610 Re-sync does not create new thread entries for existing conversations\n\u2610 Thread count matches actual unique conversations\n\u2610 Frontend and backend grouping logic are consistent\n\n<strong>Related</strong>\n\n\u2022 SPRINT-061: Communication Display Fixes\n\u2022 macOS message import\n\u2022 iPhone message sync"
  },
  {
    "id": "BACKLOG-515",
    "title": "User Identifiers Table for Contact Resolution",
    "category": "enhancement",
    "priority": "medium",
    "status": "pending",
    "sprint": "",
    "est_tokens": "",
    "actual_tokens": "Backend",
    "variance": "Create user_identifiers table to store user email/phone identifiers. Improves contact resolution performance (indexed lookup vs O(n) message scan). Supports multiple emails/phones, future messaging platforms. Auto-populate from OAuth and message imports. SR Engineer approved architecture.",
    "created_at": "",
    "completed_at": "",
    "file": "",
    "description": "<strong>Summary</strong>\n\nReplace client-side trial expiration checks with server-time validation to prevent users from manipulating their system clock to extend trials.\n\n<strong>Background</strong>\n\nCurrent trial expiration is calculated client-side:\n<code>const isExpired = new Date(license.trial_expires_at) < new Date();\n</code>\n\nA user can set their system clock back to bypass this check. Server-time validation would use Supabase's <code>now()</code> to ensure accurate expiration checks.\n\n<strong>Requirements</strong>\n\n<strong>Server-Side Function</strong>\n\n<code>CREATE OR REPLACE FUNCTION is_trial_valid(p_user_id UUID)\nRETURNS BOOLEAN AS $$\nBEGIN\n  RETURN EXISTS (\n    SELECT 1 FROM licenses\n    WHERE user_id = p_user_id\n      AND license_type = 'trial'\n      AND trial_expires_at > now()  -- Server time\n  );\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER;\n</code>\n\n<strong>Client-Side Changes</strong>\n\n1. Add RPC call to validate trial using server time\n2. Fall back to client-side check only when offline (with grace period)\n3. Cache server validation result for 1 hour\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Server-side RPC function created\n\u2610 License service uses server-time validation when online\n\u2610 Client-side fallback only used during offline grace period\n\u2610 Unit tests cover both online and offline scenarios\n\n<strong>Dependencies</strong>\n\n\u2022 BACKLOG-477 (License Schema) - COMPLETE\n\u2022 BACKLOG-478 (License Validation Service) - IN PROGRESS\n\n<strong>Related Files</strong>\n\n\u2022 <code>electron/services/licenseService.ts</code>\n\u2022 Supabase migration for RPC function"
  },
  {
    "id": "BACKLOG-542",
    "title": "Merge SMS and iMessage threads from same contact",
    "category": "bug",
    "priority": "medium",
    "status": "pending",
    "sprint": "-",
    "est_tokens": "~30K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-27",
    "completed_at": "",
    "file": "[BACKLOG-542.md](items/BACKLOG-542.md)",
    "description": "<strong>Problem Statement</strong>\n\nOn iPhone, SMS and iMessage from the same contact appear in ONE conversation thread. Our app splits them into SEPARATE threads based on channel type (SMS vs iMessage). This causes the same contact to appear multiple times in the thread list.\n\n**Example:** \"Madison\" shows up twice - once for her SMS messages, once for her iMessage messages.\n\n<strong>Expected Behavior</strong>\n\n\u2022 Group messages by contact/phone number, not by channel type\n\u2022 Match how iPhone displays conversations (unified thread per contact)\n\u2022 One thread per contact, containing both SMS and iMessage messages\n\n<strong>Root Cause (Likely)</strong>\n\n1. **macOS Messages database storage:** Messages stores SMS and iMessage with different <code>service</code> values:\n   - iMessage: <code>service = 'iMessage'</code>\n   - SMS: <code>service = 'SMS'</code>\n\n2. **Import logic issue:** Our import logic creates separate <code>thread_id</code> values based on the service type, rather than consolidating by phone number/contact.\n\n3. **Thread grouping key:** Currently uses <code>service</code> type as part of the grouping key when it should only use phone number/contact identifier.\n\n<strong>Technical Investigation Needed</strong>\n\n1. **macOS Messages Database:**\n   - How does macOS store SMS vs iMessage in the same conversation?\n   - Check <code>chat</code> table for how conversations are identified\n   - Verify <code>service</code> column values in <code>message</code> table\n\n2. **Import Service:**\n   - <code>electron/services/macOSMessagesImportService.ts</code> - thread_id assignment logic\n   - Does it use <code>chat_id</code> from macOS (which groups by contact)?\n   - Or does it generate thread_id based on service type?\n\n3. **Database Schema:**\n   - Current <code>messages</code> table thread_id logic\n   - May need to consolidate by phone number at import time\n\n<strong>Proposed Solution</strong>\n\n**Option A: Fix at Import Time**\n\u2022 Modify import to use macOS <code>chat_id</code> (which already groups by contact, not service)\n\u2022 Ignore <code>service</code> type when determining thread grouping\n\u2022 Re-import will automatically consolidate threads\n\n**Option B: Fix at Display Time**\n\u2022 Keep separate thread_ids but group by phone number in UI\n\u2022 Merge display in thread list view\n\u2022 Requires changes to <code>TransactionMessagesTab.tsx</code> grouping logic\n\n**Recommendation:** Option A (fix at import) is cleaner and matches how macOS stores the data natively.\n\n<strong>Files to Investigate</strong>\n\n| File | Purpose |\n|------|---------|\n| <code>electron/services/macOSMessagesImportService.ts</code> | Thread ID assignment during import |\n| <code>electron/database/schema.sql</code> | Messages table structure |\n| <code>src/components/transactionDetailsModule/components/TransactionMessagesTab.tsx</code> | Thread grouping in UI |\n| <code>electron/services/db/communicationDbService.ts</code> | Thread-related queries |\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Messages from same contact appear in single thread (regardless of SMS/iMessage)\n\u2610 Thread list shows one entry per contact, not one per service type\n\u2610 Existing thread links to transactions are preserved (or gracefully migrated)\n\u2610 Message display shows service type indicator per message (nice-to-have)\n\u2610 Matches iPhone conversation grouping behavior\n\n<strong>Migration Consideration</strong>\n\nExisting users may have:\n\u2022 Duplicate threads from same contact (SMS + iMessage separate)\n\u2022 Transaction links to individual threads\n\n**Migration approach:**\n1. Run thread consolidation on existing data\n2. Update thread_id references in transaction links\n3. De-duplicate thread entries\n\n<strong>Effort Estimate</strong>\n\n~30K tokens\n\u2022 Investigation: ~10K\n\u2022 Import fix: ~15K\n\u2022 Migration script: ~5K\n\n---\n\n<strong>Related</strong>\n\n\u2022 BACKLOG-514: Thread deduplication during message import (different issue - re-sync duplicates)\n\u2022 macOS Messages import feature\n\u2022 SPRINT-061: Communication Display Fixes\n\n<strong>Discovery Context</strong>\n\nFound during SPRINT-062 testing. Same contact (e.g., \"Madison\") appears twice in thread list - once for SMS history, once for iMessage history. This is confusing UX that doesn't match how iPhone displays conversations."
  },
  {
    "id": "BACKLOG-543",
    "title": "Audit period not displayed after transaction creation until edit/save",
    "category": "bug",
    "priority": "low",
    "status": "pending",
    "sprint": "-",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-27",
    "completed_at": "",
    "file": "[BACKLOG-543.md](items/BACKLOG-543.md)",
    "description": "<strong>Summary</strong>\n\nWhen creating a new transaction, the audit period doesn't show in the Overview tab summary. User has to click Edit, then Save for the audit period to appear.\n\n<strong>Problem</strong>\n\n\u2022 After creating a new transaction with a start date, the audit period is not displayed in the Overview tab\n\u2022 The <code>started_at</code> field is either not being saved on initial creation, or the UI isn't refreshing properly after creation\n\u2022 User must click Edit, then Save (without making changes) for the audit period to finally appear\n\n<strong>Expected Behavior</strong>\n\n\u2022 Audit period should show immediately after creating a transaction\n\u2022 If user entered a start date during creation, it should display as \"Jan 1, 2026 - Ongoing\" (or similar format with end date if provided)\n\n<strong>Technical Investigation Areas</strong>\n\n1. **Transaction creation flow** - Check if <code>started_at</code> is included in the initial INSERT\n2. **State refresh after creation** - Verify the transaction detail view re-fetches data after creation\n3. **Component state** - Check if Overview tab is reading stale state from creation form instead of fetched data\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 After creating a transaction with a start date, the audit period displays immediately in Overview\n\u2610 No edit/save workaround required\n\u2610 Verify <code>started_at</code> is persisted correctly on initial creation\n\n<strong>Metadata</strong>\n\n| Field | Value |\n|-------|-------|\n| ID | BACKLOG-543 |\n| Type | Bug |\n| Category | UI/State |\n| Priority | P3 |\n| Status | Pending |\n| Sprint | - |\n| Estimated Tokens | ~15K |\n| Created | 2026-01-27 |"
  },
  {
    "id": "BACKLOG-545",
    "title": "Attachments not exported in package",
    "category": "bug",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~40K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-27",
    "completed_at": "",
    "file": "[BACKLOG-545.md](items/BACKLOG-545.md)",
    "description": "**Category:** Bug - Export\n**Priority:** P2 (functional bug - incomplete export)\n**Status:** Pending\n**Created:** 2026-01-27\n\n<strong>Problem</strong>\n\nWhen exporting a transaction to a package file, attachments from emails and messages are not included in the export. Users expect all associated attachments (documents, images, etc. from emails and text messages) to be part of the exported audit package, but currently only the message content and metadata are exported.\n\n<strong>Impact</strong>\n\n\u2022 Users cannot share complete audit packages with stakeholders\n\u2022 Missing attachments require manual re-gathering of supporting documents\n\u2022 Reduces perceived completeness of exported audits\n\u2022 May result in incomplete audit trails when shared externally\n\n<strong>Related Issues</strong>\n\n\u2022 BACKLOG-451: Export Transaction to Package (completed - initial export feature)\n\u2022 BACKLOG-452: Export to PDF format enhancements\n\n<strong>Current Behavior</strong>\n\nExport package includes:\n\u2022 Transaction metadata\n\u2022 Associated emails and messages (text content only)\n\u2022 Contact information\n\u2022 Audit notes\n\nExport package does NOT include:\n\u2022 Email attachments\n\u2022 Message attachments (photos, files)\n\u2022 Attachment metadata\n\n<strong>Proposed Solution</strong>\n\n<strong>Phase 1: Identify Attachment Sources</strong>\n\n1. Map where attachments are stored:\n   - Email attachments (via Microsoft Graph API)\n   - Message attachments (from iPhone sync)\n   - Local file references in database\n\n2. Understand current storage/caching:\n   - Are attachments cached locally?\n   - How are they referenced in the database?\n   - Access patterns in export flow\n\n<strong>Phase 2: Add Attachment Collection to Export</strong>\n\n1. Modify export service to:\n   - Collect attachment references for all messages/emails\n   - Fetch attachment data (from cache or API if needed)\n   - Package attachments in export folder structure\n\n2. Define export structure:\n   <code>   export-package/\n   \u251c\u2500\u2500 transaction.json\n   \u251c\u2500\u2500 messages/\n   \u2502   \u251c\u2500\u2500 message-1.json\n   \u2502   \u2514\u2500\u2500 attachments/\n   \u2502       \u251c\u2500\u2500 document.pdf\n   \u2502       \u2514\u2500\u2500 image.jpg\n   \u2514\u2500\u2500 emails/\n       \u251c\u2500\u2500 email-1.json\n       \u2514\u2500\u2500 attachments/\n           \u2514\u2500\u2500 receipt.pdf\n   </code>\n\n<strong>Phase 3: Handle Edge Cases</strong>\n\n1. Large attachment handling:\n   - Set size limits for export package\n   - Provide warning if attachments are very large\n   - Consider compression options\n\n2. Missing attachments:\n   - Handle cases where attachment no longer accessible (API deleted, cache cleared)\n   - Log which attachments couldn't be included\n   - Continue export without failing\n\n3. Permission/access issues:\n   - Handle OAuth token expiration gracefully\n   - Verify attachment access before including\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Attachments from emails are included in export package\n\u2610 Attachments from messages are included in export package\n\u2610 Attachment folder structure is organized and clear\n\u2610 Export handles missing/inaccessible attachments gracefully\n\u2610 Export size is reasonable (warn if >50MB)\n\u2610 Exported attachments maintain original filename/type\n\u2610 Documentation updated with new export structure\n\u2610 Export flow doesn't block on attachment collection (async/background)\n\u2610 No regression in export functionality for non-attachment items\n\n<strong>Technical Considerations</strong>\n\n\u2022 Attachment API access (Microsoft Graph rate limits, OAuth tokens)\n\u2022 Local caching strategy for already-downloaded attachments\n\u2022 Memory management for large exports\n\u2022 Filename conflicts (multiple attachments with same name)\n\u2022 File type validation/security (prevent unsafe files in export)\n\n<strong>Estimated Effort</strong>\n\n~40K tokens (investigation + implementation + testing)\n\n<strong>Notes</strong>\n\n\u2022 Discovered during SPRINT-062 new user flow testing\n\u2022 Should verify with users what attachment types matter most\n\u2022 Consider if compression is needed for large exports\n\n<strong>Created</strong>\n\n2026-01-27"
  },
  {
    "id": "BACKLOG-546",
    "title": "Returning users incorrectly see T&C acceptance screen",
    "category": "bug",
    "priority": "High",
    "status": "completed",
    "sprint": "SPRINT-062",
    "est_tokens": "~15K",
    "actual_tokens": "~15K",
    "variance": "0",
    "created_at": "2026-01-27",
    "completed_at": "2026-01-27",
    "file": "[BACKLOG-546.md](items/BACKLOG-546.md)",
    "description": "<strong>Summary</strong>\n\nReturning users are incorrectly shown the Terms & Conditions acceptance screen on session restore. The <code>isNewUser</code> flag is being set to <code>true</code> for returning users during the <code>auth:get-current-user</code> IPC handler response.\n\n<strong>User Report</strong>\n\n> \"As a returning user I still see 'Welcome, Magicauditwa! Before we get started, please review and accept our terms...' - we need to make sure this is fixed. A returning user should only see it if there are new T&C to approve.\"\n\n<strong>Root Cause Analysis</strong>\n\nThe <code>auth:get-current-user</code> IPC handler is returning <code>isNewUser: true</code> for returning users during session restore. This causes the app state machine to route returning users to the T&C acceptance screen inappropriately.\n\n<strong>Expected Behavior</strong>\n\nT&C acceptance screen should ONLY be shown when:\n1. User is genuinely new (first login ever), OR\n2. There is a new T&C version that the user has not yet accepted\n\n<strong>Current (Buggy) Behavior</strong>\n\nT&C screen is shown on every session restore because <code>isNewUser</code> is incorrectly <code>true</code>.\n\n<strong>Requirements</strong>\n\n<strong>Investigation Points</strong>\n\n1. Check <code>auth:get-current-user</code> handler logic for <code>isNewUser</code> determination\n2. Verify how session restore vs fresh login is detected\n3. Check if T&C version comparison logic exists\n\n<strong>Fix Implementation</strong>\n\n1. Fix <code>isNewUser</code> flag logic in <code>auth:get-current-user</code> handler\n   - <code>isNewUser</code> should be <code>false</code> for session restores\n   - <code>isNewUser</code> should only be <code>true</code> on initial account creation\n\n2. Implement T&C version checking (if not already present)\n   - Store accepted T&C version in user profile\n   - Compare against current app T&C version\n   - Show T&C screen only when versions differ\n\n3. Update app state machine routing logic if needed\n   - Route based on: <code>isNewUser || hasNewTCVersion</code>\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Returning users do NOT see T&C screen on normal session restore\n\u2610 Returning users DO see T&C screen when there is a new T&C version\n\u2610 New users still see T&C screen on first login\n\u2610 <code>isNewUser</code> flag accurately reflects user status\n\u2610 Unit tests cover session restore vs new user scenarios\n\n<strong>Related Files (Likely)</strong>\n\n\u2022 <code>electron/auth-handlers.ts</code> - <code>auth:get-current-user</code> handler\n\u2022 <code>src/appCore/state/machine/</code> - App state machine routing\n\u2022 User profile / settings storage for T&C version tracking\n\n<strong>Dependencies</strong>\n\nNone - standalone bug fix\n\n<strong>Notes</strong>\n\nThis is a P1 bug affecting all returning users. Should be prioritized for immediate fix in SPRINT-062."
  },
  {
    "id": "BACKLOG-547",
    "title": "Email attachments not included in export package",
    "category": "bug",
    "priority": "High",
    "status": "Pending",
    "sprint": "-",
    "est_tokens": "~25K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-27",
    "completed_at": "",
    "file": "[BACKLOG-547.md](items/BACKLOG-547.md)",
    "description": "**Category:** Bug - Export\n**Priority:** P2 (functional bug - incomplete export)\n**Status:** Pending\n**Created:** 2026-01-27\n\n<strong>Problem</strong>\n\nWhen exporting a transaction to a package file, email attachments are not being included in the export. While BACKLOG-545 addressed general attachments export, email attachments from Microsoft Graph/Gmail are not being captured and packaged. Users expect all email attachments to be part of the exported audit package.\n\n<strong>Impact</strong>\n\n\u2022 Users cannot share complete audit packages when emails contain supporting documents\n\u2022 Email attachments must be manually re-gathered and attached separately\n\u2022 Incomplete audit trail when exporting transactions with email communications\n\u2022 Inconsistency with message attachment export expectations\n\n<strong>Related Issues</strong>\n\n\u2022 BACKLOG-545: General attachments export (addresses all attachments)\n\u2022 BACKLOG-451: Export Transaction to Package (initial feature)\n\n<strong>Current Behavior</strong>\n\nExport package includes:\n\u2022 Transaction metadata\n\u2022 Associated emails (text content and metadata only)\n\u2022 Message attachments (from text threads)\n\u2022 Contact information\n\nExport package does NOT include:\n\u2022 Email attachments from Microsoft Graph API\n\u2022 Email attachments from Gmail API\n\u2022 Attachment metadata and references\n\n<strong>Proposed Solution</strong>\n\n<strong>Phase 1: Email Attachment Collection</strong>\n\n1. Identify email attachment sources:\n   - Microsoft Graph: emails with attachments flag\n   - Gmail: messages with attachmentData\n   - Local cache status (if any)\n\n2. Understand current email sync/caching:\n   - How are email attachments currently stored?\n   - Are they cached locally or fetched on-demand?\n   - Database schema for email-attachment relationships\n\n<strong>Phase 2: Integration with Export Service</strong>\n\n1. Modify export flow to:\n   - Query for emails linked to transaction\n   - For each email with attachments, fetch attachment list\n   - Download attachment data (handle API limits)\n   - Package in organized structure\n\n2. Define folder structure:\n   <code>   export-package/\n   \u2514\u2500\u2500 emails/\n       \u251c\u2500\u2500 email-1.json\n       \u2514\u2500\u2500 attachments/\n           \u251c\u2500\u2500 document.pdf\n           \u251c\u2500\u2500 invoice.xlsx\n           \u2514\u2500\u2500 image.jpg\n   </code>\n\n<strong>Phase 3: Handle OAuth and Rate Limits</strong>\n\n1. Microsoft Graph API considerations:\n   - Check token validity before attachment fetch\n   - Implement exponential backoff for rate limits\n   - Handle attachment size limits\n\n2. Gmail API considerations:\n   - Handle attachmentId to binary data mapping\n   - Respect API quota\n\n<strong>Phase 4: Edge Cases</strong>\n\n1. Missing/inaccessible attachments:\n   - Handle deleted emails or revoked attachments\n   - Log unavailable attachments\n   - Continue export without failing\n\n2. Large attachment handling:\n   - Set reasonable export package size limits\n   - Warn users if email attachments exceed threshold\n   - Option to exclude large attachments\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Email attachments from Microsoft Graph are included in export\n\u2610 Email attachments from Gmail are included in export\n\u2610 Attachments organized in email-specific subdirectories\n\u2610 Original attachment filenames and types preserved\n\u2610 Handle unavailable attachments gracefully (log, continue export)\n\u2610 OAuth token validation before attachment fetch\n\u2610 Export warns if total attachment size exceeds 50MB\n\u2610 No regression in export flow for emails without attachments\n\u2610 CI/Tests pass (test export with email attachments)\n\n<strong>Technical Considerations</strong>\n\n\u2022 OAuth token refresh if expired during attachment fetch\n\u2022 Microsoft Graph batching for multiple attachment requests\n\u2022 Gmail API attachment data decoding\n\u2022 Memory management for large email attachment collections\n\u2022 Filename collision handling (duplicate names across emails)\n\u2022 Attachment type validation for security\n\u2022 Concurrent vs sequential attachment downloads\n\n<strong>Estimated Effort</strong>\n\n~25K tokens (discovery + implementation + testing)\n\nNote: This is a subset of BACKLOG-545 focused specifically on email attachments. May be smaller scope once general attachment export is completed.\n\n<strong>Notes</strong>\n\n\u2022 Discovered during SPRINT-062 testing\n\u2022 Separate from general attachments (BACKLOG-545) because email attachments have API-specific concerns\n\u2022 Confirm with users which email providers are priority (Gmail vs Exchange)\n\n<strong>Created</strong>\n\n2026-01-27"
  },
  {
    "id": "BACKLOG-548",
    "title": "Browser auth landing page with provider selection",
    "category": "feature",
    "priority": "High",
    "status": "completed",
    "sprint": "SPRINT-062",
    "est_tokens": "~5K",
    "actual_tokens": "~5K",
    "variance": "0",
    "created_at": "2026-01-27",
    "completed_at": "2026-01-27",
    "file": "[BACKLOG-548.md](items/BACKLOG-548.md)",
    "description": "<strong>Summary</strong>\n\nThe \"Sign in with Browser\" button currently hardcodes Google as the OAuth provider. Users who want to sign in with Microsoft/Outlook have no way to do so.\n\n**UPDATE (2026-01-27):** The broker-portal already has the provider selection page fully implemented at <code>broker-portal/app/auth/desktop/page.tsx</code> with both Google and Microsoft buttons. The fix is simply pointing the desktop app to use that page.\n\n<strong>Current Behavior</strong>\n\n1. User clicks \"Sign in with Browser\"\n2. App opens <code>supabase.co/auth/v1/authorize?provider=google</code> directly\n3. No option to choose Microsoft/Outlook\n\n<strong>Expected Behavior</strong>\n\n1. User clicks \"Sign in with Browser\"\n2. App opens broker portal at <code>/auth/desktop</code> (provider selection page)\n3. User clicks their preferred provider button (Google or Microsoft)\n4. OAuth flow continues with chosen provider\n5. Deep link callback (<code>magicaudit://callback</code>) works the same way for both providers\n\n<strong>Technical Approach</strong>\n\n**Selected: Option A - Use Broker Portal** (already implemented)\n\nThe broker-portal already has a complete desktop auth page at <code>broker-portal/app/auth/desktop/page.tsx</code>:\n\u2022 Google and Microsoft OAuth buttons with brand icons\n\u2022 Proper Supabase OAuth integration\n\u2022 Redirect to <code>/auth/desktop/callback</code> which triggers <code>magicaudit://callback</code>\n\u2022 Error handling and loading states\n\n**Implementation is a one-line change:**\n1. Add <code>BROKER_PORTAL_URL</code> env var (default: <code>http://localhost:3001</code>)\n2. Change <code>sessionHandlers.ts</code> to open broker portal instead of direct Supabase URL\n\n<strong>Files to Modify</strong>\n\n| File | Change |\n|------|--------|\n| <code>.env.development</code> | Add <code>BROKER_PORTAL_URL=http://localhost:3001</code> |\n| <code>.env.example</code> | Add <code>BROKER_PORTAL_URL</code> with documentation |\n| <code>electron/handlers/sessionHandlers.ts</code> | Update line ~601 to use broker portal URL |\n\n<strong>Acceptance Criteria</strong>\n\n\u2610 Clicking \"Sign in with Browser\" opens broker portal provider selection page\n\u2610 Google button initiates Google OAuth flow\n\u2610 Microsoft button initiates Microsoft/Azure OAuth flow\n\u2610 Successful auth redirects to <code>magicaudit://callback</code> with tokens\n\u2610 Both providers work with existing deep link handling\n\n<strong>Dependencies</strong>\n\n\u2022 TASK-1507 (deep link auth flow) - Complete\n\u2022 Microsoft OAuth must be configured in Supabase dashboard\n\n<strong>Notes</strong>\n\nNo new UI needs to be built - the broker portal page is already complete with:\n\u2022 Brand-appropriate Google and Microsoft buttons\n\u2022 Loading states and error handling\n\u2022 Proper OAuth redirect chain back to desktop app"
  },
  {
    "id": "BACKLOG-549",
    "title": "Investigate and consolidate TransactionToolbar vs TransactionsToolbar",
    "category": "refactoring",
    "priority": "medium",
    "status": "pending",
    "sprint": "",
    "est_tokens": "There are two nearly identical toolbar components: TransactionToolbar.tsx (used by TransactionList.tsx) and TransactionsToolbar.tsx (used by Transactions.tsx). Investigate whether both pages are needed and consolidate to a single toolbar component.",
    "actual_tokens": "",
    "variance": "2026-01-29",
    "created_at": null,
    "completed_at": null,
    "file": null,
    "description": "<strong>Type</strong>\nRefactor / Security\n\n<strong>Priority</strong>\nMedium\n\n<strong>Status</strong>\nOpen\n\n<strong>Description</strong>\n\nThe current database encryption architecture has an extra layer of complexity that may not be necessary. This backlog item proposes reviewing and potentially simplifying the architecture by storing the database encryption key directly in the OS keychain instead of using an intermediate encrypted file.\n\n<strong>Problem Statement</strong>\n\n<strong>Current Architecture (Three-Layer)</strong>\n\n<code>macOS Keychain / Windows DPAPI / Linux Secret Service\n                    |\n                    v\n        [Wrapping Key via safeStorage]\n                    |\n                    v\n        [db-key-store.json (encrypted)]\n        Contains: encryptedKey + metadata\n                    |\n                    v\n        [mad.db (SQLCipher encrypted)]\n</code>\n\n**Current Flow:**\n1. Electron's <code>safeStorage</code> uses OS keychain to provide a \"wrapping key\"\n2. The wrapping key encrypts the actual DB encryption key\n3. The encrypted DB key is stored in <code>db-key-store.json</code> alongside metadata\n4. At runtime, the key is decrypted and used with SQLCipher\n\n<strong>Current Implementation Files</strong>\n\n\u2022 <code>electron/services/databaseEncryptionService.ts</code> - Manages key generation, storage, retrieval\n\u2022 <code>db-key-store.json</code> (in userData dir) - Stores encrypted key + metadata\n\n<strong>Current Key Store Structure</strong>\n\n<code>interface KeyStore {\n  encryptedKey: string;  // Base64-encoded, safeStorage-encrypted DB key\n  metadata: {\n    keyId: string;       // UUID\n    createdAt: string;   // ISO timestamp\n    rotatedAt?: string;  // ISO timestamp (if rotated)\n    version: number;     // Currently 1\n  };\n}\n</code>\n\n<strong>Proposed Simplification</strong>\n\n<strong>Direct OS Keychain Storage (Two-Layer)</strong>\n\n<code>macOS Keychain / Windows DPAPI / Linux Secret Service\n        [DB Encryption Key stored directly]\n                    |\n                    v\n        [mad.db (SQLCipher encrypted)]\n</code>\n\n**Simplified Flow:**\n1. Store the DB encryption key directly in OS keychain\n2. Retrieve key directly from keychain at runtime\n3. Use key with SQLCipher\n\n<strong>Benefits of Simplification</strong>\n\n| Benefit | Description |\n|---------|-------------|\n| **Simpler architecture** | Fewer moving parts = fewer failure points |\n| **More secure** | No encrypted key file on disk that could be copied |\n| **Fewer files** | No <code>db-key-store.json</code> to manage/backup/corrupt |\n| **Direct OS security** | Full reliance on well-tested OS security |\n| **Less code** | Reduced maintenance burden |\n\n<strong>Technical Considerations</strong>\n\n<strong>1. Metadata Storage</strong>\n\nThe current architecture stores metadata (keyId, createdAt, version). Options:\n\n| Option | Pros | Cons |\n|--------|------|------|\n| Store metadata as separate keychain entries | Keeps simplicity, uses OS storage | Multiple keychain lookups |\n| Store metadata in app preferences | Simple, doesn't need keychain access | Separate from key lifecycle |\n| Encode metadata in key entry name | Single lookup | Limited metadata capacity |\n| Drop metadata | Simplest | Lose audit trail |\n\n**Recommendation:** If metadata is needed, store it in app preferences (electron-store or similar). Key rotation tracking can be handled separately.\n\n<strong>2. Key Rotation</strong>\n\nCurrent <code>rotateKey()</code> method returns both old and new keys for migration. With direct keychain storage:\n\n| Approach | Implementation |\n|----------|---------------|\n| **Named entries** | Store keys as <code>magic-audit-db-key-v1</code>, <code>magic-audit-db-key-v2</code> |\n| **Single entry** | One key entry, rotation handled via re-keying database |\n| **Backup entry** | Main key + backup/previous key entry |\n\n<strong>3. Cross-Platform Consistency</strong>\n\n| Platform | Current | Proposed |\n|----------|---------|----------|\n| **macOS** | safeStorage -> Keychain | Direct Keychain via safeStorage |\n| **Windows** | safeStorage -> DPAPI | Direct DPAPI via safeStorage |\n| **Linux** | safeStorage -> Secret Service | Direct Secret Service via safeStorage |\n\nElectron's <code>safeStorage</code> already abstracts cross-platform differences. The simplification maintains this abstraction.\n\n<strong>4. Migration Path</strong>\n\nExisting users have <code>db-key-store.json</code>. Migration strategy:\n\n<code>1. Check if db-key-store.json exists (returning user)\n2. If yes:\n   a. Read and decrypt key using current method\n   b. Store key directly in keychain (new location)\n   c. Verify retrieval works\n   d. Delete db-key-store.json\n3. If no (new user):\n   a. Generate key directly in keychain\n</code>\n\n**Rollback safety:** Keep <code>db-key-store.json</code> for one release cycle before deletion.\n\n<strong>5. Electron safeStorage Limitations</strong>\n\nVerify that <code>safeStorage</code> can:\n\u2022 Store arbitrary string data (not just encrypt/decrypt)\n\u2022 Handle 64-character hex strings (256-bit key)\n\u2022 Support multiple named entries (if metadata needed)\n\n**Note:** <code>safeStorage</code> only provides <code>encryptString</code>/<code>decryptString</code>. For direct keychain storage, may need <code>keytar</code> or native APIs. This needs investigation.\n\n<strong>Alternative: Keep File, Simplify Metadata</strong>\n\nIf direct keychain storage has limitations, consider:\n\n<code>// Simplified KeyStore - just the encrypted key, no metadata\ninterface KeyStore {\n  encryptedKey: string;\n  version: number;  // For format changes only\n}\n</code>\n\nThis reduces complexity while maintaining compatibility.\n\n<strong>Acceptance Criteria</strong>\n\n<strong>Investigation Phase</strong>\n\u2610 Verify Electron safeStorage capabilities for this use case\n\u2610 Research keytar or native keychain alternatives if needed\n\u2610 Document platform-specific behavior differences\n\u2610 Test keychain entry size limits\n\n<strong>Implementation Phase (if simplification viable)</strong>\n\u2610 Update <code>databaseEncryptionService.ts</code> to use direct storage\n\u2610 Implement migration path for existing users\n\u2610 Add rollback mechanism for first release\n\u2610 Update error handling for keychain-specific errors\n\u2610 Remove <code>db-key-store.json</code> file handling code (after migration period)\n\n<strong>Testing Phase</strong>\n\u2610 Test on macOS (Keychain)\n\u2610 Test on Windows (DPAPI/Credential Manager)\n\u2610 Test on Linux (Secret Service)\n\u2610 Test migration from old to new format\n\u2610 Test fresh install\n\u2610 Test key rotation (if supported)\n\u2610 Performance comparison (keychain vs file)\n\n<strong>Risks and Mitigations</strong>\n\n| Risk | Mitigation |\n|------|------------|\n| **Keychain unavailable** | Keep fallback to current file-based approach |\n| **Migration data loss** | Phased rollout, keep old file initially |\n| **Platform differences** | Thorough cross-platform testing |\n| **Performance impact** | Benchmark keychain access vs file read |\n| **Keychain prompt fatigue** | Verify no additional prompts vs current |\n\n<strong>Estimated Complexity</strong>\n\n**Medium** - Focused change to single service, but requires:\n\u2022 Cross-platform testing\n\u2022 Migration logic\n\u2022 Understanding of keychain APIs\n\n<strong>Estimated Effort</strong>\n\n\u2022 **Investigation**: ~10K tokens\n\u2022 **Implementation**: ~25K tokens\n\u2022 **Migration logic**: ~15K tokens\n\u2022 **Testing**: ~15K tokens\n\u2022 **Total**: ~65K tokens\n\n<strong>Related Files</strong>\n\n\u2022 <code>electron/services/databaseEncryptionService.ts</code> - Primary file to modify\n\u2022 <code>electron/services/databaseService.ts</code> - Uses encryption service\n\u2022 <code>electron/main.ts</code> - Initializes encryption service\n\n<strong>Related Documentation</strong>\n\n\u2022 [Electron safeStorage API](https://www.electronjs.org/docs/latest/api/safe-storage)\n\u2022 [macOS Keychain Services](https://developer.apple.com/documentation/security/keychain_services)\n\u2022 [Windows DPAPI](https://docs.microsoft.com/en-us/dotnet/standard/security/how-to-use-data-protection)\n\u2022 [keytar npm package](https://www.npmjs.com/package/keytar) (potential alternative)\n\n<strong>Decision Record</strong>\n\n**Decision needed:** Should we simplify to direct keychain storage, or keep the current architecture with reduced metadata?\n\nFactors to consider:\n1. Does <code>safeStorage</code> support our needs, or do we need <code>keytar</code>?\n2. Is the added complexity of <code>db-key-store.json</code> causing real problems?\n3. Is the migration risk worth the simplification benefit?\n\n<strong>Created</strong>\n2026-01-27"
  },
  {
    "id": "BACKLOG-566",
    "title": "Multi-Category Contact Filtering in EditContactsModal",
    "category": "enhancement",
    "priority": "Medium",
    "status": "Testing",
    "sprint": "SPRINT-066",
    "est_tokens": "~15K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-29",
    "completed_at": "TASK-1769",
    "file": "[BACKLOG-566-multi-category-contact-filtering.md](items/BACKLOG-566-multi-category-contact-filtering.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-567",
    "title": "Sort Contacts by Most Recent Communication",
    "category": "enhancement",
    "priority": "Medium",
    "status": "Testing",
    "sprint": "SPRINT-066",
    "est_tokens": "~8K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-29",
    "completed_at": "TASK-1770",
    "file": "[BACKLOG-567-contact-selection-sort-by-recent.md](items/BACKLOG-567-contact-selection-sort-by-recent.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-568",
    "title": "Unify New Audit Modal Navigation (Remove Nested Buttons)",
    "category": "ux-bug",
    "priority": "High",
    "status": "Pending",
    "sprint": "SPRINT-066",
    "est_tokens": "~20K",
    "actual_tokens": "-",
    "variance": "-",
    "created_at": "2026-01-29",
    "completed_at": "TASK-1771",
    "file": "[BACKLOG-568-audit-modal-unified-navigation.md](items/BACKLOG-568-audit-modal-unified-navigation.md)",
    "description": ""
  },
  {
    "id": "BACKLOG-569",
    "title": "Update joyride onboarding tour",
    "category": "ux",
    "priority": "medium",
    "status": "pending",
    "sprint": "",
    "est_tokens": "Review and update the joyride onboarding tour to reflect recent UI changes",
    "actual_tokens": "2026-01-31",
    "variance": "",
    "created_at": null,
    "completed_at": null,
    "file": null,
    "description": ""
  },
  {
    "id": "BACKLOG-570",
    "title": "Silent refresh pattern for contact imports",
    "category": "bugfix",
    "priority": "medium",
    "status": "completed",
    "sprint": "SPRINT-066",
    "est_tokens": "Prevent loading flicker after importing contacts by using silent refresh that doesn't show loading state",
    "actual_tokens": "2026-01-31",
    "variance": "",
    "created_at": null,
    "completed_at": null,
    "file": null,
    "description": ""
  },
  {
    "id": "BACKLOG-571",
    "title": "Fix contact source categorization for imports",
    "category": "bugfix",
    "priority": "medium",
    "status": "completed",
    "sprint": "SPRINT-066",
    "est_tokens": "Use source=contacts_app instead of manual when importing from Contacts App so they appear in Imported filter",
    "actual_tokens": "2026-01-31",
    "variance": "",
    "created_at": null,
    "completed_at": null,
    "file": null,
    "description": ""
  },
  {
    "id": "BACKLOG-572",
    "title": "Transaction header responsive improvements",
    "category": "ux",
    "priority": "medium",
    "status": "completed",
    "sprint": "SPRINT-066",
    "est_tokens": "Always row layout with flex-nowrap - address on two lines - prevents Export button wrapping",
    "actual_tokens": "2026-01-31",
    "variance": "",
    "created_at": null,
    "completed_at": null,
    "file": null,
    "description": ""
  },
  {
    "id": "BACKLOG-573",
    "title": "Transaction details button reorganization",
    "category": "ux",
    "priority": "medium",
    "status": "completed",
    "sprint": "SPRINT-066",
    "est_tokens": "Move Edit Summary button next to Summary heading - move Delete button to bottom center of Overview tab",
    "actual_tokens": "2026-01-31",
    "variance": "",
    "created_at": null,
    "completed_at": null,
    "file": null,
    "description": ""
  },
  {
    "id": "BACKLOG-574",
    "title": "Emails and Messages empty state styling",
    "category": "ux",
    "priority": "low",
    "status": "completed",
    "sprint": "SPRINT-066",
    "est_tokens": "Update empty states to match contacts style with gray box - centered icon - and action button",
    "actual_tokens": "2026-01-31",
    "variance": "",
    "created_at": null,
    "completed_at": null,
    "file": null,
    "description": ""
  },
  {
    "id": "BACKLOG-575",
    "title": "ContactRoleRow responsive layout",
    "category": "ux",
    "priority": "medium",
    "status": "completed",
    "sprint": "SPRINT-066",
    "est_tokens": "Add flex-wrap so dropdown wraps to next line on narrow screens - prevent name truncation",
    "actual_tokens": "2026-01-31",
    "variance": "",
    "created_at": null,
    "completed_at": null,
    "file": null,
    "description": ""
  },
  {
    "id": "BACKLOG-576",
    "title": "Responsive icon-only buttons for Overview tab",
    "category": "ux",
    "priority": "medium",
    "status": "completed",
    "sprint": "SPRINT-066",
    "est_tokens": "Edit Summary - Sync - Edit Contacts buttons show icon-only on small screens with text on larger screens",
    "actual_tokens": "2026-01-31",
    "variance": "",
    "created_at": null,
    "completed_at": null,
    "file": null,
    "description": ""
  },
  {
    "id": "BACKLOG-577",
    "title": "Consistent Edit button colors",
    "category": "ux",
    "priority": "low",
    "status": "completed",
    "sprint": "SPRINT-066",
    "est_tokens": "Change Edit Summary button from indigo to blue to match Edit Contacts button color",
    "actual_tokens": "2026-01-31",
    "variance": "",
    "created_at": null,
    "completed_at": null,
    "file": null,
    "description": ""
  },
  {
    "id": "BACKLOG-578",
    "title": "Fix Supabase RLS infinite recursion in organization_members",
    "category": "bugfix",
    "priority": "high",
    "status": "pending",
    "sprint": "",
    "est_tokens": "Fix Row Level Security policy on organization_members table that causes infinite recursion - need to use security definer function or different table reference",
    "actual_tokens": "2026-01-31",
    "variance": "",
    "created_at": null,
    "completed_at": null,
    "file": null,
    "description": ""
  }
];

        let currentSort = { column: 'id', direction: 'asc' };
        let filteredData = [...backlogData];

        // Chart instances (for updating)
        let statusChart, priorityChart, categoryChart, effortChart;

        // Colors
        const colors = {
            primary: '#667eea',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            info: '#3b82f6',
            gray: '#6b7280',
            purple: '#8b5cf6',
            pink: '#ec4899'
        };

        const statusColors = {
            'pending': '#818cf8',
            'completed': '#34d399',
            'in-progress': '#fbbf24',
            'testing': '#60a5fa',
            'blocked': '#f87171',
            'reopened': '#f472b6',
            'obsolete': '#94a3b8',
            'deferred': '#a1a1aa'
        };

        const priorityColors = {
            'critical': '#ef4444',
            'high': '#f59e0b',
            'medium': '#3b82f6',
            'low': '#6b7280'
        };

        // Multi-select state
        const multiSelectState = {
            status: [],
            priority: [],
            category: [],
            sprint: []
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('generated-time').textContent = new Date().toLocaleString();

            populateFilters();
            renderAll();

            // Event listeners
            document.getElementById('searchInput').addEventListener('input', applyFilters);

            // Sort headers
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.addEventListener('click', () => sortTable(th.dataset.sort));
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.multi-select')) {
                    document.querySelectorAll('.multi-select-dropdown').forEach(d => d.classList.remove('open'));
                }
            });
        });

        function normalize(val) {
            return (val || '').toLowerCase().trim().replace(/\*/g, '').replace(/_/g, '');
        }

        function parseTokens(val) {
            if (!val || val === '-') return 0;
            val = val.replace(/~/g, '').replace(/,/g, '').toUpperCase().trim();
            if (val.includes('-') && !val.startsWith('-')) val = val.split('-')[0];
            if (val.includes('K')) return parseFloat(val.replace('K', '')) * 1000 || 0;
            if (val.includes('M')) return parseFloat(val.replace('M', '')) * 1000000 || 0;
            return parseInt(val) || 0;
        }

        function formatTokens(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(0) + 'K';
            return num.toString();
        }

        function createMultiSelect(containerId, options, stateKey, placeholder) {
            const container = document.getElementById(containerId);
            const btn = document.createElement('button');
            btn.className = 'multi-select-btn';
            btn.type = 'button';
            btn.innerHTML = `<span class="selected-tags">${placeholder}</span>`;

            const dropdown = document.createElement('div');
            dropdown.className = 'multi-select-dropdown';

            options.forEach(opt => {
                const optDiv = document.createElement('div');
                optDiv.className = 'multi-select-option';
                optDiv.innerHTML = `<input type="checkbox" value="${opt}"> ${opt.charAt(0).toUpperCase() + opt.slice(1)}`;
                optDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const checkbox = optDiv.querySelector('input');
                    // Only toggle if click was not directly on the checkbox (browser already toggled it)
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                    }
                    optDiv.classList.toggle('selected', checkbox.checked);

                    if (checkbox.checked) {
                        if (!multiSelectState[stateKey].includes(opt)) {
                            multiSelectState[stateKey].push(opt);
                        }
                    } else {
                        multiSelectState[stateKey] = multiSelectState[stateKey].filter(v => v !== opt);
                    }

                    updateMultiSelectDisplay(btn, stateKey, placeholder);
                    applyFilters();
                });
                dropdown.appendChild(optDiv);
            });

            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('.multi-select-dropdown').forEach(d => {
                    if (d !== dropdown) d.classList.remove('open');
                });
                dropdown.classList.toggle('open');
            });

            container.appendChild(btn);
            container.appendChild(dropdown);
        }

        function updateMultiSelectDisplay(btn, stateKey, placeholder) {
            const selected = multiSelectState[stateKey];
            const tagsSpan = btn.querySelector('.selected-tags');
            if (selected.length === 0) {
                tagsSpan.innerHTML = placeholder;
            } else if (selected.length <= 2) {
                tagsSpan.innerHTML = selected.map(s =>
                    `<span class="selected-tag">${s.charAt(0).toUpperCase() + s.slice(1)}</span>`
                ).join('');
            } else {
                tagsSpan.innerHTML = `<span class="selected-tag">${selected.length} selected</span>`;
            }
        }

        function setMultiSelectValues(stateKey, values) {
            multiSelectState[stateKey] = values;
            const container = document.getElementById(stateKey + 'Filter');
            const btn = container.querySelector('.multi-select-btn');
            const options = container.querySelectorAll('.multi-select-option');

            options.forEach(opt => {
                const checkbox = opt.querySelector('input');
                const isSelected = values.includes(checkbox.value);
                checkbox.checked = isSelected;
                opt.classList.toggle('selected', isSelected);
            });

            const placeholder = stateKey === 'status' ? 'All Statuses' :
                               stateKey === 'priority' ? 'All Priorities' :
                               stateKey === 'category' ? 'All Categories' : 'All Sprints';
            updateMultiSelectDisplay(btn, stateKey, placeholder);
        }

        function populateFilters() {
            const statuses = [...new Set(backlogData.map(i => normalize(i.status)))].filter(Boolean).sort();
            const priorities = ['critical', 'high', 'medium', 'low'];
            const categories = [...new Set(backlogData.map(i => normalize(i.category)))].filter(Boolean).sort();

            // Get unique sprints, add "Unassigned" option
            const sprints = [...new Set(backlogData.map(i => i.sprint).filter(s => s && s !== '-'))].sort();
            const sprintOptions = ['unassigned', ...sprints];

            createMultiSelect('statusFilter', statuses, 'status', 'All Statuses');
            createMultiSelect('priorityFilter', priorities, 'priority', 'All Priorities');
            createMultiSelect('categoryFilter', categories, 'category', 'All Categories');
            createMultiSelect('sprintFilter', sprintOptions, 'sprint', 'All Sprints');
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const statuses = multiSelectState.status;
            const priorities = multiSelectState.priority;
            const categories = multiSelectState.category;
            const sprints = multiSelectState.sprint;

            filteredData = backlogData.filter(item => {
                if (search) {
                    const searchFields = [item.id, item.title, item.category].join(' ').toLowerCase();
                    if (!searchFields.includes(search)) return false;
                }
                if (statuses.length > 0 && !statuses.includes(normalize(item.status))) return false;
                if (priorities.length > 0 && !priorities.includes(normalize(item.priority))) return false;
                if (categories.length > 0 && !categories.includes(normalize(item.category))) return false;

                // Sprint filter logic
                if (sprints.length > 0) {
                    const itemSprint = item.sprint && item.sprint !== '-' ? item.sprint : 'unassigned';
                    if (!sprints.includes(itemSprint)) return false;
                }

                return true;
            });

            // Update filter indicator
            const hasFilters = search || statuses.length > 0 || priorities.length > 0 || categories.length > 0 || sprints.length > 0;
            document.getElementById('filterIndicator').classList.toggle('active', hasFilters);

            renderTable();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterIndicator').classList.remove('active');

            // Reset multi-selects
            setMultiSelectValues('status', []);
            setMultiSelectValues('priority', []);
            setMultiSelectValues('category', []);
            setMultiSelectValues('sprint', []);

            filteredData = [...backlogData];
            renderAll();
        }

        // Chart click handlers
        function handleChartClick(filterType, value) {
            if (filterType === 'status') {
                setMultiSelectValues('status', [value]);
            } else if (filterType === 'priority') {
                setMultiSelectValues('priority', [value]);
            } else if (filterType === 'category') {
                setMultiSelectValues('category', [value]);
            }
            applyFilters();
            // Scroll to table
            document.querySelector('.table-container').scrollIntoView({ behavior: 'smooth' });
        }

        function renderAll() {
            renderMetrics();
            renderCharts();
            renderTable();
        }

        function renderMetrics() {
            const closed = ['completed', 'obsolete'];
            const total = filteredData.length;
            const open = filteredData.filter(i => !closed.includes(normalize(i.status)));
            const completed = filteredData.filter(i => normalize(i.status) === 'completed');
            const critical = filteredData.filter(i => normalize(i.priority) === 'critical' && !closed.includes(normalize(i.status)));
            const highPriority = filteredData.filter(i => ['critical', 'high'].includes(normalize(i.priority)) && !closed.includes(normalize(i.status)));
            const unassigned = open.filter(i => !i.sprint || i.sprint === '-');
            const blocked = filteredData.filter(i => normalize(i.status) === 'blocked');
            const reopened = filteredData.filter(i => normalize(i.status) === 'reopened');

            const totalEstimate = open.reduce((sum, i) => sum + parseTokens(i.est_tokens), 0);

            const metrics = [
                { value: total, label: 'Total Items', class: 'info', detail: `${open.length} open` },
                { value: completed.length, label: 'Completed', class: 'success', detail: `${((completed.length/backlogData.length)*100).toFixed(0)}% of all` },
                { value: unassigned.length, label: 'Unassigned', class: '', detail: 'Not in any sprint' },
            ];

            // Add attention items if present
            if (blocked.length > 0) {
                metrics.push({ value: blocked.length, label: 'Blocked', class: 'danger', detail: 'Needs attention' });
            }
            if (reopened.length > 0) {
                metrics.push({ value: reopened.length, label: 'Reopened', class: 'danger', detail: 'Failed testing' });
            }

            const grid = document.getElementById('metrics-grid');
            grid.innerHTML = metrics.map(m => `
                <div class="metric-card ${m.class}">
                    <div class="metric-value">${m.value}</div>
                    <div class="metric-label">${m.label}</div>
                    <div class="metric-detail">${m.detail}</div>
                </div>
            `).join('');
        }

        function renderCharts() {
            const closed = ['completed', 'obsolete'];
            const openItems = filteredData.filter(i => !closed.includes(normalize(i.status)));

            // Status Chart
            const statusCounts = {};
            filteredData.forEach(i => {
                const s = normalize(i.status) || 'unknown';
                statusCounts[s] = (statusCounts[s] || 0) + 1;
            });

            const statusLabels = Object.keys(statusCounts);
            const statusData = Object.values(statusCounts);
            const statusChartColors = statusLabels.map(s => statusColors[s] || '#94a3b8');

            if (statusChart) statusChart.destroy();
            statusChart = new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: statusLabels.map(s => s.charAt(0).toUpperCase() + s.slice(1)),
                    datasets: [{
                        data: statusData,
                        backgroundColor: statusChartColors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, padding: 10 } }
                    },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            handleChartClick('status', statusLabels[idx]);
                        }
                    }
                }
            });

            // Priority Chart
            const priorityOrder = ['critical', 'high', 'medium', 'low'];
            const priorityCounts = { critical: 0, high: 0, medium: 0, low: 0 };
            openItems.forEach(i => {
                const p = normalize(i.priority);
                if (priorityCounts.hasOwnProperty(p)) priorityCounts[p]++;
            });

            if (priorityChart) priorityChart.destroy();
            priorityChart = new Chart(document.getElementById('priorityChart'), {
                type: 'bar',
                data: {
                    labels: priorityOrder.map(p => p.charAt(0).toUpperCase() + p.slice(1)),
                    datasets: [{
                        label: 'Items',
                        data: priorityOrder.map(p => priorityCounts[p]),
                        backgroundColor: priorityOrder.map(p => priorityColors[p])
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            handleChartClick('priority', priorityOrder[idx]);
                        }
                    }
                }
            });

            // Category Chart
            const categoryCounts = {};
            openItems.forEach(i => {
                const c = normalize(i.category) || 'other';
                categoryCounts[c] = (categoryCounts[c] || 0) + 1;
            });
            const topCategories = Object.entries(categoryCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);

            if (categoryChart) categoryChart.destroy();
            const categoryLabels = topCategories.map(c => c[0]);
            categoryChart = new Chart(document.getElementById('categoryChart'), {
                type: 'bar',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        label: 'Items',
                        data: topCategories.map(c => c[1]),
                        backgroundColor: colors.primary
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            handleChartClick('category', categoryLabels[idx]);
                        }
                    }
                }
            });

            // Effort Chart
            const effortBuckets = { 'Small (<20K)': 0, 'Medium (20-50K)': 0, 'Large (50-100K)': 0, 'XLarge (>100K)': 0, 'No estimate': 0 };
            openItems.forEach(i => {
                const tokens = parseTokens(i.est_tokens);
                if (tokens === 0) effortBuckets['No estimate']++;
                else if (tokens < 20000) effortBuckets['Small (<20K)']++;
                else if (tokens < 50000) effortBuckets['Medium (20-50K)']++;
                else if (tokens < 100000) effortBuckets['Large (50-100K)']++;
                else effortBuckets['XLarge (>100K)']++;
            });

            if (effortChart) effortChart.destroy();
            effortChart = new Chart(document.getElementById('effortChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(effortBuckets),
                    datasets: [{
                        data: Object.values(effortBuckets),
                        backgroundColor: [colors.success, colors.warning, '#f97316', colors.danger, colors.gray]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, padding: 10 } }
                    }
                }
            });
        }

        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            const priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 };

            filteredData.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';

                if (column === 'priority') {
                    aVal = priorityOrder[normalize(aVal)] ?? 99;
                    bVal = priorityOrder[normalize(bVal)] ?? 99;
                } else if (column === 'est_tokens') {
                    aVal = parseTokens(aVal);
                    bVal = parseTokens(bVal);
                } else if (column === 'id') {
                    aVal = parseInt(aVal.replace('BACKLOG-', '')) || 0;
                    bVal = parseInt(bVal.replace('BACKLOG-', '')) || 0;
                } else {
                    aVal = normalize(aVal);
                    bVal = normalize(bVal);
                }

                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
                if (th.dataset.sort === column) {
                    th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
            });

            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');

            tbody.innerHTML = filteredData.map(item => {
                const priority = normalize(item.priority);
                const status = normalize(item.status).replace(' ', '-');

                return `
                    <tr class="clickable-row" onclick="showItemDetail('${item.id}')">
                        <td><span class="id-link">${item.id.replace('BACKLOG-', '')}</span></td>
                        <td>${item.title}</td>
                        <td>${item.category || '-'}</td>
                        <td><span class="priority-badge priority-${priority}">${item.priority || '-'}</span></td>
                        <td><span class="status-badge status-${status}">${item.status || '-'}</span></td>
                        <td>${item.sprint && item.sprint !== '-' ? item.sprint : '-'}</td>
                        <td class="estimate-cell">${item.est_tokens || '-'}</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('resultCount').textContent =
                `Showing ${filteredData.length} of ${backlogData.length} items`;
        }

        // Modal functions
        function showItemDetail(itemId) {
            const item = backlogData.find(i => i.id === itemId);
            if (!item) return;

            document.getElementById('modalTitle').textContent = item.id;

            const priority = normalize(item.priority);
            const status = normalize(item.status).replace(' ', '-');

            // Format dates for display
            const formatDate = (dateStr) => {
                if (!dateStr || dateStr === '-') return '-';
                try {
                    const date = new Date(dateStr + 'T00:00:00');
                    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                } catch {
                    return dateStr;
                }
            };

            const createdAt = formatDate(item.created_at);
            const completedAt = formatDate(item.completed_at);
            const isCompleted = status === 'completed' || status === 'done';

            document.getElementById('modalBody').innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">Title</div>
                    <div class="detail-value">${item.title}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Category</div>
                    <div class="detail-value">${item.category || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Priority</div>
                    <div class="detail-value"><span class="priority-badge priority-${priority}">${item.priority || '-'}</span></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Status</div>
                    <div class="detail-value"><span class="status-badge status-${status}">${item.status || '-'}</span></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Created</div>
                    <div class="detail-value">${createdAt}</div>
                </div>
                ${isCompleted ? `
                <div class="detail-row">
                    <div class="detail-label">Completed</div>
                    <div class="detail-value">${completedAt}</div>
                </div>
                ` : ''}
                <div class="detail-row">
                    <div class="detail-label">Sprint</div>
                    <div class="detail-value">${item.sprint && item.sprint !== '-' ? item.sprint : '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Estimate</div>
                    <div class="detail-value">${item.est_tokens || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Actual</div>
                    <div class="detail-value">${item.actual_tokens || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Variance</div>
                    <div class="detail-value">${item.variance || '-'}</div>
                </div>
                <div class="detail-row" style="flex-direction: column;">
                    <div class="detail-label" style="width: 100%; margin-bottom: 8px;">Details</div>
                    <div class="detail-value description-content">${item.description || 'No detailed description available.'}</div>
                </div>
            `;

            document.getElementById('detailModal').classList.add('open');
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('open');
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>




































