# EUM-001: Database Schema - Organizations & Members

## Task Info
- **Task ID:** EUM-001
- **Phase:** 1 - Foundation
- **Dependencies:** None
- **Can Start:** Immediately
- **Parallel With:** EUM-002, EUM-003, EUM-004

## Goal

Create the Supabase database schema for organizations, memberships, SSO configurations, SCIM tokens, and audit logs with proper Row Level Security (RLS) policies.

## Non-Goals

- ❌ Modifying existing `users` table structure
- ❌ Adding application code (services, handlers)
- ❌ Creating seed data (optional, not required)
- ❌ Setting up Supabase Edge Functions
- ❌ Implementing billing/subscription tables
- ❌ Adding audit log archival logic
- ❌ Creating views or materialized views

## Background

The current database only supports individual users. We need to extend the schema to support organizations (teams/enterprises) with multiple members, SSO configurations, and audit logging.

## Deliverables

1. Supabase migration file with all new tables
2. RLS policies for multi-tenant data isolation
3. Indexes for common query patterns
4. Seed data for testing (optional)

## Technical Requirements

### 1. Create Organizations Table

```sql
CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  logo_url TEXT,

  -- SSO Settings
  sso_enabled BOOLEAN DEFAULT FALSE,
  sso_provider TEXT CHECK (sso_provider IN ('entra_id', 'google_workspace', NULL)),
  sso_enforced BOOLEAN DEFAULT FALSE,

  -- SCIM Settings
  scim_enabled BOOLEAN DEFAULT FALSE,

  -- License
  license_type TEXT NOT NULL CHECK (license_type IN ('team', 'enterprise')),
  license_seats INTEGER NOT NULL DEFAULT 5,
  seats_used INTEGER DEFAULT 0,

  -- Verified Domains
  verified_domains TEXT[] DEFAULT '{}',

  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),

  -- Soft delete
  deleted_at TIMESTAMPTZ,

  CONSTRAINT valid_seats CHECK (seats_used <= license_seats)
);

CREATE INDEX idx_organizations_slug ON organizations(slug);
CREATE INDEX idx_organizations_deleted ON organizations(deleted_at) WHERE deleted_at IS NULL;
```

### 2. Create Organization Members Table

```sql
CREATE TABLE organization_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

  -- Role & Status
  role TEXT NOT NULL DEFAULT 'member' CHECK (role IN ('owner', 'admin', 'member')),
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'suspended', 'pending')),

  -- Provisioning Info
  provisioned_by TEXT DEFAULT 'manual' CHECK (provisioned_by IN ('manual', 'scim', 'sso_jit')),
  provisioned_at TIMESTAMPTZ DEFAULT NOW(),

  -- Invitation (for pending members)
  invited_email TEXT,
  invited_at TIMESTAMPTZ,
  invited_by UUID REFERENCES users(id),

  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(organization_id, user_id)
);

CREATE INDEX idx_org_members_org ON organization_members(organization_id);
CREATE INDEX idx_org_members_user ON organization_members(user_id);
CREATE INDEX idx_org_members_status ON organization_members(status);
```

### 3. Create SSO Configurations Table

```sql
CREATE TABLE sso_configurations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE UNIQUE,

  -- Provider
  provider TEXT NOT NULL CHECK (provider IN ('entra_id', 'google_workspace')),

  -- Entra ID Config
  entra_tenant_id TEXT,
  entra_client_id TEXT,
  entra_client_secret_encrypted TEXT,

  -- Google Workspace Config
  google_workspace_domain TEXT,
  google_client_id TEXT,
  google_client_secret_encrypted TEXT,

  -- Common Settings
  attribute_mapping JSONB DEFAULT '{
    "email": "email",
    "firstName": "given_name",
    "lastName": "family_name",
    "displayName": "name"
  }',

  -- Status
  is_active BOOLEAN DEFAULT FALSE,
  last_tested_at TIMESTAMPTZ,
  test_result JSONB,

  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  configured_by UUID REFERENCES users(id)
);

CREATE INDEX idx_sso_config_org ON sso_configurations(organization_id);
```

### 4. Create SCIM Tokens Table

```sql
CREATE TABLE scim_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Token
  token_hash TEXT NOT NULL,
  token_prefix TEXT NOT NULL, -- First 8 chars for identification

  -- Metadata
  name TEXT NOT NULL DEFAULT 'Default Token',
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),

  -- Usage
  last_used_at TIMESTAMPTZ,
  use_count INTEGER DEFAULT 0,

  -- Expiration
  expires_at TIMESTAMPTZ,
  revoked_at TIMESTAMPTZ,
  revoked_by UUID REFERENCES users(id)
);

CREATE INDEX idx_scim_tokens_org ON scim_tokens(organization_id);
CREATE INDEX idx_scim_tokens_hash ON scim_tokens(token_hash);
```

### 5. Create Audit Logs Table

```sql
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Actor
  actor_id UUID REFERENCES users(id),
  actor_email TEXT,
  actor_type TEXT DEFAULT 'user' CHECK (actor_type IN ('user', 'system', 'scim')),

  -- Action
  action TEXT NOT NULL,
  resource_type TEXT NOT NULL,
  resource_id UUID,

  -- Details
  details JSONB DEFAULT '{}',
  ip_address INET,
  user_agent TEXT,

  -- Timestamp
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_audit_logs_org ON audit_logs(organization_id);
CREATE INDEX idx_audit_logs_created ON audit_logs(created_at DESC);
CREATE INDEX idx_audit_logs_actor ON audit_logs(actor_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_resource ON audit_logs(resource_type, resource_id);

-- Partition by month for performance (optional, for high-volume)
-- CREATE INDEX idx_audit_logs_created_month ON audit_logs(date_trunc('month', created_at));
```

### 6. Create RLS Policies

```sql
-- Enable RLS on all tables
ALTER TABLE organizations ENABLE ROW LEVEL SECURITY;
ALTER TABLE organization_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE sso_configurations ENABLE ROW LEVEL SECURITY;
ALTER TABLE scim_tokens ENABLE ROW LEVEL SECURITY;
ALTER TABLE audit_logs ENABLE ROW LEVEL SECURITY;

-- Organizations: Users can only see orgs they belong to
CREATE POLICY "Users can view their organizations" ON organizations
  FOR SELECT USING (
    id IN (
      SELECT organization_id FROM organization_members
      WHERE user_id = auth.uid() AND status = 'active'
    )
  );

-- Organization Members: Users can see members of their orgs
CREATE POLICY "Users can view org members" ON organization_members
  FOR SELECT USING (
    organization_id IN (
      SELECT organization_id FROM organization_members
      WHERE user_id = auth.uid() AND status = 'active'
    )
  );

-- SSO Configurations: Only admins/owners can view
CREATE POLICY "Admins can view SSO config" ON sso_configurations
  FOR SELECT USING (
    organization_id IN (
      SELECT organization_id FROM organization_members
      WHERE user_id = auth.uid()
      AND status = 'active'
      AND role IN ('owner', 'admin')
    )
  );

-- SCIM Tokens: Only admins/owners can view
CREATE POLICY "Admins can view SCIM tokens" ON scim_tokens
  FOR SELECT USING (
    organization_id IN (
      SELECT organization_id FROM organization_members
      WHERE user_id = auth.uid()
      AND status = 'active'
      AND role IN ('owner', 'admin')
    )
  );

-- Audit Logs: Only admins/owners can view
CREATE POLICY "Admins can view audit logs" ON audit_logs
  FOR SELECT USING (
    organization_id IN (
      SELECT organization_id FROM organization_members
      WHERE user_id = auth.uid()
      AND status = 'active'
      AND role IN ('owner', 'admin')
    )
  );
```

### 7. Create Helper Functions

```sql
-- Function to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ language 'plpgsql';

-- Apply to tables
CREATE TRIGGER update_organizations_updated_at
  BEFORE UPDATE ON organizations
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_organization_members_updated_at
  BEFORE UPDATE ON organization_members
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_sso_configurations_updated_at
  BEFORE UPDATE ON sso_configurations
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Function to update seats_used count
CREATE OR REPLACE FUNCTION update_seats_used()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    UPDATE organizations
    SET seats_used = (
      SELECT COUNT(*) FROM organization_members
      WHERE organization_id = NEW.organization_id AND status = 'active'
    )
    WHERE id = NEW.organization_id;
  ELSIF TG_OP = 'DELETE' THEN
    UPDATE organizations
    SET seats_used = (
      SELECT COUNT(*) FROM organization_members
      WHERE organization_id = OLD.organization_id AND status = 'active'
    )
    WHERE id = OLD.organization_id;
  ELSIF TG_OP = 'UPDATE' THEN
    UPDATE organizations
    SET seats_used = (
      SELECT COUNT(*) FROM organization_members
      WHERE organization_id = NEW.organization_id AND status = 'active'
    )
    WHERE id = NEW.organization_id;
  END IF;
  RETURN NULL;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_org_seats_used
  AFTER INSERT OR UPDATE OR DELETE ON organization_members
  FOR EACH ROW EXECUTE FUNCTION update_seats_used();
```

## Files to Create

- `supabase/migrations/YYYYMMDDHHMMSS_create_organizations.sql`

## Files to Modify

- None (new tables only)

## Audit Log Action Types

Define these action types for consistency:

```typescript
// User Actions
'user.invited'
'user.joined'
'user.removed'
'user.role_changed'
'user.suspended'
'user.reactivated'

// SSO Actions
'sso.configured'
'sso.updated'
'sso.tested'
'sso.enabled'
'sso.disabled'
'sso.enforced'
'sso.unenforced'

// SCIM Actions
'scim.enabled'
'scim.disabled'
'scim.token_created'
'scim.token_revoked'
'scim.user_provisioned'
'scim.user_deprovisioned'

// Organization Actions
'org.created'
'org.updated'
'org.domain_added'
'org.domain_removed'
'org.domain_verified'
```

## Dos

- ✅ Use UUIDs for all primary keys
- ✅ Add appropriate indexes for query performance
- ✅ Use foreign key constraints with ON DELETE CASCADE where appropriate
- ✅ Include soft delete (deleted_at) for organizations
- ✅ Use CHECK constraints for enum-like fields
- ✅ Add RLS policies for all tables

## Don'ts

- ❌ Don't store secrets in plain text (use _encrypted suffix fields)
- ❌ Don't create circular foreign key dependencies
- ❌ Don't skip RLS policies
- ❌ Don't modify existing tables (users, etc.)

## When to Stop and Ask

You MUST stop and ask the PM if:

1. **Schema changes to existing tables** - If you believe you need to modify the existing `users` table or any other existing table
2. **Missing foreign key targets** - If the `users` table doesn't have the expected structure for foreign keys
3. **RLS policy complexity** - If the RLS policies seem to require recursive CTEs or complex subqueries that might impact performance
4. **Conflicting constraints** - If CHECK constraints or foreign keys conflict with requirements
5. **Unclear cascade behavior** - If you're unsure whether ON DELETE CASCADE is appropriate for a relationship
6. **Index strategy questions** - If you're unsure whether to add composite indexes or partial indexes

Do NOT guess or make assumptions. Ask first.

## Integration Notes

### For EUM-002 (Organization Service)
- Service will use `organizations` and `organization_members` tables
- Expect service to handle soft-delete logic (querying `deleted_at IS NULL`)
- Service will manage seat counting, but trigger handles automatic updates

### For EUM-003 (Audit Service)
- Service will insert into `audit_logs` table
- Actor information comes from application context, not database
- Consider high insert volume - indexes are optimized for reads

### For EUM-004 (RBAC Service)
- Role checking uses `organization_members.role` column
- RLS policies depend on `auth.uid()` being set correctly
- Service should NOT bypass RLS - use service role only for admin operations

### For Phase 2 (SSO)
- `sso_configurations` stores encrypted secrets
- Application must encrypt before insert, decrypt after select
- `sso_enabled` and `sso_enforced` flags are on `organizations` table, not `sso_configurations`

### For Phase 4 (SCIM)
- `scim_tokens.token_hash` is a one-way hash, not reversible
- `token_prefix` allows identification without exposing full token
- Edge Function will need service role to bypass RLS for SCIM operations

## Testing Instructions

1. Apply migration to local Supabase instance
2. Verify all tables created successfully
3. Test RLS policies with different user roles
4. Verify triggers work (updated_at, seats_used)
5. Test cascading deletes

## PR Preparation Checklist

Before completing, ensure:

- [ ] Migration file is named correctly (timestamp prefix)
- [ ] All tables have RLS enabled
- [ ] All RLS policies tested
- [ ] Triggers work correctly
- [ ] Indexes are appropriate
- [ ] No syntax errors in SQL
- [ ] Created pull request with summary

## Work Summary

> **Instructions:** Update this section when your work is complete.

### Branch Name
```
[FILL IN YOUR BRANCH NAME HERE]
```

### Changes Made
```
[LIST THE FILES YOU CREATED AND WHAT THEY CONTAIN]
```

### Testing Done
```
[DESCRIBE WHAT TESTING YOU PERFORMED]
```

### Notes/Issues Encountered
```
[ANY ISSUES OR NOTES FOR THE REVIEWER]
```

### PR Link
```
[LINK TO YOUR PULL REQUEST]
```
