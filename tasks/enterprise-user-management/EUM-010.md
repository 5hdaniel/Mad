# EUM-010: SSO Integration & E2E Testing

## Task Info
- **Task ID:** EUM-010
- **Phase:** 2 - SSO Implementation (MERGE TASK)
- **Dependencies:** EUM-006, EUM-007, EUM-008, EUM-009
- **Can Start:** After all Phase 2 parallel tasks complete
- **Blocks:** All Phase 3 tasks

## Goal

Integrate all SSO services, update the authentication flow, register IPC handlers, and perform E2E testing with real Entra ID and Google Workspace tenants.

## Non-Goals

- ❌ Adding new SSO providers beyond Entra ID and Google Workspace
- ❌ Building SSO configuration UI (handled in Phase 3)
- ❌ Implementing SCIM provisioning
- ❌ Production deployment
- ❌ Performance optimization beyond basic verification
- ❌ Automated E2E test suite (manual testing acceptable)

## Deliverables

1. All SSO services integrated and working together
2. Authentication flow updated to support SSO
3. IPC handlers registered for SSO operations
4. E2E tests with Entra ID
5. E2E tests with Google Workspace
6. SSO enforcement working
7. JIT provisioning working

## Technical Requirements

### 1. Register SSO Handlers

Update `electron/main.ts` to register SSO handlers.

### 2. Update Auth Flow

Modify the existing auth flow in `electron/auth-handlers.ts`:
- Check if user's email domain has SSO configured
- Redirect to SSO if enforced
- Handle SSO callback
- Complete JIT provisioning

### 3. Create SSO IPC Handlers

```typescript
// electron/handlers/ssoHandlers.ts
ipcMain.handle('sso:configure-entra', async (_, input) => { ... });
ipcMain.handle('sso:configure-google', async (_, input) => { ... });
ipcMain.handle('sso:test', async (_, orgId) => { ... });
ipcMain.handle('sso:enable', async (_, orgId, actorId) => { ... });
ipcMain.handle('sso:disable', async (_, orgId, actorId) => { ... });
ipcMain.handle('sso:set-enforcement', async (_, orgId, enforced, actorId) => { ... });
ipcMain.handle('sso:get-config', async (_, orgId) => { ... });
ipcMain.handle('sso:determine-login-method', async (_, request) => { ... });
ipcMain.handle('sso:complete-login', async (_, provider, code, state) => { ... });
```

### 4. Update Preload Bridge

Add SSO API to `electron/preload.ts`.

### 5. E2E Test Scenarios

**Entra ID Tests:**
- [ ] Configure SSO with valid Entra ID credentials
- [ ] Test configuration succeeds
- [ ] Enable SSO
- [ ] Login with Entra ID account
- [ ] JIT provisioning creates new user
- [ ] Existing user is recognized
- [ ] Wrong tenant is rejected
- [ ] SSO enforcement blocks standard login

**Google Workspace Tests:**
- [ ] Configure SSO with valid Google credentials
- [ ] Test configuration succeeds
- [ ] Enable SSO
- [ ] Login with Workspace account
- [ ] Wrong domain is rejected
- [ ] SSO enforcement works

## Verification Checklist

- [ ] All services integrated
- [ ] Auth flow updated
- [ ] E2E: Entra ID OIDC flow works
- [ ] E2E: Google Workspace OIDC flow works
- [ ] SSO enforcement blocks non-SSO login
- [ ] JIT provisioning creates users
- [ ] Domain verification working
- [ ] Error states handled gracefully
- [ ] Logout flow works

## Files to Modify

- `electron/main.ts` - Register handlers
- `electron/auth-handlers.ts` - Add SSO support
- `electron/preload.ts` - Add SSO API

## Files to Create

- `electron/handlers/ssoHandlers.ts`
- `electron/__tests__/e2e/sso.e2e.test.ts`

## Dos

- ✅ Test both Entra ID and Google Workspace flows end-to-end
- ✅ Verify SSO enforcement blocks standard login when enabled
- ✅ Verify JIT provisioning creates new users correctly
- ✅ Test error handling for all failure scenarios
- ✅ Ensure logout flow clears SSO session properly

## Don'ts

- ❌ Don't merge if either provider's E2E tests fail
- ❌ Don't skip JIT provisioning testing
- ❌ Don't hardcode test tenant credentials
- ❌ Don't skip SSO enforcement testing

## Acceptance Criteria

- [ ] All Phase 2 task branches merged without conflicts
- [ ] SSO handlers registered in `electron/main.ts`
- [ ] SSO APIs exposed via `electron/preload.ts`
- [ ] Entra ID SSO flow works end-to-end
- [ ] Google Workspace SSO flow works end-to-end
- [ ] JIT provisioning creates new users on first SSO login
- [ ] Existing users are recognized and logged in
- [ ] SSO enforcement blocks standard login when enabled
- [ ] Wrong tenant/domain authentication is rejected
- [ ] Logout properly clears SSO session
- [ ] Type check passes: `npm run type-check`
- [ ] Lint check passes: `npm run lint`

## When to Stop and Ask

You MUST stop and ask the PM if:

1. **Merge conflicts** - If Phase 2 branches have significant conflicts
2. **Auth flow changes** - If existing auth flow needs major modifications
3. **Test tenant access** - If you don't have access to test Entra ID/Google tenants
4. **Callback handling** - If Electron deep link callback handling is unclear
5. **E2E test failures** - If E2E tests fail due to configuration or design issues
6. **Token storage** - If session/token storage patterns need clarification

Do NOT guess or make assumptions. Ask first.

## Integration Notes

### This Task Depends On
- **EUM-006**: Entra ID SSO Service
- **EUM-007**: Google Workspace SSO Service
- **EUM-008**: SSO Core Service
- **EUM-009**: JIT Provisioning Service

### This Task Blocks
- **All Phase 3 tasks**: Admin Portal depends on working SSO
- Phase 3 cannot start until this task is complete and merged

### Integration Points to Verify
1. SSO Core correctly routes to Entra ID or Google services
2. Auth callbacks are handled by Electron deep links
3. JIT provisioning is called after successful SSO authentication
4. Audit logs capture all SSO events
5. SSO enforcement is checked before allowing standard login

### E2E Test Environment
- Need Entra ID test tenant with test user
- Need Google Workspace test domain with test user
- Test credentials should be in environment variables, not committed

## PR Preparation Checklist

- [ ] All Phase 2 tasks merged
- [ ] E2E tests passing
- [ ] Type check passes
- [ ] Lint check passes
- [ ] Manual testing complete

## Work Summary

### Branch Name
```
[FILL IN YOUR BRANCH NAME HERE]
```

### Changes Made
```
[LIST CHANGES]
```

### Testing Done
```
[DESCRIBE E2E TESTING]
```

### PR Link
```
[LINK TO PR]
```
