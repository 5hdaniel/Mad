# EUM-016: SCIM 2.0 Server

## Task Info
- **Task ID:** EUM-016
- **Phase:** 4 - Automated Provisioning
- **Dependencies:** EUM-015 (Phase 3 complete)
- **Can Start:** After Phase 3 merge
- **Parallel With:** EUM-017, EUM-018, EUM-019

## Goal

Create a SCIM 2.0 compliant server as Supabase Edge Functions to enable automatic user provisioning from identity providers.

## Background

SCIM (System for Cross-domain Identity Management) is the standard protocol used by Entra ID, Google Workspace, and other IdPs to automatically create, update, and delete users.

## Deliverables

1. SCIM 2.0 Users endpoints
2. Bearer token authentication
3. SCIM schema compliance
4. Error responses per spec
5. Provisioning/deprovisioning handlers

## SCIM Endpoints

```
Base URL: https://your-project.supabase.co/functions/v1/scim

GET    /ServiceProviderConfig     - SCIM capabilities
GET    /Schemas                   - Schema definitions
GET    /Users                     - List users (with filtering)
GET    /Users/:id                 - Get user
POST   /Users                     - Create user
PUT    /Users/:id                 - Replace user
PATCH  /Users/:id                 - Update user
DELETE /Users/:id                 - Deactivate user
```

## Technical Requirements

### 1. Create Supabase Edge Function

```typescript
// supabase/functions/scim/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

serve(async (req) => {
  const url = new URL(req.url);
  const path = url.pathname.replace('/scim/v2', '');

  // Authenticate request
  const authResult = await authenticateSCIMRequest(req);
  if (!authResult.success) {
    return scimError(401, 'Unauthorized');
  }

  const orgId = authResult.organizationId;

  // Route to appropriate handler
  if (path === '/ServiceProviderConfig') {
    return handleServiceProviderConfig();
  }
  if (path === '/Schemas') {
    return handleSchemas();
  }
  if (path.startsWith('/Users')) {
    return handleUsers(req, path, orgId);
  }

  return scimError(404, 'Not Found');
});
```

### 2. SCIM User Schema

```typescript
interface SCIMUser {
  schemas: ['urn:ietf:params:scim:schemas:core:2.0:User'];
  id: string;
  userName: string;
  name: {
    givenName: string;
    familyName: string;
  };
  emails: Array<{
    value: string;
    primary: boolean;
  }>;
  displayName: string;
  active: boolean;
  meta: {
    resourceType: 'User';
    created: string;
    lastModified: string;
  };
}
```

### 3. Token Authentication

```typescript
async function authenticateSCIMRequest(req: Request): Promise<{
  success: boolean;
  organizationId?: string;
}> {
  const authHeader = req.headers.get('Authorization');
  if (!authHeader?.startsWith('Bearer ')) {
    return { success: false };
  }

  const token = authHeader.slice(7);
  const tokenHash = await hashToken(token);

  // Look up token in database
  const { data } = await supabase
    .from('scim_tokens')
    .select('organization_id')
    .eq('token_hash', tokenHash)
    .is('revoked_at', null)
    .single();

  if (!data) {
    return { success: false };
  }

  // Update last_used_at
  await supabase
    .from('scim_tokens')
    .update({ last_used_at: new Date().toISOString(), use_count: supabase.sql`use_count + 1` })
    .eq('token_hash', tokenHash);

  return { success: true, organizationId: data.organization_id };
}
```

### 4. User Operations

```typescript
// POST /Users - Create user
async function createUser(scimUser: SCIMUser, orgId: string) {
  // Map SCIM user to our model
  const user = mapSCIMToUser(scimUser);

  // Create user in database
  const { data, error } = await supabase.from('users').insert(user).select().single();

  // Add to organization
  await supabase.from('organization_members').insert({
    organization_id: orgId,
    user_id: data.id,
    role: 'member',
    provisioned_by: 'scim',
  });

  // Audit log
  await logAuditEvent(orgId, 'scim.user_provisioned', data.id);

  return mapUserToSCIM(data);
}

// DELETE /Users/:id - Deactivate user
async function deleteUser(userId: string, orgId: string) {
  // Don't actually delete - set status to suspended
  await supabase
    .from('organization_members')
    .update({ status: 'suspended' })
    .eq('user_id', userId)
    .eq('organization_id', orgId);

  // Audit log
  await logAuditEvent(orgId, 'scim.user_deprovisioned', userId);
}
```

## SCIM Compliance Requirements

- Return proper `schemas` array in all responses
- Support `filter` query parameter (e.g., `userName eq "john@example.com"`)
- Return 409 Conflict for duplicate users
- Return proper error schema on failures
- Support pagination with `startIndex` and `count`

## Files to Create

- `supabase/functions/scim/index.ts`
- `supabase/functions/scim/handlers/users.ts`
- `supabase/functions/scim/handlers/schemas.ts`
- `supabase/functions/scim/utils/auth.ts`
- `supabase/functions/scim/utils/mapping.ts`

## Testing

Test with:
- Postman/Insomnia SCIM collection
- Entra ID SCIM provisioning test
- Google Workspace SCIM test

## PR Preparation Checklist

- [ ] All endpoints implemented
- [ ] Token auth working
- [ ] SCIM compliance verified
- [ ] Tested with Entra ID
- [ ] Tested with Google Workspace
- [ ] Audit logging in place

## Work Summary

### Branch Name
```
[FILL IN YOUR BRANCH NAME HERE]
```

### Changes Made
```
[LIST CHANGES]
```

### Testing Done
```
[DESCRIBE SCIM TESTING]
```

### PR Link
```
[LINK TO PR]
```
