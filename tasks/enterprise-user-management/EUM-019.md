# EUM-019: Directory Sync Service

## Task Info
- **Task ID:** EUM-019
- **Phase:** 4 - Automated Provisioning
- **Dependencies:** EUM-015 (Phase 3 complete)
- **Can Start:** After Phase 3 merge
- **Parallel With:** EUM-016, EUM-017, EUM-018

## Goal

Create a service for scheduled directory synchronization as an alternative/complement to real-time SCIM provisioning.

## Background

While SCIM provides real-time provisioning, some organizations prefer scheduled sync or need it as a fallback. This service periodically syncs users from the IdP.

## Deliverables

1. Directory sync service
2. Scheduled sync jobs
3. Incremental vs full sync
4. Conflict resolution
5. Orphan user detection

## Technical Requirements

### 1. Create Directory Sync Service

```typescript
// electron/services/directorySyncService.ts
export class DirectorySyncService {
  /**
   * Perform full sync with IdP
   */
  async fullSync(orgId: string): Promise<SyncResult> {
    // 1. Get all users from IdP
    // 2. Get all users in our system for this org
    // 3. Compare and sync
    // 4. Handle orphans
    // 5. Return results
  }

  /**
   * Perform incremental sync (changes since last sync)
   */
  async incrementalSync(orgId: string): Promise<SyncResult> {
    // 1. Get last sync timestamp
    // 2. Query IdP for changes since then
    // 3. Apply changes
    // 4. Update last sync timestamp
  }

  /**
   * Detect orphan users (in our system but not in IdP)
   */
  async detectOrphans(orgId: string): Promise<OrphanUser[]> {
    // Users who were provisioned via SCIM but no longer exist in IdP
  }

  /**
   * Handle orphan users based on org policy
   */
  async handleOrphans(
    orgId: string,
    orphans: OrphanUser[],
    policy: 'suspend' | 'delete' | 'notify'
  ): Promise<void> {
    // Apply policy to each orphan
  }

  /**
   * Resolve sync conflicts
   */
  async resolveConflict(
    localUser: User,
    idpUser: IdPUser,
    strategy: 'idp_wins' | 'local_wins' | 'newest_wins'
  ): Promise<User> {
    // Apply conflict resolution strategy
  }
}
```

### 2. Sync Configuration

```typescript
interface DirectorySyncConfig {
  organizationId: string;
  enabled: boolean;
  syncInterval: number;        // minutes
  syncType: 'full' | 'incremental';
  orphanPolicy: 'suspend' | 'delete' | 'notify';
  conflictResolution: 'idp_wins' | 'local_wins' | 'newest_wins';
  lastSyncAt: string | null;
  lastSyncStatus: 'success' | 'failed' | null;
}
```

### 3. Sync Result

```typescript
interface SyncResult {
  success: boolean;
  startedAt: string;
  completedAt: string;
  stats: {
    usersCreated: number;
    usersUpdated: number;
    usersDeactivated: number;
    orphansDetected: number;
    conflicts: number;
    errors: number;
  };
  errors: SyncError[];
}
```

### 4. Scheduled Sync (Optional)

```typescript
// Using node-cron or similar
import cron from 'node-cron';

export function setupDirectorySyncScheduler() {
  // Check every hour for orgs that need sync
  cron.schedule('0 * * * *', async () => {
    const orgsToSync = await getOrgsDueForSync();
    for (const org of orgsToSync) {
      await syncService.incrementalSync(org.id);
    }
  });
}
```

## Files to Create

- `electron/services/directorySyncService.ts`
- `electron/types/directorySync.ts`
- `electron/services/__tests__/directorySyncService.test.ts`

## Sync Flow

```
1. Check sync config for org
2. Connect to IdP (Entra ID or Google)
3. Fetch user list/changes
4. Compare with local users
5. Create/Update/Deactivate as needed
6. Detect and handle orphans
7. Log results
8. Update last sync timestamp
```

## PR Preparation Checklist

- [ ] Full sync works
- [ ] Incremental sync works
- [ ] Orphan detection works
- [ ] Conflict resolution works
- [ ] Audit logging in place
- [ ] Unit tests written
- [ ] Type check passes

## Work Summary

### Branch Name
```
[FILL IN YOUR BRANCH NAME HERE]
```

### Changes Made
```
[LIST CHANGES]
```

### Testing Done
```
[DESCRIBE TESTING]
```

### PR Link
```
[LINK TO PR]
```
