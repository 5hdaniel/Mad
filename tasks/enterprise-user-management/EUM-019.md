# EUM-019: Directory Sync Service

## Task Info
- **Task ID:** EUM-019
- **Phase:** 4 - Automated Provisioning
- **Dependencies:** EUM-015 (Phase 3 complete)
- **Can Start:** After Phase 3 merge
- **Parallel With:** EUM-016, EUM-017, EUM-018

## Goal

Create a service for scheduled directory synchronization as an alternative/complement to real-time SCIM provisioning.

## Background

While SCIM provides real-time provisioning, some organizations prefer scheduled sync or need it as a fallback. This service periodically syncs users from the IdP.

## Non-Goals

- ❌ Building scheduled job infrastructure (use existing patterns)
- ❌ Real-time sync (that's what SCIM is for)
- ❌ Group sync (users only)
- ❌ Cross-IdP sync (one IdP per org)
- ❌ User data modification (sync only updates membership)
- ❌ Orphan user deletion (suspend only)

## Deliverables

1. Directory sync service
2. Scheduled sync jobs
3. Incremental vs full sync
4. Conflict resolution
5. Orphan user detection

## Technical Requirements

### 1. Create Directory Sync Service

```typescript
// electron/services/directorySyncService.ts
export class DirectorySyncService {
  /**
   * Perform full sync with IdP
   */
  async fullSync(orgId: string): Promise<SyncResult> {
    // 1. Get all users from IdP
    // 2. Get all users in our system for this org
    // 3. Compare and sync
    // 4. Handle orphans
    // 5. Return results
  }

  /**
   * Perform incremental sync (changes since last sync)
   */
  async incrementalSync(orgId: string): Promise<SyncResult> {
    // 1. Get last sync timestamp
    // 2. Query IdP for changes since then
    // 3. Apply changes
    // 4. Update last sync timestamp
  }

  /**
   * Detect orphan users (in our system but not in IdP)
   */
  async detectOrphans(orgId: string): Promise<OrphanUser[]> {
    // Users who were provisioned via SCIM but no longer exist in IdP
  }

  /**
   * Handle orphan users based on org policy
   */
  async handleOrphans(
    orgId: string,
    orphans: OrphanUser[],
    policy: 'suspend' | 'delete' | 'notify'
  ): Promise<void> {
    // Apply policy to each orphan
  }

  /**
   * Resolve sync conflicts
   */
  async resolveConflict(
    localUser: User,
    idpUser: IdPUser,
    strategy: 'idp_wins' | 'local_wins' | 'newest_wins'
  ): Promise<User> {
    // Apply conflict resolution strategy
  }
}
```

### 2. Sync Configuration

```typescript
interface DirectorySyncConfig {
  organizationId: string;
  enabled: boolean;
  syncInterval: number;        // minutes
  syncType: 'full' | 'incremental';
  orphanPolicy: 'suspend' | 'delete' | 'notify';
  conflictResolution: 'idp_wins' | 'local_wins' | 'newest_wins';
  lastSyncAt: string | null;
  lastSyncStatus: 'success' | 'failed' | null;
}
```

### 3. Sync Result

```typescript
interface SyncResult {
  success: boolean;
  startedAt: string;
  completedAt: string;
  stats: {
    usersCreated: number;
    usersUpdated: number;
    usersDeactivated: number;
    orphansDetected: number;
    conflicts: number;
    errors: number;
  };
  errors: SyncError[];
}
```

### 4. Scheduled Sync (Optional)

```typescript
// Using node-cron or similar
import cron from 'node-cron';

export function setupDirectorySyncScheduler() {
  // Check every hour for orgs that need sync
  cron.schedule('0 * * * *', async () => {
    const orgsToSync = await getOrgsDueForSync();
    for (const org of orgsToSync) {
      await syncService.incrementalSync(org.id);
    }
  });
}
```

## Files to Create

- `electron/services/directorySyncService.ts`
- `electron/types/directorySync.ts`
- `electron/services/__tests__/directorySyncService.test.ts`

## Dos

- ✅ Log all sync operations to audit log
- ✅ Support incremental sync (changes since last sync)
- ✅ Handle IdP API errors gracefully
- ✅ Respect IdP API rate limits
- ✅ Track sync progress and status

## Don'ts

- ❌ Don't hard-delete orphaned users (suspend only)
- ❌ Don't sync during active SCIM provisioning
- ❌ Don't ignore IdP API errors silently
- ❌ Don't run sync too frequently (rate limits)

## Acceptance Criteria

- [ ] `fullSync()` fetches all users from IdP and reconciles
- [ ] `incrementalSync()` fetches only changes since last sync
- [ ] `detectOrphans()` identifies users no longer in IdP
- [ ] `handleOrphans()` applies org's orphan policy
- [ ] `resolveConflict()` handles data conflicts per strategy
- [ ] Sync results include accurate statistics
- [ ] All sync operations logged to audit log
- [ ] Sync respects IdP API rate limits
- [ ] Unit tests cover main sync scenarios

## When to Stop and Ask

You MUST stop and ask the PM if:

1. **IdP API access** - If Graph API or Google Admin SDK access is needed
2. **Sync scheduling** - If scheduler implementation pattern is unclear
3. **Conflict resolution** - If default resolution strategy needs specification
4. **Orphan policies** - If orphan handling needs more options
5. **Rate limiting** - If IdP rate limits affect sync design
6. **Delta queries** - If IdP doesn't support delta/incremental queries

Do NOT guess or make assumptions. Ask first.

## Integration Notes

### Dependencies
- **EUM-002**: Uses Organization Service for member management
- **EUM-003**: Uses Audit Service for sync event logging
- **EUM-006**: May use Entra ID service for Graph API access
- **EUM-007**: May use Google service for Admin SDK access

### For EUM-016 (SCIM Server)
- Directory sync is alternative to SCIM
- Can run alongside SCIM for reconciliation

### For EUM-020 (Final Integration)
- Sync configuration added to admin settings
- Sync history visible in provisioning dashboard

### Conflict Resolution Strategies
- `idp_wins`: IdP data overwrites local data
- `local_wins`: Keep local data, ignore IdP
- `newest_wins`: Use most recently modified data

## Sync Flow

```
1. Check sync config for org
2. Connect to IdP (Entra ID or Google)
3. Fetch user list/changes
4. Compare with local users
5. Create/Update/Deactivate as needed
6. Detect and handle orphans
7. Log results
8. Update last sync timestamp
```

## PR Preparation Checklist

- [ ] Full sync works
- [ ] Incremental sync works
- [ ] Orphan detection works
- [ ] Conflict resolution works
- [ ] Audit logging in place
- [ ] Unit tests written
- [ ] Type check passes

## Work Summary

### Branch Name
```
[FILL IN YOUR BRANCH NAME HERE]
```

### Changes Made
```
[LIST CHANGES]
```

### Testing Done
```
[DESCRIBE TESTING]
```

### PR Link
```
[LINK TO PR]
```
