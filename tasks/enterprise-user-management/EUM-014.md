# EUM-014: Audit Logs Viewer

## Task Info
- **Task ID:** EUM-014
- **Phase:** 3 - Admin Portal
- **Dependencies:** EUM-010 (Phase 2 complete)
- **Can Start:** After Phase 2 merge
- **Parallel With:** EUM-011, EUM-012, EUM-013

## Goal

Create a searchable, filterable audit log viewer with export functionality.

## Non-Goals

- ‚ùå Implementing audit service (handled in Phase 1)
- ‚ùå Real-time log streaming
- ‚ùå Audit log alerting or notifications
- ‚ùå Log retention policy UI
- ‚ùå Cross-organization log viewing
- ‚ùå Log modification or deletion

## Deliverables

1. Audit logs list with pagination
2. Filter by date range
3. Filter by action type
4. Filter by actor
5. Search functionality
6. Export to CSV
7. Log detail expansion

## Component Structure

```
src/components/admin/
‚îú‚îÄ‚îÄ AuditLogs.tsx                 # Main container
‚îú‚îÄ‚îÄ AuditLogFilters.tsx           # Filter controls
‚îú‚îÄ‚îÄ AuditLogList.tsx              # Log entries list
‚îú‚îÄ‚îÄ AuditLogEntry.tsx             # Individual log row
‚îú‚îÄ‚îÄ AuditLogDetail.tsx            # Expanded detail view
‚îî‚îÄ‚îÄ AuditLogExport.tsx            # Export button/modal
```

## Key Features

1. **Log Display**
   - Timestamp (relative + absolute on hover)
   - Action type with icon
   - Actor name/email
   - Resource affected
   - Expandable details

2. **Filters**
   - Date range picker
   - Action type dropdown (multi-select)
   - Actor search
   - Resource type filter

3. **Export**
   - CSV download
   - Date range selection for export
   - All columns included

## Example Component

```tsx
// src/components/admin/AuditLogs.tsx
export function AuditLogs() {
  const { orgId } = useParams<{ orgId: string }>();
  const [logs, setLogs] = useState<PaginatedAuditLogs | null>(null);
  const [filters, setFilters] = useState<AuditLogFilters>({});
  const [page, setPage] = useState(1);

  useEffect(() => {
    loadLogs();
  }, [orgId, filters, page]);

  const loadLogs = async () => {
    const result = await window.api.audit.getLogs(orgId!, filters, { page, pageSize: 50 });
    if (result.success) {
      setLogs(result.data);
    }
  };

  const handleExport = async () => {
    const result = await window.api.audit.export(orgId!, filters);
    if (result.success) {
      downloadCSV(result.data, `audit-logs-${Date.now()}.csv`);
    }
  };

  return (
    <div className="space-y-4">
      <div className="flex justify-between items-center">
        <h2 className="text-xl font-semibold">Audit Logs</h2>
        <Button onClick={handleExport}>Export CSV</Button>
      </div>

      <AuditLogFilters filters={filters} onChange={setFilters} />

      <AuditLogList logs={logs?.logs || []} />

      <Pagination
        page={page}
        totalPages={logs?.totalPages || 1}
        onChange={setPage}
      />
    </div>
  );
}
```

## Action Type Icons

```tsx
const ACTION_ICONS = {
  'user.invited': 'üì®',
  'user.removed': 'üö™',
  'user.role_changed': 'üëë',
  'sso.configured': 'üîê',
  'sso.enabled': '‚úÖ',
  'scim.user_provisioned': 'üîÑ',
  // etc.
};
```

## Files to Create

- `src/components/admin/AuditLogs.tsx`
- `src/components/admin/AuditLogFilters.tsx`
- `src/components/admin/AuditLogList.tsx`
- `src/components/admin/AuditLogEntry.tsx`
- `src/components/admin/AuditLogDetail.tsx`
- `src/components/admin/__tests__/AuditLogs.test.tsx`

## Dos

- ‚úÖ Show relative timestamps with absolute on hover
- ‚úÖ Make action types easily scannable with icons
- ‚úÖ Allow multi-select for action type filter
- ‚úÖ Export includes all filter criteria
- ‚úÖ Handle large date ranges gracefully

## Don'ts

- ‚ùå Don't load all logs at once (use pagination)
- ‚ùå Don't show logs from other organizations
- ‚ùå Don't allow log modification
- ‚ùå Don't expose internal IDs without context

## Acceptance Criteria

- [ ] Audit logs list loads with pagination
- [ ] Date range picker filters logs correctly
- [ ] Action type filter supports multi-select
- [ ] Actor search filters by name/email
- [ ] Resource type filter works
- [ ] Log entries show timestamp, action, actor, resource
- [ ] Expandable detail shows full log metadata
- [ ] CSV export downloads with applied filters
- [ ] Empty state shows when no logs match filters
- [ ] Loading state appears during queries
- [ ] Unit tests cover filtering and export

## When to Stop and Ask

You MUST stop and ask the PM if:

1. **Large dataset performance** - If pagination or virtual scrolling is needed
2. **Action type icons** - If icon mapping is incomplete
3. **Export size limits** - If export needs size limits or background processing
4. **Date range limits** - If default date range needs specification
5. **Detail view fields** - If log detail display needs additional fields
6. **Search scope** - If full-text search is needed beyond filters

Do NOT guess or make assumptions. Ask first.

## Integration Notes

### Dependencies
- **EUM-003**: Uses Audit Service for log retrieval and export
- **EUM-004**: Uses RBAC Service for access control (audit.view, audit.export)

### For EUM-015 (Integration Task)
- Component must work within AdminLayout
- Must respond to route params (`orgId`)
- Filters should be preserved on navigation

### Action Type Categories
Group action types in filter dropdown:
- User actions (invited, removed, role_changed, etc.)
- SSO actions (configured, enabled, enforced, etc.)
- SCIM actions (provisioned, deprovisioned, etc.)
- Organization actions (created, updated, etc.)

## PR Preparation Checklist

- [ ] Log list displays correctly
- [ ] All filters work
- [ ] Pagination works
- [ ] Export works
- [ ] Detail expansion works
- [ ] Unit tests written
- [ ] Type check passes

## Work Summary

### Branch Name
```
[FILL IN YOUR BRANCH NAME HERE]
```

### Changes Made
```
[LIST CHANGES]
```

### Testing Done
```
[DESCRIBE TESTING]
```

### PR Link
```
[LINK TO PR]
```
