# EUM-017: SCIM Token Management UI

## Task Info
- **Task ID:** EUM-017
- **Phase:** 4 - Automated Provisioning
- **Dependencies:** EUM-015 (Phase 3 complete)
- **Can Start:** After Phase 3 merge
- **Parallel With:** EUM-016, EUM-018, EUM-019

## Goal

Create UI for generating, viewing, and revoking SCIM tokens for automated provisioning.

## Non-Goals

- ❌ Implementing SCIM server (handled in EUM-016)
- ❌ Token rotation automation
- ❌ Multiple token types or scopes
- ❌ Token expiration policies UI
- ❌ API key management beyond SCIM
- ❌ Token usage analytics

## Deliverables

1. SCIM settings page
2. Token generation UI (show token once)
3. Token list with metadata
4. Revoke token functionality
5. Setup instructions for IdPs

## Component Structure

```
src/components/admin/scim/
├── SCIMSettings.tsx              # Main container
├── SCIMTokenList.tsx             # List of tokens
├── GenerateTokenModal.tsx        # Generate new token
├── TokenDisplay.tsx              # Show token once
├── SetupInstructions.tsx         # IdP setup guides
└── SCIMEndpointInfo.tsx          # Endpoint URL display
```

## Key Features

1. **Generate Token**
   - Name/description for token
   - Show token ONCE after generation
   - Copy to clipboard button
   - Warning about saving token

2. **Token List**
   - Token name
   - Token prefix (first 8 chars)
   - Created date
   - Last used date
   - Use count
   - Revoke button

3. **Setup Instructions**
   - Entra ID setup steps
   - Google Workspace setup steps
   - Endpoint URL to copy

## Example Component

```tsx
// src/components/admin/scim/SCIMSettings.tsx
export function SCIMSettings() {
  const { orgId } = useParams();
  const [tokens, setTokens] = useState<SCIMToken[]>([]);
  const [showGenerateModal, setShowGenerateModal] = useState(false);
  const [newToken, setNewToken] = useState<string | null>(null);

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-xl font-semibold">SCIM Provisioning</h2>
        <Button onClick={() => setShowGenerateModal(true)}>
          Generate Token
        </Button>
      </div>

      <SCIMEndpointInfo orgId={orgId} />

      <SCIMTokenList
        tokens={tokens}
        onRevoke={handleRevoke}
      />

      <SetupInstructions />

      <GenerateTokenModal
        open={showGenerateModal}
        onClose={() => setShowGenerateModal(false)}
        onGenerated={(token) => {
          setNewToken(token);
          loadTokens();
        }}
      />

      {newToken && (
        <TokenDisplay
          token={newToken}
          onClose={() => setNewToken(null)}
        />
      )}
    </div>
  );
}
```

## IPC Handlers Needed

```typescript
ipcMain.handle('scim:generate-token', async (_, orgId, name, createdBy) => { ... });
ipcMain.handle('scim:list-tokens', async (_, orgId) => { ... });
ipcMain.handle('scim:revoke-token', async (_, tokenId, revokedBy) => { ... });
ipcMain.handle('scim:get-endpoint-url', async (_, orgId) => { ... });
```

## Files to Create

- `src/components/admin/scim/SCIMSettings.tsx`
- `src/components/admin/scim/SCIMTokenList.tsx`
- `src/components/admin/scim/GenerateTokenModal.tsx`
- `src/components/admin/scim/TokenDisplay.tsx`
- `src/components/admin/scim/SetupInstructions.tsx`
- `electron/services/scimTokenService.ts`
- `electron/handlers/scimHandlers.ts`

## Dos

- ✅ Show generated token ONLY ONCE with strong warning
- ✅ Provide copy-to-clipboard functionality
- ✅ Show token prefix for identification
- ✅ Display last used time for monitoring
- ✅ Require confirmation for revocation

## Don'ts

- ❌ Don't store full token in browser
- ❌ Don't allow token retrieval after initial display
- ❌ Don't allow multiple active tokens without clear identification
- ❌ Don't skip revocation confirmation

## Acceptance Criteria

- [ ] Generate token modal collects name/description
- [ ] Generated token shown once with copy button
- [ ] Warning displayed about saving token securely
- [ ] Token list shows name, prefix, created date, last used
- [ ] Revoke token works with confirmation
- [ ] SCIM endpoint URL displayed and copyable
- [ ] Setup instructions for Entra ID included
- [ ] Setup instructions for Google Workspace included
- [ ] All token operations logged to audit log
- [ ] Unit tests cover main interactions

## When to Stop and Ask

You MUST stop and ask the PM if:

1. **Token display security** - If one-time display pattern is unclear
2. **Token naming convention** - If token naming needs standardization
3. **Setup instructions** - If IdP setup steps need verification
4. **Multiple tokens** - If limit on active tokens is needed
5. **Token expiration** - If automatic expiration is needed
6. **Revocation impact** - If active SCIM syncs need special handling on revoke

Do NOT guess or make assumptions. Ask first.

## Integration Notes

### Dependencies
- **EUM-001**: Uses `scim_tokens` table for storage
- **EUM-003**: Uses Audit Service for token events
- **EUM-004**: Uses RBAC (scim.manage_tokens permission)

### For EUM-016 (SCIM Server)
- Token hash is used for authentication
- Token prefix allows users to identify tokens
- Use count and last used time for monitoring

### For EUM-020 (Final Integration)
- SCIM settings added to admin navigation
- Token generation must work before SCIM testing

### Token Generation Flow
1. User clicks "Generate Token"
2. Enter name/description
3. Backend generates random token (32+ bytes)
4. Store hash, return plain token
5. Display token ONCE with copy button
6. User copies token to IdP configuration

## PR Preparation Checklist

- [ ] Token generation works
- [ ] Token shown only once
- [ ] Revoke works
- [ ] Setup instructions included
- [ ] Unit tests written
- [ ] Type check passes

## Work Summary

### Branch Name
```
[FILL IN YOUR BRANCH NAME HERE]
```

### Changes Made
```
[LIST CHANGES]
```

### Testing Done
```
[DESCRIBE TESTING]
```

### PR Link
```
[LINK TO PR]
```
