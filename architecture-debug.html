<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Magic Audit - Architecture Debugger (SYNC focus)</title>
  <style>
    :root {
      --bg-dark: #0d1117;
      --bg-card: #161b22;
      --bg-hover: #21262d;
      --border: #30363d;
      --border-active: #58a6ff;
      --text-primary: #e6edf3;
      --text-secondary: #8b949e;
      --text-muted: #484f58;
      --blue: #58a6ff;
      --green: #3fb950;
      --purple: #a371f7;
      --orange: #d29922;
      --red: #f85149;
      --cyan: #39c5cf;
      --pink: #db61a2;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
    }
    .sidebar {
      width: 320px;
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      padding: 20px;
      overflow-y: auto;
      flex-shrink: 0;
    }
    .sidebar h1 { font-size: 1.1rem; margin-bottom: 5px; color: var(--blue); }
    .sidebar .subtitle { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 20px; }
    .chain-info { margin-top: 20px; }
    .chain-info h3 { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); margin-bottom: 10px; }
    .chain-step {
      background: var(--bg-hover);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 8px;
      font-size: 0.8rem;
    }
    .chain-step.active { border-color: var(--blue); background: rgba(88, 166, 255, 0.1); }
    .chain-step .step-layer { font-size: 0.65rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px; }
    .chain-step .step-name { font-weight: 600; color: var(--text-primary); }
    .chain-step .step-file { font-size: 0.7rem; color: var(--cyan); font-family: 'SF Mono', Monaco, monospace; margin-top: 4px; word-break: break-all; }
    .chain-step .step-desc { font-size: 0.7rem; color: var(--text-secondary); margin-top: 4px; }
    .chain-arrow { text-align: center; color: var(--text-muted); font-size: 0.8rem; margin: 4px 0; }
    .no-selection { color: var(--text-secondary); font-size: 0.85rem; text-align: center; padding: 40px 20px; }
    .legend { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border); }
    .legend h4 { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px; }
    .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 6px; }
    .legend-dot { width: 12px; height: 12px; border-radius: 3px; }
    .main { flex: 1; padding: 30px; overflow: auto; }
    .layers { display: flex; flex-direction: column; gap: 20px; max-width: 1400px; margin: 0 auto; }
    .layer { display: flex; align-items: flex-start; gap: 20px; }
    .layer-label { width: 120px; flex-shrink: 0; text-align: right; padding-top: 12px; }
    .layer-label .label-name { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    .layer-label .label-desc { font-size: 0.65rem; color: var(--text-muted); margin-top: 2px; }
    .layer-content { flex: 1; display: flex; flex-wrap: wrap; gap: 10px; }
    .node {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 140px;
    }
    .node:hover { border-color: var(--text-secondary); transform: translateY(-2px); }
    .node.highlighted { border-color: var(--blue); background: rgba(88, 166, 255, 0.15); box-shadow: 0 0 20px rgba(88, 166, 255, 0.3); z-index: 10; }
    .node.dimmed { opacity: 0.3; }
    .node.selected { border-color: var(--green); background: rgba(63, 185, 80, 0.15); box-shadow: 0 0 20px rgba(63, 185, 80, 0.3); }
    .node .node-name { font-weight: 600; font-size: 0.85rem; margin-bottom: 4px; }
    .node .node-type { font-size: 0.65rem; color: var(--text-muted); font-family: 'SF Mono', Monaco, monospace; }
    .layer.components .layer-label .label-name { color: var(--green); }
    .layer.components .node { border-left: 3px solid var(--green); }
    .layer.hooks .layer-label .label-name { color: var(--cyan); }
    .layer.hooks .node { border-left: 3px solid var(--cyan); }
    .layer.services .layer-label .label-name { color: var(--purple); }
    .layer.services .node { border-left: 3px solid var(--purple); }
    .layer.ipc .layer-label .label-name { color: var(--orange); }
    .layer.ipc .node { border-left: 3px solid var(--orange); }
    .layer.handlers .layer-label .label-name { color: var(--pink); }
    .layer.handlers .node { border-left: 3px solid var(--pink); }
    .layer.backend .layer-label .label-name { color: var(--blue); }
    .layer.backend .node { border-left: 3px solid var(--blue); }
    .layer.storage .layer-label .label-name { color: var(--red); }
    .layer.storage .node { border-left: 3px solid var(--red); }
    .reset-btn {
      background: var(--bg-hover);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .reset-btn:hover { border-color: var(--text-secondary); color: var(--text-primary); }
    .instructions {
      background: var(--bg-hover);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 15px 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .instructions-icon { font-size: 1.5rem; }
    .instructions-text { font-size: 0.85rem; color: var(--text-secondary); }
    .instructions-text strong { color: var(--text-primary); }
    .generated-info { font-size: 0.7rem; color: var(--text-muted); margin-top: 15px; text-align: center; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <h1>Architecture Debugger</h1>
    <p class="subtitle">Click any component to trace its connections (SYNC focus)</p>
    <button class="reset-btn" onclick="resetSelection()">Reset View</button>
    <div class="chain-info" id="chainInfo">
      <div class="no-selection">Click on any component to see its full connection chain.</div>
    </div>
    <div class="legend">
      <h4>Layers</h4>
      <div class="legend-item"><div class="legend-dot" style="background: var(--green);"></div><span>React Components</span></div>
      <div class="legend-item"><div class="legend-dot" style="background: var(--cyan);"></div><span>Custom Hooks</span></div>
      <div class="legend-item"><div class="legend-dot" style="background: var(--purple);"></div><span>Frontend Services</span></div>
      <div class="legend-item"><div class="legend-dot" style="background: var(--orange);"></div><span>IPC Bridges</span></div>
      <div class="legend-item"><div class="legend-dot" style="background: var(--pink);"></div><span>Main Process Handlers</span></div>
      <div class="legend-item"><div class="legend-dot" style="background: var(--blue);"></div><span>Backend Services</span></div>
      <div class="legend-item"><div class="legend-dot" style="background: var(--red);"></div><span>Storage / External APIs</span></div>
    </div>
    <div class="generated-info">Auto-generated by /architecture skill</div>
  </aside>

  <main class="main">
    <div class="instructions">
      <span class="instructions-icon">üîç</span>
      <div class="instructions-text">
        <strong>Debug Mode:</strong> Click any node to trace the data flow from UI to database/API.
      </div>
    </div>
    <div class="layers" id="layers">

      <div class="layer components">
        <div class="layer-label">
          <div class="label-name">Components</div>
          <div class="label-desc">React UI</div>
        </div>
        <div class="layer-content">
          <div class="node" data-id="SyncStatusIndicator" onclick="selectNode('SyncStatusIndicator')">
            <div class="node-name">SyncStatusIndicator</div>
            <div class="node-type">SyncStatusIndicator.tsx</div>
          </div>
        </div>
      </div>

      <div class="layer hooks">
        <div class="layer-label">
          <div class="label-name">Hooks</div>
          <div class="label-desc">State & Logic</div>
        </div>
        <div class="layer-content">
          <div class="node" data-id="useSyncQueue" onclick="selectNode('useSyncQueue')">
            <div class="node-name">useSyncQueue</div>
            <div class="node-type">useSyncQueue.ts</div>
          </div>
          <div class="node" data-id="useAutoRefresh" onclick="selectNode('useAutoRefresh')">
            <div class="node-name">useAutoRefresh</div>
            <div class="node-type">useAutoRefresh.ts</div>
          </div>
          <div class="node" data-id="useIPhoneSync" onclick="selectNode('useIPhoneSync')">
            <div class="node-name">useIPhoneSync</div>
            <div class="node-type">useIPhoneSync.ts</div>
          </div>
        </div>
      </div>

      <div class="layer services">
        <div class="layer-label">
          <div class="label-name">Services</div>
          <div class="label-desc">Frontend</div>
        </div>
        <div class="layer-content">
          <div class="node" data-id="SyncQueueService" onclick="selectNode('SyncQueueService')">
            <div class="node-name">SyncQueueService</div>
            <div class="node-type">SyncQueueService.ts</div>
          </div>
          <div class="node" data-id="deviceService" onclick="selectNode('deviceService')">
            <div class="node-name">deviceService</div>
            <div class="node-type">deviceService.ts</div>
          </div>
        </div>
      </div>

      <div class="layer ipc">
        <div class="layer-label">
          <div class="label-name">IPC Bridge</div>
          <div class="label-desc">window.api.*</div>
        </div>
        <div class="layer-content">
          <div class="node" data-id="syncBridge" onclick="selectNode('syncBridge')">
            <div class="node-name">syncBridge</div>
            <div class="node-type">preload.ts ‚Üí syncBridge</div>
          </div>
          <div class="node" data-id="deviceBridge" onclick="selectNode('deviceBridge')">
            <div class="node-name">deviceBridge</div>
            <div class="node-type">preload.ts ‚Üí deviceBridge</div>
          </div>
        </div>
      </div>

      <div class="layer handlers">
        <div class="layer-label">
          <div class="label-name">Handlers</div>
          <div class="label-desc">Main Process</div>
        </div>
        <div class="layer-content">
          <div class="node" data-id="syncHandlers" onclick="selectNode('syncHandlers')">
            <div class="node-name">sync-handlers</div>
            <div class="node-type">sync-handlers.ts</div>
          </div>
          <div class="node" data-id="deviceHandlers" onclick="selectNode('deviceHandlers')">
            <div class="node-name">device-handlers</div>
            <div class="node-type">device-handlers.ts</div>
          </div>
        </div>
      </div>

      <div class="layer backend">
        <div class="layer-label">
          <div class="label-name">Backend</div>
          <div class="label-desc">Electron Services</div>
        </div>
        <div class="layer-content">
          <div class="node" data-id="syncOrchestrator" onclick="selectNode('syncOrchestrator')">
            <div class="node-name">syncOrchestrator</div>
            <div class="node-type">syncOrchestrator.ts</div>
          </div>
          <div class="node" data-id="deviceDetectionService" onclick="selectNode('deviceDetectionService')">
            <div class="node-name">deviceDetectionService</div>
            <div class="node-type">deviceDetectionService.ts</div>
          </div>
          <div class="node" data-id="iPhoneSyncStorage" onclick="selectNode('iPhoneSyncStorage')">
            <div class="node-name">iPhoneSyncStorage</div>
            <div class="node-type">iPhoneSyncStorageService.ts</div>
          </div>
        </div>
      </div>

      <div class="layer storage">
        <div class="layer-label">
          <div class="label-name">Storage</div>
          <div class="label-desc">Data & APIs</div>
        </div>
        <div class="layer-content">
          <div class="node" data-id="supabase" onclick="selectNode('supabase')">
            <div class="node-name">Supabase</div>
            <div class="node-type">Cloud database</div>
          </div>
          <div class="node" data-id="libimobiledevice" onclick="selectNode('libimobiledevice')">
            <div class="node-name">libimobiledevice</div>
            <div class="node-type">Native library</div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <script>
    const architecture = {
  "SyncStatusIndicator": {
    "layer": "components",
    "file": "src/components/dashboard/SyncStatusIndicator.tsx",
    "desc": "Shows sync progress for contacts, emails, messages",
    "connects": [
      "useSyncQueue"
    ]
  },
  "useSyncQueue": {
    "layer": "hooks",
    "file": "src/hooks/useSyncQueue.ts",
    "desc": "React hook for SyncQueueService subscription",
    "connects": [
      "SyncQueueService"
    ]
  },
  "useAutoRefresh": {
    "layer": "hooks",
    "file": "src/hooks/useAutoRefresh.ts",
    "desc": "Triggers sync operations on dashboard open",
    "connects": [
      "SyncQueueService"
    ]
  },
  "useIPhoneSync": {
    "layer": "hooks",
    "file": "src/hooks/useIPhoneSync.ts",
    "desc": "Manages iPhone device detection and sync",
    "connects": [
      "syncBridge"
    ]
  },
  "SyncQueueService": {
    "layer": "services",
    "file": "src/services/SyncQueueService.ts",
    "desc": "Singleton tracking sync state with completion detection",
    "connects": []
  },
  "deviceService": {
    "layer": "services",
    "file": "src/services/deviceService.ts",
    "desc": "Device detection and iPhone sync",
    "connects": [
      "deviceBridge"
    ]
  },
  "syncBridge": {
    "layer": "ipc",
    "file": "electron/preload.ts \u2192 syncBridge",
    "desc": "window.api.sync.* - iPhone sync operations",
    "connects": [
      "syncHandlers"
    ]
  },
  "deviceBridge": {
    "layer": "ipc",
    "file": "electron/preload.ts \u2192 deviceBridge",
    "desc": "window.api.device.* - Device detection",
    "connects": [
      "deviceHandlers"
    ]
  },
  "syncHandlers": {
    "layer": "handlers",
    "file": "electron/sync-handlers.ts",
    "desc": "Handles sync:start, sync:cancel, sync:getStatus",
    "connects": [
      "syncOrchestrator",
      "deviceDetectionService"
    ]
  },
  "deviceHandlers": {
    "layer": "handlers",
    "file": "electron/device-handlers.ts",
    "desc": "Handles device detection",
    "connects": [
      "deviceDetectionService"
    ]
  },
  "syncOrchestrator": {
    "layer": "backend",
    "file": "electron/services/syncOrchestrator.ts",
    "desc": "Orchestrates full iPhone sync pipeline",
    "connects": [
      "deviceDetectionService",
      "iPhoneSyncStorage"
    ]
  },
  "deviceDetectionService": {
    "layer": "backend",
    "file": "electron/services/deviceDetectionService.ts",
    "desc": "Detects connected iPhones via libimobiledevice",
    "connects": [
      "libimobiledevice"
    ]
  },
  "iPhoneSyncStorage": {
    "layer": "backend",
    "file": "electron/services/iPhoneSyncStorageService.ts",
    "desc": "Persists sync results to local database",
    "connects": []
  },
  "supabase": {
    "layer": "storage",
    "file": "Cloud database",
    "desc": "User profiles, devices, API quotas. RLS enforced.",
    "connects": []
  },
  "libimobiledevice": {
    "layer": "storage",
    "file": "Native library",
    "desc": "iPhone communication via USB",
    "connects": []
  }
};

    let selectedNode = null;
    let highlightedNodes = new Set();

    function selectNode(nodeId) {
      selectedNode = nodeId;
      highlightedNodes.clear();
      const chain = buildChain(nodeId);
      highlightedNodes = new Set(chain.map(step => step.id));
      updateNodeStyles();
      updateChainInfo(chain);
    }

    function buildChain(startId) {
      const chain = [];
      const visited = new Set();
      const layerOrder = ['components', 'hooks', 'services', 'ipc', 'handlers', 'backend', 'storage'];

      function traverseForward(id, depth = 0) {
        if (visited.has(id) || !architecture[id]) return;
        visited.add(id);
        const node = architecture[id];
        chain.push({ id, ...node, direction: depth === 0 ? 'origin' : 'downstream' });
        for (const connId of node.connects || []) {
          traverseForward(connId, depth + 1);
        }
      }

      function findUpstream(targetId) {
        const upstream = [];
        for (const [id, node] of Object.entries(architecture)) {
          if (node.connects && node.connects.includes(targetId)) {
            upstream.push(id);
          }
        }
        return upstream;
      }

      function traverseBackward(id) {
        const upstreamIds = findUpstream(id);
        for (const upId of upstreamIds) {
          if (!visited.has(upId) && architecture[upId]) {
            visited.add(upId);
            const node = architecture[upId];
            chain.unshift({ id: upId, ...node, direction: 'upstream' });
            traverseBackward(upId);
          }
        }
      }

      traverseForward(startId);
      traverseBackward(startId);
      chain.sort((a, b) => layerOrder.indexOf(a.layer) - layerOrder.indexOf(b.layer));
      return chain;
    }

    function updateNodeStyles() {
      document.querySelectorAll('.node').forEach(node => {
        const nodeId = node.dataset.id;
        node.classList.remove('highlighted', 'selected', 'dimmed');
        if (selectedNode) {
          if (nodeId === selectedNode) {
            node.classList.add('selected');
          } else if (highlightedNodes.has(nodeId)) {
            node.classList.add('highlighted');
          } else {
            node.classList.add('dimmed');
          }
        }
      });
    }

    function updateChainInfo(chain) {
      const container = document.getElementById('chainInfo');
      if (chain.length === 0) {
        container.innerHTML = '<div class="no-selection">Click on any component to see its full connection chain.</div>';
        return;
      }
      let html = '<h3>Connection Chain</h3>';
      chain.forEach((step, index) => {
        const isOrigin = step.direction === 'origin';
        html += `
          <div class="chain-step ${isOrigin ? 'active' : ''}">
            <div class="step-layer">${step.layer}</div>
            <div class="step-name">${step.id}</div>
            <div class="step-file">${step.file}</div>
            <div class="step-desc">${step.desc}</div>
          </div>
        `;
        if (index < chain.length - 1) {
          html += '<div class="chain-arrow">‚Üì</div>';
        }
      });
      container.innerHTML = html;
    }

    function resetSelection() {
      selectedNode = null;
      highlightedNodes.clear();
      updateNodeStyles();
      document.getElementById('chainInfo').innerHTML =
        '<div class="no-selection">Click on any component to see its full connection chain.</div>';
    }
  </script>
</body>
</html>
