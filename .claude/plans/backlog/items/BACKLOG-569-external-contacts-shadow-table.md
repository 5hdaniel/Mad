# BACKLOG-569: External Contacts Shadow Table

## Status
- **Priority**: High
- **Status**: Ready
- **Category**: Architecture / Performance
- **Created**: 2026-01-30
- **Related Sprint**: SPRINT-066 (Phase 6)
- **Related**: BACKLOG-567 (contact sorting), TASK-1772 (phone_last_message lookup)

## Problem Statement

External contacts from macOS Contacts app are currently read fresh from the system every time the contact selection screen loads. This causes:

1. **No persistence** - External contact metadata (like `last_message_at`) must be recomputed every load
2. **Performance overhead** - Reading 1000+ contacts from macOS Contacts API every time
3. **Architectural complexity** - Two separate code paths for imported vs external contacts

## Current Architecture

```
macOS Contacts App (1101 records)
         |
         v (fresh read every load)
Contact Selection Screen
         |
         v (lookup per phone)
phone_last_message table (TASK-1772)
         |
         v
Sorted external contacts
```

**Issues:**
- External contacts have no persistent representation in our database
- `last_message_at` for external contacts requires cross-referencing `phone_last_message` table
- Syncing/caching behavior is ad-hoc

## Proposed Solution

Create an `external_contacts` shadow table that mirrors macOS Contacts app data with pre-computed sorting metadata.

### Proposed Schema

```sql
CREATE TABLE external_contacts (
  id TEXT PRIMARY KEY,                    -- UUID generated by us
  user_id TEXT NOT NULL,

  -- Contact data (mirrored from macOS)
  name TEXT,
  phones TEXT,                            -- JSON array of phone numbers
  emails TEXT,                            -- JSON array of email addresses
  company TEXT,

  -- Sorting metadata (pre-computed)
  last_message_at DATETIME,               -- Copied from phone_last_message or computed

  -- Sync tracking
  macos_record_id TEXT,                   -- AddressBook record ID for sync
  synced_at DATETIME,                     -- When last synced from macOS

  FOREIGN KEY (user_id) REFERENCES users_local(id) ON DELETE CASCADE,
  UNIQUE(user_id, macos_record_id)
);

CREATE INDEX idx_external_contacts_user ON external_contacts(user_id);
CREATE INDEX idx_external_contacts_last_msg ON external_contacts(user_id, last_message_at DESC);
```

### Benefits

1. **Single query for sorted external contacts** - No cross-table lookups needed
2. **Faster loading** - Read from local SQLite instead of macOS API every time
3. **Pre-computed sorting** - `last_message_at` stored directly on records
4. **Sync control** - Can refresh from macOS on demand (background job)

### Sync Strategy

1. **Initial Population**: On first load (or table empty), read all macOS contacts and insert
2. **Background Refresh**: Periodically sync changes from macOS (detect adds/updates/deletes)
3. **Message Import Hook**: After message import, update `last_message_at` for affected phones
4. **On-Demand Refresh**: User can trigger manual sync if needed

## Impact on TASK-1772 (phone_last_message)

**Decision: Keep `phone_last_message` table**

The `phone_last_message` table serves as a general-purpose lookup for message dates by phone number. It can:
- Feed `last_message_at` into `external_contacts` during sync
- Continue to serve other use cases (future features)
- Be deprecated later if shadow table fully replaces its use

## Files to Create/Modify

| File | Action | Notes |
|------|--------|-------|
| `electron/services/databaseService.ts` | MODIFY | Add migration for `external_contacts` table |
| `electron/services/db/externalContactDbService.ts` | CREATE | CRUD operations for external contacts |
| `electron/contact-handlers.ts` | MODIFY | Use shadow table instead of fresh macOS reads |
| `electron/handlers/messageImportHandlers.ts` | MODIFY | Update shadow table after message import |
| `src/services/contactService.ts` | MODIFY | Add sync trigger and external contact methods |

## Acceptance Criteria

- [ ] `external_contacts` table created via migration
- [ ] Initial population from macOS Contacts works
- [ ] Contact selection reads from shadow table (not fresh macOS reads)
- [ ] Contacts sorted by `last_message_at` (pre-computed)
- [ ] Message import updates `last_message_at` on affected external contacts
- [ ] Sync can be triggered manually
- [ ] `npm run type-check` passes
- [ ] `npm test` passes
- [ ] Performance: Contact selection loads in <500ms (was 50-100s)

## Verification Steps

1. Start app fresh - verify external contacts are populated from macOS
2. Open contact selection - verify contacts load instantly
3. Verify sorting by recent message date works
4. Import new messages - verify `last_message_at` updates
5. Add contact in macOS Contacts - verify sync picks it up

## Estimated Effort

~20K tokens (moderate complexity: migration, new service, handler updates, sync logic)

## Dependencies

- TASK-1772 (phone_last_message) - already complete, provides lookup data
- TASK-1769/1770 - contact sorting UI already in place

## Technical Considerations

### Phone Number Matching

External contacts have phone numbers in various formats. When updating `last_message_at` from `phone_last_message`, need to:
1. Normalize external contact phone numbers (same as message phone normalization)
2. Match against `phone_last_message.phone_normalized`
3. Use the most recent date if contact has multiple phone numbers

### Sync Conflict Resolution

When macOS contact is updated:
- **Name/company/email changes**: Overwrite with macOS data
- **Phone number changes**: Re-compute `last_message_at` from `phone_last_message`
- **Deleted in macOS**: Mark as deleted or remove from shadow table

### Memory Considerations

With 1000+ external contacts, ensure:
- Batch inserts/updates (not one-by-one)
- Pagination if needed for very large contact lists
- Index on `last_message_at` for efficient sorting

## Notes

This is a better architecture than computing sorting metadata on every load. The shadow table pattern allows us to:
- Control the caching/sync behavior
- Add additional computed fields in the future
- Potentially support offline scenarios
