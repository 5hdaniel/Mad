<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backlog Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        header h1 {
            font-size: 2em;
        }

        .header-info {
            text-align: right;
            opacity: 0.9;
        }

        .filter-indicator {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            display: none;
        }

        .filter-indicator.active {
            display: inline-block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .metric-card.warning {
            border-left: 4px solid #f59e0b;
        }

        .metric-card.danger {
            border-left: 4px solid #ef4444;
        }

        .metric-card.success {
            border-left: 4px solid #10b981;
        }

        .metric-card.info {
            border-left: 4px solid #3b82f6;
        }

        .metric-value {
            font-size: 2.2em;
            font-weight: bold;
            color: #667eea;
        }

        .metric-label {
            color: #666;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .metric-detail {
            font-size: 0.75em;
            color: #999;
            margin-top: 3px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-card h3 {
            margin-bottom: 15px;
            color: #444;
            font-size: 1em;
        }

        .chart-container {
            position: relative;
            height: 250px;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .filters-header h3 {
            color: #444;
            font-size: 1em;
        }

        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
            min-width: 150px;
        }

        .filter-group.search {
            flex: 2;
            min-width: 250px;
        }

        .filter-group label {
            font-size: 0.8em;
            color: #666;
            font-weight: 500;
        }

        .filter-group select, .filter-group input {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9em;
            transition: border-color 0.2s;
        }

        .filter-group select:focus, .filter-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd6;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .btn-refresh {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            margin-top: 8px;
        }

        .btn-refresh:hover {
            background: rgba(255,255,255,0.3);
        }

        .multi-select {
            position: relative;
        }

        .multi-select-btn {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9em;
            background: white;
            text-align: left;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .multi-select-btn:hover {
            border-color: #667eea;
        }

        .multi-select-btn::after {
            content: '‚ñº';
            font-size: 0.7em;
            color: #666;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }

        .multi-select-dropdown.open {
            display: block;
        }

        .multi-select-option {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .multi-select-option:hover {
            background: #f3f4f6;
        }

        .multi-select-option input {
            margin: 0;
        }

        .multi-select-option.selected {
            background: #e0e7ff;
        }

        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            max-width: 200px;
        }

        .selected-tag {
            background: #e0e7ff;
            color: #4338ca;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75em;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.2em;
            color: #333;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            padding: 20px;
        }

        .detail-row {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #666;
            width: 120px;
            flex-shrink: 0;
        }

        .detail-value {
            color: #333;
            flex: 1;
        }

        .clickable-row {
            cursor: pointer;
        }

        .clickable-row:hover {
            background: #f0f4ff;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .table-header h3 {
            color: #444;
        }

        .result-count {
            color: #666;
            font-size: 0.9em;
        }

        .column-toggle {
            position: relative;
            display: inline-block;
        }

        .column-toggle-btn {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.85em;
            color: #555;
        }

        .column-toggle-btn:hover {
            background: #e5e5e5;
        }

        .column-toggle-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px 0;
            z-index: 100;
            min-width: 160px;
        }

        .column-toggle-menu.open {
            display: block;
        }

        .column-toggle-menu label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            cursor: pointer;
            font-size: 0.85em;
            white-space: nowrap;
        }

        .column-toggle-menu label:hover {
            background: #f5f5f5;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
            cursor: pointer;
            user-select: none;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th:hover {
            background: #e9ecef;
        }

        th.sorted-asc::after {
            content: ' ‚ñ≤';
            font-size: 0.7em;
        }

        th.sorted-desc::after {
            content: ' ‚ñº';
            font-size: 0.7em;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .priority-badge, .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-critical { background: #fee2e2; color: #dc2626; }
        .priority-high { background: #fef3c7; color: #d97706; }
        .priority-medium { background: #dbeafe; color: #2563eb; }
        .priority-low { background: #e5e7eb; color: #6b7280; }

        .status-pending { background: #e0e7ff; color: #4338ca; }
        .status-in-progress { background: #fef3c7; color: #d97706; }
        .status-testing { background: #d1fae5; color: #059669; }
        .status-completed { background: #d1fae5; color: #059669; }
        .status-blocked { background: #fee2e2; color: #dc2626; }
        .status-reopened { background: #fce7f3; color: #db2777; }
        .status-obsolete, .status-deferred { background: #e5e7eb; color: #6b7280; }

        .id-link {
            color: #667eea;
            font-weight: 600;
            text-decoration: none;
        }

        .id-link:hover {
            text-decoration: underline;
        }

        .estimate-cell {
            font-family: monospace;
            color: #666;
        }

        .desc-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #666;
            font-size: 0.85em;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                text-align: center;
            }

            .header-info {
                text-align: center;
            }

            .filters-row {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
            }

            table {
                font-size: 0.85em;
            }

            th, td {
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>üìä Backlog Dashboard</h1>
                <span class="filter-indicator" id="filterIndicator">Filtered View</span>
            </div>
            <div class="header-info">
                <div id="generated-time"></div>
                <button class="btn btn-refresh" onclick="location.reload()">üîÑ Refresh</button>
            </div>
        </header>

        <div class="metrics-grid" id="metrics-grid"></div>

        <div class="charts-grid">
            <div class="chart-card">
                <h3>üìà Status Distribution</h3>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>üéØ Priority Distribution</h3>
                <div class="chart-container">
                    <canvas id="priorityChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>üìÅ Type Distribution</h3>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>‚ö° Effort Distribution</h3>
                <div class="chart-container">
                    <canvas id="effortChart"></canvas>
                </div>
            </div>
        </div>

        <div class="filters">
            <div class="filters-header">
                <h3>üîç Filter Items</h3>
                <button class="btn btn-secondary" onclick="resetFilters()">Reset All</button>
            </div>
            <div class="filters-row">
                <div class="filter-group search">
                    <label>Search</label>
                    <input type="text" id="searchInput" placeholder="Search by ID, title, type, or area...">
                </div>
                <div class="filter-group">
                    <label>Status</label>
                    <div class="multi-select" id="statusFilter"></div>
                </div>
                <div class="filter-group">
                    <label>Priority</label>
                    <div class="multi-select" id="priorityFilter"></div>
                </div>
                <div class="filter-group">
                    <label>Category</label>
                    <div class="multi-select" id="typeFilter"></div>
                    <div class="multi-select" id="areaFilter"></div>
                </div>
                <div class="filter-group">
                    <label>Sprint</label>
                    <div class="multi-select" id="sprintFilter"></div>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h3>üìã Backlog Items</h3>
                <div style="display:flex;align-items:center;gap:12px;">
                    <span class="result-count" id="resultCount"></span>
                    <div class="column-toggle">
                        <button class="column-toggle-btn" onclick="toggleColumnMenu()">Columns ‚ñæ</button>
                        <div class="column-toggle-menu" id="columnMenu"></div>
                    </div>
                </div>
            </div>
            <div class="table-wrapper">
                <table id="backlogTable">
                    <thead>
                        <tr>
                            <th data-sort="id">ID</th>
                            <th data-sort="title">Title</th>
                            <th data-sort="description">Description</th>
                            <th data-sort="type">Type</th>
                            <th data-sort="area">Area</th>
                            <th data-sort="priority">Priority</th>
                            <th data-sort="status">Status</th>
                            <th data-sort="sprint">Sprint</th>
                            <th data-sort="est_tokens">Estimate</th>
                            <th data-sort="created_at">Added</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal-overlay" id="detailModal" onclick="if(event.target === this) closeModal()">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Backlog Item</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        // Backlog data will be injected here
        const backlogData = BACKLOG_DATA_PLACEHOLDER;

        let currentSort = { column: 'id', direction: 'asc' };
        let filteredData = [...backlogData];

        // Chart instances (for updating)
        let statusChart, priorityChart, categoryChart, effortChart;

        // Colors
        const colors = {
            primary: '#667eea',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            info: '#3b82f6',
            gray: '#6b7280',
            purple: '#8b5cf6',
            pink: '#ec4899'
        };

        const statusColors = {
            'pending': '#818cf8',
            'completed': '#34d399',
            'in-progress': '#fbbf24',
            'testing': '#60a5fa',
            'blocked': '#f87171',
            'reopened': '#f472b6',
            'obsolete': '#94a3b8',
            'deferred': '#a1a1aa'
        };

        const priorityColors = {
            'critical': '#ef4444',
            'high': '#f59e0b',
            'medium': '#3b82f6',
            'low': '#6b7280'
        };

        // Multi-select state
        const multiSelectState = {
            status: [],
            priority: [],
            type: [],
            area: [],
            sprint: []
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('generated-time').textContent = new Date().toLocaleString();

            populateFilters();

            // Default: show all statuses except completed/obsolete
            const closedStatuses = ['completed', 'obsolete'];
            const allStatuses = [...new Set(backlogData.map(i => normalize(i.status)))].filter(Boolean);
            const defaultStatuses = allStatuses.filter(s => !closedStatuses.includes(s));
            setMultiSelectValues('status', defaultStatuses);
            applyFilters();

            buildColumnMenu();
            renderAll();
            updateColumnVisibility();

            // Event listeners
            document.getElementById('searchInput').addEventListener('input', applyFilters);

            // Sort headers
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.addEventListener('click', () => sortTable(th.dataset.sort));
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.multi-select')) {
                    document.querySelectorAll('.multi-select-dropdown').forEach(d => d.classList.remove('open'));
                }
            });
        });

        function normalize(val) {
            return (val || '').toLowerCase().trim().replace(/\*/g, '').replace(/_/g, '');
        }

        function parseTokens(val) {
            if (!val || val === '-') return 0;
            val = val.replace(/~/g, '').replace(/,/g, '').toUpperCase().trim();
            if (val.includes('-') && !val.startsWith('-')) val = val.split('-')[0];
            if (val.includes('K')) return parseFloat(val.replace('K', '')) * 1000 || 0;
            if (val.includes('M')) return parseFloat(val.replace('M', '')) * 1000000 || 0;
            return parseInt(val) || 0;
        }

        function formatTokens(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(0) + 'K';
            return num.toString();
        }

        function createMultiSelect(containerId, options, stateKey, placeholder) {
            const container = document.getElementById(containerId);
            const btn = document.createElement('button');
            btn.className = 'multi-select-btn';
            btn.type = 'button';
            btn.innerHTML = `<span class="selected-tags">${placeholder}</span>`;

            const dropdown = document.createElement('div');
            dropdown.className = 'multi-select-dropdown';

            options.forEach(opt => {
                const optDiv = document.createElement('div');
                optDiv.className = 'multi-select-option';
                optDiv.innerHTML = `<input type="checkbox" value="${opt}"> ${opt.charAt(0).toUpperCase() + opt.slice(1)}`;
                optDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const checkbox = optDiv.querySelector('input');
                    // Only toggle if click was not directly on the checkbox (browser already toggled it)
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                    }
                    optDiv.classList.toggle('selected', checkbox.checked);

                    if (checkbox.checked) {
                        if (!multiSelectState[stateKey].includes(opt)) {
                            multiSelectState[stateKey].push(opt);
                        }
                    } else {
                        multiSelectState[stateKey] = multiSelectState[stateKey].filter(v => v !== opt);
                    }

                    updateMultiSelectDisplay(btn, stateKey, placeholder);
                    applyFilters();
                });
                dropdown.appendChild(optDiv);
            });

            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('.multi-select-dropdown').forEach(d => {
                    if (d !== dropdown) d.classList.remove('open');
                });
                dropdown.classList.toggle('open');
            });

            container.appendChild(btn);
            container.appendChild(dropdown);
        }

        function updateMultiSelectDisplay(btn, stateKey, placeholder) {
            const selected = multiSelectState[stateKey];
            const tagsSpan = btn.querySelector('.selected-tags');
            if (selected.length === 0) {
                tagsSpan.innerHTML = placeholder;
            } else if (selected.length <= 2) {
                tagsSpan.innerHTML = selected.map(s =>
                    `<span class="selected-tag">${s.charAt(0).toUpperCase() + s.slice(1)}</span>`
                ).join('');
            } else {
                tagsSpan.innerHTML = `<span class="selected-tag">${selected.length} selected</span>`;
            }
        }

        function setMultiSelectValues(stateKey, values) {
            multiSelectState[stateKey] = values;
            const container = document.getElementById(stateKey + 'Filter');
            const btn = container.querySelector('.multi-select-btn');
            const options = container.querySelectorAll('.multi-select-option');

            options.forEach(opt => {
                const checkbox = opt.querySelector('input');
                const isSelected = values.includes(checkbox.value);
                checkbox.checked = isSelected;
                opt.classList.toggle('selected', isSelected);
            });

            const placeholder = stateKey === 'status' ? 'All Statuses' :
                               stateKey === 'priority' ? 'All Priorities' :
                               stateKey === 'type' ? 'All Types' :
                               stateKey === 'area' ? 'All Areas' : 'All Sprints';
            updateMultiSelectDisplay(btn, stateKey, placeholder);
        }

        function populateFilters() {
            const statuses = [...new Set(backlogData.map(i => normalize(i.status)))].filter(Boolean).sort();
            const priorities = ['critical', 'high', 'medium', 'low'];
            const types = [...new Set(backlogData.map(i => normalize(i.type)))].filter(Boolean).sort();
            const areas = [...new Set(backlogData.map(i => normalize(i.area)))].filter(Boolean).sort();

            // Get unique sprints, add "Unassigned" option
            const sprints = [...new Set(backlogData.map(i => i.sprint).filter(s => s && s !== '-'))].sort();
            const sprintOptions = ['unassigned', ...sprints];

            createMultiSelect('statusFilter', statuses, 'status', 'All Statuses');
            createMultiSelect('priorityFilter', priorities, 'priority', 'All Priorities');
            createMultiSelect('typeFilter', types, 'type', 'All Types');
            createMultiSelect('areaFilter', areas, 'area', 'All Areas');
            createMultiSelect('sprintFilter', sprintOptions, 'sprint', 'All Sprints');
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const statuses = multiSelectState.status;
            const priorities = multiSelectState.priority;
            const types = multiSelectState.type;
            const areas = multiSelectState.area;
            const sprints = multiSelectState.sprint;

            filteredData = backlogData.filter(item => {
                if (search) {
                    const searchFields = [item.id, item.title, item.type, item.area].join(' ').toLowerCase();
                    if (!searchFields.includes(search)) return false;
                }
                if (statuses.length > 0 && !statuses.includes(normalize(item.status))) return false;
                if (priorities.length > 0 && !priorities.includes(normalize(item.priority))) return false;
                if (types.length > 0 && !types.includes(normalize(item.type))) return false;
                if (areas.length > 0 && !areas.includes(normalize(item.area))) return false;

                // Sprint filter logic
                if (sprints.length > 0) {
                    const itemSprint = item.sprint && item.sprint !== '-' ? item.sprint : 'unassigned';
                    if (!sprints.includes(itemSprint)) return false;
                }

                return true;
            });

            // Update filter indicator
            const hasFilters = search || statuses.length > 0 || priorities.length > 0 || types.length > 0 || areas.length > 0 || sprints.length > 0;
            document.getElementById('filterIndicator').classList.toggle('active', hasFilters);

            renderTable();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterIndicator').classList.remove('active');

            // Reset multi-selects
            setMultiSelectValues('status', []);
            setMultiSelectValues('priority', []);
            setMultiSelectValues('type', []);
            setMultiSelectValues('area', []);
            setMultiSelectValues('sprint', []);

            filteredData = [...backlogData];
            renderAll();
        }

        // Chart click handlers
        function handleChartClick(filterType, value) {
            if (filterType === 'status') {
                setMultiSelectValues('status', [value]);
            } else if (filterType === 'priority') {
                setMultiSelectValues('priority', [value]);
            } else if (filterType === 'type') {
                setMultiSelectValues('type', [value]);
            }
            applyFilters();
            // Scroll to table
            document.querySelector('.table-container').scrollIntoView({ behavior: 'smooth' });
        }

        function renderAll() {
            renderMetrics();
            renderCharts();
            renderTable();
        }

        function renderMetrics() {
            const closed = ['completed', 'obsolete'];
            const total = filteredData.length;
            const open = filteredData.filter(i => !closed.includes(normalize(i.status)));
            const completed = filteredData.filter(i => normalize(i.status) === 'completed');
            const critical = filteredData.filter(i => normalize(i.priority) === 'critical' && !closed.includes(normalize(i.status)));
            const highPriority = filteredData.filter(i => ['critical', 'high'].includes(normalize(i.priority)) && !closed.includes(normalize(i.status)));
            const unassigned = open.filter(i => !i.sprint || i.sprint === '-');
            const blocked = filteredData.filter(i => normalize(i.status) === 'blocked');
            const reopened = filteredData.filter(i => normalize(i.status) === 'reopened');

            const totalEstimate = open.reduce((sum, i) => sum + parseTokens(i.est_tokens), 0);

            const metrics = [
                { value: open.length, label: 'Open Items', class: '', detail: '' },
                { value: unassigned.length, label: 'Unassigned', class: '', detail: '' },
            ];

            // Add attention items if present
            if (blocked.length > 0) {
                metrics.push({ value: blocked.length, label: 'Blocked', class: 'danger', detail: 'Needs attention' });
            }
            if (reopened.length > 0) {
                metrics.push({ value: reopened.length, label: 'Reopened', class: 'danger', detail: 'Failed testing' });
            }

            const grid = document.getElementById('metrics-grid');
            grid.innerHTML = metrics.map(m => `
                <div class="metric-card ${m.class}">
                    <div class="metric-value">${m.value}</div>
                    <div class="metric-label">${m.label}</div>
                    ${m.detail ? `<div class="metric-detail">${m.detail}</div>` : ''}
                </div>
            `).join('');
        }

        function renderCharts() {
            const closed = ['completed', 'obsolete'];
            const openItems = filteredData.filter(i => !closed.includes(normalize(i.status)));

            // Status Chart ‚Äî only show open statuses (exclude completed/obsolete)
            const statusCounts = {};
            openItems.forEach(i => {
                const s = normalize(i.status) || 'unknown';
                statusCounts[s] = (statusCounts[s] || 0) + 1;
            });

            const statusLabels = Object.keys(statusCounts);
            const statusData = Object.values(statusCounts);
            const statusChartColors = statusLabels.map(s => statusColors[s] || '#94a3b8');

            if (statusChart) statusChart.destroy();
            statusChart = new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: statusLabels.map(s => s.charAt(0).toUpperCase() + s.slice(1)),
                    datasets: [{
                        data: statusData,
                        backgroundColor: statusChartColors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, padding: 10 } }
                    },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            handleChartClick('status', statusLabels[idx]);
                        }
                    }
                }
            });

            // Priority Chart
            const priorityOrder = ['critical', 'high', 'medium', 'low'];
            const priorityCounts = { critical: 0, high: 0, medium: 0, low: 0 };
            openItems.forEach(i => {
                const p = normalize(i.priority);
                if (priorityCounts.hasOwnProperty(p)) priorityCounts[p]++;
            });

            if (priorityChart) priorityChart.destroy();
            priorityChart = new Chart(document.getElementById('priorityChart'), {
                type: 'bar',
                data: {
                    labels: priorityOrder.map(p => p.charAt(0).toUpperCase() + p.slice(1)),
                    datasets: [{
                        label: 'Items',
                        data: priorityOrder.map(p => priorityCounts[p]),
                        backgroundColor: priorityOrder.map(p => priorityColors[p])
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            handleChartClick('priority', priorityOrder[idx]);
                        }
                    }
                }
            });

            // Category Chart
            const typeCounts = {};
            openItems.forEach(i => {
                const t = normalize(i.type) || 'other';
                typeCounts[t] = (typeCounts[t] || 0) + 1;
            });
            const topTypes = Object.entries(typeCounts)
                .sort((a, b) => b[1] - a[1]);

            if (categoryChart) categoryChart.destroy();
            const typeLabels = topTypes.map(c => c[0]);
            categoryChart = new Chart(document.getElementById('categoryChart'), {
                type: 'bar',
                data: {
                    labels: typeLabels,
                    datasets: [{
                        label: 'Items',
                        data: topTypes.map(c => c[1]),
                        backgroundColor: colors.primary
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        datalabels: { anchor: 'end', align: 'right', font: { weight: 'bold' } }
                    },
                    scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            handleChartClick('type', typeLabels[idx]);
                        }
                    }
                },
                plugins: [{
                    afterDatasetsDraw(chart) {
                        const { ctx } = chart;
                        chart.data.datasets.forEach((dataset, di) => {
                            chart.getDatasetMeta(di).data.forEach((bar, i) => {
                                const value = dataset.data[i];
                                ctx.save();
                                ctx.font = 'bold 12px -apple-system, sans-serif';
                                ctx.fillStyle = '#333';
                                ctx.textAlign = 'left';
                                ctx.textBaseline = 'middle';
                                ctx.fillText(value, bar.x + 6, bar.y);
                                ctx.restore();
                            });
                        });
                    }
                }]
            });

            // Effort Chart
            const effortBuckets = { 'Small (<20K)': 0, 'Medium (20-50K)': 0, 'Large (50-100K)': 0, 'XLarge (>100K)': 0, 'No estimate': 0 };
            openItems.forEach(i => {
                const tokens = parseTokens(i.est_tokens);
                if (tokens === 0) effortBuckets['No estimate']++;
                else if (tokens < 20000) effortBuckets['Small (<20K)']++;
                else if (tokens < 50000) effortBuckets['Medium (20-50K)']++;
                else if (tokens < 100000) effortBuckets['Large (50-100K)']++;
                else effortBuckets['XLarge (>100K)']++;
            });

            if (effortChart) effortChart.destroy();
            effortChart = new Chart(document.getElementById('effortChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(effortBuckets),
                    datasets: [{
                        data: Object.values(effortBuckets),
                        backgroundColor: [colors.success, colors.warning, '#f97316', colors.danger, colors.gray]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, padding: 10 } }
                    }
                }
            });
        }

        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            const priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 };

            filteredData.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';

                if (column === 'priority') {
                    aVal = priorityOrder[normalize(aVal)] ?? 99;
                    bVal = priorityOrder[normalize(bVal)] ?? 99;
                } else if (column === 'est_tokens') {
                    aVal = parseTokens(aVal);
                    bVal = parseTokens(bVal);
                } else if (column === 'id') {
                    aVal = parseInt(aVal.replace('BACKLOG-', '')) || 0;
                    bVal = parseInt(bVal.replace('BACKLOG-', '')) || 0;
                } else {
                    aVal = normalize(aVal);
                    bVal = normalize(bVal);
                }

                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
                if (th.dataset.sort === column) {
                    th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
            });

            renderTable();
        }

        // Column visibility
        const columns = [
            { key: 'id', label: 'ID', visible: true },
            { key: 'title', label: 'Title', visible: true },
            { key: 'description', label: 'Description', visible: false },
            { key: 'type', label: 'Type', visible: true },
            { key: 'area', label: 'Area', visible: true },
            { key: 'priority', label: 'Priority', visible: true },
            { key: 'status', label: 'Status', visible: true },
            { key: 'sprint', label: 'Sprint', visible: true },
            { key: 'est_tokens', label: 'Estimate', visible: true },
            { key: 'created_at', label: 'Added', visible: true },
        ];

        function buildColumnMenu() {
            const menu = document.getElementById('columnMenu');
            menu.innerHTML = columns.map((col, i) => `
                <label>
                    <input type="checkbox" ${col.visible ? 'checked' : ''}
                        onchange="toggleColumn(${i}, this.checked)">
                    ${col.label}
                </label>
            `).join('');
        }

        function toggleColumnMenu() {
            document.getElementById('columnMenu').classList.toggle('open');
        }

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.column-toggle')) {
                document.getElementById('columnMenu').classList.remove('open');
            }
        });

        function toggleColumn(index, visible) {
            columns[index].visible = visible;
            updateColumnVisibility();
            renderTable();
        }

        function updateColumnVisibility() {
            const ths = document.querySelectorAll('#backlogTable thead th');
            ths.forEach((th, i) => {
                th.style.display = columns[i].visible ? '' : 'none';
            });
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');

            tbody.innerHTML = filteredData.map(item => {
                const priority = normalize(item.priority);
                const status = normalize(item.status).replace(' ', '-');

                const descText = item.description || '-';
                const descTruncated = descText.length > 80 ? descText.substring(0, 80) + '...' : descText;

                const cells = [
                    `<td><span class="id-link">${item.id.replace('BACKLOG-', '')}</span></td>`,
                    `<td>${item.title}</td>`,
                    `<td class="desc-cell" title="${descText.replace(/"/g, '&quot;')}">${descTruncated}</td>`,
                    `<td>${item.type || '-'}</td>`,
                    `<td>${item.area || '-'}</td>`,
                    `<td><span class="priority-badge priority-${priority}">${item.priority || '-'}</span></td>`,
                    `<td><span class="status-badge status-${status}">${item.status || '-'}</span></td>`,
                    `<td>${item.sprint && item.sprint !== '-' ? item.sprint : '-'}</td>`,
                    `<td class="estimate-cell">${item.est_tokens || '-'}</td>`,
                    `<td style="white-space:nowrap">${item.created_at && item.created_at !== '-' ? item.created_at : '-'}</td>`,
                ];

                const visibleCells = cells.filter((_, i) => columns[i].visible).join('');

                return `<tr class="clickable-row" onclick="showItemDetail('${item.id}')">${visibleCells}</tr>`;
            }).join('');

            document.getElementById('resultCount').textContent =
                `Showing ${filteredData.length} of ${backlogData.length} items`;
        }

        // Modal functions
        function showItemDetail(itemId) {
            const item = backlogData.find(i => i.id === itemId);
            if (!item) return;

            document.getElementById('modalTitle').textContent = item.id;

            const priority = normalize(item.priority);
            const status = normalize(item.status).replace(' ', '-');

            // Format dates for display
            const formatDate = (dateStr) => {
                if (!dateStr || dateStr === '-') return '-';
                try {
                    const date = new Date(dateStr + 'T00:00:00');
                    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                } catch {
                    return dateStr;
                }
            };

            const createdAt = formatDate(item.created_at);
            const completedAt = formatDate(item.completed_at);
            const isCompleted = status === 'completed' || status === 'done';

            document.getElementById('modalBody').innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">Title</div>
                    <div class="detail-value">${item.title}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Type</div>
                    <div class="detail-value">${item.type || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Area</div>
                    <div class="detail-value">${item.area || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Priority</div>
                    <div class="detail-value"><span class="priority-badge priority-${priority}">${item.priority || '-'}</span></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Status</div>
                    <div class="detail-value"><span class="status-badge status-${status}">${item.status || '-'}</span></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Created</div>
                    <div class="detail-value">${createdAt}</div>
                </div>
                ${isCompleted ? `
                <div class="detail-row">
                    <div class="detail-label">Completed</div>
                    <div class="detail-value">${completedAt}</div>
                </div>
                ` : ''}
                <div class="detail-row">
                    <div class="detail-label">Sprint</div>
                    <div class="detail-value">${item.sprint && item.sprint !== '-' ? item.sprint : '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Estimate</div>
                    <div class="detail-value">${item.est_tokens || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Actual</div>
                    <div class="detail-value">${item.actual_tokens || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Variance</div>
                    <div class="detail-value">${item.variance || '-'}</div>
                </div>
                <div class="detail-row" style="flex-direction: column;">
                    <div class="detail-label" style="width: 100%; margin-bottom: 8px;">Description</div>
                    <div class="detail-value" style="white-space: pre-wrap;">${item.description || 'No description available'}</div>
                </div>
            `;

            document.getElementById('detailModal').classList.add('open');
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('open');
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>




































