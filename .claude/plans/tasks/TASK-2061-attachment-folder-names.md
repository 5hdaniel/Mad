# Task TASK-2061: Human-Readable Attachment Folder Names in Export

---

## WORKFLOW REQUIREMENT

**This task MUST be implemented via the `engineer` agent.**

Direct implementation is PROHIBITED. The correct workflow is:

1. PM creates this task file
2. PM invokes `engineer` agent with `subagent_type="engineer"`
3. Engineer agent implements, tracks metrics, creates PR
4. PM invokes `senior-engineer-pr-lead` agent for PR review
5. SR Engineer approves PR
6. **Engineer merges PR and verifies merge state is MERGED**
7. Task marked complete only AFTER merge verified

**CRITICAL:** Creating a PR is step 3 of 7, not the final step. Task is NOT complete until PR is MERGED.

**PR Lifecycle Reference:** `.claude/docs/shared/pr-lifecycle.md`

If you are reading this task file and about to implement it yourself, **STOP**.
Use the Task tool to spawn the engineer agent instead.

---

## Goal

Fix email attachment export folder names to use the same human-readable naming convention as the thread PDFs, instead of raw Outlook thread IDs (e.g., `AAQkADVk...`). After this fix, attachment folders will be named like `thread_001_2024-03-11_RE_Insurance/attachments/` to match their corresponding PDF `thread_001_2024-03-11_RE_Insurance.pdf`.

## Non-Goals

- Do NOT change the thread PDF naming convention itself (it is already correct).
- Do NOT change text message attachment handling.
- Do NOT change the attachment file naming within the directory (individual filenames stay as-is).
- Do NOT restructure the overall export folder hierarchy.

## Prerequisites

**Sprint:** SPRINT-096
**Depends on:** Nothing. This task is independent.
**Blocks:** Nothing.

## Context

TASK-2050 added per-thread attachment subdirectories in the `emails/` export folder. The thread PDFs use human-readable names:

```
emails/
  thread_001_2024-03-11_RE_Insurance.pdf
  thread_002_2024-05-20_Contract_Review.pdf
```

But the attachment subdirectories use raw `thread_id` values (Outlook/Gmail IDs):

```
emails/
  AAQkADVkZGYwYzJjLTg1MT.../attachments/report.pdf
  CABCDEFxyz.../attachments/contract.docx
```

The mismatch makes it impossible for users to find attachments for a given thread.

### Root Cause

In `attachmentHelpers.ts` line 215:
```typescript
const threadDirName = sanitizeFileName(threadKey);
```

The `threadKey` here is the raw `thread_id` from the email object (e.g., `AAQkADVk...`). This gets sanitized to something like `AAQkADVk___` which is meaningless.

Meanwhile, in `folderExportService.ts` line 389, the thread PDF uses:
```typescript
const fileName = `thread_${paddedIndex}_${firstDate}_${subject}.pdf`;
```

The fix: make the attachment export use the same naming pattern as the PDF export.

## Requirements

### Must Do:

1. **Modify `exportEmailAttachmentsToThreadDirs` in `attachmentHelpers.ts`** to accept a thread-name mapping so attachment folders match PDF names:
   - Option A (preferred): Accept a `Map<string, string>` parameter mapping thread_id to the human-readable folder name (generated by the caller)
   - Option B: Generate the human-readable name inside the function using the same logic as `exportEmailThreads` in `folderExportService.ts`

2. **Update `folderExportService.ts`** to pass the thread-name mapping:
   - The `exportEmailThreads()` method (line ~353) already iterates threads and generates the `thread_NNN_DATE_SUBJECT` pattern
   - After generating thread PDFs, pass the same name mapping to `exportEmailAttachmentsToThreadDirs()`
   - Or: generate the mapping before both calls and pass to each

3. **The naming convention must match exactly**:
   ```
   PDF:         thread_001_2024-03-11_RE_Insurance.pdf
   Attachments: thread_001_2024-03-11_RE_Insurance/attachments/report.pdf
   ```
   The folder name should be the PDF filename minus the `.pdf` extension.

4. **Handle edge cases**:
   - Threads with no subject: use `no_subject` (matching existing PDF behavior)
   - Threads with no date: use `unknown` (matching existing PDF behavior)
   - Thread IDs that don't match any exported thread: use sanitized thread_id as fallback

### Must NOT Do:

- Change the thread PDF naming convention
- Change individual attachment filenames
- Modify text message export paths

## Acceptance Criteria

- [ ] Attachment folders use `thread_NNN_DATE_SUBJECT` naming matching the PDF convention
- [ ] A thread's attachment folder name matches its PDF name (minus `.pdf` extension)
- [ ] Threads with no subject use `no_subject` in folder name
- [ ] Threads with no date use `unknown` in folder name
- [ ] Fallback to sanitized thread_id for threads without a mapping
- [ ] Existing export tests still pass
- [ ] `npm test` passes
- [ ] `npm run type-check` passes
- [ ] `npm run lint` passes

## Deliverables

### Files to Create

None.

### Files to Modify

| File | Changes |
|------|---------|
| `electron/services/folderExport/attachmentHelpers.ts` | Modify `exportEmailAttachmentsToThreadDirs` to accept/use thread name mapping instead of raw threadKey |
| `electron/services/folderExport/folderExportService.ts` | Generate thread name mapping and pass to attachment export, ensure call order (PDFs first or mapping generation first) |

### Files to Read (for context)

| File | Why |
|------|-----|
| `electron/services/folderExport/attachmentHelpers.ts` | Full current implementation of attachment export (focus on lines 188-344) |
| `electron/services/folderExport/folderExportService.ts` | Thread PDF naming logic (focus on lines 353-393), overall export flow |
| `electron/services/folderExport/textExportHelpers.ts` | `getThreadKey()` function used for grouping (lines 21-31) |

## Implementation Notes

### Approach: Generate mapping in folderExportService, pass to attachmentHelpers

In `folderExportService.ts`, before calling export functions:

```typescript
// Build thread name mapping (thread_id -> human-readable folder name)
const threadNameMap = new Map<string, string>();
let threadIndex = 0;
for (const [threadKey, msgs] of threads) {
  const firstDate = msgs[0].sent_at
    ? new Date(msgs[0].sent_at as string).toISOString().split("T")[0]
    : "unknown";
  const subject = sanitizeFileName(msgs[0].subject || "no_subject");
  const paddedIndex = String(threadIndex + 1).padStart(3, "0");
  const folderName = `thread_${paddedIndex}_${firstDate}_${subject}`;
  threadNameMap.set(threadKey, folderName);
  threadIndex++;
}

// Pass to attachment export
await exportEmailAttachmentsToThreadDirs(emails, emailsExportPath, threadNameMap);
```

### Signature change in attachmentHelpers.ts

```typescript
export async function exportEmailAttachmentsToThreadDirs(
  emails: Communication[],
  emailsExportPath: string,
  threadNameMap?: Map<string, string>,  // NEW: optional thread name mapping
): Promise<AttachmentExportResult> {
  // ...
  for (const [threadKey, threadEmails] of threadMap) {
    // Use mapped name if available, fallback to sanitized raw key
    const threadDirName = threadNameMap?.get(threadKey) || sanitizeFileName(threadKey);
    // ... rest unchanged
  }
}
```

### Thread key matching

The thread key used in `attachmentHelpers.ts` (line 206: `email.thread_id || email.id`) must match the key used in `folderExportService.ts` (via `getThreadKey()`). Verify both use the same function or logic. If they differ, align them by using `getThreadKey()` in both places.

## Testing Expectations

### Unit Tests

- **Required:** Update existing attachment export tests if any
- **New tests to write:**
  1. `exportEmailAttachmentsToThreadDirs` with threadNameMap produces correct folder names
  2. `exportEmailAttachmentsToThreadDirs` without threadNameMap falls back to sanitized threadKey
  3. Verify folder name matches PDF name pattern

### CI Requirements

- [ ] `npm test` passes
- [ ] Tests run 3x without flakiness

## Estimation

- **Category:** fix (2 files, small scope)
- **Base estimate:** ~15K tokens
- **SR overhead:** +10K
- **Final estimate:** ~25K tokens
- **Token Cap:** 100K (4x of 25K)

## PR Preparation

- **Title:** `fix(export): use human-readable names for email attachment folders`
- **Branch:** `fix/task-2061-attachment-folder-names`
- **Target:** `develop`

---

## Implementation Summary (Engineer-Owned)

**REQUIRED: Complete this section before creating PR.**
**See: `.claude/docs/ENGINEER-WORKFLOW.md` for full workflow**

*Completed: 2026-02-23*

### Engineer Checklist

```
Pre-Work:
- [x] Created branch from develop
- [x] Noted start time: session start
- [x] Read task file completely

Implementation:
- [x] Code complete
- [x] Tests pass locally (npm test)
- [x] Type check passes (npm run type-check)
- [x] Lint passes (npm run lint)

PR Submission:
- [x] This summary section completed
- [ ] PR created with Engineer Metrics (see template)
- [ ] CI passes (gh pr checks --watch)
- [ ] SR Engineer review requested

Completion:
- [ ] SR Engineer approved and merged
- [ ] PM notified for next task
```

### Results

- **Before**: Attachment folders used raw thread_id (e.g., `AAQkADVk___/attachments/`) which was unreadable
- **After**: Attachment folders use human-readable names matching PDF names (e.g., `thread_001_2024-03-11_RE_Insurance/attachments/`)
- **Actual Tokens**: ~15K (Est: 25K)
- **PR**: https://github.com/5hdaniel/Mad/pull/953

### Changes Made

1. **`attachmentHelpers.ts`**: Added optional `threadNameMap` parameter to `exportEmailAttachmentsToThreadDirs()`. Changed thread grouping to use `getThreadKey()` for alignment with `exportEmailThreads()`. Folder name resolution uses map lookup with fallback to sanitized key.

2. **`folderExportService.ts`**: Added thread name mapping construction before calling `exportEmailAttachmentsToThreadDirs()`. Uses same grouping/naming logic as `exportEmailThreads()` (getThreadKey, chronological sort, `thread_NNN_DATE_SUBJECT` pattern).

3. **`emailAttachmentExport.test.ts`**: Updated existing test for `getThreadKey` fallback behavior. Added 3 new tests: threadNameMap usage, fallback for unmapped threads, backward compatibility without map.

### Notes

**Deviations from plan:**
Also aligned thread key computation in `attachmentHelpers.ts` to use `getThreadKey()` from `textExportHelpers.ts` instead of the simpler `thread_id || id` fallback. This was flagged in the task guardrails as a potential mismatch and ensures correct mapping between PDF names and attachment folders.

**Issues encountered:**
None. The `getThreadKey()` import worked cleanly since its transitive dependency (`contactResolutionService`) was already mocked in the test environment.

---

## Guardrails

**STOP and ask PM if:**
- The thread key used by `attachmentHelpers.ts` differs from `getThreadKey()` used by `folderExportService.ts`
- The `folderExportService` calls `exportEmailAttachmentsToThreadDirs` from a different method than `exportEmailThreads` (need to trace the call site)
- The function signature change breaks other callers of `exportEmailAttachmentsToThreadDirs`
- More than 3 files need modification
