# Task TASK-1074: Patch jsdiff DoS Vulnerability

---

## WORKFLOW REQUIREMENT

**This task MUST be implemented via the `engineer` agent.**

Direct implementation is PROHIBITED. The correct workflow is:

1. PM creates this task file
2. PM invokes `engineer` agent with `subagent_type="engineer"`
3. Engineer agent implements, tracks metrics, creates PR
4. PM invokes `senior-engineer-pr-lead` agent for PR review
5. SR Engineer approves and merges

If you are reading this task file and about to implement it yourself, **STOP**.
Use the Task tool to spawn the engineer agent instead.

---

## Task Overview

| Field | Value |
|-------|-------|
| **Task ID** | TASK-1074 |
| **Sprint** | SPRINT-039 |
| **Backlog Item** | BACKLOG-235 |
| **Priority** | MEDIUM |
| **Phase** | 1 |
| **Category** | security |
| **Estimated Tokens** | ~15K |
| **Token Cap** | 60K |

---

## Goal

Patch the jsdiff dependency to resolve the DoS (Denial of Service) vulnerability identified by `npm audit`.

## Non-Goals

- Do NOT upgrade other unrelated dependencies
- Do NOT refactor code that uses jsdiff
- Do NOT change diff functionality or behavior

## Deliverables

1. Update: `package.json` - Update jsdiff to patched version
2. Update: `package-lock.json` - Lock updated dependency tree
3. Verification: `npm audit` shows no high/critical vulnerabilities

## Acceptance Criteria

- [ ] jsdiff updated to version without vulnerability
- [ ] `npm audit` shows no high or critical vulnerabilities
- [ ] All existing tests pass
- [ ] Any code using jsdiff still works correctly
- [ ] No breaking changes introduced
- [ ] All CI checks pass

## Implementation Notes

### Problem Analysis

Run `npm audit` to identify the specific vulnerability:
```bash
npm audit
```

The output will show:
- Vulnerability severity (high/critical)
- Package name (jsdiff)
- Vulnerable versions
- Patched version to upgrade to

### Key Patterns

Simple dependency update:
```bash
# Check current version
npm list jsdiff

# Update to latest patched version
npm update jsdiff

# Or install specific version if needed
npm install jsdiff@<patched-version>

# Verify fix
npm audit
```

### Important Details

1. Check if jsdiff is a direct or transitive dependency
2. If transitive, may need to update the parent package
3. Review changelog for breaking changes between versions
4. Test any code that uses diff functionality

### Finding Usage

```bash
# Find files that use jsdiff
grep -r "jsdiff\|require.*diff\|import.*diff" --include="*.ts" --include="*.tsx" electron/ src/
```

## Integration Notes

- Imports from: npm registry
- Used by: Files using diff functionality
- Depends on: None

## Do / Don't

### Do:

- Run `npm audit` before and after fix
- Check for breaking changes in the changelog
- Test any diff functionality in the app
- Update both package.json and package-lock.json

### Don't:

- Update unrelated dependencies
- Force resolutions that might break things
- Skip testing diff functionality
- Ignore npm audit warnings

## When to Stop and Ask

- If jsdiff is a transitive dependency and parent package has no update
- If patched version has breaking changes
- If multiple packages depend on conflicting jsdiff versions
- If npm audit shows new vulnerabilities after update

## Testing Expectations (MANDATORY)

### Unit Tests

- Required: No new tests needed
- Existing tests to verify:
  - Any tests that use diff functionality should pass

### Coverage

- Coverage impact: No impact expected

### Integration / Feature Tests

- Required scenarios:
  - Verify any diff features in the app work correctly
  - Run full test suite to catch regressions

### CI Requirements

This task's PR MUST pass:
- [ ] Unit tests
- [ ] Type checking
- [ ] Lint / format checks
- [ ] npm audit (no high/critical)

**PRs without tests when required WILL BE REJECTED.**

## PR Preparation

- **Title**: `fix(deps): patch jsdiff DoS vulnerability`
- **Labels**: `security`, `dependencies`
- **Depends on**: None

---

## PM Estimate (PM-Owned)

**Category:** `security`

**Estimated Tokens:** ~15K

**Token Cap:** 60K (4x estimate)

> If you reach this cap, STOP and report to PM. See `.claude/docs/shared/token-cap-workflow.md`.

**Estimation Assumptions:**

| Factor | Assumption | Impact |
|--------|------------|--------|
| Files to modify | 2 (package.json, lock file) | +5K |
| Investigation | Find usage, check changelog | +5K |
| Testing | Run tests, verify audit | +5K |

**Confidence:** High

**Risk factors:**
- Breaking changes in new version (low risk)
- Transitive dependency issues (low risk)

**Similar past tasks:** Dependency updates are typically straightforward

---

## Implementation Summary (Engineer-Owned)

**REQUIRED: Record your agent_id immediately when the Task tool returns.**

*Completed: <DATE>*

### Agent ID

**Record this immediately when Task tool returns:**
```
Engineer Agent ID: <agent_id from Task tool output>
```

### Checklist

```
Files modified:
- [ ] package.json
- [ ] package-lock.json

Features implemented:
- [ ] jsdiff updated to patched version
- [ ] npm audit shows no vulnerabilities

Verification:
- [ ] npm run type-check passes
- [ ] npm run lint passes
- [ ] npm test passes
- [ ] npm audit passes
```

### Metrics (Auto-Captured)

**From SubagentStop hook** - Run: `grep "<agent_id>" .claude/metrics/tokens.jsonl | jq '.'`

| Metric | Value |
|--------|-------|
| **Total Tokens** | X |
| Duration | X seconds |
| API Calls | X |
| Input Tokens | X |
| Output Tokens | X |
| Cache Read | X |
| Cache Create | X |

**Variance:** PM Est ~15K vs Actual ~XK (X% over/under)

### Notes

**Planning notes:**
<Key decisions from planning phase, revisions if any>

**Deviations from plan:**
<If you deviated from the approved plan, explain what and why. Use "DEVIATION:" prefix.>
<If no deviations, write "None">

**Design decisions:**
<Document any design decisions you made and the reasoning>

**Issues encountered:**
<Document any issues or challenges and how you resolved them>

**Reviewer notes:**
<Anything the reviewer should pay attention to>

### Estimate vs Actual Analysis

**REQUIRED: Compare PM token estimate to actual to improve future predictions.**

| Metric | PM Estimate | Actual | Variance |
|--------|-------------|--------|----------|
| **Tokens** | ~15K | ~XK | +/-X% |
| Duration | - | X sec | - |

**Root cause of variance:**
<1-2 sentence explanation of why estimate was off>

**Suggestion for similar tasks:**
<What should PM estimate differently next time?>

---

## SR Engineer Review (SR-Owned)

**REQUIRED: Record your agent_id immediately when the Task tool returns.**

*Review Date: <DATE>*

### Agent ID

```
SR Engineer Agent ID: <agent_id from Task tool output>
```

### Metrics (Auto-Captured)

**From SubagentStop hook** - Run: `grep "<agent_id>" .claude/metrics/tokens.jsonl | jq '.'`

| Metric | Value |
|--------|-------|
| **Total Tokens** | X |
| Duration | X seconds |
| API Calls | X |

### Review Summary

**Architecture Compliance:** PASS / FAIL / N/A
**Security Review:** PASS / FAIL
**Test Coverage:** Adequate / N/A

**Review Notes:**
<Key observations, concerns addressed, approval rationale>

### Merge Information

**PR Number:** #XXX
**Merge Commit:** <hash>
**Merged To:** develop

---

## Related Items

| ID | Title | Relationship |
|----|-------|-------------|
| BACKLOG-235 | jsdiff DoS Vulnerability | Source backlog item |

---

## SR Engineer Pre-Implementation Review

**Review Date:** 2026-01-15 | **Status:** APPROVED

### Branch Information (SR Engineer decides)
- **Branch From:** develop
- **Branch Into:** develop
- **Suggested Branch Name:** fix/TASK-1074-jsdiff-vulnerability

### Execution Classification
- **Parallel Safe:** Yes
- **Depends On:** None
- **Blocks:** TASK-1075 (Phase 2 starts after Phase 1)

### Shared File Analysis
- Files modified: `package.json`, `package-lock.json`
- Conflicts with: None

### Technical Considerations

**Current State (verified via npm audit):**
```
diff  <8.0.3
jsdiff has a Denial of Service vulnerability in parsePatch and applyPatch
https://github.com/advisories/GHSA-73rr-hh4g-fpgx

Vulnerability Chain:
diff → ts-node → jest-config → @jest/core → jest → ts-jest
```

**Fix Options (in order of preference):**

1. **Override in package.json** (RECOMMENDED)
   ```json
   "overrides": {
     "diff": ">=8.0.3"
   }
   ```
   This forces all transitive deps to use the patched version.

2. **npm audit fix**
   May work but could introduce other changes.

3. **npm audit fix --force** (NOT RECOMMENDED)
   Will downgrade ts-node to 1.7.1 which is ancient and will break the project.

**Severity Assessment:**
- npm reports: 8 low severity vulnerabilities
- Advisory shows: DoS via crafted input to parsePatch/applyPatch
- Impact: Jest testing only (not production code)
- Risk: LOW - this is a dev dependency, not shipped with app

**Testing Verification:**
- After fix, run `npm audit` to confirm no high/critical vulnerabilities
- Run `npm test` to ensure Jest still works
- The app does not use diff directly, so no integration testing needed

### Complexity Assessment
**Estimated Tokens:** ~15K is appropriate
**Confidence:** High - simple dependency fix
